cscope 15 $HOME/example/lwqq -q 0000002548 0000425063
	@src/cli/cli.c

11 
	~<°rög.h
>

12 
	~<uni°d.h
>

13 
	~<°dlib.h
>

14 
	~<gë›t.h
>

15 
	~<sig«l.h
>

16 
	~<°dio.h
>

17 
	~<libgí.h
>

18 
	~<±hªad.h
>

20 
	~"logö.h
"

21 
	~"loggî.h
"

22 
	~"öfo.h
"

23 
	~"smem‹y.h
"

24 
	~"msg.h
"

26 
	#LWQQ_CLI_VERSION
 "0.0.1"

	)

28 
hñp_f
(
¨gc
, **
¨gv
);

29 
quô_f
(
¨gc
, **
¨gv
);

30 
li°_f
(
¨gc
, **
¨gv
);

31 
£nd_f
(
¨gc
, **
¨gv
);

33 (*
	tcfunc_t
)(
	t¨gc
, **
	t¨gv
);

35 
	sCmdInfo
 {

36 c⁄° *
«me
;

37 c⁄° *
Æäame
;

38 
cfunc_t
 
cfunc
;

39 } 
	tCmdInfo
;

41 
LwqqClõ¡
 *
lc
 = 
NULL
;

43 
vc_image
[128];

44 
vc_fûe
[128];

46 *
¥og«me
;

48 
CmdInfo
 
cmdèb
[] = {

49 {"hñp", "h", 
hñp_f
},

50 {"quô", "q", 
quô_f
},

51 {"li°", "l", 
li°_f
},

52 {"£nd", "s", 
£nd_f
},

53 {
NULL
, NULL, NULL},

54 
	}
};

56 
	$hñp_f
(
¨gc
, **
¨gv
)

58 
	`¥ötf
(

72 
	}
}

74 
	$quô_f
(
¨gc
, **
¨gv
)

77 
	}
}

79 
	$li°_f
(
¨gc
, **
¨gv
)

81 
buf
[1024] = {0};

87 i‡(
¨gc
 != 2) {

91 i‡(!
	`°rcmp
(
¨gv
[1], "all")) {

93 
LwqqBuddy
 *
buddy
;

94 
	`LIST_FOREACH
(
buddy
, &
lc
->
‰õnds
, 
íåõs
) {

95 i‡(!
buddy
->
uö
) {

99 
	`¢¥ötf
(
buf
, (buf), "uö:%s, ", 
buddy
->
uö
);

100 i‡(
buddy
->
nick
) {

101 
	`°rˇt
(
buf
, "nick:");

102 
	`°rˇt
(
buf
, 
buddy
->
nick
);

103 
	`°rˇt
(
buf
, ", ");

105 
	`¥ötf
("Buddy info: %s\n", 
buf
);

109 
LwqqBuddy
 *
buddy
;

110 
	`LIST_FOREACH
(
buddy
, &
lc
->
‰õnds
, 
íåõs
) {

111 i‡(
buddy
->
uö
 && !
	`°rcmp
(buddy->uö, 
¨gv
[1])) {

112 
	`¢¥ötf
(
buf
, (buf), "uö:%s, ", 
¨gv
[1]);

113 i‡(
buddy
->
nick
) {

114 
	`°rˇt
(
buf
, "nick:");

115 
	`°rˇt
(
buf
, 
buddy
->
nick
);

116 
	`°rˇt
(
buf
, ", ");

118 i‡(
buddy
->
m¨k«me
) {

119 
	`°rˇt
(
buf
, "markname:");

120 
	`°rˇt
(
buf
, 
buddy
->
m¨k«me
);

122 
	`¥ötf
("Buddy info: %s\n", 
buf
);

129 
	}
}

131 
	$£nd_f
(
¨gc
, **
¨gv
)

134 i‡(
¨gc
 != 3) {

138 
	`lwqq_msg_£nd2
(
lc
, 
¨gv
[1],árgv[2]);

141 
	}
}

143 *
	$gë_¥om±
()

145 
¥om±
[256];

147 i‡(!
¥om±
[0])

148 
	`¢¥ötf
(
¥om±
, ’rom±), "%s> ", 
¥og«me
);

149  
¥om±
;

150 
	}
}

152 *
	$gë_vc
()

154 
vc
[128] = {0};

155 
vc_Àn
;

156 
FILE
 *
f
;

158 i‡((
f
 = 
	`f›í
(
vc_fûe
, "r")Ë=
NULL
) {

159  
NULL
;

162 i‡(!
	`fgës
(
vc
, (vc), 
f
)) {

163 
	`f˛o£
(
f
);

164  
NULL
;

167 
vc_Àn
 = 
	`°æí
(
vc
);

168 i‡(
vc
[
vc_Àn
 - 1] == '\n') {

169 
vc
[
vc_Àn
 - 1] = '\0';

171  
	`s_°rdup
(
vc
);

172 
	}
}

174 
LwqqEº‹Code
 
	$˛i_logö
()

176 
LwqqEº‹Code
 
îr
;

178 
	`lwqq_logö
(
lc
, &
îr
);

179 i‡(
îr
 =
LWQQ_EC_LOGIN_NEED_VC
) {

180 
	`¢¥ötf
(
vc_image
, (vc_image), "/tmp/lwqq_%s.j≥g", 
lc
->
u£∫ame
);

181 
	`¢¥ötf
(
vc_fûe
, (vc_fûe), "/tmp/lwqq_%s.txt", 
lc
->
u£∫ame
);

183 
	`u∆ök
(
vc_fûe
);

185 
	`lwqq_log
(
LOG_NOTICE
, "Need verify codeÅoÜogin,Ölease check "

187 
vc_image
, 
vc_fûe
);

189 i‡(!
	`ac˚ss
(
vc_fûe
, 
F_OK
)) {

190 
	`¶ìp
(1);

193 
	`¶ìp
(1);

195 
lc
->
vc
->
°r
 = 
	`gë_vc
();

196 i‡(!
lc
->
vc
->
°r
) {

197 
Áûed
;

199 
	`lwqq_log
(
LOG_NOTICE
, "Gë vîify code: %s\n", 
lc
->
vc
->
°r
);

200 
	`lwqq_logö
(
lc
, &
îr
);

201 } i‡(
îr
 !
LWQQ_EC_OK
) {

202 
Áûed
;

205  
îr
;

207 
Áûed
:

208  
LWQQ_EC_ERROR
;

209 
	}
}

211 
	$˛i_logout
(
LwqqClõ¡
 *
lc
)

213 
LwqqEº‹Code
 
îr
;

215 
	`lwqq_logout
(
lc
, &
îr
);

216 i‡(
îr
 !
LWQQ_EC_OK
) {

217 
	`lwqq_log
(
LOG_DEBUG
, "Logout failed\n");

219 
	`lwqq_log
(
LOG_DEBUG
, "Logout sucessfully\n");

221 
	}
}

223 
	$ußge
()

225 
	`Ârötf
(
°dout
, "Usage:Üwqq-cli [options]...\n"

236 
	}
}

238 
	$sig«l_h™dÀr
(
signum
)

240 i‡(
signum
 =
SIGINT
) {

241 
	`˛i_logout
(
lc
);

242 
	`lwqq_˛õ¡_‰ì
(
lc
);

243 
	`exô
(0);

245 
	}
}

247 
	$h™dÀ_√w_msg
(
LwqqRecvMsg
 *
ªcvmsg
)

249 
LwqqMsg
 *
msg
 = 
ªcvmsg
->msg;

251 
	`¥ötf
("Re˚ivêmesßgêty≥: %d\n", 
msg
->
ty≥
);

252 i‡(
msg
->
ty≥
 =
LWQQ_MT_BUDDY_MSG
) {

253 
buf
[1024] = {0};

254 
LwqqMsgC⁄ã¡
 *
c
;

255 
LwqqMsgMesßge
 *
mmsg
 = 
msg
->
›aque
;

256 
	`TAILQ_FOREACH
(
c
, &
mmsg
->
c⁄ã¡
, 
íåõs
) {

257 i‡(
c
->
ty≥
 =
LWQQ_CONTENT_STRING
) {

258 
	`°rˇt
(
buf
, 
c
->
d©a
.
°r
);

260 
	`¥ötf
 ("Re˚ivêÁ˚ msg: %d\n", 
c
->
d©a
.
Á˚
);

263 
	`¥ötf
("Re˚ivêmesßge: %s\n", 
buf
);

264 } i‡(
msg
->
ty≥
 =
LWQQ_MT_GROUP_MSG
) {

265 
LwqqMsgMesßge
 *
mmsg
 = 
msg
->
›aque
;

266 
buf
[1024] = {0};

267 
LwqqMsgC⁄ã¡
 *
c
;

268 
	`TAILQ_FOREACH
(
c
, &
mmsg
->
c⁄ã¡
, 
íåõs
) {

269 i‡(
c
->
ty≥
 =
LWQQ_CONTENT_STRING
) {

270 
	`°rˇt
(
buf
, 
c
->
d©a
.
°r
);

272 
	`¥ötf
 ("Re˚ivêÁ˚ msg: %d\n", 
c
->
d©a
.
Á˚
);

275 
	`¥ötf
("Re˚ivêmesßge: %s\n", 
buf
);

276 } i‡(
msg
->
ty≥
 =
LWQQ_MT_STATUS_CHANGE
) {

277 
LwqqMsgSètusCh™ge
 *
°©us
 = 
msg
->
›aque
;

278 
	`¥ötf
("Receive status change: %s - > %s\n",

279 
°©us
->
who
,

280 
°©us
->status);

282 
	`¥ötf
("unknow message\n");

285 
	`lwqq_msg_‰ì
(
ªcvmsg
->
msg
);

286 
	`s_‰ì
(
ªcvmsg
);

287 
	}
}

289 *
	$ªcvmsg_thªad
(*
li°
)

291 
LwqqRecvMsgLi°
 *
l
 = (LwqqRecvMsgLi° *)
li°
;

294 
l
->
	`pﬁl_msg
(l);

298 
LwqqRecvMsg
 *
ªcvmsg
;

299 
	`±hªad_muãx_lock
(&
l
->
muãx
);

300 i‡(
	`SIMPLEQ_EMPTY
(&
l
->
hód
)) {

302 
	`±hªad_muãx_u∆ock
(&
l
->
muãx
);

303 
	`u¶ìp
(100000);

306 
ªcvmsg
 = 
	`SIMPLEQ_FIRST
(&
l
->
hód
);

307 
	`SIMPLEQ_REMOVE_HEAD
(&
l
->
hód
, 
íåõs
);

308 
	`±hªad_muãx_u∆ock
(&
l
->
muãx
);

309 
	`h™dÀ_√w_msg
(
ªcvmsg
);

312 
	`±hªad_exô
(
NULL
);

313 
	}
}

315 *
	$öfo_thªad
(*
lc
)

317 
LwqqEº‹Code
 
îr
;

318 
	`lwqq_öfo_gë_‰õnds_öfo
(
lc
, &
îr
);

321 
	`±hªad_exô
(
NULL
);

322 
	}
}

324 **
	$bªaklöe
(*
öput
, *
cou¡
)

326 
c
 = 0;

327 **
rvÆ
 = 
	`ˇŒoc
((*), 1);

328 **
tmp
;

329 *
tokí
, *
ßve_±r
;

331 
tokí
 = 
	`°πok_r
(
öput
, " ", &
ßve_±r
);

332 
tokí
) {

333 
c
++;

334 
tmp
 = 
	`ªÆloc
(
rvÆ
, (*rvÆË* (
c
 + 1));

335 
rvÆ
 = 
tmp
;

336 
rvÆ
[
c
 - 1] = 
tokí
;

337 
rvÆ
[
c
] = 
NULL
;

338 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßve_±r
);

341 *
cou¡
 = 
c
;

343 i‡(
c
 == 0) {

344 
	`‰ì
(
rvÆ
);

345  
NULL
;

348  
rvÆ
;

349 
	}
}

351 c⁄° 
CmdInfo
 *
	$föd_comm™d
(c⁄° *
cmd
)

353 
CmdInfo
 *
˘
;

355 
˘
 = 
cmdèb
; ct->
«me
; ct++) {

356 i‡(!
	`°rcmp
(
˘
->
«me
, 
cmd
Ë|| !°rcmp(˘->
Æäame
, cmd)) {

357  (c⁄° 
CmdInfo
 *)
˘
;

360  
NULL
;

361 
	}
}

363 
	$comm™d_lo›
()

365 
comm™d
[1024];

366 
d⁄e
 = 0;

368 !
d⁄e
) {

369 **
v
;

370 *
p
;

371 
c
 = 0;

372 c⁄° 
CmdInfo
 *
˘
;

373 
	`Ârötf
(
°dout
, "%s", 
	`gë_¥om±
());

374 
	`fÊush
(
°dout
);

375 
	`mem£t
(&
comm™d
, 0, (command));

376 i‡(!
	`fgës
(
comm™d
, (comm™d), 
°dö
)) {

380 
p
 = 
comm™d
 + 
	`°æí
(command);

381 i‡(
p
 !
comm™d
 &&Ö[-1] == '\n') {

382 
p
[-1] = '\0';

385 
v
 = 
	`bªaklöe
(
comm™d
, &
c
);

386 i‡(
v
) {

387 
˘
 = 
	`föd_comm™d
(
v
[0]);

388 i‡(
˘
) {

389 
d⁄e
 = 
˘
->
	`cfunc
(
c
, 
v
);

391 
	`Ârötf
(
°dîr
, "comm™d \"%s\"ÇŸ found\n", 
v
[0]);

393 
	`‰ì
(
v
);

396 
	}
}

398 
	$maö
(
¨gc
, *
¨gv
[])

400 *
qqnumbî
 = 
NULL
, *
∑ssw‹d
 = NULL;

401 
LwqqEº‹Code
 
îr
;

402 
i
, 
c
, 
e
 = 0;

403 
±hªad_t
 
tid
[2];

404 
±hªad_©å_t
 
©å
[2];

406 i‡(
¨gc
 == 1) {

407 
	`ußge
();

408 
	`exô
(1);

411 
¥og«me
 = 
	`ba£«me
(
¨gv
[0]);

413 c⁄° 
›ti⁄
 
l⁄g_›ti⁄s
[] = {

422 
	`sig«l
(
SIGINT
, 
sig«l_h™dÀr
);

424 (
c
 = 
	`gë›t_l⁄g
(
¨gc
, 
¨gv
, "vhu:p:",

425 
l⁄g_›ti⁄s
, 
NULL
)Ë!
EOF
) {

426 
c
) {

428 
	`¥ötf
("lwqq-cli version %s, Copyright (c) 2012 "

429 "m©h¶öux\n", 
LWQQ_CLI_VERSION
);

430 
	`exô
(0);

432 
	`ußge
();

433 
	`exô
(0);

435 
qqnumbî
 = 
›èrg
;

438 
∑ssw‹d
 = 
›èrg
;

441 
e
++;

445 i‡(
e
 || 
¨gc
 > 
›töd
) {

446 
	`ußge
();

447 
	`exô
(1);

450 
lc
 = 
	`lwqq_˛õ¡_√w
(
qqnumbî
, 
∑ssw‹d
);

451 i‡(!
lc
) {

452 
	`lwqq_log
(
LOG_NOTICE
, "CreateÜwqq client failed\n");

457 
îr
 = 
	`˛i_logö
();

458 i‡(
îr
 !
LWQQ_EC_OK
) {

459 
	`lwqq_log
(
LOG_ERROR
, "LoginÉrror,Éxit\n");

460 
	`lwqq_˛õ¡_‰ì
(
lc
);

464 
	`lwqq_log
(
LOG_NOTICE
, "Login successfully\n");

467 
i
 = 0; i < 2; ++i) {

468 
	`±hªad_©å_öô
(&
©å
[
i
]);

469 
	`±hªad_©å_£tdëach°©e
(&
©å
[
i
], 
PTHREAD_CREATE_DETACHED
);

473 
	`±hªad_¸óã
(&
tid
[0], &
©å
[0], 
ªcvmsg_thªad
, 
lc
->
msg_li°
);

476 
	`±hªad_¸óã
(&
tid
[1], &
©å
[1], 
öfo_thªad
, 
lc
);

479 
	`comm™d_lo›
();

482 
	`˛i_logout
(
lc
);

483 
	`lwqq_˛õ¡_‰ì
(
lc
);

485 
	}
}

	@src/gui/buddylist.c

11 
	~"buddyli°.h
"

13 
qq_buddy_li°_öô
(
QQBuddyLi°
 *
£lf
);

14 
qq_buddy_li°_˛ass_öô
(
QQBuddyLi°Cœss
 *
kœss
, 
gpoöãr
 
d©a
);

15 
qq_buddy_li°_föÆize
(
GObje˘
 *
obj
);

17 
	#QQ_FACEDIR
 ""

	)

18 
	#IMGDIR
 ""

	)

24 
GSåög
 *
	muö
;

25 
GtkTªeRowRe„ªn˚
 *
	mrow_ªf
;

26 } 
	tQQBuddyLi°M≠
;

30 
GHashTabÀ
 *
	mrow_m≠
;

31 } 
	tQQBuddyLi°Priv
;

33 
GTy≥
 
	$qq_buddy_li°_gë_ty≥
()

35 vﬁ©ûê
gsize
 
g_deföe_ty≥_id__vﬁ©ûe
 = 0;

36 
GTy≥
 
ty≥_id
 = 0;

37 i‡(
	`g_⁄˚_öô_íãr
(&
g_deföe_ty≥_id__vﬁ©ûe
)) {

38 i‡(
ty≥_id
 == 0) {

39 
GTy≥Info
 
ty≥_öfo
 = {

40 (
QQBuddyLi°Cœss
),

41 
NULL
,

42 
NULL
,

44 (
GCœssInôFunc
)
qq_buddy_li°_˛ass_öô
,

45 
NULL
,

46 
NULL
,

48 (
QQBuddyLi°
),

51 (
GIn°™˚InôFunc
)
qq_buddy_li°_öô
,

52 
NULL


54 
ty≥_id
 = 
	`g_ty≥_ªgi°î_°©ic
(

55 
GTK_TYPE_TREE_VIEW
,

57 &
ty≥_öfo
,

60 
	`g_⁄˚_öô_Àave
(&
g_deföe_ty≥_id__vﬁ©ûe
, 
ty≥_id
);

62  
ty≥_id
;

63 
	}
}

65 
GtkWidgë
* 
	$qq_buddy_li°_√w
()

67  
	`GTK_WIDGET
(
	`g_obje˘_√w
(
	`qq_buddy_li°_gë_ty≥
(), 
NULL
));

68 
	}
}

80 
	$qq_buddy_li°_ãxt_˚Œ_d©a_func
(
GtkTªeVõwCﬁumn
 *
cﬁ
,

81 
GtkCñlRídîî
 *
ªndîî
,

82 
GtkTªeModñ
 *
modñ
,

83 
GtkTªeIãr
 *
ôî
, 
gpoöãr
 
d©a
)

85 
GtkTªeP©h
 *
∑th
 = 
	`gtk_åì_modñ_gë_∑th
(
modñ
, 
ôî
);

86 
gch¨
 
ãxt
[500];

87 
gch¨
 *
«me
, *
 ick
;

88 
	`gtk_åì_modñ_gë
(
modñ
, 
ôî
, 
BDY_LIST_NAME
, &
«me
, 
BDY_LIST_LNICK
,

89 &
 ick
, -1);

90 
	`g_¢¥ötf
(
ãxt
, 500, "<b>%s</b> <span color='#808080'>%s</span>",

91 
«me
, 
 ick
);

92 
	`g_obje˘_£t
(
ªndîî
, "m¨kup", 
ãxt
, 
NULL
);

93 
	`g_‰ì
(
«me
);

94 
	`g_‰ì
(
 ick
);

95 
	`gtk_åì_∑th_‰ì
(
∑th
);

96 
	}
}

107 
	$qq_buddy_li°_pixbuf_˚Œ_d©a_func
(
GtkTªeVõwCﬁumn
 *
cﬁ
,

108 
GtkCñlRídîî
 *
ªndîî
,

109 
GtkTªeModñ
 *
modñ
,

110 
GtkTªeIãr
 *
ôî
,

111 
gpoöãr
 
d©a
)

113 
	}
}

115 
	$row_m≠_de°roy_vÆue
(
gpoöãr
 
vÆue
)

117 i‡(
vÆue
 =
NULL
) {

120 
GtkTªeRowRe„ªn˚
 *
ªf
 = 
vÆue
;

121 
	`gtk_åì_row_ª„ªn˚_‰ì
(
ªf
);

122 
	}
}

124 
	$qq_buddy_li°_öô
(
QQBuddyLi°
 *
£lf
)

126 
GtkCñlRídîî
 *
ªndîî
;

127 
GtkTªeVõwCﬁumn
 *
cﬁumn
;

130 
cﬁumn
 = 
	`gtk_åì_võw_cﬁumn_√w
();

131 
ªndîî
 = 
	`gtk_˚Œ_ªndîî_pixbuf_√w
();

132 
	`gtk_åì_võw_cﬁumn_∑ck_°¨t
(
cﬁumn
, 
ªndîî
, 
FALSE
);

133 
	`gtk_åì_võw_cﬁumn_add_©åibuã
(
cﬁumn
, 
ªndîî
, "pixbuf", 
BDY_LIST_TYPE
);

134 
	`gtk_åì_võw_≠≥nd_cﬁumn
(
	`GTK_TREE_VIEW
(
£lf
), 
cﬁumn
);

135 
	`gtk_åì_võw_cﬁumn_£t_˚Œ_d©a_func
(
cﬁumn
, 
ªndîî
,

136 
qq_buddy_li°_pixbuf_˚Œ_d©a_func
,

137 
NULL
, NULL);

140 
cﬁumn
 = 
	`gtk_åì_võw_cﬁumn_√w
();

141 
ªndîî
 = 
	`gtk_˚Œ_ªndîî_pixbuf_√w
();

142 
	`gtk_åì_võw_cﬁumn_∑ck_°¨t
(
cﬁumn
, 
ªndîî
, 
FALSE
);

143 
	`gtk_åì_võw_cﬁumn_add_©åibuã
(
cﬁumn
, 
ªndîî
, "pixbuf", 
BDY_LIST_IMG
);

144 
	`gtk_åì_võw_≠≥nd_cﬁumn
(
	`GTK_TREE_VIEW
(
£lf
), 
cﬁumn
);

145 
	`gtk_åì_võw_cﬁumn_£t_˚Œ_d©a_func
(
cﬁumn
, 
ªndîî
,

146 
qq_buddy_li°_pixbuf_˚Œ_d©a_func
,

147 
NULL
, NULL);

150 
cﬁumn
 = 
	`gtk_åì_võw_cﬁumn_√w
();

151 
ªndîî
 = 
	`gtk_˚Œ_ªndîî_ãxt_√w
();

152 
	`gtk_åì_võw_cﬁumn_∑ck_°¨t
(
cﬁumn
, 
ªndîî
, 
TRUE
);

153 
	`gtk_åì_võw_≠≥nd_cﬁumn
(
	`GTK_TREE_VIEW
(
£lf
), 
cﬁumn
);

154 
	`gtk_åì_võw_cﬁumn_£t_˚Œ_d©a_func
(
cﬁumn
, 
ªndîî
,

155 
qq_buddy_li°_ãxt_˚Œ_d©a_func
,

156 
NULL
, NULL);

159 
	`gtk_åì_võw_£t_hódîs_visibÀ
(
	`GTK_TREE_VIEW
(
£lf
), 
FALSE
);

160 
	`gtk_åì_võw_£t_hovî_£À˘i⁄
(
	`GTK_TREE_VIEW
(
£lf
), 
TRUE
);

162 
GtkLi°St‹e
 *
°‹e
 = 
	`gtk_li°_°‹e_√w
(
BDY_LIST_COLUMNS
, 
GDK_TYPE_PIXBUF
,

163 
GDK_TYPE_PIXBUF
, 
G_TYPE_STRING
,

164 
G_TYPE_INT
, 
G_TYPE_STRING
,

165 
G_TYPE_STRING
, G_TYPE_STRING);

166 
	`gtk_åì_võw_£t_modñ
(
	`GTK_TREE_VIEW
(
£lf
), 
	`GTK_TREE_MODEL
(
°‹e
));

168 
QQBuddyLi°Priv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(

169 
£lf
, 
	`qq_buddy_li°_gë_ty≥
(), 
QQBuddyLi°Priv
);

170 
¥iv
 -> 
row_m≠
 = 
	`g_hash_èbÀ_√w_fuŒ
(
g_°r_hash
, 
g_°r_equÆ
,

171 
g_‰ì
, 
row_m≠_de°roy_vÆue
);

172 
	}
}

174 
	$qq_buddy_li°_˛ass_öô
(
QQBuddyLi°Cœss
 *
kœss
, 
gpoöãr
 
d©a
)

176 
	`g_ty≥_˛ass_add_¥iv©e
(
kœss
, (
QQBuddyLi°Priv
));

177 
	`G_OBJECT_CLASS
(
kœss
)->
föÆize
 = 
qq_buddy_li°_föÆize
;

178 
	}
}

180 
gboﬁón
 
	$˛ór_row_m≠
(
gpoöãr
 
key
, gpoöã∏
vÆue
, gpoöã∏
d©a
)

183  
TRUE
;

184 
	}
}

186 
	$qq_buddy_li°_föÆize
(
GObje˘
 *
obj
)

188 
QQBuddyLi°Priv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(
obj


189 , 
	`qq_buddy_li°_gë_ty≥
()

190 , 
QQBuddyLi°Priv
);

191 
	`g_hash_èbÀ_f‹óch_ªmove
(
¥iv
 -> 
row_m≠
, 
˛ór_row_m≠
, 
NULL
);

192 
	`g_hash_èbÀ_uƒef
(
¥iv
 -> 
row_m≠
);

195 
GObje˘Cœss
 *
kœss
 = (GObje˘Cœss*)
	`g_ty≥_˛ass_≥ek_∑ª¡
(

196 
	`g_ty≥_˛ass_≥ek
(
	`qq_buddy_li°_gë_ty≥
()));

197 
kœss
 -> 
	`föÆize
(
obj
);

198 
	}
}

208 
	$qq_buddy_li°_£t_buddy
(
GtkLi°St‹e
 *
°‹e
, 
GtkTªeIãr
 *
ôî


209 , 
QQBuddy
 *
bdy
)

211 
gch¨
 *
«me
;

212 i‡(
bdy
->
m¨k«me
 =
NULL
 || bdy -> m¨k«mê-> 
Àn
 <= 0) {

213 
«me
 = 
bdy
 -> 
nick
 -> 
°r
;

215 
«me
 = 
bdy
 -> 
m¨k«me
 -> 
°r
;

218 
	`gtk_li°_°‹e_£t
(
°‹e
, 
ôî
, 
BDY_LIST_UIN
, 
bdy
->
uö
->
°r
,

219 
BDY_LIST_CLASS
, 1, 
BDY_LIST_NAME
, 
«me
,

220 
BDY_LIST_LNICK
, 
bdy
->
 ick
->
°r
, -1);

221 
gch¨
 
buf
[500];

222 
GdkPixbuf
 *
pb
 = 
NULL
;

223 
	`g_¢¥ötf
(
buf
, 500, "%s/%s", 
QQ_FACEDIR
, 
bdy
->
qqnumbî
->
°r
);

224 
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe_©_size
(
buf
, 22, 22, 
NULL
);

225 i‡(
pb
 =
NULL
) {

226 
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe_©_size
(
IMGDIR
"/group.≤g", 22, 22, 
NULL
);

228 
	`gtk_li°_°‹e_£t
(
°‹e
, 
ôî
, 
BDY_LIST_IMG
, 
pb
, -1);

229 
	}
}

231 
	$qq_buddy_li°_add_buddy
(
GtkWidgë
 *
widgë
, 
QQBuddy
 *
bdy
)

233 i‡(
widgë
 =
NULL
 || 
bdy
 == NULL) {

237 
GtkTªeVõw
 *
võw
 = 
	`GTK_TREE_VIEW
(
widgë
);

238 
GtkLi°St‹e
 *
°‹e
 = 
	`GTK_LIST_STORE
(
	`gtk_åì_võw_gë_modñ
(
võw
));

239 
GtkTªeIãr
 
ôî
;

240 
	`gtk_li°_°‹e_≠≥nd
(
°‹e
, &
ôî
);

241 
	`qq_buddy_li°_£t_buddy
(
°‹e
, &
ôî
, 
bdy
);

244 
GtkTªeP©h
 *
∑th
 = 
	`gtk_åì_modñ_gë_∑th
(
	`GTK_TREE_MODEL
(
°‹e
), &
ôî
);

245 
GtkTªeRowRe„ªn˚
 *
ªf
 = 
	`gtk_åì_row_ª„ªn˚_√w
(
	`GTK_TREE_MODEL
(
°‹e
),

246 
∑th
);

247 
	`gtk_åì_∑th_‰ì
(
∑th
);

248 
QQBuddyLi°Priv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(

249 
widgë
, 
	`qq_buddy_li°_gë_ty≥
(), 
QQBuddyLi°Priv
);

250 
	`g_hash_èbÀ_ö£π
(
¥iv
 -> 
row_m≠
, 
	`g_°rdup
(
bdy
->
uö
->
°r
), 
ªf
);

252 
	}
}

258 
	$qq_buddy_li°_£t_group
(
GtkLi°St‹e
 *
°‹e
, 
GtkTªeIãr
 *
ôî


259 , 
QQGroup
 *
gΩ
)

262 
	`gtk_li°_°‹e_£t
(
°‹e
, 
ôî


263 , 
BDY_LIST_NUMBER
, 
gΩ
 -> 
gnumbî
 -> 
°r


264 , 
BDY_LIST_UIN
, 
gΩ
 -> 
code
 -> 
°r


265 , 
BDY_LIST_CLASS
, 2

266 , 
BDY_LIST_NAME
, 
gΩ
 -> 
«me
 -> 
°r


267 , 
BDY_LIST_LNICK
, 
gΩ
 -> 
fögîmemo
 -> 
°r


269 
gch¨
 
buf
[500];

270 
GdkPixbuf
 *
pb
 = 
NULL
;

271 
	`g_¢¥ötf
(
buf
, 500, "%s/%s", 
QQ_FACEDIR
, 
gΩ
 -> 
gnumbî
 -> 
°r
);

272 
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe_©_size
(
buf
, 22, 22, 
NULL
);

273 if(
pb
 =
NULL
){

274 
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe_©_size
(
IMGDIR
"/group.≤g", 22, 22, 
NULL
);

276 
	`gtk_li°_°‹e_£t
(
°‹e
, 
ôî
, 
BDY_LIST_IMG
, 
pb
, -1);

277 
	}
}

279 
	$qq_buddy_li°_add_group
(
GtkWidgë
 *
widgë
, 
QQGroup
 *
gΩ
)

281 if(
widgë
 =
NULL
 || 
gΩ
 == NULL){

285 
GtkTªeVõw
 *
võw
 = 
	`GTK_TREE_VIEW
(
widgë
);

286 
GtkLi°St‹e
 *
°‹e
 = 
	`GTK_LIST_STORE
(
	`gtk_åì_võw_gë_modñ
(
võw
));

287 
GtkTªeIãr
 
ôî
;

288 
	`gtk_li°_°‹e_≠≥nd
(
°‹e
, &
ôî
);

289 
	`qq_buddy_li°_£t_group
(
°‹e
, &
ôî
, 
gΩ
);

292 
GtkTªeP©h
 *
∑th
 = 
	`gtk_åì_modñ_gë_∑th
(
	`GTK_TREE_MODEL
(
°‹e
), &
ôî
);

293 
GtkTªeRowRe„ªn˚
 *
ªf
 = 
	`gtk_åì_row_ª„ªn˚_√w
(
	`GTK_TREE_MODEL
(
°‹e
)

294 , 
∑th
);

295 
	`gtk_åì_∑th_‰ì
(
∑th
);

296 
QQBuddyLi°Priv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(
widgë


297 , 
	`qq_buddy_li°_gë_ty≥
()

298 , 
QQBuddyLi°Priv
);

299 
	`g_hash_èbÀ_ö£π
(
¥iv
 -> 
row_m≠
, 
	`g_°rdup
(
gΩ
 -> 
gid
 -> 
°r
), 
ªf
);

301 
	}
}

303 
	$qq_buddy_li°_add_buddõs
(
GtkWidgë
 *
widgë
, 
GPåAºay
 *
bdõs
)

306 if(
widgë
 =
NULL
 || 
bdõs
 == NULL){

309 
göt
 
i
;

310 
QQBuddy
 *
bdy
;

311 
i
 = 0; i < 
bdõs
 -> 
Àn
; ++i){

312 
bdy
 = 
	`g_±r_¨øy_ödex
(
bdõs
, 
i
);

313 
	`qq_buddy_li°_add_buddy
(
widgë
, 
bdy
);

316 
	}
}

318 
	$qq_buddy_li°_add_groups
(
GtkWidgë
 *
widgë
, 
GPåAºay
 *
gΩs
)

320 if(
widgë
 =
NULL
 || 
gΩs
 == NULL){

323 
göt
 
i
;

324 
QQGroup
 *
gΩ
;

325 
i
 = 0; i < 
gΩs
 -> 
Àn
; ++i){

326 
gΩ
 = 
	`g_±r_¨øy_ödex
(
gΩs
, 
i
);

327 
	`qq_buddy_li°_add_group
(
widgë
, 
gΩ
);

329 
	}
}

332 
	$qq_buddy_li°_upd©e_buddy_öfo
(
GtkWidgë
 *
widgë
, 
QQBuddy
 *
bdy
)

334 if(
widgë
 =
NULL
 || 
bdy
 == NULL){

338 
QQBuddyLi°Priv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(
widgë


339 , 
	`qq_buddy_li°_gë_ty≥
()

340 , 
QQBuddyLi°Priv
);

341 
GtkTªeRowRe„ªn˚
 *
ªf
 = 
	`g_hash_èbÀ_lookup
(
¥iv
 -> 
row_m≠


342 , 
bdy
 -> 
uö
 -> 
°r
);

343 if(
ªf
 =
NULL
){

346 
GtkTªeVõw
 *
võw
 = 
	`GTK_TREE_VIEW
(
widgë
);

347 
GtkLi°St‹e
 *
°‹e
 = 
	`GTK_LIST_STORE
(
	`gtk_åì_võw_gë_modñ
(
võw
));

348 
GtkTªeIãr
 
ôî
;

349 
GtkTªeP©h
 *
∑th
 = 
	`gtk_åì_row_ª„ªn˚_gë_∑th
(
ªf
);

350 
	`gtk_åì_modñ_gë_ôî
(
	`GTK_TREE_MODEL
(
°‹e
), &
ôî
, 
∑th
);

351 
	`qq_buddy_li°_£t_buddy
(
°‹e
, &
ôî
, 
bdy
);

352 
	`gtk_åì_∑th_‰ì
(
∑th
);

353 
	}
}

356 
	$qq_buddy_li°_upd©e_group_öfo
(
GtkWidgë
 *
widgë
, 
QQGroup
 *
gΩ
)

359 if(
widgë
 =
NULL
 || 
gΩ
 == NULL){

363 
QQBuddyLi°Priv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(
widgë


364 , 
	`qq_buddy_li°_gë_ty≥
()

365 , 
QQBuddyLi°Priv
);

366 
GtkTªeRowRe„ªn˚
 *
ªf
 = 
	`g_hash_èbÀ_lookup
(
¥iv
 -> 
row_m≠


367 , 
gΩ
 -> 
gid
 -> 
°r
);

368 if(
ªf
 =
NULL
){

371 
GtkTªeVõw
 *
võw
 = 
	`GTK_TREE_VIEW
(
widgë
);

372 
GtkLi°St‹e
 *
°‹e
 = 
	`GTK_LIST_STORE
(
	`gtk_åì_võw_gë_modñ
(
võw
));

373 
GtkTªeIãr
 
ôî
;

374 
GtkTªeP©h
 *
∑th
 = 
	`gtk_åì_row_ª„ªn˚_gë_∑th
(
ªf
);

375 
	`gtk_åì_modñ_gë_ôî
(
	`GTK_TREE_MODEL
(
°‹e
), &
ôî
, 
∑th
);

376 
	`qq_buddy_li°_£t_group
(
°‹e
, &
ôî
, 
gΩ
);

377 
	`gtk_åì_∑th_‰ì
(
∑th
);

379 
	}
}

381 
	$qq_buddy_li°_upd©e_buddõs_öfo
(
GtkWidgë
 *
widgë
, 
GPåAºay
 *
bdõs
)

384 if(
widgë
 =
NULL
 || 
bdõs
 == NULL){

387 
göt
 
i
;

388 
QQBuddy
 *
bdy
;

389 
i
 = 0; i < 
bdõs
 -> 
Àn
; ++i){

390 
bdy
 = 
	`g_±r_¨øy_ödex
(
bdõs
, 
i
);

391 
	`qq_buddy_li°_upd©e_buddy_öfo
(
widgë
, 
bdy
);

394 
	}
}

396 
	$qq_buddy_li°_upd©e_groups_öfo
(
GtkWidgë
 *
widgë
, 
GPåAºay
 *
gΩs
)

398 if(
widgë
 =
NULL
 || 
gΩs
 == NULL){

401 
göt
 
i
;

402 
QQGroup
 *
gΩ
;

403 
i
 = 0; i < 
gΩs
 -> 
Àn
; ++i){

404 
gΩ
 = 
	`g_±r_¨øy_ödex
(
gΩs
, 
i
);

405 
	`qq_buddy_li°_upd©e_group_öfo
(
widgë
, 
gΩ
);

407 
	}
}

412 
	$qq_buddy_li°_£t_group_membî
(
GtkLi°St‹e
 *
°‹e


413 , 
GtkTªeIãr
 *
ôî


414 , 
QQGMembî
 *
gm
)

416 
	`g_debug
("Add grou∞membî: %†%†%†(%s, %d)", 
gm
 -> 
nick
 -> 
°r


417 , 
gm
 -> 
ˇrd
 -> 
°r
, gm -> 
qqnumbî
 -> str

418 , 
__FILE__
, 
__LINE__
);

419 
gch¨
 *
«me
;

420 if(
gm
 -> 
ˇrd
 =
NULL
 || gm -> c¨d -> 
Àn
 <= 0){

421 
«me
 = 
gm
 -> 
nick
 -> 
°r
;

423 
«me
 = 
gm
 -> 
ˇrd
 -> 
°r
;

426 
	`gtk_li°_°‹e_£t
(
°‹e
, 
ôî


427 , 
BDY_LIST_UIN
, 
gm
 -> 
uö
 -> 
°r


428 , 
BDY_LIST_CLASS
, 3

429 , 
BDY_LIST_NAME
, 
«me


430 , 
BDY_LIST_LNICK
, ""

431 , 
BDY_LIST_NUMBER
, 
gm
 -> 
qqnumbî
 -> 
°r


433 
gch¨
 
buf
[500];

434 
GdkPixbuf
 *
pb
 = 
NULL
;

435 
	`g_¢¥ötf
(
buf
, 500, "%s/%s", 
QQ_FACEDIR
, 
gm
 -> 
qqnumbî
 -> 
°r
);

436 
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe_©_size
(
buf
, 22, 22, 
NULL
);

437 if(
pb
 =
NULL
){

438 
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe_©_size
(
IMGDIR
"/avatar.gif"

439 , 22, 22, 
NULL
);

441 
	`gtk_li°_°‹e_£t
(
°‹e
, 
ôî
, 
BDY_LIST_IMG
, 
pb
, -1);

442 
	}
}

444 
	$qq_buddy_li°_add_group_membî
(
GtkWidgë
 *
widgë
, 
QQGMembî
 *
gm
)

446 if(
widgë
 =
NULL
 || 
gm
 == NULL){

450 
GtkTªeVõw
 *
võw
 = 
	`GTK_TREE_VIEW
(
widgë
);

451 
GtkLi°St‹e
 *
°‹e
 = 
	`GTK_LIST_STORE
(
	`gtk_åì_võw_gë_modñ
(
võw
));

452 
GtkTªeIãr
 
ôî
;

453 
	`gtk_li°_°‹e_≠≥nd
(
°‹e
, &
ôî
);

454 
	`qq_buddy_li°_£t_group_membî
(
°‹e
, &
ôî
, 
gm
);

457 
GtkTªeP©h
 *
∑th
 = 
	`gtk_åì_modñ_gë_∑th
(
	`GTK_TREE_MODEL
(
°‹e
), &
ôî
);

458 
GtkTªeRowRe„ªn˚
 *
ªf
 = 
	`gtk_åì_row_ª„ªn˚_√w
(
	`GTK_TREE_MODEL
(
°‹e
)

459 , 
∑th
);

460 
	`gtk_åì_∑th_‰ì
(
∑th
);

461 
QQBuddyLi°Priv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(
widgë


462 , 
	`qq_buddy_li°_gë_ty≥
()

463 , 
QQBuddyLi°Priv
);

464 
	`g_hash_èbÀ_ö£π
(
¥iv
 -> 
row_m≠
, 
	`g_°rdup
(
gm
 -> 
uö
 -> 
°r
), 
ªf
);

466 
	}
}

467 
	$qq_buddy_li°_add_group_membîs
(
GtkWidgë
 *
widgë
, 
GPåAºay
 *
gms
)

469 if(
widgë
 =
NULL
 || 
gms
 == NULL){

472 
göt
 
i
;

473 
QQGMembî
 *
gm
;

474 
i
 = 0; i < 
gms
 -> 
Àn
; ++i){

475 
gm
 = 
	`g_±r_¨øy_ödex
(
gms
, 
i
);

476 
	`qq_buddy_li°_add_group_membî
(
widgë
, 
gm
);

478 
	}
}

479 
	$qq_buddy_li°_upd©e_group_membî_öfo
(
GtkWidgë
 *
widgë
, 
QQGMembî
 *
gm
)

482 
	}
}

483 
	$qq_buddy_li°_upd©e_group_membîs_öfo
(
GtkWidgë
 *
widgë


484 , 
GPåAºay
 *
gms
)

487 
	}
}

	@src/gui/buddylist.h

12 #i‚de‡
LWQQ_BUDDYLIST_H


13 
	#LWQQ_BUDDYLIST_H


	)

15 
	~<gtk/gtk.h
>

18 
	sQQGMembî
 {

19 
GSåög
 *
	muö
;

20 
GSåög
 *
	mqqnumbî
;

21 
GSåög
 *
	mnick
;

22 
GSåög
 *
	mÊag
;

23 
GSåög
 *
	m°©us
;

24 
GSåög
 *
	mˇrd
;

25 
GSåög
 *
	m˛õ¡_ty≥
;

26 } 
	tQQGMembî
;

28 
	sQQGroup
 {

29 
GSåög
 *
	m«me
;

30 
GSåög
 *
	mgid
;

31 
GSåög
 *
	mgnumbî
;

32 
GSåög
 *
	mcode
;

33 
GSåög
 *
	mÊag
;

34 
GSåög
 *
	mow√r
;

35 
GSåög
 *
	mm¨k
;

36 
GSåög
 *
	mmask
;

37 
GSåög
 *
	m›ti⁄
;

38 
GSåög
 *
	m¸óãtime
;

39 
GSåög
 *
	mg˛ass
;

40 
GSåög
 *
	mÀvñ
;

41 
GSåög
 *
	mÁ˚
;

43 
GSåög
 *
	mmemo
;

44 
GSåög
 *
	mfögîmemo
;

46 
GPåAºay
 *
	mmembîs
;

47 } 
	tQQGroup
;

49 
	#QQ_TYPE_BUDDY_LIST
 (
	`qq_buddy_li°_gë_ty≥
())

	)

50 
	#QQ_BUDDY_LIST
(
obj
) \

51 (
	`G_TYPE_CHECK_INSTANCE_CAST
((
obj
), 
QQ_TYPE_BUDDY_LIST
, 
QQBuddyLi°
))

	)

52 
	#QQ_IS_BUDDY_LIST
(
obj
) \

53 (
	`G_TYPE_CHECK_INSTANCE_TYPE
((
obj
, 
QQ_TYPE_BUDDY_LIST
)))

	)

54 
	#QQ_BUDDY_LIST_CLASS
(
kœss
) \

55 (
	`G_TYPE_CHECK_CLASS_CAST
((
kœss
), 
QQ_TYPE_BUDDY_LIST
, 
QQBuddyLi°Cœss
))

	)

56 
	#QQ_IS_BUDDY_LIST_CLASS
(
kœss
) \

57 (
	`G_TYPE_CHECK_CLASS_TYPE
((
kœss
), 
QQ_TYPE_BUDDY_LIST
))

	)

58 
	#QQ_BUDDY_LIST_GET_CLASS
(
obj
) \

59 (
	`G_TYPE_INSTANCE_GET_CLASS
((
obj
), 
QQ_TYPE_BUDDY_LIST
, 
QQBuddyLi°Cœss
))

	)

63 
	mBDY_LIST_TYPE
 = 0,

64 
	mBDY_LIST_IMG
,

65 
	mBDY_LIST_UIN
,

66 
	mBDY_LIST_CLASS
,

68 
	mBDY_LIST_NAME
,

69 
	mBDY_LIST_LNICK
,

70 
	mBDY_LIST_NUMBER
,

72 
	mBDY_LIST_COLUMNS


75 
__QQBuddyLi°
 
	tQQBuddyLi°
;

76 
__QQBuddyLi°Cœss
 
	tQQBuddyLi°Cœss
;

78 
	s__QQBuddyLi°
{

79 
GtkTªeVõw
 
	m∑ª¡
;

82 
	s__QQBuddyLi°Cœss
{

83 
GtkTªeVõwCœss
 
	m∑ª¡
;

86 
GTy≥
 
qq_buddy_li°_gë_ty≥
();

87 
GtkWidgë
 * 
qq_buddy_li°_√w
();

93 
qq_buddy_li°_add_buddy
(
GtkWidgë
 *
widgë
, 
QQBuddy
 *
bdy
);

94 
qq_buddy_li°_add_group
(
GtkWidgë
 *
widgë
, 
QQGroup
 *
gΩ
);

95 
qq_buddy_li°_add_group_membî
(
GtkWidgë
 *
widgë
, 
QQGMembî
 *
gm
);

101 
qq_buddy_li°_add_buddõs
(
GtkWidgë
 *
widgë
, 
GPåAºay
 *
bdõs
);

102 
qq_buddy_li°_add_groups
(
GtkWidgë
 *
widgë
, 
GPåAºay
 *
gΩs
);

103 
qq_buddy_li°_add_group_membîs
(
GtkWidgë
 *
widgë
, 
GPåAºay
 *
gms
);

109 
qq_buddy_li°_upd©e_buddy_öfo
(
GtkWidgë
 *
widgë
, 
QQBuddy
 *
bdy
);

110 
qq_buddy_li°_upd©e_group_öfo
(
GtkWidgë
 *
widgë
, 
QQGroup
 *
gΩ
);

111 
qq_buddy_li°_upd©e_group_membî_öfo
(
GtkWidgë
 *
widgë
, 
QQGMembî
 *
gm
);

117 
qq_buddy_li°_upd©e_buddõs_öfo
(
GtkWidgë
 *
widgë
, 
GPåAºay
 *
bdõs
);

118 
qq_buddy_li°_upd©e_groups_öfo
(
GtkWidgë
 *
widgë
, 
GPåAºay
 *
gΩs
);

119 
qq_buddy_li°_upd©e_group_membîs_öfo
(
GtkWidgë
 *
widgë
, 
GPåAºay
 *
gms
);

	@src/gui/buddytree.c

1 
	~<°dlib.h
>

2 
	~<buddyåì.h
>

3 
	~<°rög.h
>

4 
	~<loggî.h
>

5 
	~<ch©wödow.h
>

7 
LwqqClõ¡
 *
lwqq_˛õ¡
;

8 
LwqqClõ¡
 *
lwqq_˛õ¡
;

9 *
lwqq_ö°Æl_dú
;

10 *
lwqq_ic⁄s_dú
;

11 *
lwqq_buddy_°©us_dú
;

12 
GtkWidgë
 *
maö_wö
;

13 *
lwqq_u£r_dú
;

14 
GHashTabÀ
 *
lwqq_ch©_wödow
;

17 
	mBDY_TYPE
= 0,

18 
	mBDY_IMAGE
,

19 
	mBDY_MARKNAME
,

20 
	mBDY_NICK
,

21 
	mBDY_UIN
,

22 
	mBDY_QQNUMBER
,

23 
	mBDY_LONGNICK
,

24 
	mBDY_STATUS
,

26 
	mBDY_TOOLTIPIMAGE
,

28 
	mCATE_CNT
,

29 
	mCATE_TOTAL
,

30 
	mCATE_INDEX
,

31 
	mCOLUMNS


39 
GHashTabÀ
 *
	gåì_m≠
 = 
NULL
;

44 
	$qq_buddy_åì_ãxt_˚Œ_d©a_func
(
GtkTªeVõwCﬁumn
 *
cﬁ


45 , 
GtkCñlRídîî
 *
ªndîî


46 , 
GtkTªeModñ
 *
modñ


47 , 
GtkTªeIãr
 *
ôî


48 , 
gpoöãr
 
d©a
)

50 
GtkTªeP©h
 *
∑th
 = 
	`gtk_åì_modñ_gë_∑th
(
modñ
, 
ôî
);

51 
gch¨
 
ãxt
[500];

52 if(
	`gtk_åì_∑th_gë_dïth
(
∑th
) > 1){

56 
gch¨
 *
m¨k«me
, *
nick
, *
l⁄g_nick
;

57 
	`gtk_åì_modñ_gë
(
modñ
, 
ôî


58 , 
BDY_MARKNAME
, &
m¨k«me


59 , 
BDY_NICK
, &
nick


60 , 
BDY_LONGNICK
, &
l⁄g_nick
, -1);

61 
GSåög
 *
fmt
 = 
	`g_°rög_√w
(
NULL
);

62 if(
	`°æí
(
m¨k«me
) <= 0){

63 
	`g_°rög_≠≥nd
(
fmt
, "<b>%s%s</b>");

65 
	`g_°rög_≠≥nd
(
fmt
, "<b>%s</b>(%s)");

68 
	`g_°rög_≠≥nd
(
fmt
, "<span color='grey'>%s</span>");

69 
	`g_¢¥ötf
(
ãxt
, 500, 
fmt
 -> 
°r
, 
m¨k«me
, 
nick
, 
l⁄g_nick
);

70 
	`g_°rög_‰ì
(
fmt
, 
TRUE
);

71 
	`g_obje˘_£t
(
ªndîî
, "m¨kup", 
ãxt
, 
NULL
);

72 
	`g_‰ì
(
m¨k«me
);

73 
	`g_‰ì
(
nick
);

74 
	`g_‰ì
(
l⁄g_nick
);

79 
gch¨
 *
«me
;

80 
göt
 
cou¡
, 
tŸÆ
;

81 
	`gtk_åì_modñ_gë
(
modñ
, 
ôî


82 , 
BDY_MARKNAME
, &
«me


83 , 
CATE_CNT
, &
cou¡


84 , 
CATE_TOTAL
, &
tŸÆ
, -1);

85 
	`g_¢¥ötf
(
ãxt
, 500, "%†[%d/%d]", 
«me
, 
cou¡
, 
tŸÆ
);

86 
	`g_obje˘_£t
(
ªndîî
, "ãxt", 
ãxt
, 
NULL
);

87 
	`g_‰ì
(
«me
);

89 
	`gtk_åì_∑th_‰ì
(
∑th
);

90 
	}
}

95 
	$qq_buddy_åì_pixbuf_˚Œ_d©a_func
(
GtkTªeVõwCﬁumn
 *
cﬁ


96 , 
GtkCñlRídîî
 *
ªndîî


97 , 
GtkTªeModñ
 *
modñ


98 , 
GtkTªeIãr
 *
ôî


99 , 
gpoöãr
 
d©a
)

101 
GtkTªeP©h
 *
∑th
 = 
	`gtk_åì_modñ_gë_∑th
(
modñ
, 
ôî
);

102 if(
	`gtk_åì_∑th_gë_dïth
(
∑th
) > 1){

106 
	`g_obje˘_£t
(
ªndîî
, "visibÀ", 
TRUE
, 
NULL
);

107 
gch¨
 *
°©us
;

108 
	`gtk_åì_modñ_gë
(
modñ
, 
ôî
, 
BDY_STATUS
, &
°©us
, -1);

109 if(
	`g_°rcmp0
("⁄löe", 
°©us
) == 0

110 || 
	`g_°rcmp0
("away", 
°©us
) == 0

111 || 
	`g_°rcmp0
("busy", 
°©us
) == 0

112 || 
	`g_°rcmp0
("sûít", 
°©us
) == 0

113 || 
	`g_°rcmp0
("ˇŒme", 
°©us
) == 0){

114 
	`g_obje˘_£t
(
ªndîî
, "£nsôive", 
TRUE
, 
NULL
);

116 
	`g_obje˘_£t
(
ªndîî
, "£nsôive", 
FALSE
, 
NULL
);

118 
	`g_‰ì
(
°©us
);

123 
	`g_obje˘_£t
(
ªndîî
, "visibÀ", 
FALSE
, 
NULL
);

125 
	`gtk_åì_∑th_‰ì
(
∑th
);

126 
	}
}

131 
gboﬁón
 
	$gë_ˇãg‹y_ôî_by_ödex
(
GtkTªeModñ
 *
modñ
, 
göt
 
ödex


132 , 
GtkTªeIãr
 *
ôî
)

134 if(!
	`gtk_åì_modñ_gë_ôî_fú°
(
modñ
, 
ôî
)){

135  
FALSE
;

137 
göt
 
ˇã_idx
;

139 
TRUE
){

140 
	`gtk_åì_modñ_gë
(
modñ
, 
ôî
, 
CATE_INDEX
, &
ˇã_idx
, -1);

141 if(
ˇã_idx
 =
ödex
){

142  
TRUE
;

144 if(!
	`gtk_åì_modñ_ôî_√xt
(
modñ
, 
ôî
)){

145  
FALSE
;

148  
TRUE
;

149 
	}
}

153 
GdkPixbuf
* 
	$¸óã_Á˚_image
(c⁄° 
gch¨
 *
num
, 
göt
 
width
, göà
height
)

156 i‡(
num
)

157 
num
 = "12345678";

158 
gch¨
 
buf
[500];

159 
GEº‹
 *
îr
 = 
NULL
;

160 
	`g_¢¥ötf
(
buf
, 500, "%s/%s", 
lwqq_u£r_dú
, 
num
);

161 
GdkPixbuf
 *
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe_©_size
(
buf
, 
width
, 
height
, &
îr
);

162 if(
pb
 =
NULL
){

163 
	`g_îr‹_‰ì
(
îr
);

164 
îr
 = 
NULL
;

165 
gch¨
 
img
[256];

166 
	`g_¢¥ötf
(
img
, (img), "%s/av©¨.gif", 
lwqq_ic⁄s_dú
);

167 
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe_©_size
(
img
, 
width
, 
height
, &
îr
);

168 if(
pb
 =
NULL
){

169 
	`g_w¨nög
("Load default face imageÉrror. %s (%s, %d)"

170 , 
îr
 -> 
mesßge
, 
__FILE__
, 
__LINE__
);

171 
	`g_îr‹_‰ì
(
îr
);

174  
pb
;

175 
	}
}

177 
gboﬁón
 
	$buddy_åì_⁄_show_toﬁtù
(
GtkWidgë
* 
widgë


178 , 
x


179 , 
y


180 , 
gboﬁón
 
keyb‹d_mode


181 , 
GtkToﬁtù
* 
tù


182 , 
gpoöãr
 
d©a
)

184 
GtkTªeVõw
 *
åì
 = 
	`GTK_TREE_VIEW
(
widgë
);

185 
GtkTªeModñ
 *
modñ
 = 
	`gtk_åì_võw_gë_modñ
(
åì
);

186 
GtkTªeP©h
 *
∑th
;

187 
GtkTªeIãr
 
ôî
;

189 if(!
	`gtk_åì_võw_gë_toﬁtù_c⁄ãxt
(
åì
 , &
x
 , &
y
 , 
keyb‹d_mode


190 , &
modñ
 , &
∑th
 , &
ôî
)){

191  
FALSE
;

193 if(
	`gtk_åì_∑th_gë_dïth
(
∑th
) < 2){

194  
FALSE
;

197 
gch¨
 *
nick
, *
m¨k«me
, *
 ick
, *
qqnum
;

198 
GdkPixbuf
 *
pb
;

199 
	`gtk_åì_modñ_gë
(
modñ
, &
ôî


200 , 
BDY_NICK
, &
nick


201 , 
BDY_TOOLTIPIMAGE
, &
pb


202 , 
BDY_MARKNAME
, &
m¨k«me


203 , 
BDY_LONGNICK
, &
 ick


204 , 
BDY_QQNUMBER
, &
qqnum
, -1);

205 
gch¨
 
buf
[500];

207 
	`g_¢¥ötf
(
buf
, 500, "<span color='#808080'>Nick Name:</span><b>%s</b>\n"

213 , 
nick
, 
m¨k«me
, 
qqnum
, 
 ick
);

214 
	`gtk_toﬁtù_£t_m¨kup
(
tù
, 
buf
);

215 
	`gtk_toﬁtù_£t_ic⁄
(
tù
, 
pb
);

216 
	`gtk_åì_võw_£t_toﬁtù_row
(
åì
, 
tù
, 
∑th
);

218 
	`gtk_åì_∑th_‰ì
(
∑th
);

219 
	`g_obje˘_uƒef
(
pb
);

220 
	`g_‰ì
(
nick
);

221 
	`g_‰ì
(
m¨k«me
);

222 
	`g_‰ì
(
 ick
);

223 
	`g_‰ì
(
qqnum
);

224  
TRUE
;

225 
	}
}

227 
	$buddy_åì_⁄_doubÀ_˛ick
(

228 
GtkTªeVõw
 *
åì
, 
GtkTªeP©h
 *
∑th
,

229 
GtkTªeVõwCﬁumn
 *
cﬁ
, 
gpoöãr
 
d©a
)

231 
gch¨
 *
uö
;

232 
GtkTªeModñ
 *
modñ
 = 
	`gtk_åì_võw_gë_modñ
(
åì
);

233 i‡(
	`gtk_åì_∑th_gë_dïth
(
∑th
) < 2) {

237 
GtkTªeIãr
 
ôî
;

238 
	`gtk_åì_modñ_gë_ôî
(
modñ
, &
ôî
, 
∑th
);

239 
	`gtk_åì_modñ_gë
(
modñ
, &
ôî
, 
BDY_UIN
, &
uö
, -1);

241 
GtkWidgë
 *
cw
 = 
	`g_hash_èbÀ_lookup
(
lwqq_ch©_wödow
, 
uö
);

242 i‡(
cw
) {

244 
	`g_obje˘_£t
(
cw
, "uö", 
uö
, 
NULL
);

245 
	`gtk_widgë_show
(
cw
);

246 
	`g_‰ì
(
uö
);

250 
	`g_debug
("Cª©êch© wödow f‹ %s(%s, %d)", 
uö
, 
__FILE__
, 
__LINE__
);

251 
cw
 = 
	`qq_ch©wödow_√w
(
uö
);

252 
	`gtk_widgë_show
(
cw
);

253 
	`g_hash_èbÀ_ö£π
(
lwqq_ch©_wödow
, 
uö
, 
cw
);

254 
	}
}

256 
gboﬁón
 
	$buddy_åì_⁄_rightbuâ⁄_˛ick
(
GtkWidgë
* 
åì


257 , 
GdkEvítBuâ⁄
* 
evít


258 , 
gpoöãr
 
d©a
)

260  
FALSE
;

261 
	}
}

263 
	$åì_m≠_de°roy_vÆue
(
gpoöãr
 
vÆue
)

265 if(
vÆue
 =
NULL
){

268 
GtkTªeRowRe„ªn˚
 *
ªf
 = 
vÆue
;

269 
	`gtk_åì_row_ª„ªn˚_‰ì
(
ªf
);

270 
	}
}

272 
GtkWidgë
* 
	$qq_buddy_åì_√w
()

274 
GtkWidgë
 *
võw

	`gtk_åì_võw_√w
();

275 
GtkCñlRídîî
 *
ªndîî
;

276 
GtkTªeVõwCﬁumn
 *
cﬁumn
;

279 
cﬁumn
 = 
	`gtk_åì_võw_cﬁumn_√w
();

280 
ªndîî
 = 
	`gtk_˚Œ_ªndîî_pixbuf_√w
();

281 
	`gtk_åì_võw_cﬁumn_∑ck_°¨t
(
cﬁumn
, 
ªndîî
, 
FALSE
);

282 
	`gtk_åì_võw_cﬁumn_add_©åibuã
(
cﬁumn
, 
ªndîî
, "pixbuf", 
BDY_TYPE
);

283 
	`gtk_åì_võw_≠≥nd_cﬁumn
(
	`GTK_TREE_VIEW
(
võw
), 
cﬁumn
);

284 
	`gtk_åì_võw_cﬁumn_£t_˚Œ_d©a_func
(
cﬁumn
, 
ªndîî


285 , 
qq_buddy_åì_pixbuf_˚Œ_d©a_func


286 , 
NULL
, NULL);

289 
cﬁumn
 = 
	`gtk_åì_võw_cﬁumn_√w
();

290 
ªndîî
 = 
	`gtk_˚Œ_ªndîî_pixbuf_√w
();

291 
	`gtk_åì_võw_cﬁumn_∑ck_°¨t
(
cﬁumn
, 
ªndîî
, 
FALSE
);

292 
	`gtk_åì_võw_cﬁumn_add_©åibuã
(
cﬁumn
, 
ªndîî
, "pixbuf", 
BDY_IMAGE
);

293 
	`gtk_åì_võw_≠≥nd_cﬁumn
(
	`GTK_TREE_VIEW
(
võw
), 
cﬁumn
);

294 
	`gtk_åì_võw_cﬁumn_£t_˚Œ_d©a_func
(
cﬁumn
, 
ªndîî


295 , 
qq_buddy_åì_pixbuf_˚Œ_d©a_func


296 , 
NULL
, NULL);

299 
cﬁumn
 = 
	`gtk_åì_võw_cﬁumn_√w
();

300 
ªndîî
 = 
	`gtk_˚Œ_ªndîî_ãxt_√w
();

301 
	`gtk_åì_võw_cﬁumn_∑ck_°¨t
(
cﬁumn
, 
ªndîî
, 
TRUE
);

302 
	`gtk_åì_võw_≠≥nd_cﬁumn
(
	`GTK_TREE_VIEW
(
võw
), 
cﬁumn
);

303 
	`gtk_åì_võw_cﬁumn_£t_˚Œ_d©a_func
(
cﬁumn
, 
ªndîî


304 , 
qq_buddy_åì_ãxt_˚Œ_d©a_func


305 , 
NULL
, NULL);

308 
	`gtk_åì_võw_£t_hódîs_visibÀ
(
	`GTK_TREE_VIEW
(
võw
), 
FALSE
);

309 
	`gtk_åì_võw_£t_Àvñ_ödíèti⁄
(
	`GTK_TREE_VIEW
(
võw
), -35);

310 
	`gtk_åì_võw_£t_hovî_£À˘i⁄
(
	`GTK_TREE_VIEW
(
võw
), 
TRUE
);

312 
	`gtk_widgë_£t_has_toﬁtù
(
võw
, 
TRUE
);

313 
	`g_sig«l_c⁄√˘
(
võw
, "query-tooltip"

314 , 
	`G_CALLBACK
(
buddy_åì_⁄_show_toﬁtù
Ë, 
NULL
);

316 
	`g_sig«l_c⁄√˘
(
võw


318 , 
	`G_CALLBACK
(
buddy_åì_⁄_rightbuâ⁄_˛ick
)

319 , 
NULL
);

320 
	`g_sig«l_c⁄√˘
(
võw


322 , 
	`G_CALLBACK
(
buddy_åì_⁄_doubÀ_˛ick
)

323 , 
NULL
);

325 
åì_m≠
 = 
	`g_hash_èbÀ_√w_fuŒ
(
g_°r_hash
, 
g_°r_equÆ
, 
g_‰ì


326 , 
åì_m≠_de°roy_vÆue
);

330 
	`gqq_c⁄fig_¸óã_°r_hash_èbÀ
(
cfg
, "chat_window_map");

332  
võw
;

333 
	}
}

338 
gboﬁón
 
	$˛ór_åìm≠_de°roy
(
gpoöãr
 
key
, gpoöã∏
vÆue
, gpoöã∏
d©a
)

340  
TRUE
;

341 
	}
}

343 
	$åì_°‹e_£t_buddy_öfo
(
GtkTªeSt‹e
 *
°‹e
, 
LwqqBuddy
 *
bdy
,

344 
GtkTªeIãr
 *
ôî
)

347 
GtkWidgë
 *
cw
 = 
	`g_hash_èbÀ_lookup
(
lwqq_ch©_wödow
, 
bdy
->
uö
);

350 
	`gtk_åì_°‹e_£t
(
°‹e
, 
ôî
,

351 
BDY_MARKNAME
, 
bdy
->
m¨k«me
 ?: "",

352 
BDY_NICK
, 
bdy
->
nick
 ?: "", -1);

354 i‡(
cw
) {

355 
	`g_obje˘_£t
(
cw
, "«me", 
bdy
 -> 
m¨k«me
 ?: "", 
NULL
);

359 
	`gtk_åì_°‹e_£t
(
°‹e
, 
ôî
,

360 
BDY_LONGNICK
, 
bdy
->
qqnumbî
 ?: "",

361 
BDY_STATUS
, 
bdy
->
°©us
 ?: "offline",

362 
BDY_QQNUMBER
, 
bdy
->
qqnumbî
 ?: "",

363 
BDY_UIN
, 
bdy
->
uö
, -1);

364 i‡(
cw
) {

365 
	`g_obje˘_£t
(
cw
, "uö", 
bdy
->
uö
, 
NULL
);

368 
gch¨
 
buf
[500];

369 
GdkPixbuf
 *
pb
;

370 
GEº‹
 *
îr
 = 
NULL
;

371 
˘
;

372 i‡(
bdy
->
˛õ¡_ty≥
) {

373 
˘
 = 
	`©oi
(
bdy
->
˛õ¡_ty≥
);

375 
˘
 = 1;

377 
˘
)

380 
	`gtk_åì_°‹e_£t
(
°‹e
, 
ôî
, 
BDY_TYPE
, 
NULL
, -1);

383 
	`g_¢¥ötf
(
buf
, 500, "%s/ph⁄e.≤g", 
lwqq_ic⁄s_dú
);

384 
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe_©_size
(
buf
, 10, 15, &
îr
);

385 if(
îr
 !
NULL
){

386 
	`g_îr‹_‰ì
(
îr
);

387 
îr
 = 
NULL
;

389 
	`gtk_åì_°‹e_£t
(
°‹e
, 
ôî
, 
BDY_TYPE
, 
pb
, -1);

390 
	`g_obje˘_uƒef
(
pb
);

393 
	`g_¢¥ötf
(
buf
, 500, "%s/webqq.≤g", 
lwqq_ic⁄s_dú
);

394 
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe_©_size
(
buf
, 15, 15, &
îr
);

395 if(
îr
 !
NULL
){

396 
	`g_îr‹_‰ì
(
îr
);

397 
îr
 = 
NULL
;

399 
	`gtk_åì_°‹e_£t
(
°‹e
, 
ôî
, 
BDY_TYPE
, 
pb
, -1);

400 
	`g_obje˘_uƒef
(
pb
);

407 
pb
 = 
	`¸óã_Á˚_image
(
bdy
->
qqnumbî
, 20, 20);

408 
	`gtk_åì_°‹e_£t
(
°‹e
, 
ôî
, 
BDY_IMAGE
, 
pb
, -1);

409 
	`g_obje˘_uƒef
(
pb
);

412 
pb
 = 
	`¸óã_Á˚_image
(
bdy
->
qqnumbî
, 80, 80);

413 
	`gtk_åì_°‹e_£t
(
°‹e
, 
ôî
, 
BDY_TOOLTIPIMAGE
, 
pb
, -1);

414 
	`g_obje˘_uƒef
(
pb
);

415 
	}
}

420 
GtkTªeModñ
 *
	$¸óã_modñ
(
LwqqClõ¡
 *
lc
)

422 
LwqqFrõndC©eg‹y
 *
ˇã
;

424 
	`g_hash_èbÀ_f‹óch_ªmove
(
åì_m≠
, 
˛ór_åìm≠_de°roy
, 
NULL
);

426 
GtkTªeIãr
 
ôî
;

427 
GtkTªeSt‹e
 *
°‹e
 = 
	`gtk_åì_°‹e_√w
(
COLUMNS
,

428 
GDK_TYPE_PIXBUF
,

429 
GDK_TYPE_PIXBUF
,

430 
G_TYPE_STRING
,

431 
G_TYPE_STRING
,

432 
G_TYPE_STRING
,

433 
G_TYPE_STRING
,

434 
G_TYPE_STRING
,

435 
G_TYPE_STRING
,

436 
GDK_TYPE_PIXBUF
,

437 
G_TYPE_INT
,

438 
G_TYPE_INT
,

439 
G_TYPE_INT
);

440 
	`LIST_FOREACH
(
ˇã
, &
lc
->
ˇãg‹õs
, 
íåõs
) {

441 
GtkTªeIãr
 
chûd
;

442 
LwqqBuddy
 *
buddy
;

443 
j
 = 0;

444 
	`gtk_åì_°‹e_≠≥nd
(
°‹e
, &
ôî
, 
NULL
);

445 
	`gtk_åì_°‹e_£t
(
°‹e
, &
ôî
, 
BDY_MARKNAME
, 
ˇã
->
«me
,

446 
CATE_CNT
, 0,

447 
CATE_TOTAL
, 
ˇã
->
cou¡
,

448 
CATE_INDEX
, 
ˇã
->
ödex
, -1);

451 
	`LIST_FOREACH
(
buddy
, &
lc
->
‰õnds
, 
íåõs
) {

452 
GtkTªeP©h
 *
∑th
;

453 
GtkTªeRowRe„ªn˚
 *
ªf
;

454 i‡(
	`©oi
(
buddy
->
ˇã_ödex
Ë!
ˇã
->
ödex
) {

459 i‡(++
j
 > 
ˇã
->
cou¡
) {

460 
	`lwqq_log
(
LOG_ERROR
, "BUG!!!!!\n");

464 
	`gtk_åì_°‹e_≠≥nd
(
°‹e
, &
chûd
, &
ôî
);

465 
	`åì_°‹e_£t_buddy_öfo
(
°‹e
, 
buddy
, &
chûd
);

467 
∑th
 = 
	`gtk_åì_modñ_gë_∑th
(
	`GTK_TREE_MODEL
(
°‹e
), &
chûd
);

468 
ªf
 = 
	`gtk_åì_row_ª„ªn˚_√w
(
	`GTK_TREE_MODEL
(
°‹e
), 
∑th
);

469 
	`gtk_åì_∑th_‰ì
(
∑th
);

472 
	`g_hash_èbÀ_ö£π
(
åì_m≠
, 
	`g_°rdup
(
buddy
->
uö
), 
ªf
);

476 
j
 = 0; j < 
ˇã
->
cou¡
; ++j) {

477 
	`gtk_åì_°‹e_≠≥nd
(
°‹e
, &
chûd
, &
ôî
);

478 
bdy
 = (
QQBuddy
*Ë
ˇã
 -> 
membîs
 -> 
pd©a
[
j
];

480 
	`åì_°‹e_£t_buddy_öfo
(
°‹e
, 
bdy
, &
chûd
);

483 
∑th
 = 
	`gtk_åì_modñ_gë_∑th
(
	`GTK_TREE_MODEL
(
°‹e
), &
chûd
);

484 
ªf
 = 
	`gtk_åì_row_ª„ªn˚_√w
(
	`GTK_TREE_MODEL
(
°‹e
), 
∑th
);

485 
	`gtk_åì_∑th_‰ì
(
∑th
);

488 
	`g_hash_èbÀ_ö£π
(
åì_m≠
, 
	`g_°rdup
(
bdy
 -> 
uö
 -> 
°r
), 
ªf
);

493  
	`GTK_TREE_MODEL
(
°‹e
);

494 
	}
}

500 
	$upd©e_Á˚_image
(
GtkWidgë
 *
åì
, 
LwqqClõ¡
 *
lc
, c⁄° 
gch¨
 *
uö
)

503 
QQBuddy
 *
bdy
 = 
	`qq_öfo_lookup_buddy_by_uö
(
öfo
 , 
uö
);

504 if(
bdy
 =
NULL
){

508 
GtkTªeModñ
 *
modñ
;

509 
modñ
 = 
	`gtk_åì_võw_gë_modñ
(
	`GTK_TREE_VIEW
(
åì
));

510 
GtkTªeRowRe„ªn˚
 *
ªf
 = 
	`g_hash_èbÀ_lookup
(
åì_m≠
, 
uö
);

511 if(
ªf
 =
NULL
){

512 
	`g_w¨nög
("NÿTªeM≠ f‹ %s(%s, %d)", 
uö
, 
__FILE__
, 
__LINE__
);

516 
GtkTªeP©h
 *
∑th
;

517 
GtkTªeIãr
 
ôî
;

518 
∑th
 = 
	`gtk_åì_row_ª„ªn˚_gë_∑th
(
ªf
);

519 
	`gtk_åì_modñ_gë_ôî
(
modñ
, &
ôî
, 
∑th
);

521 
GdkPixbuf
 *
pb
 = 
	`¸óã_Á˚_image
(
bdy
 -> 
qqnumbî
 -> 
°r
, 20, 20);

522 
	`gtk_åì_°‹e_£t
(
	`GTK_TREE_STORE
(
modñ
), &
ôî
, 
BDY_IMAGE
, 
pb
, -1);

523 
	`g_obje˘_uƒef
(
pb
);

524 
pb
 = 
	`¸óã_Á˚_image
(
bdy
 -> 
qqnumbî
 -> 
°r
, 80, 80);

525 
	`gtk_åì_°‹e_£t
(
	`GTK_TREE_STORE
(
modñ
), &
ôî
, 
BDY_TOOLTIPIMAGE
, 
pb
, -1);

526 
	`g_obje˘_uƒef
(
pb
);

528 
	`gtk_åì_°‹e_£t
(
	`GTK_TREE_STORE
(
modñ
), &
ôî


529 , 
BDY_QQNUMBER
, 
bdy
 -> 
qqnumbî
 -> 
°r
, -1);

530 
	`gtk_åì_∑th_‰ì
(
∑th
);

533 
GtkWidgë
 *
cw
 = 
	`gqq_c⁄fig_lookup_ht
(
cfg
, "ch©_wödow_m≠", 
uö
);

534 if(
cw
 !
NULL
){

535 
	`g_obje˘_£t
(
cw
, "qqnumbî", 
bdy
 -> 
qqnumbî
 -> 
°r
, 
NULL
);

538 
	}
}

540 
	$qq_buddy_åì_upd©e_Á˚img
(
GtkWidgë
 *
åì
, 
LwqqClõ¡
 *
lc
)

544 
göt
 
i
;

545 
QQBuddy
 *
bdy
;

546 
i
 = 0; i < 
öfo
 -> 
buddõs
 -> 
Àn
; ++i){

547 
bdy
 = (
QQBuddy
*)
	`g_±r_¨øy_ödex
(
öfo
 -> 
buddõs
, 
i
);

548 if(
bdy
 =
NULL
){

551 
	`upd©e_Á˚_image
(
åì
, 
öfo
, 
bdy
 -> 
uö
 -> 
°r
);

554 
	}
}

556 
	$qq_buddy_åì_upd©e_modñ
(
GtkWidgë
 *
åì
, 
LwqqClõ¡
 *
lc
)

559 
	`gtk_åì_võw_£t_modñ
(
	`GTK_TREE_VIEW
(
åì
)

560 , 
	`¸óã_modñ
(
lc
));

561 
	}
}

563 
	$qq_buddy_åì_upd©e_⁄löe_buddõs
(
GtkWidgë
 *
åì
, 
LwqqClõ¡
 *
lc
)

565 
göt
 
ˇã_˙t
;

567 
GtkTªeP©h
 *
∑th
;

568 
GtkTªeIãr
 
ôî
, 
ˇã_ôî
;

569 
GtkTªeModñ
 *
modñ
;

570 
GtkTªeRowRe„ªn˚
 *
ªf
;

571 
modñ
 = 
	`gtk_åì_võw_gë_modñ
(
	`GTK_TREE_VIEW
(
åì
));

572 
GtkWidgë
 *
cw
;

573 
LwqqBuddy
 *
bdy
;

576 
LwqqFrõndC©eg‹y
 *
ˇã
;

577 
	`LIST_FOREACH
(
ˇã
, &
lc
->
ˇãg‹õs
, 
íåõs
) {

578 if(!
	`gë_ˇãg‹y_ôî_by_ödex
(
modñ
, 
ˇã
->
ödex
, &
ˇã_ôî
)){

581 
	`gtk_åì_°‹e_£t
(
	`GTK_TREE_STORE
(
modñ
), &
ˇã_ôî
, 
CATE_CNT
, 0, -1);

584 
	#MOVE_TO_FIRST
(
x
) \

585 
	`LIST_FOREACH
(
bdy
, &
lc
->
‰õnds
, 
íåõs
) { \

586 i‡(
	`g_°rcmp0
(
bdy
->
°©us
, 
x
) == 0) { \

587 
ªf
 = 
	`g_hash_èbÀ_lookup
(
åì_m≠
, 
bdy
->
uö
); \

588 i‡(
ªf
 =
NULL
) { \

589 
	`g_w¨nög
("No TreeMap for %s. We mayÇeedádd it..(%s, %d)" \

590 , 
bdy
->
uö
, 
__FILE__
, 
__LINE__
); \

593 
∑th
 = 
	`gtk_åì_row_ª„ªn˚_gë_∑th
(
ªf
); \

594 
	`gtk_åì_modñ_gë_ôî
(
modñ
, &
ôî
, 
∑th
); \

595 
	`åì_°‹e_£t_buddy_öfo
(
	`GTK_TREE_STORE
(
modñ
), 
bdy
, &
ôî
); \

596 
	`gtk_åì_∑th_‰ì
(
∑th
); \

597 
	`gtk_åì_°‹e_move_a·î
(
	`GTK_TREE_STORE
(
modñ
), &
ôî
, 
NULL
); \

598 if(!
	`gë_ˇãg‹y_ôî_by_ödex
(
modñ
, 
	`©oi
(
bdy
->
ˇã_ödex
), &
ˇã_ôî
)){ \

599 
	`g_w¨nög
("Nÿˇãg‹y'†ödex i†%†(%s, %d)", 
bdy
 -> 
ˇã_ödex
 \

600 , 
__FILE__
, 
__LINE__
); \

602 
	`gtk_åì_modñ_gë
(
modñ
, &
ˇã_ôî
, 
CATE_CNT
, &
ˇã_˙t
, -1); \

603 ++
ˇã_˙t
; \

604 
	`gtk_åì_°‹e_£t
(
	`GTK_TREE_STORE
(
modñ
), &
ˇã_ôî
, \

605 
CATE_CNT
, 
ˇã_˙t
, -1); \

607 
cw
 = 
	`g_hash_èbÀ_lookup
(
lwqq_ch©_wödow
, 
bdy
->
uö
); \

608 if(
cw
){ \

609 
	`g_obje˘_£t
(
cw
, "°©us", 
bdy
 -> 
°©us
 ?: "ofÊöe", 
NULL
); \

612 }

	)

614 
	`MOVE_TO_FIRST
("busy");

615 
	`MOVE_TO_FIRST
("away");

616 
	`MOVE_TO_FIRST
("silent");

617 
	`MOVE_TO_FIRST
("online");

618 
	`MOVE_TO_FIRST
("callme");

619 #unde‡
MOVE_TO_FIRST


620 
	}
}

622 
	$qq_buddy_åì_upd©e_buddy_öfo
(
GtkWidgë
 *
åì
, 
LwqqClõ¡
 *
lc
)

624 
LwqqBuddy
 *
bdy
;

625 
GtkTªeP©h
 *
∑th
;

626 
GtkTªeIãr
 
ôî
;

627 
GtkTªeModñ
 *
modñ
;

628 
GtkTªeRowRe„ªn˚
 *
ªf
;

629 
modñ
 = 
	`gtk_åì_võw_gë_modñ
(
	`GTK_TREE_VIEW
(
åì
));

631 
	`LIST_FOREACH
(
bdy
, &
lc
->
‰õnds
, 
íåõs
) {

632 
ªf
 = 
	`g_hash_èbÀ_lookup
(
åì_m≠
, 
bdy
 -> 
uö
);

633 if(
ªf
 =
NULL
){

634 
	`g_w¨nög
("No TreeMap for %s. We mayÇeedádd it..(%s, %d)"

635 , 
bdy
 -> 
uö
, 
__FILE__
, 
__LINE__
);

638 
∑th
 = 
	`gtk_åì_row_ª„ªn˚_gë_∑th
(
ªf
);

639 
	`gtk_åì_modñ_gë_ôî
(
modñ
, &
ôî
, 
∑th
);

640 
	`åì_°‹e_£t_buddy_öfo
(
	`GTK_TREE_STORE
(
modñ
), 
bdy
, &
ôî
);

641 
	`gtk_åì_∑th_‰ì
(
∑th
);

643 
	}
}

	@src/gui/buddytree.h

1 #i‚de‡
__GTKQQ_BUDDY_TREE_H


2 
	#__GTKQQ_BUDDY_TREE_H


	)

3 
	~<gtk/gtk.h
>

4 
	~"ty≥.h
"

9 
GtkWidgë
* 
qq_buddy_åì_√w
();

13 
qq_buddy_åì_upd©e_modñ
(
GtkWidgë
 *
åì
, 
LwqqClõ¡
 *
lc
);

17 
qq_buddy_åì_upd©e_Á˚img
(
GtkWidgë
 *
åì
, 
LwqqClõ¡
 *
lc
);

21 
qq_buddy_åì_upd©e_⁄löe_buddõs
(
GtkWidgë
 *
åì
, 
LwqqClõ¡
 *
lc
);

25 
qq_buddy_åì_upd©e_buddy_öfo
(
GtkWidgë
 *
åì
, 
LwqqClõ¡
 *
lc
);

	@src/gui/chattextview.c

1 
	~<ch©ãxtvõw.h
>

2 
	~<°dlib.h
>

3 
	~<°rög.h
>

5 
qq_ch©_ãxtvõw_öô
(
QQCh©Textvõw
 *
võw
);

6 
qq_ch©_ãxtvõw˛ass_öô
(
QQCh©TextvõwCœss
 *
kœss
);

8 
LwqqClõ¡
 *
lwqq_˛õ¡
;

9 *
lwqq_ö°Æl_dú
;

10 *
lwqq_ic⁄s_dú
;

11 *
lwqq_buddy_°©us_dú
;

12 
GtkWidgë
 *
maö_wö
;

14 
göt
 
	gÁ˚_å™s„r_èbÀ
[] = {14, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11

33 
	mQQ_WIDGET_FACE_T
,

34 
	mQQ_WIDGET_UNKNOWN_T


35 }
	tQQWidgëTy≥
;

40 
GtkTextM¨k
 *
	mbegö
, *
	míd
;

41 
QQWidgëTy≥
 
	mty≥
;

43 
göt
 
	mÁ˚
;

44 
gpoöãr
 
	mp
;

45 }
	md©a
;

46 }
	tQQWidgëM¨k
;

50 
GPåAºay
 *
	mmsgf⁄ts
;

51 
göt
 
	mcur_f⁄t_ödex
;

55 
gboﬁón
 
	mdeÁu…_undîlöe
;

57 
GPåAºay
 *
	mwidgë_m¨ks
;;

59 
GtkTextM¨k
 *
	míd_m¨k
, *
	mö£πed_À·_m¨k
;

60 }
	tQQCh©TextvõwPriv
;

62 
GTy≥
 
	$qq_ch©_ãxtvõw_gë_ty≥
()

64 
GTy≥
 
t
 = 0;

65 if(!
t
){

66 c⁄° 
GTy≥Info
 
öfo
 =

68 (
QQCh©TextvõwCœss
),

69 
NULL
,

70 
NULL
,

71 (
GCœssInôFunc
)
qq_ch©_ãxtvõw˛ass_öô
,

72 
NULL
,

73 
NULL
,

74 (
QQCh©Textvõw
),

76 (
GIn°™˚InôFunc
)
qq_ch©_ãxtvõw_öô
,

80 
t
 = 
	`g_ty≥_ªgi°î_°©ic
(
GTK_TYPE_TEXT_VIEW
, "QQChatTextview"

81 , &
öfo
, 0);

83  
t
;

84 
	}
}

86 
GtkWidgë
* 
	$qq_ch©_ãxtvõw_√w
()

88  
	`GTK_WIDGET
(
	`g_obje˘_√w
(
	`qq_ch©_ãxtvõw_gë_ty≥
(), 
NULL
));

89 
	}
}

94 
	$qq_ch©wödow_ãxt_buf„r_¸óã_ègs
(
GtkTextBuf„r
 *
ãxtbuf
)

96 
	`gtk_ãxt_buf„r_¸óã_èg
(
ãxtbuf
, "blue", "f‹eground", "blue", 
NULL
);

97 
	`gtk_ãxt_buf„r_¸óã_èg
(
ãxtbuf
, "gªy", "f‹eground", "gªy", 
NULL
);

98 
	`gtk_ãxt_buf„r_¸óã_èg
(
ãxtbuf
, "gªí", "f‹eground", "d¨kgªí", 
NULL
);

99 
	`gtk_ãxt_buf„r_¸óã_èg
(
ãxtbuf
, "ªd", "f‹eground", "ªd", 
NULL
);

100 
	`gtk_ãxt_buf„r_¸óã_èg
(
ãxtbuf
, "underline", "underline"

101 , 
PANGO_UNDERLINE_SINGLE
, 
NULL
);

102 
	`gtk_ãxt_buf„r_¸óã_èg
(
ãxtbuf
, "À·_m¨gö1", "À·_m¨gö", 5, 
NULL
);

103 
	`gtk_ãxt_buf„r_¸óã_èg
(
ãxtbuf
, "À·_m¨gö2", "À·_m¨gö", 20, 
NULL
);

104 
	}
}

109 
	$qq_ch©_buf„r_ö£π_ãxt
(
GtkTextBuf„r
 *
ãxtbuf


110 , 
GtkTextIãr
 *
pos


111 , 
gch¨
 *
ãxt


112 , 
göt
 
Àn


113 , 
gpoöãr
 
d©a
)

115 
QQCh©TextvõwPriv
 *
¥iv
 = 
d©a
;

116 if(
¥iv
 -> 
deÁu…_undîlöe
){

117 
GtkTextIãr
 
°¨t
, 
íd
;

118 
	`gtk_ãxt_buf„r_gë_°¨t_ôî
(
ãxtbuf
, &
°¨t
);

119 
	`gtk_ãxt_buf„r_gë_íd_ôî
(
ãxtbuf
, &
íd
);

120 
	`gtk_ãxt_buf„r_≠∂y_èg_by_«me
(
ãxtbuf
, "undîlöe", &
°¨t
, &
íd
);

122 
	}
}

130 
	$qq_ch©_ãxtvõw_add_mesßge
(
QQCh©Textvõw
 *
võw
, 
LwqqMsgMesßge
 *
msg
)

132 
LwqqBuddy
 *
bdy
 = 
	`lwqq_buddy_föd_buddy_by_uö
(
lwqq_˛õ¡
, 
msg
->
‰om
);

133 
gch¨
 *
«me
;

134 i‡(
bdy
) {

135 
«me
 = 
bdy
->
m¨k«me
 ?: bdy->
nick
;

137 
«me
 = 
msg
->
‰om
;

139 *
cﬁ‹_èg
 = "blue";

140 
QQCh©TextvõwPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(

141 
võw
, 
	`qq_ch©_ãxtvõw_gë_ty≥
(), 
QQCh©TextvõwPriv
);

143 
GtkTextBuf„r
 *
ãxtbuf
 = 
	`gtk_ãxt_võw_gë_buf„r
(
	`GTK_TEXT_VIEW
(
võw
));

145 
GtkTextIãr
 
íd_ôî
;

146 
GD©eTime
 *
t
 = 
	`g_d©e_time_√w_‰om_unix_loˇl
(
msg
->
time
);

147 
gch¨
 
hód
[500];

148 i‡(
	`gtk_ãxt_buf„r_gë_löe_cou¡
(
ãxtbuf
) > 1) {

150 
	`gtk_ãxt_buf„r_gë_íd_ôî
(
ãxtbuf
, &
íd_ôî
);

151 
	`gtk_ãxt_buf„r_ö£π
(
ãxtbuf
, &
íd_ôî
, "\n", -1);

155 
göt
 
hód_Àn
;

156 
hód_Àn
 = 
	`g_¢¥ötf
(
hód
, 500, "%†%d-%d-%d %d:%d:%d\n", 
«me
,

157 
	`g_d©e_time_gë_yór
(
t
),

158 
	`g_d©e_time_gë_m⁄th
(
t
),

159 
	`g_d©e_time_gë_day_of_m⁄th
(
t
),

160 
	`g_d©e_time_gë_hour
(
t
),

161 
	`g_d©e_time_gë_möuã
(
t
),

162 
	`g_d©e_time_gë_£c⁄d
(
t
));

163 
	`gtk_ãxt_buf„r_gë_íd_ôî
(
ãxtbuf
, &
íd_ôî
);

164 
	`gtk_ãxt_buf„r_ö£π_wôh_ègs_by_«me
(
ãxtbuf
, &
íd_ôî
, 
hód
,

165 
hód_Àn
, 
cﬁ‹_èg
,

166 "À·_m¨gö1", 
NULL
);

169 
	`qq_ch©_ãxtvõw_£t_f⁄t
(
	`GTK_WIDGET
(
võw
), 
msg
->
f_«me
, msg->
f_cﬁ‹
,

170 
msg
->
f_size
, msg->
f_°yÀ
.
a
, msg->f_°yÀ.
b
,

171 
msg
->
f_°yÀ
.
c
);

173 
LwqqMsgC⁄ã¡
 *
c
;

174 
	`TAILQ_FOREACH
(
c
, &
msg
->
c⁄ã¡
, 
íåõs
) {

175 i‡(
c
->
ty≥
 =
LWQQ_CONTENT_STRING
) {

176 
	`qq_ch©_ãxtvõw_add_°rög
(
	`GTK_WIDGET
(
võw
),

177 
c
->
d©a
.
°r
, 
	`°æí
(c->data.str));

179 i‡(
c
->
d©a
.
Á˚
 > 134) {

182 
	`qq_ch©_ãxtvõw_add_Á˚
(
	`GTK_WIDGET
(
võw
), 
c
->
d©a
.
Á˚
);

187 
	`gtk_ãxt_buf„r_gë_íd_ôî
(
ãxtbuf
, &
íd_ôî
);

188 
	`gtk_ãxt_buf„r_ö£π
(
ãxtbuf
, &
íd_ôî
, "\n", -1);

191 
	`gtk_ãxt_ôî_£t_löe_off£t
(&
íd_ôî
, 0);

192 
	`gtk_ãxt_buf„r_move_m¨k
(
ãxtbuf
, 
¥iv
 -> 
íd_m¨k
, &
íd_ôî
);

193 
	`gtk_ãxt_võw_s¸ﬁl_m¨k_⁄s¸ìn
(
	`GTK_TEXT_VIEW
(
võw
)

194 , 
¥iv
 -> 
íd_m¨k
);

196 
	}
}

198 
	$qq_ch©_ãxtvõw_öô
(
QQCh©Textvõw
 *
võw
)

200 
GtkTextBuf„r
 *
ãxtbuf
 = 
	`gtk_ãxt_võw_gë_buf„r
(

201 
	`GTK_TEXT_VIEW
(
võw
));

202 
	`qq_ch©wödow_ãxt_buf„r_¸óã_ègs
(
ãxtbuf
);

204 
QQCh©TextvõwPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(

205 
võw
, 
	`qq_ch©_ãxtvõw_gë_ty≥
()

206 , 
QQCh©TextvõwPriv
);

207 
GtkTextIãr
 
ôî
;

208 
	`gtk_ãxt_buf„r_gë_íd_ôî
(
ãxtbuf
, &
ôî
);

209 
¥iv
 -> 
íd_m¨k
 = 
	`gtk_ãxt_buf„r_¸óã_m¨k
(
ãxtbuf
, "scrollend"

210 , &
ôî
, 
FALSE
);

211 
¥iv
 -> 
ö£πed_À·_m¨k
 = 
	`gtk_ãxt_buf„r_¸óã_m¨k
(
ãxtbuf


213 , &
ôî
, 
TRUE
);

214 
¥iv
 -> 
msgf⁄ts
 = 
	`g_±r_¨øy_√w
();

215 
¥iv
 -> 
cur_f⁄t_ödex
 = -1;

216 
¥iv
 -> 
widgë_m¨ks
 = 
	`g_±r_¨øy_√w
();

221 
	`g_sig«l_c⁄√˘_a·î
(
	`G_OBJECT
(
ãxtbuf
), "insert-text"

222 , 
	`G_CALLBACK
(
qq_ch©_buf„r_ö£π_ãxt
), 
¥iv
);

223 
	}
}

225 
	$qq_ch©_ãxtvõw˛ass_öô
(
QQCh©TextvõwCœss
 *
kœss
)

227 
	`g_ty≥_˛ass_add_¥iv©e
(
kœss
, (
QQCh©TextvõwPriv
));

228 
	}
}

230 
	$qq_ch©_ãxtvõw_add_£nd_mesßge
(
GtkWidgë
 *
widgë
, 
LwqqMsg
 *
msg
)

232 i‡(
widgë
 =
NULL
 || 
msg
 == NULL) {

236 
LwqqMsgMesßge
 *
mmsg
 = 
msg
->
›aque
;

237 
	`qq_ch©_ãxtvõw_add_mesßge
(
	`QQ_CHAT_TEXTVIEW
(
widgë
), 
mmsg
);

238 
	}
}

240 
	$qq_ch©_ãxtvõw_add_ªcv_mesßge
(
GtkWidgë
 *
widgë
, 
LwqqMsgMesßge
 *
msg
)

242 i‡(!
widgë
 || !
msg
) {

247 
QQGMembî
 *
mb
 = 
NULL
;

248 
QQGroup
 *
gp
 = 
NULL
;

249 
GSåög
 *
code
 = 
msg
->
group_code
;

250 c⁄° 
gch¨
 *
«me
 = 
NULL
;

251 i‡(
code
 && code->
Àn
 > 0) {

256 
gp
 = 
	`qq_öfo_lookup_group_by_code
(
öfo
, 
code
->
°r
);

257 i‡(!
gp
) {

258 
«me
 = 
msg
 -> 
‰om_uö
 -> 
°r
;

260 
mb
 = 
	`qq_group_lookup_membî_by_uö
(
gp
, 
msg
->
£nd_uö
->
°r
);

261 i‡(
mb
)

262 
«me
 = 
mb
->
nick
->
°r
;

264 
«me
 = 
msg
->
‰om_uö
->
°r
;

270 
	}
}

272 
qq_ch©_ãxtvõw_add_mesßge
(
QQ_CHAT_TEXTVIEW
(
widgë
), 
msg
);

275 
qq_ch©_ãxtvõw_add_Á˚
(
GtkWidgë
 *
widgë
, 
göt
 
Á˚
)

277 if(
	gwidgë
 =
NULL
 || 
Á˚
 > 134){

280 
göt
 
	gi
;

281 
göt
 
	gªÆ_Á˚
 = 
Á˚
;

282 
	gi
 = 0; i < 135; ++i){

283 if(
	gÁ˚_å™s„r_èbÀ
[
i
] =
Á˚
){

284 
ªÆ_Á˚
 = 
i
;

289 
QQWidgëM¨k
 *
	gm¨k
 = 
g_¶i˚_√w0
(QQWidgetMark);

290 
gch¨
 
	g∑th
[500];

291 
g_¢¥ötf
(
∑th
, 500, "%s/qqÁ˚s/%d.gif", 
lwqq_ic⁄s_dú
, 
ªÆ_Á˚
);

292 
GtkWidgë
 *
	gimg
 = 
gtk_image_√w_‰om_fûe
(
∑th
);

293 
gtk_widgë_show
(
img
);

294 
GtkTextBuf„r
 *
	gãxtbuf
 = 
gtk_ãxt_võw_gë_buf„r
(
GTK_TEXT_VIEW
(
widgë
));

295 
GtkTextIãr
 
	gôî
;

296 
GtkTextChûdAnch‹
 *
	g™ch‹
;

297 
gtk_ãxt_buf„r_gë_íd_ôî
(
ãxtbuf
, &
ôî
);

298 
	gm¨k
 -> 
	gbegö
 = 
gtk_ãxt_buf„r_¸óã_m¨k
(
ãxtbuf
, 
NULL
, &
ôî
, 
TRUE
);

299 
	g™ch‹
 = 
gtk_ãxt_buf„r_¸óã_chûd_™ch‹
(
ãxtbuf
, &
ôî
);

300 
gtk_ãxt_võw_add_chûd_©_™ch‹
(
GTK_TEXT_VIEW
(
widgë
), 
img
, 
™ch‹
);

301 
gtk_ãxt_buf„r_gë_íd_ôî
(
ãxtbuf
, &
ôî
);

302 
	gm¨k
 -> 
	gíd
 = 
gtk_ãxt_buf„r_¸óã_m¨k
(
ãxtbuf
, 
NULL
, &
ôî
, 
TRUE
);

304 
GtkTextIãr
 
	g°¨t_ôî
, 
	gíd_ôî
;

305 
gtk_ãxt_buf„r_gë_ôî_©_m¨k
(
ãxtbuf
, &
°¨t_ôî
, 
m¨k
 -> 
begö
);

306 
gtk_ãxt_buf„r_gë_ôî_©_m¨k
(
ãxtbuf
, &
íd_ôî
, 
m¨k
 -> 
íd
);

307 
gtk_ãxt_buf„r_≠∂y_èg_by_«me
(
ãxtbuf
, "left_margin2"

308 , &
°¨t_ôî
, &
íd_ôî
);

310 
QQCh©TextvõwPriv
 *
	g¥iv
 = 
G_TYPE_INSTANCE_GET_PRIVATE
(

311 
widgë
, 
qq_ch©_ãxtvõw_gë_ty≥
()

312 , 
QQCh©TextvõwPriv
);

313 
	gm¨k
 -> 
	gd©a
.
	gÁ˚
 = 
Á˚
;

314 
	gm¨k
 -> 
	gty≥
 = 
QQ_WIDGET_FACE_T
;

315 
g_±r_¨øy_add
(
¥iv
 -> 
widgë_m¨ks
, 
m¨k
);

318 
qq_ch©_ãxtvõw_add_°rög
(
GtkWidgë
 *
widgë
, c⁄° 
gch¨
 *
°r
, 
göt
 
Àn
)

320 
QQCh©TextvõwPriv
 *
	g¥iv
 = 
G_TYPE_INSTANCE_GET_PRIVATE
(

321 
widgë
, 
qq_ch©_ãxtvõw_gë_ty≥
()

322 , 
QQCh©TextvõwPriv
);

323 
GtkTextIãr
 
	g°¨t_ôî
, 
	gíd_ôî
;

324 
GtkTextBuf„r
 *
	gãxtbuf
 = 
gtk_ãxt_võw_gë_buf„r
(
GTK_TEXT_VIEW
(
widgë
));

325 
gtk_ãxt_buf„r_gë_íd_ôî
(
ãxtbuf
, &
íd_ôî
);

326 
gtk_ãxt_buf„r_move_m¨k
(
ãxtbuf
, 
¥iv
 -> 
ö£πed_À·_m¨k


327 , &
íd_ôî
);

328 
gtk_ãxt_buf„r_ö£π_wôh_ègs_by_«me
(
ãxtbuf
, &
íd_ôî
, 
°r
, 
Àn


329 , "À·_m¨gö2", 
NULL
);

331 
gch¨
 
	gèg«me
[100];

332 if(
	g¥iv
 -> 
	gcur_f⁄t_ödex
 >= 0){

333 
g_¢¥ötf
(
èg«me
, 100, "msgf⁄âag%d", 
¥iv
 -> 
cur_f⁄t_ödex
);

334 
gtk_ãxt_buf„r_gë_ôî_©_m¨k
(
ãxtbuf
, &
°¨t_ôî


335 , 
¥iv
 -> 
ö£πed_À·_m¨k
);

336 
gtk_ãxt_buf„r_≠∂y_èg_by_«me
(
ãxtbuf
, 
èg«me


337 , &
°¨t_ôî


338 , &
íd_ôî
);

342 
qq_ch©_ãxtvõw_£t_f⁄t
(
GtkWidgë
 *
widgë
, c⁄° 
gch¨
 *
«me


343 , c⁄° 
gch¨
 *
cﬁ‹


344 , 
göt
 
size


345 , 
göt
 
a
, göà
b
, göà
c
)

348 
QQCh©TextvõwPriv
 *
	g¥iv
 = 
G_TYPE_INSTANCE_GET_PRIVATE
(

349 
widgë
, 
qq_ch©_ãxtvõw_gë_ty≥
()

350 , 
QQCh©TextvõwPriv
);

351 
QQMsgF⁄t
 *
	gf⁄t
 = 
NULL
;

352 
göt
 
	gi
;

353 
	gi
 = 0; i < 
	g¥iv
 -> 
	gmsgf⁄ts
 -> 
	gÀn
; ++i){

354 
	gf⁄t
 = 
g_±r_¨øy_ödex
(
¥iv
 -> 
msgf⁄ts
, 
i
);

355 if(
g_°rcmp0
(
«me
, 
f⁄t
 ->Çamê-> 
°r
) == 0

356 && 
g_°rcmp0
(
cﬁ‹
, 
f⁄t
 -> cﬁ‹ -> 
°r
) == 0

357 && 
size
 =
f⁄t
 -> size

358 && 
a
 =
f⁄t
 -> 
°yÀ
.a

359 && 
b
 =
f⁄t
 -> 
°yÀ
.b

360 && 
c
 =
f⁄t
 -> 
°yÀ
.c){

364 if(
	gi
 < 
	g¥iv
 -> 
	gmsgf⁄ts
 -> 
	gÀn
){

366 
	g¥iv
 -> 
	gcur_f⁄t_ödex
 = 
i
;

371 
gch¨
 
	gf⁄âag«me
[100];

372 
gch¨
 
	gcﬁ‹°r
[100];

373 
g_¢¥ötf
(
f⁄âag«me
, 100, "msgf⁄âag%d", 
¥iv
 -> 
msgf⁄ts
 -> 
Àn
);

374 
GtkTextBuf„r
 *
	gãxtbuf
 = 
gtk_ãxt_võw_gë_buf„r
(
GTK_TEXT_VIEW
(
widgë
));

375 
g_¢¥ötf
(
cﬁ‹°r
, 100, "#%s", 
cﬁ‹
);

376 
GtkTextTag
 *
	gèg
 = 
gtk_ãxt_buf„r_¸óã_èg
(
ãxtbuf
, 
f⁄âag«me


377 , "Ámûy", 
«me


378 , "f‹eground", 
cﬁ‹°r


379 , "size", 
size
 * 
PANGO_SCALE


380 , 
NULL
);

381 if(
	ga
 == 1){

382 
g_obje˘_£t
(
èg
, "weight", 
PANGO_WEIGHT_BOLD
, 
NULL
);

384 if(
	gb
 == 1){

385 
g_obje˘_£t
(
èg
, "°yÀ", 
PANGO_STYLE_ITALIC
, 
NULL
);

387 if(
	gc
 == 1){

388 
g_obje˘_£t
(
èg
, "undîlöe", 
PANGO_UNDERLINE_SINGLE
, 
NULL
);

391 
g_±r_¨øy_add
(
¥iv
 -> 
msgf⁄ts
, 
qq_msgf⁄t_√w
(
«me
, 
size
, 
cﬁ‹


392 , 
a
, 
b
, 
c
));

393 
	g¥iv
 -> 
	gcur_f⁄t_ödex
 = 
¥iv
 -> 
msgf⁄ts
 -> 
Àn
 - 1;

394 
g_debug
("Create fontÅag %s : %s %s %d %d %d %d(%s, %d)"

395 , 
f⁄âag«me
, 
«me
, 
cﬁ‹
, 
size
, 
a
, 
b
, 
c


396 , 
__FILE__
, 
__LINE__
);

400 
qq_ch©_ãxtvõw_£t_deÁu…_f⁄t
(
GtkWidgë
 *
widgë
, c⁄° 
gch¨
 *
«me


401 , c⁄° 
gch¨
 *
cﬁ‹


402 , 
göt
 
size


403 , 
göt
 
a
, göà
b
, göà
c
)

405 if(
	gwidgë
 =
NULL
){

409 
gch¨
 
	gbuf
[100];

410 
P™goF⁄tDes¸ùti⁄
 *
	gdesc
 = 
NULL
;

412 if(
	gcﬁ‹
 !
NULL
){

413 
g_¢¥ötf
(
buf
, 100, 
cﬁ‹
[0] == '#' ? "%s":"#%s", color);

414 
GdkCﬁ‹
 
	gcc
;

415 if(
gdk_cﬁ‹_∑r£
(
buf
, &
cc
)){

416 
gtk_widgë_modify_ãxt
(
widgë
, 
GTK_STATE_NORMAL
, &
cc
);

418 
g_w¨nög
("Wr⁄g cﬁ‹: %†(%s, %d)", 
buf
, 
__FILE__
, 
__LINE__
);

422 
g_¢¥ötf
(
buf
, 100, "%†%†%†%d", 
«me
 =
NULL
 ? "" :Çame

423 , 
a
 == 1 ? "bold" : ""

424 , 
b
 == 1 ? "italic" : ""

425 , 
size
);

426 
	gdesc
 = 
∑ngo_f⁄t_des¸ùti⁄_‰om_°rög
(
buf
);

427 
gtk_widgë_modify_f⁄t
(
widgë
, 
desc
);

428 
∑ngo_f⁄t_des¸ùti⁄_‰ì
(
desc
);

430 
QQCh©TextvõwPriv
 *
	g¥iv
 = 
G_TYPE_INSTANCE_GET_PRIVATE
(

431 
widgë
, 
qq_ch©_ãxtvõw_gë_ty≥
()

432 , 
QQCh©TextvõwPriv
);

433 
	g¥iv
 -> 
	gdeÁu…_undîlöe
 = (
c
 =1 ? 
TRUE
 : 
FALSE
);

434 
GtkTextIãr
 
	g°¨t
, 
	gíd
;

435 
GtkTextBuf„r
 *
	gãxtbuf
 = 
gtk_ãxt_võw_gë_buf„r
(
GTK_TEXT_VIEW
(
widgë
));

436 
gtk_ãxt_buf„r_gë_°¨t_ôî
(
ãxtbuf
, &
°¨t
);

437 
gtk_ãxt_buf„r_gë_íd_ôî
(
ãxtbuf
, &
íd
);

438 if(
	g¥iv
 -> 
	gdeÁu…_undîlöe
){

439 
gtk_ãxt_buf„r_≠∂y_èg_by_«me
(
ãxtbuf
, "undîlöe", &
°¨t
, &
íd
);

441 
gtk_ãxt_buf„r_ªmove_èg_by_«me
(
ãxtbuf
, "undîlöe", &
°¨t
, &
íd
);

445 
qq_ch©_ãxtvõw_˛ór
(
GtkWidgë
 *
widgë
)

447 if(
	gwidgë
 =
NULL
){

450 
QQCh©TextvõwPriv
 *
	g¥iv
 = 
G_TYPE_INSTANCE_GET_PRIVATE
(

451 
widgë
, 
qq_ch©_ãxtvõw_gë_ty≥
()

452 , 
QQCh©TextvõwPriv
);

453 
GtkTextBuf„r
 *
	gãxtbuf
 = 
gtk_ãxt_võw_gë_buf„r
(
GTK_TEXT_VIEW
(
widgë
));

454 
gtk_ãxt_buf„r_£t_ãxt
(
ãxtbuf
, "", -1);

456 
göt
 
	gi
;

457 
QQWidgëM¨k
 *
	gm¨k
;

458 
	gi
 = 0; i < 
	g¥iv
 -> 
	gwidgë_m¨ks
 -> 
	gÀn
; ++i){

459 
	gm¨k
 = 
g_±r_¨øy_ödex
(
¥iv
 -> 
widgë_m¨ks
, 
i
);

460 
gtk_ãxt_buf„r_dñëe_m¨k
(
ãxtbuf
, 
m¨k
 -> 
begö
);

461 
gtk_ãxt_buf„r_dñëe_m¨k
(
ãxtbuf
, 
m¨k
 -> 
íd
);

462 
g_¶i˚_‰ì
(
QQWidgëM¨k
, 
m¨k
);

464 if(
	g¥iv
 -> 
	gwidgë_m¨ks
 -> 
	gÀn
 > 0){

465 
g_±r_¨øy_ªmove_ønge
(
¥iv
 -> 
widgë_m¨ks
, 0

466 , 
¥iv
 -> 
widgë_m¨ks
 -> 
Àn
);

471 
göt
 
qq_ch©_ãxtvõw_gë_msg_c⁄ã¡s
(
GtkWidgë
 *
widgë
, 
LwqqMsgMesßge
 *
mmsg
)

473 i‡(
	gwidgë
 =
NULL
 || 
mmsg
 == NULL) {

477 
QQCh©TextvõwPriv
 *
	g¥iv
 = 
G_TYPE_INSTANCE_GET_PRIVATE
(

478 
widgë
, 
qq_ch©_ãxtvõw_gë_ty≥
(), 
QQCh©TextvõwPriv
);

479 
GtkTextBuf„r
 *
	gãxtbuf
 = 
gtk_ãxt_võw_gë_buf„r
(
GTK_TEXT_VIEW
(
widgë
));

480 i‡(
gtk_ãxt_buf„r_gë_ch¨_cou¡
(
ãxtbuf
) <= 0) {

484 
GtkTextIãr
 
	g°¨t_ôî
, 
	gíd_ôî
;

485 
gtk_ãxt_buf„r_gë_°¨t_ôî
(
ãxtbuf
, &
°¨t_ôî
);

486 
göt
 
	gi
;

487 
QQWidgëM¨k
 *
	gm¨k
;

488 
gch¨
 *
	gãxt
;

489 
LwqqMsgC⁄ã¡
 *
	gc
;

490 
	gi
 = 0; i < 
	g¥iv
->
	gwidgë_m¨ks
->
	gÀn
; ++i) {

491 
	gm¨k
 = 
g_±r_¨øy_ödex
(
¥iv
->
widgë_m¨ks
, 
i
);

492 i‡(
	gm¨k
 =
NULL
) {

495 
gtk_ãxt_buf„r_gë_ôî_©_m¨k
(
ãxtbuf
, &
íd_ôî
, 
m¨k
->
begö
);

497 
	gãxt
 = 
gtk_ãxt_buf„r_gë_ãxt
(
ãxtbuf
, &
°¨t_ôî
, &
íd_ôî
, 
FALSE
);

498 
	gc
 = 
g_mÆloc0
((*
c
));

499 
	gc
->
	gty≥
 = 
LWQQ_CONTENT_STRING
;

500 
	gc
->
	gd©a
.
	g°r
 = 
g_°rdup
(
ãxt
);

501 
TAILQ_INSERT_HEAD
(&
mmsg
->
c⁄ã¡
, 
c
, 
íåõs
);

502 
g_‰ì
(
ãxt
);

503 
	gm¨k
->
	gty≥
) {

504 
	gQQ_WIDGET_FACE_T
:

505 
c
 = 
g_mÆloc0
((*c));

506 
	gc
->
	gty≥
 = 
LWQQ_CONTENT_FACE
;

507 
	gc
->
	gd©a
.
	gÁ˚
 = 
m¨k
->
d©a
.
Á˚
;

508 
TAILQ_INSERT_HEAD
(&
mmsg
->
c⁄ã¡
, 
c
, 
íåõs
);

511 
g_w¨nög
("Unknown chatÅext view widgetÅype! %d (%s, %d)"

512 , 
m¨k
 -> 
ty≥
, 
__FILE__
, 
__LINE__
);

515 
gtk_ãxt_buf„r_gë_ôî_©_m¨k
(
ãxtbuf
, &
°¨t_ôî
, 
m¨k
 -> 
íd
);

519 
gtk_ãxt_buf„r_gë_íd_ôî
(
ãxtbuf
, &
íd_ôî
);

520 
	gãxt
 = 
gtk_ãxt_buf„r_gë_ãxt
(
ãxtbuf
, &
°¨t_ôî
, &
íd_ôî
, 
FALSE
);

521 
	gc
 = 
g_mÆloc0
((*
c
));

522 
	gc
->
	gty≥
 = 
LWQQ_CONTENT_STRING
;

523 
	gc
->
	gd©a
.
	g°r
 = 
g_°rdup
(
ãxt
);

524 
TAILQ_INSERT_HEAD
(&
mmsg
->
c⁄ã¡
, 
c
, 
íåõs
);

525 
g_‰ì
(
ãxt
);

	@src/gui/chattextview.h

1 #i‚de‡
__QQ_CHAT_TEXT_VIEW_H_


2 
	#__QQ_CHAT_TEXT_VIEW_H_


	)

3 
	~<gtk/gtk.h
>

4 
	~"ty≥.h
"

28 
	#QQ_CHAT_TEXTVIEW
(
obj
Ë
	`G_TYPE_CHECK_INSTANCE_CAST
(obj\

29 , 
	`qq_ch©_ãxtvõw_gë_ty≥
()\

30 , 
QQCh©Textvõw
)

	)

31 
	#QQ_CHAT_TEXTVIEWCLASS
(
c
Ë
	`G_TYPE_CHECK_CLASS_CAST
(c\

32 , 
	`qq_ch©_ãxtvõw_gë_ty≥
()\

33 , 
QQCh©TextvõwCœss
)

	)

34 
	#QQ_IS_CHAT_TEXTVIEW
(
obj
Ë
	`G_TYPE_CHECK_INSTANCE_TYPE
(obj\

35 , 
	`qq_ch©_ãxtvõw_gë_ty≥
())

	)

37 
__QQCh©Textvõw
 
	tQQCh©Textvõw
;

38 
__QQCh©TextvõwCœss
 
	tQQCh©TextvõwCœss
;

40 
	s__QQCh©Textvõw
{

41 
GtkTextVõw
 
	m∑ª¡
;

44 
	s__QQCh©TextvõwCœss
{

45 
GtkTextVõwCœss
 
	m∑ª¡
;

48 
GtkWidgë
* 
qq_ch©_ãxtvõw_√w
();

49 
GTy≥
 
qq_ch©_ãxtvõw_gë_ty≥
();

54 
qq_ch©_ãxtvõw_˛ór
(
GtkWidgë
 *
widgë
);

59 
qq_ch©_ãxtvõw_add_ªcv_mesßge
(
GtkWidgë
 *
widgë
, 
LwqqMsgMesßge
 *
msg
);

60 
qq_ch©_ãxtvõw_add_£nd_mesßge
(
GtkWidgë
 *
widgë
, 
LwqqMsg
 *
msg
);

65 
qq_ch©_ãxtvõw_add_Á˚
(
GtkWidgë
 *
widgë
, 
göt
 
Á˚
);

66 
qq_ch©_ãxtvõw_add_°rög
(
GtkWidgë
 *
widgë
, c⁄° 
gch¨
 *
°r
, 
göt
 
Àn
);

77 
qq_ch©_ãxtvõw_£t_f⁄t
(
GtkWidgë
 *
widgë
, c⁄° 
gch¨
 *
«me


78 , c⁄° 
gch¨
 *
cﬁ‹


79 , 
göt
 
size


80 , 
göt
 
a
, göà
b
, göà
c
);

85 
qq_ch©_ãxtvõw_£t_deÁu…_f⁄t
(
GtkWidgë
 *
widgë
, c⁄° 
gch¨
 *
«me


86 , c⁄° 
gch¨
 *
cﬁ‹


87 , 
göt
 
size


88 , 
göt
 
a
, göà
b
, göà
c
);

95 
göt
 
qq_ch©_ãxtvõw_gë_msg_c⁄ã¡s
(
GtkWidgë
 *
widgë
, 
LwqqMsgMesßge
 *
mmsg
);

	@src/gui/chatwidget.c

1 
	~<ch©widgë.h
>

2 
	~<°dlib.h
>

3 
	~<ch©ãxtvõw.h
>

5 
	~<Á˚p›upwödow.h
>

8 
qq_ch©widgë_öô
(
QQCh©Widgë
 *
wö
);

9 
qq_ch©widgë˛ass_öô
(
QQCh©WidgëCœss
 *
wc
);

11 
LwqqClõ¡
 *
lwqq_˛õ¡
;

12 *
lwqq_ö°Æl_dú
;

13 *
lwqq_ic⁄s_dú
;

14 *
lwqq_buddy_°©us_dú
;

15 
GtkWidgë
 *
maö_wö
;

17 c⁄° 
gch¨
 *
	gf⁄t_«mes
[] = {"ÂÆã‰Ωì", "Èªë‰Ωì", "Èö∂‰π¶", "ÂæÆËΩØÈõÖÈªë"

20 , "Vîd™a", 
NULL
};

21 
guöt
 
	$sˇÀ_255
(
guöt
 
v
)

23 
guöt
 
ª
 = (guöt)(
v
 / 65535.0 * 255.0 + 0.5);

24 
ª
 =Ñe < 0 ? 0 :Ñe;

25 
ª
 =Ñe > 255 ? 255 :Ñe;

26  
ª
;

27 
	}
}

34 
GtkWidgë
 *
	mmesßge_ãxtvõw
;

37 
GtkWidgë
 *
	mf⁄t_toﬁ_box
;

38 
GtkWidgë
 *
	mf⁄t_cb
, *
	msize_cb
, *
	mbﬁd_bä
, *
	môÆic_bä


39 , *
	mundîlöe_bä
, *
	mcﬁ‹_bä
;

42 
GtkWidgë
 *
	mtoﬁ_b¨
;

43 
GtkToﬁIãm
 *
	mf⁄t_ôem
, *
	mÁ˚_ôem
, *
	m£ndfûe_ôem


44 , *
	m£ndpic_ôem
, *
	m˛ór_ôem
, *
	mhi°‹y_ôem
;

45 
GtkWidgë
 *
	mÁ˚p›upwödow
;

47 
GtkWidgë
 *
	möput_ãxtvõw
;

49 
GtkWidgë
 *
	m£nd_bä
, *
	m˛o£_bä
;

50 }
	tQQCh©WidgëPriv
;

52 
GTy≥
 
	$qq_ch©widgë_gë_ty≥
()

54 
GTy≥
 
t
 = 0;

55 if(!
t
){

56 c⁄° 
GTy≥Info
 
öfo
 =

58 (
QQCh©WidgëCœss
),

59 
NULL
,

60 
NULL
,

61 (
GCœssInôFunc
)
qq_ch©widgë˛ass_öô
,

62 
NULL
,

63 
NULL
,

64 (
QQCh©Widgë
),

66 (
GIn°™˚InôFunc
)
qq_ch©widgë_öô
,

70 
t
 = 
	`g_ty≥_ªgi°î_°©ic
(
GTK_TYPE_VBOX
, "QQChatWidget"

71 , &
öfo
, 0);

73  
t
;

74 
	}
}

76 
GtkWidgë
* 
	$qq_ch©widgë_√w
()

78  
	`GTK_WIDGET
(
	`g_obje˘_√w
(
	`qq_ch©widgë_gë_ty≥
()

80 , "homogíeous", 
FALSE


81 , 
NULL
));

82 
	}
}

87 
GtkWidgë
* 
	$qq_toggÀ_buâ⁄_√w_wôh_°ock
(c⁄° 
gch¨
 *
°ock_id
)

89 
GtkWidgë
 *
bä
 = 
	`gtk_toggÀ_buâ⁄_√w
();

90 if(
°ock_id
 !
NULL
){

91 
GtkWidgë
 *
img
 = 
	`gtk_image_√w_‰om_°ock
(
°ock_id


92 , 
GTK_ICON_SIZE_LARGE_TOOLBAR
);

93 
	`gtk_buâ⁄_£t_image
(
	`GTK_BUTTON
(
bä
), 
img
);

95  
bä
;

96 
	}
}

101 
	$Á˚_toﬁ_buâ⁄_˛icked
(
GtkToﬁBuâ⁄
 *
bä
, 
gpoöãr
 
d©a
)

104 
QQCh©WidgëPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(
d©a


105 , 
	`qq_ch©widgë_gë_ty≥
()

106 , 
QQCh©WidgëPriv
);

107 
x
 , 
y
 , 
ex
 , 
ey
 , 
roŸ_x
 , 
roŸ_y
;

110 
GtkWidgë
 *
∑ª¡
 = 
	`GTK_WIDGET
(
bä
), *
tmp
;

111 (
tmp
 = 
	`gtk_widgë_gë_∑ª¡
(
∑ª¡
)Ë!
NULL
){

112 
∑ª¡
 = 
tmp
;

115 
	`gtk_widgë_å™¶©e_co‹dö©es
(
	`GTK_WIDGET
(
bä
), 
∑ª¡
, 0, 0, &
ex
, &
ey
);

116 
	`gtk_wödow_gë_posôi⁄
(
	`GTK_WINDOW
(
∑ª¡
), &
roŸ_x
, &
roŸ_y
);

117 
x
 = 
roŸ_x
 + 
ex
 + 2;

118 
y
 = 
roŸ_y
 + 
ey
 + 45;

119 
	`qq_Á˚_p›up_wödow_p›up
(
¥iv
 -> 
Á˚p›upwödow
, 
x
, 
y
);

121 
	}
}

126 
	$˛ór_buâ⁄_˛icked
(
GtkToﬁBuâ⁄
 *
bä
, 
gpoöãr
 
d©a
)

128 
QQCh©WidgëPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(
d©a


129 , 
	`qq_ch©widgë_gë_ty≥
()

130 , 
QQCh©WidgëPriv
);

131 
	`qq_ch©_ãxtvõw_˛ór
(
¥iv
 -> 
mesßge_ãxtvõw
);

132 
	}
}

136 
	$qq_ch©_võw_f⁄t_buâ⁄_˛icked
(
GtkToggÀToﬁBuâ⁄
 *
bä
, 
gpoöãr
 
d©a
)

138 
QQCh©Widgë
 *
widgë
 = 
d©a
;

139 
QQCh©WidgëPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(
widgë


140 , 
	`qq_ch©widgë_gë_ty≥
()

141 , 
QQCh©WidgëPriv
);

142 if(
	`gtk_toggÀ_toﬁ_buâ⁄_gë_a˘ive
(
bä
)){

143 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
widgë
), 
¥iv
 -> 
f⁄t_toﬁ_box


144 , 
FALSE
, FALSE, 0);

145 
	`gtk_box_ª‹dî_chûd
(
	`GTK_BOX
(
widgë
), 
¥iv
 -> 
f⁄t_toﬁ_box
, 1);

147 
	`gtk_c⁄èöî_ªmove
(
	`GTK_CONTAINER
(
widgë
)

148 , 
¥iv
 -> 
f⁄t_toﬁ_box
);

150 
	}
}

152 
	$qq_ch©_widgë_f⁄t_ch™ged
(
GtkWidgë
 *
widgë
, 
gpoöãr
 
d©a
)

154 
QQCh©WidgëPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(
d©a


155 , 
	`qq_ch©widgë_gë_ty≥
()

156 , 
QQCh©WidgëPriv
);

157 
gch¨
 *
«me
 = 
NULL
, 
cﬁ‹
[20], *
size°r
 = NULL;

158 
göt
 
size
, 
a
 = 0, 
b
 = 0, 
c
 = 0;

160 
«me
 = 
	`gtk_combo_box_ãxt_gë_a˘ive_ãxt
(

161 
	`GTK_COMBO_BOX_TEXT
(
¥iv
 -> 
f⁄t_cb
));

162 if(
«me
 =
NULL
){

166 
GdkCﬁ‹
 
gc
;

167 
	`gtk_cﬁ‹_buâ⁄_gë_cﬁ‹
(
	`GTK_COLOR_BUTTON
(
¥iv
 -> 
cﬁ‹_bä
), &
gc
);

168 
	`g_¢¥ötf
(
cﬁ‹
, 20, "#%02X%02X%02X", 
	`sˇÀ_255
(
gc
.
ªd
), sˇÀ_255(gc.
gªí
)

169 , 
	`sˇÀ_255
(
gc
.
blue
));

170 
	`g_debug
("SëÅexàvõw cﬁ‹ %†(%u,%u,%u)(%s, %d)", 
cﬁ‹
, 
gc
.
ªd


171 , 
gc
.
gªí
, gc.
blue
, 
__FILE__
, 
__LINE__
);

173 
size°r
 = 
	`gtk_combo_box_ãxt_gë_a˘ive_ãxt
(

174 
	`GTK_COMBO_BOX_TEXT
(
¥iv
 -> 
size_cb
));

175 if(
size°r
 =
NULL
){

176 
out_œbñ
;

178 
size
 = (
göt
)
	`°πﬁ
(
size°r
, 
NULL
, 10);

180 if(
	`gtk_toggÀ_buâ⁄_gë_a˘ive
(
	`GTK_TOGGLE_BUTTON
(
¥iv
 -> 
bﬁd_bä
))){

181 
a
 = 1;

183 if(
	`gtk_toggÀ_buâ⁄_gë_a˘ive
(
	`GTK_TOGGLE_BUTTON
(
¥iv
 -> 
ôÆic_bä
))){

184 
b
 = 1;

186 if(
	`gtk_toggÀ_buâ⁄_gë_a˘ive
(
	`GTK_TOGGLE_BUTTON
(
¥iv
 -> 
undîlöe_bä
))){

187 
c
 = 1;

189 
	`qq_ch©_ãxtvõw_£t_deÁu…_f⁄t
(
¥iv
 -> 
öput_ãxtvõw
,

190 
«me
, 
cﬁ‹
, 
size
, 
a
, 
b
, 
c
);

192 
out_œbñ
:

193 
	`g_‰ì
(
«me
);

194 
	`g_‰ì
(
size°r
);

195 
	}
}

201 
	$qq_ch©widgë_Á˚_˛icked
(
gpoöãr
 
ö°™˚
, 
göt
 
Á˚


202 , 
gpoöãr
 
d©a
)

204 
QQCh©WidgëPriv
 *
¥iv
 = 
d©a
;

205 
	`qq_ch©_ãxtvõw_add_Á˚
(
¥iv
 -> 
öput_ãxtvõw
, 
Á˚
);

206 
	}
}

209 
	$qq_ch©widgë_öô
(
QQCh©Widgë
 *
widgë
)

211 
QQCh©WidgëPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(
widgë


212 , 
	`qq_ch©widgë_gë_ty≥
()

213 , 
QQCh©WidgëPriv
);

214 
GtkWidgë
 *
s¸ﬁÀd_wö
;

215 
gch¨
 
buf
[100];

217 
GtkWidgë
 *
∑√d
=
	`gtk_∑√d_√w
(
GTK_ORIENTATION_VERTICAL
);

218 
GtkWidgë
* 
vbox
=
	`gtk_box_√w
(
GTK_ORIENTATION_VERTICAL
,0);

219 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
widgë
),
∑√d
, 
TRUE
,TRUE,0);

220 
	`gtk_∑√d_£t_posôi⁄
(
	`GTK_PANED
(
∑√d
),250);

221 
	`gtk_∑√d_∑ck2
(
	`GTK_PANED
(
∑√d
),
vbox
,
TRUE
,TRUE);

223 
¥iv
 -> 
mesßge_ãxtvõw
 = 
	`qq_ch©_ãxtvõw_√w
();

224 
s¸ﬁÀd_wö

	`gtk_s¸ﬁÀd_wödow_√w
(
NULL
, NULL);

225 
	`gtk_s¸ﬁÀd_wödow_£t_pﬁicy
(
	`GTK_SCROLLED_WINDOW
(
s¸ﬁÀd_wö
),

226 
GTK_POLICY_AUTOMATIC
, GTK_POLICY_AUTOMATIC);

227 
	`gtk_s¸ﬁÀd_wödow_£t_shadow_ty≥
(
	`GTK_SCROLLED_WINDOW
(
s¸ﬁÀd_wö
)

228 , 
GTK_SHADOW_ETCHED_IN
);

229 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
s¸ﬁÀd_wö
), 
¥iv
 -> 
mesßge_ãxtvõw
);

230 
	`gtk_∑√d_∑ck1
(
	`GTK_PANED
(
∑√d
),
s¸ﬁÀd_wö
,
TRUE
,
FALSE
);

232 
	`gtk_ãxt_võw_£t_curs‹_visibÀ
(
	`GTK_TEXT_VIEW
(
¥iv
 -> 
mesßge_ãxtvõw
)

233 , 
FALSE
);

234 
	`gtk_ãxt_võw_£t_wøp_mode
(
	`GTK_TEXT_VIEW
(
¥iv
 -> 
mesßge_ãxtvõw
)

235 , 
GTK_WRAP_CHAR
);

236 
	`gtk_ãxt_võw_£t_edôabÀ
(
	`GTK_TEXT_VIEW
(
¥iv
 -> 
mesßge_ãxtvõw
)

237 , 
FALSE
);

240 
¥iv
 -> 
f⁄t_toﬁ_box
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_VERTICAL
, 5);

241 
	`g_obje˘_ªf
(
¥iv
 -> 
f⁄t_toﬁ_box
);

242 
¥iv
 -> 
f⁄t_cb
 = 
	`gtk_combo_box_ãxt_√w
();

243 
göt
 
i
;

244 
i
 = 0; 
f⁄t_«mes
[i] !
NULL
; ++i){

245 
	`gtk_combo_box_ãxt_≠≥nd_ãxt
(
	`GTK_COMBO_BOX_TEXT
(
¥iv
 -> 
f⁄t_cb
)

246 , 
f⁄t_«mes
[
i
]);

248 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
¥iv
 -> 
f⁄t_toﬁ_box
),Öriv -> 
f⁄t_cb


249 , 
FALSE
, FALSE, 0);

250 
¥iv
 -> 
size_cb
 = 
	`gtk_combo_box_ãxt_√w
();

251 
i
 = 8; i < 23; ++i){

252 
	`g_¢¥ötf
(
buf
, 10, "%d", 
i
);

253 
	`gtk_combo_box_ãxt_≠≥nd_ãxt
(
	`GTK_COMBO_BOX_TEXT
(
¥iv
 -> 
size_cb
)

254 , 
buf
);

256 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
¥iv
 -> 
f⁄t_toﬁ_box
),Öriv -> 
size_cb


257 , 
FALSE
, FALSE, 0);

258 
¥iv
 -> 
bﬁd_bä
 = 
	`qq_toggÀ_buâ⁄_√w_wôh_°ock
(
GTK_STOCK_BOLD
);

259 
¥iv
 -> 
ôÆic_bä
 = 
	`qq_toggÀ_buâ⁄_√w_wôh_°ock
(
GTK_STOCK_ITALIC
);

260 
¥iv
 -> 
undîlöe_bä
 = 
	`qq_toggÀ_buâ⁄_√w_wôh_°ock
(

261 
GTK_STOCK_UNDERLINE
);

262 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
¥iv
 -> 
f⁄t_toﬁ_box
),Öriv -> 
bﬁd_bä


263 , 
FALSE
, FALSE, 0);

264 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
¥iv
 -> 
f⁄t_toﬁ_box
),Öriv -> 
ôÆic_bä


265 , 
FALSE
, FALSE, 0);

266 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
¥iv
 -> 
f⁄t_toﬁ_box
),Öriv -> 
undîlöe_bä


267 , 
FALSE
, FALSE, 0);

268 
¥iv
 -> 
cﬁ‹_bä
 = 
	`gtk_cﬁ‹_buâ⁄_√w
();

269 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
¥iv
 -> 
f⁄t_toﬁ_box
),Öriv -> 
cﬁ‹_bä


270 , 
FALSE
, FALSE, 0);

271 
	`gtk_widgë_show_Æl
(
¥iv
 -> 
f⁄t_toﬁ_box
);

273 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
¥iv
 -> 
f⁄t_cb
), "changed"

274 , 
	`G_CALLBACK
(
qq_ch©_widgë_f⁄t_ch™ged
), 
widgë
);

275 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
¥iv
 -> 
size_cb
), "changed"

276 , 
	`G_CALLBACK
(
qq_ch©_widgë_f⁄t_ch™ged
), 
widgë
);

277 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
¥iv
 -> 
bﬁd_bä
), "toggled"

278 , 
	`G_CALLBACK
(
qq_ch©_widgë_f⁄t_ch™ged
), 
widgë
);

279 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
¥iv
 -> 
ôÆic_bä
), "toggled"

280 , 
	`G_CALLBACK
(
qq_ch©_widgë_f⁄t_ch™ged
), 
widgë
);

281 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
¥iv
 -> 
undîlöe_bä
), "toggled"

282 , 
	`G_CALLBACK
(
qq_ch©_widgë_f⁄t_ch™ged
), 
widgë
);

283 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
¥iv
 -> 
cﬁ‹_bä
), "color-set"

284 , 
	`G_CALLBACK
(
qq_ch©_widgë_f⁄t_ch™ged
), 
widgë
);

288 
¥iv
 -> 
toﬁ_b¨
 = 
	`gtk_toﬁb¨_√w
();

289 
GtkWidgë
 *
img
 = 
NULL
;

291 
gch¨
 
img_fûe
[256];

292 
	`g_¢¥ötf
(
img_fûe
, (img_fûe), "%s/£À˘f⁄t.≤g", 
lwqq_ic⁄s_dú
);

293 
img
 = 
	`gtk_image_√w_‰om_fûe
(
img_fûe
);

294 
¥iv
 -> 
f⁄t_ôem
 = 
	`gtk_toggÀ_toﬁ_buâ⁄_√w
();

295 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
¥iv
 -> 
f⁄t_ôem
), "toggled"

296 , 
	`G_CALLBACK
(
qq_ch©_võw_f⁄t_buâ⁄_˛icked
)

297 , 
widgë
);

298 
	`gtk_toﬁ_buâ⁄_£t_ic⁄_widgë
(
	`GTK_TOOL_BUTTON
(
¥iv
 -> 
f⁄t_ôem
), 
img
);

299 
	`gtk_toﬁb¨_ö£π
(
	`GTK_TOOLBAR
(
¥iv
 -> 
toﬁ_b¨
),Öriv -> 
f⁄t_ôem
, -1);

301 
	`g_¢¥ötf
(
img_fûe
, (img_fûe), "%s/£À˘Á˚.≤g", 
lwqq_ic⁄s_dú
);

302 
img
 = 
	`gtk_image_√w_‰om_fûe
(
img_fûe
);

303 
¥iv
 -> 
Á˚_ôem
 = 
	`gtk_toﬁ_buâ⁄_√w
(
img
, 
NULL
);

304 
	`gtk_toﬁb¨_ö£π
(
	`GTK_TOOLBAR
(
¥iv
 -> 
toﬁ_b¨
),Öriv -> 
Á˚_ôem
, -1);

305 
	`gtk_toﬁb¨_ö£π
(
	`GTK_TOOLBAR
(
¥iv
 -> 
toﬁ_b¨
)

306 , 
	`gtk_£∑øt‹_toﬁ_ôem_√w
() , -1);

307 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
¥iv
 -> 
Á˚_ôem
), "clicked",

308 
	`G_CALLBACK
(
Á˚_toﬁ_buâ⁄_˛icked
), 
widgë
);

310 
	`g_¢¥ötf
(
img_fûe
, (img_fûe), "%s/£ndfûe.≤g", 
lwqq_ic⁄s_dú
);

311 
img
 = 
	`gtk_image_√w_‰om_fûe
(
img_fûe
);

312 
¥iv
 -> 
£ndfûe_ôem
 = 
	`gtk_toﬁ_buâ⁄_√w
(
img
, 
NULL
);

313 
	`gtk_toﬁb¨_ö£π
(
	`GTK_TOOLBAR
(
¥iv
 -> 
toﬁ_b¨
),Öriv -> 
£ndfûe_ôem
, -1);

315 
	`g_¢¥ötf
(
img_fûe
, (img_fûe), "%s/£ndpic.≤g", 
lwqq_ic⁄s_dú
);

316 
img
 = 
	`gtk_image_√w_‰om_fûe
(
img_fûe
);

317 
¥iv
 -> 
£ndpic_ôem
 = 
	`gtk_toﬁ_buâ⁄_√w
(
img
, 
NULL
);

318 
	`gtk_toﬁb¨_ö£π
(
	`GTK_TOOLBAR
(
¥iv
 -> 
toﬁ_b¨
),Öriv -> 
£ndpic_ôem
, -1);

319 
	`gtk_toﬁb¨_ö£π
(
	`GTK_TOOLBAR
(
¥iv
 -> 
toﬁ_b¨
)

320 , 
	`gtk_£∑øt‹_toﬁ_ôem_√w
() , -1);

322 
	`g_¢¥ötf
(
img_fûe
, (img_fûe), "%s/˛órs¸ìn.≤g", 
lwqq_ic⁄s_dú
);

323 
img
 = 
	`gtk_image_√w_‰om_fûe
(
img_fûe
);

324 
¥iv
 -> 
˛ór_ôem
 = 
	`gtk_toﬁ_buâ⁄_√w
(
img
, 
NULL
);

325 
	`gtk_toﬁb¨_ö£π
(
	`GTK_TOOLBAR
(
¥iv
 -> 
toﬁ_b¨
),Öriv -> 
˛ór_ôem
, -1);

326 
	`gtk_toﬁb¨_ö£π
(
	`GTK_TOOLBAR
(
¥iv
 -> 
toﬁ_b¨
)

327 , 
	`gtk_£∑øt‹_toﬁ_ôem_√w
() , -1);

328 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
¥iv
 -> 
˛ór_ôem
), "clicked",

329 
	`G_CALLBACK
(
˛ór_buâ⁄_˛icked
), 
widgë
);

331 
	`g_¢¥ötf
(
img_fûe
, (img_fûe), "%s/showhi°‹y.≤g", 
lwqq_ic⁄s_dú
);

332 
img
 = 
	`gtk_image_√w_‰om_fûe
(
img_fûe
);

333 
¥iv
 -> 
hi°‹y_ôem
 = 
	`gtk_toﬁ_buâ⁄_√w
(
img
, 
NULL
);

334 
	`gtk_toﬁb¨_ö£π
(
	`GTK_TOOLBAR
(
¥iv
 -> 
toﬁ_b¨
),Öriv -> 
hi°‹y_ôem
, -1);

335 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
vbox
), 
¥iv
 -> 
toﬁ_b¨


336 , 
FALSE
, FALSE, 0);

339 
¥iv
 -> 
öput_ãxtvõw
 = 
	`qq_ch©_ãxtvõw_√w
();

340 
	`gtk_ãxt_võw_£t_ödít
(
	`GTK_TEXT_VIEW
(
¥iv
 -> 
öput_ãxtvõw
), 1);

341 
s¸ﬁÀd_wö

	`gtk_s¸ﬁÀd_wödow_√w
(
NULL
, NULL);

342 
	`gtk_s¸ﬁÀd_wödow_£t_pﬁicy
 (
	`GTK_SCROLLED_WINDOW
(
s¸ﬁÀd_wö
),

343 
GTK_POLICY_AUTOMATIC
, GTK_POLICY_AUTOMATIC);

344 
	`gtk_s¸ﬁÀd_wödow_£t_shadow_ty≥
(
	`GTK_SCROLLED_WINDOW
(
s¸ﬁÀd_wö
)

345 , 
GTK_SHADOW_ETCHED_IN
);

346 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
s¸ﬁÀd_wö
), 
¥iv
 -> 
öput_ãxtvõw
);

352 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
vbox
), 
s¸ﬁÀd_wö
, 
TRUE
, TRUE, 0);

354 
	`gtk_ãxt_võw_£t_wøp_mode
(
	`GTK_TEXT_VIEW
(
¥iv
 -> 
öput_ãxtvõw
)

355 , 
GTK_WRAP_CHAR
);

357 
	`gtk_combo_box_£t_a˘ive
(
	`GTK_COMBO_BOX
(
¥iv
 -> 
f⁄t_cb
), 1);

358 
	`gtk_combo_box_£t_a˘ive
(
	`GTK_COMBO_BOX
(
¥iv
 -> 
size_cb
), 3);

360 
	`gtk_widgë_gøb_focus
(
¥iv
 -> 
öput_ãxtvõw
);

364 
¥iv
 -> 
Á˚p›upwödow
 = 
	`qq_Á˚_p›up_wödow_√w
();

365 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
¥iv
 -> 
Á˚p›upwödow
), "face-clicked"

366 , 
	`G_CALLBACK
(
qq_ch©widgë_Á˚_˛icked
)

367 , 
¥iv
);

369 
	}
}

371 
	$qq_ch©widgë_föÆize
(
GObje˘
 *
obj
)

373 
QQCh©WidgëPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(
obj


374 , 
	`qq_ch©widgë_gë_ty≥
()

375 , 
QQCh©WidgëPriv
);

376 
	`gtk_widgë_de°roy
(
¥iv
 -> 
Á˚p›upwödow
);

378 
GObje˘Cœss
 *
kœss
 = (GObje˘Cœss*)
	`g_ty≥_˛ass_≥ek_∑ª¡
(

379 
	`g_ty≥_˛ass_≥ek
(
	`qq_ch©widgë_gë_ty≥
()));

380 
kœss
 -> 
	`föÆize
(
obj
);

381 
	}
}

383 
	$qq_ch©widgë˛ass_öô
(
QQCh©WidgëCœss
 *
wc
)

385 
	`g_ty≥_˛ass_add_¥iv©e
(
wc
, (
QQCh©WidgëPriv
));

386 
	`G_OBJECT_CLASS
(
wc
Ë-> 
föÆize
 = 
qq_ch©widgë_föÆize
;

387 
	}
}

390 
	$qq_ch©widgë_add_£nd_mesßge
(
GtkWidgë
 *
widgë
, 
LwqqMsg
 *
msg
)

392 i‡(
widgë
 =
NULL
 || 
msg
 == NULL) {

396 
QQCh©WidgëPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(

397 
widgë
, 
	`qq_ch©widgë_gë_ty≥
(), 
QQCh©WidgëPriv
);

399 
	`qq_ch©_ãxtvõw_add_£nd_mesßge
(
¥iv
->
mesßge_ãxtvõw
, 
msg
);

400 
	}
}

401 
	$qq_ch©widgë_add_ªcv_mesßge
(
GtkWidgë
 *
widgë
, 
LwqqMsgMesßge
 *
msg
)

403 if(
widgë
 =
NULL
 || 
msg
 == NULL){

407 
QQCh©WidgëPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(
widgë


408 , 
	`qq_ch©widgë_gë_ty≥
()

409 , 
QQCh©WidgëPriv
);

410 
	`qq_ch©_ãxtvõw_add_ªcv_mesßge
(
¥iv
 -> 
mesßge_ãxtvõw
, 
msg
);

411 
	}
}

413 
GtkWidgë
 * 
	$qq_ch©widgë_gë_mesßge_ãxtvõw
(
GtkWidgë
 *
widgë
)

415 
QQCh©WidgëPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(

416 
widgë
, 
	`qq_ch©widgë_gë_ty≥
(), 
QQCh©WidgëPriv
);

417  
¥iv
->
mesßge_ãxtvõw
;

418 
	}
}

420 
GtkWidgë
 * 
	$qq_ch©widgë_gë_öput_ãxtvõw
(
GtkWidgë
 *
widgë
)

422 
QQCh©WidgëPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(
widgë


423 , 
	`qq_ch©widgë_gë_ty≥
()

424 , 
QQCh©WidgëPriv
);

425  
¥iv
 -> 
öput_ãxtvõw
;

426 
	}
}

429 
QQMsgC⁄ã¡
* 
	$qq_ch©widgë_gë_f⁄t
(
GtkWidgë
 *
widgë
)

431 
QQCh©WidgëPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(
widgë


432 , 
	`qq_ch©widgë_gë_ty≥
()

433 , 
QQCh©WidgëPriv
);

435 
gch¨
 *
«me
 = 
NULL
, 
cﬁ‹
[20] , *
size°r
 = NULL;

436 
göt
 
size
, 
a
 = 0, 
b
 = 0, 
c
 = 0;

438 
«me
 = 
	`gtk_combo_box_ãxt_gë_a˘ive_ãxt
(

439 
	`GTK_COMBO_BOX_TEXT
(
¥iv
 -> 
f⁄t_cb
));

440 if(
«me
 =
NULL
){

441 
«me
 = "ÂÆã‰Ωì";

443 
GdkCﬁ‹
 
gc
;

444 
	`gtk_cﬁ‹_buâ⁄_gë_cﬁ‹
(
	`GTK_COLOR_BUTTON
(
¥iv
 -> 
cﬁ‹_bä
), &
gc
);

445 
	`g_¢¥ötf
(
cﬁ‹
, 20, "%02X%02X%02X", 
	`sˇÀ_255
(
gc
.
ªd
), sˇÀ_255(gc.
gªí
)

446 , 
	`sˇÀ_255
(
gc
.
blue
));

448 
size°r
 = 
	`gtk_combo_box_ãxt_gë_a˘ive_ãxt
(

449 
	`GTK_COMBO_BOX_TEXT
(
¥iv
 -> 
size_cb
));

450 if(
size°r
 =
NULL
){

451 
size
 = 11;

453 
size
 = (
göt
)
	`°πﬁ
(
size°r
, 
NULL
, 10);

455 if(
	`gtk_toggÀ_buâ⁄_gë_a˘ive
(
	`GTK_TOGGLE_BUTTON
(
¥iv
 -> 
bﬁd_bä
))){

456 
a
 = 1;

458 if(
	`gtk_toggÀ_buâ⁄_gë_a˘ive
(
	`GTK_TOGGLE_BUTTON
(
¥iv
 -> 
ôÆic_bä
))){

459 
b
 = 1;

461 if(
	`gtk_toggÀ_buâ⁄_gë_a˘ive
(
	`GTK_TOGGLE_BUTTON
(
¥iv
 -> 
undîlöe_bä
))){

462 
c
 = 1;

464 
QQMsgC⁄ã¡
 *
f⁄t
 = 
	`qq_msgc⁄ã¡_√w
(
QQ_MSG_CONTENT_FONT_T
, 
«me
, 
size


465 , 
cﬁ‹
, 
a
, 
b
, 
c
);

466 
	`g_‰ì
(
«me
);

467 
	`g_‰ì
(
size°r
);

468  
f⁄t
;

469 
	}
}

	@src/gui/chatwidget.h

1 #i‚de‡
__GTKQQ_CHATWIDGET_H


2 
	#__GTKQQ_CHATWIDGET_H


	)

3 
	~<gtk/gtk.h
>

4 
	~"ty≥.h
"

28 
	#QQ_CHATWIDGET
(
obj
Ë
	`G_TYPE_CHECK_INSTANCE_CAST
(obj, 
	`qq_ch©widgë_gë_ty≥
()\

29 , 
QQCh©Widgë
)

	)

30 
	#QQ_CHATWIDGETCLASS
(
c
Ë
	`G_TYPE_CHECK_CLASS_CAST
(c\

31 , 
	`qq_ch©widgë_gë_ty≥
()\

32 , 
QQCh©WidgëCœss
)

	)

33 
	#QQ_IS_CHATWIDGET
(
obj
Ë
	`G_TYPE_CHECK_INSTANCE_TYPE
(obj, 
	`qq_ch©widgë_gë_ty≥
())

	)

35 
__QQCh©Widgë
 
	tQQCh©Widgë
;

36 
__QQCh©WidgëCœss
 
	tQQCh©WidgëCœss
;

38 
	s__QQCh©Widgë
{

39 
GtkVBox
 
	m∑ª¡
;

43 
	s__QQCh©WidgëCœss
{

44 
GtkVBoxCœss
 
	m∑ª¡
;

47 
GtkWidgë
* 
qq_ch©widgë_√w
();

48 
GTy≥
 
qq_ch©widgë_gë_ty≥
();

53 
qq_ch©widgë_add_ªcv_mesßge
(
GtkWidgë
 *
widgë
, 
LwqqMsgMesßge
 *
msg
);

54 
qq_ch©widgë_add_£nd_mesßge
(
GtkWidgë
 *
widgë
, 
LwqqMsg
 *
msg
);

59 
GtkWidgë
* 
qq_ch©widgë_gë_mesßge_ãxtvõw
(GtkWidgë *
widgë
);

60 
GtkWidgë
* 
qq_ch©widgë_gë_öput_ãxtvõw
(GtkWidgë *
widgë
);

66 
QQMsgC⁄ã¡
* 
qq_ch©widgë_gë_f⁄t
(
GtkWidgë
 *
widgë
);

	@src/gui/chatwindow.c

1 
	~<ch©wödow.h
>

2 
	~<°dlib.h
>

3 
	~"ty≥.h
"

4 
	~<ch©ãxtvõw.h
>

5 
	~<åay.h
>

6 
	~<msglo›.h
>

7 
	~<gdk/gdkkeysyms.h
>

8 
	~<ch©widgë.h
>

9 
	~"loggî.h
"

12 #ifde‡
HAVE_CONFIG_H


13 
	~<c⁄fig.h
>

16 
QQTøy
 *
åay
;

17 
GQQMesßgeLo›
 *
£nd_lo›
;

18 
LwqqClõ¡
 *
lwqq_˛õ¡
;

19 *
lwqq_ö°Æl_dú
;

20 *
lwqq_ic⁄s_dú
;

21 *
lwqq_buddy_°©us_dú
;

22 
GtkWidgë
 *
maö_wö
;

23 
GHashTabÀ
 *
lwqq_ch©_wödow
;

24 *
lwqq_u£r_dú
;

26 
qq_ch©wödow_öô
(
QQCh©Wödow
 *
wö
);

27 
qq_ch©wödow˛ass_öô
(
QQCh©WödowCœss
 *
wc
);

30 
	mQQ_CHATWINDOW_PROPERTY_UIN
 = 1,

31 
	mQQ_CHATWINDOW_PROPERTY_UNKNOWN


38 
gch¨
 
	muö
[100];

39 
GtkWidgë
 *
	mbody_vbox
;

41 
GtkWidgë
 *
	mÁ˚image
;

42 
GtkWidgë
 *
	m«me_œbñ
, *
	m ick_œbñ
;

44 
GtkWidgë
 *
	mch©_widgë
;

46 
GtkWidgë
 *
	m£nd_bä
, *
	m˛o£_bä
;

47 }
	tQQCh©WödowPriv
;

49 
GTy≥
 
	$qq_ch©wödow_gë_ty≥
()

51 
GTy≥
 
t
 = 0;

52 if(!
t
){

53 c⁄° 
GTy≥Info
 
öfo
 =

55 (
QQCh©WödowCœss
),

56 
NULL
,

57 
NULL
,

58 (
GCœssInôFunc
)
qq_ch©wödow˛ass_öô
,

59 
NULL
,

60 
NULL
,

61 (
QQCh©Wödow
),

63 (
GIn°™˚InôFunc
)
qq_ch©wödow_öô
,

67 
t
 = 
	`g_ty≥_ªgi°î_°©ic
(
GTK_TYPE_WINDOW
, "QQChatWindow"

68 , &
öfo
, 0);

70  
t
;

71 
	}
}

73 
GtkWidgë
* 
	$qq_ch©wödow_√w
(c⁄° 
gch¨
 *
uö
)

75  
	`GTK_WIDGET
(
	`g_obje˘_√w
(
	`qq_ch©wödow_gë_ty≥
()

76 , "ty≥", 
GTK_WINDOW_TOPLEVEL


77 , "uö", 
uö


78 , 
NULL
));

79 
	}
}

84 
	$qq_ch©wödow_⁄_˛o£_˛icked
(
GtkWidgë
 *
widgë
, 
gpoöãr
 
d©a
)

87 
QQCh©WödowPriv
 *
¥iv
;

89 
	`lwqq_log
(
LOG_DEBUG
, "De°‹y ch© wödow: %p\n", 
d©a
);

90 
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(

91 
d©a
, 
	`qq_ch©wödow_gë_ty≥
(), 
QQCh©WödowPriv
);

92 
	`g_hash_èbÀ_ªmove
(
lwqq_ch©_wödow
, 
¥iv
->
uö
);

93 
	`gtk_widgë_de°roy
(
	`GTK_WIDGET
(
d©a
));

94 
	}
}

101 
	$qq_ch©wödow_£nd_msg_cb
(
GtkWidgë
 *
widgë
, 
LwqqMsg
 *
msg
)

103 i‡(
widgë
 =
NULL
 || 
msg
 == NULL) {

106 
göt
 
ªt
 = 
	`lwqq_msg_£nd
(
lwqq_˛õ¡
, 
msg
);

107 i‡(
ªt
 != 0) {

109 
	`lwqq_msg_‰ì
(
msg
);

110 
	}
}

115 
	$qq_ch©wödow_⁄_£nd_˛icked
(
GtkWidgë
 *
widgë
, 
gpoöãr
 
d©a
)

117 
QQCh©WödowPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(

118 
d©a
, 
	`qq_ch©wödow_gë_ty≥
(), 
QQCh©WödowPriv
);

119 
LwqqMsg
 *
msg
 = 
	`lwqq_msg_√w
(
LWQQ_MT_BUDDY_MSG
);

120 
LwqqMsgMesßge
 *
mmsg
 = 
msg
->
›aque
;

121 
	`qq_ch©_ãxtvõw_gë_msg_c⁄ã¡s
(
	`qq_ch©widgë_gë_öput_ãxtvõw
(

122 
¥iv
->
ch©_widgë
), 
mmsg
);

123 i‡(
	`TAILQ_EMPTY
(&
mmsg
->
c⁄ã¡
)) {

130 
	`qq_ch©_ãxtvõw_˛ór
(
	`qq_ch©widgë_gë_öput_ãxtvõw
(
¥iv
->
ch©_widgë
));

132 
mmsg
->
‰om
 = 
	`g_°rdup
(
lwqq_˛õ¡
->
my£lf
->
qqnumbî
);

133 
mmsg
->
to
 = 
	`g_°rdup
(
¥iv
->
uö
);

134 
mmsg
->
time
 = 
	`time
(
NULL
);

136 
mmsg
->
f_«me
 = 
	`g_°rdup
("Arial");

137 
mmsg
->
f_cﬁ‹
 = 
	`g_°rdup
("000000");

138 
mmsg
->
f_size
 = 12;

139 
mmsg
->
f_°yÀ
.
a
 = 0;

140 
mmsg
->
f_°yÀ
.
b
 = 0;

141 
mmsg
->
f_°yÀ
.
b
 = 0;

143 
QQMsgC⁄ã¡
 *
f⁄t
 = 
	`qq_ch©widgë_gë_f⁄t
(
¥iv
 -> 
ch©_widgë
);

144 
	`qq_£ndmsg_add_c⁄ã¡
(
msg
, 
f⁄t
);

147 
	`qq_ch©widgë_add_£nd_mesßge
(
¥iv
->
ch©_widgë
, 
msg
);

148 
	`gqq_maölo›_©èch
(
£nd_lo›
, 
qq_ch©wödow_£nd_msg_cb
, 2, 
d©a
, 
msg
);

150 
	}
}

152 
gboﬁón
 
	$qq_ch©wödow_dñëe_evít
(
GtkWidgë
 *
widgë
, 
GdkEvít
 *
evít


153 , 
gpoöãr
 
d©a
)

155 
QQCh©WödowPriv
 *
¥iv
 = 
d©a
;

156 
	`g_hash_èbÀ_ªmove
(
lwqq_ch©_wödow
, 
¥iv
->
uö
);

157  
FALSE
;

158 
	}
}

164 
gboﬁón
 
	$qq_ch©wödow_focus_ö_evít
(
GtkWidgë
 *
widgë
, 
GdkEvít
 *
evít
,

165 
gpoöãr
 
d©a
)

167 
QQCh©WödowPriv
 *
¥iv
 = 
d©a
;

168 
	`qq_åay_°›_blökög_f‹
(
åay
, 
¥iv
->
uö
);

169 
	`g_debug
("Focu†ö ch©wödow o‡%†(%s, %d)", 
¥iv
->
uö
, 
__FILE__
, 
__LINE__
);

170  
FALSE
;

171 
	}
}

176 
gboﬁón
 
	$qq_öput_ãxtvõw_key_¥ess
(
GtkWidgë
 *
widgë
, 
GdkEvít
 *
e


177 , 
gpoöãr
 
d©a
)

179 
GdkEvítKey
 *
evít
 = (GdkEvítKey*)
e
;

180 i‡(
evít
->
keyvÆ
 =
GDK_KEY_Rëu∫
 ||Évíà-> keyvÆ =
GDK_KEY_KP_E¡î
 ||

181 
evít
->
keyvÆ
 =
GDK_KEY_ISO_E¡î
) {

182 i‡((
evít
->
°©e
 & 
GDK_CONTROL_MASK
) != 0 ||

183 (
evít
 -> 
°©e
 & 
GDK_SHIFT_MASK
) != 0) {

184  
FALSE
;

186 
	`qq_ch©wödow_⁄_£nd_˛icked
(
NULL
, 
d©a
);

187  
TRUE
;

189  
FALSE
;

190 
	}
}

195 
gboﬁón
 
	$qq_ch©wödow_key_¥ess
(
GtkWidgë
 *
widgë
, 
GdkEvít
 *
e


196 , 
gpoöãr
 
d©a
)

199 
GdkEvítKey
 *
evít
 = (GdkEvítKey*)
e
;

200 if((
evít
 -> 
°©e
 & 
GDK_CONTROL_MASK
) != 0

201 && (
evít
 -> 
keyvÆ
 =
GDK_KEY_w
 ||Évíà-> keyvÆ =
GDK_KEY_W
)){

202 
QQCh©WödowPriv
 *
¥iv
 = 
d©a
;

203 
	`gqq_c⁄fig_ªmove_ht
(
cfg
, "ch©_wödow_m≠", 
¥iv
 -> 
uö
);

204 
	`gtk_widgë_de°roy
(
widgë
);

207  
FALSE
;

208 
	}
}

211 
	$qq_ch©wödow_öô
(
QQCh©Wödow
 *
wö
)

213 
gch¨
 
buf
[500];

214 
QQCh©WödowPriv
 *
¥iv
;

216 
	`lwqq_log
(
LOG_DEBUG
, "Cª©êch© wödow: %p\n", 
wö
);

218 
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(

219 
wö
, 
	`qq_ch©wödow_gë_ty≥
(), 
QQCh©WödowPriv
);

220 
¥iv
->
body_vbox
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_VERTICAL
, 0);

222 
GtkWidgë
 *
hódî_hbox
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_HORIZONTAL
, 0);

223 
GtkWidgë
 *
vbox
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_VERTICAL
, 0);

225 
GdkPixbuf
 *
pb
 = 
NULL
;

226 
LwqqBuddy
 *
bdy
 = 
	`lwqq_buddy_föd_buddy_by_uö
(
lwqq_˛õ¡
, 
¥iv
->
uö
);

227 
	`g_¢¥ötf
(
buf
, (buf), "%s/av©¨.gif", 
lwqq_ic⁄s_dú
);

228 
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe
(
buf
, 
NULL
);

229 
	`gtk_wödow_£t_ic⁄
(
	`GTK_WINDOW
(
wö
), 
pb
);

230 
	`g_obje˘_uƒef
(
pb
);

231 
	`g_¢¥ötf
(
buf
, 500, "TÆkög wôh %s", 
bdy
? bdy->
nick
 : 
¥iv
->
uö
);

232 
	`gtk_wödow_£t_tôÀ
(
	`GTK_WINDOW
(
wö
), 
buf
);

235 
	`g_¢¥ötf
(
buf
, (buf), "%s/av©¨.gif", 
lwqq_ic⁄s_dú
);

236 
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe_©_size
(
buf
, 35, 35, 
NULL
);

237 
¥iv
->
Á˚image
 = 
	`gtk_image_√w_‰om_pixbuf
(
pb
);

238 
	`g_obje˘_uƒef
(
pb
);

239 
¥iv
->
«me_œbñ
 = 
	`gtk_œbñ_√w
("");

240 
¥iv
->
 ick_œbñ
 = 
	`gtk_œbñ_√w
("");

241 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
hódî_hbox
), 
¥iv
->
Á˚image
, 
FALSE
, FALSE, 5);

242 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
vbox
), 
¥iv
->
«me_œbñ
, 
FALSE
, FALSE, 0);

243 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
vbox
), 
¥iv
->
 ick_œbñ
, 
FALSE
, FALSE, 0);

244 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
hódî_hbox
), 
vbox
, 
FALSE
, FALSE, 5);

245 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
¥iv
->
body_vbox
), 
hódî_hbox
, 
FALSE
, FALSE, 5);

248 
¥iv
->
ch©_widgë
 = 
	`qq_ch©widgë_√w
();

249 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
¥iv
->
body_vbox
),Öriv->
ch©_widgë
,

250 
TRUE
, TRUE, 0);

253 
GtkWidgë
 *
buâ⁄box
 = 
	`gtk_buâ⁄_box_√w
(
GTK_ORIENTATION_HORIZONTAL
);

254 
	`gtk_buâ⁄_box_£t_œyout
(
	`GTK_BUTTON_BOX
(
buâ⁄box
), 
GTK_BUTTONBOX_END
);

255 
	`gtk_box_£t_•acög
(
	`GTK_BOX
(
buâ⁄box
), 5);

256 
¥iv
->
˛o£_bä
 = 
	`gtk_buâ⁄_√w_wôh_œbñ
("Close");

257 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
¥iv
->
˛o£_bä
), "clicked",

258 
	`G_CALLBACK
(
qq_ch©wödow_⁄_˛o£_˛icked
), 
wö
);

259 
¥iv
->
£nd_bä
 = 
	`gtk_buâ⁄_√w_wôh_œbñ
("Send");

260 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
¥iv
->
£nd_bä
), "clicked",

261 
	`G_CALLBACK
(
qq_ch©wödow_⁄_£nd_˛icked
), 
wö
);

262 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
buâ⁄box
), 
¥iv
->
˛o£_bä
);

263 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
buâ⁄box
), 
¥iv
->
£nd_bä
);

264 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
¥iv
->
body_vbox
), 
buâ⁄box
, 
FALSE
, FALSE, 3);

266 
GtkWidgë
 *
w
 = 
	`GTK_WIDGET
(
wö
);

267 
	`gtk_wödow_ªsize
(
	`GTK_WINDOW
(
w
), 500, 450);

268 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
wö
), 
¥iv
->
body_vbox
);

270 
	`gtk_widgë_show_Æl
(
¥iv
->
body_vbox
);

271 
	`gtk_widgë_gøb_focus
(
	`qq_ch©widgë_gë_öput_ãxtvõw
(
¥iv
->
ch©_widgë
));

273 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
wö
), "delete-event",

274 
	`G_CALLBACK
(
qq_ch©wödow_dñëe_evít
), 
¥iv
);

275 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
wö
), "focus-in-event",

276 
	`G_CALLBACK
(
qq_ch©wödow_focus_ö_evít
), 
¥iv
);

277 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
wö
), "key-press-event",

278 
	`G_CALLBACK
(
qq_ch©wödow_key_¥ess
), 
¥iv
);

280 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
	`qq_ch©widgë_gë_öput_ãxtvõw
(
¥iv
->
ch©_widgë
)),

281 "key-¥ess-evít", 
	`G_CALLBACK
(
qq_öput_ãxtvõw_key_¥ess
), 
wö
);

282 
	}
}

287 
	$qq_ch©wödow_gëãr
(
GObje˘
 *
obje˘
, 
guöt
 
¥›îty_id
,

288 
GVÆue
 *
vÆue
, 
GP¨amS≥c
 *
p•ec
)

290 if(
obje˘
 =
NULL
 || 
vÆue
 =NULL || 
¥›îty_id
 < 0){

294 
QQCh©WödowPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(

295 
obje˘
, 
	`qq_ch©wödow_gë_ty≥
()

296 , 
QQCh©WödowPriv
);

298 
¥›îty_id
)

300 
QQ_CHATWINDOW_PROPERTY_UIN
:

301 
	`g_vÆue_£t_°rög
(
vÆue
, 
¥iv
 -> 
uö
);

304 
	`G_OBJECT_WARN_INVALID_PROPERTY_ID
(
obje˘
, 
¥›îty_id
, 
p•ec
);

307 
	}
}

312 
	$qq_ch©wödow_£âî
(
GObje˘
 *
obje˘
, 
guöt
 
¥›îty_id
,

313 c⁄° 
GVÆue
 *
vÆue
, 
GP¨amS≥c
 *
p•ec
)

315 i‡(!
obje˘
 || !
vÆue
 || 
¥›îty_id
 < 0) {

318 
QQCh©WödowPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(

319 
obje˘
, 
	`qq_ch©wödow_gë_ty≥
()

320 , 
QQCh©WödowPriv
);

321 
gch¨
 
buf
[500];

322 
GdkPixbuf
 *
pb
 = 
NULL
;

323 
¥›îty_id
) {

324 
QQ_CHATWINDOW_PROPERTY_UIN
:

325 
	`g_°p˝y
(
¥iv
->
uö
, 
	`g_vÆue_gë_°rög
(
vÆue
));

328 
	`G_OBJECT_WARN_INVALID_PROPERTY_ID
(
obje˘
, 
¥›îty_id
, 
p•ec
);

332 
LwqqBuddy
 *
bdy
 = 
	`lwqq_buddy_föd_buddy_by_uö
(
lwqq_˛õ¡
, 
¥iv
->
uö
);

333 
gch¨
 *
«me
 = 
¥iv
->
uö
;

334 i‡(!
bdy
) {

338 
	`g_¢¥ötf
(
buf
, 500, "<b>%s</b>", 
bdy
->
l⁄g_nick
 ?: "");

339 
	`gtk_œbñ_£t_m¨kup
(
	`GTK_LABEL
(
¥iv
->
 ick_œbñ
), 
buf
);

341 
	`g_¢¥ötf
(
buf
, 500, "%s/%s", 
lwqq_u£r_dú
, 
bdy
->
qqnumbî
 ?: "");

342 
pb

	`gdk_pixbuf_√w_‰om_fûe_©_size
(
buf
, 35, 35, 
NULL
);

343 i‡(!
pb
) {

344 
img
[512];

345 
	`g_¢¥ötf
(
img
, (img), "%s/av©¨.gif", 
lwqq_ic⁄s_dú
);

346 
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe_©_size
(
img
, 35, 35, 
NULL
);

348 
	`gtk_image_£t_‰om_pixbuf
(
	`GTK_IMAGE
(
¥iv
->
Á˚image
), 
pb
);

350 
	`gtk_wödow_£t_ic⁄
(
	`GTK_WINDOW
(
obje˘
), 
pb
);

351 
	`g_obje˘_uƒef
(
pb
);

353 i‡(!
bdy
->
m¨k«me
 || bdy->markname[0] == '\0') {

354 
«me
 = 
bdy
->
nick
;

356 
«me
 = 
bdy
->
m¨k«me
;

359 i‡(
	`g_°rcmp0
("⁄löe", 
bdy
->
°©us
) == 0

360 || 
	`g_°rcmp0
("away", 
bdy
->
°©us
) == 0

361 || 
	`g_°rcmp0
("busy", 
bdy
->
°©us
) == 0

362 || 
	`g_°rcmp0
("sûít", 
bdy
->
°©us
) == 0

363 || 
	`g_°rcmp0
("ˇŒme", 
bdy
->
°©us
) == 0) {

364 
	`gtk_widgë_£t_£nsôive
(
¥iv
->
Á˚image
, 
TRUE
);

365 
	`g_¢¥ötf
(
buf
, 500, "<b>%s</b><span color='blue'>[%s]</span>",

366 
«me
, 
bdy
->
°©us
);

368 
	`gtk_widgë_£t_£nsôive
(
¥iv
->
Á˚image
, 
FALSE
);

369 
	`g_¢¥ötf
(
buf
, 500, "<b>%s</b>", 
«me
);

371 
	`gtk_œbñ_£t_m¨kup
(
	`GTK_LABEL
(
¥iv
->
«me_œbñ
), 
buf
);

374 
	`g_¢¥ötf
(
buf
, 500, "TÆkög wôh %s", 
«me
);

375 
	`gtk_wödow_£t_tôÀ
(
	`GTK_WINDOW
(
obje˘
), 
buf
);

376 
	}
}

378 
	$qq_ch©wödow˛ass_öô
(
QQCh©WödowCœss
 *
wc
)

380 
	`g_ty≥_˛ass_add_¥iv©e
(
wc
, (
QQCh©WödowPriv
));

382 
	`G_OBJECT_CLASS
(
wc
)->
gë_¥›îty
 = 
qq_ch©wödow_gëãr
;

383 
	`G_OBJECT_CLASS
(
wc
)->
£t_¥›îty
 = 
qq_ch©wödow_£âî
;

386 
GP¨amS≥c
 *
p•ec
;

387 
p•ec
 = 
	`g_∑øm_•ec_°rög
("uin"

391 , 
G_PARAM_READABLE
 | 
G_PARAM_CONSTRUCT
 | 
G_PARAM_WRITABLE
);

392 
	`g_obje˘_˛ass_ö°Æl_¥›îty
(
	`G_OBJECT_CLASS
(
wc
)

393 , 
QQ_CHATWINDOW_PROPERTY_UIN
, 
p•ec
);

394 
	}
}

397 
	$qq_ch©wödow_add_£nd_mesßge
(
GtkWidgë
 *
widgë
, 
LwqqMsg
 *
msg
)

400 if(
widgë
 =
NULL
 || 
msg
 == NULL){

404 
QQCh©WödowPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(
widgë


405 , 
	`qq_ch©wödow_gë_ty≥
()

406 , 
QQCh©WödowPriv
);

408 
GtkWidgë
 *
mt
 = 
	`qq_ch©widgë_gë_mesßge_ãxtvõw
(
¥iv
->
ch©_widgë
);

409 
	`qq_ch©_ãxtvõw_add_£nd_mesßge
(
mt
, 
msg
);

411 
	}
}

413 
	$qq_ch©wödow_add_ªcv_mesßge
(
GtkWidgë
 *
widgë
, 
LwqqMsgMesßge
 *
msg
)

415 i‡(!
widgë
 || !
msg
){

419 
QQCh©WödowPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(

420 
widgë
, 
	`qq_ch©wödow_gë_ty≥
(), 
QQCh©WödowPriv
);

422 
GtkWidgë
 *
mt
 = 
	`qq_ch©widgë_gë_mesßge_ãxtvõw
(
¥iv
->
ch©_widgë
);

423 
	`qq_ch©_ãxtvõw_add_ªcv_mesßge
(
mt
, 
msg
);

424 
	}
}

	@src/gui/chatwindow.h

1 #i‚de‡
__GTKQQ_CHATWINDOW_H


2 
	#__GTKQQ_CHATWINDOW_H


	)

3 
	~<gtk/gtk.h
>

4 
	~"msg.h
"

6 
	#QQ_CHATWINDOW
(
obj
Ë
	`G_TYPE_CHECK_INSTANCE_CAST
(obj, 
	`qq_ch©wödow_gë_ty≥
()\

7 , 
QQCh©Wödow
)

	)

8 
	#QQ_CHATWINDOWCLASS
(
c
Ë
	`G_TYPE_CHECK_CLASS_CAST
(c\

9 , 
	`qq_ch©wödow_gë_ty≥
()\

10 , 
QQCh©WödowCœss
)

	)

11 
	#QQ_IS_CHATWINDOW
(
obj
Ë
	`G_TYPE_CHECK_INSTANCE_TYPE
(obj, 
	`qq_ch©wödow_gë_ty≥
())

	)

13 
__QQCh©Wödow
 
	tQQCh©Wödow
;

14 
__QQCh©WödowCœss
 
	tQQCh©WödowCœss
;

16 
	s__QQCh©Wödow
{

17 
GtkWödow
 
	m∑ª¡
;

21 
	s__QQCh©WödowCœss
{

22 
GtkWödowCœss
 
	m∑ª¡
;

25 
GtkWidgë
* 
qq_ch©wödow_√w
(c⁄° 
gch¨
 *
uö
);

26 
GTy≥
 
qq_ch©wödow_gë_ty≥
();

31 
qq_ch©wödow_add_ªcv_mesßge
(
GtkWidgë
 *
widgë
, 
LwqqMsgMesßge
 *
msg
);

32 
qq_ch©wödow_add_£nd_mesßge
(
GtkWidgë
 *
widgë
, 
LwqqMsg
 *
msg
);

	@src/gui/loginpanel.c

1 
	~<glib.h
>

2 
	~<glib/g°dio.h
>

3 
	~<logö∑√l.h
>

4 
	~<maö∑√l.h
>

5 
	~<maöwödow.h
>

6 
	~<åay.h
>

7 
	~<gdk/gdkkeysyms.h
>

8 
	~<°dlib.h
>

9 
	~<°©usbuâ⁄.h
>

10 
	~<ch©wödow.h
>

11 
	~<msglo›.h
>

12 
	~<°rög.h
>

13 
	~"ty≥.h
"

14 
	~"lwdb.h
"

15 
	~"loggî.h
"

16 
	~"logö.h
"

17 
	~"öfo.h
"

18 
	~"smem‹y.h
"

20 #ifde‡
HAVE_CONFIG_H


21 
	~<c⁄fig.h
>

28 
LwqqClõ¡
 *
lwqq_˛õ¡
;

29 *
lwqq_ö°Æl_dú
;

30 *
lwqq_ic⁄s_dú
;

31 *
lwqq_buddy_°©us_dú
;

32 
QQTøy
 *
åay
;

34 
GQQMesßgeLo›
 *
gë_öfo_lo›
;

35 
GQQMesßgeLo›
 *
£nd_lo›
;

37 
GHashTabÀ
 *
lwqq_ch©_wödow
;

39 
qq_logö∑√l˛ass_öô
(
QQLogöP™ñCœss
 *
c
);

40 
qq_logö∑√l_öô
(
QQLogöP™ñ
 *
obj
);

41 
qq_logö∑√l_de°roy
(
GtkWidgë
 *
obj
);

42 
qqnumbî_combox_ch™ged
(
GtkComboBoxText
 *
widgë
, 
gpoöãr
 
d©a
);

44 
upd©e_buddy_qq_numbî
(
LwqqClõ¡
 *
lc
, 
QQMaöP™ñ
 *
∑√l
);

45 
run_logö_°©e_machöe
(
QQLogöP™ñ
 *
∑√l
);

47 
	sLogöP™ñU£rInfo
 {

48 *
	mqqnumbî
;

49 *
	m∑ssw‹d
;

50 *
	m°©us
;

51 *
	mªmpwd
;

52 } 
	tLogöP™ñU£rInfo
;

53 
LogöP™ñU£rInfo
 
	glogö_∑√l_u£r_öfo
;

58 
GQQMesßgeLo›
 
	ggtklo›
;

62 
GTy≥
 
	$qq_logö∑√l_gë_ty≥
()

64 
GTy≥
 
t
 = 0;

65 if(!
t
){

66 c⁄° 
GTy≥Info
 
öfo
 =

68 (
QQLogöP™ñCœss
),

69 
NULL
,

70 
NULL
,

71 (
GCœssInôFunc
)
qq_logö∑√l˛ass_öô
,

72 
NULL
,

73 
NULL
,

74 (
QQLogöP™ñ
),

76 (
GIn°™˚InôFunc
)
qq_logö∑√l_öô
,

77 
NULL


79 
t
 = 
	`g_ty≥_ªgi°î_°©ic
(
GTK_TYPE_VBOX
, "QQLoginPanel"

80 , &
öfo
, 0);

82  
t
;

83 
	}
}

85 
GtkWidgë
* 
	$qq_logö∑√l_√w
(
GtkWidgë
 *
c⁄èöî
)

87 
QQLogöP™ñ
 *
∑√l
 = 
	`g_obje˘_√w
(
	`qq_logö∑√l_gë_ty≥
(), 
NULL
);

88 
∑√l
 -> 
c⁄èöî
 = container;

90  
	`GTK_WIDGET
(
∑√l
);

91 
	}
}

93 
	$qq_logö∑√l˛ass_öô
(
QQLogöP™ñCœss
 *
c
)

95 
GtkWidgëCœss
 *
obje˘_˛ass
 = 
NULL
;

96 
obje˘_˛ass
 = 
	`GTK_WIDGET_CLASS
(
c
);

98 
obje˘_˛ass
 -> 
de°roy
 = 
qq_logö∑√l_de°roy
;

105 
gtklo›
.
˘x
 = 
	`g_maö_c⁄ãxt_deÁu…
();

106 
gtklo›
.
«me
 = "LoginPanel Gtk";

107 
	}
}

112 
	$upd©e_dëaûs
(
LwqqClõ¡
 *
lc
, 
QQLogöP™ñ
 *
∑√l
)

116 
	`qq_gë_buddy_öfo
(
öfo
, infÿ-> 
me
, 
NULL
);

117 
	`gqq_maölo›_©èch
(&
gtklo›


118 , 
qq_maö∑√l_upd©e_my_öfo


120 , 
	`QQ_MAINWINDOW
(
∑√l
 -> 
c⁄èöî
Ë-> 
maö_∑√l
);

123 
QQMaöP™ñ
 *
mp
 = 
	`QQ_MAINPANEL
(
	`QQ_MAINWINDOW
(
∑√l
->
c⁄èöî
)->
maö_∑√l
);

125 
	`lwqq_öfo_gë_⁄löe_buddõs
(
lc
, 
NULL
);

126 
	`gqq_maölo›_©èch
(&
gtklo›
, 
qq_maö∑√l_upd©e_⁄löe_buddõs
, 1, 
mp
);

129 
	`upd©e_buddy_qq_numbî
(
lc
, (
QQMaöP™ñ
 *)
	`QQ_MAINWINDOW
(
∑√l
->
c⁄èöî
)->
maö_∑√l
);

132 
göt
 
i
;

133 
QQGroup
 *
gΩ
;

134 
gch¨
 
num
[100];

135 
i
 = 0; i < 
öfo
->
groups
->
Àn
; ++i){

136 
gΩ
 = 
	`g_±r_¨øy_ödex
(
öfo
 -> 
groups
, 
i
);

137 if(
gΩ
 =
NULL
){

140 
	`qq_gë_qq_numbî
(
öfo
, 
gΩ
 -> 
code
 -> 
°r
, 
num
, 
NULL
);

141 
	`qq_group_£t
(
gΩ
, "gnumbî", 
num
);

143 
	`gqq_maölo›_©èch
(&
gtklo›
, 
qq_maö∑√l_upd©e_group_öfo
 , 1,

144 
	`QQ_MAINWINDOW
(
∑√l
 -> 
c⁄èöî
Ë-> 
maö_∑√l
);

147 
	`upd©e_Á˚_image
(
öfo
,

148 (
QQMaöP™ñ
*)
	`QQ_MAINWINDOW
(
∑√l
->
c⁄èöî
)-> 
maö_∑√l
);

150 
	}
}

154 
	mLOGIN_SM_CHECKVC
,

155 
	mLOGIN_SM_LOGIN
,

156 
	mLOGIN_SM_GET_DATA
,

157 
	mLOGIN_SM_DONE
,

158 
	mLOGIN_SM_ERR


161 
	$‰ì_logö_∑√l_u£r_öfo
()

163 
LogöP™ñU£rInfo
 *
öfo
 = &
logö_∑√l_u£r_öfo
;

164 
	`g_‰ì
(
öfo
->
∑ssw‹d
);

165 
	`g_‰ì
(
öfo
->
qqnumbî
);

166 
	`g_‰ì
(
öfo
->
ªmpwd
);

167 
	`g_‰ì
(
öfo
->
°©us
);

168 
	}
}

170 
	$logö_∑√l_upd©e_u£r_öfo
(
QQLogöP™ñ
* 
logö∑√l
)

172 
QQLogöP™ñ
 *
∑√l
 = 
NULL
;

173 
gboﬁón
 
a˘ive
;

174 
LogöP™ñU£rInfo
 *
öfo
;

177 
	`‰ì_logö_∑√l_u£r_öfo
();

179 
∑√l
 = 
	`QQ_LOGINPANEL
(
logö∑√l
);

181 
öfo
 = &
logö_∑√l_u£r_öfo
;

183 
öfo
->
qqnumbî
 = 
	`gtk_combo_box_ãxt_gë_a˘ive_ãxt
(

184 
	`GTK_COMBO_BOX_TEXT
(
∑√l
->
uö_íåy
));

186 
öfo
->
∑ssw‹d
 = 
	`g_°rdup
(
	`gtk_íåy_gë_ãxt
(

187 
	`GTK_ENTRY
(
∑√l
->
∑sswd_íåy
)));

189 
öfo
->
°©us
 = 
	`g_°rdup
(
	`qq_°©usbuâ⁄_gë_°©us_°rög
(

190 
logö∑√l
->
°©us_comb
));

192 
a˘ive
 = 
	`gtk_toggÀ_buâ⁄_gë_a˘ive
(
	`GTK_TOGGLE_BUTTON
(

193 
logö∑√l
->
ªmpwcb
));

194 i‡(
a˘ive
 =
TRUE
) {

195 
öfo
->
ªmpwd
 = 
	`g_°rdup
("1");

197 
öfo
->
ªmpwd
 = 
	`g_°rdup
("0");

199 
	}
}

201 
	$upd©e_gdb
(
QQLogöP™ñ
 *
Õ
)

203 
	#UPDATE_GDB_MACRO
() { \

204 
gdb
->
	`upd©e_u£r_öfo
(gdb, 
öfo
->
qqnumbî
, "∑ssw‹d", info->
∑ssw‹d
); \

205 
gdb
->
	`upd©e_u£r_öfo
(gdb, 
öfo
->
qqnumbî
, "°©us", info->
°©us
); \

206 
gdb
->
	`upd©e_u£r_öfo
(gdb, 
öfo
->
qqnumbî
, "ªmpwd", info->
ªmpwd
); \

207 }

	)

208 
LwdbGlobÆDB
 *
gdb
 = 
Õ
->gdb;

209 
LwdbGlobÆU£rE¡ry
 *
e
;

210 
LogöP™ñU£rInfo
 *
öfo
 = &
logö_∑√l_u£r_öfo
;

212 
	`LIST_FOREACH
(
e
, &
gdb
->
hód
, 
íåõs
) {

213 i‡(!
	`g_°rcmp0
(
e
->
qqnumbî
, 
öfo
->qqnumber)) {

214 
	`UPDATE_GDB_MACRO
();

219 
gdb
->
	`add_√w_u£r
(gdb, 
öfo
->
qqnumbî
);

220 
	`UPDATE_GDB_MACRO
();

222 #unde‡
UPDATE_GDB_MACRO


223 
	}
}

225 
	$gë_vc
(
QQLogöP™ñ
 *
∑√l
)

227 
LwqqClõ¡
 *
lc
 = 
lwqq_˛õ¡
;

228 
vc_image
[128];

229 
GtkWidgë
 *
w
 = 
∑√l
->
c⁄èöî
;

231 
	`g_¢¥ötf
(
vc_image
, (vc_image), "/tmp/lwqq_%s.j≥g", 
lc
->
u£∫ame
);

232 i‡(
	`g_ac˚ss
(
vc_image
, 
F_OK
)) {

233 
	`g_w¨nög
("Nÿv¯imagêd©®‹Åy≥!(%s, %d)" , 
__FILE__
, 
__LINE__
);

234 
	`gtk_œbñ_£t_ãxt
(
	`GTK_LABEL
(
∑√l
->
îr_œbñ
),

236 
	`qq_maöwödow_show_logö∑√l
(
w
);

240 
GtkWidgë
 *
dülog
 = 
	`gtk_dülog_√w_wôh_buâ⁄s
(

241 "Inf‹m©i⁄", 
	`GTK_WINDOW
(
w
), 
GTK_DIALOG_MODAL
, 
GTK_STOCK_OK
,

242 
GTK_RESPONSE_OK
, 
NULL
);

243 
GtkWidgë
 *
vbox
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_VERTICAL
, 0);

244 
	`gtk_c⁄èöî_add
(

245 
	`GTK_CONTAINER
(
	`gtk_dülog_gë_c⁄ã¡_¨ó
(
	`GTK_DIALOG
(
dülog
))), 
vbox
);

247 
GtkWidgë
 *
img
 = 
	`gtk_image_√w_‰om_fûe
(
vc_image
);

249 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
vbox
), 
	`gtk_œbñ_√w
("VerifyCodeÔºö"),

250 
FALSE
, FALSE, 20);

251 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
vbox
), 
img
, 
FALSE
, FALSE, 0);

253 
GtkWidgë
 *
vc_íåy
 = 
	`gtk_íåy_√w
();

254 
	`gtk_widgë_£t_size_ªque°
(
vc_íåy
, 200, -1);

255 
GtkWidgë
 *
hbox
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_HORIZONTAL
, 0);

256 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
hbox
), 
vc_íåy
, 
TRUE
, 
FALSE
, 0);

257 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
vbox
), 
hbox
, 
FALSE
, FALSE, 10);

259 
	`gtk_widgë_£t_size_ªque°
(
dülog
, 300, 220);

260 
	`gtk_widgë_show_Æl
(
dülog
);

261 
	`gtk_dülog_run
(
	`GTK_DIALOG
(
dülog
));

264 
lc
->
vc
->
°r
 = 
	`g_°rdup
(
	`gtk_íåy_gë_ãxt
(
	`GTK_ENTRY
(
vc_íåy
)));

265 
	`gtk_widgë_de°roy
(
dülog
);

266 
	`run_logö_°©e_machöe
(
∑√l
);

267 
	}
}

269 
	$h™dÀ_√w_msg
(
LwqqRecvMsg
 *
ªcvmsg
)

271 
LwqqMsg
 *
msg
 = 
ªcvmsg
->msg;

273 
	`¥ötf
("Re˚ivêmesßgêty≥: %d\n", 
msg
->
ty≥
);

275 i‡(
msg
->
ty≥
 =
LWQQ_MT_BUDDY_MSG
) {

276 
LwqqMsgMesßge
 *
mmsg
 = 
msg
->
›aque
;

277 
GtkWidgë
 *
cw
 = 
	`g_hash_èbÀ_lookup
(
lwqq_ch©_wödow
, 
mmsg
->
‰om
);

279 i‡(!
cw
) {

280 
cw
 = 
	`qq_ch©wödow_√w
(
mmsg
->
‰om
);

281 
	`lwqq_log
(
LOG_DEBUG
, "No chat window for uin:%s, createáÇew:%p\n",

282 
mmsg
->
‰om
, 
cw
);

285 
	`gtk_widgë_hide
(
cw
);

287 
	`g_hash_èbÀ_ö£π
(
lwqq_ch©_wödow
, 
	`g_°rdup
(
mmsg
->
‰om
), 
cw
);

289 
	`lwqq_log
(
LOG_DEBUG
, "Found ch© wödow:%∞f‹ uö:%s\n", 
cw
, 
mmsg
->
‰om
);

291 
	`qq_ch©wödow_add_ªcv_mesßge
(
cw
, 
mmsg
);

292 
	`gtk_widgë_show
(
cw
);

294 } i‡(
msg
->
ty≥
 =
LWQQ_MT_GROUP_MSG
) {

296 } i‡(
msg
->
ty≥
 =
LWQQ_MT_STATUS_CHANGE
) {

299 
	`¥ötf
("unknow message\n");

302 
	`lwqq_msg_‰ì
(
ªcvmsg
->
msg
);

303 
	`s_‰ì
(
ªcvmsg
);

304 
	}
}

306 
gpoöãr
 
	$pﬁl_msg
(
gpoöãr
 
d©a
)

308 
LwqqRecvMsgLi°
 *
l
 = (LwqqRecvMsgLi° *)
d©a
;

309 
l
->
	`pﬁl_msg
(l);

311 
LwqqRecvMsg
 *
msg
;

312 
	`±hªad_muãx_lock
(&
l
->
muãx
);

313 i‡(
	`SIMPLEQ_EMPTY
(&
l
->
hód
)) {

315 
	`±hªad_muãx_u∆ock
(&
l
->
muãx
);

316 
	`u¶ìp
(100000);

319 
msg
 = 
	`SIMPLEQ_FIRST
(&
l
->
hód
);

320 
	`SIMPLEQ_REMOVE_HEAD
(&
l
->
hód
, 
íåõs
);

321 
	`±hªad_muãx_u∆ock
(&
l
->
muãx
);

322 
	`gqq_maölo›_©èch
(&
gtklo›
, 
h™dÀ_√w_msg
, 1, 
msg
);

324  
NULL
;

325 
	}
}

333 
	$h™dÀ_logö
(
QQLogöP™ñ
 *
∑√l
)

335 
LwqqClõ¡
 *
lc
 = 
lwqq_˛õ¡
;

336 
LwqqEº‹Code
 
îr
 = 
LWQQ_EC_ERROR
;

338 
	`lwqq_logö
(
lwqq_˛õ¡
, &
îr
);

340 
îr
) {

341 
LWQQ_EC_OK
:

342 
	`lwqq_log
(
LOG_NOTICE
, "Login successfully\n");

343 
	`lwqq_öfo_gë_‰õnds_öfo
(
lc
, 
NULL
);

346 #i‡
	`GLIB_CHECK_VERSION
(2,31,0)

347 
	`g_thªad_√w
("Pﬁ»mesßge", 
pﬁl_msg
, 
lc
->
msg_li°
);

349 
	`g_thªad_¸óã
(
pﬁl_msg
, 
lc
->
msg_li°
, 
FALSE
, 
NULL
);

353 
	`gqq_maölo›_©èch
(&
gtklo›
, 
qq_maö∑√l_upd©e
, 1,

354 
	`QQ_MAINPANEL
(
	`QQ_MAINWINDOW
(
∑√l
->
c⁄èöî
)->
maö_∑√l
));

357 
	`gqq_maölo›_©èch
(&
gtklo›
, 
qq_maöwödow_show_maö∑√l
,

358 1, 
∑√l
->
c⁄èöî
);

360 
	`upd©e_dëaûs
(
lc
, 
∑√l
);

362 
LWQQ_EC_LOGIN_NEED_VC
:

363 
	`gqq_maölo›_©èch
(&
gtklo›
, 
gë_vc
, 1, 
∑√l
);

365 
LWQQ_EC_ERROR
:

367 
	`lwqq_log
(
LOG_ERROR
, "Login failed\n");

368 
	`gqq_maölo›_©èch
(&
gtklo›
, 
gtk_œbñ_£t_ãxt
, 2,

369 
	`GTK_LABEL
(
∑√l
->
îr_œbñ
), "Login failed");

370 
	`gqq_maölo›_©èch
(&
gtklo›
, 
qq_maöwödow_show_logö∑√l
,

371 1, 
∑√l
->
c⁄èöî
);

374 
	}
}

379 
	$run_logö_°©e_machöe
(
QQLogöP™ñ
 *
∑√l
)

381 
	`gqq_maölo›_©èch
(
gë_öfo_lo›
, 
h™dÀ_logö
, 1, 
∑√l
);

382 
	}
}

388 
	$logö_cb
(
QQLogöP™ñ
* 
∑√l
)

390 
LogöP™ñU£rInfo
 *
öfo
 = &
logö_∑√l_u£r_öfo
;

391 
GtkWidgë
 *
wö
 = 
∑√l
->
c⁄èöî
;

392 
	`qq_maöwödow_show_•œsh∑√l
(
wö
);

395 
	`logö_∑√l_upd©e_u£r_öfo
(
∑√l
);

396 
	`lwqq_log
(
LOG_NOTICE
, "StartÜogin... qqnum: %s, status: %s\n",

397 
öfo
->
qqnumbî
, info->
°©us
);

400 
	`upd©e_gdb
(
∑√l
);

402 i‡(
lwqq_˛õ¡
) {

404 
	`lwqq_˛õ¡_‰ì
(
lwqq_˛õ¡
);

406 
lwqq_˛õ¡
 = 
	`lwqq_˛õ¡_√w
(
öfo
->
qqnumbî
, info->
∑ssw‹d
);

408 i‡(
lwqq_˛õ¡
) {

409 
	`run_logö_°©e_machöe
(
∑√l
);

411 
	}
}

415 
gboﬁón
 
	$quick_logö
(
GtkWidgë
* 
widgë
,
GdkEvít
* 
e
,
gpoöãr
 
d©a
)

417 
GdkEvítKey
 *
evít
 = (GdkEvítKey*)
e
;

418 if(
evít
 -> 
keyvÆ
 =
GDK_KEY_Rëu∫
 ||Évíà-> keyvÆ =
GDK_KEY_KP_E¡î
||

419 
evít
 -> 
keyvÆ
 =
GDK_KEY_ISO_E¡î
){

420 if((
evít
 -> 
°©e
 & 
GDK_CONTROL_MASK
) != 0

421 || (
evít
 -> 
°©e
 & 
GDK_SHIFT_MASK
) != 0){

422  
FALSE
;

424 
	`logö_cb
(
	`QQ_LOGINPANEL
(
d©a
));

425  
TRUE
;

427  
FALSE
;

429 
	}
}

434 
	$logö_bä_cb
(
GtkBuâ⁄
 *
bä
, 
gpoöãr
 
d©a
)

436 
QQLogöP™ñ
 *
∑√l
 = 
	`QQ_LOGINPANEL
(
d©a
);

437 
	`logö_cb
(
∑√l
);

438 
	}
}

441 
	$qq_logö∑√l_öô
(
QQLogöP™ñ
 *
obj
)

443 
LwdbGlobÆU£rE¡ry
 *
e
;

445 
	`mem£t
(&
logö_∑√l_u£r_öfo
, 0, (login_panel_user_info));

447 
obj
->
gdb
 = 
	`lwdb_globÆdb_√w
();

448 i‡(!
obj
->
gdb
) {

449 
	`lwqq_log
(
LOG_ERROR
, "Create global db failed,Éxit\n");

450 
	`exô
(1);

452 
obj
->
uö_œbñ
 = 
	`gtk_œbñ_√w
("QQ Number:");

453 
obj
->
uö_íåy
 = 
	`gtk_combo_box_ãxt_√w_wôh_íåy
();

454 
	`LIST_FOREACH
(
e
, &
obj
->
gdb
->
hód
, 
íåõs
) {

455 
	`gtk_combo_box_ãxt_≠≥nd_ãxt
(
	`GTK_COMBO_BOX_TEXT
(
obj
->
uö_íåy
),

456 
e
->
qqnumbî
);

458 
	`gtk_combo_box_£t_a˘ive
(
	`GTK_COMBO_BOX
(
obj
->
uö_íåy
), 0);

460 
obj
->
∑sswd_œbñ
 = 
	`gtk_œbñ_√w
("Password:");

461 
obj
->
∑sswd_íåy
 = 
	`gtk_íåy_√w
();

462 
e
 = 
	`LIST_FIRST
(&
obj
->
gdb
->
hód
);

463 i‡(
e
 &&É->
ªmpwd
) {

464 
	`gtk_íåy_£t_ãxt
(
	`GTK_ENTRY
(
obj
->
∑sswd_íåy
), 
e
->
∑ssw‹d
);

466 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
obj
->
uö_íåy
), "changed",

467 
	`G_CALLBACK
(
qqnumbî_combox_ch™ged
), 
obj
);

468 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
obj
->
uö_íåy
),"key-press-event",

469 
	`G_CALLBACK
(
quick_logö
), (
gpoöãr
)
obj
);

470 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
obj
->
∑sswd_íåy
), "key-press-event",

471 
	`G_CALLBACK
(
quick_logö
), (
gpoöãr
)
obj
);

473 
	`gtk_íåy_£t_visibûôy
(
	`GTK_ENTRY
(
obj
->
∑sswd_íåy
), 
FALSE
);

475 
	`gtk_widgë_£t_size_ªque°
(
obj
->
uö_íåy
, 200, -1);

476 
	`gtk_widgë_£t_size_ªque°
(
obj
->
∑sswd_íåy
, 220, -1);

478 
GtkWidgë
 *
vbox
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_VERTICAL
, 10);

481 
GtkWidgë
 *
uö_hbox
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_HORIZONTAL
, 0);

482 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
uö_hbox
), 
obj
->
uö_œbñ
, 
FALSE
, FALSE, 0);

483 
GtkWidgë
 *
uö_vbox
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_VERTICAL
, 2);

484 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
uö_vbox
), 
uö_hbox
, 
FALSE
, FALSE, 0);

485 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
uö_vbox
), 
obj
->
uö_íåy
, 
FALSE
, FALSE, 0);

488 
GtkWidgë
 *
∑sswd_hbox
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_HORIZONTAL
, 0);

489 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
∑sswd_hbox
), 
obj
->
∑sswd_œbñ
,

490 
FALSE
, FALSE, 0);

491 
GtkWidgë
 *
∑sswd_vbox
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_VERTICAL
, 2);

492 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
∑sswd_vbox
), 
∑sswd_hbox
, 
FALSE
, FALSE, 0);

493 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
∑sswd_vbox
), 
obj
->
∑sswd_íåy
, 
FALSE
, FALSE, 0);

496 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
vbox
), 
uö_vbox
, 
FALSE
, FALSE, 2);

497 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
vbox
), 
∑sswd_vbox
, 
FALSE
, FALSE, 2);

500 
obj
->
ªmpwcb
 = 
	`gtk_check_buâ⁄_√w_wôh_œbñ
("Remeber Password");

501 i‡(
e
 &&É->
ªmpwd
) {

502 
gboﬁón
 
r
;

503 
r
 = 
	`©oi
(
e
->
ªmpwd
Ë=1 ? 
TRUE
 : 
FALSE
;

504 
	`gtk_toggÀ_buâ⁄_£t_a˘ive
(
	`GTK_TOGGLE_BUTTON
(
obj
->
ªmpwcb
), 
r
);

509 
GtkWidgë
 *
hbox4
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_HORIZONTAL
, 0);

510 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
hbox4
), 
obj
->
ªmpwcb
, 
TRUE
, 
FALSE
, 0);

511 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
vbox
), 
hbox4
, 
FALSE
, 
TRUE
, 2);

514 
obj
->
logö_bä
 = 
	`gtk_buâ⁄_√w_wôh_œbñ
("Login");

515 
	`gtk_widgë_£t_size_ªque°
(
obj
->
logö_bä
, 90, -1);

516 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
obj
->
logö_bä
), "˛icked", 
	`G_CALLBACK
(
logö_bä_cb
), (
gpoöãr
)obj);

519 
obj
->
°©us_comb
 = 
	`qq_°©usbuâ⁄_√w
();

520 i‡(
e
 &&É->
°©us
) {

521 
	`qq_°©usbuâ⁄_£t_°©us_°rög
(
obj
->
°©us_comb
, 
e
->
°©us
);

524 
GtkWidgë
 *
hbox1
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_HORIZONTAL
, 0);

525 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
hbox1
), 
vbox
, 
TRUE
, 
FALSE
, 0);

527 
GtkWidgë
 *
hbox2
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_HORIZONTAL
, 0);

528 
GtkWidgë
 *
hbox3
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_HORIZONTAL
, 0);

529 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
hbox2
), 
obj
->
°©us_comb
, 
FALSE
, FALSE, 0);

530 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
hbox2
), 
obj
->
logö_bä
, 
FALSE
, FALSE, 0);

531 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
hbox3
), 
hbox2
, 
TRUE
, 
FALSE
, 0);

534 
obj
->
îr_œbñ
 = 
	`gtk_œbñ_√w
("");

535 
GdkRGBA
 
cﬁ‹
;

536 
	`gdk_rgba_∑r£
(&
cﬁ‹
, "#fff000000");

537 
	`gtk_widgë_ovîride_cﬁ‹
(
	`GTK_WIDGET
(
obj
-> 
îr_œbñ
), 
GTK_STATE_NORMAL
, &
cﬁ‹
);

539 
hbox2
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_HORIZONTAL
, 0);

540 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
hbox2
), 
obj
 -> 
îr_œbñ
, 
TRUE
, 
FALSE
, 0);

541 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
vbox
), 
hbox2
, 
TRUE
, 
FALSE
, 0);

543 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
vbox
), 
hbox3
, 
FALSE
, FALSE, 0);

545 
	`gtk_box_£t_homogíeous
(
	`GTK_BOX
(
obj
), 
FALSE
);

546 
img
[512];

547 
	`g_¢¥ötf
(
img
, (img), "%s/webqq_ic⁄.≤g", 
lwqq_ic⁄s_dú
);

548 
GtkWidgë
 *
logo
 = 
	`gtk_image_√w_‰om_fûe
(
img
);

549 
	`gtk_widgë_£t_size_ªque°
(
logo
, -1, 150);

550 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
obj
), 
logo
, 
FALSE
, FALSE, 5);

551 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
obj
), 
hbox1
, 
FALSE
, FALSE, 15);

552 
	}
}

554 
	$qqnumbî_combox_ch™ged
(
GtkComboBoxText
 *
widgë
, 
gpoöãr
 
d©a
)

556 
LwdbGlobÆU£rE¡ry
 *
e
;

557 *
qqnumbî
 = 
	`gtk_combo_box_ãxt_gë_a˘ive_ãxt
(
widgë
);

558 i‡(!
qqnumbî
) {

562 
QQLogöP™ñ
 *
obj
 = 
	`QQ_LOGINPANEL
(
d©a
);

563 
	`LIST_FOREACH
(
e
, &
obj
->
gdb
->
hód
, 
íåõs
) {

564 i‡(!
	`°rcmp
(
e
->
qqnumbî
, qqnumber)) {

565 
	`gtk_íåy_£t_ãxt
(
	`GTK_ENTRY
(
obj
->
∑sswd_íåy
), 
e
->
∑ssw‹d
);

566 
	`qq_°©usbuâ⁄_£t_°©us_°rög
(
obj
->
°©us_comb
, 
e
->
°©us
);

570 
	}
}

575 
	$qq_logö∑√l_de°roy
(
GtkWidgë
 *
obj
)

582 
	}
}

584 c⁄° 
gch¨
* 
	$qq_logö∑√l_gë_uö
(
QQLogöP™ñ
 *
logö∑√l
)

586 
QQLogöP™ñ
 *
∑√l
 = 
	`QQ_LOGINPANEL
(
logö∑√l
);

589  
	`gtk_combo_box_ãxt_gë_a˘ive_ãxt
(

590 
	`GTK_COMBO_BOX_TEXT
(
∑√l
->
uö_íåy
));

592 
	}
}

593 c⁄° 
gch¨
* 
	$qq_logö∑√l_gë_∑sswd
(
QQLogöP™ñ
 *
logö∑√l
)

595 
QQLogöP™ñ
 *
∑√l
 = 
	`QQ_LOGINPANEL
(
logö∑√l
);

596  
	`gtk_íåy_gë_ãxt
(

597 
	`GTK_ENTRY
(
∑√l
 -> 
∑sswd_íåy
));

598 
	}
}

599 c⁄° 
gch¨
* 
	$qq_logö∑√l_gë_°©us
(
QQLogöP™ñ
 *
logö∑√l
)

601  
	`qq_°©usbuâ⁄_gë_°©us_°rög
(
logö∑√l
 -> 
°©us_comb
);

602 
	}
}

604 
göt
 
	$qq_logö∑√l_gë_ªmpw
(
QQLogöP™ñ
 *
logö∑√l
)

606  
	`gtk_toggÀ_buâ⁄_gë_a˘ive
(
	`GTK_TOGGLE_BUTTON
(
logö∑√l
->
ªmpwcb
));

607 
	}
}

610 
LwqqClõ¡
 *
	mlc
;

611 
LwqqBuddy
 *
	mbdy
;

612 } 
	tThªadFuncP¨
;

617 
	$gë_buddy_qqnumbî_thªad_func
(
gpoöãr
 
d©a
, gpoöã∏
u£r_d©a
)

620 
ThªadFuncP¨
 *
∑r
 = 
d©a
;

621 
LwqqClõ¡
 *
lc
 = 
∑r
->lc;

622 
LwqqBuddy
 *
bdy
 = 
∑r
->bdy;

623 
	`g_¶i˚_‰ì
(
ThªadFuncP¨
 ,
∑r
);

626 
	`s_‰ì
(
bdy
->
qqnumbî
);

627 
bdy
->
qqnumbî
 = 
	`lwqq_öfo_gë_‰õnd_qqnumbî
(
lc
, bdy->
uö
);

628 
	}
}

634 
	$upd©e_buddy_qq_numbî
(
LwqqClõ¡
 *
lc
, 
QQMaöP™ñ
 *
∑√l
)

636 
GThªadPoﬁ
 *
thªad_poﬁ
;

637 
ThªadFuncP¨
 *
∑r
 = 
NULL
;

638 
LwqqBuddy
 *
buddy
;

640 
thªad_poﬁ
 = 
	`g_thªad_poﬁ_√w
(
gë_buddy_qqnumbî_thªad_func
, 
NULL
,

641 100, 
TRUE
, 
NULL
);

643 i‡(!
thªad_poﬁ
){

644 
	`g_debug
("canÇot createÇewÅhreadÖool ...(%s,%d)",

645 
__FILE__
, 
__LINE__
 );

648 
	`LIST_FOREACH
(
buddy
, &
lc
->
‰õnds
, 
íåõs
) {

649 
∑r
 = 
	`g_¶i˚_√w0
(
ThªadFuncP¨
);

650 
∑r
->
lc
 =Üc;

651 
∑r
->
bdy
 = 
buddy
;

652 
	`g_thªad_poﬁ_push
(
thªad_poﬁ
, (
gpoöãr
)
∑r
, 
NULL
);

655 
	`g_thªad_poﬁ_‰ì
(
thªad_poﬁ
, 0, 1);

658 
	`qq_maö∑√l_upd©e_buddy_öfo
(
∑√l
);

661 
	}
}

664 
	$gë_buddy_Á˚_thªad_func
(
gpoöãr
 
d©a
, gpoöã∏
u£r_d©a
)

667 
ThªadFuncP¨
 *
∑r
 = 
d©a
;

668 
GPåAºay
 * 
imgs
 = 
∑r
 -> 
¨øy
;

669 
göt
 
id
 = 
∑r
 -> id;

670 
QQInfo
 * 
öfo
 = 
∑r
 -> info;

671 
	`g_¶i˚_‰ì
(
ThªadFuncP¨
 , 
∑r
);

672 
QQFa˚Img
 * 
img
;

673 
gch¨
 
∑th
[500];

674 
img
 = 
	`g_±r_¨øy_ödex
(
imgs
, 
id
);

675 
	`qq_gë_Á˚_img
(
öfo
,
img
, 
NULL
);

676 
	`g_¢¥ötf
(
∑th
, 500, "%s/%s", 
QQ_FACEDIR
, 
img
 -> 
num
 -> 
°r
);

677 
	`qq_ßve_Á˚_img
(
img
,
∑th
,
NULL
);

679 
	}
}

684 
	$upd©e_Á˚_image
(
LwqqClõ¡
 *
lc
, 
QQMaöP™ñ
 *
∑√l
)

686 if(
öfo
 =
NULL
 || 
∑√l
 == NULL){

690 
GPåAºay
 *
fimgs
 = 
	`g_±r_¨øy_√w
();

691 
göt
 
i
;

692 
QQBuddy
 *
bdy
 = 
NULL
;

693 
QQFa˚Img
 *
img
 = 
NULL
;

696 
img
 = 
	`qq_Á˚img_√w
();

697 
	`qq_Á˚img_£t
(
img
, "uö", 
öfo
 -> 
me
 -> 
uö
);

698 
	`qq_Á˚img_£t
(
img
, "num", 
öfo
 -> 
me
 -> 
qqnumbî
);

699 
	`g_±r_¨øy_add
(
fimgs
, 
img
);

702 
i
 = 0; i < 
öfo
 -> 
buddõs
 -> 
Àn
; ++i){

703 
bdy
 = 
	`g_±r_¨øy_ödex
(
öfo
 -> 
buddõs
, 
i
);

704 if(
bdy
 =
NULL
){

707 
img
 = 
	`qq_Á˚img_√w
();

708 
	`qq_Á˚img_£t
(
img
, "uö", 
bdy
 -> 
uö
);

709 
	`qq_Á˚img_£t
(
img
, "num", 
bdy
 -> 
qqnumbî
);

710 
	`g_±r_¨øy_add
(
fimgs
, 
img
);

714 
QQGroup
 *
gΩ
 = 
NULL
;

715 
i
 = 0; i < 
öfo
 -> 
groups
 -> 
Àn
; ++i){

716 
gΩ
 = 
	`g_±r_¨øy_ödex
(
öfo
 -> 
groups
, 
i
);

717 if(
gΩ
 =
NULL
){

720 
img
 = 
	`qq_Á˚img_√w
();

721 
	`qq_Á˚img_£t
(
img
, "uö", 
gΩ
 -> 
code
);

722 
	`qq_Á˚img_£t
(
img
, "num", 
gΩ
 -> 
gnumbî
);

723 
	`g_±r_¨øy_add
(
fimgs
, 
img
);

727 
GThªadPoﬁ
 * 
thªad_poﬁ
;

729 #i‡!
	`GLIB_CHECK_VERSION
(2,31,0)

730 
	`g_thªad_öô
(
NULL
);

732 
ThªadFuncP¨
 * 
∑r
 = 
NULL
;

734 
thªad_poﬁ
 = 
	`g_thªad_poﬁ_√w
(
gë_buddy_Á˚_thªad_func
, 
NULL
 ,100, 
TRUE
, NULL );

736 i‡–! 
thªad_poﬁ
 ){

737 
	`g_debug
("canÇot createÇewÅhreadÖool ...(%s,%d)",

738 
__FILE__
, 
__LINE__
 );

742  
i
 =0 ; i < 
öfo
->
buddõs
 ->
Àn
 ; i ++ )

744 
∑r
 = 
	`g_¶i˚_√w0
(
ThªadFuncP¨
);

745 
∑r
 -> 
¨øy
 = 
NULL
;

746 
∑r
 -> 
id
 = 
i
;

747 
∑r
 -> 
öfo
 = info;

748 
∑r
 -> 
¨øy
 = 
fimgs
;

750 
	`g_thªad_poﬁ_push
–
thªad_poﬁ
 , (
gpoöãr
Ë
∑r
, 
NULL
);

753 
	`g_thªad_poﬁ_‰ì
(
thªad_poﬁ
, 0,1);

756 
i
 = 0; i < 
fimgs
 -> 
Àn
; ++i){

757 
img
 = 
	`g_±r_¨øy_ödex
(
fimgs
, 
i
);

758 
	`qq_Á˚img_‰ì
(
img
);

762 
	`gqq_maölo›_©èch
(&
gtklo›
, 
qq_maö∑√l_upd©e_buddy_Á˚img
, 1, 
∑√l
);

763 
	`gqq_maölo›_©èch
(&
gtklo›
, 
qq_maö∑√l_upd©e_group_öfo
, 1, 
∑√l
);

764 
	}
}

	@src/gui/loginpanel.h

1 #i‚de‡
__GTKQQ_LOGINWIN_H


2 
	#__GTKQQ_LOGINWIN_H


	)

3 
	~<gtk/gtk.h
>

4 
	~"lwdb.h
"

6 
	#QQ_LOGINPANEL
(
obj
Ë
	`G_TYPE_CHECK_INSTANCE_CAST
(obj, 
	`qq_logö∑√l_gë_ty≥
()\

7 , 
QQLogöP™ñ
)

	)

8 
	#QQ_LOGINPANEL_CLASS
(
c
Ë
	`G_TYPE_CHECK_CLASS_CAST
(c\

9 , 
	`qq_logö∑√l_gë_ty≥
()\

10 , 
QQLogöP™ñCœss
)

	)

11 
	#QQ_IS_LOGINPANEL
(
obj
Ë
	`G_TYPE_CHECK_INSTANCE_TYPE
(obj, 
	`qq_logö∑√l_gë_ty≥
())

	)

13 
_QQLogöP™ñ
 
	tQQLogöP™ñ
;

14 
_QQLogöP™ñCœss
 
	tQQLogöP™ñCœss
;

15 
_QQLogöP™ñLogöSèã
 
	tQQLogöP™ñLogöSèã
;

18 
	e_QQLogöP™ñLogöSèã
{

19 
	mLS_CHECK_VC
,

20 
	mLS_LOGIN
,

21 
	mLS_GET_MY_INFO
,

22 
	mLS_GET_FRIENDS
,

23 
	mLS_GET_GROUP_LIST
,

24 
	mLS_ONLINE
,

25 
	mLS_RECENT
,

26 
	mLS_SLNICK
,

27 
	mLS_GET_FACEIMG
,

28 
	mLS_DONE
,

29 
	mLS_ERROR
,

30 
	mLS_UNKNOWN


33 
	s_QQLogöP™ñ
{

34 
GtkVBox
 
	m∑ª¡
;

37 
GtkWidgë
 *
	muö_œbñ
, *
	muö_íåy
;

38 
GtkWidgë
 *
	m∑sswd_œbñ
, *
	m∑sswd_íåy
;

39 
GtkWidgë
 *
	mªmpwcb
;

40 
GtkWidgë
 *
	mîr_œbñ
;

41 
GtkWidgë
 *
	mlogö_bä
, *
	m°©us_comb
;

42 #ifde‡
USE_PROXY


43 
GtkWidgë
 *
	m£t_¥oxy_bä
;

46 c⁄° 
gch¨
 *
	muö
, *
	m∑sswd
, *
	m°©us
;

47 
göt
 
	mªmpw
;

49 
LwdbGlobÆDB
 *
	mgdb
;

50 
GtkWidgë
 *
	mc⁄èöî
;

53 
QQLogöP™ñLogöSèã
 
	mlogö_°©e
;

56 
	s_QQLogöP™ñCœss
{

57 
GtkVBoxCœss
 
	m∑ª¡
;

66 
GtkWidgë
* 
qq_logö∑√l_√w
(GtkWidgë *
c⁄èöî
);

67 
GTy≥
 
qq_logö∑√l_gë_ty≥
();

72 c⁄° 
gch¨
* 
qq_logö∑√l_gë_uö
(
QQLogöP™ñ
 *
logö∑√l
);

73 c⁄° 
gch¨
* 
qq_logö∑√l_gë_∑sswd
(
QQLogöP™ñ
 *
logö∑√l
);

74 c⁄° 
gch¨
* 
qq_logö∑√l_gë_°©us
(
QQLogöP™ñ
 *
logö∑√l
);

75 
göt
 
qq_logö∑√l_gë_ªmpw
(
QQLogöP™ñ
 *
logö∑√l
);

	@src/gui/main.c

1 
	~<gtk/gtk.h
>

2 
	~<°dlib.h
>

3 
	~<gë›t.h
>

4 
	~<uni°d.h
>

5 
	~<logö∑√l.h
>

6 
	~<maö∑√l.h
>

7 
	~<maöwödow.h
>

8 
	~<msglo›.h
>

9 
	~<åay.h
>

10 
	~"loggî.h
"

11 
	~"lwdb.h
"

13 #ifde‡
USE_GSTREAMER


14 
	~<g°/g°.h
>

21 *
	glwqq_ö°Æl_dú
 = 
NULL
;

22 *
	glwqq_ic⁄s_dú
 = 
NULL
;

23 *
	glwqq_buddy_°©us_dú
 = 
NULL
;

24 *
	glwqq_u£r_dú
 = 
NULL
;

25 
QQTøy
 *
	gåay
 = 
NULL
;

26 
GtkWidgë
 *
	gmaö_wö
 = 
NULL
;

27 
GHashTabÀ
 *
	glwqq_ch©_wödow
 = 
NULL
;

33 
GQQMesßgeLo›
 *
	ggë_öfo_lo›
 = 
NULL
;

38 
GQQMesßgeLo›
 *
	ggë_numbî_Á˚img_lo›
 = 
NULL
;

43 
GQQMesßgeLo›
 *
	g£nd_lo›
 = 
NULL
;

47 
gboﬁón
 
	gdebug
 = 
FALSE
;

49 
gboﬁón
 
	$_¥öt_vîsi⁄_™d_exô
(c⁄° *
›ti⁄_«me
,

50 c⁄° *
vÆue
, 
gpoöãr
 
d©a
,

51 
GEº‹
 **
îr‹
)

54 
	`exô
(
EXIT_SUCCESS
);

55  
TRUE
;

56 
	}
}

58 
GO±i⁄E¡ry
 
	gíåõs
[] =

60 {"debug", 'd', 0, 
G_OPTION_ARG_NONE
, &
debug
, "O≥¿debug mode", 
NULL
},

61 {"vîsi⁄", 'v', 
G_OPTION_FLAG_NO_ARG
, 
G_OPTION_ARG_CALLBACK
,

62 
_¥öt_vîsi⁄_™d_exô
, "ShowÅhê≠∂iˇti⁄'†vîsi⁄", 
NULL
},

63 {
NULL
}

66 
	$gui_öô
()

68 i‡(
	`g_thªad_gë_öôülized
(Ë=
FALSE
) {

69 #i‡!
	`GLIB_CHECK_VERSION
(2,31,0)

70 
	`g_thªad_öô
(
NULL
);

72 
	`lwqq_log
(
LOG_DEBUG
, "InitÅhe gthread system\n");

75 
gë_öfo_lo›
 = 
	`gqq_msglo›_°¨t
("Get informain");

76 i‡(
gë_öfo_lo›
 =
NULL
) {

77 
	`exô
(1);

81 
	`lwdb_öô
();

83 
lwqq_ö°Æl_dú
 = 
	`g_°rdup
(
LWQQ_INSTALL_DIR
);

84 
lwqq_ic⁄s_dú
 = 
	`g_°rdup_¥ötf
("%s/ic⁄s", 
lwqq_ö°Æl_dú
);

85 
lwqq_buddy_°©us_dú
 = 
	`g_°rdup_¥ötf
("%s/°©us", 
lwqq_ic⁄s_dú
);

86 
lwqq_u£r_dú
 = 
	`g_°rdup_¥ötf
("%s/lwqq", 
	`g_gë_u£r_c⁄fig_dú
());

89 
lwqq_ch©_wödow
 = 
	`g_hash_èbÀ_√w_fuŒ
(
g_°r_hash
, 
g_°r_equÆ
,

90 
g_‰ì
, 
NULL
);

91 
	}
}

93 
	$gui_föÆize
()

95 
	`lwdb_föÆize
();

96 
	`g_‰ì
(
lwqq_ö°Æl_dú
);

97 
	`g_‰ì
(
lwqq_ic⁄s_dú
);

98 
	`g_‰ì
(
lwqq_buddy_°©us_dú
);

99 
	}
}

101 
	$maö
(
¨gc
, **
¨gv
)

103 
GEº‹
 *
îr‹
 = 
NULL
;

104 
GO±i⁄C⁄ãxt
 *
c⁄ãxt
;

105 
c⁄ãxt
 = 
	`g_›ti⁄_c⁄ãxt_√w
(
NULL
);

106 
	`g_›ti⁄_c⁄ãxt_add_maö_íåõs
(
c⁄ãxt
, 
íåõs
, 
NULL
);

107 
	`g_›ti⁄_c⁄ãxt_add_group
(
c⁄ãxt
, 
	`gtk_gë_›ti⁄_group
(
TRUE
));

108 #ifde‡
USE_GSTREAMER


109 
	`g_›ti⁄_c⁄ãxt_add_group
(
c⁄ãxt
, 
	`g°_öô_gë_›ti⁄_group
());

111 i‡(!
	`g_›ti⁄_c⁄ãxt_∑r£
(
c⁄ãxt
, &
¨gc
, &
¨gv
, &
îr‹
)) {

112 
	`g_¥öt
("›ti⁄Ö¨sög faûed: %s\n", 
îr‹
->
mesßge
);

113 
	`exô
(1);

115 
	`g_›ti⁄_c⁄ãxt_‰ì
(
c⁄ãxt
);

117 #ifde‡
USE_GSTREAMER


118 
	`g°_öô
(
NULL
, NULL);

120 
	`gtk_öô
(&
¨gc
, &
¨gv
);

122 
	`gui_öô
();

124 
	`log_öô
(
debug
);

125 
öfo
 = 
	`qq_öô
(
NULL
);

126 if(
öfo
 =
NULL
){

129 
cfg
 = 
	`gqq_c⁄fig_√w
(
öfo
);

132 
£nd_lo›
 = 
	`gqq_msglo›_°¨t
("Send");

133 if(
£nd_lo›
 =
NULL
){

136 
gë_öfo_lo›
 = 
	`gqq_msglo›_°¨t
("Get informain");

137 if(
gë_öfo_lo›
 =
NULL
){

140 
gë_numbî_Á˚img_lo›
 = 
	`gqq_msglo›_°¨t
("Get Numberánd face images");

141 if(
gë_numbî_Á˚img_lo›
 =
NULL
){

146 
maö_wö
 = 
	`qq_maöwödow_√w
();

147 
åay
 = 
	`qq_åay_√w
();

148 
	`gtk_widgë_show_Æl
(
maö_wö
);

150 
	`gtk_maö
();

152 
	`g_obje˘_uƒef
(
	`G_OBJECT
(
åay
));

154 
	`gui_föÆize
();

156 
	`qq_logout
(
öfo
, 
NULL
);

158 
	`gqq_msglo›_°›
(
gë_öfo_lo›
);

159 
	`gqq_msglo›_°›
(
£nd_lo›
);

163 
	`gqq_c⁄fig_ßve
(
cfg
);

164 
	`qq_föÆize
(
öfo
, 
NULL
);

167 
	}
}

	@src/gui/mainpanel.c

1 
	~<maö∑√l.h
>

2 
	~<°©usbuâ⁄.h
>

3 
	~<msglo›.h
>

4 
	~<buddyåì.h
>

5 
	~<åay.h
>

6 
	~<buddyli°.h
>

7 
	~<°dlib.h
>

9 
QQTøy
 *
åay
;

10 
LwqqClõ¡
 *
lwqq_˛õ¡
;

11 *
lwqq_ö°Æl_dú
;

12 *
lwqq_ic⁄s_dú
;

13 *
lwqq_buddy_°©us_dú
;

15 
GQQMesßgeLo›
 *
gë_öfo_lo›
;

16 
GQQMesßgeLo›
 *
£nd_lo›
;

20 
GQQMesßgeLo›
 
	ggtklo›
;

22 
QQMaöP™ñCœss
 *
	gthis_˛ass
 = 
NULL
;

24 
qq_maö∑√l_öô
(
QQMaöP™ñ
 *
∑√l
);

25 
qq_maö∑√l˛ass_öô
(
QQMaöP™ñCœss
 *
c
);

27 
gboﬁón
 
 ick_ªÀa£_cb
(
GtkWidgë
 *
w
, 
GdkEvít
 *
evít
, 
gpoöãr
 
d©a
);

28 
gboﬁón
 
 ick_focus_out_cb
(
GtkWidgë
 *
w
, 
GdkEvít
 *
evít
, 
gpoöãr
 
d©a
);

29 
gboﬁón
 
 ick_íãr_cb
(
GtkWidgë
 *
w
, 
GdkEvít
 *
evít
, 
gpoöãr
 
d©a
);

30 
gboﬁón
 
 ick_Àave_cb
(
GtkWidgë
 *
w
, 
GdkEvít
 *
evít
, 
gpoöãr
 
d©a
);

33 
bä_group_ªÀa£_cb
(
GtkWidgë
 *
bä
, 
GdkEvít
 *
evít
, 
gpoöãr
 
d©a
);

34 
bä_group_íãr_cb
(
GtkWidgë
 *
bä
, 
GdkEvít
 *
evít
, 
gpoöãr
 
d©a
);

35 
bä_group_Àave_cb
(
GtkWidgë
 *
bä
, 
GdkEvít
 *
evít
, 
gpoöãr
 
d©a
);

37 
upd©e_my_Á˚_image
(
QQMaöP™ñ
 *
∑√l
);

39 
GTy≥
 
	$qq_maö∑√l_gë_ty≥
()

41 
GTy≥
 
t
 = 0;

42 if(!
t
){

43 c⁄° 
GTy≥Info
 
öfo
 =

45 (
QQMaöP™ñCœss
),

46 
NULL
,

47 
NULL
,

48 (
GCœssInôFunc
)
qq_maö∑√l˛ass_öô
,

49 
NULL
,

50 
NULL
,

51 (
QQMaöP™ñ
),

53 (
GIn°™˚InôFunc
)
qq_maö∑√l_öô
,

54 
NULL


56 
t
 = 
	`g_ty≥_ªgi°î_°©ic
(
GTK_TYPE_VBOX
, "QQMainPanel"

57 , &
öfo
, 0);

59  
t
;

60 
	}
}

61 
GtkWidgë
* 
	$qq_maö∑√l_√w
(
GtkWidgë
 *
c⁄èöî
)

63 
QQMaöP™ñ
 *
∑√l
 = 
	`g_obje˘_√w
(
	`qq_maö∑√l_gë_ty≥
(), 
NULL
);

64 
∑√l
 -> 
c⁄èöî
 = container;

66  
	`GTK_WIDGET
(
∑√l
);

67 
	}
}

69 
	$qq_group_li°_⁄_doubÀ_˛ick
(
GtkTªeVõw
 *
åì


70 , 
GtkTªeP©h
 *
∑th


71 , 
GtkTªeVõwCﬁumn
 *
cﬁ


72 , 
gpoöãr
 
d©a
)

75 
gch¨
 *
code
;

76 
GtkTªeModñ
 *
modñ
 = 
	`gtk_åì_võw_gë_modñ
(
åì
);

78 
GtkTªeIãr
 
ôî
;

79 
	`gtk_åì_modñ_gë_ôî
(
modñ
, &
ôî
, 
∑th
);

80 
	`gtk_åì_modñ_gë
(
modñ
, &
ôî
, 
BDY_LIST_UIN
, &
code
, -1);

82 
GtkWidgë
 *
cw
 = 
	`gqq_c⁄fig_lookup_ht
(
cfg
, "ch©_wödow_m≠", 
code
);

83 if(
cw
 !
NULL
){

85 
	`g_obje˘_£t
(
cw
, "code", 
code
, 
NULL
);

86 
	`gtk_widgë_show
(
cw
);

87 
	`g_‰ì
(
code
);

91 
	`g_debug
("Cª©êgrou∞ch© wödow f‹ %s(%s, %d)", 
code


92 , 
__FILE__
, 
__LINE__
);

93 
cw
 = 
	`qq_group_ch©wödow_√w
(
code
);

94 
	`gtk_widgë_show
(
cw
);

95 
	`gqq_c⁄fig_ö£π_ht
(
cfg
, "ch©_wödow_m≠", 
code
, 
cw
);

96 
	`g_‰ì
(
code
);

98 
	}
}

103 
gboﬁón
 
	$qq_group_li°_⁄_show_toﬁtù
(
GtkWidgë
* 
widgë


104 , 
x


105 , 
y


106 , 
gboﬁón
 
keyb‹d_mode


107 , 
GtkToﬁtù
* 
tù


108 , 
gpoöãr
 
d©a
)

111 
gch¨
 *
«me
, *
code
;

112 
GtkTªeVõw
 *
åì
 = 
	`GTK_TREE_VIEW
(
widgë
);

113 
GtkTªeModñ
 *
modñ
 = 
	`gtk_åì_võw_gë_modñ
(
åì
);

114 
GtkTªeP©h
 *
∑th
;

115 
GtkTªeIãr
 
ôî
;

117 if(!
	`gtk_åì_võw_gë_toﬁtù_c⁄ãxt
(
åì
 , &
x
 , &
y
 , 
keyb‹d_mode


118 , &
modñ
 , &
∑th
 , &
ôî
)){

119  
FALSE
;

121 
	`gtk_åì_modñ_gë
(
modñ
, &
ôî


122 , 
BDY_LIST_NAME
, &
«me


123 , 
BDY_LIST_UIN
, &
code


125 
QQGroup
 *
gΩ
 = 
	`qq_öfo_lookup_group_by_code
(
öfo
, 
code
);

126 if(
gΩ
 =
NULL
){

127 
	`gtk_åì_∑th_‰ì
(
∑th
);

128 
	`g_‰ì
(
«me
);

129 
	`g_‰ì
(
code
);

130  
FALSE
;

133 
gch¨
 
buf
[100];

134 c⁄° 
gch¨
 *
Àvñ°r
 = 
NULL
;

135 
göt
 
tmpöt
 = (göt)
	`°πﬁ
(
gΩ
 -> 
Àvñ
 -> 
°r
, 
NULL
, 10);

136 
tmpöt
)

139 
Àvñ°r
 = "ÊôÆÈÄöÁæ§";

142 
Àvñ°r
 = "È´òÁ∫ßÁæ§";

145 
Àvñ°r
 = "";

148 
	`g_¢¥ötf
(
buf
, 100, "%†- %s", 
«me
, 
Àvñ°r
);

149 
	`gtk_toﬁtù_£t_m¨kup
(
tù
, 
buf
);

150 
	`gtk_åì_võw_£t_toﬁtù_row
(
åì
, 
tù
, 
∑th
);

152 
	`gtk_åì_∑th_‰ì
(
∑th
);

153 
	`g_‰ì
(
«me
);

154 
	`g_‰ì
(
code
);

156  
TRUE
;

157 
	}
}

160 
	$qq_maö∑√l_öô
(
QQMaöP™ñ
 *
∑√l
)

163 
GtkWidgë
 *
hbox
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_HORIZONTAL
, 0);

164 
GtkWidgë
 *
box
 = 
NULL
;

165 
GtkWidgë
 *
vbox
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_VERTICAL
, 0);

167 
∑√l
 -> 
Á˚img‰ame
 = 
	`gtk_‰ame_√w
(
NULL
);

168 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
hbox
), 
∑√l
 -> 
Á˚img‰ame


169 , 
FALSE
, FALSE, 5);

171 
∑√l
 -> 
°©us_bä
 = 
	`qq_°©usbuâ⁄_√w
();

172 
∑√l
 -> 
nick
 = 
	`gtk_œbñ_√w
("");

173 
box
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_HORIZONTAL
, 0);

174 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
box
), 
∑√l
 -> 
°©us_bä
, 
FALSE
, FALSE, 0);

175 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
box
), 
∑√l
 -> 
nick
, 
FALSE
, FALSE, 5);

176 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
vbox
), 
box
, 
FALSE
, FALSE, 2);

178 
∑√l
 -> 
l⁄gnick
 = 
	`gtk_œbñ_√w
("");

179 
∑√l
 -> 
l⁄gnick_íåy
 = 
	`gtk_íåy_√w
();

180 
	`gtk_widgë_£t_size_ªque°
(
	`GTK_WIDGET
(
∑√l
 -> 
l⁄gnick_íåy
), 0, 0);

181 
∑√l
 -> 
l⁄gnick_box
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_HORIZONTAL
, 0);

182 
∑√l
 -> 
l⁄gnick_evítbox
 = 
	`gtk_evít_box_√w
();

183 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
∑√l
 -> 
l⁄gnick_evítbox
)

184 , 
∑√l
 -> 
l⁄gnick
);

185 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
∑√l
 -> 
l⁄gnick_box
)

186 , 
∑√l
 -> 
l⁄gnick_evítbox


187 , 
FALSE
, FALSE, 0);

188 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
∑√l
 -> 
l⁄gnick_box
)

189 , 
∑√l
 -> 
l⁄gnick_íåy


190 , 
FALSE
, FALSE, 0);

191 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
vbox
), 
∑√l
 -> 
l⁄gnick_box
, 
FALSE
, FALSE, 0);

193 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
hbox
), 
vbox
, 
FALSE
, FALSE, 0);

194 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
∑√l
), 
hbox
, 
FALSE
, FALSE, 10);

196 
	`g_sig«l_c⁄√˘
(
	`GTK_WIDGET
(
∑√l
 -> 
l⁄gnick_evítbox
)

198 , 
	`G_CALLBACK
(
 ick_ªÀa£_cb
), 
∑√l
);

199 
	`g_sig«l_c⁄√˘
(
	`GTK_WIDGET
(
∑√l
 -> 
l⁄gnick_evítbox
)

201 , 
	`G_CALLBACK
(
 ick_íãr_cb
), 
∑√l
);

202 
	`g_sig«l_c⁄√˘
(
	`GTK_WIDGET
(
∑√l
 -> 
l⁄gnick_evítbox
)

204 , 
	`G_CALLBACK
(
 ick_Àave_cb
), 
∑√l
);

205 
	`g_sig«l_c⁄√˘
(
	`GTK_WIDGET
(
∑√l
 -> 
l⁄gnick_íåy
)

207 , 
	`G_CALLBACK
(
 ick_focus_out_cb
), 
∑√l
);

209 
∑√l
 -> 
buddy_bä
 = 
	`gtk_evít_box_√w
();

210 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
∑√l
 -> 
buddy_bä
)

211 , 
this_˛ass
 -> 
buddy_img
[0]);

212 
∑√l
 -> 
gΩ_bä
 = 
	`gtk_evít_box_√w
();

213 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
∑√l
 -> 
gΩ_bä
)

214 , 
this_˛ass
 -> 
gΩ_img
[1]);

215 
∑√l
 -> 
ª˚¡_bä
 = 
	`gtk_evít_box_√w
();

216 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
∑√l
 -> 
ª˚¡_bä
)

217 , 
this_˛ass
 -> 
ª˚¡_img
[1]);

219 
	`g_sig«l_c⁄√˘
(
	`GTK_WIDGET
(
∑√l
 -> 
buddy_bä
), "button-release-event"

220 , 
	`G_CALLBACK
(
bä_group_ªÀa£_cb
), 
∑√l
);

221 
	`g_sig«l_c⁄√˘
(
	`GTK_WIDGET
(
∑√l
 -> 
gΩ_bä
), "button-release-event"

222 , 
	`G_CALLBACK
(
bä_group_ªÀa£_cb
), 
∑√l
);

223 
	`g_sig«l_c⁄√˘
(
	`GTK_WIDGET
(
∑√l
 -> 
ª˚¡_bä
), "button-release-event"

224 , 
	`G_CALLBACK
(
bä_group_ªÀa£_cb
), 
∑√l
);

226 
	`g_sig«l_c⁄√˘
(
	`GTK_WIDGET
(
∑√l
 -> 
buddy_bä
), "enter-notify-event"

227 , 
	`G_CALLBACK
(
bä_group_íãr_cb
), 
∑√l
);

228 
	`g_sig«l_c⁄√˘
(
	`GTK_WIDGET
(
∑√l
 -> 
gΩ_bä
), "enter-notify-event"

229 , 
	`G_CALLBACK
(
bä_group_íãr_cb
), 
∑√l
);

230 
	`g_sig«l_c⁄√˘
(
	`GTK_WIDGET
(
∑√l
 -> 
ª˚¡_bä
), "enter-notify-event"

231 , 
	`G_CALLBACK
(
bä_group_íãr_cb
), 
∑√l
);

233 
	`g_sig«l_c⁄√˘
(
	`GTK_WIDGET
(
∑√l
 -> 
buddy_bä
), "leave-notify-event"

234 , 
	`G_CALLBACK
(
bä_group_Àave_cb
), 
∑√l
);

235 
	`g_sig«l_c⁄√˘
(
	`GTK_WIDGET
(
∑√l
 -> 
gΩ_bä
), "leave-notify-event"

236 , 
	`G_CALLBACK
(
bä_group_Àave_cb
), 
∑√l
);

237 
	`g_sig«l_c⁄√˘
(
	`GTK_WIDGET
(
∑√l
 -> 
ª˚¡_bä
), "leave-notify-event"

238 , 
	`G_CALLBACK
(
bä_group_Àave_cb
), 
∑√l
);

240 
hbox
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_HORIZONTAL
, 0);

241 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
hbox
), 
∑√l
 -> 
buddy_bä
, 
TRUE
, TRUE, 0);

242 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
hbox
), 
∑√l
 -> 
gΩ_bä
, 
TRUE
, TRUE, 0);

243 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
hbox
), 
∑√l
 -> 
ª˚¡_bä
, 
TRUE
, TRUE, 0);

244 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
∑√l
), 
hbox
, 
FALSE
, FALSE, 0);

247 
∑√l
 -> 
nŸebook
 = 
	`gtk_nŸebook_√w
();

248 
	`gtk_nŸebook_£t_show_èbs
(
	`GTK_NOTEBOOK
(
∑√l
 -> 
nŸebook
), 
FALSE
);

249 
	`gtk_nŸebook_£t_s¸ﬁœbÀ
(
	`GTK_NOTEBOOK
(
∑√l
 -> 
nŸebook
), 
TRUE
);

250 
	`gtk_nŸebook_£t_show_b‹dî
(
	`GTK_NOTEBOOK
(
∑√l
 -> 
nŸebook
), 
TRUE
);

251 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
∑√l
),Ö™ñ -> 
nŸebook
, 
TRUE
, TRUE, 3);

253 
∑√l
 -> 
buddy_åì

	`qq_buddy_åì_√w
();

254 
∑√l
 -> 
group_li°
 = 
	`qq_buddy_li°_√w
();

255 
∑√l
 -> 
ª˚¡_li°
 = 
	`qq_buddy_li°_√w
();

257 
	`g_sig«l_c⁄√˘
(
∑√l
 -> 
group_li°


259 , 
	`G_CALLBACK
(
qq_group_li°_⁄_doubÀ_˛ick
)

260 , 
NULL
);

261 
	`gtk_widgë_£t_has_toﬁtù
(
∑√l
 -> 
group_li°
, 
TRUE
);

262 
	`g_sig«l_c⁄√˘
(
∑√l
 -> 
group_li°
, "query-tooltip"

263 , 
	`G_CALLBACK
(
qq_group_li°_⁄_show_toﬁtù
Ë, 
NULL
);

265 
GtkWidgë
 *
s¸ﬁÀd_wö
;

266 
s¸ﬁÀd_wö

	`gtk_s¸ﬁÀd_wödow_√w
(
NULL
, NULL);

267 
	`gtk_s¸ﬁÀd_wödow_£t_pﬁicy
 (
	`GTK_SCROLLED_WINDOW
(
s¸ﬁÀd_wö
),

268 
GTK_POLICY_NEVER
, 
GTK_POLICY_AUTOMATIC
);

269 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
s¸ﬁÀd_wö
), 
∑√l
 -> 
buddy_åì
);

270 
	`gtk_nŸebook_≠≥nd_∑ge
(
	`GTK_NOTEBOOK
(
∑√l
 -> 
nŸebook
)

271 , 
s¸ﬁÀd_wö
, 
NULL
);

273 
s¸ﬁÀd_wö

	`gtk_s¸ﬁÀd_wödow_√w
(
NULL
, NULL);

274 
	`gtk_s¸ﬁÀd_wödow_£t_pﬁicy
 (
	`GTK_SCROLLED_WINDOW
(
s¸ﬁÀd_wö
),

275 
GTK_POLICY_NEVER
, 
GTK_POLICY_AUTOMATIC
);

276 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
s¸ﬁÀd_wö
), 
∑√l
 -> 
group_li°
);

277 
	`gtk_nŸebook_≠≥nd_∑ge
(
	`GTK_NOTEBOOK
(
∑√l
 -> 
nŸebook
)

278 , 
s¸ﬁÀd_wö
, 
NULL
);

280 
s¸ﬁÀd_wö

	`gtk_s¸ﬁÀd_wödow_√w
(
NULL
, NULL);

281 
	`gtk_s¸ﬁÀd_wödow_£t_pﬁicy
 (
	`GTK_SCROLLED_WINDOW
(
s¸ﬁÀd_wö
),

282 
GTK_POLICY_NEVER
, 
GTK_POLICY_AUTOMATIC
);

283 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
s¸ﬁÀd_wö
), 
∑√l
 -> 
ª˚¡_li°
);

284 
	`gtk_nŸebook_≠≥nd_∑ge
(
	`GTK_NOTEBOOK
(
∑√l
 -> 
nŸebook
)

285 , 
s¸ﬁÀd_wö
, 
NULL
);

287 
	}
}

288 
	$qq_maö∑√l˛ass_öô
(
QQMaöP™ñCœss
 *
c
)

290 
this_˛ass
 = 
c
;

291 
GdkPixbuf
 * 
pb
;

292 
img
[512];

294 
	#QQ_MAINPANELCLASS_INIT_MACRO
(
v¨übÀ
, 
«me
) { \

295 
	`g_¢¥ötf
(
img
, (img), "%s/%s", 
lwqq_ic⁄s_dú
, 
«me
); \

296 
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe
(
img
, 
NULL
); \

297 
v¨übÀ
 = 
	`gtk_image_√w_‰om_pixbuf
(
pb
); \

298 }

	)

300 
	`QQ_MAINPANELCLASS_INIT_MACRO
(
c
->
buddy_img
[0], "ContactMainTabButton1.png");

301 
	`QQ_MAINPANELCLASS_INIT_MACRO
(
c
->
buddy_img
[1], "ContactMainTabButton2.png");

303 
	`QQ_MAINPANELCLASS_INIT_MACRO
(
c
->
gΩ_img
[0], "GroupMainTabButton1.png");

304 
	`QQ_MAINPANELCLASS_INIT_MACRO
(
c
->
gΩ_img
[1], "GroupMainTabButton2.png");

306 
	`QQ_MAINPANELCLASS_INIT_MACRO
(
c
->
ª˚¡_img
[0], "RecentMainTabButton1.png");

307 
	`QQ_MAINPANELCLASS_INIT_MACRO
(
c
->
ª˚¡_img
[1], "RecentMainTabButton2.png");

308 #unde‡
QQ_MAINPANELCLASS_INIT_MACRO


311 
	`g_obje˘_ªf
(
	`G_OBJECT
(
c
->
buddy_img
[0]));

312 
	`g_obje˘_ªf
(
	`G_OBJECT
(
c
->
buddy_img
[1]));

313 
	`g_obje˘_ªf
(
	`G_OBJECT
(
c
->
gΩ_img
[0]));

314 
	`g_obje˘_ªf
(
	`G_OBJECT
(
c
->
gΩ_img
[1]));

315 
	`g_obje˘_ªf
(
	`G_OBJECT
(
c
->
ª˚¡_img
[0]));

316 
	`g_obje˘_ªf
(
	`G_OBJECT
(
c
->
ª˚¡_img
[1]));

319 
	`gtk_widgë_show
(
c
->
buddy_img
[0]);

320 
	`gtk_widgë_show
(
c
->
buddy_img
[1]);

321 
	`gtk_widgë_show
(
c
->
gΩ_img
[0]);

322 
	`gtk_widgë_show
(
c
->
gΩ_img
[1]);

323 
	`gtk_widgë_show
(
c
->
ª˚¡_img
[0]);

324 
	`gtk_widgë_show
(
c
->
ª˚¡_img
[1]);

326 
c
->
h™d
 = 
	`gdk_curs‹_√w
(
GDK_HAND1
);

328 
gtklo›
.
˘x
 = 
	`g_maö_c⁄ãxt_deÁu…
();

329 
gtklo›
.
«me
 = "MainPanel Gtk";

330 
	}
}

331 
	$qq_maö∑√l_upd©e_my_öfo
(
QQMaöP™ñ
 *
∑√l
)

333 
	`upd©e_my_Á˚_image
(
∑√l
);

335 
gch¨
 
buf
[100];

336 
	`g_¢¥ötf
(
buf
, 100, "<b>%s</b>", 
öfo
->
me
->
nick
->
°r
);

337 
	`gtk_œbñ_£t_m¨kup
(
	`GTK_LABEL
(
∑√l
->
nick
), 
buf
);

338 
	`gtk_œbñ_£t_ãxt
(
	`GTK_LABEL
(
∑√l
->
l⁄gnick
),

339 
öfo
->
me
->
 ick
->
°r
);

341 
	`qq_°©usbuâ⁄_£t_°©us_°rög
(
∑√l
->
°©us_bä
,

342 
öfo
->
me
->
°©us
->
°r
);

344 
	}
}

349 
	$qq_maö∑√l_upd©e
(
QQMaöP™ñ
 *
∑√l
)

352 
	`qq_buddy_åì_upd©e_modñ
(
∑√l
->
buddy_åì
, 
lwqq_˛õ¡
);

354 
	`qq_maö∑√l_upd©e_my_öfo
(
∑√l
);

356 
	`qq_buddy_li°_add_groups
(
∑√l
->
group_li°
, 
öfo
->
groups
);

358 
	}
}

360 
	$qq_maö∑√l_upd©e_buddy_öfo
(
QQMaöP™ñ
 *
∑√l
)

362 
	`qq_buddy_åì_upd©e_buddy_öfo
(
∑√l
->
buddy_åì
, 
lwqq_˛õ¡
);

363 
	}
}

365 
	$qq_maö∑√l_upd©e_buddy_Á˚img
(
QQMaöP™ñ
 *
∑√l
)

368 
	`qq_buddy_åì_upd©e_Á˚img
(
∑√l
->
buddy_åì
, 
öfo
);

370 
	}
}

372 
	$qq_maö∑√l_upd©e_⁄löe_buddõs
(
QQMaöP™ñ
 *
∑√l
)

374 
	`qq_buddy_åì_upd©e_⁄löe_buddõs
(
∑√l
->
buddy_åì
, 
lwqq_˛õ¡
);

375 
	}
}

377 
	$qq_maö∑√l_upd©e_group_öfo
(
QQMaöP™ñ
 *
∑√l
)

380 
	`qq_buddy_li°_upd©e_groups_öfo
(
∑√l
->
group_li°
, 
öfo
->
groups
);

382 
	}
}

387 
gboﬁón
 
	$ ick_ªÀa£_cb
(
GtkWidgë
 *
w
, 
GdkEvít
 *
evít
, 
gpoöãr
 
d©a
)

389 
QQMaöP™ñ
 *
∑√l
 = 
	`QQ_MAINPANEL
(
d©a
);

391 
	`gtk_widgë_hide
(
	`GTK_WIDGET
(
∑√l
 -> 
l⁄gnick_evítbox
));

392 
	`gtk_widgë_show
(
	`GTK_WIDGET
(
∑√l
 -> 
l⁄gnick_íåy
));

394 
	`gtk_íåy_£t_ãxt
(
	`GTK_ENTRY
(
∑√l
 -> 
l⁄gnick_íåy
),

395 
	`gtk_œbñ_gë_ãxt
(
	`GTK_LABEL
(
∑√l
 -> 
l⁄gnick
)));

396 
	`gtk_widgë_show
(
	`GTK_WIDGET
(
∑√l
 -> 
l⁄gnick_íåy
));

397 
	`gtk_widgë_£t_size_ªque°
(
	`GTK_WIDGET
(
∑√l
 -> 
l⁄gnick_íåy
)

399 
	`gtk_widgë_gøb_focus
(
	`GTK_WIDGET
(
∑√l
 -> 
l⁄gnick_íåy
));

400  
FALSE
;

401 
	}
}

406 
gboﬁón
 
	$ ick_focus_out_cb
(
GtkWidgë
 *
w
, 
GdkEvít
 *
evít


407 , 
gpoöãr
 
d©a
)

409 
QQMaöP™ñ
 *
∑√l
 = 
	`QQ_MAINPANEL
(
d©a
);

410 
	`gtk_widgë_show
(
∑√l
 -> 
l⁄gnick_evítbox
);

411 
	`gtk_widgë_hide
(
∑√l
 -> 
l⁄gnick_íåy
);

412 
	`gtk_œbñ_£t_ãxt
(
	`GTK_LABEL
(
∑√l
 -> 
l⁄gnick
)

413 , 
	`gtk_íåy_gë_ãxt
(
	`GTK_ENTRY
(
∑√l
 -> 
l⁄gnick_íåy
)));

414  
FALSE
;

415 
	}
}

423 
	$bä_group_ªÀa£_cb
(
GtkWidgë
 *
bä
, 
GdkEvít
 *
evít
, 
gpoöãr
 
d©a
)

426 
	`gtk_widgë_gøb_focus
(
bä
);

429 
QQMaöP™ñ
 *
∑√l
 = 
	`QQ_MAINPANEL
(
d©a
);

430 
	`gtk_c⁄èöî_ªmove
(
	`GTK_CONTAINER
(
∑√l
 -> 
buddy_bä
)

431 , 
	`gtk_bö_gë_chûd
(
	`GTK_BIN
(
∑√l
 -> 
buddy_bä
)));

432 
	`gtk_c⁄èöî_ªmove
(
	`GTK_CONTAINER
(
∑√l
 -> 
gΩ_bä
)

433 , 
	`gtk_bö_gë_chûd
(
	`GTK_BIN
(
∑√l
 -> 
gΩ_bä
)));

434 
	`gtk_c⁄èöî_ªmove
(
	`GTK_CONTAINER
(
∑√l
 -> 
ª˚¡_bä
)

435 , 
	`gtk_bö_gë_chûd
(
	`GTK_BIN
(
∑√l
 -> 
ª˚¡_bä
)));

437 if(
bä
 =
∑√l
 -> 
buddy_bä
){

438 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
∑√l
 -> 
buddy_bä
)

439 , 
this_˛ass
 -> 
buddy_img
[0]);

440 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
∑√l
 -> 
gΩ_bä
)

441 , 
this_˛ass
 -> 
gΩ_img
[1]);

442 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
∑√l
 -> 
ª˚¡_bä
)

443 , 
this_˛ass
 -> 
ª˚¡_img
[1]);

444 
	`gtk_nŸebook_£t_cuºít_∑ge
(
	`GTK_NOTEBOOK
(
∑√l
 -> 
nŸebook
), 0);

445 }if(
bä
 =
∑√l
 -> 
gΩ_bä
){

446 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
∑√l
 -> 
buddy_bä
)

447 , 
this_˛ass
 -> 
buddy_img
[1]);

448 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
∑√l
 -> 
gΩ_bä
)

449 , 
this_˛ass
 -> 
gΩ_img
[0]);

450 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
∑√l
 -> 
ª˚¡_bä
)

451 , 
this_˛ass
 -> 
ª˚¡_img
[1]);

452 
	`gtk_nŸebook_£t_cuºít_∑ge
(
	`GTK_NOTEBOOK
(
∑√l
 -> 
nŸebook
), 1);

453 }if(
bä
 =
∑√l
 -> 
ª˚¡_bä
){

454 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
∑√l
 -> 
buddy_bä
)

455 , 
this_˛ass
 -> 
buddy_img
[1]);

456 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
∑√l
 -> 
gΩ_bä
)

457 , 
this_˛ass
 -> 
gΩ_img
[1]);

458 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
∑√l
 -> 
ª˚¡_bä
)

459 , 
this_˛ass
 -> 
ª˚¡_img
[0]);

460 
	`gtk_nŸebook_£t_cuºít_∑ge
(
	`GTK_NOTEBOOK
(
∑√l
 -> 
nŸebook
), 2);

463 
	}
}

464 
	$bä_group_íãr_cb
(
GtkWidgë
 *
bä
, 
GdkEvít
 *
evít
, 
gpoöãr
 
d©a
)

466 
GdkWödow
 *
wö
 = 
	`gtk_widgë_gë_wödow
(
bä
);

467 
	`gdk_wödow_£t_curs‹
(
wö
, 
this_˛ass
 -> 
h™d
);

468 
GdkCﬁ‹
 
cﬁ‹
;

469 
	`gdk_cﬁ‹_∑r£
("#C4E6FF", &
cﬁ‹
);

470 
	`gtk_widgë_modify_bg
(
bä
, 
GTK_STATE_NORMAL
, &
cﬁ‹
);

471 
	}
}

472 
	$bä_group_Àave_cb
(
GtkWidgë
 *
bä
, 
GdkEvít
 *
evít
, 
gpoöãr
 
d©a
)

474 
GdkWödow
 *
wö
 = 
	`gtk_widgë_gë_wödow
(
bä
);

475 
	`gdk_wödow_£t_curs‹
(
wö
, 
NULL
);

476 
	`gtk_widgë_modify_bg
(
bä
, 
GTK_STATE_NORMAL
, 
NULL
);

477 
	}
}

483 
gboﬁón
 
	$ ick_íãr_cb
(
GtkWidgë
 *
w
, 
GdkEvít
 *
evít
, 
gpoöãr
 
d©a
)

485 
QQMaöP™ñ
 *
∑√l
 = 
	`QQ_MAINPANEL
(
d©a
);

486 
GdkWödow
 *
wö
 = 
	`gtk_widgë_gë_wödow
(
w
);

487 
	`gdk_wödow_£t_curs‹
(
wö
, 
this_˛ass
 -> 
h™d
);

488 
GdkCﬁ‹
 
cﬁ‹
;

489 
	`gdk_cﬁ‹_∑r£
("#C4E6FF", &
cﬁ‹
);

490 
	`gtk_widgë_modify_bg
(
	`GTK_WIDGET
(
∑√l
 -> 
l⁄gnick_evítbox
)

491 , 
GTK_STATE_NORMAL
, &
cﬁ‹
);

492  
TRUE
;

493 
	}
}

494 
gboﬁón
 
	$ ick_Àave_cb
(
GtkWidgë
 *
w
, 
GdkEvít
 *
evít
, 
gpoöãr
 
d©a
)

496 
QQMaöP™ñ
 *
∑√l
 = 
	`QQ_MAINPANEL
(
d©a
);

497 
GdkWödow
 *
wö
 = 
	`gtk_widgë_gë_wödow
(
w
);

498 
	`gdk_wödow_£t_curs‹
(
wö
, 
NULL
);

499 
	`gtk_widgë_modify_bg
(
	`GTK_WIDGET
(
∑√l
 -> 
l⁄gnick_evítbox
)

500 , 
GTK_STATE_NORMAL
, 
NULL
);

501  
TRUE
;

502 
	}
}

504 
	$upd©e_my_Á˚_image
(
QQMaöP™ñ
 *
∑√l
)

507 
GtkBö
 *
Á˚img‰ame
 = 
	`GTK_BIN
(
∑√l
->faceimgframe);

510 
GtkWidgë
 *
Á˚img
 = 
	`gtk_bö_gë_chûd
(
Á˚img‰ame
);

511 i‡(
Á˚img
 !
NULL
) {

512 
	`gtk_c⁄èöî_ªmove
(
	`GTK_CONTAINER
(
Á˚img‰ame
), 
Á˚img
);

515 
GEº‹
 *
îr
 = 
NULL
;

517 
gch¨
 
buf
[500] = "/usr/share/lwqq/icons/webqq.png";

519 
GdkPixbuf
 *
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe_©_size
(
buf
, 48, 48, &
îr
);

521 i‡(
pb
 =
NULL
) {

522 
	`g_debug
("Load %s's face imageÉrror. use default. %s (%s, %d)",

523 
öfo
->
me
->
qqnumbî
->
°r
,

524 
îr
->
mesßge
, 
__FILE__
, 
__LINE__
);

525 
	`g_îr‹_‰ì
(
îr
);

526 
îr
 = 
NULL
;

527 
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe_©_size
(

528 
IMGDIR
"/av©¨.gif", 48, 48, &
îr
);

529 if(
pb
 =
NULL
){

530 
	`g_w¨nög
("Load default face imageÉrror. %s (%s, %d)",

531 
îr
->
mesßge
, 
__FILE__
, 
__LINE__
);

532 
	`g_îr‹_‰ì
(
îr
);

536 
GtkWidgë
 *
img
 = 
	`gtk_image_√w_‰om_pixbuf
(
pb
);

537 
	`g_obje˘_uƒef
(
pb
);

539 
	`gtk_widgë_show
(
img
);

540 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
Á˚img‰ame
), 
img
);

541 
	}
}

	@src/gui/mainpanel.h

1 #i‚de‡
__GTKQQ_MAINPANEL_H


2 
	#__GTKQQ_MAINPANEL_H


	)

3 
	~<gtk/gtk.h
>

5 
	#QQ_MAINPANEL
(
obj
Ë
	`G_TYPE_CHECK_INSTANCE_CAST
(obj, 
	`qq_maö∑√l_gë_ty≥
()\

6 , 
QQMaöP™ñ
)

	)

7 
	#QQ_MAINPANELCLASS
(
c
Ë
	`G_TYPE_CHECK_CLASS_CAST
(c\

8 , 
	`qq_maö∑√l_gë_ty≥
()\

9 , 
QQMaöP™ñCœss
)

	)

10 
	#QQ_IS_MAINPANEL
(
obj
Ë
	`G_TYPE_CHECK_INSTANCE_TYPE
(obj, 
	`qq_maö∑√l_gë_ty≥
())

	)

12 
_QQMaöP™ñ
 
	tQQMaöP™ñ
;

13 
_QQMaöP™ñCœss
 
	tQQMaöP™ñCœss
;

15 
	s_QQMaöP™ñ
{

16 
GtkVBox
 
	m∑ª¡
;

19 
GtkWidgë
 *
	mÁ˚img‰ame
;

20 
GtkWidgë
 *
	mÁ˚evítbox
;

21 
GdkPixbuf
 *
	mÁ˚pixbuf
;

23 
GtkWidgë
 *
	m°©us_bä
;

24 
GtkWidgë
 *
	mnick
;

26 
GtkWidgë
 *
	ml⁄gnick
, *
	ml⁄gnick_íåy
;

27 
GtkWidgë
 *
	ml⁄gnick_box
, *
	ml⁄gnick_evítbox
;

29 
GtkWidgë
 *
	m£¨ch_íåy
;

31 
GtkWidgë
 *
	mbuddy_bä
, *
	mgΩ_bä
, *
	mª˚¡_bä
;

33 
GtkWidgë
 *
	mnŸebook
;

34 
GtkWidgë
 *
	mbuddy_åì
;

35 
GtkWidgë
 *
	mgroup_li°
;

36 
GtkWidgë
 *
	mª˚¡_li°
;

38 
GtkWidgë
 *
	mmíub¨
;

40 
GtkWidgë
 *
	mc⁄èöî
;

43 
	s_QQMaöP™ñCœss
{

44 
GtkVBoxCœss
 
	m∑ª¡
;

47 
GtkWidgë
 *
	mbuddy_img
[2];

48 
GtkWidgë
 *
	mgΩ_img
[2];

49 
GtkWidgë
 *
	mª˚¡_img
[2];

51 
GdkCurs‹
 *
	mh™d
;

54 
GTy≥
 
qq_maö∑√l_gë_ty≥
();

55 
GtkWidgë
* 
qq_maö∑√l_√w
(GtkWidgë *
c⁄èöî
);

62 
qq_maö∑√l_upd©e
(
QQMaöP™ñ
 *
∑√l
);

66 
qq_maö∑√l_upd©e_my_öfo
(
QQMaöP™ñ
 *
∑√l
);

70 
qq_maö∑√l_upd©e_buddy_öfo
(
QQMaöP™ñ
 *
∑√l
);

71 
qq_maö∑√l_upd©e_buddy_Á˚img
(
QQMaöP™ñ
 *
∑√l
);

72 
qq_maö∑√l_upd©e_⁄löe_buddõs
(
QQMaöP™ñ
 *
∑√l
);

74 
qq_maö∑√l_upd©e_group_öfo
(
QQMaöP™ñ
 *
∑√l
);

	@src/gui/mainwindow.c

12 
	~<°dlib.h
>

13 
	~"maöwödow.h
"

14 
	~"logö∑√l.h
"

15 
	~"•œsh∑√l.h
"

16 
	~"maö∑√l.h
"

17 
	~"ty≥.h
"

18 
	~"logö.h
"

20 
LwqqClõ¡
 *
	glwqq_˛õ¡
 = 
NULL
;

22 
qq_maöwödow_öô
(
QQMaöWödow
 *
wö
);

23 
qq_maöwödow˛ass_öô
(
QQMaöWödowCœss
 *
wc
);

25 
gboﬁón
 
	$qq_maöwödow_˛o£
(
GtkWidgë
 *
widgë
)

27 
	`lwqq_logout
(
lwqq_˛õ¡
, 
NULL
);

28 
	`gtk_maö_quô
();

31 
	`qq_maöwödow_hide
(
widgë
);

34  
TRUE
;

35 
	}
}

37 
GTy≥
 
	$qq_maöwödow_gë_ty≥
()

39 
GTy≥
 
t
 = 0;

40 i‡(!
t
) {

41 c⁄° 
GTy≥Info
 
öfo
 = {

42 (
QQMaöWödowCœss
),

43 
NULL
,

44 
NULL
,

45 (
GCœssInôFunc
)
qq_maöwödow˛ass_öô
,

46 
NULL
,

47 
NULL
,

48 (
QQMaöWödow
),

50 (
GIn°™˚InôFunc
)
qq_maöwödow_öô
,

54 
t
 = 
	`g_ty≥_ªgi°î_°©ic
(
GTK_TYPE_WINDOW
, "QQMaöWödow", &
öfo
, 0);

56  
t
;

57 
	}
}

64 
	$qq_maöwödow_show
(
GtkWidgë
 *
wö
)

66 
QQMaöWödow
 *
maöwö
 = (QQMaöWödow *)
wö
;

68 
maöwö
->
showed
 = 
TRUE
;

69 
	`gtk_widgë_show
(
wö
);

70 
	}
}

77 
	$qq_maöwödow_hide
(
GtkWidgë
 *
wö
)

79 
QQMaöWödow
 *
maöwö
 = (QQMaöWödow *)
wö
;

81 
maöwö
->
showed
 = 
FALSE
;

82 
	`gtk_widgë_hide
(
wö
);

83 
	}
}

90 
	$qq_maöwödow_show_hide
(
GtkWidgë
 *
wö
)

92 
QQMaöWödow
 *
maöwö
 = (QQMaöWödow *)
wö
;

94 i‡(
TRUE
 =
maöwö
->
showed
) {

95 
	`qq_maöwödow_hide
(
wö
);

97 
	`qq_maöwödow_show
(
wö
);

99 
	}
}

107 
GtkWidgë
 *
	$qq_maöwödow_√w
()

109  
	`GTK_WIDGET
(
	`g_obje˘_√w
(
	`qq_maöwödow_gë_ty≥
(), "type",

110 
GTK_WINDOW_TOPLEVEL
, 
NULL
));

111 
	}
}

113 
	$qq_maöwödow_öô
(
QQMaöWödow
 *
wö
)

115 
GtkWidgë
 *
w
 = 
	`GTK_WIDGET
(
wö
);

118 
	`gtk_widgë_£t_size_ªque°
(
w
, 200, 500);

119 
	`gtk_wödow_ªsize
(
	`GTK_WINDOW
(
w
), 250, 550);

121 
	`g_sig«l_c⁄√˘
(
w
, "delete-event",

122 
	`G_CALLBACK
(
qq_maöwödow_˛o£
), 
NULL
);

123 
wö
->
showed
 = 
FALSE
;

125 
wö
->
logö_∑√l
 = 
	`qq_logö∑√l_√w
(
w
);

126 
wö
->
•œsh_∑√l
 = 
	`qq_•œsh∑√l_√w
();

127 
wö
->
maö_∑√l
 = 
	`qq_maö∑√l_√w
(
w
);

129 
wö
->
nŸebook
 = 
	`gtk_nŸebook_√w
();

131 
	`gtk_nŸebook_£t_show_èbs
(
	`GTK_NOTEBOOK
(
wö
->
nŸebook
), 
FALSE
);

132 
	`gtk_nŸebook_£t_show_b‹dî
(
	`GTK_NOTEBOOK
(
wö
->
nŸebook
), 
FALSE
);

134 
	`gtk_widgë_show_Æl
(
wö
->
logö_∑√l
);

135 
	`gtk_widgë_show_Æl
(
wö
->
•œsh_∑√l
);

136 
	`gtk_widgë_show_Æl
(
wö
->
maö_∑√l
);

138 
	`gtk_nŸebook_≠≥nd_∑ge
(
	`GTK_NOTEBOOK
(
wö
->
nŸebook
),

139 
wö
->
logö_∑√l
, 
NULL
);

140 
	`gtk_nŸebook_≠≥nd_∑ge
(
	`GTK_NOTEBOOK
(
wö
->
nŸebook
),

141 
wö
->
•œsh_∑√l
, 
NULL
);

142 
	`gtk_nŸebook_≠≥nd_∑ge
(
	`GTK_NOTEBOOK
(
wö
->
nŸebook
),

143 
wö
->
maö_∑√l
, 
NULL
);

145 
	`gtk_c⁄èöî_add
(
	`GTK_CONTAINER
(
wö
), wö->
nŸebook
);

147 
	`gtk_wödow_£t_tôÀ
(
	`GTK_WINDOW
(
wö
), "LWQQ");

148 
	}
}

150 
	$qq_maöwödow˛ass_öô
(
QQMaöWödowCœss
 *
wc
)

152 
	}
}

154 
	$qq_maöwödow_show_logö∑√l
(
GtkWidgë
 *
wö
)

156 i‡(!
	`QQ_IS_MAINWINDOW
(
wö
)) {

157 
	`g_w¨nög
("NŸá maöwödow!!(%s, %d)", 
__FILE__
, 
__LINE__
);

160 
	`gtk_nŸebook_£t_cuºít_∑ge
(

161 
	`GTK_NOTEBOOK
(
	`QQ_MAINWINDOW
(
wö
)->
nŸebook
), 0);

162 
	}
}

164 
	$qq_maöwödow_show_•œsh∑√l
(
GtkWidgë
 *
wö
)

166 i‡(!
	`QQ_IS_MAINWINDOW
(
wö
)) {

167 
	`g_w¨nög
("NŸá maöwödow!!(%s, %d)", 
__FILE__
, 
__LINE__
);

170 
	`gtk_nŸebook_£t_cuºít_∑ge
(

171 
	`GTK_NOTEBOOK
(
	`QQ_MAINWINDOW
(
wö
)->
nŸebook
), 1);

172 
	}
}

173 
	$qq_maöwödow_show_maö∑√l
(
GtkWidgë
 *
wö
)

175 i‡(!
	`QQ_IS_MAINWINDOW
(
wö
)) {

176 
	`g_w¨nög
("NŸá maöwödow!!(%s, %d)", 
__FILE__
, 
__LINE__
);

179 
	`gtk_nŸebook_£t_cuºít_∑ge
(

180 
	`GTK_NOTEBOOK
(
	`QQ_MAINWINDOW
(
wö
)->
nŸebook
), 2);

181 
	}
}

	@src/gui/mainwindow.h

13 #i‚de‡
LWQQ_MAINWINDOW_H


14 
	#LWQQ_MAINWINDOW_H


	)

16 
	~<gtk/gtk.h
>

18 
	#QQ_MAINWINDOW
(
obj
) \

19 
	`G_TYPE_CHECK_INSTANCE_CAST
(
obj
, 
	`qq_maöwödow_gë_ty≥
(), 
QQMaöWödow
)

	)

20 
	#QQ_MAINWINDOWCLASS
(
c
) \

21 
	`G_TYPE_CHECK_CLASS_CAST
(
c
, 
	`qq_maöwödow_gë_ty≥
(), 
QQMaöWödowCœss
)

	)

22 
	#QQ_IS_MAINWINDOW
(
obj
Ë
	`G_TYPE_CHECK_INSTANCE_TYPE
(obj, 
	`qq_maöwödow_gë_ty≥
())

	)

24 
	s__QQMaöWödow
 {

25 
GtkWödow
 
	m∑ª¡
;

27 
GtkWidgë
 *
	mnŸebook
;

29 
GtkWidgë
 *
	mlogö_∑√l
;

30 
GtkWidgë
 *
	mmaö_∑√l
;

31 
GtkWidgë
 *
	m•œsh_∑√l
;

33 
gboﬁón
 
	mshowed
;

34 } 
	tQQMaöWödow
;

36 
	s__QQMaöWödowCœss
 {

37 
GtkWödowCœss
 
	m∑ª¡
;

38 } 
	tQQMaöWödowCœss
;

46 
GtkWidgë
 *
qq_maöwödow_√w
();

48 
GTy≥
 
qq_maöwödow_gë_ty≥
();

55 
qq_maöwödow_show
(
GtkWidgë
 *
wö
);

62 
qq_maöwödow_show
(
GtkWidgë
 *
wö
);

69 
qq_maöwödow_hide
(
GtkWidgë
 *
wö
);

76 
qq_maöwödow_show_hide
(
GtkWidgë
 *
wö
);

83 
qq_maöwödow_show_hide
(
GtkWidgë
 *
wö
);

88 
qq_maöwödow_show_logö∑√l
(
GtkWidgë
 *
wö
);

89 
qq_maöwödow_show_•œsh∑√l
(
GtkWidgë
 *
wö
);

90 
qq_maöwödow_show_maö∑√l
(
GtkWidgë
 *
wö
);

	@src/gui/msgloop.c

11 
	~<msglo›.h
>

12 
	~"loggî.h
"

15 (*
	tInvokî
)(
	tgpoöãr
 
	tmëhod
, gpoöã∏*
	t∑rs
);

26 
Invokî
 
övokî
;

27 
gpoöãr
 
mëhod
;

29 
gpoöãr
 
∑rs
[10];

30 } 
	tGQQClosuª
;

32 
gpoöãr
 
	$thªad_maö
(
gpoöãr
 
d©a
)

34 
GQQMesßgeLo›
 *
ml
(GQQMesßgeLo› *)
d©a
;

35 
«me
[256];

37 
ml
->
˘x
 = 
	`g_maö_c⁄ãxt_√w
();

38 i‡(
ml
->
˘x
 =
NULL
) {

39 
	`lwqq_log
(
LOG_ERROR
, "Cª©êc⁄ãxàf‹ %†lo› faûed\n", 
ml
->
«me
);

40  
NULL
;

43 
GMaöLo›
 *
lo›
 = 
	`g_maö_lo›_√w
(
ml
->
˘x
, 
TRUE
);

44 i‡(
lo›
 =
NULL
) {

45 
	`lwqq_log
(
LOG_ERROR
, "Cª©ê%†maöÜo› faûed\n", 
ml
->
«me
);

46  
NULL
;

48 
ml
->
lo›
 =Üoop;

50 
	`lwqq_log
(
LOG_DEBUG
, "Sèπ %†maöÜo› ......\n", 
ml
->
«me
);

51 
	`g_¢¥ötf
(
«me
, “ame), "%s", 
ml
->name);

52 
	`g_maö_lo›_run
(
ml
->
lo›
);

54 
	`lwqq_log
(
LOG_DEBUG
, "%†maöÜo› quô\n", 
«me
);

55  
NULL
;

56 
	}
}

58 
GQQMesßgeLo›
* 
	$gqq_msglo›_°¨t
(c⁄° 
gch¨
 *
«me
)

60 i‡(
«me
 =
NULL
) {

61 
«me
 = "";

64 
GQQMesßgeLo›
 *
ml
 = 
	`g_¶i˚_√w0
(GQQMessageLoop);

65 
ml
->
«me
 = 
	`g_°rdup
(name);

67 
GEº‹
 *
îr
 = 
NULL
;

68 i‡(
	`g_thªad_¸óã
(
thªad_maö
, 
ml
, 
FALSE
, &
îr
Ë=
NULL
) {

69 
	`lwqq_log
(
LOG_WARNING
, "Cª©êmaöÜo›Åhªad faûed\n", 
îr
->
mesßge
);

70 
	`g_îr‹_‰ì
(
îr
);

71 
	`g_‰ì
(
ml
->
«me
);

72 
	`g_¶i˚_‰ì
(
GQQMesßgeLo›
, 
ml
);

73  
NULL
;

75  
ml
;

76 
	}
}

77 
	$gqq_msglo›_°›
(
GQQMesßgeLo›
 *
lo›
)

79 i‡(
lo›
 =
NULL
) {

82 
	`g_maö_c⁄ãxt_uƒef
(
lo›
->
˘x
);

83 
	`g_maö_lo›_quô
(
lo›
->loop);

84 
	`g_‰ì
(
lo›
->
«me
);

85 
	`g_¶i˚_‰ì
(
GQQMesßgeLo›
, 
lo›
);

87 
	}
}

89 
	$gqq_mëhod_övokî_1
(
gpoöãr
 
mëhod
, gpoöã∏*
∑rs
)

91 (*
	tMëhodTy≥1
)(
	tgpoöãr
);

92 
MëhodTy≥1
 
m
 = (MëhodTy≥1)
mëhod
;

93 
	`m
(
∑rs
[0]);

94 
	}
}

95 
	$gqq_mëhod_övokî_2
(
gpoöãr
 
mëhod
, gpoöã∏*
∑rs
)

97 (*
	tMëhodTy≥1
)(
	tgpoöãr
, gpointer);

98 
MëhodTy≥1
 
m
 = (MëhodTy≥1)
mëhod
;

99 
	`m
(
∑rs
[0],Öars[1]);

100 
	}
}

101 
	$gqq_mëhod_övokî_3
(
gpoöãr
 
mëhod
, gpoöã∏*
∑rs
)

103 (*
	tMëhodTy≥1
)(
	tgpoöãr
, gpointer, gpointer);

104 
MëhodTy≥1
 
m
 = (MëhodTy≥1)
mëhod
;

105 
	`m
(
∑rs
[0],Öars[1],Öars[2]);

106 
	}
}

107 
	$gqq_mëhod_övokî_4
(
gpoöãr
 
mëhod
, gpoöã∏*
∑rs
)

109 (*
	tMëhodTy≥1
)(
	tgpoöãr
, gpointer, gpointer, gpointer);

110 
MëhodTy≥1
 
m
 = (MëhodTy≥1)
mëhod
;

111 
	`m
(
∑rs
[0],Öars[1],Öars[2],Öars[3]);

112 
	}
}

113 
	$gqq_mëhod_övokî_5
(
gpoöãr
 
mëhod
, gpoöã∏*
∑rs
)

115 (*
	tMëhodTy≥1
)(
	tgpoöãr
, gpointer, gpointer,

116 
	tgpoöãr
, gpointer);

117 
MëhodTy≥1
 
m
 = (MëhodTy≥1)
mëhod
;

118 
	`m
(
∑rs
[0],Öars[1],Öars[2],Öars[3],Öars[4]);

119 
	}
}

122 
Invokî
 
	gövokîs
[] = {

123 
NULL
,

124 
gqq_mëhod_övokî_1
,

125 
gqq_mëhod_övokî_2
,

126 
gqq_mëhod_övokî_3
,

127 
gqq_mëhod_övokî_4
,

128 
gqq_mëhod_övokî_5
,

129 
NULL


139 
gboﬁón
 
	$gqq_˘x_ˇŒback
(
gpoöãr
 
d©a
)

141 
GQQClosuª
 *
c
 = (GQQClosuª*)
d©a
;

143 
c
->
	`övokî
(c->
mëhod
, c->
∑rs
);

145 
	`g_¶i˚_‰ì
(
GQQClosuª
, 
c
);

146  
FALSE
;

147 
	}
}

149 
göt
 
	$gqq_maölo›_©èch
(
GQQMesßgeLo›
 *
lo›
, 
gpoöãr
 
mëhod
, 
göt
 
∑r_num
, ...)

151 
va_li°
 
∑r
;

152 
	`va_°¨t
(
∑r
, 
∑r_num
);

153 
GQQClosuª
 *
c
 = 
	`g_¶i˚_√w0
(GQQClosure);

154 
c
->
mëhod
 = method;

155 
c
->
övokî
 = 
övokîs
[
∑r_num
];

156 
gpoöãr
 
p
;

157 
göt
 
i
;

158 
i
 = 0; i < 
∑r_num
; ++i){

159 
p
 = 
	`va_¨g
(
∑r
, 
gpoöãr
);

160 
c
->
∑rs
[
i
] = 
p
;

162 
	`va_íd
(
∑r
);

164 
GSour˚
 *
§c
 = 
	`g_idÀ_sour˚_√w
();

165 
	`g_sour˚_£t_ˇŒback
(
§c
, 
gqq_˘x_ˇŒback
, 
c
, 
NULL
);

166 
	`g_sour˚_©èch
(
§c
, 
lo›
->
˘x
);

167 
	`g_sour˚_uƒef
(
§c
);

169 
	}
}

	@src/gui/msgloop.h

12 #i‚de‡
__GQQ_MSGLOOP_H_


13 
	#__GQQ_MSGLOOP_H_


	)

15 
	~<glib.h
>

16 
	~<°d¨g.h
>

21 
	s__GQQMesßgeLo›
 {

22 
GMaöLo›
 *
	mlo›
;

23 
GMaöC⁄ãxt
 *
	m˘x
;

24 
gch¨
 *
	m«me
;

25 } 
	tGQQMesßgeLo›
;

35 
GQQMesßgeLo›
* 
gqq_msglo›_°¨t
(c⁄° 
gch¨
 *
«me
);

37 
gqq_msglo›_°›
(
GQQMesßgeLo›
 *
lo›
);

50 
göt
 
gqq_maölo›_©èch
(
GQQMesßgeLo›
* 
lo›
, 
gpoöãr
 
mëhod
, göà
∑r_num
, ...);

	@src/gui/splashpanel.c

1 
	~<•œsh∑√l.h
>

2 
	~"ty≥.h
"

4 #ifde‡
HAVE_CONFIG_H


5 
	~<c⁄fig.h
>

8 
LwqqClõ¡
 *
lwqq_˛õ¡
;

9 *
lwqq_ö°Æl_dú
;

10 *
lwqq_ic⁄s_dú
;

11 *
lwqq_buddy_°©us_dú
;

12 
GtkWidgë
 *
maö_wö
;

14 
qq_•œsh∑√l˛ass_öô
(
QQS∂ashP™ñCœss
 *
c
);

15 
qq_•œsh∑√l_öô
(
QQS∂ashP™ñ
 *
obj
);

16 
qq_•œsh∑√l_de°roy
(
GtkWidgë
 *
obj
);

18 
GtkWidgë
 *
	$qq_•œsh∑√l_√w
()

20 
QQS∂ashP™ñ
 *
∑√l
 = 
	`g_obje˘_√w
(
	`qq_•œsh∑√l_gë_ty≥
(), 
NULL
);

21  
	`GTK_WIDGET
(
∑√l
);

22 
	}
}

24 
GTy≥
 
	$qq_•œsh∑√l_gë_ty≥
()

26 
GTy≥
 
t
 = 0;

27 if(!
t
){

28 c⁄° 
GTy≥Info
 
öfo
 =

30 (
QQS∂ashP™ñCœss
),

31 
NULL
,

32 
NULL
,

33 (
GCœssInôFunc
)
qq_•œsh∑√l˛ass_öô
,

34 
NULL
,

35 
NULL
,

36 (
QQS∂ashP™ñ
),

38 (
GIn°™˚InôFunc
)
qq_•œsh∑√l_öô
,

39 
NULL


41 
t
 = 
	`g_ty≥_ªgi°î_°©ic
(
GTK_TYPE_VBOX
, "QQSplashPanel"

42 , &
öfo
, 0);

44  
t
;

46 
	}
}

48 
	$qq_•œsh∑√l˛ass_öô
(
QQS∂ashP™ñCœss
 *
c
)

50 
GtkWidgëCœss
 *
˛
 = 
	`GTK_WIDGET_CLASS
(
c
);

51 
˛
 -> 
de°roy
 = 
qq_•œsh∑√l_de°roy
;

52 
	}
}

57 
gboﬁón
 
	$¥ogªss_b¨_timeout_func
(
gpoöãr
 
d©a
)

59 
	`gtk_¥ogªss_b¨_pul£
(
	`GTK_PROGRESS_BAR
(
d©a
));

60  
TRUE
;

61 
	}
}

63 
	$qq_•œsh∑√l_öô
(
QQS∂ashP™ñ
 *
obj
)

65 
gch¨
 
img
[256];

66 
	`g_¢¥ötf
(
img
, (img), "%s/webqq_ic⁄.≤g", 
lwqq_ic⁄s_dú
);

67 
GtkWidgë
 *
logo
 = 
	`gtk_image_√w_‰om_fûe
(
img
);

68 
	`gtk_widgë_£t_size_ªque°
(
logo
, -1, 250);

69 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
obj
), 
logo
, 
FALSE
, FALSE, 0);

71 
GtkWidgë
 *
¥ob¨
 = 
	`gtk_¥ogªss_b¨_√w
();

72 
	`gtk_widgë_£t_size_ªque°
(
¥ob¨
, 200, 50);

73 
	`gtk_¥ogªss_b¨_£t_ãxt
(
	`GTK_PROGRESS_BAR
(
¥ob¨
), "Login...");

74 #ifde‡
USE_GTK3


75 
	`gtk_¥ogªss_b¨_£t_show_ãxt
(
	`GTK_PROGRESS_BAR
(
¥ob¨
), 
TRUE
);

78 
	`g_timeout_add
(100, 
¥ogªss_b¨_timeout_func
, 
¥ob¨
);

80 
GtkWidgë
 *
box
 = 
NULL
;

81 
box
 = 
	`gtk_box_√w
(
GTK_ORIENTATION_HORIZONTAL
, 0);

82 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
box
), 
¥ob¨
, 
TRUE
, 
FALSE
, 0);

83 
	`gtk_box_∑ck_°¨t
(
	`GTK_BOX
(
obj
), 
box
, 
FALSE
, FALSE, 50);

84 
	}
}

85 
	$qq_•œsh∑√l_de°roy
(
GtkWidgë
 *
obj
)

88 
	}
}

	@src/gui/splashpanel.h

1 #i‚de‡
__GTKQQ_SPLASHPANEL_H


2 
	#__GTKQQ_SPLASHPANEL_H


	)

3 
	~<gtk/gtk.h
>

5 
	#QQ_SPLASHPANEL
(
obj
Ë
	`G_TYPE_CHECK_INSTANCE_CAST
(obj, 
	`qq_•œsh∑√l_gë_ty≥
(),\

6 
QQS∂ashP™ñ
)

	)

7 
	#QQ_SPLASHPANEL_CLASS
(
c
Ë
	`G_TYPE_CHECK_CLASS_CAST
(c,\

8 
	`qq_•œsh∑√l_gë_ty≥
(),\

9 
QQS∂ashP™ñCœss
)

	)

10 
	#QQ_IS_SPLASHPANEL
(
obj
Ë
	`G_TYPE_CHECK_INSTANCE_TYPE
(obj, 
	`qq_•œshP™ñ_gë_ty≥
())

	)

12 
_QQS∂ashP™ñ
 
	tQQS∂ashP™ñ
;

13 
_QQS∂ashP™ñCœss
 
	tQQS∂ashP™ñCœss
;

15 
	s_QQS∂ashP™ñ
{

16 
GtkVBox
 
	m∑ª¡
;

19 
	s_QQS∂ashP™ñCœss
{

20 
GtkVBoxCœss
 
	m∑ª¡
;

23 
GtkWidgë
 *
qq_•œsh∑√l_√w
();

24 
GTy≥
 
qq_•œsh∑√l_gë_ty≥
();

	@src/gui/statusbutton.c

11 
	~"°©usbuâ⁄.h
"

13 *
lwqq_ö°Æl_dú
;

14 *
lwqq_ic⁄s_dú
;

15 *
lwqq_buddy_°©us_dú
;

17 c⁄° 
gch¨
 *
	g°©us_œbñ
[] = {

18 "⁄löe", "hiddí", "away", "ofÊöe", "ˇŒme", "busy", "sûít", 
NULL
};

20 
QQSètusBuâ⁄Cœss
 *
	gthis_˛ass
 = 
NULL
;

22 
qq_°©usbuâ⁄_öô
(
QQSètusBuâ⁄
 *
bä
);

23 
qq_°©usbuâ⁄˛ass_öô
(
QQSètusBuâ⁄Cœss
 *
c
);

25 
gboﬁón
 
expo£_evít_cb
(
GtkWidgë
 *
widgë
,

26 
GdkEvítExpo£
 *
evít
, 
gpoöãr
 
d©a
);

27 
ch™ge_img_cb
(
GtkComboBox
 *
w
, 
gpoöãr
 
d©a
);

29 
gboﬁón
 
íãr_evít_cb
(
GtkWidgë
 *
w
, 
GdkEvít
 *
evít
, 
gpoöãr
 
d©a
);

30 
gboﬁón
 
Àave_evít_cb
(
GtkWidgë
 *
w
, 
GdkEvít
 *
evít
, 
gpoöãr
 
d©a
);

32 
GTy≥
 
	$qq_°©usbuâ⁄_gë_ty≥
()

34 
GTy≥
 
t
 = 0;

35 i‡(!
t
) {

36 c⁄° 
GTy≥Info
 
öfo
 = {

37 (
QQSètusBuâ⁄Cœss
),

38 
NULL
,

39 
NULL
,

40 (
GCœssInôFunc
)
qq_°©usbuâ⁄˛ass_öô
,

41 
NULL
,

42 
NULL
,

43 (
QQSètusBuâ⁄
),

45 (
GIn°™˚InôFunc
)
qq_°©usbuâ⁄_öô
,

46 
NULL


48 
t
 = 
	`g_ty≥_ªgi°î_°©ic
(
GTK_TYPE_COMBO_BOX
, "QQSètusBuâ⁄", &
öfo
, 0);

50  
t
;

51 
	}
}

56 
GtkTªeModñ
* 
	$¸óã_modñ
()

58 
GtkTªeIãr
 
ôî
;

59 
GtkLi°St‹e
 *
°‹e
;

60 
göt
 
i
;

62 
°‹e
 = 
	`gtk_li°_°‹e_√w
(2, 
GDK_TYPE_PIXBUF
, 
G_TYPE_STRING
);

63 
i
 = 0; i < 
STATUS_NUM
; i++) {

64 
	`gtk_li°_°‹e_≠≥nd
(
°‹e
, &
ôî
);

65 
	`gtk_li°_°‹e_£t
(
°‹e
, &
ôî
, 0, 
this_˛ass
->
pb
[
i
], 1,

66 
°©us_œbñ
[
i
], -1);

68  
	`GTK_TREE_MODEL
(
°‹e
);

69 
	}
}

71 
GtkWidgë
* 
	$qq_°©usbuâ⁄_√w
()

73 
gpoöãr
 
bä
 = 
	`g_obje˘_√w
(
QQ_TYPE_STATUSBUTTON
, 
NULL
);

74  
	`GTK_WIDGET
(
bä
);

75 
	}
}

77 
	$qq_°©usbuâ⁄_öô
(
QQSètusBuâ⁄
 *
bä
)

79 
	`gtk_widgë_£t_size_ªque°
(
	`GTK_WIDGET
(
bä
), 30, 25);

80 
	`gtk_combo_box_£t_modñ
(
	`GTK_COMBO_BOX
(
bä
), 
	`¸óã_modñ
());

81 
GtkCñlRídîî
 *
ªndîî
 = 
	`gtk_˚Œ_ªndîî_pixbuf_√w
();

82 
	`gtk_˚Œ_œyout_∑ck_°¨t
(
	`GTK_CELL_LAYOUT
(
bä
), 
ªndîî
, 
FALSE
);

83 
	`gtk_˚Œ_œyout_£t_©åibuãs
(
	`GTK_CELL_LAYOUT
(
bä
), 
ªndîî
,

84 "pixbuf", 0, 
NULL
);

85 
ªndîî
 = 
	`gtk_˚Œ_ªndîî_ãxt_√w
();

86 
	`gtk_˚Œ_œyout_∑ck_°¨t
(
	`GTK_CELL_LAYOUT
(
bä
), 
ªndîî
, 
FALSE
);

87 
	`gtk_˚Œ_œyout_£t_©åibuãs
(
	`GTK_CELL_LAYOUT
(
bä
), 
ªndîî
,

88 "ãxt", 1, 
NULL
);

90 
GdkEvítMask
 
evít_mask
 = 0;

91 
evít_mask
 = 
	`gtk_widgë_gë_evíts
(
	`GTK_WIDGET
(
bä
));

92 
evít_mask
 |
GDK_POINTER_MOTION_MASK
;

93 
evít_mask
 |
GDK_ENTER_NOTIFY_MASK
;

94 
evít_mask
 |
GDK_LEAVE_NOTIFY_MASK
;

95 
	`gtk_widgë_£t_evíts
(
	`GTK_WIDGET
(
bä
), 
evít_mask
);

96 
	`g_sig«l_c⁄√˘
(
	`GTK_WIDGET
(
bä
), "draw",

97 
	`G_CALLBACK
(
expo£_evít_cb
), 
NULL
);

98 
	`g_sig«l_c⁄√˘
(
	`GTK_WIDGET
(
bä
), "changed",

99 
	`G_CALLBACK
(
ch™ge_img_cb
), 
NULL
);

100 
	`g_sig«l_c⁄√˘
(
	`GTK_WIDGET
(
bä
), "enter-notify-event",

101 
	`G_CALLBACK
(
íãr_evít_cb
), 
NULL
);

102 
	`g_sig«l_c⁄√˘
(
	`GTK_WIDGET
(
bä
), "leave-notify-event",

103 
	`G_CALLBACK
(
Àave_evít_cb
), 
NULL
);

105 
bä
->
°©us
 = 
STATUS_ONLINE
;

106 
	`gtk_combo_box_£t_a˘ive
(
	`GTK_COMBO_BOX
(
bä
), 
STATUS_ONLINE
);

107 
	}
}

109 
	$qq_°©usbuâ⁄˛ass_öô
(
QQSètusBuâ⁄Cœss
 *
c
)

111 
img
[512];

113 
	#QQ_STATUSBUTTON_INIT_MACRO
(
°©us
, 
«me
, 
w
, 
h
, 
b
) { \

114 
	`g_¢¥ötf
(
img
, (img), "%s/%s", 
lwqq_buddy_°©us_dú
, 
«me
); \

115 
c
->
pb
[
°©us
] = 
	`gdk_pixbuf_√w_‰om_fûe_©_sˇÀ
(
img
, 
w
, 
h
, 
b
, 
NULL
); \

116 }

	)

118 
	`QQ_STATUSBUTTON_INIT_MACRO
(
STATUS_ONLINE
, "⁄löe.≤g", 12, 12, 
TRUE
);

119 
	`QQ_STATUSBUTTON_INIT_MACRO
(
STATUS_HIDDEN
, "hiddí.≤g", 12, 12, 
TRUE
);

120 
	`QQ_STATUSBUTTON_INIT_MACRO
(
STATUS_OFFLINE
, "ofÊöe.≤g", 12, 12, 
TRUE
);

121 
	`QQ_STATUSBUTTON_INIT_MACRO
(
STATUS_AWAY
, "away.≤g", 12, 12, 
TRUE
);

122 
	`QQ_STATUSBUTTON_INIT_MACRO
(
STATUS_CALLME
, "ˇŒme.≤g", 12, 12, 
TRUE
);

123 
	`QQ_STATUSBUTTON_INIT_MACRO
(
STATUS_BUSY
, "busy.≤g", 12, 12, 
TRUE
);

124 
	`QQ_STATUSBUTTON_INIT_MACRO
(
STATUS_SILENT
, "sûít.≤g", 12, 12, 
TRUE
);

126 
	`g_¢¥ötf
(
img
, (img), "%s/dow«ºow.≤g", 
lwqq_buddy_°©us_dú
);

127 
c
->
¨row
 = 
	`gdk_pixbuf_√w_‰om_fûe_©_sˇÀ
(
img
, 10, 7, 
TRUE
, 
NULL
);

128 #unde‡
QQ_STATUSBUTTON_INIT_MACRO


129 
c
->
h™d_curs‹
 = 
	`gdk_curs‹_√w
(
GDK_HAND1
);

130 
this_˛ass
 = 
c
;

131 
	}
}

136 
gboﬁón
 
	$expo£_evít_cb
(
GtkWidgë
 *
widgë


137 , 
GdkEvítExpo£
 *
evít
, 
gpoöãr
 
d©a
)

139 
ˇúo_t
 *
˘
 = 
	`gdk_ˇúo_¸óã
(
	`gtk_widgë_gë_wödow
(
widgë
));

140 
GdkPixbuf
 *
pb
 = 
this_˛ass
->pb[
	`QQ_STATUSBUTTON
(
widgë
)->
°©us
];

141 
göt
 
pbw
, 
pbh
, 
¨roww
, 
¨rowh
, 
g≠
 = 5;

142 
pbw
 = 
	`gdk_pixbuf_gë_width
(
pb
);

143 
pbh
 = 
	`gdk_pixbuf_gë_height
(
pb
);

144 
¨roww
 = 
	`gdk_pixbuf_gë_width
(
this_˛ass
->
¨row
);

145 
¨rowh
 = 
	`gdk_pixbuf_gë_height
(
this_˛ass
->
¨row
);

146 
GtkAŒoˇti⁄
 
Æloc
;

147 
	`gtk_widgë_gë_Æloˇti⁄
(
widgë
, &
Æloc
);

149 
göt
 
Æignx
, 
Æigny
;

150 
Æignx
 = (
Æloc
.
width
 - 
pbw
 - 
¨roww
 - 
g≠
) / 2;

151 
Æigny
 = (
Æloc
.
height
 - 
pbh
) / 2;

154 
Æignx
 = (alignx > 0 ?álignx : 0);

155 
Æigny
 = (aligny > 0 ?áligny : 0);

157 
	`gdk_ˇúo_£t_sour˚_pixbuf
(
˘
, 
pb
, 
Æloc
.
x
 + 
Æignx
,áŒoc.
y
 + 
Æigny
);

158 
	`ˇúo_∑öt
(
˘
);

161 
Æigny
 = (
Æloc
.
height
 - 
¨rowh
) / 2;

162 
Æigny
 = (aligny > 0 ?áligny : 0);

163 
	`gdk_ˇúo_£t_sour˚_pixbuf
(
˘
, 
this_˛ass
->
¨row
,

164 
Æloc
.
x
 + 
Æignx
 + 
pbw
 + 
g≠
,áŒoc.
y
 + 
Æigny
);

165 
	`ˇúo_∑öt
(
˘
);

166 
	`ˇúo_de°roy
(
˘
);

172  
TRUE
;

173 
	}
}

175 c⁄° 
gch¨
* 
	$qq_°©usbuâ⁄_gë_°©us_°rög
(
GtkWidgë
 *
bä
)

177 i‡(
bä
 =
NULL
) {

178  
NULL
;

181 
göt
 
idx
 = 
	`gtk_combo_box_gë_a˘ive
(
	`GTK_COMBO_BOX
(
bä
));

182  
°©us_œbñ
[
idx
];

183 
	}
}

185 
QQSètusBuâ⁄Sètus
 
	$qq_°©usbuâ⁄_gë_°©us
(
GtkWidgë
 *
bä
)

187 i‡(
bä
 =
NULL
) {

188  
STATUS_NUM
;

191 
göt
 
idx
 = 
	`gtk_combo_box_gë_a˘ive
(
	`GTK_COMBO_BOX
(
bä
));

192  
idx
;

193 
	}
}

195 
	$qq_°©usbuâ⁄_£t_°©us_°rög
(
GtkWidgë
 *
bä


196 , c⁄° 
gch¨
 *
°©us
)

198 i‡(
bä
 =
NULL
 || 
°©us
 == NULL) {

201 
göt
 
i
;

202 
i
 = 0; i < 
STATUS_NUM
; ++i) {

203 i‡(
	`g_°rcmp0
(
°©us_œbñ
[
i
], 
°©us
) == 0) {

207 i‡(
i
 < 
STATUS_NUM
) {

208 
	`gtk_combo_box_£t_a˘ive
(
	`GTK_COMBO_BOX
(
bä
), 
i
);

210 
	}
}

212 
	$qq_°©usbuâ⁄_£t_°©us
(
GtkWidgë
 *
bä


213 , 
QQSètusBuâ⁄Sètus
 
°©us
)

215 i‡(
bä
 =
NULL
 || 
°©us
 >
STATUS_NUM
|| status < 0) {

219 
	`gtk_combo_box_£t_a˘ive
(
	`GTK_COMBO_BOX
(
bä
), 
°©us
);

220 
	}
}

225 
	$ch™ge_img_cb
(
GtkComboBox
 *
w
, 
gpoöãr
 
d©a
)

227 
QQSètusBuâ⁄
 *
bä
 = 
	`QQ_STATUSBUTTON
(
w
);

228 
bä
->
°©us
 = 
	`gtk_combo_box_gë_a˘ive
(
w
);

232 i‡(
	`gtk_widgë_gë_wödow
(
	`GTK_WIDGET
(
w
)Ë=
NULL
) {

236 
	`expo£_evít_cb
(
	`GTK_WIDGET
(
w
), 
NULL
, NULL);

237 
	}
}

239 
gboﬁón
 
	$íãr_evít_cb
(
GtkWidgë
 *
w
, 
GdkEvít
 *
evít
, 
gpoöãr
 
d©a
)

241 
GdkWödow
 *
wö
 = 
	`gtk_widgë_gë_wödow
(
w
);

242 
	`g_debug
("enter status button.");

243 i‡(
wö
 !
NULL
) {

245 
	`gdk_wödow_£t_curs‹
(
wö
, 
this_˛ass
->
h™d_curs‹
);

247  
FALSE
;

248 
	}
}

249 
gboﬁón
 
	$Àave_evít_cb
(
GtkWidgë
 *
w
, 
GdkEvít
 *
evít
, 
gpoöãr
 
d©a
)

251 
GdkWödow
 *
wö
 = 
	`gtk_widgë_gë_wödow
(
w
);

252 
	`g_debug
("leave status button.");

253 i‡(
wö
 !
NULL
) {

255 
	`gdk_wödow_£t_curs‹
(
wö
, 
NULL
);

257  
FALSE
;

258 
	}
}

	@src/gui/statusbutton.h

11 #i‚de‡
__LWQQ_STATUS_BUTTON


12 
	#__LWQQ_STATUS_BUTTON


	)

14 
	~<gtk/gtk.h
>

20 
	#QQ_STATUSBUTTON
(
obj
) \

21 
	`G_TYPE_CHECK_INSTANCE_CAST
(
obj
, 
	`qq_°©usbuâ⁄_gë_ty≥
(), 
QQSètusBuâ⁄
)

	)

22 
	#QQ_STATUSBUTTONCLASS
(
c
) \

23 
	`G_TYPE_CHECK_CLASS_CAST
(
c
, 
	`qq_°©usbuâ⁄_gë_ty≥
(), 
QQSètusBuâ⁄Cœss
)

	)

24 
	#QQ_IS_STATUSBUTTON
(
obj
) \

25 
	`G_TYPE_CHECK_INSTANCE_TYPE
(
obj
, 
	`qq_°©usbuâ⁄_gë_ty≥
())

	)

26 
	#QQ_TYPE_STATUSBUTTON
 
	`qq_°©usbuâ⁄_gë_ty≥
()

	)

28 
_QQSètusBuâ⁄
 
	tQQSètusBuâ⁄
;

29 
_QQSètusBuâ⁄Cœss
 
	tQQSètusBuâ⁄Cœss
;

31 
_QQSètusBuâ⁄Sètus
 
	tQQSètusBuâ⁄Sètus
;

33 
	e_QQSètusBuâ⁄Sètus
 {

34 
	mSTATUS_ONLINE
 = 0,

35 
	mSTATUS_HIDDEN
,

36 
	mSTATUS_AWAY
,

37 
	mSTATUS_OFFLINE
,

38 
	mSTATUS_CALLME
,

39 
	mSTATUS_BUSY
,

40 
	mSTATUS_SILENT
,

41 
	mSTATUS_NUM


44 
	s_QQSètusBuâ⁄
 {

45 
GtkComboBox
 
	m∑ª¡
;

46 
QQSètusBuâ⁄Sètus
 
	m°©us
;

49 
GtkWidgë
 *
	mp›míu
;

52 
	s_QQSètusBuâ⁄Cœss
 {

53 
GtkComboBoxCœss
 
	m∑ª¡
;

56 
GdkPixbuf
 *
	mpb
[
STATUS_NUM
];

57 
GdkPixbuf
 *
	m¨row
;

58 
GdkCurs‹
 *
	mh™d_curs‹
;

61 
GTy≥
 
qq_°©usbuâ⁄_gë_ty≥
();

62 
GtkWidgë
* 
qq_°©usbuâ⁄_√w
();

68 c⁄° 
gch¨
* 
qq_°©usbuâ⁄_gë_°©us_°rög
(
GtkWidgë
 *
bä
);

69 
QQSètusBuâ⁄Sètus
 
qq_°©usbuâ⁄_gë_°©us
(
GtkWidgë
 *
bä
);

74 
qq_°©usbuâ⁄_£t_°©us_°rög
(
GtkWidgë
 *
bä
, c⁄° 
gch¨
 *
°©us
);

75 
qq_°©usbuâ⁄_£t_°©us
(
GtkWidgë
 *
bä
, 
QQSètusBuâ⁄Sètus
 
°©us
);

	@src/gui/tray.c

1 
	~<c⁄fig.h
>

2 
	~<glib/gi18n.h
>

3 
	~"åay.h
"

4 
	~"maöwödow.h
"

5 
	~"ty≥.h
"

10 
LwqqClõ¡
 *
lwqq_˛õ¡
;

11 *
lwqq_ö°Æl_dú
;

12 *
lwqq_ic⁄s_dú
;

13 *
lwqq_buddy_°©us_dú
;

14 *
lwqq_u£r_dú
;

15 
GtkWidgë
 *
maö_wö
;

16 
GHashTabÀ
 *
lwqq_ch©_wödow
;

22 
GQueue
 *
	mblökög_queue
;

23 
GQueue
 *
	mtmp_queue
;

25 
GtkWidgë
 *
	mp›upmíu
;

26 
GtkWidgë
 *
	mmuã_ôem
;

27 } 
	tQQTøyPriv
;

29 
qq_åay_öô
(
QQTøy
 *
åay
);

30 
qq_åay˛ass_öô
(
QQTøyCœss
 *
tc
, 
gpoöãr
 
d©a
);

32 
GTy≥
 
	$qq_åay_gë_ty≥
()

34 
GTy≥
 
t
 = 0;

35 i‡(!
t
) {

36 c⁄° 
GTy≥Info
 
öfo
 = {

37 (
QQTøyCœss
),

38 
NULL
,

39 
NULL
,

40 (
GCœssInôFunc
)
qq_åay˛ass_öô
,

41 
NULL
,

42 
NULL
,

43 (
QQTøy
),

45 (
GIn°™˚InôFunc
)
qq_åay_öô
,

49 
t
 = 
	`g_ty≥_ªgi°î_°©ic
(
GTK_TYPE_STATUS_ICON
, "QQTøy", &
öfo
, 0);

51  
t
;

52 
	}
}

54 
QQTøy
 *
	$qq_åay_√w
()

56 
gch¨
 
img
[256];

57 
	`g_¢¥ötf
(
img
, (img), "%s/webqq_ic⁄.≤g", 
lwqq_ic⁄s_dú
);

58  
	`QQ_TRAY
(
	`g_obje˘_√w
(
	`qq_åay_gë_ty≥
(), "fûe", 
img
 , 
NULL
));

59 
	}
}

67 
	$qq_åay_blökög
(
QQTøy
 *
åay
, c⁄° 
gch¨
 *
uö
)

69 
gch¨
 
buf
[500];

70 
GdkPixbuf
 *
pb
;

71 
LwqqBuddy
 *
bdy
 = 
	`lwqq_buddy_föd_buddy_by_uö
(
lwqq_˛õ¡
, 
uö
);

74 i‡(
bdy
) {

75 
	`g_¢¥ötf
(
buf
, (buf), "%s/%s", 
lwqq_u£r_dú
, 
bdy
->
qqnumbî
 ?: "");

77 
	`g_¢¥ötf
(
buf
, (buf), "%s/webqq_ic⁄.≤g", 
lwqq_ic⁄s_dú
);

79 
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe
(
buf
, 
NULL
);

80 i‡(!
pb
) {

81 
	`g_¢¥ötf
(
buf
, (buf), "%s/webqq_ic⁄.≤g", 
lwqq_ic⁄s_dú
);

82 
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe
(
buf
, 
NULL
);

84 
	`gtk_°©us_ic⁄_£t_‰om_pixbuf
(
	`GTK_STATUS_ICON
(
åay
), 
pb
);

85 
	`g_obje˘_uƒef
(
pb
);

86 
	}
}

92 
	$qq_åay_p›up_míu
(
GtkSètusIc⁄
 *
åay
, 
guöt
 
buâ⁄
,

93 
guöt
 
a˘ive_time
, 
gpoöãr
 
d©a
)

95 
QQTøyPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(
åay
, 
	`qq_åay_gë_ty≥
(),

96 
QQTøyPriv
);

97 
	`gtk_míu_p›up
(
	`GTK_MENU
(
¥iv
->
p›upmíu
), 
NULL
, NULL,

98 
gtk_°©us_ic⁄_posôi⁄_míu
, 
åay
, 
buâ⁄
, 
a˘ive_time
);

99 
	}
}

101 
gboﬁón
 
	$qq_åay_buâ⁄_¥ess
(
GtkSètusIc⁄
 *
åay
, 
GdkEvít
 *
evít
,

102 
gpoöãr
 
d©a
)

104 
GdkEvítBuâ⁄
 *
buâ⁄evít
 = (GdkEvítBuâ⁄ *)
evít
;

107 i‡(
buâ⁄evít
->
buâ⁄
 !1 || buâ⁄evít->
ty≥
 !
GDK_BUTTON_PRESS
) {

108  
FALSE
;

111 
QQTøyPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(
åay
, 
	`qq_åay_gë_ty≥
(),

112 
QQTøyPriv
);

113 
gch¨
 *
uö
 = 
	`g_queue_p›_èû
(
¥iv
->
blökög_queue
);

114 i‡(!
uö
) {

117 
	`qq_maöwödow_show_hide
(
maö_wö
);

119  
FALSE
;

121 
GtkWidgë
 *
cw
 = 
	`g_hash_èbÀ_lookup
(
lwqq_ch©_wödow
, 
uö
);

122 if(
cw
 !
NULL
){

123 
	`gtk_widgë_show
(
cw
);

125 
	`g_‰ì
(
uö
);

127 i‡(
	`g_queue_is_em±y
(
¥iv
 -> 
blökög_queue
)) {

135 
gch¨
 
img
[256];

136 
	`g_¢¥ötf
(
img
, (img), "%s/webqq_ic⁄.≤g", 
lwqq_ic⁄s_dú
);

137 
GdkPixbuf
 *
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe
(
img
, 
NULL
);

138 
	`gtk_°©us_ic⁄_£t_‰om_pixbuf
(
	`GTK_STATUS_ICON
(
åay
), 
pb
);

139 
	`g_obje˘_uƒef
(
pb
);

140  
FALSE
;

142 
	`qq_åay_blökög
(
	`QQ_TRAY
(
åay
), 
	`g_queue_≥ek_èû
(
¥iv
->
blökög_queue
));

143  
FALSE
;

144 
	}
}

149 
gboﬁón
 
	$qq_åay_⁄_show_toﬁtù
(
GtkWidgë
* 
widgë
, 
x
, 
y
,

150 
gboﬁón
 
keyb‹d_mode
, 
GtkToﬁtù
* 
tù
,

151 
gpoöãr
 
d©a
)

153 
GdkPixbuf
 *
pb
;

154 
gch¨
 
buf
[500];

156 i‡(!
lwqq_˛õ¡
){

158 
	`g_¢¥ötf
(
buf
, 500, "%s/webqq_ic⁄.≤g", 
lwqq_ic⁄s_dú
);

159 
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe_©_size
(
buf
, 35, 35, 
NULL
);

160 
	`gtk_toﬁtù_£t_m¨kup
(
tù
, "<b>GtkQQ</b>");

161 
	`gtk_toﬁtù_£t_ic⁄
(
tù
, 
pb
);

162 
	`g_obje˘_uƒef
(
pb
);

163  
TRUE
;

165 
	`g_¢¥ötf
(
buf
, 500, "%s/%s", 
lwqq_u£r_dú
, 
lwqq_˛õ¡
->
u£∫ame
);

168 i‡(
	`ac˚ss
(
buf
, 
F_OK
)) {

169 
	`g_¢¥ötf
(
buf
, 500, "%s/webqq_ic⁄.≤g", 
lwqq_ic⁄s_dú
);

171 
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe_©_size
(
buf
, 35, 35, 
NULL
);

172 
	`gtk_toﬁtù_£t_ic⁄
(
tù
, 
pb
);

173 
	`g_obje˘_uƒef
(
pb
);

174 
	`g_¢¥ötf
(
buf
, 500, "<b>%s</b><span color='blue'>(%s)</span>", "me",

175 
lwqq_˛õ¡
->
u£∫ame
);

176 
	`gtk_toﬁtù_£t_m¨kup
(
tù
, 
buf
);

177  
TRUE
;

178 
	}
}

184 
	$qq_åay_muã_míu_ôem_a˘iv©e
(
GtkMíuIãm
 *
ôem
, 
gpoöãr
 
d©a
)

186 
göt
 
muã
 = 
	`gtk_check_míu_ôem_gë_a˘ive
(
	`GTK_CHECK_MENU_ITEM
(
ôem
));

188 i‡(
muã
)

189 
	`g_¥öt
("Muã (%s, %d)\n", 
__FILE__
, 
__LINE__
);

191 
	`gqq_c⁄fig_£t_muã
(
cfg
, 
muã
);

192 
	}
}

200 
	$qq_åay_£t_muã_ôem
(
QQTøy
 *
åay
, 
gboﬁón
 
muã
)

202 
QQTøyPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(
åay
,

203 
	`qq_åay_gë_ty≥
(), 
QQTøyPriv
);

204 i‡(!
¥iv
)

206 
	`gtk_check_míu_ôem_£t_a˘ive
(

207 
	`GTK_CHECK_MENU_ITEM
(
¥iv
->
muã_ôem
), 
muã
);

208 
	}
}

212 
	$qq_åay_°©us_míu_ôem_a˘iv©e
(
GtkMíuIãm
 *
ôem
, 
gpoöãr
 
d©a
)

214 c⁄° 
gch¨
 *
°©us
 = 
d©a
;

215 
	`g_debug
("Ch™gê°©u†tÿ%†(%s, %d)", 
°©us
, 
__FILE__
, 
__LINE__
);

216 
	}
}

218 
	$qq_åay_≥rs⁄Æ_£âög_míu_ôem_a˘iv©e
(
GtkMíuIãm
 *
ôem
,

219 
gpoöãr
 
d©a
)

221 
	`g_debug
("TøyÖîs⁄Æ sëtög (%s, %d)", 
__FILE__
, 
__LINE__
);

222 
	}
}

223 
	$qq_åay_sy°em_£âög_míu_ôem_a˘iv©e
(
GtkMíuIãm
 *
ôem
,

224 
gpoöãr
 
d©a
)

226 
	`g_debug
("Tøy sy°em sëtög (%s, %d)", 
__FILE__
, 
__LINE__
);

228 
	}
}

236 
	$qq_åay_about_míu_ôem_a˘iv©e
(
GtkMíuIãm
 *
ôem
, 
gpoöãr
 
d©a
)

238 
gch¨
 *
c›yright
 = "Copyright ¬© 2012Üwqq";

239 
gch¨
 *
commít
 = 
	`_
("A QQ client based on web qqÖrotocol");

240 
gch¨
 *
li˚n˚
 = "GPL v3";

241 
GdkPixbuf
 *
logo
 = 
NULL
;

242 
gch¨
 *
auth‹s
[] = {

244 
NULL


247 
	`g_debug
("Tøyábout(%s, %d)", 
__FILE__
, 
__LINE__
);

250 
gch¨
 
img_fûe
[256];

251 
	`g_¢¥ötf
(
img_fûe
, (img_fûe), "%s/webqq_ic⁄.≤g", 
lwqq_ic⁄s_dú
);

252 
logo
 = 
	`gdk_pixbuf_√w_‰om_fûe
(
img_fûe
, 
NULL
);

254 
GtkWidgë
 *
dülog
 = 
	`gtk_about_dülog_√w
();

256 
	`gtk_about_dülog_£t_¥ogøm_«me
(
	`GTK_ABOUT_DIALOG
(
dülog
), 
PACKAGE_NAME
);

257 
	`gtk_about_dülog_£t_vîsi⁄
(
	`GTK_ABOUT_DIALOG
(
dülog
), 
PACKAGE_VERSION
);

258 
	`gtk_about_dülog_£t_li˚n£
(
	`GTK_ABOUT_DIALOG
(
dülog
), 
li˚n˚
);

259 
	`gtk_about_dülog_£t_c›yright
(
	`GTK_ABOUT_DIALOG
(
dülog
), 
c›yright
);

260 
	`gtk_about_dülog_£t_auth‹s
(
	`GTK_ABOUT_DIALOG
(
dülog
), (c⁄° 
gch¨
 **)
auth‹s
);

261 
	`gtk_about_dülog_£t_commíts
(
	`GTK_ABOUT_DIALOG
(
dülog
), 
commít
);

262 
	`gtk_about_dülog_£t_websôe
(
	`GTK_ABOUT_DIALOG
(
dülog
), 
PACKAGE_URL
);

263 
	`gtk_about_dülog_£t_logo
(
	`GTK_ABOUT_DIALOG
(
dülog
), 
logo
);

265 
	`g_obje˘_uƒef
(
logo
);

266 
	`gtk_dülog_run
(
	`GTK_DIALOG
(
dülog
));

267 
	`gtk_widgë_de°roy
(
dülog
);

268 
	}
}

270 
	$qq_åay_quô_míu_ôem_a˘iv©e
(
GtkMíuIãm
 *
ôem
, 
gpoöãr
 
d©a
)

272 
	`g_debug
("Tøy quô(%s, %d)", 
__FILE__
, 
__LINE__
);

273 
	`gtk_maö_quô
();

274 
	}
}

276 
	$qq_åay_öô
(
QQTøy
 *
åay
)

278 
gch¨
 
img_fûe
[256];

279 
	`gtk_°©us_ic⁄_£t_toﬁtù_m¨kup
(
	`GTK_STATUS_ICON
(
åay
), "<b>GtkQQ</b>");

281 
QQTøyPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(
åay
, 
	`qq_åay_gë_ty≥
(),

282 
QQTøyPriv
);

284 
¥iv
->
blökög_queue
 = 
	`g_queue_√w
();

285 
¥iv
->
tmp_queue
 = 
	`g_queue_√w
();

286 
¥iv
->
p›upmíu
 = 
	`gtk_míu_√w
();

288 
GtkWidgë
 *
míuôem
;

290 
míuôem
 = 
	`gtk_check_míu_ôem_√w_wôh_œbñ
("Mute");

291 
¥iv
->
muã_ôem
 = 
míuôem
;

292 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
míuôem
), "activate"

293 , 
	`G_CALLBACK
(
qq_åay_muã_míu_ôem_a˘iv©e
)

294 , 
NULL
);

295 
	`gtk_míu_shñl_≠≥nd
(
	`GTK_MENU_SHELL
(
¥iv
->
p›upmíu
), 
míuôem
);

298 
míuôem
 = 
	`gtk_£∑øt‹_míu_ôem_√w
();

299 
	`gtk_míu_shñl_≠≥nd
(
	`GTK_MENU_SHELL
(
¥iv
->
p›upmíu
), 
míuôem
);

301 
GtkWidgë
 *
img
;

302 
GdkPixbuf
 *
pb
;

303 
	#STATUS_ITEM
(
x
,
y
) { \

304 
míuôem
 = 
	`gtk_image_míu_ôem_√w
(); \

305 
	`gtk_míu_shñl_≠≥nd
(
	`GTK_MENU_SHELL
(
¥iv
->
p›upmíu
), 
míuôem
); \

306 
	`g_¢¥ötf
(
img_fûe
, (img_fûe), "%s/°©us/%s.≤g", 
lwqq_ic⁄s_dú
, 
x
); \

307 
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe_©_size
(
img_fûe
, 12, 12, 
NULL
); \

308 
img
 = 
	`gtk_image_√w_‰om_pixbuf
(
pb
); \

309 
	`g_obje˘_uƒef
(
pb
); \

310 
	`gtk_image_míu_ôem_£t_image
(
	`GTK_IMAGE_MENU_ITEM
(
míuôem
), 
img
); \

311 
	`gtk_míu_ôem_£t_œbñ
(
	`GTK_MENU_ITEM
(
míuôem
), 
y
); \

312 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
míuôem
), "activate", \

313 
	`G_CALLBACK
(
qq_åay_°©us_míu_ôem_a˘iv©e
), 
x
); \

314 }

	)

316 
	`STATUS_ITEM
("online", "Online");

317 
	`STATUS_ITEM
("hidden", "Hidden");

318 
	`STATUS_ITEM
("away", "Away");

319 
	`STATUS_ITEM
("busy", "Busy");

320 
	`STATUS_ITEM
("callme", "Call Me");

321 
	`STATUS_ITEM
("silent", "Silent");

322 #unde‡
STATUS_ITEM


324 
míuôem
 = 
	`gtk_£∑øt‹_míu_ôem_√w
();

325 
	`gtk_míu_shñl_≠≥nd
(
	`GTK_MENU_SHELL
(
¥iv
->
p›upmíu
), 
míuôem
);

327 
míuôem
 = 
	`gtk_míu_ôem_√w_wôh_œbñ
("Personal Setting");

328 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
míuôem
), "activate",

329 
	`G_CALLBACK
(
qq_åay_≥rs⁄Æ_£âög_míu_ôem_a˘iv©e
), 
NULL
);

330 
	`gtk_míu_shñl_≠≥nd
(
	`GTK_MENU_SHELL
(
¥iv
->
p›upmíu
), 
míuôem
);

332 
míuôem
 = 
	`gtk_míu_ôem_√w_wôh_œbñ
("System Setting");

333 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
míuôem
), "activate",

334 
	`G_CALLBACK
(
qq_åay_sy°em_£âög_míu_ôem_a˘iv©e
), 
NULL
);

335 
	`gtk_míu_shñl_≠≥nd
(
	`GTK_MENU_SHELL
(
¥iv
->
p›upmíu
), 
míuôem
);

337 
míuôem
 = 
	`gtk_£∑øt‹_míu_ôem_√w
();

338 
	`gtk_míu_shñl_≠≥nd
(
	`GTK_MENU_SHELL
(
¥iv
->
p›upmíu
), 
míuôem
);

340 
míuôem
 = 
	`gtk_image_míu_ôem_√w_‰om_°ock
(
GTK_STOCK_ABOUT
, 
NULL
);

341 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
míuôem
), "activate",

342 
	`G_CALLBACK
(
qq_åay_about_míu_ôem_a˘iv©e
), 
NULL
);

343 
	`gtk_míu_shñl_≠≥nd
(
	`GTK_MENU_SHELL
(
¥iv
->
p›upmíu
), 
míuôem
);

344 
	`gtk_míu_ôem_£t_œbñ
(
	`GTK_MENU_ITEM
(
míuôem
), "About GtkQQ");

346 
míuôem
 = 
	`gtk_image_míu_ôem_√w_‰om_°ock
(
GTK_STOCK_QUIT
, 
NULL
);

347 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
míuôem
), "activate",

348 
	`G_CALLBACK
(
qq_åay_quô_míu_ôem_a˘iv©e
), 
NULL
);

349 
	`gtk_míu_shñl_≠≥nd
(
	`GTK_MENU_SHELL
(
¥iv
->
p›upmíu
), 
míuôem
);

350 
	`gtk_míu_ôem_£t_œbñ
(
	`GTK_MENU_ITEM
(
míuôem
), "Quit");

352 
	`gtk_widgë_show_Æl
(
¥iv
->
p›upmíu
);

354 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
åay
), "popup-menu",

355 
	`G_CALLBACK
(
qq_åay_p›up_míu
), 
åay
);

356 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
åay
), "button-press-event",

357 
	`G_CALLBACK
(
qq_åay_buâ⁄_¥ess
), 
åay
);

358 
	`g_sig«l_c⁄√˘
(
	`G_OBJECT
(
åay
), "query-tooltip",

359 
	`G_CALLBACK
(
qq_åay_⁄_show_toﬁtù
), 
åay
);

360 
	}
}

362 
	$qq_åay˛ass_öô
(
QQTøyCœss
 *
tc
, 
gpoöãr
 
d©a
)

364 
	`g_ty≥_˛ass_add_¥iv©e
(
tc
, (
QQTøyPriv
));

365 
	}
}

367 
	$qq_åay_blökög_f‹
(
QQTøy
 *
åay
, c⁄° 
gch¨
 *
uö
)

369 i‡(
åay
 =
NULL
 || 
uö
 == NULL) {

373 
QQTøyPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(
åay
, 
	`qq_åay_gë_ty≥
(),

374 
QQTøyPriv
);

376 if(
NULL
 !
	`g_queue_föd_cu°om
(
¥iv
->
blökög_queue
, 
uö
,

377 (
GCom∑ªFunc
)
g_°rcmp0
)){

381 
	`g_queue_push_hód
(
¥iv
->
blökög_queue
, 
	`g_°rdup
(
uö
));

382 
	`qq_åay_blökög
(
åay
, 
	`g_queue_≥ek_èû
(
¥iv
->
blökög_queue
));

383 
	}
}

385 
	$qq_åay_°›_blökög_f‹
(
QQTøy
 *
åay
, c⁄° 
gch¨
 *
uö
)

387 i‡(
åay
 =
NULL
 || 
uö
 == NULL) {

391 
QQTøyPriv
 *
¥iv
 = 
	`G_TYPE_INSTANCE_GET_PRIVATE
(

392 
åay
, 
	`qq_åay_gë_ty≥
(),
QQTøyPriv
);

394 
gch¨
 *
tmpuö
 = 
NULL
;

395 
	`g_queue_˛ór
(
¥iv
->
tmp_queue
);

396 !
	`g_queue_is_em±y
(
¥iv
->
blökög_queue
)) {

397 
tmpuö
 = 
	`g_queue_p›_èû
(
¥iv
->
blökög_queue
);

398 i‡(
	`g_°rcmp0
(
tmpuö
, 
uö
) == 0) {

400 
	`g_‰ì
(
tmpuö
);

403 
	`g_queue_push_hód
(
¥iv
->
tmp_queue
, 
tmpuö
);

405 !
	`g_queue_is_em±y
(
¥iv
->
tmp_queue
)) {

406 
	`g_queue_push_èû
(
¥iv
->
blökög_queue
,

407 
	`g_queue_p›_hód
(
¥iv
->
tmp_queue
));

410 
GdkPixbuf
 *
pb
;

411 i‡(
	`g_queue_is_em±y
(
¥iv
->
blökög_queue
)) {

412 
gch¨
 
img
[256];

413 
	`g_¢¥ötf
(
img
, (img), "%s/webqq_ic⁄.≤g", 
lwqq_ic⁄s_dú
);

414 
pb
 = 
	`gdk_pixbuf_√w_‰om_fûe
(
img
, 
NULL
);

415 
	`gtk_°©us_ic⁄_£t_‰om_pixbuf
(
	`GTK_STATUS_ICON
(
åay
), 
pb
);

416 
	`g_obje˘_uƒef
(
pb
);

418 
	`qq_åay_blökög
(
åay
, 
	`g_queue_≥ek_èû
(
¥iv
->
blökög_queue
));

420 
	}
}

	@src/gui/tray.h

1 #i‚de‡
__GTKQQ_TRAY_H


2 
	#__GTKQQ_TRAY_H


	)

3 
	~<gtk/gtk.h
>

5 
	#QQ_TRAY
(
obj
Ë
	`G_TYPE_CHECK_INSTANCE_CAST
(obj, 
	`qq_åay_gë_ty≥
(), 
QQTøy
)

	)

6 
	#QQ_TRAYCLASS
(
c
Ë
	`G_TYPE_CHECK_CLASS_CAST
(c, 
	`qq_åay_gë_ty≥
()\

7 , 
QQTøyCœss
)

	)

8 
	#QQ_IS_TRAY
(
obj
Ë
	`G_TYPE_CHECK_INSTANCE_TYPE
(obj, 
	`qq_åay_gë_ty≥
())

	)

10 
__QQTøy
 
	tQQTøy
;

11 
__QQTøyCœss
 
	tQQTøyCœss
;

13 
	s__QQTøy
{

14 
GtkSètusIc⁄
 
	m∑ª¡
;

17 
	s__QQTøyCœss
{

18 
GtkSètusIc⁄Cœss
 
	m∑ª¡
;

21 
QQTøy
* 
qq_åay_√w
();

22 
GTy≥
 
qq_åay_gë_ty≥
();

29 
qq_åay_blökög_f‹
(
QQTøy
 *
åay
, c⁄° 
gch¨
 *
uö
);

35 
qq_åay_°›_blökög_f‹
(
QQTøy
 *
åay
, c⁄° 
gch¨
 *
uö
);

43 
qq_åay_£t_muã_ôem
(
QQTøy
 *
åay
, 
gboﬁón
 
muã
);

	@src/include/lwqq/info.h

11 #i‚de‡
LWQQ_INFO_H


12 
	#LWQQ_INFO_H


	)

14 
	~"ty≥.h
"

23 
lwqq_öfo_gë_‰õnds_öfo
(
LwqqClõ¡
 *
lc
, 
LwqqEº‹Code
 *
îr
);

31 
lwqq_öfo_gë_group_«me_li°
(
LwqqClõ¡
 *
lc
, 
LwqqEº‹Code
 *
îr
);

42 
lwqq_öfo_gë_‰õnd_dëaû_öfo
(
LwqqClõ¡
 *
lc
, 
LwqqBuddy
 *
buddy
,

43 
LwqqEº‹Code
 *
îr
);

51 
lwqq_öfo_gë_Æl_‰õnd_qqnumbîs
(
LwqqClõ¡
 *
lc
, 
LwqqEº‹Code
 *
îr
);

62 *
lwqq_öfo_gë_‰õnd_qqnumbî
(
LwqqClõ¡
 *
lc
, c⁄° *
uö
);

71 
lwqq_öfo_gë_group_dëaû_öfo
(
LwqqClõ¡
 *
lc
, 
LwqqGroup
 *
group
,

72 
LwqqEº‹Code
 *
îr
);

83 
lwqq_öfo_gë_⁄löe_buddõs
(
LwqqClõ¡
 *
lc
, 
LwqqEº‹Code
 *
îr
);

	@src/include/lwqq/logger.h

11 #i‚de‡
LWQQ_LOGGER_H


12 
	#LWQQ_LOGGER_H


	)

14 
	#_A_
 
__FILE__
, 
__LINE__
, 
__PRETTY_FUNCTION__


	)

15 
	#_LOG_DEBUG
 0

	)

16 
	#LOG_DEBUG
 
_LOG_DEBUG
, 
_A_


	)

18 
	#__LOG_NOTICE
 1

	)

19 
	#LOG_NOTICE
 
__LOG_NOTICE
, 
_A_


	)

21 
	#__LOG_WARNING
 2

	)

22 
	#LOG_WARNING
 
__LOG_WARNING
, 
_A_


	)

24 
	#__LOG_ERROR
 3

	)

25 
	#LOG_ERROR
 
__LOG_ERROR
, 
_A_


	)

36 
lwqq_log
(
Àvñ
, c⁄° *
fûe
, 
löe
,

37 c⁄° *
fun˘i⁄
, c⁄° * 
msg
, ...);

	@src/include/lwqq/login.h

11 #i‚de‡
LWQQ_LOGIN_H


12 
	#LWQQ_LOGIN_H


	)

14 
	~"ty≥.h
"

22 
lwqq_logö
(
LwqqClõ¡
 *
˛õ¡
, 
LwqqEº‹Code
 *
îr
);

30 
lwqq_logout
(
LwqqClõ¡
 *
˛õ¡
, 
LwqqEº‹Code
 *
îr
);

	@src/include/lwqq/msg.h

11 #i‚de‡
LWQQ_MSG_H


12 
	#LWQQ_MSG_H


	)

14 
	~<±hªad.h
>

15 
	~"queue.h
"

17 
	#LWQQ_CONTENT_STRING
 0

	)

18 
	#LWQQ_CONTENT_FACE
 1

	)

20 
	sLwqqMsgC⁄ã¡
 {

21 
	mty≥
;

23 
	mÁ˚
;

24 *
	m°r
;

25 } 
	md©a
;

26 
TAILQ_ENTRY
(
LwqqMsgC⁄ã¡
Ë
	míåõs
;

27 } 
	tLwqqMsgC⁄ã¡
 ;

29 
	sLwqqMsgMesßge
 {

30 *
	m‰om
;

31 *
	mto
;

32 
time_t
 
	mtime
;

35 *
	mf_«me
;

36 
	mf_size
;

38 
	ma
, 
	mb
, 
	mc
;

39 } 
	mf_°yÀ
;

40 *
	mf_cﬁ‹
;

42 
TAILQ_HEAD
(, 
LwqqMsgC⁄ã¡
Ë
	mc⁄ã¡
;

43 } 
	tLwqqMsgMesßge
;

45 
	sLwqqMsgSètusCh™ge
 {

46 *
	mwho
;

47 *
	m°©us
;

48 
	m˛õ¡_ty≥
;

49 } 
	tLwqqMsgSètusCh™ge
;

51 
	sLwqqMsgKickMesßge
 {

52 
	mshow_ªas⁄
;

53 *
	mªas⁄
;

54 *
	mway
;

55 } 
	tLwqqMsgKickMesßge
;

57 
	eLwqqMsgTy≥
 {

58 
	mLWQQ_MT_BUDDY_MSG
 = 0,

59 
	mLWQQ_MT_GROUP_MSG
,

60 
	mLWQQ_MT_STATUS_CHANGE
,

61 
	mLWQQ_MT_KICK_MESSAGE
,

62 
	mLWQQ_MT_UNKNOWN
,

63 } 
	tLwqqMsgTy≥
;

65 
	sLwqqMsg
 {

67 
LwqqMsgTy≥
 
	mty≥
;

68 *
	m›aque
;

69 } 
	tLwqqMsg
;

78 
LwqqMsg
 *
lwqq_msg_√w
(
LwqqMsgTy≥
 
ty≥
);

85 
lwqq_msg_‰ì
(
LwqqMsg
 *
msg
);

93 
	sLwqqRecvMsg
 {

94 
LwqqMsg
 *
	mmsg
;

95 
SIMPLEQ_ENTRY
(
LwqqRecvMsg
Ë
	míåõs
;

96 } 
	tLwqqRecvMsg
;

98 
	sLwqqRecvMsgLi°
 {

99 
	mcou¡
;

100 
±hªad_muãx_t
 
	mmuãx
;

101 
SIMPLEQ_HEAD
(, 
LwqqRecvMsg
Ë
	mhód
;

102 *
	mlc
;

103 (*
	mpﬁl_msg
)(
LwqqRecvMsgLi°
 *
	mli°
);

104 } 
	tLwqqRecvMsgLi°
;

113 
LwqqRecvMsgLi°
 *
lwqq_ªcvmsg_√w
(*
˛õ¡
);

120 
lwqq_ªcvmsg_‰ì
(
LwqqRecvMsgLi°
 *
li°
);

125 
lwqq_msg_£nd
(*
˛õ¡
, 
LwqqMsg
 *
msg
);

126 
lwqq_msg_£nd2
(*
˛õ¡
, c⁄° *
to
, c⁄° *
c⁄ã¡
);

	@src/include/lwqq/queue.h

32 #i‚def 
_SYS_QUEUE_H_


33 
	#_SYS_QUEUE_H_


	)

84 
	#LIST_HEAD
(
«me
, 
ty≥
) \

85 
	s«me
 { \

86 
ty≥
 *
lh_fú°
; \

87 }

	)

89 
	#LIST_HEAD_INITIALIZER
(
hód
) \

90 { 
NULL
 }

	)

92 
	#LIST_ENTRY
(
ty≥
) \

94 
ty≥
 *
À_√xt
; \

95 
ty≥
 **
À_¥ev
; \

96 }

	)

101 
	#LIST_INIT
(
hód
) do { \

102 (
hód
)->
lh_fú°
 = 
NULL
; \

103 }  0)

	)

105 
	#LIST_INSERT_AFTER
(
li°ñm
, 
ñm
, 
fõld
) do { \

106 i‡(((
ñm
)->
fõld
.
À_√xt
 = (
li°ñm
)->fõld.À_√xtË!
NULL
) \

107 (
li°ñm
)->
fõld
.
À_√xt
->fõld.
À_¥ev
 = \

108 &(
ñm
)->
fõld
.
À_√xt
; \

109 (
li°ñm
)->
fõld
.
À_√xt
 = (
ñm
); \

110 (
ñm
)->
fõld
.
À_¥ev
 = &(
li°ñm
)->fõld.
À_√xt
; \

111 }  0)

	)

113 
	#LIST_INSERT_BEFORE
(
li°ñm
, 
ñm
, 
fõld
) do { \

114 (
ñm
)->
fõld
.
À_¥ev
 = (
li°ñm
)->field.le_prev; \

115 (
ñm
)->
fõld
.
À_√xt
 = (
li°ñm
); \

116 *(
li°ñm
)->
fõld
.
À_¥ev
 = (
ñm
); \

117 (
li°ñm
)->
fõld
.
À_¥ev
 = &(
ñm
)->fõld.
À_√xt
; \

118 }  0)

	)

120 
	#LIST_INSERT_HEAD
(
hód
, 
ñm
, 
fõld
) do { \

121 i‡(((
ñm
)->
fõld
.
À_√xt
 = (
hód
)->
lh_fú°
Ë!
NULL
) \

122 (
hód
)->
lh_fú°
->
fõld
.
À_¥ev
 = &(
ñm
)->fõld.
À_√xt
;\

123 (
hód
)->
lh_fú°
 = (
ñm
); \

124 (
ñm
)->
fõld
.
À_¥ev
 = &(
hód
)->
lh_fú°
; \

125 }  0)

	)

127 
	#LIST_REMOVE
(
ñm
, 
fõld
) do { \

128 i‡((
ñm
)->
fõld
.
À_√xt
 !
NULL
) \

129 (
ñm
)->
fõld
.
À_√xt
->fõld.
À_¥ev
 = \

130 (
ñm
)->
fõld
.
À_¥ev
; \

131 *(
ñm
)->
fõld
.
À_¥ev
 = (ñm)->fõld.
À_√xt
; \

132 }  0)

	)

134 
	#LIST_FOREACH
(
v¨
, 
hód
, 
fõld
) \

135 (
v¨
Ë((
hód
)->
lh_fú°
); \

136 (
v¨
); \

137 (
v¨
Ë((v¨)->
fõld
.
À_√xt
))

	)

139 
	#LIST_FOREACH_SAFE
(
v¨
, 
hód
, 
fõld
, 
tv¨
) \

140 (
v¨
Ë
	`LIST_FIRST
((
hód
)); \

141 (
v¨
Ë&& ((
tv¨
Ë
	`LIST_NEXT
((v¨), 
fõld
), 1); \

142 (
v¨
Ë(
tv¨
))

	)

147 
	#LIST_EMPTY
(
hód
Ë((hód)->
lh_fú°
 =
NULL
)

	)

148 
	#LIST_FIRST
(
hód
Ë((hód)->
lh_fú°
)

	)

149 
	#LIST_NEXT
(
ñm
, 
fõld
Ë(”lm)->fõld.
À_√xt
)

	)

155 
	#SLIST_HEAD
(
«me
, 
ty≥
) \

156 
	s«me
 { \

157 
ty≥
 *
¶h_fú°
; \

158 }

	)

160 
	#SLIST_HEAD_INITIALIZER
(
hód
) \

161 { 
NULL
 }

	)

163 
	#SLIST_ENTRY
(
ty≥
) \

165 
ty≥
 *
¶e_√xt
; \

166 }

	)

171 
	#SLIST_INIT
(
hód
) do { \

172 (
hód
)->
¶h_fú°
 = 
NULL
; \

173 }  0)

	)

175 
	#SLIST_INSERT_AFTER
(
¶i°ñm
, 
ñm
, 
fõld
) do { \

176 (
ñm
)->
fõld
.
¶e_√xt
 = (
¶i°ñm
)->field.sle_next; \

177 (
¶i°ñm
)->
fõld
.
¶e_√xt
 = (
ñm
); \

178 }  0)

	)

180 
	#SLIST_INSERT_HEAD
(
hód
, 
ñm
, 
fõld
) do { \

181 (
ñm
)->
fõld
.
¶e_√xt
 = (
hód
)->
¶h_fú°
; \

182 (
hód
)->
¶h_fú°
 = (
ñm
); \

183 }  0)

	)

185 
	#SLIST_REMOVE_HEAD
(
hód
, 
fõld
) do { \

186 (
hód
)->
¶h_fú°
 = (hód)->¶h_fú°->
fõld
.
¶e_√xt
; \

187 }  0)

	)

189 
	#SLIST_REMOVE
(
hód
, 
ñm
, 
ty≥
, 
fõld
) do { \

190 i‡((
hód
)->
¶h_fú°
 =(
ñm
)) { \

191 
	`SLIST_REMOVE_HEAD
((
hód
), 
fõld
); \

194 
ty≥
 *
cuªlm
 = (
hód
)->
¶h_fú°
; \

195 
cuªlm
->
fõld
.
¶e_√xt
 !(
ñm
)) \

196 
cuªlm
 = cuªlm->
fõld
.
¶e_√xt
; \

197 
cuªlm
->
fõld
.
¶e_√xt
 = \

198 
cuªlm
->
fõld
.
¶e_√xt
->field.sle_next; \

200 }  0)

	)

202 
	#SLIST_FOREACH
(
v¨
, 
hód
, 
fõld
) \

203 (
v¨
Ë(
hód
)->
¶h_fú°
; (v¨); (v¨Ë(v¨)->
fõld
.
¶e_√xt
)

	)

205 
	#SLIST_FOREACH_SAFE
(
v¨
, 
hód
, 
fõld
, 
tv¨
) \

206 (
v¨
Ë
	`SLIST_FIRST
((
hód
)); \

207 (
v¨
Ë&& ((
tv¨
Ë
	`SLIST_NEXT
((v¨), 
fõld
), 1); \

208 (
v¨
Ë(
tv¨
))

	)

210 
	#SLIST_FOREACH_PREVPTR
(
v¨
, 
v¨p
, 
hód
, 
fõld
) \

211 (
v¨p
Ë&
	`SLIST_FIRST
((
hód
)); \

212 ((
v¨
Ë*(
v¨p
)Ë!
NULL
; \

213 (
v¨p
Ë&
	`SLIST_NEXT
((
v¨
), 
fõld
))

	)

218 
	#SLIST_EMPTY
(
hód
Ë((hód)->
¶h_fú°
 =
NULL
)

	)

219 
	#SLIST_FIRST
(
hód
Ë((hód)->
¶h_fú°
)

	)

220 
	#SLIST_NEXT
(
ñm
, 
fõld
Ë(”lm)->fõld.
¶e_√xt
)

	)

226 
	#STAILQ_HEAD
(
«me
, 
ty≥
) \

227 
	s«me
 { \

228 
ty≥
 *
°qh_fú°
; \

229 
ty≥
 **
°qh_œ°
; \

230 }

	)

232 
	#STAILQ_HEAD_INITIALIZER
(
hód
) \

233 { 
NULL
, &(
hód
).
°qh_fú°
 }

	)

235 
	#STAILQ_ENTRY
(
ty≥
) \

237 
ty≥
 *
°qe_√xt
; \

238 }

	)

243 
	#STAILQ_INIT
(
hód
) do { \

244 (
hód
)->
°qh_fú°
 = 
NULL
; \

245 (
hód
)->
°qh_œ°
 = &(hód)->
°qh_fú°
; \

246 }  0)

	)

248 
	#STAILQ_INSERT_HEAD
(
hód
, 
ñm
, 
fõld
) do { \

249 i‡(((
ñm
)->
fõld
.
°qe_√xt
 = (
hód
)->
°qh_fú°
Ë=
NULL
) \

250 (
hód
)->
°qh_œ°
 = &(
ñm
)->
fõld
.
°qe_√xt
; \

251 (
hód
)->
°qh_fú°
 = (
ñm
); \

252 }  0)

	)

254 
	#STAILQ_INSERT_TAIL
(
hód
, 
ñm
, 
fõld
) do { \

255 (
ñm
)->
fõld
.
°qe_√xt
 = 
NULL
; \

256 *(
hód
)->
°qh_œ°
 = (
ñm
); \

257 (
hód
)->
°qh_œ°
 = &(
ñm
)->
fõld
.
°qe_√xt
; \

258 }  0)

	)

260 
	#STAILQ_LAST
(
hód
, 
ty≥
, 
fõld
) \

261 (
	`STAILQ_EMPTY
((
hód
)) ? \

262 
NULL
 : \

263 ((
ty≥
 *)(*) \

264 ((*)((
hód
)->
°qh_œ°
Ë- 
	`off£tof
(
ty≥
, 
fõld
))))

	)

266 
	#STAILQ_INSERT_AFTER
(
hód
, 
li°ñm
, 
ñm
, 
fõld
) do { \

267 i‡(((
ñm
)->
fõld
.
°qe_√xt
 = (
li°ñm
)->fõld.°qe_√xtË=
NULL
)\

268 (
hód
)->
°qh_œ°
 = &(
ñm
)->
fõld
.
°qe_√xt
; \

269 (
li°ñm
)->
fõld
.
°qe_√xt
 = (
ñm
); \

270 }  0)

	)

272 
	#STAILQ_REMOVE_HEAD
(
hód
, 
fõld
) do { \

273 i‡(((
hód
)->
°qh_fú°
 = (hód)->°qh_fú°->
fõld
.
°qe_√xt
Ë=
NULL
) \

274 (
hód
)->
°qh_œ°
 = &(hód)->
°qh_fú°
; \

275 }  0)

	)

277 
	#STAILQ_REMOVE
(
hód
, 
ñm
, 
ty≥
, 
fõld
) do { \

278 i‡((
hód
)->
°qh_fú°
 =(
ñm
)) { \

279 
	`STAILQ_REMOVE_HEAD
((
hód
), 
fõld
); \

281 
ty≥
 *
cuªlm
 = (
hód
)->
°qh_fú°
; \

282 
cuªlm
->
fõld
.
°qe_√xt
 !(
ñm
)) \

283 
cuªlm
 = cuªlm->
fõld
.
°qe_√xt
; \

284 i‡((
cuªlm
->
fõld
.
°qe_√xt
 = \

285 
cuªlm
->
fõld
.
°qe_√xt
->fõld.°qe_√xtË=
NULL
) \

286 (
hód
)->
°qh_œ°
 = &(
cuªlm
)->
fõld
.
°qe_√xt
; \

288 }  0)

	)

290 
	#STAILQ_FOREACH
(
v¨
, 
hód
, 
fõld
) \

291 (
v¨
Ë((
hód
)->
°qh_fú°
); \

292 (
v¨
); \

293 (
v¨
Ë((v¨)->
fõld
.
°qe_√xt
))

	)

295 
	#STAILQ_CONCAT
(
hód1
, 
hód2
) do { \

296 i‡(!
	`STAILQ_EMPTY
((
hód2
))) { \

297 *(
hód1
)->
°qh_œ°
 = (
hód2
)->
°qh_fú°
; \

298 (
hód1
)->
°qh_œ°
 = (
hód2
)->stqh_last; \

299 
	`STAILQ_INIT
((
hód2
)); \

301 }  0)

	)

306 
	#STAILQ_EMPTY
(
hód
Ë((hód)->
°qh_fú°
 =
NULL
)

	)

307 
	#STAILQ_FIRST
(
hód
Ë((hód)->
°qh_fú°
)

	)

308 
	#STAILQ_NEXT
(
ñm
, 
fõld
Ë(”lm)->fõld.
°qe_√xt
)

	)

310 
	#STAILQ_FOREACH_SAFE
(
v¨
, 
hód
, 
fõld
, 
tv¨
) \

311 (
v¨
Ë
	`STAILQ_FIRST
((
hód
)); \

312 (
v¨
Ë&& ((
tv¨
Ë
	`STAILQ_NEXT
((v¨), 
fõld
), 1); \

313 (
v¨
Ë(
tv¨
))

	)

319 
	#SIMPLEQ_HEAD
(
«me
, 
ty≥
) \

320 
	s«me
 { \

321 
ty≥
 *
sqh_fú°
; \

322 
ty≥
 **
sqh_œ°
; \

323 }

	)

325 
	#SIMPLEQ_HEAD_INITIALIZER
(
hód
) \

326 { 
NULL
, &(
hód
).
sqh_fú°
 }

	)

328 
	#SIMPLEQ_ENTRY
(
ty≥
) \

330 
ty≥
 *
sqe_√xt
; \

331 }

	)

336 
	#SIMPLEQ_INIT
(
hód
) do { \

337 (
hód
)->
sqh_fú°
 = 
NULL
; \

338 (
hód
)->
sqh_œ°
 = &(hód)->
sqh_fú°
; \

339 }  0)

	)

341 
	#SIMPLEQ_INSERT_HEAD
(
hód
, 
ñm
, 
fõld
) do { \

342 i‡(((
ñm
)->
fõld
.
sqe_√xt
 = (
hód
)->
sqh_fú°
Ë=
NULL
) \

343 (
hód
)->
sqh_œ°
 = &(
ñm
)->
fõld
.
sqe_√xt
; \

344 (
hód
)->
sqh_fú°
 = (
ñm
); \

345 }  0)

	)

347 
	#SIMPLEQ_INSERT_TAIL
(
hód
, 
ñm
, 
fõld
) do { \

348 (
ñm
)->
fõld
.
sqe_√xt
 = 
NULL
; \

349 *(
hód
)->
sqh_œ°
 = (
ñm
); \

350 (
hód
)->
sqh_œ°
 = &(
ñm
)->
fõld
.
sqe_√xt
; \

351 }  0)

	)

353 
	#SIMPLEQ_INSERT_AFTER
(
hód
, 
li°ñm
, 
ñm
, 
fõld
) do { \

354 i‡(((
ñm
)->
fõld
.
sqe_√xt
 = (
li°ñm
)->fõld.sqe_√xtË=
NULL
)\

355 (
hód
)->
sqh_œ°
 = &(
ñm
)->
fõld
.
sqe_√xt
; \

356 (
li°ñm
)->
fõld
.
sqe_√xt
 = (
ñm
); \

357 }  0)

	)

359 
	#SIMPLEQ_REMOVE_HEAD
(
hód
, 
fõld
) do { \

360 i‡(((
hód
)->
sqh_fú°
 = (hód)->sqh_fú°->
fõld
.
sqe_√xt
Ë=
NULL
) \

361 (
hód
)->
sqh_œ°
 = &(hód)->
sqh_fú°
; \

362 }  0)

	)

364 
	#SIMPLEQ_REMOVE
(
hód
, 
ñm
, 
ty≥
, 
fõld
) do { \

365 i‡((
hód
)->
sqh_fú°
 =(
ñm
)) { \

366 
	`SIMPLEQ_REMOVE_HEAD
((
hód
), 
fõld
); \

368 
ty≥
 *
cuªlm
 = (
hód
)->
sqh_fú°
; \

369 
cuªlm
->
fõld
.
sqe_√xt
 !(
ñm
)) \

370 
cuªlm
 = cuªlm->
fõld
.
sqe_√xt
; \

371 i‡((
cuªlm
->
fõld
.
sqe_√xt
 = \

372 
cuªlm
->
fõld
.
sqe_√xt
->fõld.sqe_√xtË=
NULL
) \

373 (
hód
)->
sqh_œ°
 = &(
cuªlm
)->
fõld
.
sqe_√xt
; \

375 }  0)

	)

377 
	#SIMPLEQ_FOREACH
(
v¨
, 
hód
, 
fõld
) \

378 (
v¨
Ë((
hód
)->
sqh_fú°
); \

379 (
v¨
); \

380 (
v¨
Ë((v¨)->
fõld
.
sqe_√xt
))

	)

385 
	#SIMPLEQ_EMPTY
(
hód
Ë((hód)->
sqh_fú°
 =
NULL
)

	)

386 
	#SIMPLEQ_FIRST
(
hód
Ë((hód)->
sqh_fú°
)

	)

387 
	#SIMPLEQ_NEXT
(
ñm
, 
fõld
Ë(”lm)->fõld.
sqe_√xt
)

	)

393 
	#_TAILQ_HEAD
(
«me
, 
ty≥
, 
quÆ
) \

394 
	s«me
 { \

395 
quÆ
 
ty≥
 *
tqh_fú°
; \

396 
quÆ
 
ty≥
 *quÆ *
tqh_œ°
; \

397 }

	)

398 
	#TAILQ_HEAD
(
«me
, 
ty≥
Ë
	`_TAILQ_HEAD
“ame, ty≥,)

	)

400 
	#TAILQ_HEAD_INITIALIZER
(
hód
) \

401 { 
NULL
, &(
hód
).
tqh_fú°
 }

	)

403 
	#_TAILQ_ENTRY
(
ty≥
, 
quÆ
) \

405 
quÆ
 
ty≥
 *
tqe_√xt
; \

406 
quÆ
 
ty≥
 *quÆ *
tqe_¥ev
; \

407 }

	)

408 
	#TAILQ_ENTRY
(
ty≥
Ë
	`_TAILQ_ENTRY
(ty≥,)

	)

413 
	#TAILQ_INIT
(
hód
) do { \

414 (
hód
)->
tqh_fú°
 = 
NULL
; \

415 (
hód
)->
tqh_œ°
 = &(hód)->
tqh_fú°
; \

416 }  0)

	)

418 
	#TAILQ_INSERT_HEAD
(
hód
, 
ñm
, 
fõld
) do { \

419 i‡(((
ñm
)->
fõld
.
tqe_√xt
 = (
hód
)->
tqh_fú°
Ë!
NULL
) \

420 (
hód
)->
tqh_fú°
->
fõld
.
tqe_¥ev
 = \

421 &(
ñm
)->
fõld
.
tqe_√xt
; \

423 (
hód
)->
tqh_œ°
 = &(
ñm
)->
fõld
.
tqe_√xt
; \

424 (
hód
)->
tqh_fú°
 = (
ñm
); \

425 (
ñm
)->
fõld
.
tqe_¥ev
 = &(
hód
)->
tqh_fú°
; \

426 }  0)

	)

428 
	#TAILQ_INSERT_TAIL
(
hód
, 
ñm
, 
fõld
) do { \

429 (
ñm
)->
fõld
.
tqe_√xt
 = 
NULL
; \

430 (
ñm
)->
fõld
.
tqe_¥ev
 = (
hód
)->
tqh_œ°
; \

431 *(
hód
)->
tqh_œ°
 = (
ñm
); \

432 (
hód
)->
tqh_œ°
 = &(
ñm
)->
fõld
.
tqe_√xt
; \

433 }  0)

	)

435 
	#TAILQ_INSERT_AFTER
(
hód
, 
li°ñm
, 
ñm
, 
fõld
) do { \

436 i‡(((
ñm
)->
fõld
.
tqe_√xt
 = (
li°ñm
)->fõld.tqe_√xtË!
NULL
)\

437 (
ñm
)->
fõld
.
tqe_√xt
->fõld.
tqe_¥ev
 = \

438 &(
ñm
)->
fõld
.
tqe_√xt
; \

440 (
hód
)->
tqh_œ°
 = &(
ñm
)->
fõld
.
tqe_√xt
; \

441 (
li°ñm
)->
fõld
.
tqe_√xt
 = (
ñm
); \

442 (
ñm
)->
fõld
.
tqe_¥ev
 = &(
li°ñm
)->fõld.
tqe_√xt
; \

443 }  0)

	)

445 
	#TAILQ_INSERT_BEFORE
(
li°ñm
, 
ñm
, 
fõld
) do { \

446 (
ñm
)->
fõld
.
tqe_¥ev
 = (
li°ñm
)->field.tqe_prev; \

447 (
ñm
)->
fõld
.
tqe_√xt
 = (
li°ñm
); \

448 *(
li°ñm
)->
fõld
.
tqe_¥ev
 = (
ñm
); \

449 (
li°ñm
)->
fõld
.
tqe_¥ev
 = &(
ñm
)->fõld.
tqe_√xt
; \

450 }  0)

	)

452 
	#TAILQ_REMOVE
(
hód
, 
ñm
, 
fõld
) do { \

453 i‡(((
ñm
)->
fõld
.
tqe_√xt
Ë!
NULL
) \

454 (
ñm
)->
fõld
.
tqe_√xt
->fõld.
tqe_¥ev
 = \

455 (
ñm
)->
fõld
.
tqe_¥ev
; \

457 (
hód
)->
tqh_œ°
 = (
ñm
)->
fõld
.
tqe_¥ev
; \

458 *(
ñm
)->
fõld
.
tqe_¥ev
 = (ñm)->fõld.
tqe_√xt
; \

459 }  0)

	)

461 
	#TAILQ_FOREACH
(
v¨
, 
hód
, 
fõld
) \

462 (
v¨
Ë((
hód
)->
tqh_fú°
); \

463 (
v¨
); \

464 (
v¨
Ë((v¨)->
fõld
.
tqe_√xt
))

	)

466 
	#TAILQ_FOREACH_SAFE
(
v¨
, 
hód
, 
fõld
, 
tv¨
) \

467 (
v¨
Ë
	`TAILQ_FIRST
((
hód
)); \

468 (
v¨
Ë&& ((
tv¨
Ë
	`TAILQ_NEXT
((v¨), 
fõld
), 1); \

469 (
v¨
Ë(
tv¨
))

	)

471 
	#TAILQ_FOREACH_REVERSE
(
v¨
, 
hód
, 
hód«me
, 
fõld
) \

472 (
v¨
Ë(*(((
hód«me
 *)((
hód
)->
tqh_œ°
))->tqh_last)); \

473 (
v¨
); \

474 (
v¨
Ë(*(((
hód«me
 *)((v¨)->
fõld
.
tqe_¥ev
))->
tqh_œ°
)))

	)

476 
	#TAILQ_FOREACH_REVERSE_SAFE
(
v¨
, 
hód
, 
hód«me
, 
fõld
, 
tv¨
) \

477 (
v¨
Ë
	`TAILQ_LAST
((
hód
), 
hód«me
); \

478 (
v¨
Ë&& ((
tv¨
Ë
	`TAILQ_PREV
((v¨), 
hód«me
, 
fõld
), 1); \

479 (
v¨
Ë(
tv¨
))

	)

482 
	#TAILQ_CONCAT
(
hód1
, 
hód2
, 
fõld
) do { \

483 i‡(!
	`TAILQ_EMPTY
(
hód2
)) { \

484 *(
hód1
)->
tqh_œ°
 = (
hód2
)->
tqh_fú°
; \

485 (
hód2
)->
tqh_fú°
->
fõld
.
tqe_¥ev
 = (
hód1
)->
tqh_œ°
; \

486 (
hód1
)->
tqh_œ°
 = (
hód2
)->tqh_last; \

487 
	`TAILQ_INIT
((
hód2
)); \

489 }  0)

	)

494 
	#TAILQ_EMPTY
(
hód
Ë((hód)->
tqh_fú°
 =
NULL
)

	)

495 
	#TAILQ_FIRST
(
hód
Ë((hód)->
tqh_fú°
)

	)

496 
	#TAILQ_NEXT
(
ñm
, 
fõld
Ë(”lm)->fõld.
tqe_√xt
)

	)

498 
	#TAILQ_LAST
(
hód
, 
hód«me
) \

499 (*(((
hód«me
 *)((
hód
)->
tqh_œ°
))->tqh_œ°))

	)

500 
	#TAILQ_PREV
(
ñm
, 
hód«me
, 
fõld
) \

501 (*(((
hód«me
 *)((
ñm
)->
fõld
.
tqe_¥ev
))->
tqh_œ°
))

	)

507 
	#CIRCLEQ_HEAD
(
«me
, 
ty≥
) \

508 
	s«me
 { \

509 
ty≥
 *
cqh_fú°
; \

510 
ty≥
 *
cqh_œ°
; \

511 }

	)

513 
	#CIRCLEQ_HEAD_INITIALIZER
(
hód
) \

514 { (*)&
hód
, (*)&hód }

	)

516 
	#CIRCLEQ_ENTRY
(
ty≥
) \

518 
ty≥
 *
cqe_√xt
; \

519 
ty≥
 *
cqe_¥ev
; \

520 }

	)

525 
	#CIRCLEQ_INIT
(
hód
) do { \

526 (
hód
)->
cqh_fú°
 = (*)(head); \

527 (
hód
)->
cqh_œ°
 = (*)(head); \

528 }  0)

	)

530 
	#CIRCLEQ_INSERT_AFTER
(
hód
, 
li°ñm
, 
ñm
, 
fõld
) do { \

531 (
ñm
)->
fõld
.
cqe_√xt
 = (
li°ñm
)->field.cqe_next; \

532 (
ñm
)->
fõld
.
cqe_¥ev
 = (
li°ñm
); \

533 i‡((
li°ñm
)->
fõld
.
cqe_√xt
 =(*)(
hód
)) \

534 (
hód
)->
cqh_œ°
 = (
ñm
); \

536 (
li°ñm
)->
fõld
.
cqe_√xt
->fõld.
cqe_¥ev
 = (
ñm
); \

537 (
li°ñm
)->
fõld
.
cqe_√xt
 = (
ñm
); \

538 }  0)

	)

540 
	#CIRCLEQ_INSERT_BEFORE
(
hód
, 
li°ñm
, 
ñm
, 
fõld
) do { \

541 (
ñm
)->
fõld
.
cqe_√xt
 = (
li°ñm
); \

542 (
ñm
)->
fõld
.
cqe_¥ev
 = (
li°ñm
)->field.cqe_prev; \

543 i‡((
li°ñm
)->
fõld
.
cqe_¥ev
 =(*)(
hód
)) \

544 (
hód
)->
cqh_fú°
 = (
ñm
); \

546 (
li°ñm
)->
fõld
.
cqe_¥ev
->fõld.
cqe_√xt
 = (
ñm
); \

547 (
li°ñm
)->
fõld
.
cqe_¥ev
 = (
ñm
); \

548 }  0)

	)

550 
	#CIRCLEQ_INSERT_HEAD
(
hód
, 
ñm
, 
fõld
) do { \

551 (
ñm
)->
fõld
.
cqe_√xt
 = (
hód
)->
cqh_fú°
; \

552 (
ñm
)->
fõld
.
cqe_¥ev
 = (*)(
hód
); \

553 i‡((
hód
)->
cqh_œ°
 == (*)(head)) \

554 (
hód
)->
cqh_œ°
 = (
ñm
); \

556 (
hód
)->
cqh_fú°
->
fõld
.
cqe_¥ev
 = (
ñm
); \

557 (
hód
)->
cqh_fú°
 = (
ñm
); \

558 }  0)

	)

560 
	#CIRCLEQ_INSERT_TAIL
(
hód
, 
ñm
, 
fõld
) do { \

561 (
ñm
)->
fõld
.
cqe_√xt
 = (*)(
hód
); \

562 (
ñm
)->
fõld
.
cqe_¥ev
 = (
hód
)->
cqh_œ°
; \

563 i‡((
hód
)->
cqh_fú°
 == (*)(head)) \

564 (
hód
)->
cqh_fú°
 = (
ñm
); \

566 (
hód
)->
cqh_œ°
->
fõld
.
cqe_√xt
 = (
ñm
); \

567 (
hód
)->
cqh_œ°
 = (
ñm
); \

568 }  0)

	)

570 
	#CIRCLEQ_REMOVE
(
hód
, 
ñm
, 
fõld
) do { \

571 i‡((
ñm
)->
fõld
.
cqe_√xt
 =(*)(
hód
)) \

572 (
hód
)->
cqh_œ°
 = (
ñm
)->
fõld
.
cqe_¥ev
; \

574 (
ñm
)->
fõld
.
cqe_√xt
->fõld.
cqe_¥ev
 = \

575 (
ñm
)->
fõld
.
cqe_¥ev
; \

576 i‡((
ñm
)->
fõld
.
cqe_¥ev
 =(*)(
hód
)) \

577 (
hód
)->
cqh_fú°
 = (
ñm
)->
fõld
.
cqe_√xt
; \

579 (
ñm
)->
fõld
.
cqe_¥ev
->fõld.
cqe_√xt
 = \

580 (
ñm
)->
fõld
.
cqe_√xt
; \

581 }  0)

	)

583 
	#CIRCLEQ_FOREACH
(
v¨
, 
hód
, 
fõld
) \

584 (
v¨
Ë((
hód
)->
cqh_fú°
); \

585 (
v¨
Ë!(c⁄° *)(
hód
); \

586 (
v¨
Ë((v¨)->
fõld
.
cqe_√xt
))

	)

588 
	#CIRCLEQ_FOREACH_REVERSE
(
v¨
, 
hód
, 
fõld
) \

589 (
v¨
Ë((
hód
)->
cqh_œ°
); \

590 (
v¨
Ë!(c⁄° *)(
hód
); \

591 (
v¨
Ë((v¨)->
fõld
.
cqe_¥ev
))

	)

596 
	#CIRCLEQ_EMPTY
(
hód
Ë((hód)->
cqh_fú°
 =(*)(hód))

	)

597 
	#CIRCLEQ_FIRST
(
hód
Ë((hód)->
cqh_fú°
)

	)

598 
	#CIRCLEQ_LAST
(
hód
Ë((hód)->
cqh_œ°
)

	)

599 
	#CIRCLEQ_NEXT
(
ñm
, 
fõld
Ë(”lm)->fõld.
cqe_√xt
)

	)

600 
	#CIRCLEQ_PREV
(
ñm
, 
fõld
Ë(”lm)->fõld.
cqe_¥ev
)

	)

602 
	#CIRCLEQ_LOOP_NEXT
(
hód
, 
ñm
, 
fõld
) \

603 (((
ñm
)->
fõld
.
cqe_√xt
 =(*)(
hód
)) \

604 ? ((
hód
)->
cqh_fú°
) \

605 : (
ñm
->
fõld
.
cqe_√xt
))

	)

606 
	#CIRCLEQ_LOOP_PREV
(
hód
, 
ñm
, 
fõld
) \

607 (((
ñm
)->
fõld
.
cqe_¥ev
 =(*)(
hód
)) \

608 ? ((
hód
)->
cqh_œ°
) \

609 : (
ñm
->
fõld
.
cqe_¥ev
))

	)

	@src/include/lwqq/smemory.h

12 #i‚de‡
SMEMORY_H


13 
	#SMEMORY_H


	)

15 
	~<°d¨g.h
>

16 
	~<°dio.h
>

18 *
s_mÆloc
(
size_t
 
size
);

19 *
s_mÆloc0
(
size_t
 
size
);

20 *
s_ˇŒoc
(
size_t
 
nmemb
, size_à
lsize
);

21 *
s_ªÆloc
(*
±r
, 
size_t
 
size
);

22 
s_‰ì
(*
p
);

23 *
s_°rdup
(c⁄° *
s1
);

24 *
s_°∫dup
(c⁄° *
s1
, 
size_t
 
n
);

25 
s_va•rötf
(**
buf
, c⁄° * 
f‹m©
, 
va_li°
 
¨g
);

26 
s_a•rötf
(**
buf
, c⁄° *
f‹m©
, ...);

	@src/include/lwqq/type.h

11 #i‚de‡
LWQQ_TYPE_H


12 
	#LWQQ_TYPE_H


	)

14 
	~"queue.h
"

15 
	~"msg.h
"

20 
	sLwqqFrõndC©eg‹y
 {

21 
	mödex
;

22 
	ms‹t
;

23 *
	m«me
;

24 
	mcou¡
;

25 
LIST_ENTRY
(
LwqqFrõndC©eg‹y
Ë
	míåõs
;

26 } 
	tLwqqFrõndC©eg‹y
;

29 
	sLwqqBuddy
 {

30 *
	muö
;

31 *
	mqqnumbî
;

32 *
	mÁ˚
;

33 *
	moccu∑ti⁄
;

34 *
	mph⁄e
;

35 *
	mÆlow
;

36 *
	mcﬁÀge
;

37 *
	mªg_time
;

38 *
	mc⁄°ñ
;

39 *
	mblood
;

40 *
	mhomïage
;

41 *
	m°©
;

42 *
	mcou¡ry
;

43 *
	mcôy
;

44 *
	m≥rs⁄Æ
;

45 *
	mnick
;

46 *
	ml⁄g_nick
;

47 *
	mshígxüo
;

48 *
	memaû
;

49 *
	m¥ovö˚
;

50 *
	mgídî
;

51 *
	mmobûe
;

52 *
	mvù_öfo
;

53 *
	mm¨k«me
;

55 *
	mÊag
;

57 *
	mˇã_ödex
;

64 *
	m˛õ¡_ty≥
;

66 *
	m°©us
;

67 
±hªad_muãx_t
 
	mmuãx
;

68 
LIST_ENTRY
(
LwqqBuddy
Ë
	míåõs
;

69 } 
	tLwqqBuddy
;

72 
	sLwqqGroup
 {

73 *
	m«me
;

74 *
	mgid
;

75 *
	mcode
;

76 *
	maccou¡
;

77 *
	mm¨k«me
;

80 *
	mÁ˚
;

81 *
	mmemo
;

82 *
	m˛ass
;

83 *
	mfögîmemo
;

84 *
	m¸óãtime
;

85 *
	mÀvñ
;

86 *
	mow√r
;

87 *
	mÊag
;

88 *
	m›ti⁄
;

90 
LIST_ENTRY
(
LwqqGroup
Ë
	míåõs
;

91 
LIST_HEAD
(, 
LwqqBuddy
Ë
	mmembîs
;

92 } 
	tLwqqGroup
;

94 
	sLwqqVîifyCode
 {

95 *
	m°r
;

96 *
	mty≥
;

97 *
	mimg
;

98 *
	muö
;

99 } 
	tLwqqVîifyCode
 ;

101 
	sLwqqCookõs
 {

102 *
	m±vf£ssi⁄
;

103 *
	m±cz
;

104 *
	mskey
;

105 *
	m±webqq
;

106 *
	m±u£röfo
;

107 *
	muö
;

108 *
	m±i•
;

109 *
	m±2gguö
;

110 *
	mvîify£ssi⁄
;

111 *
	mlwcookõs
;

112 } 
	tLwqqCookõs
;

115 
	sLwqqClõ¡
 {

116 *
	mu£∫ame
;

117 *
	m∑ssw‹d
;

118 
LwqqBuddy
 *
	mmy£lf
;

119 *
	mvîsi⁄
;

120 
LwqqVîifyCode
 *
	mvc
;

121 *
	m˛õ¡id
;

122 *
	m£skey
;

123 *
	mcù
;

124 *
	mödex
;

125 *
	mp‹t
;

126 *
	m°©us
;

127 *
	mvfwebqq
;

128 *
	mp£ssi⁄id
;

129 
LwqqCookõs
 *
	mcookõs
;

130 
LIST_HEAD
(, 
LwqqBuddy
Ë
	m‰õnds
;

131 
LIST_HEAD
(, 
LwqqFrõndC©eg‹y
Ë
	mˇãg‹õs
;

132 
LIST_HEAD
(, 
LwqqGroup
Ë
	mgroups
;

133 
LwqqRecvMsgLi°
 *
	mmsg_li°
;

134 
	mmsg_id
;

135 } 
	tLwqqClõ¡
;

139 
	mLWQQ_EC_OK
,

140 
	mLWQQ_EC_ERROR
,

141 
	mLWQQ_EC_NULL_POINTER
,

142 
	mLWQQ_EC_FILE_NOT_EXIST
,

143 
	mLWQQ_EC_LOGIN_NEED_VC
 = 10,

144 
	mLWQQ_EC_NETWORK_ERROR
 = 20,

145 
	mLWQQ_EC_HTTP_ERROR
 = 30,

146 
	mLWQQ_EC_DB_EXEC_FAIELD
 = 50,

147 
	mLWQQ_EC_DB_CLOSE_FAILED
,

148 } 
	tLwqqEº‹Code
;

162 
LwqqClõ¡
 *
lwqq_˛õ¡_√w
(c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
);

171 *
lwqq_gë_cookõs
(
LwqqClõ¡
 *
lc
);

178 
lwqq_vc_‰ì
(
LwqqVîifyCode
 *
vc
);

185 
lwqq_˛õ¡_‰ì
(
LwqqClõ¡
 *
˛õ¡
);

197 
LwqqBuddy
 *
lwqq_buddy_√w
();

204 
lwqq_buddy_‰ì
(
LwqqBuddy
 *
buddy
);

214 
LwqqBuddy
 *
lwqq_buddy_föd_buddy_by_uö
(
LwqqClõ¡
 *
lc
, c⁄° *
uö
);

224 
lwqq_group_‰ì
(
LwqqGroup
 *
group
);

232 
LwqqGroup
 *
lwqq_group_√w
();

242 
LwqqGroup
 *
lwqq_group_föd_group_by_gid
(
LwqqClõ¡
 *
lc
, c⁄° *
gid
);

252 
LwqqBuddy
 *
lwqq_group_föd_group_membî_by_uö
(
LwqqGroup
 *
group
, c⁄° *
uö
);

	@src/liblwqq/http.c

1 
	~<°rög.h
>

2 
	~<zlib.h
>

3 
	~<ev.h
>

4 
	~<ghâp.h
>

5 
	~"smem‹y.h
"

6 
	~"hâp.h
"

7 
	~"loggî.h
"

9 
	#LWQQ_HTTP_USER_AGENT
 "U£r-Agít: Mozûœ/5.0 \
(X11; Löux x86_64;Ñv:10.0ËGecko/20100101 Fúefox/10.0"

	)

12 
lwqq_hâp_do_ªque°
(
LwqqHâpReque°
 *
ªque°
, 
mëhod
, *
body
);

13 
lwqq_hâp_£t_hódî
(
LwqqHâpReque°
 *
ªque°
, c⁄° *
«me
,

14 c⁄° *
vÆue
);

15 
lwqq_hâp_£t_deÁu…_hódî
(
LwqqHâpReque°
 *
ªque°
);

16 *
lwqq_hâp_gë_hódî
(
LwqqHâpReque°
 *
ªque°
, c⁄° *
«me
);

17 *
lwqq_hâp_gë_cookõ
(
LwqqHâpReque°
 *
ªque°
, c⁄° *
«me
);

20 
lwqq_hâp_do_ªque°_async
(
LwqqHâpReque°
 *
ªque°
, 
mëhod
,

21 *
body
, 
LwqqAsyncCÆlback
 
ˇŒback
,

22 *
d©a
);

23 
ev_io_come
(
EV_P_
 
ev_io
* 
w
,
ªvít
);

25 
	$lwqq_hâp_£t_hódî
(
LwqqHâpReque°
 *
ªque°
, c⁄° *
«me
,

26 c⁄° *
vÆue
)

28 i‡(!
ªque°
->
ªq
 || !
«me
 || !
vÆue
)

31 
	`ghâp_£t_hódî
(
ªque°
->
ªq
, 
«me
, 
vÆue
);

32 
	}
}

34 
	$lwqq_hâp_£t_deÁu…_hódî
(
LwqqHâpReque°
 *
ªque°
)

36 
	`lwqq_hâp_£t_hódî
(
ªque°
, "U£r-Agít", 
LWQQ_HTTP_USER_AGENT
);

37 
	`lwqq_hâp_£t_hódî
(
ªque°
, "Accept", "text/html,ápplication/xml;q=0.9, "

40 
	`lwqq_hâp_£t_hódî
(
ªque°
, "Accept-Language", "en-US,zh-CN,zh;q=0.9,en;q=0.8");

41 
	`lwqq_hâp_£t_hódî
(
ªque°
, "Accept-Charset", "GBK, utf-8, utf-16, *;q=0.1");

42 
	`lwqq_hâp_£t_hódî
(
ªque°
, "Accept-Encoding", "deflate, gzip, x-gzip, "

44 
	`lwqq_hâp_£t_hódî
(
ªque°
, "Connection", "Keep-Alive");

45 
	}
}

47 *
	$lwqq_hâp_gë_hódî
(
LwqqHâpReque°
 *
ªque°
, c⁄° *
«me
)

49 i‡(!
«me
) {

50 
	`lwqq_log
(
LOG_ERROR
, "InvalidÖarameter\n");

51  
NULL
;

54 c⁄° *
h
 = 
	`ghâp_gë_hódî
(
ªque°
->
ªq
, 
«me
);

55 i‡(!
h
) {

56  
NULL
;

59  
	`s_°rdup
(
h
);

60 
	}
}

62 *
	$lwqq_hâp_gë_cookõ
(
LwqqHâpReque°
 *
ªque°
, c⁄° *
«me
)

64 i‡(!
«me
) {

65 
	`lwqq_log
(
LOG_ERROR
, "InvalidÖarameter\n");

66  
NULL
;

69 *
cookõ
 = 
	`ghâp_gë_cookõ
(
ªque°
->
ªq
, 
«me
);

70 i‡(!
cookõ
) {

71 
	`lwqq_log
(
LOG_WARNING
, "Nÿcookõ: %s\n", 
«me
);

72  
NULL
;

75 
	`lwqq_log
(
LOG_DEBUG
, "P¨£ Cookõ: %s=%s\n", 
«me
, 
cookõ
);

76  
cookõ
;

77 
	}
}

84 
	$lwqq_hâp_ªque°_‰ì
(
LwqqHâpReque°
 *
ªque°
)

86 i‡(!
ªque°
)

89 i‡(
ªque°
) {

90 
	`s_‰ì
(
ªque°
->
ª•⁄£
);

91 
	`ghâp_ªque°_de°roy
(
ªque°
->
ªq
);

92 
	`s_‰ì
(
ªque°
);

94 
	}
}

103 
LwqqHâpReque°
 *
	$lwqq_hâp_ªque°_√w
(c⁄° *
uri
)

105 i‡(!
uri
) {

106  
NULL
;

109 
LwqqHâpReque°
 *
ªque°
;

110 
ªque°
 = 
	`s_mÆloc0
((*request));

112 
ªque°
->
ªq
 = 
	`ghâp_ªque°_√w
();

113 i‡(!
ªque°
->
ªq
) {

115 
Áûed
;

117 i‡(
	`ghâp_£t_uri
(
ªque°
->
ªq
, (*)
uri
) == -1) {

118 
	`lwqq_log
(
LOG_WARNING
, "InvÆid uri: %s\n", 
uri
);

119 
Áûed
;

122 
ªque°
->
do_ªque°
 = 
lwqq_hâp_do_ªque°
;

123 
ªque°
->
do_ªque°_async
 = 
lwqq_hâp_do_ªque°_async
;

124 
ªque°
->
£t_hódî
 = 
lwqq_hâp_£t_hódî
;

125 
ªque°
->
£t_deÁu…_hódî
 = 
lwqq_hâp_£t_deÁu…_hódî
;

126 
ªque°
->
gë_hódî
 = 
lwqq_hâp_gë_hódî
;

127 
ªque°
->
gë_cookõ
 = 
lwqq_hâp_gë_cookõ
;

128  
ªque°
;

130 
Áûed
:

131 i‡(
ªque°
) {

132 
	`lwqq_hâp_ªque°_‰ì
(
ªque°
);

134  
NULL
;

135 
	}
}

137 *
	$unzlib
(c⁄° *
sour˚
, 
Àn
, *
tŸÆ
, 
isgzù
)

139 
	#CHUNK
 16 * 1024

	)

140 
ªt
;

141 
have
;

142 
z_°ªam
 
°rm
;

143 
out
[
CHUNK
];

144 
tŸÆsize
 = 0;

145 *
de°
 = 
NULL
;

147 i‡(!
sour˚
 || 
Àn
 <0 || !
tŸÆ
)

148  
NULL
;

151 
°rm
.
zÆloc
 = 
Z_NULL
;

152 
°rm
.
z‰ì
 = 
Z_NULL
;

153 
°rm
.
›aque
 = 
Z_NULL
;

154 
°rm
.
avaû_ö
 = 0;

155 
°rm
.
√xt_ö
 = 
Z_NULL
;

157 if(
isgzù
) {

163 
ªt
 = 
	`öÊ©eInô2
(&
°rm
, 47);

165 
ªt
 = 
	`öÊ©eInô
(&
°rm
);

168 i‡(
ªt
 !
Z_OK
) {

169 
	`lwqq_log
(
LOG_ERROR
, "Init zlibÉrror\n");

170  
NULL
;

173 
°rm
.
avaû_ö
 = 
Àn
;

174 
°rm
.
√xt_ö
 = (
Byãf
 *)
sour˚
;

177 
°rm
.
avaû_out
 = 
CHUNK
;

178 
°rm
.
√xt_out
 = 
out
;

179 
ªt
 = 
	`öÊ©e
(&
°rm
, 
Z_NO_FLUSH
);

180 
ªt
) {

181 
Z_STREAM_END
:

183 
Z_BUF_ERROR
:

184 
	`lwqq_log
(
LOG_ERROR
, "UnzlibÉrror\n");

186 
Z_NEED_DICT
:

187 
ªt
 = 
Z_DATA_ERROR
;

189 
Z_DATA_ERROR
:

190 
Z_MEM_ERROR
:

191 
Z_STREAM_ERROR
:

192 
	`lwqq_log
(
LOG_ERROR
, "Ungzù såómÉº‹!", 
°rm
.
msg
);

193 
	`öÊ©eEnd
(&
°rm
);

194 
Áûed
;

196 
have
 = 
CHUNK
 - 
°rm
.
avaû_out
;

197 
tŸÆsize
 +
have
;

198 
de°
 = 
	`s_ªÆloc
(de°, 
tŸÆsize
);

199 
	`mem˝y
(
de°
 + 
tŸÆsize
 - 
have
, 
out
, have);

200 } 
°rm
.
avaû_out
 == 0);

203 ()
	`öÊ©eEnd
(&
°rm
);

204 i‡(
ªt
 !
Z_STREAM_END
) {

205 
Áûed
;

207 *
tŸÆ
 = 
tŸÆsize
;

208  
de°
;

210 
Áûed
:

211 i‡(
de°
) {

212 
	`s_‰ì
(
de°
);

214 
	`lwqq_log
(
LOG_ERROR
, "UnzipÉrror\n");

215  
NULL
;

216 
	}
}

218 *
	$ungzù
(c⁄° *
sour˚
, 
Àn
, *
tŸÆ
)

220  
	`unzlib
(
sour˚
, 
Àn
, 
tŸÆ
, 1);

221 
	}
}

223 
	$lwqq_hâp_do_ªque°
(
LwqqHâpReque°
 *
ªque°
, 
mëhod
, *
body
)

225 i‡(!
ªque°
->
ªq
)

228 
ghâp_°©us
 
°©us
;

229 *
buf
;

230 
have_ªad_byãs
 = 0;

231 
ghâp_ty≥
 
m
;

232 **
ª•
 = &
ªque°
->
ª•⁄£
;

235 i‡(*
ª•
) {

236 
	`s_‰ì
(*
ª•
);

237 *
ª•
 = 
NULL
;

241 i‡(
mëhod
 == 0) {

242 
m
 = 
ghâp_ty≥_gë
;

243 } i‡(
mëhod
 == 1) {

244 
m
 = 
ghâp_ty≥_po°
;

246 
	`lwqq_log
(
LOG_WARNING
, "Wrong http method\n");

247 
Áûed
;

249 i‡(
	`ghâp_£t_ty≥
(
ªque°
->
ªq
, 
m
) == -1) {

250 
	`lwqq_log
(
LOG_WARNING
, "SetÑequestÅypeÉrror\n");

251 
Áûed
;

255 i‡(
m
 =
ghâp_ty≥_po°
 && 
body
) {

256 
	`ghâp_£t_body
(
ªque°
->
ªq
, 
body
, 
	`°æí
(body));

259 i‡(
	`ghâp_¥ï¨e
(
ªque°
->
ªq
)) {

260 
Áûed
;

264 
Àn
 = 0;

265 
°©us
 = 
	`ghâp_¥o˚ss
(
ªque°
->
ªq
);

266 if(
°©us
 =
ghâp_îr‹
) {

267 
	`lwqq_log
(
LOG_ERROR
, "HttpÑequest failed: %s\n",

268 
	`ghâp_gë_îr‹
(
ªque°
->
ªq
));

269 
Áûed
;

272 
buf
 = 
	`ghâp_gë_body
(
ªque°
->
ªq
);

273 i‡(
buf
) {

274 
Àn
 = 
	`ghâp_gë_body_Àn
(
ªque°
->
ªq
);

275 *
ª•
 = 
	`s_ªÆloc
(*ª•, 
have_ªad_byãs
 + 
Àn
);

276 
	`mem˝y
(*
ª•
 + 
have_ªad_byãs
, 
buf
, 
Àn
);

277 
have_ªad_byãs
 +
Àn
;

279 if(
°©us
 =
ghâp_d⁄e
) {

286 i‡(*
ª•
 =
NULL
) {

287 
Áûed
;

291 *
íc_ty≥
 = 
NULL
;

292 
íc_ty≥
 = 
	`lwqq_hâp_gë_hódî
(
ªque°
, "Content-Encoding");

293 i‡(
íc_ty≥
 && 
	`°r°r
(enc_type, "gzip")) {

294 *
outd©a
;

295 
tŸÆ
 = 0;

297 
outd©a
 = 
	`ungzù
(*
ª•
, 
have_ªad_byãs
, &
tŸÆ
);

298 i‡(!
outd©a
) {

299 
	`s_‰ì
(
íc_ty≥
);

300 
Áûed
;

303 
	`s_‰ì
(*
ª•
);

305 *
ª•
 = 
	`s_°rdup
(
outd©a
);

306 
	`s_‰ì
(
outd©a
);

307 
have_ªad_byãs
 = 
tŸÆ
;

309 
	`s_‰ì
(
íc_ty≥
);

312 i‡((*
ª•
)[
have_ªad_byãs
 -1] != '\0') {

314 *
ª•
 = 
	`s_ªÆloc
(*ª•, 
have_ªad_byãs
 + 1);

315 (*
ª•
)[
have_ªad_byãs
] = '\0';

317 
ªque°
->
hâp_code
 = 
	`ghâp_°©us_code
‘eque°->
ªq
);

320 
Áûed
:

321 i‡(*
ª•
) {

322 
	`s_‰ì
(*
ª•
);

323 *
ª•
 = 
NULL
;

326 
	}
}

337 
LwqqHâpReque°
 *
	$lwqq_hâp_¸óã_deÁu…_ªque°
(c⁄° *
uæ
,

338 
LwqqEº‹Code
 *
îr
)

340 
LwqqHâpReque°
 *
ªq
;

342 i‡(!
uæ
) {

343 i‡(
îr
)

344 *
îr
 = 
LWQQ_EC_ERROR
;

345  
NULL
;

348 
ªq
 = 
	`lwqq_hâp_ªque°_√w
(
uæ
);

349 i‡(!
ªq
) {

350 
	`lwqq_log
(
LOG_ERROR
, "Cª©êªque° obje˘ f‹ uæ: %†Áûed\n", 
uæ
);

351 i‡(
îr
)

352 *
îr
 = 
LWQQ_EC_ERROR
;

353  
NULL
;

356 
ªq
->
	`£t_deÁu…_hódî
(req);

357 
	`lwqq_log
(
LOG_DEBUG
, "Cª©êªque° obje˘ f‹ uæ: %†su˚ssfuŒy\n", 
uæ
);

358  
ªq
;

359 
	}
}

363 
	sAsyncW©chD©a


365 
LwqqHâpReque°
 *
	mªque°
;

366 
LwqqAsyncCÆlback
 
	mˇŒback
;

367 *
	md©a
;

368 } 
	tAsyncW©chD©a
;

370 
±hªad_t
 
	glwqq_async_tid
;

371 
±hªad_c⁄d_t
 
	glwqq_async_c⁄d
 = 
PTHREAD_COND_INITIALIZER
;

372 
	glwqq_async_ru¬ög
 = -1;

374 *
	$lwqq_async_thªad
(* 
d©a
)

376 
ev_lo›
* 
lo›
 = 
EV_DEFAULT
;

377 
±hªad_muãx_t
 
muãx
 = 
PTHREAD_MUTEX_INITIALIZER
;

379 
lwqq_async_ru¬ög
 = 1;

380 
	`ev_run
(
lo›
, 0);

381 
lwqq_async_ru¬ög
 = 0;

382 
	`±hªad_muãx_lock
(&
muãx
);

383 
	`±hªad_c⁄d_waô
(&
lwqq_async_c⁄d
, &
muãx
);

384 
	`±hªad_muãx_u∆ock
(&
muãx
);

386 
	}
}

388 
	$ev_io_come
(
EV_P_
 
ev_io
* 
w
,
ªvít
)

390 
AsyncW©chD©a
 *
d
 = (AsyncW©chD©®*)
w
->
d©a
;

391 
LwqqEº‹Code
 
ec
;

392 *
buf
;

393 
LwqqHâpReque°
 *
lhr
 = 
d
->
ªque°
;

394 
ghâp_ªque°
 *
ªq
 = 
lhr
->req;

397 
°©us
 = 
	`ghâp_¥o˚ss
(
ªq
);

398 i‡(
°©us
 =
ghâp_îr‹
) {

399 
ec
 = 
LWQQ_EC_ERROR
;

400 
d⁄e
;

404 
buf
 = 
	`ghâp_gë_body
(
ªq
);

405 i‡(
buf
) {

406 
Àn
;

407 
Àn
 = 
	`ghâp_gë_body_Àn
(
ªq
);

408 
lhr
->
ª•⁄£
 = 
	`s_ªÆloc
÷hr->ª•⁄£,Ühr->
ª•_Àn
 + 
Àn
);

409 
	`mem˝y
(
lhr
->
ª•⁄£
 +Ühr->
ª•_Àn
, 
buf
, 
Àn
);

410 
lhr
->
ª•_Àn
 +
Àn
;

412 i‡(
°©us
 =
ghâp_d⁄e
) {

413 
ec
 = 
LWQQ_EC_OK
;

414 
d⁄e
;

420 
d⁄e
:

421 i‡(
ec
 =
LWQQ_EC_OK
 && 
lhr
->
ª•⁄£
) {

423 *
íc_ty≥
 = 
NULL
;

424 
íc_ty≥
 = 
	`lwqq_hâp_gë_hódî
(
lhr
, "Content-Encoding");

425 i‡(
íc_ty≥
 && 
	`°r°r
(enc_type, "gzip")) {

426 *
outd©a
;

427 
tŸÆ
 = 0;

429 
outd©a
 = 
	`ungzù
(
lhr
->
ª•⁄£
,Ühr->
ª•_Àn
, &
tŸÆ
);

430 i‡(
outd©a
) {

431 
	`s_‰ì
(
lhr
->
ª•⁄£
);

433 
lhr
->
ª•⁄£
 = 
	`s_°rdup
(
outd©a
);

434 
	`s_‰ì
(
outd©a
);

435 
lhr
->
ª•_Àn
 = 
tŸÆ
;

438 
	`s_‰ì
(
íc_ty≥
);

441 i‡(
lhr
->
ª•⁄£
[lhr->
ª•_Àn
 -1] != '\0') {

443 
lhr
->
ª•⁄£
 = 
	`s_ªÆloc
÷hr->ª•⁄£,Ühr->
ª•_Àn
 + 1);

444 
lhr
->
ª•⁄£
[lhr->
ª•_Àn
] = '\0';

449 
d
->
	`ˇŒback
(
ec
, 
lhr
->
ª•⁄£
, d->
d©a
);

452 
	`ev_io_°›
(
EV_DEFAULT
, 
w
);

453 
	`lwqq_hâp_ªque°_‰ì
(
d
->
ªque°
);

454 
	`s_‰ì
(
d
);

455 
	`s_‰ì
(
w
);

456 
	}
}

458 
	$lwqq_hâp_do_ªque°_async
(
LwqqHâpReque°
 *
ªque°
, 
mëhod
,

459 *
body
, 
LwqqAsyncCÆlback
 
ˇŒback
,

460 *
d©a
)

462 
ghâp_ty≥
 
m
;

463 
°©us
;

466 i‡(
mëhod
 == 0) {

467 
m
 = 
ghâp_ty≥_gë
;

468 } i‡(
mëhod
 == 1) {

469 
m
 = 
ghâp_ty≥_po°
;

471 
	`lwqq_log
(
LOG_WARNING
, "Wrong http method\n");

472 
	`lwqq_hâp_ªque°_‰ì
(
ªque°
);

475 i‡(
	`ghâp_£t_ty≥
(
ªque°
->
ªq
, 
m
) == -1) {

476 
	`lwqq_log
(
LOG_WARNING
, "SetÑequestÅypeÉrror\n");

477 
	`lwqq_hâp_ªque°_‰ì
(
ªque°
);

482 i‡(
m
 =
ghâp_ty≥_po°
 && 
body
) {

483 
	`ghâp_£t_body
(
ªque°
->
ªq
, 
body
, 
	`°æí
(body));

486 
	`ghâp_£t_sync
(
ªque°
->
ªq
, 
ghâp_async
);

487 i‡(
	`ghâp_¥ï¨e
(
ªque°
->
ªq
)) {

488 
	`lwqq_hâp_ªque°_‰ì
(
ªque°
);

492 
°©us
 = 
	`ghâp_¥o˚ss
(
ªque°
->
ªq
);

493 i‡(
°©us
 !
ghâp_nŸ_d⁄e
){

494 
	`lwqq_log
(
LOG_ERROR
, "BUG!!!asyncÉrror\n");

495 
	`lwqq_hâp_ªque°_‰ì
(
ªque°
);

499 
ev_io
 *
w©chî
 = (ev_iÿ*)
	`s_mÆloc
((ev_io));

501 
ghâp_ªque°
* 
ªq
 = (ghâp_ªque°*)
ªque°
->req;

503 
	`ev_io_öô
(
w©chî
, 
ev_io_come
, 
	`ghâp_gë_sockë
(
ªq
), 
EV_READ
);

504 
AsyncW©chD©a
 *
d
 = 
	`s_mÆloc
((AsyncWatchData));

505 
d
->
ªque°
 =Ñequest;

506 
d
->
ˇŒback
 = callback;

507 
d
->
d©a
 = data;

508 
w©chî
->
d©a
 = 
d
;

510 
	`ev_io_°¨t
(
EV_DEFAULT
, 
w©chî
);

512 i‡(
lwqq_async_ru¬ög
 == -1) {

513 
lwqq_async_ru¬ög
 = 1;

514 
	`±hªad_¸óã
(&
lwqq_async_tid
, 
NULL
, 
lwqq_async_thªad
, NULL);

515 } if(
lwqq_async_ru¬ög
 == 0) {

516 
	`±hªad_c⁄d_sig«l
(&
lwqq_async_c⁄d
);

520 
	}
}

523 
	$maö
(
¨gc
, *
¨gv
[])

525 i‡(
¨gc
 != 2)

528 *
uri
 = 
¨gv
[1];

529 
LwqqHâpReque°
 *
ªq
 = 
	`lwqq_hâp_ªque°_√w
(
uri
);

530 i‡(
ªq
) {

531 
ªt
 = 0;

532 
ªt
 = 
ªq
->
	`do_ªque°
‘eq, 0, 
NULL
);

533 
ªt
 = 
ªq
->
	`do_ªque°
‘eq, 0, 
NULL
);

534 
ªt
 = 
ªq
->
	`do_ªque°
‘eq, 0, 
NULL
);

535 
ªt
 = 
ªq
->
	`do_ªque°
‘eq, 0, 
NULL
);

536 i‡(
ªt
 == 0) {

537 
	`lwqq_log
(
LOG_NOTICE
, "Hâ∞ª•⁄£ code: %d\n", 
ªq
->
hâp_code
);

538 
	`lwqq_log
("LOG_NOTICE, Hâ∞ª•⁄£ buf: %s\n", 
ªq
->
ª•⁄£
);

540 
	`lwqq_hâp_ªque°_‰ì
(
ªq
);

544 
	}
}

	@src/liblwqq/http.h

11 #i‚de‡
LWQQ_HTTP_H


12 
	#LWQQ_HTTP_H


	)

14 
	~"ty≥.h
"

16 (*
	tLwqqAsyncCÆlback
)(
	tLwqqEº‹Code
 
	tec
, *
	tª•⁄£
, * 
	td©a
);

23 
	sLwqqHâpReque°
 {

24 *
ªq
;

30 
hâp_code
;

33 *
ª•⁄£
;

36 
ª•_Àn
;

42 (*
do_ªque°
)(
LwqqHâpReque°
 *
ªque°
, 
mëhod
, *
body
);

48 (*
do_ªque°_async
)(
LwqqHâpReque°
 *
ªque°
, 
mëhod
,

49 *
body
, 
LwqqAsyncCÆlback
 
ˇŒback
, *
d©a
);

52 (*
£t_hódî
)(
LwqqHâpReque°
 *
ªque°
, c⁄° *
«me
,

53 c⁄° *
vÆue
);

56 (*
£t_deÁu…_hódî
)(
LwqqHâpReque°
 *
ªque°
);

62 * (*
gë_hódî
)(
LwqqHâpReque°
 *
ªque°
, c⁄° *
«me
);

68 * (*
gë_cookõ
)(
LwqqHâpReque°
 *
ªque°
, c⁄° *
«me
);

70 } 
	tLwqqHâpReque°
;

77 
	`lwqq_hâp_ªque°_‰ì
(
LwqqHâpReque°
 *
ªque°
);

86 
LwqqHâpReque°
 *
	`lwqq_hâp_ªque°_√w
(c⁄° *
uri
);

97 
LwqqHâpReque°
 *
	`lwqq_hâp_¸óã_deÁu…_ªque°
(c⁄° *
uæ
,

98 
LwqqEº‹Code
 *
îr
);

	@src/liblwqq/http_curl.c

11 #ifde‡
USE_ASYNC_HTTP


	@src/liblwqq/info.c

11 
	~<°rög.h
>

12 
	~<°dlib.h
>

13 
	~"öfo.h
"

14 
	~"uæ.h
"

15 
	~"loggî.h
"

16 
	~"hâp.h
"

17 
	~"smem‹y.h
"

18 
	~"js⁄.h
"

20 
js⁄_t
 *
gë_ªsu…_js⁄_obje˘
(js⁄_à*
js⁄
);

21 
¸óã_po°_d©a
(
LwqqClõ¡
 *
lc
, *
buf
, 
buÊí
);

22 *
gë_‰õnd_qqnumbî
(
LwqqClõ¡
 *
lc
, c⁄° *
uö
);

23 *
gë_group_qqnumbî
(
LwqqClõ¡
 *
lc
, c⁄° *
code
);

32 
js⁄_t
 *
	$gë_ªsu…_js⁄_obje˘
(
js⁄_t
 *
js⁄
)

34 
js⁄_t
 *
js⁄_tmp
;

35 *
vÆue
;

41 
vÆue
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, "retcode");

42 i‡(!
vÆue
 || 
	`°rcmp
(value, "0")) {

43 
Áûed
 ;

49 
js⁄_tmp
 = 
	`js⁄_föd_fú°_œbñ_Æl
(
js⁄
, "result");

50 i‡(!
js⁄_tmp
) {

51 
Áûed
;

54  
js⁄_tmp
;

56 
Áûed
:

57  
NULL
;

58 
	}
}

67 
	$¸óã_po°_d©a
(
LwqqClõ¡
 *
lc
, *
buf
, 
buÊí
)

69 *
s
;

70 
m
[256];

71 
	`¢¥ötf
(
m
, (m), "{\"h\":\"hello\",\"vfwebqq\":\"%s\"}",

72 
lc
->
vfwebqq
);

73 
s
 = 
	`uæ_ícode
(
m
);

74 
	`¢¥ötf
(
buf
, 
buÊí
, "r=%s", 
s
);

75 
	`s_‰ì
(
s
);

76 
	}
}

84 
	$∑r£_ˇãg‹õs_chûd
(
LwqqClõ¡
 *
lc
, 
js⁄_t
 *
js⁄
)

86 
LwqqFrõndC©eg‹y
 *
ˇã
;

87 
js⁄_t
 *
cur
;

88 *
ödex
, *
s‹t
, *
«me
;

91 
js⁄
) {

92 i‡(
js⁄
->
ãxt
 && !
	`°rcmp
(json->text, "categories")) {

95 
js⁄
 = js⁄->
√xt
;

97 i‡(!
js⁄
) {

101 
js⁄
 = js⁄->
chûd
;

102 
cur
 = 
js⁄
->
chûd
; cu∏!
NULL
; cu∏cur->
√xt
) {

103 
ödex
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "index");

104 
s‹t
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "sort");

105 
«me
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "name");

106 
ˇã
 = 
	`s_mÆloc0
((*cate));

107 i‡(
ödex
) {

108 
ˇã
->
ödex
 = 
	`©oi
(index);

110 i‡(
s‹t
) {

111 
ˇã
->
s‹t
 = 
	`©oi
(sort);

113 i‡(
«me
) {

114 
ˇã
->
«me
 = 
	`s_°rdup
(name);

118 
	`LIST_INSERT_HEAD
(&
lc
->
ˇãg‹õs
, 
ˇã
, 
íåõs
);

122 
ˇã
 = 
	`s_mÆloc0
((*cate));

123 
ˇã
->
ödex
 = 0;

124 
ˇã
->
«me
 = 
	`s_°rdup
("My Friends");

125 
	`LIST_INSERT_HEAD
(&
lc
->
ˇãg‹õs
, 
ˇã
, 
íåõs
);

126 
	}
}

134 
	$∑r£_öfo_chûd
(
LwqqClõ¡
 *
lc
, 
js⁄_t
 *
js⁄
)

136 
LwqqBuddy
 *
buddy
;

137 
js⁄_t
 *
cur
;

140 
js⁄
) {

141 i‡(
js⁄
->
ãxt
 && !
	`°rcmp
(json->text, "info")) {

144 
js⁄
 = js⁄->
√xt
;

146 i‡(!
js⁄
) {

150 
js⁄
 = js⁄->
chûd
;

151 
cur
 = 
js⁄
->
chûd
; cu∏!
NULL
; cu∏cur->
√xt
) {

152 
buddy
 = 
	`lwqq_buddy_√w
();

153 
buddy
->
Á˚
 = 
	`s_°rdup
(
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "face"));

154 
buddy
->
Êag
 = 
	`s_°rdup
(
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "flag"));

155 
buddy
->
nick
 = 
	`s_°rdup
(
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "nick"));

156 
buddy
->
uö
 = 
	`s_°rdup
(
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "uin"));

159 
	`LIST_INSERT_HEAD
(&
lc
->
‰õnds
, 
buddy
, 
íåõs
);

161 
	}
}

169 
	$∑r£_m¨k«mes_chûd
(
LwqqClõ¡
 *
lc
, 
js⁄_t
 *
js⁄
)

171 
LwqqBuddy
 *
buddy
;

172 *
uö
, *
m¨k«me
;

173 
js⁄_t
 *
cur
;

176 
js⁄
) {

177 i‡(
js⁄
->
ãxt
 && !
	`°rcmp
(json->text, "marknames")) {

180 
js⁄
 = js⁄->
√xt
;

182 i‡(!
js⁄
) {

186 
js⁄
 = js⁄->
chûd
;

187 
cur
 = 
js⁄
->
chûd
; cu∏!
NULL
; cu∏cur->
√xt
) {

188 
uö
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "uin");

189 
m¨k«me
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "markname");

190 i‡(!
uö
 || !
m¨k«me
)

193 
buddy
 = 
	`lwqq_buddy_föd_buddy_by_uö
(
lc
, 
uö
);

194 i‡(!
buddy
)

198 i‡(
buddy
->
m¨k«me
)

199 
	`s_‰ì
(
buddy
->
m¨k«me
);

200 
buddy
->
m¨k«me
 = 
	`s_°rdup
(markname);

202 
	}
}

210 
	$∑r£_‰õnds_chûd
(
LwqqClõ¡
 *
lc
, 
js⁄_t
 *
js⁄
)

212 
LwqqBuddy
 *
buddy
;

213 *
uö
, *
ˇã_ödex
;

214 
js⁄_t
 *
cur
;

217 
js⁄
) {

218 i‡(
js⁄
->
ãxt
 && !
	`°rcmp
(json->text, "friends")) {

221 
js⁄
 = js⁄->
√xt
;

223 i‡(!
js⁄
) {

228 
js⁄
 = js⁄->
chûd
;

229 
cur
 = 
js⁄
->
chûd
; cu∏!
NULL
; cu∏cur->
√xt
) {

230 
LwqqFrõndC©eg‹y
 *
c_íåy
;

231 
uö
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "uin");

232 
ˇã_ödex
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "categories");

233 i‡(!
uö
 || !
ˇã_ödex
)

236 
buddy
 = 
	`lwqq_buddy_föd_buddy_by_uö
(
lc
, 
uö
);

237 i‡(!
buddy
)

240 
	`LIST_FOREACH
(
c_íåy
, &
lc
->
ˇãg‹õs
, 
íåõs
) {

241 i‡(
c_íåy
->
ödex
 =
	`©oi
(
ˇã_ödex
)) {

242 
c_íåy
->
cou¡
++;

245 
buddy
->
ˇã_ödex
 = 
	`s_°rdup
(cate_index);

247 
	}
}

256 
	$lwqq_öfo_gë_‰õnds_öfo
(
LwqqClõ¡
 *
lc
, 
LwqqEº‹Code
 *
îr
)

258 
msg
[256] ={0};

259 
LwqqHâpReque°
 *
ªq
 = 
NULL
;

260 
ªt
;

261 
js⁄_t
 *
js⁄
 = 
NULL
, *
js⁄_tmp
;

262 *
cookõs
;

265 
	`¸óã_po°_d©a
(
lc
, 
msg
, (msg));

268 
uæ
[512];

269 
	`¢¥ötf
(
uæ
, (url), "%s/api/get_user_friends2", "http://s.web2.qq.com");

270 
ªq
 = 
	`lwqq_hâp_¸óã_deÁu…_ªque°
(
uæ
, 
îr
);

271 i‡(!
ªq
) {

272 
d⁄e
;

274 
ªq
->
	`£t_hódî
(req, "Referer", "http://s.web2.qq.com/proxy.html?v=20101025002");

275 
ªq
->
	`£t_hódî
(req, "Content-Transfer-Encoding", "binary");

276 
ªq
->
	`£t_hódî
(req, "Content-type", "application/x-www-form-urlencoded");

277 
cookõs
 = 
	`lwqq_gë_cookõs
(
lc
);

278 i‡(
cookõs
) {

279 
ªq
->
	`£t_hódî
‘eq, "Cookõ", 
cookõs
);

280 
	`s_‰ì
(
cookõs
);

282 
ªt
 = 
ªq
->
	`do_ªque°
‘eq, 1, 
msg
);

283 i‡(
ªt
 || 
ªq
->
hâp_code
 != 200) {

284 i‡(
îr
)

285 *
îr
 = 
LWQQ_EC_HTTP_ERROR
;

286 
d⁄e
;

294 
ªt
 = 
	`js⁄_∑r£_documít
(&
js⁄
, 
ªq
->
ª•⁄£
);

295 i‡(
ªt
 !
JSON_OK
) {

296 
	`lwqq_log
(
LOG_ERROR
, "P¨£ js⁄ obje˘ o‡‰õnd†îr‹: %s\n", 
ªq
->
ª•⁄£
);

297 i‡(
îr
)

298 *
îr
 = 
LWQQ_EC_ERROR
;

299 
d⁄e
;

302 
js⁄_tmp
 = 
	`gë_ªsu…_js⁄_obje˘
(
js⁄
);

303 i‡(!
js⁄_tmp
) {

304 
	`lwqq_log
(
LOG_ERROR
, "P¨£ js⁄ obje˘Éº‹: %s\n", 
ªq
->
ª•⁄£
);

305 
js⁄_îr‹
;

310 i‡(
js⁄_tmp
->
chûd
 && json_tmp->child->child ) {

311 
js⁄_tmp
 = js⁄_tmp->
chûd
->child;

314 
	`∑r£_ˇãg‹õs_chûd
(
lc
, 
js⁄_tmp
);

322 
	`∑r£_öfo_chûd
(
lc
, 
js⁄_tmp
);

323 
	`∑r£_m¨k«mes_chûd
(
lc
, 
js⁄_tmp
);

324 
	`∑r£_‰õnds_chûd
(
lc
, 
js⁄_tmp
);

327 
d⁄e
:

328 i‡(
js⁄
)

329 
	`js⁄_‰ì_vÆue
(&
js⁄
);

330 
	`lwqq_hâp_ªque°_‰ì
(
ªq
);

333 
js⁄_îr‹
:

334 i‡(
îr
)

335 *
îr
 = 
LWQQ_EC_ERROR
;

337 i‡(
js⁄
)

338 
	`js⁄_‰ì_vÆue
(&
js⁄
);

339 
	`lwqq_hâp_ªque°_‰ì
(
ªq
);

340 
	}
}

353 
	$∑r£_groups_g«mñi°_chûd
(
LwqqClõ¡
 *
lc
, 
js⁄_t
 *
js⁄
)

355 
LwqqGroup
 *
group
;

356 
js⁄_t
 *
cur
;

359 
js⁄
) {

360 i‡(
js⁄
->
ãxt
 && !
	`°rcmp
(json->text, "gnamelist")) {

363 
js⁄
 = js⁄->
√xt
;

365 i‡(!
js⁄
) {

369 
js⁄
 = js⁄->
chûd
;

370 
cur
 = 
js⁄
->
chûd
; cu∏!
NULL
; cu∏cur->
√xt
) {

371 
group
 = 
	`lwqq_group_√w
();

372 
group
->
Êag
 = 
	`s_°rdup
(
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "flag"));

373 
group
->
«me
 = 
	`s_°rdup
(
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "name"));

374 
group
->
gid
 = 
	`s_°rdup
(
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "gid"));

375 
group
->
code
 = 
	`s_°rdup
(
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "code"));

378 
group
->
accou¡
 = 
	`gë_group_qqnumbî
(
lc
, group->
code
);

381 
	`LIST_INSERT_HEAD
(&
lc
->
groups
, 
group
, 
íåõs
);

383 
	}
}

393 
	$∑r£_groups_gm¨kli°_chûd
(
LwqqClõ¡
 *
lc
, 
js⁄_t
 *
js⁄
)

395 
LwqqGroup
 *
group
;

396 
js⁄_t
 *
cur
;

397 *
uö
;

398 *
m¨k«me
;

401 
js⁄
) {

402 i‡(
js⁄
->
ãxt
 && !
	`°rcmp
(json->text, "gmarklist")) {

405 
js⁄
 = js⁄->
√xt
;

407 i‡(!
js⁄
) {

411 
js⁄
 = js⁄->
chûd
;

412 
cur
 = 
js⁄
->
chûd
; cu∏!
NULL
; cu∏cur->
√xt
) {

413 
uö
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "uin");

414 
m¨k«me
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "markname");

416 i‡(!
uö
 || !
m¨k«me
)

418 
group
 = 
	`lwqq_group_föd_group_by_gid
(
lc
, 
uö
);

419 i‡(!
group
)

421 
group
->
m¨k«me
 = 
	`s_°rdup
(markname);

423 
	}
}

431 
	$lwqq_öfo_gë_group_«me_li°
(
LwqqClõ¡
 *
lc
, 
LwqqEº‹Code
 *
îr
)

434 
	`lwqq_log
(
LOG_DEBUG
, "in function.");

436 
msg
[256];

437 
uæ
[512];

438 
LwqqHâpReque°
 *
ªq
 = 
NULL
;

439 
ªt
;

440 
js⁄_t
 *
js⁄
 = 
NULL
, *
js⁄_tmp
;

441 *
cookõs
;

444 
	`¸óã_po°_d©a
(
lc
, 
msg
, (msg));

447 
	`¢¥ötf
(
uæ
, (url), "%s/api/get_group_name_list_mask2", "http://s.web2.qq.com");

448 
ªq
 = 
	`lwqq_hâp_¸óã_deÁu…_ªque°
(
uæ
, 
îr
);

449 i‡(!
ªq
) {

450 
d⁄e
;

452 
ªq
->
	`£t_hódî
(req, "Referer", "http://s.web2.qq.com/proxy.html?v=20101025002");

453 
ªq
->
	`£t_hódî
(req, "Content-Transfer-Encoding", "binary");

454 
ªq
->
	`£t_hódî
(req, "Content-type", "application/x-www-form-urlencoded");

455 
cookõs
 = 
	`lwqq_gë_cookõs
(
lc
);

456 i‡(
cookõs
) {

457 
ªq
->
	`£t_hódî
‘eq, "Cookõ", 
cookõs
);

458 
	`s_‰ì
(
cookõs
);

460 
ªt
 = 
ªq
->
	`do_ªque°
‘eq, 1, 
msg
);

461 i‡(
ªt
 || 
ªq
->
hâp_code
 != 200) {

462 i‡(
îr
)

463 *
îr
 = 
LWQQ_EC_HTTP_ERROR
;

464 
d⁄e
;

478 
ªt
 = 
	`js⁄_∑r£_documít
(&
js⁄
, 
ªq
->
ª•⁄£
);

479 i‡(
ªt
 !
JSON_OK
) {

480 
	`lwqq_log
(
LOG_ERROR
, "P¨£ js⁄ obje˘ o‡group†îr‹: %s\n", 
ªq
->
ª•⁄£
);

481 i‡(
îr
)

482 *
îr
 = 
LWQQ_EC_ERROR
;

483 
d⁄e
;

486 
js⁄_tmp
 = 
	`gë_ªsu…_js⁄_obje˘
(
js⁄
);

487 i‡(!
js⁄_tmp
) {

488 
	`lwqq_log
(
LOG_ERROR
, "P¨£ js⁄ obje˘Éº‹: %s\n", 
ªq
->
ª•⁄£
);

489 
js⁄_îr‹
;

495 i‡(
js⁄_tmp
->
chûd
 && json_tmp->child->child ) {

496 
js⁄_tmp
 = js⁄_tmp->
chûd
->child;

499 
	`∑r£_groups_g«mñi°_chûd
(
lc
, 
js⁄_tmp
);

500 
	`∑r£_groups_gm¨kli°_chûd
(
lc
, 
js⁄_tmp
);

504 
d⁄e
:

505 i‡(
js⁄
)

506 
	`js⁄_‰ì_vÆue
(&
js⁄
);

507 
	`lwqq_hâp_ªque°_‰ì
(
ªq
);

510 
js⁄_îr‹
:

511 i‡(
îr
)

512 *
îr
 = 
LWQQ_EC_ERROR
;

514 i‡(
js⁄
)

515 
	`js⁄_‰ì_vÆue
(&
js⁄
);

516 
	`lwqq_hâp_ªque°_‰ì
(
ªq
);

517 
	}
}

525 
	$lwqq_öfo_gë_Æl_‰õnd_qqnumbîs
(
LwqqClõ¡
 *
lc
, 
LwqqEº‹Code
 *
îr
)

527 
LwqqBuddy
 *
buddy
;

529 i‡(!
lc
)

532 
	`LIST_FOREACH
(
buddy
, &
lc
->
‰õnds
, 
íåõs
) {

533 i‡(!
buddy
->
qqnumbî
) {

537 
buddy
->
qqnumbî
 = 
	`gë_‰õnd_qqnumbî
(
lc
, buddy->
uö
);

538 
	`lwqq_log
(
LOG_DEBUG
, "Gë buddy qqnumbî: %s\n", 
buddy
->
qqnumbî
);

542 i‡(
îr
) {

543 *
îr
 = 
LWQQ_EC_OK
;

545 
	}
}

556 *
	$lwqq_öfo_gë_‰õnd_qqnumbî
(
LwqqClõ¡
 *
lc
, c⁄° *
uö
)

558  
	`gë_‰õnd_qqnumbî
(
lc
, 
uö
);

559 
	}
}

576 
	$∑r£_groups_göfo_chûd
(
LwqqClõ¡
 *
lc
, 
LwqqGroup
 *
group
, 
js⁄_t
 *
js⁄
)

578 *
gid
;

581 
js⁄
) {

582 i‡(
js⁄
->
ãxt
 && !
	`°rcmp
(json->text, "ginfo")) {

585 
js⁄
 = js⁄->
√xt
;

587 i‡(!
js⁄
) {

592 
gid
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
,"gid");

593 i‡(
	`°rcmp
(
group
->
gid
, gid) != 0) {

594 
	`lwqq_log
(
LOG_ERROR
, "Parse json objectÉrror.");

598 
	#SET_GINFO
(
key
, 
«me
) { \

599 i‡(
group
->
key
) { \

600 
	`s_‰ì
(
group
->
key
); \

602 
group
->
key
 = 
	`s_°rdup
(
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, 
«me
)); \

603 }

	)

606 
	`SET_GINFO
(
Á˚
, "face");

607 
	`SET_GINFO
(
memo
, "memo");

608 
	`SET_GINFO
(
˛ass
, "class");

609 
	`SET_GINFO
(
fögîmemo
,"fingermemo");

611 
	`SET_GINFO
(
¸óãtime
, "createtime");

612 
	`SET_GINFO
(
Êag
, "flag");

613 
	`SET_GINFO
(
Àvñ
, "level");

616 
	`SET_GINFO
(
ow√r
, "owner");

617 
	`SET_GINFO
(
›ti⁄
, "option");

619 #unde‡
SET_GINFO


621 
	}
}

635 
	$∑r£_groups_möfo_chûd
(
LwqqClõ¡
 *
lc
, 
LwqqGroup
 *
group
, 
js⁄_t
 *
js⁄
)

637 
LwqqBuddy
 *
membî
;

638 
js⁄_t
 *
cur
;

639 *
uö
;

640 *
nick
;

643 
js⁄
) {

644 i‡(
js⁄
->
ãxt
 && !
	`°rcmp
(json->text, "minfo")) {

647 
js⁄
 = js⁄->
√xt
;

649 i‡(!
js⁄
) {

653 
js⁄
 = js⁄->
chûd
;

654 
cur
 = 
js⁄
->
chûd
; cu∏!
NULL
; cu∏cur->
√xt
) {

655 
uö
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "uin");

656 
nick
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "nick");

658 i‡(!
uö
 || !
nick
)

660 
membî
 = 
	`lwqq_buddy_√w
();

662 
membî
->
uö
 = 
	`s_°rdup
(uin);

663 
membî
->
nick
 = 
	`s_°rdup
(nick);

667 
membî
->
qqnumbî
 = 
	`gë_‰õnd_qqnumbî
(
lc
, membî->
uö
);

670 
	`LIST_INSERT_HEAD
(&
group
->
membîs
, 
membî
, 
íåõs
);

672 
	}
}

683 
	$∑r£_groups_°©s_chûd
(
LwqqClõ¡
 *
lc
, 
LwqqGroup
 *
group
, 
js⁄_t
 *
js⁄
)

685 
LwqqBuddy
 *
membî
;

686 
js⁄_t
 *
cur
;

687 *
uö
;

690 
js⁄
) {

691 i‡(
js⁄
->
ãxt
 && !
	`°rcmp
(json->text, "stats")) {

694 
js⁄
 = js⁄->
√xt
;

696 i‡(!
js⁄
) {

700 
js⁄
 = js⁄->
chûd
;

701 
cur
 = 
js⁄
->
chûd
; cu∏!
NULL
; cu∏cur->
√xt
) {

702 
uö
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "uin");

704 i‡(!
uö
)

706 
membî
 = 
	`lwqq_group_föd_group_membî_by_uö
(
group
, 
uö
);

707 i‡(!
membî
)

709 
membî
->
˛õ¡_ty≥
 = 
	`s_°rdup
(
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "client_type"));

710 
membî
->
°©
 = 
	`s_°rdup
(
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "stat"));

713 
	}
}

722 
	$lwqq_öfo_gë_group_dëaû_öfo
(
LwqqClõ¡
 *
lc
, 
LwqqGroup
 *
group
,

723 
LwqqEº‹Code
 *
îr
)

725 
	`lwqq_log
(
LOG_DEBUG
, "in function.");

727 
uæ
[512];

728 
LwqqHâpReque°
 *
ªq
 = 
NULL
;

729 
ªt
;

730 
js⁄_t
 *
js⁄
 = 
NULL
, *
js⁄_tmp
;

731 *
cookõs
;

733 i‡(!
lc
 || ! 
group
) {

738 i‡(!
group
->
code
) {

739 i‡(
îr
)

740 *
îr
 = 
LWQQ_EC_NULL_POINTER
;

745 
	`¢¥ötf
(
uæ
, (url),

747 "hâp://s.web2.qq.com", 
group
->
code
, 
lc
->
vfwebqq
);

748 
ªq
 = 
	`lwqq_hâp_¸óã_deÁu…_ªque°
(
uæ
, 
îr
);

749 i‡(!
ªq
) {

750 
d⁄e
;

752 
ªq
->
	`£t_hódî
(req, "Referer", "http://s.web2.qq.com/proxy.html?v=20101025002");

753 
ªq
->
	`£t_hódî
(req, "Content-Transfer-Encoding", "binary");

754 
ªq
->
	`£t_hódî
(req, "Content-type", "utf-8");

755 
cookõs
 = 
	`lwqq_gë_cookõs
(
lc
);

756 i‡(
cookõs
) {

757 
ªq
->
	`£t_hódî
‘eq, "Cookõ", 
cookõs
);

758 
	`s_‰ì
(
cookõs
);

760 
ªt
 = 
ªq
->
	`do_ªque°
‘eq, 0, 
NULL
);

761 i‡(
ªt
 || 
ªq
->
hâp_code
 != 200) {

762 i‡(
îr
)

763 *
îr
 = 
LWQQ_EC_HTTP_ERROR
;

764 
d⁄e
;

786 
ªt
 = 
	`js⁄_∑r£_documít
(&
js⁄
, 
ªq
->
ª•⁄£
);

787 i‡(
ªt
 !
JSON_OK
) {

788 
	`lwqq_log
(
LOG_ERROR
, "P¨£ js⁄ obje˘ o‡group†îr‹: %s\n", 
ªq
->
ª•⁄£
);

789 i‡(
îr
)

790 *
îr
 = 
LWQQ_EC_ERROR
;

791 
d⁄e
;

794 
js⁄_tmp
 = 
	`gë_ªsu…_js⁄_obje˘
(
js⁄
);

795 i‡(!
js⁄_tmp
) {

796 
	`lwqq_log
(
LOG_ERROR
, "P¨£ js⁄ obje˘Éº‹: %s\n", 
ªq
->
ª•⁄£
);

797 
js⁄_îr‹
;

803 i‡(
js⁄_tmp
->
chûd
 && json_tmp->child->child ) {

804 
js⁄_tmp
 = js⁄_tmp->
chûd
->child;

807 
	`∑r£_groups_göfo_chûd
(
lc
, 
group
, 
js⁄_tmp
);

809 
	`∑r£_groups_möfo_chûd
(
lc
, 
group
, 
js⁄_tmp
);

811 
	`∑r£_groups_°©s_chûd
(
lc
, 
group
, 
js⁄_tmp
);

815 
d⁄e
:

816 i‡(
js⁄
)

817 
	`js⁄_‰ì_vÆue
(&
js⁄
);

818 
	`lwqq_hâp_ªque°_‰ì
(
ªq
);

821 
js⁄_îr‹
:

822 i‡(
îr
)

823 *
îr
 = 
LWQQ_EC_ERROR
;

825 i‡(
js⁄
)

826 
	`js⁄_‰ì_vÆue
(&
js⁄
);

827 
	`lwqq_hâp_ªque°_‰ì
(
ªq
);

828 
	}
}

838 *
	$gë_‰õnd_qqnumbî
(
LwqqClõ¡
 *
lc
, c⁄° *
uö
)

840 i‡(!
lc
 || !
uö
) {

841  
NULL
;

844 
uæ
[512];

845 
LwqqHâpReque°
 *
ªq
 = 
NULL
;

846 
ªt
;

847 
js⁄_t
 *
js⁄
 = 
NULL
;

848 *
qqnumbî
 = 
NULL
;

849 *
cookõs
;

851 i‡(!
lc
 || ! 
uö
) {

852  
NULL
;

858 
	`¢¥ötf
(
uæ
, (url),

860 "hâp://s.web2.qq.com", 
uö
, 
lc
->
vfwebqq
);

861 
ªq
 = 
	`lwqq_hâp_¸óã_deÁu…_ªque°
(
uæ
, 
NULL
);

862 i‡(!
ªq
) {

863 
d⁄e
;

865 
ªq
->
	`£t_hódî
(req, "Referer", "http://s.web2.qq.com/proxy.html?v=20101025002");

866 
ªq
->
	`£t_hódî
(req, "Content-Transfer-Encoding", "binary");

867 
ªq
->
	`£t_hódî
(req, "Content-type", "utf-8");

868 
cookõs
 = 
	`lwqq_gë_cookõs
(
lc
);

869 i‡(
cookõs
) {

870 
ªq
->
	`£t_hódî
‘eq, "Cookõ", 
cookõs
);

871 
	`s_‰ì
(
cookõs
);

873 
ªt
 = 
ªq
->
	`do_ªque°
‘eq, 0, 
NULL
);

874 i‡(
ªt
 || 
ªq
->
hâp_code
 != 200) {

875 
d⁄e
;

883 
ªt
 = 
	`js⁄_∑r£_documít
(&
js⁄
, 
ªq
->
ª•⁄£
);

884 i‡(
ªt
 !
JSON_OK
) {

885 
	`lwqq_log
(
LOG_ERROR
, "P¨£ js⁄ obje˘ o‡group†îr‹: %s\n", 
ªq
->
ª•⁄£
);

886 
d⁄e
;

889 
qqnumbî
 = 
	`s_°rdup
(
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, "account"));

891 
d⁄e
:

893 i‡(
js⁄
)

894 
	`js⁄_‰ì_vÆue
(&
js⁄
);

895 
	`lwqq_hâp_ªque°_‰ì
(
ªq
);

896  
qqnumbî
;

897 
	}
}

907 *
	$gë_group_qqnumbî
(
LwqqClõ¡
 *
lc
, c⁄° *
code
)

909  
	`gë_‰õnd_qqnumbî
(
lc
, 
code
);

910 
	}
}

921 
	$lwqq_öfo_gë_‰õnd_dëaû_öfo
(
LwqqClõ¡
 *
lc
, 
LwqqBuddy
 *
buddy
,

922 
LwqqEº‹Code
 *
îr
)

924 
	`lwqq_log
(
LOG_DEBUG
, "in function.");

926 
uæ
[512];

927 
LwqqHâpReque°
 *
ªq
 = 
NULL
;

928 
ªt
;

929 
js⁄_t
 *
js⁄
 = 
NULL
, *
js⁄_tmp
;

930 *
cookõs
;

932 i‡(!
lc
 || ! 
buddy
) {

937 i‡(!
buddy
->
uö
) {

938 i‡(
îr
)

939 *
îr
 = 
LWQQ_EC_NULL_POINTER
;

944 
	`¢¥ötf
(
uæ
, (url),

946 "hâp://s.web2.qq.com", 
buddy
->
uö
, 
lc
->
vfwebqq
);

947 
ªq
 = 
	`lwqq_hâp_¸óã_deÁu…_ªque°
(
uæ
, 
îr
);

948 i‡(!
ªq
) {

949 
d⁄e
;

951 
ªq
->
	`£t_hódî
(req, "Referer", "http://s.web2.qq.com/proxy.html?v=20101025002");

952 
ªq
->
	`£t_hódî
(req, "Content-Transfer-Encoding", "binary");

953 
ªq
->
	`£t_hódî
(req, "Content-type", "utf-8");

954 
cookõs
 = 
	`lwqq_gë_cookõs
(
lc
);

955 i‡(
cookõs
) {

956 
ªq
->
	`£t_hódî
‘eq, "Cookõ", 
cookõs
);

957 
	`s_‰ì
(
cookõs
);

959 
ªt
 = 
ªq
->
	`do_ªque°
‘eq, 0, 
NULL
);

960 i‡(
ªt
 || 
ªq
->
hâp_code
 != 200) {

961 i‡(
îr
)

962 *
îr
 = 
LWQQ_EC_HTTP_ERROR
;

963 
d⁄e
;

978 
ªt
 = 
	`js⁄_∑r£_documít
(&
js⁄
, 
ªq
->
ª•⁄£
);

979 i‡(
ªt
 !
JSON_OK
) {

980 
	`lwqq_log
(
LOG_ERROR
, "P¨£ js⁄ obje˘ o‡group†îr‹: %s\n", 
ªq
->
ª•⁄£
);

981 i‡(
îr
)

982 *
îr
 = 
LWQQ_EC_ERROR
;

983 
d⁄e
;

986 
js⁄_tmp
 = 
	`gë_ªsu…_js⁄_obje˘
(
js⁄
);

987 i‡(!
js⁄_tmp
) {

988 
	`lwqq_log
(
LOG_ERROR
, "P¨£ js⁄ obje˘Éº‹: %s\n", 
ªq
->
ª•⁄£
);

989 
js⁄_îr‹
;

995 i‡(
js⁄_tmp
->
chûd
) {

996 
js⁄_tmp
 = js⁄_tmp->
chûd
;

997 
	#SET_BUDDY_INFO
(
key
, 
«me
) { \

998 i‡(
buddy
->
key
) { \

999 
	`s_‰ì
(
buddy
->
key
); \

1001 
buddy
->
key
 = 
	`s_°rdup
(
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, 
«me
)); \

1002 }

	)

1003 
	`SET_BUDDY_INFO
(
uö
, "uin");

1004 
	`SET_BUDDY_INFO
(
Á˚
, "face");

1006 
	`SET_BUDDY_INFO
(
occu∑ti⁄
, "occupation");

1007 
	`SET_BUDDY_INFO
(
ph⁄e
, "phone");

1008 
	`SET_BUDDY_INFO
(
Ælow
, "allow");

1009 
	`SET_BUDDY_INFO
(
cﬁÀge
, "college");

1010 
	`SET_BUDDY_INFO
(
ªg_time
, "reg_time");

1011 
	`SET_BUDDY_INFO
(
c⁄°ñ
, "constel");

1012 
	`SET_BUDDY_INFO
(
blood
, "blood");

1013 
	`SET_BUDDY_INFO
(
homïage
, "homepage");

1014 
	`SET_BUDDY_INFO
(
°©
, "stat");

1015 
	`SET_BUDDY_INFO
(
vù_öfo
, "vip_info");

1016 
	`SET_BUDDY_INFO
(
cou¡ry
, "country");

1017 
	`SET_BUDDY_INFO
(
côy
, "city");

1018 
	`SET_BUDDY_INFO
(
≥rs⁄Æ
, "personal");

1019 
	`SET_BUDDY_INFO
(
nick
, "nick");

1020 
	`SET_BUDDY_INFO
(
shígxüo
, "shengxiao");

1021 
	`SET_BUDDY_INFO
(
emaû
, "email");

1022 
	`SET_BUDDY_INFO
(
˛õ¡_ty≥
, "client_type");

1023 
	`SET_BUDDY_INFO
(
¥ovö˚
, "province");

1024 
	`SET_BUDDY_INFO
(
gídî
, "gender");

1025 
	`SET_BUDDY_INFO
(
mobûe
, "mobile");

1026 #unde‡
SET_BUDDY_INFO


1030 
d⁄e
:

1031 i‡(
js⁄
)

1032 
	`js⁄_‰ì_vÆue
(&
js⁄
);

1033 
	`lwqq_hâp_ªque°_‰ì
(
ªq
);

1036 
js⁄_îr‹
:

1037 i‡(
îr
)

1038 *
îr
 = 
LWQQ_EC_ERROR
;

1040 i‡(
js⁄
)

1041 
	`js⁄_‰ì_vÆue
(&
js⁄
);

1042 
	`lwqq_hâp_ªque°_‰ì
(
ªq
);

1043 
	}
}

1045 
	$upd©e_⁄löe_buddõs
(
LwqqClõ¡
 *
lc
, 
js⁄_t
 *
js⁄
)

1052 
js⁄_t
 *
cur
;

1053 
cur
 = 
js⁄
->
chûd
; cu∏!
NULL
; cu∏cur->
√xt
) {

1054 *
uö
, *
°©us
, *
˛õ¡_ty≥
;

1055 
LwqqBuddy
 *
b
;

1056 
uö
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "uin");

1057 
°©us
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "status");

1058 i‡(!
uö
 || !
°©us
) {

1061 
˛õ¡_ty≥
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
cur
, "client_type");

1062 
b
 = 
	`lwqq_buddy_föd_buddy_by_uö
(
lc
, 
uö
);

1063 i‡(
b
) {

1064 
	`s_‰ì
(
b
->
°©us
);

1065 
b
->
°©us
 = 
	`s_°rdup
(status);

1066 i‡(
˛õ¡_ty≥
) {

1067 
	`s_‰ì
(
b
->
˛õ¡_ty≥
);

1068 
b
->
˛õ¡_ty≥
 = 
	`s_°rdup
(client_type);

1072 
	}
}

1083 
	$lwqq_öfo_gë_⁄löe_buddõs
(
LwqqClõ¡
 *
lc
, 
LwqqEº‹Code
 *
îr
)

1085 
uæ
[512];

1086 
LwqqHâpReque°
 *
ªq
 = 
NULL
;

1087 
ªt
;

1088 
js⁄_t
 *
js⁄
 = 
NULL
, *
js⁄_tmp
;

1089 *
cookõs
;

1091 i‡(!
lc
) {

1096 
	`¢¥ötf
(
uæ
, (url),

1098 "hâp://d.web2.qq.com", 
lc
->
˛õ¡id
,Üc->
p£ssi⁄id
);

1099 
ªq
 = 
	`lwqq_hâp_¸óã_deÁu…_ªque°
(
uæ
, 
îr
);

1100 i‡(!
ªq
) {

1101 
d⁄e
;

1103 
ªq
->
	`£t_hódî
(req, "Referer", "http://d.web2.qq.com/proxy.html?v=20101025002");

1104 
ªq
->
	`£t_hódî
(req, "Content-Transfer-Encoding", "binary");

1105 
ªq
->
	`£t_hódî
(req, "Content-type", "utf-8");

1106 
cookõs
 = 
	`lwqq_gë_cookõs
(
lc
);

1107 i‡(
cookõs
) {

1108 
ªq
->
	`£t_hódî
‘eq, "Cookõ", 
cookõs
);

1109 
	`s_‰ì
(
cookõs
);

1111 
ªt
 = 
ªq
->
	`do_ªque°
‘eq, 0, 
NULL
);

1112 i‡(
ªt
 || 
ªq
->
hâp_code
 != 200) {

1113 i‡(
îr
)

1114 *
îr
 = 
LWQQ_EC_HTTP_ERROR
;

1115 
d⁄e
;

1123 
ªt
 = 
	`js⁄_∑r£_documít
(&
js⁄
, 
ªq
->
ª•⁄£
);

1124 i‡(
ªt
 !
JSON_OK
) {

1125 
	`lwqq_log
(
LOG_ERROR
, "P¨£ js⁄ obje˘ o‡group†îr‹: %s\n", 
ªq
->
ª•⁄£
);

1126 i‡(
îr
)

1127 *
îr
 = 
LWQQ_EC_ERROR
;

1128 
d⁄e
;

1131 
js⁄_tmp
 = 
	`gë_ªsu…_js⁄_obje˘
(
js⁄
);

1132 i‡(!
js⁄_tmp
) {

1133 
	`lwqq_log
(
LOG_ERROR
, "P¨£ js⁄ obje˘Éº‹: %s\n", 
ªq
->
ª•⁄£
);

1134 
js⁄_îr‹
;

1137 i‡(
js⁄_tmp
->
chûd
) {

1138 
js⁄_tmp
 = js⁄_tmp->
chûd
;

1139 
	`upd©e_⁄löe_buddõs
(
lc
, 
js⁄_tmp
);

1142 
d⁄e
:

1143 i‡(
js⁄
)

1144 
	`js⁄_‰ì_vÆue
(&
js⁄
);

1145 
	`lwqq_hâp_ªque°_‰ì
(
ªq
);

1148 
js⁄_îr‹
:

1149 i‡(
îr
)

1150 *
îr
 = 
LWQQ_EC_ERROR
;

1152 i‡(
js⁄
)

1153 
	`js⁄_‰ì_vÆue
(&
js⁄
);

1154 
	`lwqq_hâp_ªque°_‰ì
(
ªq
);

1155 
	}
}

	@src/liblwqq/json.c

21 
	~"js⁄.h
"

23 
	~<°dlib.h
>

24 
	~<°dio.h
>

25 
	~<as£π.h
>

26 
	~<mem‹y.h
>

27 
	~<sys/ty≥s.h
>

30 
	eLEX_VALUE


31 { 
	mLEX_MORE
 = 0,

32 
	mLEX_INVALID_CHARACTER
,

33 
	mLEX_TRUE
,

34 
	mLEX_FALSE
,

35 
	mLEX_NULL
,

36 
	mLEX_BEGIN_OBJECT
,

37 
	mLEX_END_OBJECT
,

38 
	mLEX_BEGIN_ARRAY
,

39 
	mLEX_END_ARRAY
,

40 
	mLEX_NAME_SEPARATOR
,

41 
	mLEX_VALUE_SEPARATOR
,

42 
	mLEX_STRING
,

43 
	mLEX_NUMBER
,

44 
	mLEX_ERROR
,

45 
	mLEX_MEMORY


51 
	#RSTRING_INCSTEP
 5

	)

52 
	#RSTRING_DEFAULT
 8

	)

55 
	erui_°rög_îr‹_codes


56 { 
	mRS_MEMORY
, 
	mRS_OK
 = 1, 
	mRS_UNKNOWN
 };

58 
rui_°rög_îr‹_codes
 
	tr°rög_code
;

61 
rc°rög
 *

62 
	$rcs_¸óã
 (
size_t
 
Àngth
)

64 
rc°rög
 *
rcs
;

65 
rcs
 = 
	`mÆloc
 ( (
rc°rög
));

66 i‡(
rcs
 =
NULL
)

67  
NULL
;

69 
rcs
->
max
 = 
Àngth
;

70 
rcs
->
Àngth
 = 0;

72 
rcs
->
ãxt
 = 
	`mÆloc
 (‘cs->
max
 + 1) *  ());

73 i‡(
rcs
->
ãxt
 =
NULL
)

75 
	`‰ì
 (
rcs
);

76  
NULL
;

78 
rcs
->
ãxt
[0] = '\0';

80  
rcs
;

81 
	}
}

85 
	$rcs_‰ì
 (
rc°rög
 ** 
rcs
)

87 
	`as£π
 (
rcs
 !
NULL
);

88 i‡(*
rcs
 !
NULL
)

90 i‡((*
rcs
)->
ãxt
 !
NULL
)

92 
	`‰ì
 ((*
rcs
)->
ãxt
);

93 (*
rcs
)->
ãxt
 = 
NULL
;

95 
	`‰ì
 (*
rcs
);

96 *
rcs
 = 
NULL
;

99 
	}
}

102 
r°rög_code


103 
	$rcs_ªsize
 (
rc°rög
 * 
rcs
, 
size_t
 
Àngth
)

105 *
ãmp
;

106 
	`as£π
 (
rcs
 !
NULL
);

108 
ãmp
 = 
	`ªÆloc
 (
rcs
->
ãxt
,  (Ë* (
Àngth
 + 1));

109 i‡(
ãmp
 =
NULL
)

111 
	`‰ì
 (
rcs
);

112  
RS_MEMORY
;

114 
rcs
->
ãxt
 = 
ãmp
;

115 
rcs
->
max
 = 
Àngth
;

116 
rcs
->
ãxt
[rcs->
max
] = '\0';

117  
RS_OK
;

118 
	}
}

121 
r°rög_code


122 
	$rcs_ˇtcs
 (
rc°rög
 * 
¥e
, c⁄° *
pos
, c⁄° 
size_t
 
Àngth
)

124 
	`as£π
 (
¥e
 !
NULL
);

125 
	`as£π
 (
pos
 !
NULL
);

127 i‡(
¥e
->
max
 <Öª->
Àngth
 +Üength)

129 i‡(
	`rcs_ªsize
 (
¥e
,Öª->
Àngth
 +Üígth + 
RSTRING_INCSTEP
Ë!
RS_OK
)

130  
RS_MEMORY
;

132 
	`°∫˝y
 (
¥e
->
ãxt
 +Öª->
Àngth
, 
pos
,Üength);

133 
¥e
->
ãxt
[¥e->
Àngth
 +Üength] = '\0';

134 
¥e
->
Àngth
 +=Üength;

135  
RS_OK
;

136 
	}
}

139 
r°rög_code


140 
	$rcs_ˇtc
 (
rc°rög
 * 
¥e
, c⁄° 
c
)

142 
	`as£π
 (
¥e
 !
NULL
);

144 i‡(
¥e
->
max
 <¥e->
Àngth
)

146 i‡(
	`rcs_ªsize
 (
¥e
,Öª->
max
 + 
RSTRING_INCSTEP
Ë!
RS_OK
)

147  
RS_MEMORY
;

149 
¥e
->
ãxt
[¥e->
Àngth
] = 
c
;

150 
¥e
->
Àngth
++;

151 
¥e
->
ãxt
[¥e->
Àngth
] = '\0';

152  
RS_OK
;

153 
	}
}

157 
	$rcs_unwøp
 (
rc°rög
 * 
rcs
)

159 *
out
;

160 
	`as£π
 (
rcs
 !
NULL
);

162 i‡(
rcs
->
ãxt
 =
NULL
)

163 
out
 = 
NULL
;

166 
out
 = 
	`ªÆloc
 (
rcs
->
ãxt
,  (Ë* (
	`°æí
 (rcs->text) + 1));

169 
	`‰ì
 (
rcs
);

170  
out
;

171 
	}
}

175 
size_t


176 
	$rcs_Àngth
 (
rc°rög
 * 
rcs
)

179 
	`as£π
 (
rcs
 !
NULL
);

180  
rcs
->
Àngth
;

181 
	}
}

187 
js⁄_îr‹


188 
	$js⁄_°ªam_∑r£
 (
FILE
 * 
fûe
, 
js⁄_t
 ** 
documít
)

190 
buf„r
[1024];

191 
îr‹
 = 
JSON_INCOMPLETE_DOCUMENT
;

193 
js⁄_∑rsög_öfo
 
°©e
;

195 
	`as£π
 (
fûe
 !
NULL
);

196 
	`as£π
 (
documít
 !
NULL
);

197 
	`as£π
 (*
documít
 =
NULL
);

199 
	`js⁄_jpi_öô
 (&
°©e
);

201 (
îr‹
 =
JSON_WAITING_FOR_EOF
Ë|| (îr‹ =
JSON_INCOMPLETE_DOCUMENT
))

203 i‡(
	`fgës
 (
buf„r
, 1024, 
fûe
Ë!
NULL
)

205 
îr‹
 = 
	`js⁄_∑r£_‰agmít
 (&
°©e
, 
buf„r
))

207 
JSON_OK
:

208 
JSON_WAITING_FOR_EOF
:

209 
JSON_INCOMPLETE_DOCUMENT
:

213 
	`js⁄_‰ì_vÆue
 (&
°©e
.
curs‹
);

214  
îr‹
;

220 i‡(
îr‹
 =
JSON_WAITING_FOR_EOF
)

221 
îr‹
 = 
JSON_OK
;

225 
îr‹
 = 
JSON_UNKNOWN_PROBLEM
;

230 i‡(
îr‹
 =
JSON_OK
)

232 *
documít
 = 
°©e
.
curs‹
;

235  
îr‹
;

236 
	}
}

239 
js⁄_t
 *

240 
	$js⁄_√w_vÆue
 (c⁄° 
js⁄_vÆue_ty≥
 
ty≥
)

242 
js⁄_t
 *
√w_obje˘
;

244 
√w_obje˘
 = 
	`mÆloc
 ( (
js⁄_t
));

245 i‡(
√w_obje˘
 =
NULL
)

246  
NULL
;

249 
√w_obje˘
->
ãxt
 = 
NULL
;

250 
√w_obje˘
->
∑ª¡
 = 
NULL
;

251 
√w_obje˘
->
chûd
 = 
NULL
;

252 
√w_obje˘
->
chûd_íd
 = 
NULL
;

253 
√w_obje˘
->
¥evious
 = 
NULL
;

254 
√w_obje˘
->
√xt
 = 
NULL
;

255 
√w_obje˘
->
ty≥
 =Åype;

256  
√w_obje˘
;

257 
	}
}

260 
js⁄_t
 *

261 
	$js⁄_√w_°rög
 (c⁄° *
ãxt
)

263 
js⁄_t
 *
√w_obje˘
;

264 
size_t
 
Àngth
;

266 
	`as£π
 (
ãxt
 !
NULL
);

269 
√w_obje˘
 = 
	`mÆloc
 ( (
js⁄_t
));

270 i‡(
√w_obje˘
 =
NULL
)

271  
NULL
;

274 
Àngth
 = 
	`°æí
 (
ãxt
) + 1;

275 
√w_obje˘
->
ãxt
 = 
	`mÆloc
 (
Àngth
 *  ());

276 i‡(
√w_obje˘
->
ãxt
 =
NULL
)

278 
	`‰ì
 (
√w_obje˘
);

279  
NULL
;

281 
	`°∫˝y
 (
√w_obje˘
->
ãxt
,Åext, 
Àngth
);

282 
√w_obje˘
->
∑ª¡
 = 
NULL
;

283 
√w_obje˘
->
chûd
 = 
NULL
;

284 
√w_obje˘
->
chûd_íd
 = 
NULL
;

285 
√w_obje˘
->
¥evious
 = 
NULL
;

286 
√w_obje˘
->
√xt
 = 
NULL
;

287 
√w_obje˘
->
ty≥
 = 
JSON_STRING
;

288  
√w_obje˘
;

289 
	}
}

292 
js⁄_t
 *

293 
	$js⁄_√w_numbî
 (c⁄° *
ãxt
)

295 
js⁄_t
 *
√w_obje˘
;

296 
size_t
 
Àngth
;

298 
	`as£π
 (
ãxt
 !
NULL
);

301 
√w_obje˘
 = 
	`mÆloc
 ( (
js⁄_t
));

302 i‡(
√w_obje˘
 =
NULL
)

303  
NULL
;

306 
Àngth
 = 
	`°æí
 (
ãxt
) + 1;

307 
√w_obje˘
->
ãxt
 = 
	`mÆloc
 (
Àngth
 *  ());

308 i‡(
√w_obje˘
->
ãxt
 =
NULL
)

310 
	`‰ì
 (
√w_obje˘
);

311  
NULL
;

313 
	`°∫˝y
 (
√w_obje˘
->
ãxt
,Åext, 
Àngth
);

314 
√w_obje˘
->
∑ª¡
 = 
NULL
;

315 
√w_obje˘
->
chûd
 = 
NULL
;

316 
√w_obje˘
->
chûd_íd
 = 
NULL
;

317 
√w_obje˘
->
¥evious
 = 
NULL
;

318 
√w_obje˘
->
√xt
 = 
NULL
;

319 
√w_obje˘
->
ty≥
 = 
JSON_NUMBER
;

320  
√w_obje˘
;

321 
	}
}

324 
js⁄_t
 *

325 
	$js⁄_√w_obje˘
 ()

327  
	`js⁄_√w_vÆue
 (
JSON_OBJECT
);

328 
	}
}

331 
js⁄_t
 *

332 
	$js⁄_√w_¨øy
 ()

334  
	`js⁄_√w_vÆue
 (
JSON_ARRAY
);

335 
	}
}

338 
js⁄_t
 *

339 
	$js⁄_√w_nuŒ
 ()

341  
	`js⁄_√w_vÆue
 (
JSON_NULL
);

342 
	}
}

345 
js⁄_t
 *

346 
	$js⁄_√w_åue
 ()

348  
	`js⁄_√w_vÆue
 (
JSON_TRUE
);

349 
	}
}

352 
js⁄_t
 *

353 
	$js⁄_√w_Ál£
 ()

355  
	`js⁄_√w_vÆue
 (
JSON_FALSE
);

356 
	}
}

360 
	$öã∫_js⁄_‰ì_vÆue
 (
js⁄_t
 ** 
vÆue
)

362 
	`as£π
 (
vÆue
 !
NULL
);

363 
	`as£π
 ((*
vÆue
Ë!
NULL
);

364 
	`as£π
 ((*
vÆue
)->
chûd
 =
NULL
);

367 i‡((*
vÆue
)->
¥evious
 && (*vÆue)->
√xt
)

369 (*
vÆue
)->
¥evious
->
√xt
 = (*value)->next;

370 (*
vÆue
)->
√xt
->
¥evious
 = (*value)->previous;

374 i‡((*
vÆue
)->
¥evious
)

376 (*
vÆue
)->
¥evious
->
√xt
 = 
NULL
;

378 i‡((*
vÆue
)->
√xt
)

380 (*
vÆue
)->
√xt
->
¥evious
 = 
NULL
;

385 i‡((*
vÆue
)->
∑ª¡
)

388 i‡((*
vÆue
)->
∑ª¡
->
chûd
 == (*value))

390 i‡((*
vÆue
)->
√xt
)

392 (*
vÆue
)->
∑ª¡
->
chûd
 = (*vÆue)->
√xt
;

396 (*
vÆue
)->
∑ª¡
->
chûd
 = 
NULL
;

401 i‡((*
vÆue
)->
∑ª¡
->
chûd_íd
 == (*value))

403 i‡((*
vÆue
)->
¥evious
)

405 (*
vÆue
)->
∑ª¡
->
chûd_íd
 = (*vÆue)->
¥evious
;

409 (*
vÆue
)->
∑ª¡
->
chûd_íd
 = 
NULL
;

415 i‡((*
vÆue
)->
ãxt
 !
NULL
)

417 
	`‰ì
 ((*
vÆue
)->
ãxt
);

419 
	`‰ì
 (*
vÆue
);

420 (*
vÆue
Ë
NULL
;

421 
	}
}

425 
	$js⁄_‰ì_vÆue
 (
js⁄_t
 ** 
vÆue
)

427 
js⁄_t
 *
curs‹
 = *
vÆue
;

429 
	`as£π
 (
vÆue
);

430 
	`as£π
 (*
vÆue
);

432 *
vÆue
)

434 
js⁄_t
 *
∑ª¡
;

436 i‡(
curs‹
->
chûd
)

438 
curs‹
 = curs‹->
chûd
;

442 i‡(
curs‹
 =*
vÆue
)

444 *
vÆue
 = 
NULL
;

447 
∑ª¡
 = 
curs‹
->parent;

448 
	`öã∫_js⁄_‰ì_vÆue
 (&
curs‹
);

449 
curs‹
 = 
∑ª¡
;

451 
	}
}

454 
js⁄_îr‹


455 
	$js⁄_ö£π_chûd
 (
js⁄_t
 * 
∑ª¡
, js⁄_à* 
chûd
)

458 
	`as£π
 (
∑ª¡
 !
NULL
);

459 
	`as£π
 (
chûd
 !
NULL
);

460 
	`as£π
 (
∑ª¡
 !
chûd
);

463 
∑ª¡
->
ty≥
)

465 
JSON_STRING
:

468 
chûd
->
ty≥
)

470 
JSON_STRING
:

471 
JSON_NUMBER
:

472 
JSON_TRUE
:

473 
JSON_FALSE
:

474 
JSON_NULL
:

475 i‡(
chûd
->chûd !
NULL
)

476  
JSON_BAD_TREE_STRUCTURE
;

479 
JSON_OBJECT
:

480 
JSON_ARRAY
:

484  
JSON_BAD_TREE_STRUCTURE
;

489 
JSON_OBJECT
:

490 i‡(
chûd
->
ty≥
 !
JSON_STRING
)

491  
JSON_BAD_TREE_STRUCTURE
;

494 
JSON_ARRAY
:

495 
chûd
->
ty≥
)

497 
JSON_STRING
:

498 
JSON_TRUE
:

499 
JSON_FALSE
:

500 
JSON_NULL
:

501 
JSON_NUMBER
:

502 i‡(
chûd
->child)

503  
JSON_BAD_TREE_STRUCTURE
;

506 
JSON_OBJECT
:

507 
JSON_ARRAY
:

511  
JSON_BAD_TREE_STRUCTURE
;

516  
JSON_BAD_TREE_STRUCTURE
;

519 
chûd
->
∑ª¡
 =Öarent;

520 i‡(
∑ª¡
->
chûd
)

522 
chûd
->
¥evious
 = 
∑ª¡
->
chûd_íd
;

523 
∑ª¡
->
chûd_íd
->
√xt
 = 
chûd
;

524 
∑ª¡
->
chûd_íd
 = 
chûd
;

528 
∑ª¡
->
chûd
 = child;

529 
∑ª¡
->
chûd_íd
 = 
chûd
;

532  
JSON_OK
;

533 
	}
}

536 
js⁄_îr‹


537 
	$js⁄_ö£π_∑ú_öto_obje˘
 (
js⁄_t
 * 
∑ª¡
, c⁄° *
ãxt_œbñ
, js⁄_à* 
vÆue
)

539 
js⁄_îr‹
 
îr‹
;

540 
js⁄_t
 *
œbñ
;

543 
	`as£π
 (
∑ª¡
 !
NULL
);

544 
	`as£π
 (
ãxt_œbñ
 !
NULL
);

545 
	`as£π
 (
vÆue
 !
NULL
);

546 
	`as£π
 (
∑ª¡
 !
vÆue
);

549 
	`as£π
 (
∑ª¡
->
ty≥
 =
JSON_OBJECT
);

553 
œbñ
 = 
	`js⁄_√w_°rög
 (
ãxt_œbñ
);

554 i‡(
œbñ
 =
NULL
)

555  
JSON_MEMORY
;

558 
îr‹
 = 
	`js⁄_ö£π_chûd
 (
œbñ
, 
vÆue
);

559 i‡(
îr‹
 !
JSON_OK
)

560  
îr‹
;

562 
îr‹
 = 
	`js⁄_ö£π_chûd
 (
∑ª¡
, 
œbñ
);

563 i‡(
îr‹
 !
JSON_OK
)

564  
îr‹
;

566  
JSON_OK
;

567 
	}
}

570 
js⁄_îr‹


571 
	$js⁄_åì_to_°rög
 (
js⁄_t
 * 
roŸ
, **
ãxt
)

573 
js⁄_t
 *
curs‹
;

574 
rc°rög
 *
ouçut
;

576 
	`as£π
 (
roŸ
 !
NULL
);

577 
	`as£π
 (
ãxt
 !
NULL
);

579 
curs‹
 = 
roŸ
;

581 
ouçut
 = 
	`rcs_¸óã
 (
RSTRING_DEFAULT
);

584 
°©e1
:

586 i‡((
curs‹
->
¥evious
Ë&& (curs‹ !
roŸ
))

589 i‡(
	`rcs_ˇtc
 (
ouçut
, ','Ë!
RS_OK
)

591  
JSON_MEMORY
;

594 
curs‹
->
ty≥
)

596 
JSON_STRING
:

599 i‡(
	`rcs_ˇtc
 (
ouçut
, '\"'Ë!
RS_OK
)

601  
JSON_MEMORY
;

603 i‡(
	`rcs_ˇtcs
 (
ouçut
, 
curs‹
->
ãxt
, 
	`°æí
 (curs‹->ãxt)Ë!
RS_OK
)

605  
JSON_MEMORY
;

607 i‡(
	`rcs_ˇtc
 (
ouçut
, '\"'Ë!
RS_OK
)

609  
JSON_MEMORY
;

612 i‡(
curs‹
->
∑ª¡
 !
NULL
)

614 i‡(
curs‹
->
∑ª¡
->
ty≥
 =
JSON_OBJECT
)

617 i‡(
curs‹
->
chûd
 !
NULL
)

619 i‡(
	`rcs_ˇtc
 (
ouçut
, ':'Ë!
RS_OK
)

621  
JSON_MEMORY
;

627 
	`rcs_‰ì
 (&
ouçut
);

628 
ãxt
 = 
NULL
;

629  
JSON_BAD_TREE_STRUCTURE
;

635 i‡(
curs‹
->
chûd
 !
NULL
)

637 i‡(
	`rcs_ˇtc
 (
ouçut
, ':'Ë!
RS_OK
)

639  
JSON_MEMORY
;

645 
	`rcs_‰ì
 (&
ouçut
);

646 
ãxt
 = 
NULL
;

647  
JSON_BAD_TREE_STRUCTURE
;

652 
JSON_NUMBER
:

655 i‡(
	`rcs_ˇtcs
 (
ouçut
, 
curs‹
->
ãxt
, 
	`°æí
 (curs‹->ãxt)Ë!
RS_OK
)

657  
JSON_MEMORY
;

659 
°©e2
;

662 
JSON_OBJECT
:

663 i‡(
	`rcs_ˇtc
 (
ouçut
, '{'Ë!
RS_OK
)

665  
JSON_MEMORY
;

668 i‡(
curs‹
->
chûd
)

670 
curs‹
 = curs‹->
chûd
;

671 
°©e1
;

675 
°©e2
;

679 
JSON_ARRAY
:

680 i‡(
	`rcs_ˇtc
 (
ouçut
, '['Ë!
RS_OK
)

682  
JSON_MEMORY
;

685 i‡(
curs‹
->
chûd
 !
NULL
)

687 
curs‹
 = curs‹->
chûd
;

688 
°©e1
;

692 
°©e2
;

696 
JSON_TRUE
:

698 i‡(
	`rcs_ˇtcs
 (
ouçut
, "åue", 4Ë!
RS_OK
)

700  
JSON_MEMORY
;

702 
°©e2
;

705 
JSON_FALSE
:

707 i‡(
	`rcs_ˇtcs
 (
ouçut
, "Ál£", 5Ë!
RS_OK
)

709  
JSON_MEMORY
;

711 
°©e2
;

714 
JSON_NULL
:

716 i‡(
	`rcs_ˇtcs
 (
ouçut
, "nuŒ", 4Ë!
RS_OK
)

718  
JSON_MEMORY
;

720 
°©e2
;

724 
îr‹
;

726 i‡(
curs‹
->
chûd
)

728 
curs‹
 = curs‹->
chûd
;

729 
°©e1
;

734 
°©e2
;

738 
°©e2
:

740 
curs‹
->
ty≥
)

742 
JSON_OBJECT
:

743 i‡(
	`rcs_ˇtc
 (
ouçut
, '}'Ë!
RS_OK
)

745  
JSON_MEMORY
;

749 
JSON_ARRAY
:

750 i‡(
	`rcs_ˇtc
 (
ouçut
, ']'Ë!
RS_OK
)

752  
JSON_MEMORY
;

756 
JSON_STRING
:

758 
JSON_NUMBER
:

760 
JSON_TRUE
:

762 
JSON_FALSE
:

764 
JSON_NULL
:

767 
îr‹
;

769 i‡((
curs‹
->
∑ª¡
 =
NULL
Ë|| (curs‹ =
roŸ
))

771 
íd
;

773 i‡(
curs‹
->
√xt
)

775 
curs‹
 = curs‹->
√xt
;

776 
°©e1
;

780 
curs‹
 = curs‹->
∑ª¡
;

781 
°©e2
;

785 
îr‹
:

787 
	`rcs_‰ì
 (&
ouçut
);

788  
JSON_UNKNOWN_PROBLEM
;

791 
íd
:

793 *
ãxt
 = 
	`rcs_unwøp
 (
ouçut
);

794  
JSON_OK
;

796 
	}
}

799 
js⁄_îr‹


800 
	$js⁄_°ªam_ouçut
 (
FILE
 * 
fûe
, 
js⁄_t
 * 
roŸ
)

802 
js⁄_t
 *
curs‹
;

804 
	`as£π
 (
roŸ
 !
NULL
);

805 
	`as£π
 (
fûe
 !
NULL
);

807 
curs‹
 = 
roŸ
;

811 
°©e1
:

813 i‡((
curs‹
->
¥evious
Ë&& (curs‹ !
roŸ
))

816 
	`Ârötf
 (
fûe
, ",");

818 
curs‹
->
ty≥
)

820 
JSON_STRING
:

823 
	`Ârötf
 (
fûe
, "\"%s\"", 
curs‹
->
ãxt
);

825 i‡(
curs‹
->
∑ª¡
 !
NULL
)

827 i‡(
curs‹
->
∑ª¡
->
ty≥
 =
JSON_OBJECT
)

830 i‡(
curs‹
->
chûd
 !
NULL
)

832 i‡(
	`Ârötf
 (
fûe
, ":"Ë!
RS_OK
)

834  
JSON_MEMORY
;

840  
JSON_BAD_TREE_STRUCTURE
;

846 i‡(
curs‹
->
chûd
 !
NULL
)

848 
	`Ârötf
 (
fûe
, ":");

853  
JSON_BAD_TREE_STRUCTURE
;

858 
JSON_NUMBER
:

861 
	`Ârötf
 (
fûe
, "%s", 
curs‹
->
ãxt
);

862 
°©e2
;

865 
JSON_OBJECT
:

866 
	`Ârötf
 (
fûe
, "{");

868 i‡(
curs‹
->
chûd
)

870 
curs‹
 = curs‹->
chûd
;

871 
°©e1
;

875 
°©e2
;

879 
JSON_ARRAY
:

880 
	`Ârötf
 (
fûe
, "[");

882 i‡(
curs‹
->
chûd
 !
NULL
)

884 
curs‹
 = curs‹->
chûd
;

885 
°©e1
;

889 
°©e2
;

893 
JSON_TRUE
:

895 
	`Ârötf
 (
fûe
, "true");

896 
°©e2
;

899 
JSON_FALSE
:

901 
	`Ârötf
 (
fûe
, "false");

902 
°©e2
;

905 
JSON_NULL
:

907 
	`Ârötf
 (
fûe
, "null");

908 
°©e2
;

912 
îr‹
;

914 i‡(
curs‹
->
chûd
)

916 
curs‹
 = curs‹->
chûd
;

917 
°©e1
;

922 
°©e2
;

926 
°©e2
:

928 
curs‹
->
ty≥
)

930 
JSON_OBJECT
:

931 
	`Ârötf
 (
fûe
, "}");

934 
JSON_ARRAY
:

935 
	`Ârötf
 (
fûe
, "]");

938 
JSON_STRING
:

940 
JSON_NUMBER
:

942 
JSON_TRUE
:

944 
JSON_FALSE
:

946 
JSON_NULL
:

949 
îr‹
;

951 i‡((
curs‹
->
∑ª¡
 =
NULL
Ë|| (curs‹ =
roŸ
))

953 
íd
;

955 i‡(
curs‹
->
√xt
)

957 
curs‹
 = curs‹->
√xt
;

958 
°©e1
;

962 
curs‹
 = curs‹->
∑ª¡
;

963 
°©e2
;

967 
îr‹
:

969  
JSON_UNKNOWN_PROBLEM
;

972 
íd
:

974 
	`Ârötf
 (
fûe
, "\n");

975  
JSON_OK
;

977 
	}
}

981 
	$js⁄_°rù_whôe_•a˚s
 (*
ãxt
)

983 
size_t
 
ö
, 
out
, 
Àngth
;

984 
°©e
;

986 
	`as£π
 (
ãxt
 !
NULL
);

988 
ö
 = 0;

989 
out
 = 0;

990 
Àngth
 = 
	`°æí
 (
ãxt
);

991 
°©e
 = 0;

993 
ö
 < 
Àngth
)

995 
ãxt
[
ö
])

1001 i‡(
°©e
 == 1)

1003 
ãxt
[
out
++] =Åext[
ö
];

1008 
°©e
)

1011 
°©e
 = 1;

1015 i‡(
ãxt
[
ö
 - 1] != '\\')

1017 
°©e
 = 0;

1022 
	`as£π
 (0);

1024 
ãxt
[
out
++] =Åext[
ö
];

1028 
ãxt
[
out
++] =Åext[
ö
];

1030 ++
ö
;

1032 
ãxt
[
out
] = '\0';

1033 
	}
}

1037 
	$js⁄_f‹m©_°rög
 (c⁄° *
ãxt
)

1039 
size_t
 
pos
 = 0, 
ãxt_Àngth
;

1040 
ödíèti⁄
 = 0;

1041 
i
;

1042 
lo›
;

1044 
rc°rög
 *
ouçut
;

1045 
ãxt_Àngth
 = 
	`°æí
 (
ãxt
);

1047 
ouçut
 = 
	`rcs_¸óã
 (
ãxt_Àngth
);

1048 
pos
 < 
ãxt_Àngth
)

1050 
ãxt
[
pos
])

1056 
pos
++;

1060 
ödíèti⁄
++;

1061 
	`rcs_ˇtcs
 (
ouçut
, "{\n", 2);

1062 
i
 = 0; i < 
ödíèti⁄
; i++)

1064 
	`rcs_ˇtc
 (
ouçut
, '\t');

1066 
pos
++;

1070 
ödíèti⁄
--;

1071 
	`rcs_ˇtc
 (
ouçut
, '\n');

1072 
i
 = 0; i < 
ödíèti⁄
; i++)

1074 
	`rcs_ˇtc
 (
ouçut
, '\t');

1076 
	`rcs_ˇtc
 (
ouçut
, '}');

1077 
pos
++;

1081 
	`rcs_ˇtcs
 (
ouçut
, ": ", 2);

1082 
pos
++;

1086 
	`rcs_ˇtcs
 (
ouçut
, ",\n", 2);

1087 
i
 = 0; i < 
ödíèti⁄
; i++)

1089 
	`rcs_ˇtc
 (
ouçut
, '\t');

1091 
pos
++;

1095 
	`rcs_ˇtc
 (
ouçut
, 
ãxt
[
pos
]);

1096 
pos
++;

1097 
lo›
 = 1;

1098 
lo›
)

1100 i‡(
ãxt
[
pos
] == '\\')

1102 
	`rcs_ˇtc
 (
ouçut
, '\\');

1103 
pos
++;

1104 i‡(
ãxt
[
pos
] == '\"')

1106 
	`rcs_ˇtc
 (
ouçut
, '\"');

1107 
pos
++;

1110 i‡(
ãxt
[
pos
] == '\"')

1112 
lo›
 = 0;

1115 
	`rcs_ˇtc
 (
ouçut
, 
ãxt
[
pos
]);

1117 
pos
++;

1118 i‡(
pos
 >
ãxt_Àngth
)

1120 
lo›
 = 0;

1126 
	`rcs_ˇtc
 (
ouçut
, 
ãxt
[
pos
]);

1127 
pos
++;

1132  
	`rcs_unwøp
 (
ouçut
);

1133 
	}
}

1137 
	$js⁄_esˇ≥
 (*
ãxt
)

1139 
rc°rög
 *
ouçut
;

1140 
size_t
 
i
, 
Àngth
;

1141 
buf„r
[7];

1143 
	`as£π
 (
ãxt
 !
NULL
);

1146 
Àngth
 = 
	`°æí
 (
ãxt
);

1147 
ouçut
 = 
	`rcs_¸óã
 (
Àngth
);

1148 i‡(
ouçut
 =
NULL
)

1149  
NULL
;

1150 
i
 = 0; i < 
Àngth
; i++)

1152 i‡(
ãxt
[
i
] == '\\')

1154 
	`rcs_ˇtcs
 (
ouçut
, "\\\\", 2);

1156 i‡(
ãxt
[
i
] == '\"')

1158 
	`rcs_ˇtcs
 (
ouçut
, "\\\"", 2);

1160 i‡(
ãxt
[
i
] == '/')

1162 
	`rcs_ˇtcs
 (
ouçut
, "\\/", 2);

1164 i‡(
ãxt
[
i
] == '\b')

1166 
	`rcs_ˇtcs
 (
ouçut
, "\\b", 2);

1168 i‡(
ãxt
[
i
] == '\f')

1170 
	`rcs_ˇtcs
 (
ouçut
, "\\f", 2);

1172 i‡(
ãxt
[
i
] == '\n')

1174 
	`rcs_ˇtcs
 (
ouçut
, "\\n", 2);

1176 i‡(
ãxt
[
i
] == '\r')

1178 
	`rcs_ˇtcs
 (
ouçut
, "\\r", 2);

1180 i‡(
ãxt
[
i
] == '\t')

1182 
	`rcs_ˇtcs
 (
ouçut
, "\\t", 2);

1184 i‡(
ãxt
[
i
] < 0)

1186 
	`rcs_ˇtc
 (
ouçut
, 
ãxt
[
i
]);

1188 i‡(
ãxt
[
i
] < 0x20)

1190 
	`¢¥ötf
 (
buf„r
, 7, "\\u%4.4x", 
ãxt
[
i
]);

1191 
	`rcs_ˇtcs
 (
ouçut
, 
buf„r
, 6);

1195 
	`rcs_ˇtc
 (
ouçut
, 
ãxt
[
i
]);

1198  
	`rcs_unwøp
 (
ouçut
);

1199 
	}
}

1203 
	$js⁄_u√sˇ≥
 (*
ãxt
)

1205 *
ªsu…
 = 
	`mÆloc
 (
	`°æí
 (
ãxt
) + 1);

1206 
size_t
 
r
;

1207 
size_t
 
w
;

1209 
	`as£π
 (
ãxt
);

1211 
r
 = 
w
 = 0; 
ãxt
[r];Ñ++)

1213 
ãxt
[
r
])

1216 
ãxt
[++
r
])

1222 
ªsu…
[
w
++] = 
ãxt
[
r
];

1225 
ªsu…
[
w
++] = '\b';

1228 
ªsu…
[
w
++] = '\f';

1231 
ªsu…
[
w
++] = '\n';

1234 
ªsu…
[
w
++] = '\r';

1237 
ªsu…
[
w
++] = '\t';

1241 
buf
[5];

1242 
öt64_t
 
unicode
;

1244 
buf
[0] = 
ãxt
[++
r
];

1245 
buf
[1] = 
ãxt
[++
r
];

1246 
buf
[2] = 
ãxt
[++
r
];

1247 
buf
[3] = 
ãxt
[++
r
];

1248 
buf
[4] = '\0';

1250 
unicode
 = 
	`°πﬁ
 (
buf
, 
NULL
, 16);

1252 i‡(
unicode
 < 0x80)

1255 
ªsu…
[
w
++] = (Ë
unicode
;

1257 i‡(
unicode
 < 0x800)

1260 
⁄e
 = 0xC0;

1261 
two
 = 0x80;

1263 
two
 +(
unicode
 & 0x3F);

1264 
unicode
 >>= 6;

1265 
⁄e
 +(
unicode
 & 0x1F);

1267 
ªsu…
[
w
++] = 
⁄e
;

1268 
ªsu…
[
w
++] = 
two
;

1270 i‡(
unicode
 < 0x10000)

1272 i‡(
unicode
 < 0xD800 || 0xDBFF < unicode)

1275 
⁄e
 = 0xE0;

1276 
two
 = 0x80;

1277 
thªe
 = 0x80;

1279 
thªe
 +(
unicode
 & 0x3F);

1280 
unicode
 >>= 6;

1281 
two
 +(
unicode
 & 0x3F);

1282 
unicode
 >>= 6;

1283 
⁄e
 +(
unicode
 & 0xF);

1285 
ªsu…
[
w
++] = 
⁄e
;

1286 
ªsu…
[
w
++] = 
two
;

1287 
ªsu…
[
w
++] = 
thªe
;

1292 
uöt64_t
 
high_suºog©e
 = 
unicode
;

1293 
uöt64_t
 
low_suºog©e
;

1294 
⁄e
 = 0xF0;

1295 
two
 = 0x80;

1296 
thªe
 = 0x80;

1297 
four
 = 0x80;

1299 i‡(!
ãxt
[++
r
] == '\\')

1303 i‡(!
ãxt
[++
r
] == 'u')

1308 
buf
[0] = 
ãxt
[++
r
];

1309 
buf
[1] = 
ãxt
[++
r
];

1310 
buf
[2] = 
ãxt
[++
r
];

1311 
buf
[3] = 
ãxt
[++
r
];

1313 
low_suºog©e
 = 
	`°πﬁ
 (
buf
, 
NULL
, 16);

1316 
high_suºog©e
 -= 0xD800;

1317 
low_suºog©e
 -= 0xDC00;

1319 
unicode
 = (
high_suºog©e
 << 10Ë+ (
low_suºog©e
) + 0x10000;

1322 
four
 +(
unicode
 & 0x3F);

1323 
unicode
 >>= 6;

1324 
thªe
 +(
unicode
 & 0x3F);

1325 
unicode
 >>= 6;

1326 
two
 +(
unicode
 & 0x3F);

1327 
unicode
 >>= 6;

1328 
⁄e
 +(
unicode
 & 0x7);

1330 
ªsu…
[
w
++] = 
⁄e
;

1331 
ªsu…
[
w
++] = 
two
;

1332 
ªsu…
[
w
++] = 
thªe
;

1333 
ªsu…
[
w
++] = 
four
;

1338 
	`Ârötf
 (
°dîr
, "JSON: unsuµ‹ãd unicodêvÆue: 0x%lX\n", ()
unicode
);

1343 
	`as£π
 (0);

1348 
ªsu…
[
w
++] = 
ãxt
[
r
];

1352 
ªsu…
[
w
] = '\0';

1354  
ªsu…
;

1355 
	}
}

1359 
	$js⁄_jpi_öô
 (
js⁄_∑rsög_öfo
 *
jpi
)

1361 
	`as£π
 (
jpi
 !
NULL
);

1362 
jpi
->
°©e
 = 0;

1363 
jpi
->
Àx_°©e
 = 0;

1364 
jpi
->
Àx_ãxt
 = 
NULL
;

1365 
jpi
->
p
 = 
NULL
;

1366 
jpi
->
curs‹
 = 
NULL
;

1367 
jpi
->
löe
 = 1;

1368 
jpi
->
°rög_Àngth_limô_ªached
 = 0;

1369 
	}
}

1373 
	$Àxî
 (*
buf„r
, **
p
, *
°©e
, 
rc°rög
 ** 
ãxt
, 
size_t
 *
löe
)

1375 
	`as£π
 (
buf„r
 !
NULL
);

1376 
	`as£π
 (
p
 !
NULL
);

1377 
	`as£π
 (
°©e
 !
NULL
);

1378 
	`as£π
 (
ãxt
 !
NULL
);

1379 
	`as£π
 (
löe
 !
NULL
);

1380 i‡(*
p
 =
NULL
)

1381 *
p
 = 
buf„r
;

1383 **
p
 != '\0')

1385 *
°©e
)

1390 *(*
p
)++)

1398 *
löe
 += 1;

1402  
LEX_BEGIN_OBJECT
;

1404  
LEX_END_OBJECT
;

1406  
LEX_BEGIN_ARRAY
;

1408  
LEX_END_ARRAY
;

1410  
LEX_NAME_SEPARATOR
;

1412  
LEX_VALUE_SEPARATOR
;

1415 *
ãxt
 = 
	`rcs_¸óã
 (
RSTRING_DEFAULT
);

1416 i‡(*
ãxt
 =
NULL
)

1417  
LEX_MEMORY
;

1418 *
°©e
 = 1;

1422 *
°©e
 = 7;

1426 *
°©e
 = 10;

1430 *
°©e
 = 14;

1434 *
ãxt
 = 
	`rcs_¸óã
 (
RSTRING_DEFAULT
);

1435 i‡(*
ãxt
 =
NULL
)

1436  
LEX_MEMORY
;

1437 i‡(
	`rcs_ˇtc
 (*
ãxt
, '-'Ë!
RS_OK
)

1438  
LEX_MEMORY
;

1439 *
°©e
 = 17;

1443 *
ãxt
 = 
	`rcs_¸óã
 (
RSTRING_DEFAULT
);

1444 i‡(*
ãxt
 =
NULL
)

1445  
LEX_MEMORY
;

1446 i‡(
	`rcs_ˇtc
 (*
ãxt
, '0'Ë!
RS_OK
)

1447  
LEX_MEMORY
;

1448 *
°©e
 = 18;

1460 *
ãxt
 = 
	`rcs_¸óã
 (
RSTRING_DEFAULT
);

1461 i‡(*
ãxt
 =
NULL
)

1462  
LEX_MEMORY
;

1463 i‡(
	`rcs_ˇtc
 (*
ãxt
, *(*
p
 - 1)Ë!
RS_OK
)

1464  
LEX_MEMORY
;

1465 *
°©e
 = 19;

1470  
LEX_INVALID_CHARACTER
;

1477 
	`as£π
 (*
ãxt
 !
NULL
);

1478 **
p
)

1512  
LEX_INVALID_CHARACTER
;

1517 *
°©e
 = 0;

1518 ++*
p
;

1519  
LEX_STRING
;

1523 i‡(
	`rcs_ˇtc
 (*
ãxt
, '\\'Ë!
RS_OK
)

1524  
LEX_MEMORY
;

1525 *
°©e
 = 2;

1529 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1530  
LEX_MEMORY
;

1532 ++*
p
;

1538 
	`as£π
 (*
ãxt
 !
NULL
);

1539 **
p
)

1549 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1550  
LEX_MEMORY
;

1551 *
°©e
 = 1;

1555 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1556  
LEX_MEMORY
;

1557 *
°©e
 = 3;

1561  
LEX_INVALID_CHARACTER
;

1563 ++*
p
;

1569 
	`as£π
 (*
ãxt
 !
NULL
);

1570 i‡((**
p
 >= 'a') && (**p <= 'f'))

1572 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1573  
LEX_MEMORY
;

1574 *
°©e
 = 4;

1576 i‡((**
p
 >= 'A') && (**p <= 'F'))

1578 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1579  
LEX_MEMORY
;

1580 *
°©e
 = 4;

1582 i‡((**
p
 >= '0') && (**p <= '9'))

1584 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1585  
LEX_MEMORY
;

1586 *
°©e
 = 4;

1589  
LEX_INVALID_CHARACTER
;

1590 ++*
p
;

1596 
	`as£π
 (*
ãxt
 !
NULL
);

1597 i‡((**
p
 >= 'a') && (**p <= 'f'))

1599 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1600  
LEX_MEMORY
;

1601 *
°©e
 = 5;

1603 i‡((**
p
 >= 'A') && (**p <= 'F'))

1605 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1606  
LEX_MEMORY
;

1607 *
°©e
 = 5;

1609 i‡((**
p
 >= '0') && (**p <= '9'))

1611 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1612  
LEX_MEMORY
;

1613 *
°©e
 = 5;

1616  
LEX_INVALID_CHARACTER
;

1617 ++*
p
;

1623 
	`as£π
 (*
ãxt
 !
NULL
);

1624 i‡((**
p
 >= 'a') && (**p <= 'f'))

1626 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1627  
LEX_MEMORY
;

1628 *
°©e
 = 6;

1630 i‡((**
p
 >= 'A') && (**p <= 'F'))

1632 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1633  
LEX_MEMORY
;

1634 *
°©e
 = 6;

1636 i‡((**
p
 >= '0') && (**p <= '9'))

1638 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1639  
LEX_MEMORY
;

1640 *
°©e
 = 6;

1643  
LEX_INVALID_CHARACTER
;

1644 ++*
p
;

1650 
	`as£π
 (*
ãxt
 !
NULL
);

1651 i‡((**
p
 >= 'a') && (**p <= 'f'))

1653 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1654  
LEX_MEMORY
;

1655 *
°©e
 = 1;

1657 i‡((**
p
 >= 'A') && (**p <= 'F'))

1659 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1660  
LEX_MEMORY
;

1661 *
°©e
 = 1;

1663 i‡((**
p
 >= '0') && (**p <= '9'))

1665 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1666  
LEX_MEMORY
;

1667 *
°©e
 = 1;

1670  
LEX_INVALID_CHARACTER
;

1671 ++*
p
;

1677 *(*
p
)++)

1680 *
°©e
 = 8;

1683  
LEX_INVALID_CHARACTER
;

1691 *(*
p
)++)

1694 *
°©e
 = 9;

1697  
LEX_INVALID_CHARACTER
;

1705 *(*
p
)++)

1708 *
°©e
 = 0;

1709  
LEX_TRUE
;

1712  
LEX_INVALID_CHARACTER
;

1720 *(*
p
)++)

1723 *
°©e
 = 11;

1726  
LEX_INVALID_CHARACTER
;

1734 *(*
p
)++)

1737 *
°©e
 = 12;

1740  
LEX_INVALID_CHARACTER
;

1748 *(*
p
)++)

1751 *
°©e
 = 13;

1754  
LEX_INVALID_CHARACTER
;

1762 *(*
p
)++)

1765 *
°©e
 = 0;

1766  
LEX_FALSE
;

1769  
LEX_INVALID_CHARACTER
;

1777 *(*
p
)++)

1780 *
°©e
 = 15;

1783  
LEX_INVALID_CHARACTER
;

1791 *(*
p
)++)

1794 *
°©e
 = 16;

1797  
LEX_INVALID_CHARACTER
;

1805 *(*
p
)++)

1808 *
°©e
 = 0;

1809  
LEX_NULL
;

1812  
LEX_INVALID_CHARACTER
;

1820 
	`as£π
 (*
ãxt
 !
NULL
);

1821 **
p
)

1824 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1825  
LEX_MEMORY
;

1826 ++*
p
;

1827 *
°©e
 = 18;

1839 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1840  
LEX_MEMORY
;

1841 ++*
p
;

1842 *
°©e
 = 19;

1846  
LEX_INVALID_CHARACTER
;

1854 
	`as£π
 (*
ãxt
 !
NULL
);

1855 **
p
)

1861 ++*
p
;

1865 *
°©e
 = 0;

1866  
LEX_NUMBER
;

1870 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1871  
LEX_MEMORY
;

1872 ++*
p
;

1873 *
°©e
 = 20;

1878 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1879  
LEX_MEMORY
;

1880 ++*
p
;

1881 *
°©e
 = 22;

1885  
LEX_INVALID_CHARACTER
;

1893 
	`as£π
 (*
ãxt
 !
NULL
);

1894 **
p
)

1900 ++*
p
;

1904 *
°©e
 = 0;

1905  
LEX_NUMBER
;

1909 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1910  
LEX_MEMORY
;

1911 ++*
p
;

1912 *
°©e
 = 20;

1917 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1918  
LEX_MEMORY
;

1919 ++*
p
;

1920 *
°©e
 = 22;

1933 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1934  
LEX_MEMORY
;

1935 ++*
p
;

1939  
LEX_INVALID_CHARACTER
;

1947 
	`as£π
 (*
ãxt
 !
NULL
);

1948 **
p
)

1960 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1961  
LEX_MEMORY
;

1962 ++*
p
;

1963 *
°©e
 = 21;

1967  
LEX_INVALID_CHARACTER
;

1975 
	`as£π
 (*
ãxt
 !
NULL
);

1976 **
p
)

1982 ++*
p
;

1986 *
°©e
 = 0;

1987  
LEX_NUMBER
;

1992 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

1993  
LEX_MEMORY
;

1994 ++*
p
;

1995 *
°©e
 = 22;

2008 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

2009  
LEX_MEMORY
;

2010 ++*
p
;

2014  
LEX_INVALID_CHARACTER
;

2022 
	`as£π
 (*
ãxt
 !
NULL
);

2023 **
p
)

2027 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

2028  
LEX_MEMORY
;

2029 ++*
p
;

2030 *
°©e
 = 23;

2043 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

2044  
LEX_MEMORY
;

2045 ++*
p
;

2046 *
°©e
 = 24;

2050  
LEX_INVALID_CHARACTER
;

2058 
	`as£π
 (*
ãxt
 !
NULL
);

2059 **
p
)

2071 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

2072  
LEX_MEMORY
;

2073 ++*
p
;

2074 *
°©e
 = 24;

2078  
LEX_INVALID_CHARACTER
;

2086 
	`as£π
 (*
ãxt
 !
NULL
);

2087 **
p
)

2093 ++*
p
;

2097 *
°©e
 = 0;

2098  
LEX_NUMBER
;

2111 i‡(
	`rcs_ˇtc
 (*
ãxt
, **
p
Ë!
RS_OK
)

2112  
LEX_MEMORY
;

2113 ++*
p
;

2117  
LEX_INVALID_CHARACTER
;

2124 
	`Ârötf
 (
°dîr
, "JSON: *°©êmissög: %d\n", *
°©e
);

2125  
LEX_INVALID_CHARACTER
;

2130 *
p
 = 
NULL
;

2131  
LEX_MORE
;

2132 
	}
}

2135 
js⁄_îr‹


2136 
	$js⁄_∑r£_‰agmít
 (
js⁄_∑rsög_öfo
 *
öfo
, *
buf„r
)

2138 
js⁄_t
 *
ãmp
 = 
NULL
;

2140 
	`as£π
 (
öfo
 !
NULL
);

2141 
	`as£π
 (
buf„r
 !
NULL
);

2143 
öfo
->
p
 = 
buf„r
;

2144 *
öfo
->
p
 != '\0')

2146 
öfo
->
°©e
)

2150 
	`Àxî
 (
buf„r
, &
öfo
->
p
, &öfo->
Àx_°©e
, &öfo->
Àx_ãxt
, &öfo->
löe
))

2152 
LEX_BEGIN_OBJECT
:

2153 
öfo
->
°©e
 = 1;

2156 
LEX_INVALID_CHARACTER
:

2157  
JSON_MALFORMED_DOCUMENT
;

2161 
	`Ârötf
 (
°dîr
, "JSON: sèã %d: deÁu…edáàlöê%zd\n", 
öfo
->
°©e
, info->
löe
);

2162  
JSON_MALFORMED_DOCUMENT
;

2170 i‡(
öfo
->
curs‹
 =
NULL
)

2172 i‡((
öfo
->
curs‹
 = 
	`js⁄_√w_obje˘
 ()Ë=
NULL
)

2174  
JSON_MEMORY
;

2180 
	`as£π
 ((
öfo
->
curs‹
->
ty≥
 =
JSON_STRING
Ë|| (öfo->curs‹->ty≥ =
JSON_ARRAY
));

2182 i‡((
ãmp
 = 
	`js⁄_√w_obje˘
 ()Ë=
NULL
)

2184  
JSON_MEMORY
;

2186 i‡(
	`js⁄_ö£π_chûd
 (
öfo
->
curs‹
, 
ãmp
Ë!
JSON_OK
)

2188  
JSON_UNKNOWN_PROBLEM
;

2190 
öfo
->
curs‹
 = 
ãmp
;

2191 
ãmp
 = 
NULL
;

2193 
öfo
->
°©e
 = 2;

2200 
	`as£π
 (
öfo
->
curs‹
 !
NULL
);

2201 
	`as£π
 (
öfo
->
curs‹
->
ty≥
 =
JSON_OBJECT
);

2203 
	`Àxî
 (
buf„r
, &
öfo
->
p
, &öfo->
Àx_°©e
, &öfo->
Àx_ãxt
, &öfo->
löe
))

2205 
LEX_STRING
:

2206 i‡((
ãmp
 = 
	`js⁄_√w_vÆue
 (
JSON_STRING
)Ë=
NULL
)

2207  
JSON_MEMORY
;

2208 
ãmp
->
ãxt
 = 
	`rcs_unwøp
 (
öfo
->
Àx_ãxt
), info->Àx_ãxà
NULL
;

2209 i‡(
	`js⁄_ö£π_chûd
 (
öfo
->
curs‹
, 
ãmp
Ë!
JSON_OK
)

2212  
JSON_UNKNOWN_PROBLEM
;

2214 
öfo
->
curs‹
 = 
ãmp
;

2215 
ãmp
 = 
NULL
;

2216 
öfo
->
°©e
 = 5;

2219 
LEX_END_OBJECT
:

2220 i‡(
öfo
->
curs‹
->
∑ª¡
 =
NULL
)

2222 
öfo
->
°©e
 = 99;

2226 
öfo
->
curs‹
 = info->curs‹->
∑ª¡
;

2227 
öfo
->
curs‹
->
ty≥
)

2229 
JSON_STRING
:

2231 
	`as£π
 (
öfo
->
curs‹
->
∑ª¡
 !
NULL
);

2233 
öfo
->
curs‹
 = info->curs‹->
∑ª¡
;

2234 i‡(
öfo
->
curs‹
->
ty≥
 !
JSON_OBJECT
)

2236  
JSON_BAD_TREE_STRUCTURE
;

2240 
öfo
->
°©e
 = 3;

2244 
JSON_ARRAY
:

2245 
öfo
->
°©e
 = 9;

2249  
JSON_BAD_TREE_STRUCTURE
;

2254 
LEX_MORE
:

2255  
JSON_INCOMPLETE_DOCUMENT
;

2260 
	`Ârötf
 (
°dîr
, "JSON: sèã %d: deÁu…edáàlöê%zd\n", 
öfo
->
°©e
, info->
löe
);

2261  
JSON_MALFORMED_DOCUMENT
;

2270 
	`as£π
 (
öfo
->
curs‹
 !
NULL
);

2271 
	`as£π
 (
öfo
->
curs‹
->
ty≥
 =
JSON_OBJECT
);

2273 
	`Àxî
 (
buf„r
, &
öfo
->
p
, &öfo->
Àx_°©e
, &öfo->
Àx_ãxt
, &öfo->
löe
))

2275 
LEX_VALUE_SEPARATOR
:

2276 
öfo
->
°©e
 = 4;

2279 
LEX_END_OBJECT
:

2280 i‡(
öfo
->
curs‹
->
∑ª¡
 =
NULL
)

2282 
öfo
->
°©e
 = 99;

2286 
öfo
->
curs‹
 = info->curs‹->
∑ª¡
;

2287 
öfo
->
curs‹
->
ty≥
)

2289 
JSON_STRING
:

2291 
	`as£π
 (
öfo
->
curs‹
->
∑ª¡
 !
NULL
);

2293 
öfo
->
curs‹
 = info->curs‹->
∑ª¡
;

2294 i‡(
öfo
->
curs‹
->
ty≥
 !
JSON_OBJECT
)

2296  
JSON_BAD_TREE_STRUCTURE
;

2300 
öfo
->
°©e
 = 3;

2304 
JSON_ARRAY
:

2305 
öfo
->
°©e
 = 9;

2309  
JSON_BAD_TREE_STRUCTURE
;

2314 
LEX_MORE
:

2315  
JSON_INCOMPLETE_DOCUMENT
;

2319 
	`Ârötf
 (
°dîr
, "JSON: sèã %d: deÁu…edáàlöê%zd\n", 
öfo
->
°©e
, info->
löe
);

2320  
JSON_MALFORMED_DOCUMENT
;

2328 
	`as£π
 (
öfo
->
curs‹
 !
NULL
);

2329 
	`as£π
 (
öfo
->
curs‹
->
ty≥
 =
JSON_OBJECT
);

2331 
	`Àxî
 (
buf„r
, &
öfo
->
p
, &öfo->
Àx_°©e
, &öfo->
Àx_ãxt
, &öfo->
löe
))

2333 
LEX_STRING
:

2334 i‡((
ãmp
 = 
	`js⁄_√w_vÆue
 (
JSON_STRING
)Ë=
NULL
)

2335  
JSON_MEMORY
;

2336 
ãmp
->
ãxt
 = 
	`rcs_unwøp
 (
öfo
->
Àx_ãxt
), info->Àx_ãxà
NULL
;

2337 i‡(
	`js⁄_ö£π_chûd
 (
öfo
->
curs‹
, 
ãmp
Ë!
JSON_OK
)

2339  
JSON_UNKNOWN_PROBLEM
;

2341 
öfo
->
curs‹
 = 
ãmp
;

2342 
ãmp
 = 
NULL
;

2343 
öfo
->
°©e
 = 5;

2346 
LEX_MORE
:

2347  
JSON_INCOMPLETE_DOCUMENT
;

2350 
LEX_INVALID_CHARACTER
:

2351  
JSON_ILLEGAL_CHARACTER
;

2355 
	`Ârötf
 (
°dîr
, "JSON: sèã %d: deÁu…edáàlöê%zd\n", 
öfo
->
°©e
, info->
löe
);

2356  
JSON_MALFORMED_DOCUMENT
;

2365 
	`as£π
 (
öfo
->
curs‹
 !
NULL
);

2366 
	`as£π
 (
öfo
->
curs‹
->
ty≥
 =
JSON_STRING
);

2368 
	`Àxî
 (
buf„r
, &
öfo
->
p
, &öfo->
Àx_°©e
, &öfo->
Àx_ãxt
, &öfo->
löe
))

2370 
LEX_NAME_SEPARATOR
:

2371 
öfo
->
°©e
 = 6;

2374 
LEX_MORE
:

2375  
JSON_INCOMPLETE_DOCUMENT
;

2379 
	`Ârötf
 (
°dîr
, "JSON: sèã %d: deÁu…edáàlöê%zd\n", 
öfo
->
°©e
, info->
löe
);

2380  
JSON_MALFORMED_DOCUMENT
;

2388 
vÆue
;

2390 
	`as£π
 (
öfo
->
curs‹
 !
NULL
);

2391 
	`as£π
 (
öfo
->
curs‹
->
ty≥
 =
JSON_STRING
);

2393 
vÆue
 = 
	`Àxî
 (
buf„r
, &
öfo
->
p
, &öfo->
Àx_°©e
, &öfo->
Àx_ãxt
, &öfo->
löe
))

2395 
LEX_STRING
:

2396 i‡((
ãmp
 = 
	`js⁄_√w_vÆue
 (
JSON_STRING
)Ë=
NULL
)

2397  
JSON_MEMORY
;

2398 
ãmp
->
ãxt
 = 
	`rcs_unwøp
 (
öfo
->
Àx_ãxt
), info->Àx_ãxà
NULL
;

2399 i‡(
	`js⁄_ö£π_chûd
 (
öfo
->
curs‹
, 
ãmp
Ë!
JSON_OK
)

2402  
JSON_UNKNOWN_PROBLEM
;

2404 i‡(
öfo
->
curs‹
->
∑ª¡
 =
NULL
)

2406 
öfo
->
°©e
 = 99;

2410 
öfo
->
curs‹
 = info->curs‹->
∑ª¡
;

2412 
ãmp
 = 
NULL
;

2413 
öfo
->
°©e
 = 3;

2416 
LEX_NUMBER
:

2417 i‡((
ãmp
 = 
	`js⁄_√w_vÆue
 (
JSON_NUMBER
)Ë=
NULL
)

2418  
JSON_MEMORY
;

2419 
ãmp
->
ãxt
 = 
	`rcs_unwøp
 (
öfo
->
Àx_ãxt
), info->Àx_ãxà
NULL
;

2420 i‡(
	`js⁄_ö£π_chûd
 (
öfo
->
curs‹
, 
ãmp
Ë!
JSON_OK
)

2423  
JSON_UNKNOWN_PROBLEM
;

2425 i‡(
öfo
->
curs‹
->
∑ª¡
 =
NULL
)

2427 
öfo
->
°©e
 = 99;

2431 
öfo
->
curs‹
 = info->curs‹->
∑ª¡
;

2433 
ãmp
 = 
NULL
;

2434 
öfo
->
°©e
 = 3;

2437 
LEX_TRUE
:

2438 i‡((
ãmp
 = 
	`js⁄_√w_vÆue
 (
JSON_TRUE
)Ë=
NULL
)

2439  
JSON_MEMORY
;

2440 i‡(
	`js⁄_ö£π_chûd
 (
öfo
->
curs‹
, 
ãmp
Ë!
JSON_OK
)

2443  
JSON_UNKNOWN_PROBLEM
;

2445 i‡(
öfo
->
curs‹
->
∑ª¡
 =
NULL
)

2447 
öfo
->
°©e
 = 99;

2451 
öfo
->
curs‹
 = info->curs‹->
∑ª¡
;

2453 
ãmp
 = 
NULL
;

2454 
öfo
->
°©e
 = 3;

2457 
LEX_FALSE
:

2458 i‡((
ãmp
 = 
	`js⁄_√w_vÆue
 (
JSON_FALSE
)Ë=
NULL
)

2459  
JSON_MEMORY
;

2460 i‡(
	`js⁄_ö£π_chûd
 (
öfo
->
curs‹
, 
ãmp
Ë!
JSON_OK
)

2463  
JSON_UNKNOWN_PROBLEM
;

2465 i‡(
öfo
->
curs‹
->
∑ª¡
 =
NULL
)

2467 
öfo
->
°©e
 = 99;

2471 
öfo
->
curs‹
 = info->curs‹->
∑ª¡
;

2473 
ãmp
 = 
NULL
;

2474 
öfo
->
°©e
 = 3;

2477 
LEX_NULL
:

2478 i‡((
ãmp
 = 
	`js⁄_√w_vÆue
 (
JSON_NULL
)Ë=
NULL
)

2479  
JSON_MEMORY
;

2480 i‡(
	`js⁄_ö£π_chûd
 (
öfo
->
curs‹
, 
ãmp
Ë!
JSON_OK
)

2483  
JSON_UNKNOWN_PROBLEM
;

2485 i‡(
öfo
->
curs‹
->
∑ª¡
 =
NULL
)

2487 
öfo
->
°©e
 = 99;

2491 
öfo
->
curs‹
 = info->curs‹->
∑ª¡
;

2493 
ãmp
 = 
NULL
;

2494 
öfo
->
°©e
 = 3;

2497 
LEX_BEGIN_OBJECT
:

2498 
öfo
->
°©e
 = 1;

2501 
LEX_BEGIN_ARRAY
:

2502 
öfo
->
°©e
 = 7;

2505 
LEX_MORE
:

2506  
JSON_INCOMPLETE_DOCUMENT
;

2509 
LEX_MEMORY
:

2510  
JSON_MEMORY
;

2513 
LEX_INVALID_CHARACTER
:

2514  
JSON_ILLEGAL_CHARACTER
;

2518 
	`Ârötf
 (
°dîr
, "JSON: sèã %d: deÁu…edáàlöê%zd\n", 
öfo
->
°©e
, info->
löe
);

2519  
JSON_MALFORMED_DOCUMENT
;

2527 i‡(
öfo
->
curs‹
 =
NULL
)

2529 i‡((
öfo
->
curs‹
 = 
	`js⁄_√w_¨øy
 ()Ë=
NULL
)

2531  
JSON_MEMORY
;

2537 
	`as£π
 ((
öfo
->
curs‹
->
ty≥
 =
JSON_ARRAY
Ë|| (öfo->curs‹->ty≥ =
JSON_STRING
));

2539 i‡((
ãmp
 = 
	`js⁄_√w_¨øy
 ()Ë=
NULL
)

2541  
JSON_MEMORY
;

2543 i‡(
	`js⁄_ö£π_chûd
 (
öfo
->
curs‹
, 
ãmp
Ë!
JSON_OK
)

2545  
JSON_UNKNOWN_PROBLEM
;

2547 
öfo
->
curs‹
 = 
ãmp
;

2548 
ãmp
 = 
NULL
;

2550 
öfo
->
°©e
 = 8;

2557 
	`as£π
 (
öfo
->
curs‹
 !
NULL
);

2558 
	`as£π
 (
öfo
->
curs‹
->
ty≥
 =
JSON_ARRAY
);

2560 
	`Àxî
 (
buf„r
, &
öfo
->
p
, &öfo->
Àx_°©e
, &öfo->
Àx_ãxt
, &öfo->
löe
))

2562 
LEX_STRING
:

2563 i‡((
ãmp
 = 
	`js⁄_√w_vÆue
 (
JSON_STRING
)Ë=
NULL
)

2564  
JSON_MEMORY
;

2565 
ãmp
->
ãxt
 = 
	`rcs_unwøp
 (
öfo
->
Àx_ãxt
), info->Àx_ãxà
NULL
;

2566 i‡(
	`js⁄_ö£π_chûd
 (
öfo
->
curs‹
, 
ãmp
Ë!
JSON_OK
)

2568  
JSON_UNKNOWN_PROBLEM
;

2570 
ãmp
 = 
NULL
;

2571 
öfo
->
°©e
 = 9;

2574 
LEX_NUMBER
:

2575 i‡((
ãmp
 = 
	`js⁄_√w_vÆue
 (
JSON_NUMBER
)Ë=
NULL
)

2576  
JSON_MEMORY
;

2577 
ãmp
->
ãxt
 = 
	`rcs_unwøp
 (
öfo
->
Àx_ãxt
), info->Àx_ãxà
NULL
;

2578 i‡(
	`js⁄_ö£π_chûd
 (
öfo
->
curs‹
, 
ãmp
Ë!
JSON_OK
)

2580  
JSON_UNKNOWN_PROBLEM
;

2582 
ãmp
 = 
NULL
;

2583 
öfo
->
°©e
 = 9;

2586 
LEX_TRUE
:

2587 i‡((
ãmp
 = 
	`js⁄_√w_vÆue
 (
JSON_TRUE
)Ë=
NULL
)

2588  
JSON_MEMORY
;

2589 i‡(
	`js⁄_ö£π_chûd
 (
öfo
->
curs‹
, 
ãmp
Ë!
JSON_OK
)

2591  
JSON_UNKNOWN_PROBLEM
;

2593 
öfo
->
°©e
 = 9;

2596 
LEX_FALSE
:

2597 i‡((
ãmp
 = 
	`js⁄_√w_vÆue
 (
JSON_FALSE
)Ë=
NULL
)

2598  
JSON_MEMORY
;

2599 i‡(
	`js⁄_ö£π_chûd
 (
öfo
->
curs‹
, 
ãmp
Ë!
JSON_OK
)

2601  
JSON_UNKNOWN_PROBLEM
;

2603 
öfo
->
°©e
 = 9;

2606 
LEX_NULL
:

2607 i‡((
ãmp
 = 
	`js⁄_√w_vÆue
 (
JSON_NULL
)Ë=
NULL
)

2608  
JSON_MEMORY
;

2609 i‡(
	`js⁄_ö£π_chûd
 (
öfo
->
curs‹
, 
ãmp
Ë!
JSON_OK
)

2611  
JSON_UNKNOWN_PROBLEM
;

2613 
öfo
->
°©e
 = 9;

2616 
LEX_BEGIN_ARRAY
:

2617 
öfo
->
°©e
 = 7;

2620 
LEX_END_ARRAY
:

2621 i‡(
öfo
->
curs‹
->
∑ª¡
 =
NULL
)

2624 
öfo
->
°©e
 = 99;

2628 
öfo
->
curs‹
 = info->curs‹->
∑ª¡
;

2629 
öfo
->
curs‹
->
ty≥
)

2631 
JSON_STRING
:

2632 i‡(
öfo
->
curs‹
->
∑ª¡
 =
NULL
)

2633  
JSON_BAD_TREE_STRUCTURE
;

2636 
öfo
->
curs‹
 = info->curs‹->
∑ª¡
;

2637 i‡(
öfo
->
curs‹
->
ty≥
 !
JSON_OBJECT
)

2639  
JSON_BAD_TREE_STRUCTURE
;

2642 
öfo
->
°©e
 = 3;

2646 
JSON_ARRAY
:

2647 
öfo
->
°©e
 = 9;

2651  
JSON_BAD_TREE_STRUCTURE
;

2656 
LEX_BEGIN_OBJECT
:

2657 
öfo
->
°©e
 = 1;

2660 
LEX_MORE
:

2661  
JSON_INCOMPLETE_DOCUMENT
;

2664 
LEX_INVALID_CHARACTER
:

2665  
JSON_ILLEGAL_CHARACTER
;

2669 
	`Ârötf
 (
°dîr
, "JSON: sèã %d: deÁu…edáàlöê%zd\n", 
öfo
->
°©e
, info->
löe
);

2670  
JSON_MALFORMED_DOCUMENT
;

2679 
	`as£π
 (
öfo
->
curs‹
 !
NULL
);

2680 
	`Àxî
 (
buf„r
, &
öfo
->
p
, &öfo->
Àx_°©e
, &öfo->
Àx_ãxt
, &öfo->
löe
))

2682 
LEX_VALUE_SEPARATOR
:

2683 
öfo
->
°©e
 = 8;

2686 
LEX_END_ARRAY
:

2687 i‡(
öfo
->
curs‹
->
∑ª¡
 =
NULL
)

2689 
öfo
->
°©e
 = 99;

2693 
öfo
->
curs‹
 = info->curs‹->
∑ª¡
;

2694 
öfo
->
curs‹
->
ty≥
)

2696 
JSON_STRING
:

2697 i‡(
öfo
->
curs‹
->
∑ª¡
 =
NULL
)

2699 
öfo
->
°©e
 = 99;

2703 
öfo
->
curs‹
 = info->curs‹->
∑ª¡
;

2704 i‡(
öfo
->
curs‹
->
ty≥
 !
JSON_OBJECT
)

2706  
JSON_BAD_TREE_STRUCTURE
;

2710 
öfo
->
°©e
 = 3;

2715 
JSON_ARRAY
:

2716 
öfo
->
°©e
 = 9;

2720  
JSON_BAD_TREE_STRUCTURE
;

2725 
LEX_MORE
:

2726  
JSON_INCOMPLETE_DOCUMENT
;

2730 
	`Ârötf
 (
°dîr
, "JSON: sèã %d: deÁu…edáàlöê%zd\n", 
öfo
->
°©e
, info->
löe
);

2731  
JSON_MALFORMED_DOCUMENT
;

2740 
	`as£π
 (
öfo
->
curs‹
->
∑ª¡
 =
NULL
);

2741 
	`Àxî
 (
buf„r
, &
öfo
->
p
, &öfo->
Àx_°©e
, &öfo->
Àx_ãxt
, &öfo->
löe
))

2743 
LEX_MORE
:

2744  
JSON_WAITING_FOR_EOF
;

2747 
LEX_MEMORY
:

2748  
JSON_MEMORY
;

2752  
JSON_MALFORMED_DOCUMENT
;

2759 
	`Ârötf
 (
°dîr
, "JSON: sèã %d: deÁu…edáàlöê%zd\n", 
öfo
->
°©e
, info->
löe
);

2760  
JSON_UNKNOWN_PROBLEM
;

2763 
öfo
->
p
 = 
NULL
;

2764 i‡(
öfo
->
°©e
 == 99)

2765  
JSON_WAITING_FOR_EOF
;

2767  
JSON_INCOMPLETE_DOCUMENT
;

2768 
	}
}

2772 
js⁄_îr‹


2773 
	$js⁄_∑r£_documít
 (
js⁄_t
 ** 
roŸ
, *
ãxt
)

2775 
js⁄_îr‹
 
îr‹
;

2776 
js⁄_∑rsög_öfo
 *
jpi
;

2778 
	`as£π
 (
roŸ
 !
NULL
);

2779 
	`as£π
 (*
roŸ
 =
NULL
);

2780 
	`as£π
 (
ãxt
 !
NULL
);

2783 
jpi
 = 
	`mÆloc
 ( (
js⁄_∑rsög_öfo
));

2784 i‡(
jpi
 =
NULL
)

2786  
JSON_MEMORY
;

2788 
	`js⁄_jpi_öô
 (
jpi
);

2790 
îr‹
 = 
	`js⁄_∑r£_‰agmít
 (
jpi
, 
ãxt
);

2791 i‡((
îr‹
 =
JSON_WAITING_FOR_EOF
Ë|| (îr‹ =
JSON_OK
))

2793 *
roŸ
 = 
jpi
->
curs‹
;

2794 
	`‰ì
 (
jpi
);

2795  
JSON_OK
;

2799 
	`‰ì
 (
jpi
);

2800  
îr‹
;

2802 
	}
}

2805 
js⁄_îr‹


2806 
	$js⁄_ßxy_∑r£
 (
js⁄_ßxy_∑r£r_°©us
 *
j•s
, 
js⁄_ßxy_fun˘i⁄s
 *
jsf
, 
c
)

2813 
	`as£π
 (
j•s
 !
NULL
);

2814 
	`as£π
 (
jsf
 !
NULL
);

2818 
j•s
->
°©e
)

2821 
°©e0
;

2824 
°©e1
;

2827 
°©e2
;

2830 
°©e3
;

2833 
°©e4
;

2836 
°©e5
;

2839 
°©e6
;

2842 
°©e7
;

2845 
°©e8
;

2848 
°©e9
;

2851 
°©e10
;

2854 
°©e11
;

2857 
°©e12
;

2860 
°©e13
;

2863 
°©e14
;

2866 
°©e15
;

2869 
°©e16
;

2872 
°©e17
;

2875 
°©e18
;

2878 
°©e19
;

2881 
°©e20
;

2884 
°©e21
;

2887 
°©e22
;

2890 
°©e23
;

2893 
°©e24
;

2896 
°©e25
;

2899 
°©e26
;

2902 
°©e27
;

2906  
JSON_UNKNOWN_PROBLEM
;

2909 
°©e0
:

2911 
c
)

2920 
j•s
->
°rög_Àngth_limô_ªached
 = 0;

2921 
j•s
->
°©e
 = 1;

2925 i‡(
jsf
->
›í_obje˘
 !
NULL
)

2926 
jsf
->
	`›í_obje˘
 ();

2927 
j•s
->
°©e
 = 25;

2931 i‡(
jsf
->
˛o£_obje˘
 !
NULL
)

2932 
jsf
->
	`˛o£_obje˘
 ();

2933 
j•s
->
°©e
 = 26;

2937 i‡(
jsf
->
›í_¨øy
 !
NULL
)

2938 
jsf
->
	`›í_¨øy
 ();

2943 i‡(
jsf
->
˛o£_¨øy
 !
NULL
)

2944 
jsf
->
	`˛o£_¨øy
 ();

2945 
j•s
->
°©e
 = 26;

2949 
j•s
->
°©e
 = 7;

2953 
j•s
->
°©e
 = 10;

2957 
j•s
->
°©e
 = 14;

2961 i‡(
jsf
->
œbñ_vÆue_£∑øt‹
 !
NULL
)

2962 
jsf
->
	`œbñ_vÆue_£∑øt‹
 ();

2967 i‡(
jsf
->
siblög_£∑øt‹
 !
NULL
)

2968 
jsf
->
	`siblög_£∑øt‹
 ();

2969 
j•s
->
°©e
 = 27;

2973 
j•s
->
°rög_Àngth_limô_ªached
 = 0;

2974 
j•s
->
°©e
 = 17;

2975 i‡((
j•s
->
ãmp
 = 
	`rcs_¸óã
 (5)Ë=
NULL
)

2977  
JSON_MEMORY
;

2979 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), '0'Ë!
RS_OK
)

2981  
JSON_MEMORY
;

2994 
j•s
->
°rög_Àngth_limô_ªached
 = 0;

2995 
j•s
->
°©e
 = 24;

2996 i‡((
j•s
->
ãmp
 = 
	`rcs_¸óã
 (5)Ë=
NULL
)

2998  
JSON_MEMORY
;

3000 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), 
c
Ë!
RS_OK
)

3002  
JSON_MEMORY
;

3007 
j•s
->
°rög_Àngth_limô_ªached
 = 0;

3008 
j•s
->
°©e
 = 23;

3009 
j•s
->
ãmp
 = 
NULL
;

3010 i‡((
j•s
->
ãmp
 = 
	`rcs_¸óã
 (5)Ë=
NULL
)

3012  
JSON_MEMORY
;

3014 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), '-'Ë!
RS_OK
)

3016  
JSON_MEMORY
;

3022  
JSON_ILLEGAL_CHARACTER
;

3025  
JSON_OK
;

3028 
°©e1
:

3030 
c
)

3033 i‡(!
j•s
->
°rög_Àngth_limô_ªached
)

3035 i‡(
	`rcs_Àngth
 ((
j•s
->
ãmp
)Ë< 
JSON_MAX_STRING_LENGTH
 - 1)

3037 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), '\\'Ë!
RS_OK
)

3039  
JSON_MEMORY
;

3044 
j•s
->
°rög_Àngth_limô_ªached
 = 1;

3047 
j•s
->
°©e
 = 2;

3051 i‡((
j•s
->
ãmp
Ë!
NULL
)

3053 
j•s
->
°©e
 = 0;

3054 i‡(
jsf
->
√w_°rög
 !
NULL
)

3055 
jsf
->
	`√w_°rög
 (((
j•s
->
ãmp
))->
ãxt
);

3056 
	`rcs_‰ì
 (&
j•s
->
ãmp
);

3059  
JSON_UNKNOWN_PROBLEM
;

3063 i‡(!
j•s
->
°rög_Àngth_limô_ªached
)

3065 i‡(
	`rcs_Àngth
 ((
j•s
->
ãmp
)Ë< 
JSON_MAX_STRING_LENGTH
)

3067 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), 
c
Ë!
RS_OK
)

3069  
JSON_MEMORY
;

3074 
j•s
->
°rög_Àngth_limô_ªached
 = 1;

3079  
JSON_OK
;

3082 
°©e2
:

3084 
c
)

3094 i‡(!
j•s
->
°rög_Àngth_limô_ªached
)

3096 i‡(
	`rcs_Àngth
 ((
j•s
->
ãmp
)Ë< 
JSON_MAX_STRING_LENGTH
)

3098 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), 
c
Ë!
RS_OK
)

3100  
JSON_MEMORY
;

3105 
j•s
->
°rög_Àngth_limô_ªached
 = 1;

3111 i‡(!
j•s
->
°rög_Àngth_limô_ªached
)

3113 i‡(
	`rcs_Àngth
 ((
j•s
->
ãmp
)Ë< 
JSON_MAX_STRING_LENGTH
 - 4)

3115 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), 'u'Ë!
RS_OK
)

3117  
JSON_MEMORY
;

3122 
j•s
->
°rög_Àngth_limô_ªached
 = 1;

3125 
j•s
->
°©e
 = 3;

3129  
JSON_ILLEGAL_CHARACTER
;

3132  
JSON_OK
;

3135 
°©e3
:

3137 
c
)

3161 i‡(!
j•s
->
°rög_Àngth_limô_ªached
)

3163 i‡(
	`rcs_Àngth
 ((
j•s
->
ãmp
)Ë< 
JSON_MAX_STRING_LENGTH
 - 3)

3165 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), 'u'Ë!
RS_OK
)

3167  
JSON_MEMORY
;

3172 
j•s
->
°rög_Àngth_limô_ªached
 = 1;

3175 
j•s
->
°©e
 = 4;

3179  
JSON_ILLEGAL_CHARACTER
;

3181  
JSON_OK
;

3184 
°©e4
:

3186 
c
)

3210 i‡(!
j•s
->
°rög_Àngth_limô_ªached
)

3212 i‡(
	`rcs_Àngth
 ((
j•s
->
ãmp
)Ë< 
JSON_MAX_STRING_LENGTH
 - 2)

3214 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), 
c
Ë!
RS_OK
)

3216  
JSON_MEMORY
;

3221 
j•s
->
°rög_Àngth_limô_ªached
 = 1;

3224 
j•s
->
°©e
 = 5;

3228  
JSON_ILLEGAL_CHARACTER
;

3230  
JSON_OK
;

3233 
°©e5
:

3235 
c
)

3259 i‡(!
j•s
->
°rög_Àngth_limô_ªached
)

3261 i‡(
	`rcs_Àngth
 ((
j•s
->
ãmp
)Ë< 
JSON_MAX_STRING_LENGTH
 - 1)

3263 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), 
c
Ë!
RS_OK
)

3265  
JSON_MEMORY
;

3270 
j•s
->
°rög_Àngth_limô_ªached
 = 1;

3273 
j•s
->
°©e
 = 6;

3277  
JSON_ILLEGAL_CHARACTER
;

3279  
JSON_OK
;

3282 
°©e6
:

3284 
c
)

3308 i‡(!
j•s
->
°rög_Àngth_limô_ªached
)

3310 i‡(
	`rcs_Àngth
 ((
j•s
->
ãmp
)Ë< 
JSON_MAX_STRING_LENGTH
)

3312 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), 
c
Ë!
RS_OK
)

3314  
JSON_MEMORY
;

3319 
j•s
->
°rög_Àngth_limô_ªached
 = 1;

3322 
j•s
->
°©e
 = 1;

3326  
JSON_ILLEGAL_CHARACTER
;

3328  
JSON_OK
;

3331 
°©e7
:

3333 i‡(
c
 != 'r')

3335  
JSON_ILLEGAL_CHARACTER
;

3338 
j•s
->
°©e
 = 8;

3339  
JSON_OK
;

3342 
°©e8
:

3344 i‡(
c
 != 'u')

3346  
JSON_ILLEGAL_CHARACTER
;

3349 
j•s
->
°©e
 = 9;

3350  
JSON_OK
;

3353 
°©e9
:

3355 i‡(
c
 != 'e')

3357  
JSON_ILLEGAL_CHARACTER
;

3360 
j•s
->
°©e
 = 0;

3361 i‡(
jsf
->
√w_åue
 !
NULL
)

3362 
jsf
->
	`√w_åue
 ();

3363  
JSON_OK
;

3366 
°©e10
:

3368 i‡(
c
 != 'a')

3370  
JSON_ILLEGAL_CHARACTER
;

3373 
j•s
->
°©e
 = 11;

3374  
JSON_OK
;

3377 
°©e11
:

3379 i‡(
c
 != 'l')

3381  
JSON_ILLEGAL_CHARACTER
;

3384 
j•s
->
°©e
 = 12;

3385  
JSON_OK
;

3388 
°©e12
:

3390 i‡(
c
 != 's')

3392  
JSON_ILLEGAL_CHARACTER
;

3395 
j•s
->
°©e
 = 13;

3396  
JSON_OK
;

3399 
°©e13
:

3401 i‡(
c
 != 'e')

3403  
JSON_ILLEGAL_CHARACTER
;

3406 
j•s
->
°©e
 = 0;

3407 i‡(
jsf
->
√w_Ál£
 !
NULL
)

3408 
jsf
->
	`√w_Ál£
 ();

3409  
JSON_OK
;

3412 
°©e14
:

3414 i‡(
c
 != 'u')

3416  
JSON_ILLEGAL_CHARACTER
;

3419 
j•s
->
°©e
 = 15;

3420  
JSON_OK
;

3423 
°©e15
:

3425 i‡(
c
 != 'l')

3427  
JSON_ILLEGAL_CHARACTER
;

3430 
j•s
->
°©e
 = 16;

3431  
JSON_OK
;

3434 
°©e16
:

3436 i‡(
c
 != 'l')

3438  
JSON_ILLEGAL_CHARACTER
;

3441 
j•s
->
°©e
 = 0;

3442 i‡(
jsf
->
√w_nuŒ
 !
NULL
)

3443 
jsf
->
	`√w_nuŒ
 ();

3444  
JSON_OK
;

3447 
°©e17
:

3449 
c
)

3452 i‡((
j•s
->
ãmp
 = 
	`rcs_¸óã
 (5)Ë=
NULL
)

3454  
JSON_MEMORY
;

3456 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), '.'Ë!
RS_OK
)

3458  
JSON_MEMORY
;

3460 
j•s
->
°©e
 = 18;

3467 i‡((
j•s
->
ãmp
Ë=
NULL
)

3468  
JSON_MEMORY
;

3469 i‡(
jsf
->
√w_numbî
 !
NULL
)

3471 
jsf
->
	`√w_numbî
 ((
j•s
->
ãmp
)->
ãxt
);

3473 
	`rcs_‰ì
 (&
j•s
->
ãmp
);

3475 
j•s
->
°©e
 = 0;

3479 i‡((
j•s
->
ãmp
Ë=
NULL
)

3480  
JSON_MEMORY
;

3481 i‡(
jsf
->
√w_numbî
 !
NULL
)

3483 
jsf
->
	`√w_numbî
 ((
j•s
->
ãmp
)->
ãxt
);

3485 
	`rcs_‰ì
 (&
j•s
->
ãmp
);

3487 i‡(
jsf
->
›í_obje˘
 !
NULL
)

3488 
jsf
->
	`˛o£_obje˘
 ();

3489 
j•s
->
°©e
 = 26;

3494 i‡((
j•s
->
ãmp
Ë=
NULL
)

3495  
JSON_MEMORY
;

3496 i‡(
jsf
->
√w_numbî
 !
NULL
)

3498 
jsf
->
	`√w_numbî
 ((
j•s
->
ãmp
)->
ãxt
);

3500 
	`rcs_‰ì
 (&
j•s
->
ãmp
);

3502 i‡(
jsf
->
›í_obje˘
 !
NULL
)

3503 
jsf
->
	`˛o£_¨øy
 ();

3504 
j•s
->
°©e
 = 26;

3509 i‡((
j•s
->
ãmp
Ë=
NULL
)

3510  
JSON_MEMORY
;

3511 i‡(
jsf
->
√w_numbî
 !
NULL
)

3513 
jsf
->
	`√w_numbî
 ((
j•s
->
ãmp
)->
ãxt
);

3515 
	`rcs_‰ì
 (&
j•s
->
ãmp
);

3517 i‡(
jsf
->
›í_obje˘
 !
NULL
)

3518 
jsf
->
	`œbñ_vÆue_£∑øt‹
 ();

3519 
j•s
->
°©e
 = 27;

3523  
JSON_ILLEGAL_CHARACTER
;

3527  
JSON_OK
;

3530 
°©e18
:

3532 
c
)

3544 i‡(!
j•s
->
°rög_Àngth_limô_ªached
)

3546 i‡(
	`rcs_Àngth
 ((
j•s
->
ãmp
)Ë< 
JSON_MAX_STRING_LENGTH
 / 2)

3548 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), 
c
Ë!
RS_OK
)

3550  
JSON_MEMORY
;

3555 
j•s
->
°rög_Àngth_limô_ªached
 = 1;

3558 
j•s
->
°©e
 = 19;

3562  
JSON_ILLEGAL_CHARACTER
;

3565  
JSON_OK
;

3568 
°©e19
:

3570 
c
)

3582 i‡(!
j•s
->
°rög_Àngth_limô_ªached
)

3584 i‡(
	`rcs_Àngth
 ((
j•s
->
ãmp
)Ë< 
JSON_MAX_STRING_LENGTH
 / 2)

3586 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), 
c
Ë!
RS_OK
)

3588  
JSON_MEMORY
;

3593 
j•s
->
°rög_Àngth_limô_ªached
 = 1;

3601 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), 
c
Ë!
RS_OK
)

3603  
JSON_MEMORY
;

3606 
j•s
->
°©e
 = 20;

3615 i‡((
j•s
->
ãmp
Ë=
NULL
)

3616  
JSON_MEMORY
;

3617 i‡(
jsf
->
√w_numbî
 !
NULL
)

3619 
jsf
->
	`√w_numbî
 ((
j•s
->
ãmp
)->
ãxt
);

3621 
	`rcs_‰ì
 (&
j•s
->
ãmp
);

3623 
j•s
->
°©e
 = 0;

3628 i‡((
j•s
->
ãmp
Ë=
NULL
)

3629  
JSON_MEMORY
;

3630 i‡(
jsf
->
√w_numbî
 !
NULL
)

3632 
jsf
->
	`√w_numbî
 ((
j•s
->
ãmp
)->
ãxt
);

3634 
	`rcs_‰ì
 (&
j•s
->
ãmp
);

3636 i‡(
jsf
->
›í_obje˘
 !
NULL
)

3637 
jsf
->
	`˛o£_obje˘
 ();

3638 
j•s
->
°©e
 = 26;

3642 i‡(
jsf
->
√w_numbî
 !
NULL
)

3644 i‡((
j•s
->
ãmp
Ë=
NULL
)

3645  
JSON_MEMORY
;

3646 
jsf
->
	`√w_numbî
 ((
j•s
->
ãmp
)->
ãxt
);

3647 
	`rcs_‰ì
 (&
j•s
->
ãmp
);

3651 
	`rcs_‰ì
 (&
j•s
->
ãmp
);

3652 
j•s
->
ãmp
 = 
NULL
;

3654 i‡(
jsf
->
›í_obje˘
 !
NULL
)

3655 
jsf
->
	`˛o£_¨øy
 ();

3656 
j•s
->
°©e
 = 26;

3661 i‡((
j•s
->
ãmp
Ë=
NULL
)

3662  
JSON_MEMORY
;

3663 i‡(
jsf
->
√w_numbî
 !
NULL
)

3665 
jsf
->
	`√w_numbî
 ((
j•s
->
ãmp
)->
ãxt
);

3667 
	`rcs_‰ì
 (&
j•s
->
ãmp
);

3669 i‡(
jsf
->
œbñ_vÆue_£∑øt‹
 !
NULL
)

3670 
jsf
->
	`œbñ_vÆue_£∑øt‹
 ();

3671 
j•s
->
°©e
 = 27;

3676  
JSON_ILLEGAL_CHARACTER
;

3679  
JSON_OK
;

3682 
°©e20
:

3684 
c
)

3688 
j•s
->
°rög_Àngth_limô_ªached
 = 0;

3689 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), 
c
Ë!
RS_OK
)

3691  
JSON_MEMORY
;

3694 
j•s
->
°©e
 = 22;

3707 i‡(!
j•s
->
°rög_Àngth_limô_ªached
)

3709 i‡(
	`rcs_Àngth
 ((
j•s
->
ãmp
)Ë< 
JSON_MAX_STRING_LENGTH
)

3711 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), 
c
Ë!
RS_OK
)

3713  
JSON_MEMORY
;

3719 
j•s
->
°rög_Àngth_limô_ªached
 = 1;

3722 
j•s
->
°©e
 = 21;

3726  
JSON_ILLEGAL_CHARACTER
;

3729  
JSON_OK
;

3732 
°©e21
:

3734 
c
)

3746 i‡(!
j•s
->
°rög_Àngth_limô_ªached
)

3748 i‡(
	`rcs_Àngth
 ((
j•s
->
ãmp
)Ë< 
JSON_MAX_STRING_LENGTH
)

3750 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), 
c
Ë!
RS_OK
)

3752  
JSON_MEMORY
;

3757 
j•s
->
°rög_Àngth_limô_ªached
 = 1;

3768 i‡((
j•s
->
ãmp
Ë=
NULL
)

3769  
JSON_MEMORY
;

3770 i‡(
jsf
->
√w_numbî
 !
NULL
)

3772 
jsf
->
	`√w_numbî
 ((
j•s
->
ãmp
)->
ãxt
);

3774 
	`rcs_‰ì
 (&
j•s
->
ãmp
);

3776 
j•s
->
°©e
 = 0;

3780 i‡((
j•s
->
ãmp
Ë=
NULL
)

3781  
JSON_MEMORY
;

3782 i‡(
jsf
->
√w_numbî
 !
NULL
)

3784 
jsf
->
	`√w_numbî
 ((
j•s
->
ãmp
)->
ãxt
);

3786 
	`rcs_‰ì
 (&
j•s
->
ãmp
);

3788 i‡(
jsf
->
›í_obje˘
 !
NULL
)

3789 
jsf
->
	`˛o£_obje˘
 ();

3790 
j•s
->
°©e
 = 26;

3794 i‡(
jsf
->
√w_numbî
 !
NULL
)

3796 i‡((
j•s
->
ãmp
Ë=
NULL
)

3797  
JSON_MEMORY
;

3798 
jsf
->
	`√w_numbî
 ((
j•s
->
ãmp
)->
ãxt
);

3799 
	`‰ì
 (
j•s
->
ãmp
);

3800 
j•s
->
ãmp
 = 
NULL
;

3804 
	`‰ì
 ((
j•s
->
ãmp
));

3805 
j•s
->
ãmp
 = 
NULL
;

3807 i‡(
jsf
->
›í_obje˘
 !
NULL
)

3808 
jsf
->
	`˛o£_¨øy
 ();

3809 
j•s
->
°©e
 = 26;

3813 i‡(
jsf
->
√w_numbî
 !
NULL
)

3815 i‡((
j•s
->
ãmp
Ë=
NULL
)

3816  
JSON_MEMORY
;

3817 
jsf
->
	`√w_numbî
 ((
j•s
->
ãmp
)->
ãxt
);

3818 
	`‰ì
 ((
j•s
->
ãmp
));

3819 
j•s
->
ãmp
 = 
NULL
;

3823 
	`‰ì
 (
j•s
->
ãmp
);

3824 
j•s
->
ãmp
 = 
NULL
;

3826 i‡(
jsf
->
œbñ_vÆue_£∑øt‹
 !
NULL
)

3827 
jsf
->
	`œbñ_vÆue_£∑øt‹
 ();

3828 
j•s
->
°©e
 = 27;

3832  
JSON_ILLEGAL_CHARACTER
;

3835  
JSON_OK
;

3838 
°©e22
:

3840 
c
)

3852 i‡(!
j•s
->
°rög_Àngth_limô_ªached
)

3854 i‡(
	`rcs_Àngth
 ((
j•s
->
ãmp
)Ë< 
JSON_MAX_STRING_LENGTH
)

3856 
	`rcs_ˇtc
 ((
j•s
->
ãmp
), 
c
);

3860 
j•s
->
°rög_Àngth_limô_ªached
 = 1;

3863 
j•s
->
°©e
 = 21;

3867  
JSON_ILLEGAL_CHARACTER
;

3870  
JSON_OK
;

3873 
°©e23
:

3875 
c
)

3878 
	`rcs_ˇtc
 ((
j•s
->
ãmp
), 
c
);

3879 
j•s
->
°©e
 = 17;

3891 i‡(!
j•s
->
°rög_Àngth_limô_ªached
)

3893 i‡(
	`rcs_Àngth
 ((
j•s
->
ãmp
)Ë< 
JSON_MAX_STRING_LENGTH
 / 2)

3895 i‡((
j•s
->
ãmp
 = 
	`rcs_¸óã
 (5)Ë=
NULL
)

3897  
JSON_MEMORY
;

3899 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), 
c
Ë!
RS_OK
)

3901  
JSON_MEMORY
;

3905 
j•s
->
°rög_Àngth_limô_ªached
 = 1;

3909 
j•s
->
°©e
 = 24;

3913  
JSON_ILLEGAL_CHARACTER
;

3916  
JSON_OK
;

3919 
°©e24
:

3921 
c
)

3933 i‡(!
j•s
->
°rög_Àngth_limô_ªached
)

3935 i‡(
	`rcs_Àngth
 ((
j•s
->
ãmp
)Ë< 
JSON_MAX_STRING_LENGTH
 / 2)

3937 i‡((
j•s
->
ãmp
 = 
	`rcs_¸óã
 (5)Ë=
NULL
)

3939  
JSON_MEMORY
;

3941 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), 
c
Ë!
RS_OK
)

3943  
JSON_MEMORY
;

3948 
j•s
->
°rög_Àngth_limô_ªached
 = 1;

3955 i‡((
j•s
->
ãmp
 = 
	`rcs_¸óã
 (5)Ë=
NULL
)

3957  
JSON_MEMORY
;

3959 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), '.'Ë!
RS_OK
)

3961  
JSON_MEMORY
;

3964 
j•s
->
°©e
 = 18;

3969 i‡((
j•s
->
ãmp
 = 
	`rcs_¸óã
 (5)Ë=
NULL
)

3971  
JSON_MEMORY
;

3973 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), 
c
Ë!
RS_OK
)

3975  
JSON_MEMORY
;

3978 
j•s
->
°rög_Àngth_limô_ªached
 = 0;

3979 
j•s
->
°©e
 = 20;

3986 i‡((
j•s
->
ãmp
Ë=
NULL
)

3987  
JSON_MEMORY
;

3988 i‡(
jsf
->
√w_numbî
 !
NULL
)

3990 
jsf
->
	`√w_numbî
 ((
j•s
->
ãmp
)->
ãxt
);

3992 
	`rcs_‰ì
 (&
j•s
->
ãmp
);

3994 
j•s
->
°©e
 = 0;

3998 i‡((
j•s
->
ãmp
Ë=
NULL
)

3999  
JSON_MEMORY
;

4000 i‡(
jsf
->
√w_numbî
 !
NULL
)

4002 
jsf
->
	`√w_numbî
 ((
j•s
->
ãmp
)->
ãxt
);

4004 
	`rcs_‰ì
 (&
j•s
->
ãmp
);

4006 i‡(
jsf
->
›í_obje˘
 !
NULL
)

4007 
jsf
->
	`˛o£_obje˘
 ();

4008 
j•s
->
°©e
 = 26;

4012 i‡((
j•s
->
ãmp
Ë=
NULL
)

4013  
JSON_MEMORY
;

4014 i‡(
jsf
->
√w_numbî
 !
NULL
)

4016 
jsf
->
	`√w_numbî
 ((
j•s
->
ãmp
)->
ãxt
);

4018 
	`rcs_‰ì
 (&
j•s
->
ãmp
);

4020 i‡(
jsf
->
›í_obje˘
 !
NULL
)

4021 
jsf
->
	`˛o£_¨øy
 ();

4022 
j•s
->
°©e
 = 26;

4026 i‡((
j•s
->
ãmp
Ë=
NULL
)

4027  
JSON_MEMORY
;

4028 i‡(
jsf
->
√w_numbî
 !
NULL
)

4030 
jsf
->
	`√w_numbî
 ((
j•s
->
ãmp
)->
ãxt
);

4032 
	`rcs_‰ì
 (&
j•s
->
ãmp
);

4034 i‡(
jsf
->
œbñ_vÆue_£∑øt‹
 !
NULL
)

4035 
jsf
->
	`œbñ_vÆue_£∑øt‹
 ();

4036 
j•s
->
°©e
 = 27;

4040  
JSON_ILLEGAL_CHARACTER
;

4043  
JSON_OK
;

4046 
°©e25
:

4048 
c
)

4057 
j•s
->
ãmp
 = 
NULL
;

4058 
j•s
->
°©e
 = 1;

4062 i‡(
jsf
->
˛o£_obje˘
 !
NULL
)

4063 
jsf
->
	`˛o£_obje˘
 ();

4064 
j•s
->
°©e
 = 26;

4068  
JSON_ILLEGAL_CHARACTER
;

4071  
JSON_OK
;

4074 
°©e26
:

4076 
c
)

4085 i‡(
jsf
->
˛o£_obje˘
 !
NULL
)

4086 
jsf
->
	`˛o£_obje˘
 ();

4091 i‡(
jsf
->
˛o£_¨øy
 !
NULL
)

4092 
jsf
->
	`˛o£_¨øy
 ();

4097 i‡(
jsf
->
siblög_£∑øt‹
 !
NULL
)

4098 
jsf
->
	`siblög_£∑øt‹
 ();

4099 
j•s
->
°©e
 = 27;

4103  
JSON_ILLEGAL_CHARACTER
;

4106  
JSON_OK
;

4109 
°©e27
:

4111 
c
)

4120 
j•s
->
°©e
 = 1;

4121 
j•s
->
ãmp
 = 
NULL
;

4125 i‡(
jsf
->
›í_obje˘
 !
NULL
)

4126 
jsf
->
	`›í_obje˘
 ();

4127 
j•s
->
°©e
 = 25;

4131 i‡(
jsf
->
›í_¨øy
 !
NULL
)

4132 
jsf
->
	`›í_¨øy
 ();

4137 
j•s
->
°©e
 = 7;

4141 
j•s
->
°©e
 = 10;

4145 
j•s
->
°©e
 = 14;

4149 
j•s
->
°©e
 = 17;

4150 i‡((
j•s
->
ãmp
 = 
	`rcs_¸óã
 (5)Ë=
NULL
)

4152  
JSON_MEMORY
;

4154 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), '0'Ë!
RS_OK
)

4156  
JSON_MEMORY
;

4169 
j•s
->
°©e
 = 24;

4170 i‡((
j•s
->
ãmp
 = 
	`rcs_¸óã
 (5)Ë=
NULL
)

4172  
JSON_MEMORY
;

4174 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), 
c
Ë!
RS_OK
)

4176  
JSON_MEMORY
;

4181 
j•s
->
°©e
 = 23;

4182 i‡((
j•s
->
ãmp
 = 
	`rcs_¸óã
 (
RSTRING_DEFAULT
)Ë=
NULL
)

4184  
JSON_MEMORY
;

4186 i‡(
	`rcs_ˇtc
 ((
j•s
->
ãmp
), '-'Ë!
RS_OK
)

4188  
JSON_MEMORY
;

4193  
JSON_ILLEGAL_CHARACTER
;

4196  
JSON_OK
;

4199  
JSON_UNKNOWN_PROBLEM
;

4200 
	}
}

4203 
js⁄_t
 *

4204 
	$js⁄_föd_fú°_œbñ
 (c⁄° 
js⁄_t
 * 
obje˘
, c⁄° *
ãxt_œbñ
)

4206 
js⁄_t
 *
curs‹
;

4208 
	`as£π
 (
obje˘
 !
NULL
);

4209 
	`as£π
 (
ãxt_œbñ
 !
NULL
);

4210 
	`as£π
 (
obje˘
->
ty≥
 =
JSON_OBJECT
);

4212 
curs‹
 = 
obje˘
->
chûd
; curs‹ !
NULL
; curs‹ = curs‹->
√xt
)

4214 i‡(
	`°rcmp
 (
curs‹
->
ãxt
, 
ãxt_œbñ
) == 0)

4217  
curs‹
;

4218 
	}
}

4220 
js⁄_t
 *
	$js⁄_föd_fú°_œbñ_Æl
 (c⁄° 
js⁄_t
 * 
js⁄
, c⁄° *
ãxt_œbñ
)

4222 
js⁄_t
 *
cur
, *
tmp
;

4224 
	`as£π
 (
js⁄
 !
NULL
);

4225 
	`as£π
 (
ãxt_œbñ
 !
NULL
);

4227 if(
js⁄
 -> 
ãxt
 !
NULL
 && 
	`°rcmp
(js⁄ ->Åext, 
ãxt_œbñ
) == 0){

4228  (
js⁄_t
 *)
js⁄
;

4231 
cur
 = 
js⁄
 -> 
chûd
; cu∏!
NULL
; cu∏cu∏-> 
√xt
){

4232 
tmp
 = 
	`js⁄_föd_fú°_œbñ_Æl
(
cur
, 
ãxt_œbñ
);

4233 if(
tmp
 !
NULL
){

4234  
tmp
;

4238  
NULL
;

4239 
	}
}

4252 *
	$js⁄_∑r£_sim∂e_vÆue
(
js⁄_t
 *
js⁄
, c⁄° *
key
)

4254 
js⁄_t
 *
vÆ
;

4256 i‡(!
js⁄
 || !
key
)

4257  
NULL
;

4259 
vÆ
 = 
	`js⁄_föd_fú°_œbñ_Æl
(
js⁄
, 
key
);

4260 i‡(
vÆ
 && vÆ->
chûd
 && vÆ->chûd->
ãxt
) {

4261  
vÆ
->
chûd
->
ãxt
;

4264  
NULL
;

4265 
	}
}

	@src/liblwqq/json.h

30 
	~<°döt.h
>

31 
	~<°dio.h
>

33 #i‚de‡
JSON_H


34 
	#JSON_H


	)

36 #ifde‡
__˝lu•lus


41 
	#JSON_MAX_STRING_LENGTH
 
SIZE_MAX
-1

	)

46 
	ejs⁄_vÆue_ty≥


47 { 
JSON_STRING
 = 0,

48 
JSON_NUMBER
,

49 
JSON_OBJECT
,

50 
JSON_ARRAY
,

51 
JSON_TRUE
,

52 
JSON_FALSE
,

53 
JSON_NULL


59 
	srui_c°rög


61 *
ãxt
;

62 
size_t
 
Àngth
;

63 
size_t
 
max
;

66 
rui_c°rög
 
	trc°rög
;

71 
	ejs⁄_îr‹


73 
JSON_OK
 = 1,

74 
JSON_INCOMPLETE_DOCUMENT
,

75 
JSON_WAITING_FOR_EOF
,

76 
JSON_MALFORMED_DOCUMENT
,

77 
JSON_INCOMPATIBLE_TYPE
,

78 
JSON_MEMORY
,

79 
JSON_ILLEGAL_CHARACTER
,

80 
JSON_BAD_TREE_STRUCTURE
,

81 
JSON_MAXIMUM_LENGTH
,

82 
JSON_UNKNOWN_PROBLEM


89 
	sjs⁄_vÆue


91 
js⁄_vÆue_ty≥
 
ty≥
;

92 *
ãxt
;

95 
js⁄_vÆue
 *
√xt
;

96 
js⁄_vÆue
 *
¥evious
;

97 
js⁄_vÆue
 *
∑ª¡
;

98 
js⁄_vÆue
 *
chûd
;

99 
js⁄_vÆue
 *
chûd_íd
;

100 } 
	tjs⁄_t
;

106 
	sjs⁄_∑rsög_öfo


108 
°©e
;

109 
Àx_°©e
;

110 
rc°rög
 *
Àx_ãxt
;

111 *
p
;

112 
°rög_Àngth_limô_ªached
;

113 
size_t
 
löe
;

114 
js⁄_t
 *
curs‹
;

121 
	sjs⁄_ßxy_fun˘i⁄s


123 (*
›í_obje˘
) ();

124 (*
˛o£_obje˘
) ();

125 (*
›í_¨øy
) ();

126 (*
˛o£_¨øy
) ();

127 (*
√w_°rög
Ë(*
ãxt
);

128 (*
√w_numbî
Ë(*
ãxt
);

129 (*
√w_åue
) ();

130 (*
√w_Ál£
) ();

131 (*
√w_nuŒ
) ();

132 (*
œbñ_vÆue_£∑øt‹
) ();

133 (*
siblög_£∑øt‹
) ();

140 
	sjs⁄_ßxy_∑r£r_°©us


142 
°©e
;

143 
°rög_Àngth_limô_ªached
;

144 
rc°rög
 *
ãmp
;

154 
js⁄_îr‹
 
js⁄_°ªam_∑r£
 (
FILE
 * 
fûe
, 
js⁄_t
 ** 
documít
);

162 
js⁄_t
 *
js⁄_√w_vÆue
 (c⁄° 
js⁄_vÆue_ty≥
 
ty≥
);

170 
js⁄_t
 *
js⁄_√w_°rög
 (c⁄° *
ãxt
);

178 
js⁄_t
 *
js⁄_√w_numbî
 (c⁄° *
ãxt
);

185 
js⁄_t
 *
js⁄_√w_obje˘
 ();

192 
js⁄_t
 *
js⁄_√w_¨øy
 ();

199 
js⁄_t
 *
js⁄_√w_nuŒ
 ();

206 
js⁄_t
 *
js⁄_√w_åue
 ();

213 
js⁄_t
 *
js⁄_√w_Ál£
 ();

220 
js⁄_‰ì_vÆue
 (
js⁄_t
 ** 
vÆue
);

229 
js⁄_îr‹
 
js⁄_ö£π_chûd
 (
js⁄_t
 * 
∑ª¡
, js⁄_à* 
chûd
);

239 
js⁄_îr‹
 
js⁄_ö£π_∑ú_öto_obje˘
 (
js⁄_t
 * 
∑ª¡
, c⁄° *
ãxt_œbñ
, js⁄_à* 
vÆue
);

248 
js⁄_îr‹
 
js⁄_åì_to_°rög
 (
js⁄_t
 * 
roŸ
, **
ãxt
);

257 
js⁄_îr‹
 
js⁄_°ªam_ouçut
 (
FILE
 * 
fûe
, 
js⁄_t
 * 
roŸ
);

264 
js⁄_°rù_whôe_•a˚s
 (*
ãxt
);

272 *
js⁄_f‹m©_°rög
 (c⁄° *
ãxt
);

280 *
js⁄_esˇ≥
 (*
ãxt
);

289 *
js⁄_u√sˇ≥
 (*
ãxt
);

297 
js⁄_jpi_öô
 (
js⁄_∑rsög_öfo
 *
jpi
);

306 
js⁄_îr‹
 
js⁄_∑r£_‰agmít
 (
js⁄_∑rsög_öfo
 *
öfo
, *
buf„r
);

315 
js⁄_îr‹
 
js⁄_∑r£_documít
 (
js⁄_t
 ** 
roŸ
, *
ãxt
);

325 
js⁄_îr‹
 
js⁄_ßxy_∑r£
 (
js⁄_ßxy_∑r£r_°©us
 *
j•s
, 
js⁄_ßxy_fun˘i⁄s
 *
jsf
, 
c
);

334 
js⁄_t
 *
js⁄_föd_fú°_œbñ
 (c⁄° js⁄_à* 
obje˘
, c⁄° *
ãxt_œbñ
);

339 
js⁄_t
 *
js⁄_föd_fú°_œbñ_Æl
 (c⁄° js⁄_à* 
js⁄
, c⁄° *
ãxt_œbñ
);

353 *
js⁄_∑r£_sim∂e_vÆue
(
js⁄_t
 *
js⁄
, c⁄° *
key
);

357 #ifde‡
__˝lu•lus


	@src/liblwqq/libghttp/ghttp.c

22 
	~<°dlib.h
>

23 
	~<°rög.h
>

24 
	~<uni°d.h
>

25 
	~"ghâp.h
"

26 
	~"hâp_uri.h
"

27 
	~"hâp_hdrs.h
"

28 
	~"hâp_å™s.h
"

29 
	~"hâp_ªq.h
"

30 
	~"hâp_ª•.h
"

31 
	~"hâp_d©e.h
"

32 
	~"hâp_globÆ.h
"

33 
	~"hâp_ba£64.h
"

35 
	s_ghâp_ªque°


37 
hâp_uri
 *
	muri
;

38 
hâp_uri
 *
	m¥oxy
;

39 
hâp_ªq
 *
	mªq
;

40 
hâp_ª•
 *
	mª•
;

41 
hâp_å™s_c⁄n
 *
	mc⁄n
;

42 c⁄° *
	mîr°r
;

43 
	mc⁄√˘ed
;

44 
ghâp_¥oc
 
	m¥oc
;

45 *
	mu£∫ame
;

46 *
	m∑ssw‹d
;

47 *
	mauthtokí
;

48 *
	m¥oxy_u£∫ame
;

49 *
	m¥oxy_∑ssw‹d
;

50 *
	m¥oxy_authtokí
;

53 c⁄° *
	gbasic_hódî
 = "Basic ";

55 
ghâp_ªque°
 *

56 
	$ghâp_ªque°_√w
()

58 
_ghâp_ªque°
 *
l_ªtu∫
 = 
NULL
;

61 
l_ªtu∫
 = 
	`mÆloc
((
_ghâp_ªque°
));

62 
	`mem£t
(
l_ªtu∫
, 0, (
_ghâp_ªque°
));

63 
l_ªtu∫
->
uri
 = 
	`hâp_uri_√w
();

64 
l_ªtu∫
->
¥oxy
 = 
	`hâp_uri_√w
();

65 
l_ªtu∫
->
ªq
 = 
	`hâp_ªq_√w
();

66 
l_ªtu∫
->
ª•
 = 
	`hâp_ª•_√w
();

67 
l_ªtu∫
->
c⁄n
 = 
	`hâp_å™s_c⁄n_√w
();

68  
l_ªtu∫
;

69 
	}
}

72 
	$ghâp_ªque°_de°roy
(
ghâp_ªque°
 *
a_ªque°
)

74 i‡(!
a_ªque°
)

77 i‡(
a_ªque°
->
c⁄n
->
sock
 >= 0)

79 
	`˛o£
(
a_ªque°
->
c⁄n
->
sock
);

80 
a_ªque°
->
c⁄n
->
sock
 = -1;

83 i‡(
a_ªque°
->
uri
)

84 
	`hâp_uri_de°roy
(
a_ªque°
->
uri
);

85 i‡(
a_ªque°
->
¥oxy
)

86 
	`hâp_uri_de°roy
(
a_ªque°
->
¥oxy
);

87 i‡(
a_ªque°
->
ªq
)

88 
	`hâp_ªq_de°roy
(
a_ªque°
->
ªq
);

89 i‡(
a_ªque°
->
ª•
)

90 
	`hâp_ª•_de°roy
(
a_ªque°
->
ª•
);

91 i‡(
a_ªque°
->
c⁄n
)

92 
	`hâp_å™s_c⁄n_de°roy
(
a_ªque°
->
c⁄n
);

94 i‡(
a_ªque°
->
u£∫ame
)

96 
	`‰ì
(
a_ªque°
->
u£∫ame
);

97 
a_ªque°
->
u£∫ame
 = 
NULL
;

99 i‡(
a_ªque°
->
∑ssw‹d
)

101 
	`‰ì
(
a_ªque°
->
∑ssw‹d
);

102 
a_ªque°
->
∑ssw‹d
 = 
NULL
;

104 i‡(
a_ªque°
->
authtokí
)

106 
	`‰ì
(
a_ªque°
->
authtokí
);

107 
a_ªque°
->
authtokí
 = 
NULL
;

110 i‡(
a_ªque°
->
¥oxy_u£∫ame
)

112 
	`‰ì
(
a_ªque°
->
¥oxy_u£∫ame
);

113 
a_ªque°
->
¥oxy_u£∫ame
 = 
NULL
;

115 i‡(
a_ªque°
->
¥oxy_∑ssw‹d
)

117 
	`‰ì
(
a_ªque°
->
¥oxy_∑ssw‹d
);

118 
a_ªque°
->
¥oxy_∑ssw‹d
 = 
NULL
;

120 i‡(
a_ªque°
->
¥oxy_authtokí
)

122 
	`‰ì
(
a_ªque°
->
¥oxy_authtokí
);

123 
a_ªque°
->
¥oxy_authtokí
 = 
NULL
;

125 i‡(
a_ªque°
)

126 
	`‰ì
(
a_ªque°
);

128 
	}
}

131 
	$ghâp_uri_vÆid©e
(*
a_uri
)

133 i‡(!
a_uri
)

136 (
	`hâp_uri_∑r£
(
a_uri
, 
NULL
));

137 
	}
}

140 
	$ghâp_£t_uri
(
ghâp_ªque°
 *
a_ªque°
, *
a_uri
)

142 
l_rv
 = 0;

143 
hâp_uri
 *
l_√w_uri
 = 
NULL
;

145 i‡((!
a_ªque°
Ë|| (!
a_uri
))

148 
l_√w_uri
 = 
	`hâp_uri_√w
();

149 
l_rv
 = 
	`hâp_uri_∑r£
(
a_uri
, 
l_√w_uri
);

150 i‡(
l_rv
 < 0)

152 
	`hâp_uri_de°roy
(
l_√w_uri
);

155 i‡(
a_ªque°
->
uri
)

158 i‡(
a_ªque°
->
uri
->
ho°
 &&

159 
a_ªque°
->
uri
->
p‹t
 &&

160 
a_ªque°
->
uri
->
ªsour˚
)

163 i‡((!
	`°rcmp
(
a_ªque°
->
uri
->
ho°
, 
l_√w_uri
->host)) &&

164 (
a_ªque°
->
uri
->
p‹t
 =
l_√w_uri
->port))

166 
	`‰ì
(
a_ªque°
->
uri
->
ªsour˚
);

168 
a_ªque°
->
uri
->
ªsour˚
 = 
	`°rdup
(
l_√w_uri
->resource);

169 
	`hâp_uri_de°roy
(
l_√w_uri
);

173 
	`hâp_uri_de°roy
(
a_ªque°
->
uri
);

174 
a_ªque°
->
uri
 = 
l_√w_uri
;

179 
	`hâp_uri_de°roy
(
a_ªque°
->
uri
);

180 
a_ªque°
->
uri
 = 
l_√w_uri
;

184 
	}
}

187 
	$ghâp_£t_¥oxy
(
ghâp_ªque°
 *
a_ªque°
, *
a_uri
)

189 
l_rv
 = 0;

191 i‡((!
a_ªque°
Ë|| (!
a_uri
))

194 
l_rv
 = 
	`hâp_uri_∑r£
(
a_uri
, 
a_ªque°
->
¥oxy
);

195 i‡(
l_rv
 < 0)

198 
	}
}

201 
	$ghâp_£t_ty≥
(
ghâp_ªque°
 *
a_ªque°
, 
ghâp_ty≥
 
a_ty≥
)

203 
l_ªtu∫
 = 0;

206 i‡(!
a_ªque°
)

209 
a_ty≥
)

211 
ghâp_ty≥_gë
:

212 
a_ªque°
->
ªq
->
ty≥
 = 
hâp_ªq_ty≥_gë
;

214 
ghâp_ty≥_›ti⁄s
:

215 
a_ªque°
->
ªq
->
ty≥
 = 
hâp_ªq_ty≥_›ti⁄s
;

217 
ghâp_ty≥_hód
:

218 
a_ªque°
->
ªq
->
ty≥
 = 
hâp_ªq_ty≥_hód
;

220 
ghâp_ty≥_po°
:

221 
a_ªque°
->
ªq
->
ty≥
 = 
hâp_ªq_ty≥_po°
;

223 
ghâp_ty≥_put
:

224 
a_ªque°
->
ªq
->
ty≥
 = 
hâp_ªq_ty≥_put
;

226 
ghâp_ty≥_dñëe
:

227 
a_ªque°
->
ªq
->
ty≥
 = 
hâp_ªq_ty≥_dñëe
;

229 
ghâp_ty≥_åa˚
:

230 
a_ªque°
->
ªq
->
ty≥
 = 
hâp_ªq_ty≥_åa˚
;

232 
ghâp_ty≥_c⁄√˘
:

233 
a_ªque°
->
ªq
->
ty≥
 = 
hâp_ªq_ty≥_c⁄√˘
;

235 
ghâp_ty≥_¥›föd
:

236 
a_ªque°
->
ªq
->
ty≥
 = 
hâp_ªq_ty≥_¥›föd
;

238 
ghâp_ty≥_¥›∑tch
:

239 
a_ªque°
->
ªq
->
ty≥
 = 
hâp_ªq_ty≥_¥›∑tch
;

241 
ghâp_ty≥_mkcﬁ
:

242 
a_ªque°
->
ªq
->
ty≥
 = 
hâp_ªq_ty≥_mkcﬁ
;

244 
ghâp_ty≥_c›y
:

245 
a_ªque°
->
ªq
->
ty≥
 = 
hâp_ªq_ty≥_c›y
;

247 
ghâp_ty≥_move
:

248 
a_ªque°
->
ªq
->
ty≥
 = 
hâp_ªq_ty≥_move
;

250 
ghâp_ty≥_lock
:

251 
a_ªque°
->
ªq
->
ty≥
 = 
hâp_ªq_ty≥_lock
;

253 
ghâp_ty≥_u∆ock
:

254 
a_ªque°
->
ªq
->
ty≥
 = 
hâp_ªq_ty≥_u∆ock
;

257 
l_ªtu∫
 = -1;

260  
l_ªtu∫
;

261 
	}
}

264 
	$ghâp_£t_body
(
ghâp_ªque°
 *
a_ªque°
, *
a_body
, 
a_Àn
)

267 i‡(!
a_ªque°
)

270 i‡((
a_Àn
 > 0Ë&& (
a_body
 =
NULL
))

273 i‡((
a_ªque°
->
ªq
->
ty≥
 !
hâp_ªq_ty≥_po°
) &&

274 (
a_ªque°
->
ªq
->
ty≥
 !
hâp_ªq_ty≥_put
) &&

275 (
a_ªque°
->
ªq
->
ty≥
 !
hâp_ªq_ty≥_¥›∑tch
) &&

276 (
a_ªque°
->
ªq
->
ty≥
 !
hâp_ªq_ty≥_¥›föd
) &&

277 (
a_ªque°
->
ªq
->
ty≥
 !
hâp_ªq_ty≥_lock
))

280 
a_ªque°
->
ªq
->
body
 = 
a_body
;

281 
a_ªque°
->
ªq
->
body_Àn
 = 
a_Àn
;

283 
	}
}

286 
	$ghâp_£t_sync
(
ghâp_ªque°
 *
a_ªque°
,

287 
ghâp_sync_mode
 
a_mode
)

289 i‡(!
a_ªque°
)

291 i‡(
a_mode
 =
ghâp_sync
)

292 
a_ªque°
->
c⁄n
->
sync
 = 
HTTP_TRANS_SYNC
;

293 i‡(
a_mode
 =
ghâp_async
)

294 
a_ªque°
->
c⁄n
->
sync
 = 
HTTP_TRANS_ASYNC
;

298 
	}
}

301 
	$ghâp_¥ï¨e
(
ghâp_ªque°
 *
a_ªque°
)

304 i‡(!
a_ªque°
->
¥oxy
->
ho°
 &&á_ªque°->
uri
->
¥Ÿo
 &&

305 
	`°rcmp
(
a_ªque°
->
uri
->
¥Ÿo
, "http"))

309 i‡((
a_ªque°
->
c⁄n
->
ho°
 =
NULL
) ||

310 (
a_ªque°
->
c⁄n
->
ho°
 !a_ªque°->
uri
->host) ||

311 (
a_ªque°
->
c⁄n
->
p‹t
 !a_ªque°->
uri
->port) ||

312 (
a_ªque°
->
c⁄n
->
¥oxy_ho°
 !a_ªque°->
¥oxy
->
ho°
) ||

313 (
a_ªque°
->
c⁄n
->
¥oxy_p‹t
 !a_ªque°->
¥oxy
->
p‹t
))

316 
a_ªque°
->
c⁄n
->
ho°
 =á_ªque°->
uri
->host;

317 
a_ªque°
->
ªq
->
ho°
 =á_ªque°->
uri
->host;

318 
a_ªque°
->
ªq
->
fuŒ_uri
 =á_ªque°->
uri
->
fuŒ
;

319 
a_ªque°
->
c⁄n
->
p‹t
 =á_ªque°->
uri
->port;

320 
a_ªque°
->
c⁄n
->
¥oxy_ho°
 =á_ªque°->
¥oxy
->
ho°
;

321 
a_ªque°
->
c⁄n
->
¥oxy_p‹t
 =á_ªque°->
¥oxy
->
p‹t
;

322 
a_ªque°
->
c⁄n
->
ho°öfo
 = 
NULL
;

324 i‡(
a_ªque°
->
c⁄n
->
sock
 >= 0)

326 
	`˛o£
(
a_ªque°
->
c⁄n
->
sock
);

327 
a_ªque°
->
c⁄n
->
sock
 = -1;

328 
a_ªque°
->
c⁄√˘ed
 = 0;

332 i‡((
a_ªque°
->
ªq
->
ªsour˚
 =
NULL
) ||

333 (
a_ªque°
->
ªq
->
ªsour˚
 !a_ªque°->
uri
->resource))

335 
a_ªque°
->
ªq
->
ªsour˚
 =á_ªque°->
uri
->resource;

336 
a_ªque°
->
ªq
->
ho°
 =á_ªque°->
uri
->host;

339 i‡((
a_ªque°
->
authtokí
 !
NULL
) &&

340 (
	`°æí
(
a_ªque°
->
authtokí
) > 0))

342 
	`hâp_hdr_£t_vÆue
(
a_ªque°
->
ªq
->
hódîs
,

343 
hâp_hdr_Auth‹iz©i⁄
,

344 
a_ªque°
->
authtokí
);

348 
	`hâp_hdr_£t_vÆue
(
a_ªque°
->
ªq
->
hódîs
,

349 
hâp_hdr_WWW_Authítiˇã
,

350 
NULL
);

353 i‡((
a_ªque°
->
¥oxy_authtokí
 !
NULL
) &&

354 (
	`°æí
(
a_ªque°
->
¥oxy_authtokí
) > 0))

356 
	`hâp_hdr_£t_vÆue
(
a_ªque°
->
ªq
->
hódîs
,

357 
hâp_hdr_Proxy_Auth‹iz©i⁄
,

358 
a_ªque°
->
¥oxy_authtokí
);

360 
	`hâp_ªq_¥ï¨e
(
a_ªque°
->
ªq
);

362 
	}
}

364 
ghâp_°©us


365 
	$ghâp_¥o˚ss
(
ghâp_ªque°
 *
a_ªque°
)

367 
l_rv
 = 0;

369 i‡(
a_ªque°
->
¥oc
 =
ghâp_¥oc_n⁄e
)

370 
a_ªque°
->
¥oc
 = 
ghâp_¥oc_ªque°
;

371 i‡(
a_ªque°
->
¥oc
 =
ghâp_¥oc_ªque°
)

373 i‡(
a_ªque°
->
c⁄√˘ed
 == 0)

375 i‡(
	`hâp_å™s_c⁄√˘
(
a_ªque°
->
c⁄n
) < 0)

377 i‡(
a_ªque°
->
c⁄n
->
îr‹_ty≥
 =
hâp_å™s_îr_ty≥_î∫o
)

378 
a_ªque°
->
îr°r
 = 
	`°ªº‹
◊_ªque°->
c⁄n
->
îr‹
);

379 if(
a_ªque°
->
c⁄n
->
îr‹_ty≥
 =
hâp_å™s_îr_ty≥_ho°
)

380 
a_ªque°
->
îr°r
 = 
	`hâp_å™s_gë_ho°_îr‹
(
h_î∫o
);

381  
ghâp_îr‹
;

383 
a_ªque°
->
c⁄√˘ed
 = 1;

385 
l_rv
 = 
	`hâp_ªq_£nd
(
a_ªque°
->
ªq
,á_ªque°->
c⁄n
);

386 i‡(
l_rv
 =
HTTP_TRANS_ERR
)

387  
ghâp_îr‹
;

388 i‡(
l_rv
 =
HTTP_TRANS_NOT_DONE
)

389  
ghâp_nŸ_d⁄e
;

390 i‡(
l_rv
 =
HTTP_TRANS_DONE
)

392 
a_ªque°
->
¥oc
 = 
ghâp_¥oc_ª•⁄£_hdrs
;

393 i‡(
a_ªque°
->
c⁄n
->
sync
 =
HTTP_TRANS_ASYNC
)

394  
ghâp_nŸ_d⁄e
;

397 i‡(
a_ªque°
->
¥oc
 =
ghâp_¥oc_ª•⁄£_hdrs
)

399 
l_rv
 = 
	`hâp_ª•_ªad_hódîs
(
a_ªque°
->
ª•
,á_ªque°->
c⁄n
);

400 i‡(
l_rv
 =
HTTP_TRANS_ERR
)

401  
ghâp_îr‹
;

402 i‡(
l_rv
 =
HTTP_TRANS_NOT_DONE
)

403  
ghâp_nŸ_d⁄e
;

404 i‡(
l_rv
 =
HTTP_TRANS_DONE
)

406 
a_ªque°
->
¥oc
 = 
ghâp_¥oc_ª•⁄£
;

407 i‡(
a_ªque°
->
c⁄n
->
sync
 =
HTTP_TRANS_ASYNC
)

408  
ghâp_nŸ_d⁄e
;

411 i‡(
a_ªque°
->
¥oc
 =
ghâp_¥oc_ª•⁄£
)

413 
l_rv
 = 
	`hâp_ª•_ªad_body
(
a_ªque°
->
ª•
,

414 
a_ªque°
->
ªq
,

415 
a_ªque°
->
c⁄n
);

416 i‡(
l_rv
 =
HTTP_TRANS_ERR
)

419 i‡(
a_ªque°
->
c⁄n
->
sock
 == -1)

420 
a_ªque°
->
c⁄√˘ed
 = 0;

421  
ghâp_îr‹
;

423 i‡(
l_rv
 =
HTTP_TRANS_NOT_DONE
)

424  
ghâp_nŸ_d⁄e
;

425 i‡(
l_rv
 =
HTTP_TRANS_DONE
)

428 i‡(
a_ªque°
->
c⁄n
->
sock
 == -1)

429 
a_ªque°
->
c⁄√˘ed
 = 0;

430 
a_ªque°
->
¥oc
 = 
ghâp_¥oc_n⁄e
;

431  
ghâp_d⁄e
;

434  
ghâp_îr‹
;

435 
	}
}

437 
ghâp_cuºít_°©us


438 
	$ghâp_gë_°©us
(
ghâp_ªque°
 *
a_ªque°
)

440 
ghâp_cuºít_°©us
 
l_ªtu∫
;

442 
l_ªtu∫
.
¥oc
 = 
a_ªque°
->proc;

443 i‡(
a_ªque°
->
¥oc
 =
ghâp_¥oc_ªque°
)

445 
l_ªtu∫
.
byãs_ªad
 = 
a_ªque°
->
c⁄n
->
io_buf_io_d⁄e
;

446 
l_ªtu∫
.
byãs_tŸÆ
 = 
a_ªque°
->
c⁄n
->
io_buf_Æloc
;

448 i‡(
a_ªque°
->
¥oc
 =
ghâp_¥oc_ª•⁄£_hdrs
)

450 
l_ªtu∫
.
byãs_ªad
 = 0;

451 
l_ªtu∫
.
byãs_tŸÆ
 = 0;

453 i‡(
a_ªque°
->
¥oc
 =
ghâp_¥oc_ª•⁄£
)

455 i‡(
a_ªque°
->
ª•
->
c⁄ã¡_Àngth
 > 0)

457 
l_ªtu∫
.
byãs_ªad
 = 
a_ªque°
->
ª•
->
body_Àn
 +

458 
a_ªque°
->
c⁄n
->
io_buf_Æloc
 +

459 
a_ªque°
->
ª•
->
Êushed_Àngth
;

460 
l_ªtu∫
.
byãs_tŸÆ
 = 
a_ªque°
->
ª•
->
c⁄ã¡_Àngth
;

464 
l_ªtu∫
.
byãs_ªad
 = 
a_ªque°
->
ª•
->
body_Àn
 +

465 
a_ªque°
->
c⁄n
->
io_buf_Æloc
 +

466 
a_ªque°
->
ª•
->
Êushed_Àngth
;

467 
l_ªtu∫
.
byãs_tŸÆ
 = -1;

472 
l_ªtu∫
.
byãs_ªad
 = 0;

473 
l_ªtu∫
.
byãs_tŸÆ
 = 0;

475  
l_ªtu∫
;

476 
	}
}

479 
	$ghâp_Êush_ª•⁄£_buf„r
(
ghâp_ªque°
 *
a_ªque°
)

481 
	`hâp_ª•_Êush
(
a_ªque°
->
ª•
,á_ªque°->
c⁄n
);

482 
	}
}

485 
	$ghâp_˛o£
(
ghâp_ªque°
 *
a_ªque°
)

487 i‡(!
a_ªque°
)

489 i‡(
a_ªque°
->
c⁄n
->
sock
 >= 0)

491 
	`˛o£
(
a_ªque°
->
c⁄n
->
sock
);

492 
a_ªque°
->
c⁄n
->
sock
 = -1;

494 
a_ªque°
->
c⁄√˘ed
 = 0;

496 
	}
}

499 
	$ghâp_˛ón
(
ghâp_ªque°
 *
a_ªque°
)

501 
	`hâp_ª•_de°roy
(
a_ªque°
->
ª•
);

502 
a_ªque°
->
ª•
 = 
	`hâp_ª•_√w
();

503 
	`hâp_ªq_de°roy
(
a_ªque°
->
ªq
);

504 
a_ªque°
->
ªq
 = 
	`hâp_ªq_√w
();

505 
	`hâp_å™s_buf_ª£t
(
a_ªque°
->
c⁄n
);

506 
a_ªque°
->
¥oc
 = 
ghâp_¥oc_n⁄e
;

508 
	}
}

511 
	$ghâp_£t_chunksize
(
ghâp_ªque°
 *
a_ªque°
, 
a_size
)

513 i‡(
a_ªque°
 && (
a_size
 > 0))

514 
a_ªque°
->
c⁄n
->
io_buf_chunksize
 = 
a_size
;

515 
	}
}

518 
	$ghâp_£t_hódî
(
ghâp_ªque°
 *
a_ªque°
,

519 c⁄° *
a_hdr
, c⁄° *
a_vÆ
)

521 
	`hâp_hdr_£t_vÆue
(
a_ªque°
->
ªq
->
hódîs
,

522 
a_hdr
, 
a_vÆ
);

523 
	}
}

526 
	$ghâp_gë_hódî
(
ghâp_ªque°
 *
a_ªque°
,

527 c⁄° *
a_hdr
)

529  
	`hâp_hdr_gë_vÆue
(
a_ªque°
->
ª•
->
hódîs
,

530 
a_hdr
);

531 
	}
}

533 *
	$ghâp_gë_cookõ
(
ghâp_ªque°
 *
a_ªque°
, c⁄° *
a_hdr
)

535  
	`hâp_hdr_gë_cookõ
(
a_ªque°
->
ª•
->
hódîs
, 
a_hdr
);

536 
	}
}

539 
	$ghâp_gë_hódî_«mes
(
ghâp_ªque°
 *
a_ªque°
,

540 ***
a_hdrs
, *
a_num_hdrs
)

542  
	`hâp_hdr_gë_hódîs
(
a_ªque°
->
ª•
->
hódîs
,

543 
a_hdrs
, 
a_num_hdrs
);

544 
	}
}

547 
	$ghâp_gë_îr‹
(
ghâp_ªque°
 *
a_ªque°
)

549 i‡(
a_ªque°
->
îr°r
 =
NULL
)

551  
a_ªque°
->
îr°r
;

552 
	}
}

554 
time_t


555 
	$ghâp_∑r£_d©e
(*
a_d©e
)

557 i‡(!
a_d©e
)

559  (
	`hâp_d©e_to_time
(
a_d©e
));

560 
	}
}

563 
	$ghâp_°©us_code
(
ghâp_ªque°
 *
a_ªque°
)

565 i‡(!
a_ªque°
)

567 (
a_ªque°
->
ª•
->
°©us_code
);

568 
	}
}

571 
	$ghâp_ªas⁄_phø£
(
ghâp_ªque°
 *
a_ªque°
)

573 i‡(!
a_ªque°
)

575 (
a_ªque°
->
ª•
->
ªas⁄_phø£
);

576 
	}
}

579 
	$ghâp_gë_sockë
(
ghâp_ªque°
 *
a_ªque°
)

581 i‡(!
a_ªque°
)

583 (
a_ªque°
->
c⁄n
->
sock
);

584 
	}
}

587 
	$ghâp_gë_body
(
ghâp_ªque°
 *
a_ªque°
)

589 i‡(!
a_ªque°
)

590  
NULL
;

591 i‡(
a_ªque°
->
¥oc
 =
ghâp_¥oc_n⁄e
)

592  (
a_ªque°
->
ª•
->
body
);

593 i‡(
a_ªque°
->
¥oc
 =
ghâp_¥oc_ª•⁄£
)

595 i‡(
a_ªque°
->
ª•
->
c⁄ã¡_Àngth
 > 0)

597 i‡(
a_ªque°
->
ª•
->
body_Àn
)

598  
a_ªque°
->
ª•
->
body
;

600  
a_ªque°
->
c⁄n
->
io_buf
;

604  
a_ªque°
->
ª•
->
body
;

607  
NULL
;

608 
	}
}

611 
	$ghâp_gë_body_Àn
(
ghâp_ªque°
 *
a_ªque°
)

613 i‡(!
a_ªque°
)

615 i‡(
a_ªque°
->
¥oc
 =
ghâp_¥oc_n⁄e
)

616  (
a_ªque°
->
ª•
->
body_Àn
);

617 i‡(
a_ªque°
->
¥oc
 =
ghâp_¥oc_ª•⁄£
)

619 i‡(
a_ªque°
->
ª•
->
c⁄ã¡_Àngth
 > 0)

621 i‡(
a_ªque°
->
ª•
->
body_Àn
)

622  
a_ªque°
->
ª•
->
body_Àn
;

624  
a_ªque°
->
c⁄n
->
io_buf_Æloc
;

628  
a_ªque°
->
ª•
->
body_Àn
;

632 
	}
}

635 
	$ghâp_£t_authöfo
(
ghâp_ªque°
 *
a_ªque°
,

636 c⁄° *
a_u£r
,

637 c⁄° *
a_∑ss
)

639 *
l_authtokí
 = 
NULL
;

640 *
l_föÆ_auth
 = 
NULL
;

641 *
l_auth64
 = 
NULL
;

644 i‡(!
a_ªque°
)

648 i‡((!
a_u£r
Ë|| (
	`°æí
(a_user) < 1) ||

649 (!
a_∑ss
Ë|| (
	`°æí
(a_pass)< 1))

651 i‡(
a_ªque°
->
u£∫ame
)

653 
	`‰ì
(
a_ªque°
->
u£∫ame
);

654 
a_ªque°
->
u£∫ame
 = 
NULL
;

656 i‡(
a_ªque°
->
∑ssw‹d
)

658 
	`‰ì
(
a_ªque°
->
∑ssw‹d
);

659 
a_ªque°
->
∑ssw‹d
 = 
NULL
;

661 i‡(
a_ªque°
->
authtokí
)

663 
	`‰ì
(
a_ªque°
->
authtokí
);

664 
a_ªque°
->
authtokí
 = 
NULL
;

674 
l_authtokí
 = 
	`mÆloc
(
	`°æí
(
a_u£r
Ë+ såÀn(
a_∑ss
) + 2);

675 
	`mem£t
(
l_authtokí
, 0, (
	`°æí
(
a_u£r
Ë+ såÀn(
a_∑ss
) + 2));

676 
	`•rötf
(
l_authtokí
, "%s:%s", 
a_u£r
, 
a_∑ss
);

677 
l_auth64
 = 
	`hâp_ba£64_ícode
(
l_authtokí
);

678 i‡(!
l_auth64
)

680 
	`‰ì
(
l_authtokí
);

684 
l_föÆ_auth
 = 
	`mÆloc
(
	`°æí
(
l_auth64
Ë+ såÀn(
basic_hódî
) + 1);

685 
	`mem£t
(
l_föÆ_auth
, 0, (
	`°æí
(
l_auth64
Ë+ såÀn(
basic_hódî
) + 1));

686 
	`°rˇt
(
l_föÆ_auth
, 
basic_hódî
);

687 
	`°rˇt
(
l_föÆ_auth
, 
l_auth64
);

688 
	`‰ì
(
l_auth64
);

689 
	`‰ì
(
l_authtokí
);

692 i‡(
a_ªque°
->
u£∫ame
Ë
	`‰ì
(a_request->username);

693 i‡(
a_ªque°
->
∑ssw‹d
Ë
	`‰ì
(a_request->password);

694 i‡(
a_ªque°
->
authtokí
Ë
	`‰ì
(a_request->authtoken);

695 
a_ªque°
->
u£∫ame
 = 
	`°rdup
(
a_u£r
);

696 
a_ªque°
->
∑ssw‹d
 = 
	`°rdup
(
a_∑ss
);

697 
a_ªque°
->
authtokí
 = 
l_föÆ_auth
;

700 
	}
}

704 
	$ghâp_£t_¥oxy_authöfo
(
ghâp_ªque°
 *
a_ªque°
,

705 c⁄° *
a_u£r
,

706 c⁄° *
a_∑ss
)

708 *
l_authtokí
 = 
NULL
;

709 *
l_föÆ_auth
 = 
NULL
;

710 *
l_auth64
 = 
NULL
;

713 i‡(!
a_ªque°
)

717 i‡((!
a_u£r
Ë|| (
	`°æí
(a_user) < 1) ||

718 (!
a_∑ss
Ë|| (
	`°æí
(a_pass)< 1))

720 i‡(
a_ªque°
->
¥oxy_u£∫ame
)

722 
	`‰ì
(
a_ªque°
->
¥oxy_u£∫ame
);

723 
a_ªque°
->
¥oxy_u£∫ame
 = 
NULL
;

725 i‡(
a_ªque°
->
¥oxy_∑ssw‹d
)

727 
	`‰ì
(
a_ªque°
->
¥oxy_∑ssw‹d
);

728 
a_ªque°
->
¥oxy_∑ssw‹d
 = 
NULL
;

730 i‡(
a_ªque°
->
¥oxy_authtokí
)

732 
	`‰ì
(
a_ªque°
->
¥oxy_authtokí
);

733 
a_ªque°
->
¥oxy_authtokí
 = 
NULL
;

743 
l_authtokí
 = 
	`mÆloc
(
	`°æí
(
a_u£r
Ë+ såÀn(
a_∑ss
) + 2);

744 
	`mem£t
(
l_authtokí
, 0, (
	`°æí
(
a_u£r
Ë+ såÀn(
a_∑ss
) + 2));

745 
	`•rötf
(
l_authtokí
, "%s:%s", 
a_u£r
, 
a_∑ss
);

746 
l_auth64
 = 
	`hâp_ba£64_ícode
(
l_authtokí
);

747 i‡(!
l_auth64
)

749 
	`‰ì
(
l_authtokí
);

753 
l_föÆ_auth
 = 
	`mÆloc
(
	`°æí
(
l_auth64
Ë+ såÀn(
basic_hódî
) + 1);

754 
	`mem£t
(
l_föÆ_auth
, 0, (
	`°æí
(
l_auth64
Ë+ såÀn(
basic_hódî
) + 1));

755 
	`°rˇt
(
l_föÆ_auth
, 
basic_hódî
);

756 
	`°rˇt
(
l_föÆ_auth
, 
l_auth64
);

757 
	`‰ì
(
l_auth64
);

758 
	`‰ì
(
l_authtokí
);

760 i‡(
a_ªque°
->
¥oxy_u£∫ame
Ë
	`‰ì
(a_request->proxy_username);

761 i‡(
a_ªque°
->
¥oxy_∑ssw‹d
Ë
	`‰ì
(a_request->proxy_password);

762 i‡(
a_ªque°
->
¥oxy_authtokí
Ë
	`‰ì
(a_request->proxy_authtoken);

763 
a_ªque°
->
¥oxy_u£∫ame
 = 
	`°rdup
(
a_u£r
);

764 
a_ªque°
->
¥oxy_∑ssw‹d
 = 
	`°rdup
(
a_∑ss
);

765 
a_ªque°
->
¥oxy_authtokí
 = 
l_föÆ_auth
;

768 
	}
}

	@src/liblwqq/libghttp/ghttp.h

22 #i‚de‡
GHTTP_H


23 
	#GHTTP_H


	)

25 
	~<ghâp_c⁄°™ts.h
>

26 
	~<time.h
>

28 #ifde‡
__˝lu•lus


32 
_ghâp_ªque°
 
	tghâp_ªque°
;

34 
	eghâp_ty≥_èg


36 
ghâp_ty≥_gë
 = 0,

37 
ghâp_ty≥_›ti⁄s
,

38 
ghâp_ty≥_hód
,

39 
ghâp_ty≥_po°
,

40 
ghâp_ty≥_put
,

41 
ghâp_ty≥_dñëe
,

42 
ghâp_ty≥_åa˚
,

43 
ghâp_ty≥_c⁄√˘
,

44 
ghâp_ty≥_¥›föd
,

45 
ghâp_ty≥_¥›∑tch
,

46 
ghâp_ty≥_mkcﬁ
,

47 
ghâp_ty≥_c›y
,

48 
ghâp_ty≥_move
,

49 
ghâp_ty≥_lock
,

50 
ghâp_ty≥_u∆ock


51 } 
	tghâp_ty≥
;

53 
	eghâp_sync_mode_èg


55 
ghâp_sync
 = 0,

56 
ghâp_async


57 } 
	tghâp_sync_mode
;

59 
	eghâp_°©us_èg


61 
ghâp_îr‹
 = -1,

62 
ghâp_nŸ_d⁄e
,

63 
ghâp_d⁄e


64 } 
	tghâp_°©us
;

66 
	eghâp_¥oc_èg


68 
ghâp_¥oc_n⁄e
 = 0,

69 
ghâp_¥oc_ªque°
,

70 
ghâp_¥oc_ª•⁄£_hdrs
,

71 
ghâp_¥oc_ª•⁄£


72 } 
	tghâp_¥oc
;

74 
	sghâp_cuºít_°©us_èg


76 
ghâp_¥oc
 
¥oc
;

77 
byãs_ªad
;

78 
byãs_tŸÆ
;

79 } 
	tghâp_cuºít_°©us
;

82 
ghâp_ªque°
 *

83 
ghâp_ªque°_√w
();

87 
ghâp_ªque°_de°roy
(
ghâp_ªque°
 *
a_ªque°
);

93 
ghâp_uri_vÆid©e
(*
a_uri
);

100 
ghâp_£t_uri
(
ghâp_ªque°
 *
a_ªque°
, *
a_uri
);

107 
ghâp_£t_¥oxy
(
ghâp_ªque°
 *
a_ªque°
, *
a_uri
);

115 
ghâp_£t_ty≥
(
ghâp_ªque°
 *
a_ªque°
, 
ghâp_ty≥
 
a_ty≥
);

122 
ghâp_£t_body
(
ghâp_ªque°
 *
a_ªque°
, *
a_body
, 
a_Àn
);

128 
ghâp_£t_sync
(
ghâp_ªque°
 *
a_ªque°
,

129 
ghâp_sync_mode
 
a_mode
);

137 
ghâp_¥ï¨e
(
ghâp_ªque°
 *
a_ªque°
);

144 
ghâp_£t_chunksize
(
ghâp_ªque°
 *
a_ªque°
, 
a_size
);

150 
ghâp_£t_hódî
(
ghâp_ªque°
 *
a_ªque°
,

151 c⁄° *
a_hdr
, c⁄° *
a_vÆ
);

156 
ghâp_°©us


157 
ghâp_¥o˚ss
(
ghâp_ªque°
 *
a_ªque°
);

162 
ghâp_cuºít_°©us


163 
ghâp_gë_°©us
(
ghâp_ªque°
 *
a_ªque°
);

172 
ghâp_Êush_ª•⁄£_buf„r
(
ghâp_ªque°
 *
a_ªque°
);

178 
ghâp_gë_hódî
(
ghâp_ªque°
 *
a_ªque°
,

179 c⁄° *
a_hdr
);

182 * 
ghâp_gë_cookõ
(
ghâp_ªque°
 *
a_ªque°
, c⁄° *
a_hdr
);

188 
ghâp_gë_hódî_«mes
(
ghâp_ªque°
 *
a_ªque°
,

189 ***
a_hdrs
, *
a_num_hdrs
);

193 
ghâp_˛o£
(
ghâp_ªque°
 *
a_ªque°
);

198 
ghâp_˛ón
(
ghâp_ªque°
 *
a_ªque°
);

204 
ghâp_gë_sockë
(
ghâp_ªque°
 *
a_ªque°
);

210 
ghâp_gë_body
(
ghâp_ªque°
 *
a_ªque°
);

216 
ghâp_gë_body_Àn
(
ghâp_ªque°
 *
a_ªque°
);

222 
ghâp_gë_îr‹
(
ghâp_ªque°
 *
a_ªque°
);

228 
time_t


229 
ghâp_∑r£_d©e
(*
a_d©e
);

235 
ghâp_°©us_code
(
ghâp_ªque°
 *
a_ªque°
);

241 
ghâp_ªas⁄_phø£
(
ghâp_ªque°
 *
a_ªque°
);

247 
ghâp_£t_authöfo
(
ghâp_ªque°
 *
a_ªque°
,

248 c⁄° *
a_u£r
,

249 c⁄° *
a_∑ss
);

256 
ghâp_£t_¥oxy_authöfo
(
ghâp_ªque°
 *
a_ªque°
,

257 c⁄° *
a_u£r
,

258 c⁄° *
a_∑ss
);

261 #ifde‡
__˝lu•lus


	@src/liblwqq/libghttp/ghttp_constants.h

23 #i‚de‡
GHTTP_CONSTANTS_H


24 
	#GHTTP_CONSTANTS_H


	)

26 #ifde‡
__˝lu•lus


30 c⁄° 
hâp_hdr_AŒow
[];

31 c⁄° 
hâp_hdr_C⁄ã¡_Encodög
[];

32 c⁄° 
hâp_hdr_C⁄ã¡_L™guage
[];

33 c⁄° 
hâp_hdr_C⁄ã¡_Lígth
[];

34 c⁄° 
hâp_hdr_C⁄ã¡_Loˇti⁄
[];

35 c⁄° 
hâp_hdr_C⁄ã¡_MD5
[];

36 c⁄° 
hâp_hdr_C⁄ã¡_R™ge
[];

37 c⁄° 
hâp_hdr_C⁄ã¡_Ty≥
[];

38 c⁄° 
hâp_hdr_Expúes
[];

39 c⁄° 
hâp_hdr_La°_Modifõd
[];

43 c⁄° 
hâp_hdr_Cache_C⁄åﬁ
[];

44 c⁄° 
hâp_hdr_C⁄√˘i⁄
[];

45 c⁄° 
hâp_hdr_D©e
[];

46 c⁄° 
hâp_hdr_Pøgma
[];

47 c⁄° 
hâp_hdr_Tøns„r_Encodög
[];

48 c⁄° 
hâp_hdr_Upd©e
[];

49 c⁄° 
hâp_hdr_Tøûî
[];

50 c⁄° 
hâp_hdr_Vü
[];

54 c⁄° 
hâp_hdr_Ac˚±
[];

55 c⁄° 
hâp_hdr_Ac˚±_Ch¨£t
[];

56 c⁄° 
hâp_hdr_Ac˚±_Encodög
[];

57 c⁄° 
hâp_hdr_Ac˚±_L™guage
[];

58 c⁄° 
hâp_hdr_Auth‹iz©i⁄
[];

59 c⁄° 
hâp_hdr_Ex≥˘
[];

60 c⁄° 
hâp_hdr_From
[];

61 c⁄° 
hâp_hdr_Ho°
[];

62 c⁄° 
hâp_hdr_If_Modifõd_Sö˚
[];

63 c⁄° 
hâp_hdr_If_M©ch
[];

64 c⁄° 
hâp_hdr_If_N⁄e_M©ch
[];

65 c⁄° 
hâp_hdr_If_R™ge
[];

66 c⁄° 
hâp_hdr_If_Unmodifõd_Sö˚
[];

67 c⁄° 
hâp_hdr_Max_F‹w¨ds
[];

68 c⁄° 
hâp_hdr_Proxy_Auth‹iz©i⁄
[];

69 c⁄° 
hâp_hdr_R™ge
[];

70 c⁄° 
hâp_hdr_Re„ºî
[];

71 c⁄° 
hâp_hdr_TE
[];

72 c⁄° 
hâp_hdr_U£r_Agít
[];

76 c⁄° 
hâp_hdr_Ac˚±_R™ges
[];

77 c⁄° 
hâp_hdr_Age
[];

78 c⁄° 
hâp_hdr_ETag
[];

79 c⁄° 
hâp_hdr_Loˇti⁄
[];

80 c⁄° 
hâp_hdr_Rëry_A·î
[];

81 c⁄° 
hâp_hdr_Sîvî
[];

82 c⁄° 
hâp_hdr_V¨y
[];

83 c⁄° 
hâp_hdr_W¨nög
[];

84 c⁄° 
hâp_hdr_WWW_Authítiˇã
[];

88 c⁄° 
hâp_hdr_Së_Cookõ
[];

92 c⁄° 
hâp_hdr_DAV
[];

93 c⁄° 
hâp_hdr_Dïth
[];

94 c⁄° 
hâp_hdr_De°ö©i⁄
[];

95 c⁄° 
hâp_hdr_If
[];

96 c⁄° 
hâp_hdr_Lock_Tokí
[];

97 c⁄° 
hâp_hdr_Ovîwrôe
[];

98 c⁄° 
hâp_hdr_Sètus_URI
[];

99 c⁄° 
hâp_hdr_Timeout
[];

101 #ifde‡
__˝lu•lus


	@src/liblwqq/libghttp/http_base64.c

23 
	~<°dlib.h
>

24 
	~<°dio.h
>

25 
	~<°rög.h
>

27 c⁄° 
	gb64_Æphabë
[65] = {

33 
	$hâp_ba£64_ícode
(c⁄° *
ãxt
) {

36 *
buf„r
 = 
NULL
;

37 *
poöt
 = 
NULL
;

38 
öÀn
 = 0;

39 
ouéí
 = 0;

42 i‡(
ãxt
 =
NULL
)

43  
NULL
;

48 
öÀn
 = 
	`°æí
–
ãxt
 );

50 i‡(
öÀn
 == 0)

52 
buf„r
 = 
	`mÆloc
(());

53 
buf„r
[0] = '\0';

54  
buf„r
;

56 
ouéí
 = (
öÀn
*4)/3;

57 if–(
öÀn
 % 3) > 0 )

58 
ouéí
 +4 - (
öÀn
 % 3);

60 
buf„r
 = 
	`mÆloc
–
ouéí
 + 1 );

61 
	`mem£t
(
buf„r
, 0, 
ouéí
 + 1);

66  
poöt
=
buf„r
; 
öÀn
>=3; i∆í-=3, 
ãxt
+=3 ) {

67 *(
poöt
++Ë
b64_Æphabë
[ *
ãxt
>>2 ];

68 *(
poöt
++Ë
b64_Æphabë
[ (*
ãxt
<<4 & 0x30) | *(text+1)>>4 ];

69 *(
poöt
++Ë
b64_Æphabë
[ (*(
ãxt
+1)<<2 & 0x3c) | *(text+2)>>6 ];

70 *(
poöt
++Ë
b64_Æphabë
[ *(
ãxt
+2) & 0x3f ];

74 if–
öÀn
 ) {

76 *(
poöt
++Ë
b64_Æphabë
[ *
ãxt
>>2 ];

77 *(
poöt
++Ë
b64_Æphabë
[ (*
ãxt
<<4 & 0x30) |

78 (
öÀn
==2?*(
ãxt
+1)>>4:0) ];

79 *(
poöt
++Ë(
öÀn
==1?'=':
b64_Æphabë
[ *(
ãxt
+1)<<2 & 0x3c ] );

80 *(
poöt
++) = '=';

83 *
poöt
 = '\0';

85  
buf„r
;

86 
	}
}

	@src/liblwqq/libghttp/http_base64.h

22 #i‚de‡
HTTP_BASE64_H


23 
	#HTTP_BASE64_H


	)

26 
hâp_ba£64_ícode
(c⁄° *
ãxt
);

	@src/liblwqq/libghttp/http_date.c

22 
	~<°rög.h
>

23 
	~<˘y≥.h
>

24 
	~"hâp_d©e.h
"

27 
m⁄th_‰om_°rög_sh‹t
(c⁄° *
a_m⁄th
);

41 
time_t


42 
	$hâp_d©e_to_time
(c⁄° *
a_d©e
)

44 
tm
 
l_tm_time
;

45 
time_t
 
l_ªtu∫
 = 0;

46 
l_buf
[12];

47 c⁄° *
l_°¨t_d©e
 = 
NULL
;

48 
i
 = 0;

51 i‡(!
a_d©e
)

53 
	`mem£t
(&
l_tm_time
, 0, (
tm
));

54 
	`mem£t
(
l_buf
, 0, 12);

57 i‡(
a_d©e
[3] == ',')

59 i‡(
	`°æí
(
a_d©e
) != 29)

62 i‡(
a_d©e
[4] != ' ')

65 i‡((
	`isdigô
(
a_d©e
[5]) == 0) ||

66 (
	`isdigô
(
a_d©e
[6]) == 0))

69 i‡((
l_tm_time
.
tm_m⁄
 = 
	`m⁄th_‰om_°rög_sh‹t
(&
a_d©e
[8])) < 0)

72 i‡((
	`isdigô
(
a_d©e
[12]) == 0) ||

73 (
	`isdigô
(
a_d©e
[13]) == 0) ||

74 (
	`isdigô
(
a_d©e
[14]) == 0) ||

75 (
	`isdigô
(
a_d©e
[15]) == 0))

77 i‡(
a_d©e
[16] != ' ')

80 i‡((
	`isdigô
(
a_d©e
[17]) == 0) ||

81 (
	`isdigô
(
a_d©e
[18]) == 0) ||

82 (
a_d©e
[19] != ':') ||

83 (
	`isdigô
(
a_d©e
[20]) == 0) ||

84 (
	`isdigô
(
a_d©e
[21]) == 0) ||

85 (
a_d©e
[22] != ':') ||

86 (
	`isdigô
(
a_d©e
[23]) == 0) ||

87 (
	`isdigô
(
a_d©e
[24]) == 0))

89 i‡(
a_d©e
[25] != ' ')

92 i‡(
	`°∫cmp
(&
a_d©e
[26], "GMT", 3) != 0)

96 
l_tm_time
.
tm_mday
 +(
a_d©e
[5] - 0x30) * 10;

97 
l_tm_time
.
tm_mday
 +(
a_d©e
[6] - 0x30);

100 
l_tm_time
.
tm_yór
 +(
a_d©e
[12] - 0x30) * 1000;

101 
l_tm_time
.
tm_yór
 +(
a_d©e
[13] - 0x30) * 100;

102 
l_tm_time
.
tm_yór
 +(
a_d©e
[14] - 0x30) * 10;

103 
l_tm_time
.
tm_yór
 +(
a_d©e
[15] - 0x30);

104 
l_tm_time
.
tm_yór
 -= 1900;

106 
l_tm_time
.
tm_hour
 +(
a_d©e
[17] - 0x30) * 10;

107 
l_tm_time
.
tm_hour
 +(
a_d©e
[18] - 0x30);

108 
l_tm_time
.
tm_mö
 +(
a_d©e
[20] - 0x30) * 10;

109 
l_tm_time
.
tm_mö
 +(
a_d©e
[21] - 0x30);

110 
l_tm_time
.
tm_£c
 +(
a_d©e
[23] - 0x30) * 10;

111 
l_tm_time
.
tm_£c
 +(
a_d©e
[24] - 0x30);

113 
l_ªtu∫
 = 
	`mktime
(&
l_tm_time
);

116 i‡(
a_d©e
[3] == ' ')

118 i‡(
	`°æí
(
a_d©e
) != 24)

121 i‡((
l_tm_time
.
tm_m⁄
 =

122 
	`m⁄th_‰om_°rög_sh‹t
(&
a_d©e
[4])) < 0)

124 i‡(
a_d©e
[7] != ' ')

127 i‡(((
a_d©e
[8] !' 'Ë&& (
	`isdigô
(a_date[8]) == 0)) ||

128 (
	`isdigô
(
a_d©e
[9]) == 0))

130 i‡(
a_d©e
[10] != ' ')

133 i‡((
	`isdigô
(
a_d©e
[11]) == 0) ||

134 (
	`isdigô
(
a_d©e
[12]) == 0) ||

135 (
a_d©e
[13] != ':') ||

136 (
	`isdigô
(
a_d©e
[14]) == 0) ||

137 (
	`isdigô
(
a_d©e
[15]) == 0) ||

138 (
a_d©e
[16] != ':') ||

139 (
	`isdigô
(
a_d©e
[17]) == 0) ||

140 (
	`isdigô
(
a_d©e
[18]) == 0))

142 i‡(
a_d©e
[19] != ' ')

145 i‡((
	`isdigô
(
a_d©e
[20]) == 0) ||

146 (
	`isdigô
(
a_d©e
[21]) == 0) ||

147 (
	`isdigô
(
a_d©e
[22]) == 0) ||

148 (
	`isdigô
(
a_d©e
[23]) == 0))

153 i‡(
a_d©e
[8] != ' ')

154 
l_tm_time
.
tm_mday
 +(
a_d©e
[8] - 0x30) * 10;

155 
l_tm_time
.
tm_mday
 +(
a_d©e
[9] - 0x30);

157 
l_tm_time
.
tm_hour
 +(
a_d©e
[11] - 0x30) * 10;

158 
l_tm_time
.
tm_hour
 +(
a_d©e
[12] - 0x30);

159 
l_tm_time
.
tm_mö
 +(
a_d©e
[14] - 0x30) * 10;

160 
l_tm_time
.
tm_mö
 +(
a_d©e
[15] - 0x30);

161 
l_tm_time
.
tm_£c
 +(
a_d©e
[17] - 0x30) * 10;

162 
l_tm_time
.
tm_£c
 +(
a_d©e
[18] - 0x30);

164 
l_tm_time
.
tm_yór
 +(
a_d©e
[20] - 0x30) * 1000;

165 
l_tm_time
.
tm_yór
 +(
a_d©e
[21] - 0x30) * 100;

166 
l_tm_time
.
tm_yór
 +(
a_d©e
[22] - 0x30) * 10;

167 
l_tm_time
.
tm_yór
 +(
a_d©e
[23] - 0x30);

168 
l_tm_time
.
tm_yór
 -= 1900;

170 
l_ªtu∫
 = 
	`mktime
(&
l_tm_time
);

176 i‡(
	`°æí
(
a_d©e
) < 11)

178 
a_d©e
[
i
])

180 i‡(
a_d©e
[
i
] == ' ')

182 
l_°¨t_d©e
 = &
a_d©e
[
i
+1];

185 
i
++;

188 i‡(
l_°¨t_d©e
 =
NULL
)

191 i‡(
	`°æí
(
l_°¨t_d©e
) != 22)

195 i‡((
	`isdigô
(
l_°¨t_d©e
[0]) == 0) ||

196 (
	`isdigô
(
l_°¨t_d©e
[1]) == 0) ||

197 (
l_°¨t_d©e
[2] != '-'))

200 i‡((
l_tm_time
.
tm_m⁄
 =

201 
	`m⁄th_‰om_°rög_sh‹t
(&
l_°¨t_d©e
[3])) < 0)

204 i‡((
l_°¨t_d©e
[6] != '-') ||

205 (
	`isdigô
(
l_°¨t_d©e
[7]) == 0) ||

206 (
	`isdigô
(
l_°¨t_d©e
[8]) == 0))

208 i‡(
l_°¨t_d©e
[9] != ' ')

211 i‡((
	`isdigô
(
l_°¨t_d©e
[10]) == 0) ||

212 (
	`isdigô
(
l_°¨t_d©e
[11]) == 0) ||

213 (
l_°¨t_d©e
[12] != ':') ||

214 (
	`isdigô
(
l_°¨t_d©e
[13]) == 0) ||

215 (
	`isdigô
(
l_°¨t_d©e
[14]) == 0) ||

216 (
l_°¨t_d©e
[15] != ':') ||

217 (
	`isdigô
(
l_°¨t_d©e
[16]) == 0) ||

218 (
	`isdigô
(
l_°¨t_d©e
[17]) == 0))

220 i‡(
l_°¨t_d©e
[18] != ' ')

222 i‡(
	`°∫cmp
(&
l_°¨t_d©e
[19], "GMT", 3) != 0)

226 
l_tm_time
.
tm_mday
 +(
l_°¨t_d©e
[0] - 0x30) * 10;

227 
l_tm_time
.
tm_mday
 +(
l_°¨t_d©e
[1] - 0x30);

230 
l_tm_time
.
tm_yór
 +(
l_°¨t_d©e
[7] - 0x30) * 10;

231 
l_tm_time
.
tm_yór
 +(
l_°¨t_d©e
[8] - 0x30);

233 i‡(
l_tm_time
.
tm_yór
 < 20)

234 
l_tm_time
.
tm_yór
 += 100;

236 
l_tm_time
.
tm_hour
 +(
l_°¨t_d©e
[10] - 0x30) * 10;

237 
l_tm_time
.
tm_hour
 +(
l_°¨t_d©e
[11] - 0x30);

238 
l_tm_time
.
tm_mö
 +(
l_°¨t_d©e
[13] - 0x30) * 10;

239 
l_tm_time
.
tm_mö
 +(
l_°¨t_d©e
[14] - 0x30);

240 
l_tm_time
.
tm_£c
 +(
l_°¨t_d©e
[16] - 0x30) * 10;

241 
l_tm_time
.
tm_£c
 +(
l_°¨t_d©e
[17] - 0x30);

243 
l_ªtu∫
 = 
	`mktime
(&
l_tm_time
);

245  
l_ªtu∫
;

246 
	}
}

249 
	$m⁄th_‰om_°rög_sh‹t
(c⁄° *
a_m⁄th
)

251 i‡(
	`°∫cmp
(
a_m⁄th
, "Jan", 3) == 0)

253 i‡(
	`°∫cmp
(
a_m⁄th
, "Feb", 3) == 0)

255 i‡(
	`°∫cmp
(
a_m⁄th
, "Mar", 3) == 0)

257 i‡(
	`°∫cmp
(
a_m⁄th
, "Apr", 3) == 0)

259 i‡(
	`°∫cmp
(
a_m⁄th
, "May", 3) == 0)

261 i‡(
	`°∫cmp
(
a_m⁄th
, "Jun", 3) == 0)

263 i‡(
	`°∫cmp
(
a_m⁄th
, "Jul", 3) == 0)

265 i‡(
	`°∫cmp
(
a_m⁄th
, "Aug", 3) == 0)

267 i‡(
	`°∫cmp
(
a_m⁄th
, "Sep", 3) == 0)

269 i‡(
	`°∫cmp
(
a_m⁄th
, "Oct", 3) == 0)

271 i‡(
	`°∫cmp
(
a_m⁄th
, "Nov", 3) == 0)

273 i‡(
	`°∫cmp
(
a_m⁄th
, "Dec", 3) == 0)

277 
	}
}

	@src/liblwqq/libghttp/http_date.h

22 #i‚de‡
HTTP_DATE_H


23 
	#HTTP_DATE_H


	)

25 
	~<time.h
>

27 
time_t


28 
hâp_d©e_to_time
(c⁄° *
a_d©e
);

	@src/liblwqq/libghttp/http_global.h

23 #i‚de‡
HTTP_GLOBAL_H


24 
	#HTTP_GLOBAL_H


	)

26 
	#HTTP_TRANS_ERR
 -1

	)

27 
	#HTTP_TRANS_NOT_DONE
 1

	)

28 
	#HTTP_TRANS_DONE
 2

	)

30 
	#HTTP_TRANS_SYNC
 0

	)

31 
	#HTTP_TRANS_ASYNC
 1

	)

	@src/liblwqq/libghttp/http_hdrs.c

22 
	~<°dlib.h
>

23 
	~<°rög.h
>

24 
	~"hâp_hdrs.h
"

28 c⁄° 
	ghâp_hdr_AŒow
[] = "Allow";

29 c⁄° 
	ghâp_hdr_C⁄ã¡_Encodög
[] = "Content-Encoding";

30 c⁄° 
	ghâp_hdr_C⁄ã¡_L™guage
[] = "Content-Language";

31 c⁄° 
	ghâp_hdr_C⁄ã¡_Lígth
[] = "Content-Length";

32 c⁄° 
	ghâp_hdr_C⁄ã¡_Loˇti⁄
[] = "Content-Location";

33 c⁄° 
	ghâp_hdr_C⁄ã¡_MD5
[] = "Content-MD5";

34 c⁄° 
	ghâp_hdr_C⁄ã¡_R™ge
[] = "Content-Range";

35 c⁄° 
	ghâp_hdr_C⁄ã¡_Ty≥
[] = "Content-Type";

36 c⁄° 
	ghâp_hdr_Expúes
[] = "Expires";

37 c⁄° 
	ghâp_hdr_La°_Modifõd
[] = "Last-Modified";

41 c⁄° 
	ghâp_hdr_Cache_C⁄åﬁ
[] = "Cache-Control";

42 c⁄° 
	ghâp_hdr_C⁄√˘i⁄
[] = "Connection";

43 c⁄° 
	ghâp_hdr_D©e
[] = "Date";

44 c⁄° 
	ghâp_hdr_Pøgma
[] = "Pragma";

45 c⁄° 
	ghâp_hdr_Tøns„r_Encodög
[] = "Transfer-Encoding";

46 c⁄° 
	ghâp_hdr_Upd©e
[] = "Update";

47 c⁄° 
	ghâp_hdr_Tøûî
[] = "Trailer";

48 c⁄° 
	ghâp_hdr_Vü
[] = "Via";

52 c⁄° 
	ghâp_hdr_Ac˚±
[] = "Accept";

53 c⁄° 
	ghâp_hdr_Ac˚±_Ch¨£t
[] = "Accept-Charset";

54 c⁄° 
	ghâp_hdr_Ac˚±_Encodög
[] = "Accept-Encoding";

55 c⁄° 
	ghâp_hdr_Ac˚±_L™guage
[] = "Accept-Language";

56 c⁄° 
	ghâp_hdr_Auth‹iz©i⁄
[] = "Authorization";

57 c⁄° 
	ghâp_hdr_Ex≥˘
[] = "Expect";

58 c⁄° 
	ghâp_hdr_From
[] = "From";

59 c⁄° 
	ghâp_hdr_Ho°
[] = "Host";

60 c⁄° 
	ghâp_hdr_If_Modifõd_Sö˚
[] = "If-Modified-Since";

61 c⁄° 
	ghâp_hdr_If_M©ch
[] = "If-Match";

62 c⁄° 
	ghâp_hdr_If_N⁄e_M©ch
[] = "If-None-Match";

63 c⁄° 
	ghâp_hdr_If_R™ge
[] = "If-Range";

64 c⁄° 
	ghâp_hdr_If_Unmodifõd_Sö˚
[] = "If-Unmodified-Since";

65 c⁄° 
	ghâp_hdr_Max_F‹w¨ds
[] = "Max-Forwards";

66 c⁄° 
	ghâp_hdr_Proxy_Auth‹iz©i⁄
[] = "Proxy-Authorization";

67 c⁄° 
	ghâp_hdr_R™ge
[] = "Range";

68 c⁄° 
	ghâp_hdr_Re„ºî
[] = "Referrer";

69 c⁄° 
	ghâp_hdr_TE
[] = "TE";

70 c⁄° 
	ghâp_hdr_U£r_Agít
[] = "User-Agent";

74 c⁄° 
	ghâp_hdr_Ac˚±_R™ges
[] = "Accept-Ranges";

75 c⁄° 
	ghâp_hdr_Age
[] = "Age";

76 c⁄° 
	ghâp_hdr_ETag
[] = "ETag";

77 c⁄° 
	ghâp_hdr_Loˇti⁄
[] = "Location";

78 c⁄° 
	ghâp_hdr_Rëry_A·î
[] = "Retry-After";

79 c⁄° 
	ghâp_hdr_Sîvî
[] = "Server";

80 c⁄° 
	ghâp_hdr_V¨y
[] = "Vary";

81 c⁄° 
	ghâp_hdr_W¨nög
[] = "Warning";

82 c⁄° 
	ghâp_hdr_WWW_Authítiˇã
[] = "WWW-Authenticate";

86 c⁄° 
	ghâp_hdr_Së_Cookõ
[] = "Set-Cookie";

90 c⁄° 
	ghâp_hdr_DAV
[] = "DAV";

91 c⁄° 
	ghâp_hdr_Dïth
[] = "Depth";

92 c⁄° 
	ghâp_hdr_De°ö©i⁄
[] = "Destination";

93 c⁄° 
	ghâp_hdr_If
[] = "If";

94 c⁄° 
	ghâp_hdr_Lock_Tokí
[] = "Lock-Token";

95 c⁄° 
	ghâp_hdr_Ovîwrôe
[] = "Overwrite";

96 c⁄° 
	ghâp_hdr_Sètus_URI
[] = "Status-URI";

97 c⁄° 
	ghâp_hdr_Timeout
[] = "Timeout";

99 c⁄° *
	ghâp_hdr_known_li°
[] =

102 
hâp_hdr_AŒow
,

103 
hâp_hdr_C⁄ã¡_Encodög
,

104 
hâp_hdr_C⁄ã¡_L™guage
,

105 
hâp_hdr_C⁄ã¡_Lígth
,

106 
hâp_hdr_C⁄ã¡_Loˇti⁄
,

107 
hâp_hdr_C⁄ã¡_MD5
,

108 
hâp_hdr_C⁄ã¡_R™ge
,

109 
hâp_hdr_C⁄ã¡_Ty≥
,

110 
hâp_hdr_Expúes
,

111 
hâp_hdr_La°_Modifõd
,

113 
hâp_hdr_Cache_C⁄åﬁ
,

114 
hâp_hdr_C⁄√˘i⁄
,

115 
hâp_hdr_D©e
,

116 
hâp_hdr_Pøgma
,

117 
hâp_hdr_Tøns„r_Encodög
,

118 
hâp_hdr_Upd©e
,

119 
hâp_hdr_Tøûî
,

120 
hâp_hdr_Vü
,

122 
hâp_hdr_Ac˚±
,

123 
hâp_hdr_Ac˚±_Ch¨£t
,

124 
hâp_hdr_Ac˚±_Encodög
,

125 
hâp_hdr_Ac˚±_L™guage
,

126 
hâp_hdr_Auth‹iz©i⁄
,

127 
hâp_hdr_Ex≥˘
,

128 
hâp_hdr_From
,

129 
hâp_hdr_Ho°
,

130 
hâp_hdr_If_Modifõd_Sö˚
,

131 
hâp_hdr_If_M©ch
,

132 
hâp_hdr_If_N⁄e_M©ch
,

133 
hâp_hdr_If_R™ge
,

134 
hâp_hdr_If_Unmodifõd_Sö˚
,

135 
hâp_hdr_Max_F‹w¨ds
,

136 
hâp_hdr_Proxy_Auth‹iz©i⁄
,

137 
hâp_hdr_R™ge
,

138 
hâp_hdr_Re„ºî
,

139 
hâp_hdr_TE
,

140 
hâp_hdr_U£r_Agít
,

142 
hâp_hdr_Ac˚±_R™ges
,

143 
hâp_hdr_Age
,

144 
hâp_hdr_ETag
,

145 
hâp_hdr_Loˇti⁄
,

146 
hâp_hdr_Rëry_A·î
,

147 
hâp_hdr_Sîvî
,

148 
hâp_hdr_V¨y
,

149 
hâp_hdr_W¨nög
,

150 
hâp_hdr_WWW_Authítiˇã
,

151 
NULL


157 
	$hâp_hdr_is_known
(c⁄° *
a_hdr
)

159 
l_pos
 = 0;

160 c⁄° *
l_ªtu∫
 = 
NULL
;

162 i‡(!
a_hdr
)

163 
ec
;

164 
hâp_hdr_known_li°
[
l_pos
] !
NULL
)

166 i‡(
	`°rˇ£cmp
(
a_hdr
, 
hâp_hdr_known_li°
[
l_pos
]) == 0)

168 
l_ªtu∫
 = 
hâp_hdr_known_li°
[
l_pos
];

171 
l_pos
++;

173 
ec
:

174  
l_ªtu∫
;

175 
	}
}

177 
hâp_hdr_li°
 *

178 
	$hâp_hdr_li°_√w
()

180 
hâp_hdr_li°
 *
l_ªtu∫
 = 
NULL
;

182 
l_ªtu∫
 = (
hâp_hdr_li°
 *)
	`mÆloc
((http_hdr_list));

183 
	`mem£t
(
l_ªtu∫
, 0, (
hâp_hdr_li°
));

184  
l_ªtu∫
;

185 
	}
}

188 
	$hâp_hdr_li°_de°roy
(
hâp_hdr_li°
 *
a_li°
)

190 
i
 = 0;

192 i‡(
a_li°
 =
NULL
)

194 
i
=0; i < 
HTTP_HDRS_MAX
; i++)

196 i‡(
a_li°
->
hódî
[
i
] &&

197 (
	`hâp_hdr_is_known
(
a_li°
->
hódî
[
i
]Ë=
NULL
))

198 
	`‰ì
(
a_li°
->
hódî
[
i
]);

199 i‡(
a_li°
->
vÆue
[
i
])

200 
	`‰ì
(
a_li°
->
vÆue
[
i
]);

202 
	`‰ì
 (
a_li°
);

203 
	}
}

206 
	$hâp_hdr_£t_vÆue_no_¡s
(
hâp_hdr_li°
 *
a_li°
,

207 c⁄° *
a_«me_°¨t
,

208 
a_«me_Àn
,

209 c⁄° *
a_vÆ_°¨t
,

210 
a_vÆ_Àn
)

212 
l_ªtu∫
 = 0;

213 *
l_ãmp_«me
 = 
NULL
;

214 *
l_ãmp_vÆ
 = 
NULL
;

217 i‡((
a_li°
 =
NULL
) ||

218 (
a_«me_°¨t
 =
NULL
) ||

219 (
a_vÆ_°¨t
 =
NULL
) ||

220 (
a_«me_Àn
 == 0))

221 
ec
;

222 
l_ãmp_«me
 = (*)
	`mÆloc
(
a_«me_Àn
 + 1);

223 
	`mem£t
(
l_ãmp_«me
, 0, 
a_«me_Àn
 + 1);

224 
	`mem˝y
(
l_ãmp_«me
, 
a_«me_°¨t
, 
a_«me_Àn
);

225 
l_ãmp_vÆ
 = (*)
	`mÆloc
(
a_vÆ_Àn
 + 1);

226 
	`mem£t
(
l_ãmp_vÆ
, 0, 
a_vÆ_Àn
 + 1);

227 
	`mem˝y
(
l_ãmp_vÆ
, 
a_vÆ_°¨t
, 
a_vÆ_Àn
);

229 
l_ªtu∫
 = 
	`hâp_hdr_£t_vÆue
(
a_li°
,

230 
l_ãmp_«me
,

231 
l_ãmp_vÆ
);

232 
	`‰ì
(
l_ãmp_«me
);

233 
	`‰ì
(
l_ãmp_vÆ
);

234 
ec
:

235  
l_ªtu∫
;

237 
	}
}

254 
	$hâp_hdr_£t_cookõ_vÆue
(
hâp_hdr_li°
 *
a_li°
,

255 c⁄° *
a_vÆ
)

257 
i
 = 0;

258 *
l_ãmp_vÆue
 = 
NULL
;

259 
l_ªtu∫
 = 0;

261 
i
 = 0; i < 
HTTP_HDRS_MAX
; i++) {

262 i‡(
a_li°
->
hódî
[
i
])

266 
l_ãmp_vÆue
 = (*)
	`hâp_hdr_is_known
("Set-Cookie");

267 i‡(
l_ãmp_vÆue
) {

268 
a_li°
->
hódî
[
i
] = 
l_ãmp_vÆue
;

271 
a_li°
->
hódî
[
i
] = 
	`°rdup
("Set-Cookie");

273 
a_li°
->
vÆue
[
i
] = 
	`°rdup
(
a_vÆ
);

274 
l_ªtu∫
 = 1;

277  
l_ªtu∫
;

278 
	}
}

281 
	$hâp_hdr_£t_vÆue
(
hâp_hdr_li°
 *
a_li°
,

282 c⁄° *
a_«me
,

283 c⁄° *
a_vÆ
)

285 
i
 = 0;

286 *
l_ãmp_vÆue
 = 
NULL
;

287 
l_ªtu∫
 = 0;

289 i‡((
a_li°
 =
NULL
Ë|| (
a_«me
 =NULLË|| (
a_vÆ
 == NULL))

290 
ec
;

293 i‡(!
	`°rcmp
(
a_«me
, "Set-Cookie")) {

294  
	`hâp_hdr_£t_cookõ_vÆue
(
a_li°
, 
a_vÆ
);

297 
l_ãmp_vÆue
 = 
	`hâp_hdr_gë_vÆue
(
a_li°
, 
a_«me
);

298 i‡(
l_ãmp_vÆue
 =
NULL
)

300 
i
=0; i < 
HTTP_HDRS_MAX
; i++)

302 i‡(
a_li°
->
hódî
[
i
] =
NULL
)

305 
l_ãmp_vÆue
 = (*)
	`hâp_hdr_is_known
(
a_«me
);

306 i‡(
l_ãmp_vÆue
)

308 
a_li°
->
hódî
[
i
] = 
l_ãmp_vÆue
;

312 
a_li°
->
hódî
[
i
] = 
	`°rdup
(
a_«me
);

313 
a_li°
->
vÆue
[
i
] = 
	`°rdup
(
a_vÆ
);

314 
l_ªtu∫
 = 1;

321 
i
 = 0; i < 
HTTP_HDRS_MAX
; i++)

323 i‡(
a_li°
->
vÆue
[
i
] =
l_ãmp_vÆue
)

325 
	`‰ì
(
a_li°
->
vÆue
[
i
]);

326 
a_li°
->
vÆue
[
i
] = 
	`°rdup
(
a_vÆ
);

327 
l_ªtu∫
 = 1;

332 
ec
:

333  
l_ªtu∫
;

334 
	}
}

336 *
	$hâp_hdr_gë_cookõ
(
hâp_hdr_li°
 *
a_li°
, c⁄° *
a_«me
)

338 
i
 = 0;

339 *
l_ªtu∫
 = 
NULL
;

341 i‡(
a_«me
 =
NULL
)

342 
ec
;

343 
i
=0; i < 
HTTP_HDRS_MAX
; i++) {

344 i‡(
a_li°
->
hódî
[
i
] =
NULL
 ||

345 
a_li°
->
vÆue
[
i
] =
NULL
||

346 
	`°rˇ£cmp
(
a_li°
->
hódî
[
i
], "Set-Cookie")) {

349 i‡(
	`°r°r
(
a_li°
->
vÆue
[
i
], 
a_«me
)) {

350 
cookõ
[256] = {0};

351 *
°¨t
;

352 *
íd
;

354 
	`°∫˝y
(
cookõ
, 
a_li°
->
vÆue
[
i
], (cookie) - 1);

355 
°¨t
 = 
	`°r°r
(
cookõ
, 
a_«me
);

356 if(!
°¨t
){

357 
ec
;

359 
°¨t
 +
	`°æí
(
a_«me
) + 1;

360 
íd
 = 
	`°r°r
(
°¨t
, ";");

361 i‡(
íd
) {

362 *
íd
 = '\0';

365 
l_ªtu∫
 = 
	`°rdup
(
°¨t
);

369 
ec
:

370  
l_ªtu∫
;

371 
	}
}

374 
	$hâp_hdr_gë_vÆue
(
hâp_hdr_li°
 *
a_li°
,

375 c⁄° *
a_«me
)

377 
i
 = 0;

378 *
l_ªtu∫
 = 
NULL
;

380 i‡(
a_«me
 =
NULL
)

381 
ec
;

382 
i
=0; i < 
HTTP_HDRS_MAX
; i++)

384 i‡(
a_li°
->
hódî
[
i
] &&

385 (
	`°rˇ£cmp
(
a_li°
->
hódî
[
i
], 
a_«me
) == 0))

387 i‡(
a_li°
->
vÆue
[
i
] =
NULL
)

388 
ec
;

389 
l_ªtu∫
 = 
a_li°
->
vÆue
[
i
];

393 
ec
:

394  
l_ªtu∫
;

395 
	}
}

398 
	$hâp_hdr_gë_hódîs
(
hâp_hdr_li°
 *
a_li°
, ***
a_«mes
,

399 *
a_num_«mes
)

401 
i
 = 0;

402 
l_num_«mes
 = 0;

403 **
l_«mes
;

405 i‡(
a_num_«mes
 =
NULL
)

407 i‡(
a_«mes
 =
NULL
)

411 *
a_«mes
 = 
NULL
;

412 *
a_num_«mes
 = 0;

415 
i
=0; i < 
HTTP_HDRS_MAX
; i++)

417 i‡(
a_li°
->
hódî
[
i
])

418 
l_num_«mes
++;

422 i‡(
l_num_«mes
 == 0)

427 
l_«mes
 = 
	`mÆloc
((*Ë* 
l_num_«mes
);

428 i‡(
l_«mes
 =
NULL
)

432 
	`mem£t
(
l_«mes
, 0, 
l_num_«mes
);

435 
i
=0; i < 
HTTP_HDRS_MAX
; i++)

437 i‡(
a_li°
->
hódî
[
i
])

439 
l_«mes
[
i
] = 
	`°rdup
(
a_li°
->
hódî
[i]);

440 i‡(
l_«mes
[
i
] =
NULL
)

441 
ec
;

445 *
a_«mes
 = 
l_«mes
;

446 *
a_num_«mes
 = 
l_num_«mes
;

450 
ec
:

451 i‡(
l_«mes
)

453 
i
=0; i < 
l_num_«mes
; i++)

455 i‡(
l_«mes
[
i
])

457 
	`‰ì
(
l_«mes
[
i
]);

458 
l_«mes
[
i
] = 
NULL
;

461 
	`‰ì
(
l_«mes
);

462 *
a_«mes
 = 0;

464 *
a_num_«mes
 = 0;

466 
	}
}

469 
	$hâp_hdr_˛ór_vÆue
(
hâp_hdr_li°
 *
a_li°
,

470 c⁄° *
a_«me
)

472 
i
 = 0;

473 
l_ªtu∫
 = 0;

475 i‡((
a_li°
 =
NULL
Ë|| (
a_«me
 == NULL))

476 
ec
;

477 
i
=0; i < 
HTTP_HDRS_MAX
; i++)

479 i‡(
a_«me
 && 
a_li°
->
hódî
[
i
] &&

480 (
	`°rˇ£cmp
(
a_li°
->
hódî
[
i
], 
a_«me
) == 0))

482 i‡(
	`hâp_hdr_is_known
(
a_«me
Ë=
NULL
)

483 
	`‰ì
(
a_li°
->
hódî
[
i
]);

484 
a_li°
->
hódî
[
i
] = 
NULL
;

485 
	`‰ì
(
a_li°
->
vÆue
[
i
]);

486 
a_li°
->
vÆue
[
i
] = 
NULL
;

489 
ec
:

490  
l_ªtu∫
;

491 
	}
}

	@src/liblwqq/libghttp/http_hdrs.h

22 #i‚de‡
HTTP_HDRS_H


23 
	#HTTP_HDRS_H


	)

25 
	~"ghâp_c⁄°™ts.h
"

28 c⁄° *
hâp_hdr_known_li°
[];

31 
	#HTTP_HDRS_MAX
 256

	)

32 
	shâp_hdr_li°_èg


34 *
	mhódî
[
HTTP_HDRS_MAX
];

35 *
	mvÆue
[
HTTP_HDRS_MAX
];

36 } 
	thâp_hdr_li°
;

42 
hâp_hdr_is_known
(c⁄° *
a_hdr
);

45 
hâp_hdr_li°
 *

46 
hâp_hdr_li°_√w
();

50 
hâp_hdr_li°_de°roy
(
hâp_hdr_li°
 *
a_li°
);

54 
hâp_hdr_£t_vÆue
(
hâp_hdr_li°
 *
a_li°
,

55 c⁄° *
a_«me
,

56 c⁄° *
a_vÆ
);

60 
hâp_hdr_£t_vÆue_no_¡s
(
hâp_hdr_li°
 *
a_li°
,

61 c⁄° *
a_«me_°¨t
,

62 
a_«me_Àn
,

63 c⁄° *
a_vÆ_°¨t
,

64 
a_vÆ_Àn
);

68 
hâp_hdr_gë_vÆue
(
hâp_hdr_li°
 *
a_li°
,

69 c⁄° *
a_«me
);

73 
hâp_hdr_gë_cookõ
(
hâp_hdr_li°
 *
a_li°
,

74 c⁄° *
a_«me
);

78 
hâp_hdr_gë_hódîs
(
hâp_hdr_li°
 *
a_li°
,

79 ***
a_«mes
,

80 *
a_num_«mes
);

84 
hâp_hdr_˛ór_vÆue
(
hâp_hdr_li°
 *
a_li°
,

85 c⁄° *
a_«me
);

	@src/liblwqq/libghttp/http_req.c

22 
	~<°rög.h
>

23 
	~<°dlib.h
>

24 
	~"hâp_ªq.h
"

25 
	~"hâp_å™s.h
"

26 
	~"hâp_globÆ.h
"

29 
	ghâp_ªq_ty≥_ch¨
[] = {

45 
NULL


48 
hâp_ªq
 *

49 
	$hâp_ªq_√w
()

51 
hâp_ªq
 *
l_ªtu∫
 = 
NULL
;

53 
l_ªtu∫
 = (
hâp_ªq
 *)
	`mÆloc
((http_req));

54 
	`mem£t
(
l_ªtu∫
, 0, (
hâp_ªq
));

56 
l_ªtu∫
->
hâp_vî
 = 1.1;

57 
l_ªtu∫
->
hódîs
 = 
	`hâp_hdr_li°_√w
();

58  
l_ªtu∫
;

59 
	}
}

62 
	$hâp_ªq_de°roy
(
hâp_ªq
 *
a_ªq
)

64 i‡(!
a_ªq
)

66 i‡(
a_ªq
->
hódîs
)

67 
	`hâp_hdr_li°_de°roy
(
a_ªq
->
hódîs
);

68 
	`‰ì
(
a_ªq
);

69 
	}
}

72 
	$hâp_ªq_¥ï¨e
(
hâp_ªq
 *
a_ªq
)

74 
l_ªtu∫
 = 0;

75 
l_buf
[30];

77 i‡(!
a_ªq
)

79 
	`mem£t
(
l_buf
, 0, 30);

81 
	`hâp_hdr_£t_vÆue
(
a_ªq
->
hódîs
,

82 
hâp_hdr_Ho°
,

83 
a_ªq
->
ho°
);

85 i‡((
a_ªq
->
ty≥
 =
hâp_ªq_ty≥_po°
) ||

86 (
a_ªq
->
ty≥
 =
hâp_ªq_ty≥_put
) ||

87 (
a_ªq
->
ty≥
 =
hâp_ªq_ty≥_åa˚
))

89 
	`•rötf
(
l_buf
, "%d", 
a_ªq
->
body_Àn
);

90 
	`hâp_hdr_£t_vÆue
(
a_ªq
->
hódîs
,

91 
hâp_hdr_C⁄ã¡_Lígth
,

92 
l_buf
);

95 i‡(
	`hâp_hdr_gë_vÆue
(
a_ªq
->
hódîs
, 
hâp_hdr_U£r_Agít
Ë=
NULL
)

96 
	`hâp_hdr_£t_vÆue
(
a_ªq
->
hódîs
, 
hâp_hdr_U£r_Agít
,

98  
l_ªtu∫
;

99 
	}
}

102 
	$hâp_ªq_£nd
(
hâp_ªq
 *
a_ªq
, 
hâp_å™s_c⁄n
 *
a_c⁄n
)

104 *
l_ªque°
 = 
NULL
;

105 
l_ªque°_Àn
 = 0;

106 
i
 = 0;

107 
l_Àn
 = 0;

108 
l_hódîs_Àn
 = 0;

109 
l_rv
 = 0;

110 *
l_c⁄ã¡
 = 
NULL
;

113 i‡(
a_c⁄n
->
sync
 =
HTTP_TRANS_ASYNC
)

115 i‡(
a_ªq
->
°©e
 =
hâp_ªq_°©e_£ndög_ªque°
)

116 
hâp_ªq_°©e_£ndög_ªque°_jump
;

117 i‡(
a_ªq
->
°©e
 =
hâp_ªq_°©e_£ndög_hódîs
)

118 
hâp_ªq_°©e_£ndög_hódîs_jump
;

119 i‡(
a_ªq
->
°©e
 =
hâp_ªq_°©e_£ndög_body
)

120 
hâp_ªq_°©e_£ndög_body_jump
;

123 
l_ªque°
 = 
	`mÆloc
(30 + 
	`°æí
(
a_ªq
->
ªsour˚
Ë+ (
a_c⁄n
->
¥oxy_ho°
 ?

124 (
	`°æí
(
a_ªq
->
ho°
) + 20) : 0));

125 
	`mem£t
(
l_ªque°
, 0, 30 + 
	`°æí
(
a_ªq
->
ªsour˚
Ë+ (
a_c⁄n
->
¥oxy_ho°
 ?

126 (
	`°æí
(
a_ªq
->
ho°
) + 20) : 0));

128 i‡(
a_c⁄n
->
¥oxy_ho°
)

130 
l_ªque°_Àn
 = 
	`•rötf
(
l_ªque°
,

132 
hâp_ªq_ty≥_ch¨
[
a_ªq
->
ty≥
],

133 
a_ªq
->
fuŒ_uri
,

134 
a_ªq
->
hâp_vî
);

138 
l_ªque°_Àn
 = 
	`•rötf
(
l_ªque°
,

140 
hâp_ªq_ty≥_ch¨
[
a_ªq
->
ty≥
],

141 
a_ªq
->
ªsour˚
,

142 
a_ªq
->
hâp_vî
);

145 
	`hâp_å™s_≠≥nd_d©a_to_buf
(
a_c⁄n
, 
l_ªque°
, 
l_ªque°_Àn
);

147 
	`‰ì
(
l_ªque°
);

148 
l_ªque°
 = 
NULL
;

150 
a_ªq
->
°©e
 = 
hâp_ªq_°©e_£ndög_ªque°
;

151 
hâp_ªq_°©e_£ndög_ªque°_jump
:

154 
l_rv
 = 
	`hâp_å™s_wrôe_buf
(
a_c⁄n
);

155 i‡((
a_c⁄n
->
sync
 =
HTTP_TRANS_ASYNC
Ë&& (
l_rv
 =
HTTP_TRANS_NOT_DONE
))

156  
HTTP_TRANS_NOT_DONE
;

157 i‡((
l_rv
 =
HTTP_TRANS_DONE
Ë&& (
a_c⁄n
->
œ°_ªad
 == 0))

158  
HTTP_TRANS_ERR
;

159 } 
l_rv
 =
HTTP_TRANS_NOT_DONE
);

161 
	`hâp_å™s_buf_ª£t
(
a_c⁄n
);

163 
i
 = 0; i < 
HTTP_HDRS_MAX
; i++)

165 
l_Àn
 = 0;

166 i‡(
a_ªq
->
hódîs
->
hódî
[
i
])

168 
l_Àn
 = 
	`°æí
(
a_ªq
->
hódîs
->
hódî
[
i
]);

169 i‡(
l_Àn
 > 0)

171 
	`hâp_å™s_≠≥nd_d©a_to_buf
(
a_c⁄n
, 
a_ªq
->
hódîs
->
hódî
[
i
], 
l_Àn
);

172 
l_hódîs_Àn
 +
l_Àn
;

173 
	`hâp_å™s_≠≥nd_d©a_to_buf
(
a_c⁄n
, ": ", 2);

174 
l_hódîs_Àn
 += 2;

176 i‡((
l_Àn
 = 
	`°æí
(
a_ªq
->
hódîs
->
vÆue
[
i
])) > 0)

178 
	`hâp_å™s_≠≥nd_d©a_to_buf
(
a_c⁄n
, 
a_ªq
->
hódîs
->
vÆue
[
i
], 
l_Àn
);

179 
l_hódîs_Àn
 +
l_Àn
;

181 
	`hâp_å™s_≠≥nd_d©a_to_buf
(
a_c⁄n
, "\r\n", 2);

182 
l_hódîs_Àn
 += 2;

186 
	`hâp_å™s_≠≥nd_d©a_to_buf
(
a_c⁄n
, "\r\n", 2);

187 
l_hódîs_Àn
 += 2;

189 
a_ªq
->
°©e
 = 
hâp_ªq_°©e_£ndög_hódîs
;

190 
hâp_ªq_°©e_£ndög_hódîs_jump
:

193 
l_rv
 = 
	`hâp_å™s_wrôe_buf
(
a_c⁄n
);

194 i‡((
a_c⁄n
->
sync
 =
HTTP_TRANS_ASYNC
Ë&& (
l_rv
 =
HTTP_TRANS_NOT_DONE
))

195  
HTTP_TRANS_NOT_DONE
;

196 i‡((
l_rv
 =
HTTP_TRANS_DONE
Ë&& (
a_c⁄n
->
œ°_ªad
 == 0))

197  
HTTP_TRANS_ERR
;

198 } 
l_rv
 =
HTTP_TRANS_NOT_DONE
);

200 
	`hâp_å™s_buf_ª£t
(
a_c⁄n
);

201 
l_c⁄ã¡
 = 
	`hâp_hdr_gë_vÆue
(
a_ªq
->
hódîs
, 
hâp_hdr_C⁄ã¡_Lígth
);

202 i‡(
l_c⁄ã¡
)

205 
	`hâp_å™s_≠≥nd_d©a_to_buf
(
a_c⁄n
, 
a_ªq
->
body
,á_ªq->
body_Àn
);

206 
a_ªq
->
°©e
 = 
hâp_ªq_°©e_£ndög_body
;

207 
hâp_ªq_°©e_£ndög_body_jump
:

209 
l_rv
 = 
	`hâp_å™s_wrôe_buf
(
a_c⁄n
);

210 i‡((
a_c⁄n
->
sync
 =
HTTP_TRANS_ASYNC
Ë&& (
l_rv
 =
HTTP_TRANS_NOT_DONE
))

211  
HTTP_TRANS_NOT_DONE
;

212 i‡((
l_rv
 =
HTTP_TRANS_DONE
Ë&& (
a_c⁄n
->
œ°_ªad
 == 0))

213  
HTTP_TRANS_ERR
;

214 } 
l_rv
 =
HTTP_TRANS_NOT_DONE
);

216 
	`hâp_å™s_buf_ª£t
(
a_c⁄n
);

218  
HTTP_TRANS_DONE
;

219 
	}
}

	@src/liblwqq/libghttp/http_req.h

24 #i‚de‡
HTTP_REQ_H


25 
	#HTTP_REQ_H


	)

27 
	~<°dio.h
>

28 
	~"hâp_hdrs.h
"

29 
	~"hâp_å™s.h
"

31 
	ehâp_ªq_ty≥
 {

32 
	mhâp_ªq_ty≥_gë
 = 0,

33 
	mhâp_ªq_ty≥_›ti⁄s
,

34 
	mhâp_ªq_ty≥_hód
,

35 
	mhâp_ªq_ty≥_po°
,

36 
	mhâp_ªq_ty≥_put
,

37 
	mhâp_ªq_ty≥_dñëe
,

38 
	mhâp_ªq_ty≥_åa˚
,

39 
	mhâp_ªq_ty≥_c⁄√˘
,

40 
	mhâp_ªq_ty≥_¥›föd
,

41 
	mhâp_ªq_ty≥_¥›∑tch
,

42 
	mhâp_ªq_ty≥_mkcﬁ
,

43 
	mhâp_ªq_ty≥_c›y
,

44 
	mhâp_ªq_ty≥_move
,

45 
	mhâp_ªq_ty≥_lock
,

46 
	mhâp_ªq_ty≥_u∆ock


47 } 
	thâp_ªq_ty≥
;

49 
	ehâp_ªq_°©e_èg
 {

50 
	mhâp_ªq_°©e_°¨t
 = 0,

51 
	mhâp_ªq_°©e_£ndög_ªque°
,

52 
	mhâp_ªq_°©e_£ndög_hódîs
,

53 
	mhâp_ªq_°©e_£ndög_body


54 } 
	thâp_ªq_°©e
;

58 c⁄° *
hâp_ªq_ty≥_ch¨
[];

60 
	shâp_ªq_èg
 {

61 
hâp_ªq_ty≥
 
	mty≥
;

62 
	mhâp_vî
;

63 *
	mho°
;

64 *
	mfuŒ_uri
;

65 *
	mªsour˚
;

66 *
	mbody
;

67 
	mbody_Àn
;

68 
hâp_hdr_li°
 *
	mhódîs
;

69 
hâp_ªq_°©e
 
	m°©e
;

70 } 
	thâp_ªq
;

72 
hâp_ªq
 *

73 
hâp_ªq_√w
();

76 
hâp_ªq_de°roy
(
hâp_ªq
 *
a_ªq
);

79 
hâp_ªq_¥ï¨e
(
hâp_ªq
 *
a_ªq
);

82 
hâp_ªq_£nd
(
hâp_ªq
 *
a_ªq
, 
hâp_å™s_c⁄n
 *
a_c⁄n
);

	@src/liblwqq/libghttp/http_resp.c

22 
	~<°dlib.h
>

23 
	~<°rög.h
>

24 
	~<˘y≥.h
>

25 
	~<uni°d.h
>

26 
	~"hâp_ª•.h
"

27 
	~"hâp_globÆ.h
"

29 
	ehódî_°©e_èg


31 
	mªadög_hódî
 = 0,

32 
	mªadög_vÆue
,

33 
	mªadög_£p
,

34 
	mªadög_eﬁ


35 } 
	thódî_°©e
;

38 
°rög_is_numbî
(*
a_°rög
);

41 
ªad_chunk
(
hâp_å™s_c⁄n
 *
a_c⁄n
);

44 
ªad_body_chunked
(
hâp_ª•
 *
a_ª•
,

45 
hâp_ªq
 *
a_ªq
,

46 
hâp_å™s_c⁄n
 *
a_c⁄n
);

49 
ªad_body_c⁄ã¡_Àngth
(
hâp_ª•
 *
a_ª•
,

50 
hâp_ªq
 *
a_ªq
,

51 
hâp_å™s_c⁄n
 *
a_c⁄n
);

54 
ªad_body_°™d¨d
(
hâp_ª•
 *
a_ª•
,

55 
hâp_ªq
 *
a_ªq
,

56 
hâp_å™s_c⁄n
 *
a_c⁄n
);

58 
hâp_ª•
 *

59 
	$hâp_ª•_√w
()

61 
hâp_ª•
 *
l_ªtu∫
 = 
NULL
;

63 
l_ªtu∫
 = (
hâp_ª•
 *)
	`mÆloc
((http_resp));

64 
	`mem£t
(
l_ªtu∫
, 0, (
hâp_ª•
));

65 
l_ªtu∫
->
hódîs
 = 
	`hâp_hdr_li°_√w
();

66  
l_ªtu∫
;

67 
	}
}

70 
	$hâp_ª•_de°roy
(
hâp_ª•
 *
a_ª•
)

72 i‡(!
a_ª•
)

74 i‡(
a_ª•
->
ªas⁄_phø£
)

75 
	`‰ì
(
a_ª•
->
ªas⁄_phø£
);

76 i‡(
a_ª•
->
hódîs
)

77 
	`hâp_hdr_li°_de°roy
(
a_ª•
->
hódîs
);

78 i‡(
a_ª•
->
body
)

79 
	`‰ì
(
a_ª•
->
body
);

80 
	`‰ì
(
a_ª•
);

82 
	}
}

85 
	$hâp_ª•_ªad_hódîs
(
hâp_ª•
 *
a_ª•
, 
hâp_å™s_c⁄n
 *
a_c⁄n
)

87 *
l_°¨t_body
 = 
NULL
;

88 
l_rv
 = 0;

89 
l_d⁄e
 = 0;

90 
l_ªtu∫
 = 
HTTP_TRANS_DONE
;

91 *
l_°¨t_hódî
 = 
NULL
;

92 
l_hódî_Àn
 = 0;

93 *
l_œ°_hódî
 = 
NULL
;

94 
l_œ°_hódî_Àn
 = 0;

95 *
l_°¨t_vÆue
 = 
NULL
;

96 
l_vÆue_Àn
 = 0;

97 *
l_cur_±r
 = 
NULL
;

98 *
l_±r
 = 
NULL
;

99 
hódî_°©e
 
l_°©e
 = 
ªadög_hódî
;

102 i‡(
a_c⁄n
->
sync
 =
HTTP_TRANS_ASYNC
)

104 i‡(
a_ª•
->
hódî_°©e
 =
hâp_ª•_ªadög_hódî
)

105 
hâp_ª•_ªadög_hódî_jump
;

110 
a_ª•
->
hódî_°©e
 = 
hâp_ª•_ªadög_hódî
;

111 
hâp_ª•_ªadög_hódî_jump
:

113 
l_rv
 = 
	`hâp_å™s_ªad_öto_buf
(
a_c⁄n
);

115 i‡(
l_rv
 =
HTTP_TRANS_ERR
)

117 
a_c⁄n
->
îr°r
 = "FailedÅoÑead httpÑesponseÜine";

118 
l_ªtu∫
 = 
HTTP_TRANS_ERR
;

119 
ec
;

122 
l_°¨t_body
 = 
	`hâp_å™s_buf_has_∑â
(
a_c⁄n
->
io_buf
,

123 
a_c⁄n
->
io_buf_Æloc
,

125 i‡(
l_°¨t_body
 !
NULL
)

126 
l_d⁄e
 = 1;

127 i‡((
l_d⁄e
 =0Ë&& (
a_c⁄n
->
sync
 =
HTTP_TRANS_ASYNC
Ë&& (
l_rv
 =
HTTP_TRANS_NOT_DONE
))

128  
HTTP_TRANS_NOT_DONE
;

132 i‡((!
l_d⁄e
Ë&& (
l_rv
 =
HTTP_TRANS_DONE
Ë&& (
a_c⁄n
->
œ°_ªad
 == 0))

134 
a_c⁄n
->
îr°r
 = "ShortÑead whileÑeading httpÑesponse headers";

135  
HTTP_TRANS_ERR
;

137 } 
l_d⁄e
 == 0);

140 i‡((
a_c⁄n
->
io_buf_Æloc
) < 14)

142 
a_c⁄n
->
îr°r
 = "The httpÑesponseÜine wasÅoo short.";

143 
l_ªtu∫
 = 
HTTP_TRANS_ERR
;

144 
ec
;

146 
l_±r
 = 
a_c⁄n
->
io_buf
;

148 i‡(
	`°∫cmp
(
l_±r
, "HTTP", 4) != 0)

150 
a_c⁄n
->
îr°r
 = "The httpÑesponseÜine didÇot begin with \"HTTP\"";

151 
l_ªtu∫
 = 
HTTP_TRANS_ERR
;

152 
ec
;

154 i‡((
	`isdigô
(
l_±r
[5]) == 0) ||

155 (
l_±r
[6] != '.') ||

156 (
	`isdigô
(
l_±r
[7]) == 0) ||

157 (
l_±r
[8] != ' ') ||

158 (
	`isdigô
(
l_±r
[9]) == 0) ||

159 (
	`isdigô
(
l_±r
[10]) == 0) ||

160 (
	`isdigô
(
l_±r
[11]) == 0) ||

161 (
l_±r
[12] != ' '))

163 
a_c⁄n
->
îr°r
 = "ErrorÖarsing httpÑesponseÜine";

164 
l_ªtu∫
 = 
HTTP_TRANS_ERR
;

165 
ec
;

168 
a_ª•
->
hâp_vî
 = (
l_±r
[5] - 0x30);

169 
a_ª•
->
hâp_vî
 +((
l_±r
[7] - 0x30) / 10.0);

171 
a_ª•
->
°©us_code
 = ((
l_±r
[9] - 0x30)*100);

172 
a_ª•
->
°©us_code
 +((
l_±r
[10] - 0x30)*10);

173 
a_ª•
->
°©us_code
 +(
l_±r
[11] - 0x30);

175 
l_cur_±r
 = &
l_±r
[13];

179 *
l_cur_±r
 != '\r')

180 
l_cur_±r
++;

182 i‡(
a_ª•
->
ªas⁄_phø£
) {

183 
	`‰ì
(
a_ª•
->
ªas⁄_phø£
);

184 
a_ª•
->
ªas⁄_phø£
 = 
NULL
;

187 
a_ª•
->
ªas⁄_phø£
 =

188 
	`mÆloc
((
l_cur_±r
 - (&
l_±r
[13])) + 1);

189 
	`mem£t
(
a_ª•
->
ªas⁄_phø£
, 0,

190 ((
l_cur_±r
 - (&
l_±r
[13])) + 1));

191 
	`mem˝y
(
a_ª•
->
ªas⁄_phø£
,

192 &
l_±r
[13], (
l_cur_±r
 - (&l_ptr[13])));

196 i‡(
l_cur_±r
 =
l_°¨t_body
)

197 
l_d⁄e
 = 1;

199 
l_d⁄e
 = 0;

201 i‡(
a_ª•
->
°©us_code
 == 100)

204 *
l_íd_c⁄töue
 = 
	`hâp_å™s_buf_has_∑â
(
a_c⁄n
->
io_buf
,

205 
a_c⁄n
->
io_buf_Æloc
,

207 i‡(!
l_íd_c⁄töue
)

208  
HTTP_TRANS_ERR
;

209 
	`hâp_å™s_buf_˛ù
(
a_c⁄n
, 
l_íd_c⁄töue
 + 4);

210 
l_°¨t_body
 = 
NULL
;

211 
a_ª•
->
°©us_code
 = 0;

212 
l_d⁄e
 = 0;

213 i‡(
a_c⁄n
->
sync
 =
HTTP_TRANS_ASYNC
)

214  
HTTP_TRANS_NOT_DONE
;

216 
hâp_ª•_ªadög_hódî_jump
;

220 (*
l_cur_±r
 == '\r') ||

221 (*
l_cur_±r
 == '\n'))

222 
l_cur_±r
++;

226 
l_°¨t_hódî
 = 
l_cur_±r
;

227 
l_d⁄e
 == 0)

231 i‡(
l_cur_±r
 =(
l_°¨t_body
 + 1))

234 i‡(
l_°©e
 =
ªadög_hódî
)

239 i‡(
l_hódî_Àn
 == 0)

241 i‡((*
l_cur_±r
 == ' ') || (*l_cur_ptr == '\t'))

244 i‡((
l_œ°_hódî
 =
NULL
Ë|| (
l_œ°_hódî_Àn
 == 0))

246 
a_c⁄n
->
îr°r
 = "The first httpÑesponse header began with whitespace";

247 
l_ªtu∫
 = 
HTTP_TRANS_ERR
;

248 
ec
;

250 
l_cur_±r
++;

252 
l_°©e
 = 
ªadög_£p
;

256 i‡(*
l_cur_±r
 == ':')

259 i‡(
l_hódî_Àn
 == 0)

261 
a_c⁄n
->
îr°r
 = "An httpÑesponse header was zeroÜength";

262 
l_ªtu∫
 = 
HTTP_TRANS_ERR
;

263 
ec
;

266 
l_°©e
 = 
ªadög_£p
;

267 
l_cur_±r
++;

271 i‡(*
l_cur_±r
 == '\r')

273 
a_c⁄n
->
îr°r
 = "FailedÅo find seperator in httpÑesponse headers";

274 
l_ªtu∫
 = 
HTTP_TRANS_ERR
;

275 
ec
;

279 
l_cur_±r
++;

280 
l_hódî_Àn
++;

284 if(
l_°©e
 =
ªadög_£p
)

287 i‡((*
l_cur_±r
 == ' ') || (*l_cur_ptr == '\t'))

288 
l_cur_±r
++;

291 
l_°©e
 = 
ªadög_vÆue
;

292 
l_°¨t_vÆue
 = 
l_cur_±r
;

293 
l_vÆue_Àn
 = 0;

297 if(
l_°©e
 =
ªadög_vÆue
)

301 i‡((*
l_cur_±r
 == '\r') || (*l_cur_ptr == '\n'))

306 i‡(
l_hódî_Àn
 == 0)

308 
	`hâp_hdr_£t_vÆue_no_¡s
(
a_ª•
->
hódîs
,

309 
l_œ°_hódî
,

310 
l_œ°_hódî_Àn
,

311 
l_°¨t_vÆue
,

312 
l_vÆue_Àn
);

316 
	`hâp_hdr_£t_vÆue_no_¡s
(
a_ª•
->
hódîs
,

317 
l_°¨t_hódî
,

318 
l_hódî_Àn
,

319 
l_°¨t_vÆue
,

320 
l_vÆue_Àn
);

325 
l_œ°_hódî
 = 
l_°¨t_hódî
;

326 
l_œ°_hódî_Àn
 = 
l_hódî_Àn
;

329 
l_°©e
 = 
ªadög_eﬁ
;

333 
l_cur_±r
++;

334 
l_vÆue_Àn
++;

338 if(
l_°©e
 =
ªadög_eﬁ
)

341 i‡((*
l_cur_±r
 == '\r') || (*l_cur_ptr == '\n'))

342 
l_cur_±r
++;

346 
l_°©e
 = 
ªadög_hódî
;

347 
l_°¨t_hódî
 = 
l_cur_±r
;

348 
l_hódî_Àn
 = 0;

354 
a_c⁄n
->
îr°r
 = "Unknown state whileÑeading httpÑesponse headers";

355 
l_ªtu∫
 = 
HTTP_TRANS_ERR
;

356 
ec
;

360 
	`hâp_å™s_buf_˛ù
(
a_c⁄n
, 
l_°¨t_body
 + 4);

361 
ec
:

362 
a_ª•
->
hódî_°©e
 = 
hâp_ª•_hódî_°¨t
;

363  
l_ªtu∫
;

364 
	}
}

367 
	$hâp_ª•_ªad_body
(
hâp_ª•
 *
a_ª•
,

368 
hâp_ªq
 *
a_ªq
,

369 
hâp_å™s_c⁄n
 *
a_c⁄n
)

371 
l_ªtu∫
 = 0;

372 *
l_c⁄ã¡_Àngth
 = 
NULL
;

373 *
l_å™s„r_ícodög
 = 
NULL
;

374 *
l_c⁄√˘i⁄
 = 
NULL
;

377 i‡(
a_c⁄n
->
sync
 =
HTTP_TRANS_ASYNC
)

379 i‡(
a_ª•
->
body_°©e
 =
hâp_ª•_body_ªad_c⁄ã¡_Àngth
)

380 
hâp_ª•_body_ªad_c⁄ã¡_Àngth_jump
;

381 i‡(
a_ª•
->
body_°©e
 =
hâp_ª•_body_ªad_chunked
)

382 
hâp_ª•_body_ªad_chunked_jump
;

383 i‡(
a_ª•
->
body_°©e
 =
hâp_ª•_body_ªad_°™d¨d
)

384 
hâp_ª•_body_ªad_°™d¨d_jump
;

387 i‡((!
a_ª•
Ë|| (!
a_c⁄n
))

391 
l_c⁄ã¡_Àngth
 =

392 
	`hâp_hdr_gë_vÆue
(
a_ª•
->
hódîs
,

393 
hâp_hdr_C⁄ã¡_Lígth
);

395 
l_å™s„r_ícodög
 =

396 
	`hâp_hdr_gë_vÆue
(
a_ª•
->
hódîs
,

397 
hâp_hdr_Tøns„r_Encodög
);

399 
l_c⁄√˘i⁄
 =

400 
	`hâp_hdr_gë_vÆue
(
a_ª•
->
hódîs
,

401 
hâp_hdr_C⁄√˘i⁄
);

403 i‡(
l_c⁄ã¡_Àngth
 && (
a_ªq
->
ty≥
 !
hâp_ªq_ty≥_hód
))

405 i‡(
	`°rög_is_numbî
(
l_c⁄ã¡_Àngth
) == 0)

407 
a_c⁄n
->
îr°r
 = "ContentÜength in httpÑesponse wasÇotáÇumber";

410 
a_ª•
->
c⁄ã¡_Àngth
 = 
	`©oi
(
l_c⁄ã¡_Àngth
);

412 
a_ª•
->
body_°©e
 = 
hâp_ª•_body_ªad_c⁄ã¡_Àngth
;

413 
hâp_ª•_body_ªad_c⁄ã¡_Àngth_jump
:

414 
l_ªtu∫
 = 
	`ªad_body_c⁄ã¡_Àngth
(
a_ª•
, 
a_ªq
, 
a_c⁄n
);

416 i‡(
l_c⁄ã¡_Àngth
)

419  
HTTP_TRANS_DONE
;

421 i‡(
l_å™s„r_ícodög
)

424 i‡(!
	`°rˇ£cmp
(
l_å™s„r_ícodög
, "chunked"))

427 
a_ª•
->
body_°©e
 = 
hâp_ª•_body_ªad_chunked
;

428 
hâp_ª•_body_ªad_chunked_jump
:

429 
l_ªtu∫
 = 
	`ªad_body_chunked
(
a_ª•
, 
a_ªq
, 
a_c⁄n
);

434 
a_c⁄n
->
îr°r
 = "UnknownÉncodingÅype in httpÑesponse";

440 
a_ª•
->
body_°©e
 = 
hâp_ª•_body_ªad_°™d¨d
;

442 
hâp_ª•_body_ªad_°™d¨d_jump
:

443 
l_ªtu∫
 = 
	`ªad_body_°™d¨d
(
a_ª•
, 
a_ªq
, 
a_c⁄n
);

445 i‡(
l_ªtu∫
 =
HTTP_TRANS_DONE
)

447 
	`˛o£
(
a_c⁄n
->
sock
);

448 
a_c⁄n
->
sock
 = -1;

452 i‡(
l_c⁄√˘i⁄
 && (
l_ªtu∫
 !
HTTP_TRANS_NOT_DONE
))

454 i‡(!
	`°rˇ£cmp
(
l_c⁄√˘i⁄
, "close"))

456 
	`˛o£
 (
a_c⁄n
->
sock
);

457 
a_c⁄n
->
sock
 = -1;

460 i‡(
l_ªtu∫
 =
HTTP_TRANS_DONE
)

461 
a_ª•
->
body_°©e
 = 
hâp_ª•_body_°¨t
;

462  
l_ªtu∫
;

463 
	}
}

466 
	$°rög_is_numbî
(*
a_°rög
)

468 
i
 = 0;

470 i‡(
	`°æí
(
a_°rög
) < 1)

472 
a_°rög
[
i
])

474 i‡(
	`isdigô
(
a_°rög
[
i
]) == 0)

476 
i
++;

479 
	}
}

482 
	$ªad_chunk
(
hâp_å™s_c⁄n
 *
a_c⁄n
)

484 *
l_íd_chunk_hdr
 = 
NULL
;

485 
l_Àn
 = 0;

486 
i
 = 0;

487 
j
 = 0;

488 *
l_±r
 = 
NULL
;

489 
l_À·_to_ªad
 = 0;

490 
l_rv
 = 0;

492 i‡(
a_c⁄n
->
chunk_Àn
 == 0)

497 i‡((
l_íd_chunk_hdr
 =

498 
	`hâp_å™s_buf_has_∑â
(
a_c⁄n
->
io_buf
,á_c⁄n->
io_buf_Æloc
,

499 "\r\n", 2)Ë=
NULL
)

501 
l_rv
 = 
	`hâp_å™s_ªad_öto_buf
(
a_c⁄n
);

502 i‡(
l_rv
 =
HTTP_TRANS_ERR
)

503  
HTTP_TRANS_ERR
;

505 i‡((
l_rv
 =
HTTP_TRANS_DONE
Ë&& (
a_c⁄n
->
œ°_ªad
 == 0))

506  
HTTP_TRANS_ERR
;

507 i‡((
a_c⁄n
->
sync
 =
HTTP_TRANS_ASYNC
Ë&& (
l_rv
 =
HTTP_TRANS_NOT_DONE
))

508  
HTTP_TRANS_NOT_DONE
;

510 } 
l_íd_chunk_hdr
 =
NULL
);

512 
l_±r
 = 
a_c⁄n
->
io_buf
;

514 (
l_±r
 < 
l_íd_chunk_hdr
) &&

515 (((
	`tﬁowî
(*
l_±r
) <= 'f') && (tolower(*l_ptr) >= 'a')) ||

516 ((*
l_±r
 <= '9') && (*l_ptr >= '0'))))

517 
l_±r
++;

519 
l_Àn
 = 
l_±r
 - 
a_c⁄n
->
io_buf
;

520 i‡(
l_Àn
 == 0)

522 
a_c⁄n
->
chunk_Àn
 = -1;

523  
HTTP_TRANS_ERR
;

526 
i
=0, 
j
=
l_Àn
-1; i <Ü_len; i++, j--)

528 i‡((
	`tﬁowî
(
a_c⁄n
->
io_buf
[
i
]) <= 'f') && (tolower(a_conn->io_buf[i]) >= 'a'))

529 
a_c⁄n
->
chunk_Àn
 +(
	`tﬁowî
◊_c⁄n->
io_buf
[
i
]Ë- 0x57Ë<< (4*
j
);

531 
a_c⁄n
->
chunk_Àn
 +(
	`tﬁowî
◊_c⁄n->
io_buf
[
i
]Ë- 0x30Ë<< (4*
j
);

534 
	`hâp_å™s_buf_˛ù
(
a_c⁄n
, 
l_íd_chunk_hdr
 + 2);

537 i‡(
a_c⁄n
->
chunk_Àn
 != 0)

541 
l_À·_to_ªad
 = 
a_c⁄n
->
chunk_Àn
 -á_c⁄n->
io_buf_Æloc
 + 2;

543 i‡(
l_À·_to_ªad
 > 0)

546 
a_c⁄n
->
io_buf_io_À·
 = 
l_À·_to_ªad
;

547 
a_c⁄n
->
io_buf_io_d⁄e
 = 0;

550 
l_rv
 = 
	`hâp_å™s_ªad_öto_buf
(
a_c⁄n
);

551 i‡(
l_rv
 =
HTTP_TRANS_ERR
)

552  
HTTP_TRANS_ERR
;

554 i‡((
l_rv
 =
HTTP_TRANS_DONE
Ë&& (
a_c⁄n
->
œ°_ªad
 == 0))

555  
HTTP_TRANS_ERR
;

556 i‡((
a_c⁄n
->
sync
 =
HTTP_TRANS_ASYNC
Ë&& (
l_rv
 =
HTTP_TRANS_NOT_DONE
))

557  
HTTP_TRANS_NOT_DONE
;

558 } 
l_rv
 =
HTTP_TRANS_NOT_DONE
);

561 i‡(
a_c⁄n
->
io_buf_Æloc
 >a_c⁄n->
chunk_Àn
 + 2)

562  
HTTP_TRANS_DONE
;

564 i‡(
a_c⁄n
->
chunk_Àn
 == 0)

565  
HTTP_TRANS_DONE
;

566  
HTTP_TRANS_ERR
;

567 
	}
}

570 
	$ªad_body_chunked
(
hâp_ª•
 *
a_ª•
,

571 
hâp_ªq
 *
a_ªq
,

572 
hâp_å™s_c⁄n
 *
a_c⁄n
)

574 
l_rv
 = 0;

575 
l_d⁄e
 = 0;

580 
l_rv
 = 
	`ªad_chunk
(
a_c⁄n
);

581 i‡(
l_rv
 =
HTTP_TRANS_ERR
)

582  
HTTP_TRANS_ERR
;

583 i‡((
a_c⁄n
->
sync
 =
HTTP_TRANS_ASYNC
Ë&& (
l_rv
 =
HTTP_TRANS_NOT_DONE
))

584  
HTTP_TRANS_NOT_DONE
;

586 i‡(
a_c⁄n
->
chunk_Àn
 > 0)

588 i‡(
a_ª•
->
body
 =
NULL
)

590 
a_ª•
->
body
 = 
	`mÆloc
(
a_c⁄n
->
chunk_Àn
);

591 
	`mem˝y
(
a_ª•
->
body
, 
a_c⁄n
->
io_buf
,á_c⁄n->
chunk_Àn
);

592 
a_ª•
->
body_Àn
 = 
a_c⁄n
->
chunk_Àn
;

597 
a_ª•
->
body
 = 
	`ªÆloc
(a_resp->body,

598 (
a_ª•
->
body_Àn
 + 
a_c⁄n
->
chunk_Àn
));

599 
	`mem˝y
(&
a_ª•
->
body
[a_ª•->
body_Àn
], 
a_c⁄n
->
io_buf
,á_c⁄n->
chunk_Àn
);

600 
a_ª•
->
body_Àn
 +
a_c⁄n
->
chunk_Àn
;

606 i‡((
a_c⁄n
->
chunk_Àn
 =0Ë&& (a_c⁄n->
io_buf_Æloc
 < 2))

608 
a_c⁄n
->
io_buf_io_À·
 = ( 2 -á_c⁄n->
io_buf_Æloc
 );

609 
a_c⁄n
->
io_buf_io_d⁄e
 = 0;

611 
l_rv
 = 
	`hâp_å™s_ªad_öto_buf
(
a_c⁄n
);

612 } 
l_rv
 =
HTTP_TRANS_NOT_DONE
);

614 i‡(
l_rv
 =
HTTP_TRANS_ERR
)

615  
HTTP_TRANS_ERR
;

617 i‡(
a_c⁄n
->
chunk_Àn
 == 0)

618 
l_d⁄e
 = 1;

622 
	`hâp_å™s_buf_˛ù
(
a_c⁄n
, &a_c⁄n->
io_buf
[a_c⁄n->
chunk_Àn
 + 2]);

624 
a_c⁄n
->
chunk_Àn
 = 0;

625 } 
l_d⁄e
 == 0);

626  
HTTP_TRANS_DONE
;

627 
	}
}

630 
	$Êush_ª•⁄£_body
(
hâp_ª•
 *
a_ª•
,

631 
hâp_å™s_c⁄n
 *
a_c⁄n
)

633 i‡(
a_ª•
->
body
 !
NULL
) {

634 
	`‰ì
(
a_ª•
->
body
);

636 
a_ª•
->
Êushed_Àngth
 +a_ª•->
body_Àn
;

637 
a_ª•
->
body_Àn
 = 
a_c⁄n
->
io_buf_Æloc
;

638 
a_ª•
->
body
 = 
	`mÆloc
(
a_c⁄n
->
io_buf_Æloc
 + 1);

639 
	`mem£t
(
a_ª•
->
body
, 0, 
a_c⁄n
->
io_buf_Æloc
 + 1);

640 
	`mem˝y
(
a_ª•
->
body
, 
a_c⁄n
->
io_buf
,á_c⁄n->
io_buf_Æloc
);

642 
	`hâp_å™s_buf_ª£t
(
a_c⁄n
);

643 
	}
}

646 
	$hâp_ª•_Êush
(
hâp_ª•
 *
a_ª•
,

647 
hâp_å™s_c⁄n
 *
a_c⁄n
)

649 
	`Êush_ª•⁄£_body
(
a_ª•
, 
a_c⁄n
);

650 
	}
}

653 
	$ªad_body_c⁄ã¡_Àngth
(
hâp_ª•
 *
a_ª•
,

654 
hâp_ªq
 *
a_ªq
,

655 
hâp_å™s_c⁄n
 *
a_c⁄n
)

657 
l_Àn
 = 0;

658 
l_À·_to_ªad
 = 0;

659 
l_rv
 = 0;

661 
l_Àn
 = 
a_ª•
->
c⁄ã¡_Àngth
;

662 i‡(
l_Àn
 == 0)

663  
HTTP_TRANS_DONE
;

666 
l_À·_to_ªad
 = 
l_Àn
 - 
a_c⁄n
->
io_buf_Æloc
 - 
a_ª•
->
Êushed_Àngth
 -á_ª•->
body_Àn
;

668 
a_c⁄n
->
io_buf_io_À·
 = 
l_À·_to_ªad
;

669 
a_c⁄n
->
io_buf_io_d⁄e
 = 0;

670 i‡(
l_À·_to_ªad
 > 0)

675 
l_rv
 = 
	`hâp_å™s_ªad_öto_buf
(
a_c⁄n
);

676 i‡((
l_rv
 =
HTTP_TRANS_NOT_DONE
) &&

677 (
a_c⁄n
->
sync
 =
HTTP_TRANS_ASYNC
))

678  
HTTP_TRANS_NOT_DONE
;

679 i‡((
l_rv
 =
HTTP_TRANS_DONE
Ë&& (
a_c⁄n
->
œ°_ªad
 == 0))

680  
HTTP_TRANS_ERR
;

681 } 
l_rv
 =
HTTP_TRANS_NOT_DONE
);

682 i‡(
l_rv
 =
HTTP_TRANS_ERR
)

683  
HTTP_TRANS_ERR
;

686 
	`Êush_ª•⁄£_body
 (
a_ª•
, 
a_c⁄n
);

687  
HTTP_TRANS_DONE
;

688 
	}
}

691 
	$ªad_body_°™d¨d
(
hâp_ª•
 *
a_ª•
,

692 
hâp_ªq
 *
a_ªq
,

693 
hâp_å™s_c⁄n
 *
a_c⁄n
)

695 
l_rv
 = 0;

698 
l_rv
 = 
	`hâp_å™s_ªad_öto_buf
(
a_c⁄n
);

699 i‡(
a_c⁄n
->
sync
 =
HTTP_TRANS_ASYNC
)

701 i‡((
l_rv
 =
HTTP_TRANS_NOT_DONE
Ë|| (
a_c⁄n
->
œ°_ªad
 != 0))

702  
HTTP_TRANS_NOT_DONE
;

704 } (
l_rv
 =
HTTP_TRANS_NOT_DONE
Ë|| (
a_c⁄n
->
œ°_ªad
 > 0));

706 i‡(
l_rv
 =
HTTP_TRANS_ERR
)

707  
HTTP_TRANS_ERR
;

709 
	`Êush_ª•⁄£_body
(
a_ª•
, 
a_c⁄n
);

710  
HTTP_TRANS_DONE
;

711 
	}
}

	@src/liblwqq/libghttp/http_resp.h

22 #i‚de‡
HTTP_RESP_H


23 
	#HTTP_RESP_H


	)

25 
	~"hâp_hdrs.h
"

26 
	~"hâp_å™s.h
"

27 
	~"hâp_ªq.h
"

29 
	#HTTP_RESP_INFORMATIONAL
(
x
Ë(x >=100 && < 200)

	)

30 
	#HTTP_RESP_SUCCESS
(
x
Ë(x >200 && x < 300)

	)

31 
	#HTTP_RESP_REDIR
(
x
Ë(x >300 && x < 400)

	)

32 
	#HTTP_RESP_CLIENT_ERR
(
x
Ë(x >400 && x < 500)

	)

33 
	#HTTP_RESP_SERVER_ERR
(
x
Ë(x >500 && x < 600)

	)

35 
	ehâp_ª•_hódî_°©e_èg


37 
	mhâp_ª•_hódî_°¨t
 = 0,

38 
	mhâp_ª•_ªadög_hódî


39 } 
	thâp_ª•_hódî_°©e
;

41 
	ehâp_ª•_body_°©e_èg


43 
	mhâp_ª•_body_°¨t
 = 0,

44 
	mhâp_ª•_body_ªad_c⁄ã¡_Àngth
,

45 
	mhâp_ª•_body_ªad_chunked
,

46 
	mhâp_ª•_body_ªad_°™d¨d


47 } 
	thâp_ª•_body_°©e
;

51 
	shâp_ª•_èg


53 
	mhâp_vî
;

54 
	m°©us_code
;

55 *
	mªas⁄_phø£
;

56 
hâp_hdr_li°
 *
	mhódîs
;

57 *
	mbody
;

58 
	mbody_Àn
;

59 
	mc⁄ã¡_Àngth
;

60 
	mÊushed_Àngth
;

61 
hâp_ª•_hódî_°©e
 
	mhódî_°©e
;

62 
hâp_ª•_body_°©e
 
	mbody_°©e
;

63 } 
	thâp_ª•
;

65 
hâp_ª•
 *

66 
hâp_ª•_√w
();

69 
hâp_ª•_de°roy
(
hâp_ª•
 *
a_ª•
);

72 
hâp_ª•_ªad_body
(
hâp_ª•
 *
a_ª•
,

73 
hâp_ªq
 *
a_ªq
,

74 
hâp_å™s_c⁄n
 *
a_c⁄n
);

77 
hâp_ª•_ªad_hódîs
(
hâp_ª•
 *
a_ª•
, 
hâp_å™s_c⁄n
 *
a_c⁄n
);

80 
hâp_ª•_Êush
(
hâp_ª•
 *
a_ª•
,

81 
hâp_å™s_c⁄n
 *
a_c⁄n
);

	@src/liblwqq/libghttp/http_trans.c

23 
	~<sys/time.h
>

24 
	~<sys/ty≥s.h
>

25 
	~<uni°d.h
>

26 
	~<°dlib.h
>

27 
	~<°rög.h
>

28 
	~<î∫o.h
>

29 
	~"hâp_å™s.h
"

30 
	~"hâp_globÆ.h
"

33 
hâp_å™s_buf_‰ì
(
hâp_å™s_c⁄n
 *
a_c⁄n
);

36 
	$hâp_å™s_c⁄√˘
(
hâp_å™s_c⁄n
 *
a_c⁄n
)

38 i‡((
a_c⁄n
 =
NULL
Ë|| (a_c⁄n->
ho°
 == NULL))

39 
ec
;

40 i‡(
a_c⁄n
->
ho°öfo
 =
NULL
)

43 i‡(
a_c⁄n
->
¥oxy_ho°
)

45 i‡((
a_c⁄n
->
ho°öfo
 = 
	`gëho°by«me
◊_c⁄n->
¥oxy_ho°
)Ë=
NULL
)

47 
a_c⁄n
->
îr‹_ty≥
 = 
hâp_å™s_îr_ty≥_ho°
;

48 
a_c⁄n
->
îr‹
 = 
h_î∫o
;

49 
ec
;

55 i‡((
a_c⁄n
->
ho°öfo
 = 
	`gëho°by«me
◊_c⁄n->
ho°
)Ë=
NULL
)

57 
a_c⁄n
->
îr‹_ty≥
 = 
hâp_å™s_îr_ty≥_ho°
;

58 
a_c⁄n
->
îr‹
 = 
h_î∫o
;

59 
ec
;

63 
a_c⁄n
->
ßddr
.
sö_Ámûy
 = 
AF_INET
;

65 i‡(
a_c⁄n
->
¥oxy_ho°
)

66 
a_c⁄n
->
ßddr
.
sö_p‹t
 = 
	`ht⁄s
◊_c⁄n->
¥oxy_p‹t
);

68 
a_c⁄n
->
ßddr
.
sö_p‹t
 = 
	`ht⁄s
◊_c⁄n->
p‹t
);

70 
	`mem˝y
(&
a_c⁄n
->
ßddr
.
sö_addr
.
s_addr
,

71 
a_c⁄n
->
ho°öfo
->
h_addr_li°
[0],

75 i‡((
a_c⁄n
->
sock
 = 
	`sockë
(
AF_INET
, 
SOCK_STREAM
, 0)) < 0)

77 
a_c⁄n
->
îr‹_ty≥
 = 
hâp_å™s_îr_ty≥_î∫o
;

78 
a_c⁄n
->
îr‹
 = 
î∫o
;

79 
ec
;

82 i‡(
	`c⁄√˘
(
a_c⁄n
->
sock
,

83 (
sockaddr
 *)&
a_c⁄n
->
ßddr
,

84 (
sockaddr
)) < 0)

86 
a_c⁄n
->
îr‹_ty≥
 = 
hâp_å™s_îr_ty≥_î∫o
;

87 
a_c⁄n
->
îr‹
 = 
î∫o
;

88 
ec
;

92 
ec
:

94 
	}
}

96 
hâp_å™s_c⁄n
 *

97 
	$hâp_å™s_c⁄n_√w
()

99 
hâp_å™s_c⁄n
 *
l_ªtu∫
 = 
NULL
;

102 
l_ªtu∫
 = (
hâp_å™s_c⁄n
 *)
	`mÆloc
((http_trans_conn));

103 
	`mem£t
(
l_ªtu∫
, 0, (
hâp_å™s_c⁄n
));

105 
l_ªtu∫
->
p‹t
 = 80;

107 
l_ªtu∫
->
io_buf_chunksize
 = 1024;

109 
l_ªtu∫
->
io_buf
 = 
	`mÆloc
÷_ªtu∫->
io_buf_chunksize
);

110 
	`mem£t
(
l_ªtu∫
->
io_buf
, 0,Ü_ªtu∫->
io_buf_chunksize
);

111 
l_ªtu∫
->
io_buf_Àn
 =Ü_ªtu∫->
io_buf_chunksize
;

113 
l_ªtu∫
->
sock
 = -1;

114  
l_ªtu∫
;

115 
	}
}

118 
	$hâp_å™s_c⁄n_de°roy
(
hâp_å™s_c⁄n
 *
a_c⁄n
)

121 i‡(
a_c⁄n
 =
NULL
)

123 i‡(
a_c⁄n
->
io_buf
)

124 
	`‰ì
(
a_c⁄n
->
io_buf
);

125 i‡(
a_c⁄n
->
sock
 != -1)

126 
	`˛o£
(
a_c⁄n
->
sock
);

127 
	`‰ì
(
a_c⁄n
);

129 
	}
}

132 
	$hâp_å™s_gë_ho°_îr‹
(
a_hîr‹
)

134 
a_hîr‹
)

136 
HOST_NOT_FOUND
:

138 
NO_ADDRESS
:

140 
NO_RECOVERY
:

142 
TRY_AGAIN
:

147 
	}
}

150 
	$hâp_å™s_≠≥nd_d©a_to_buf
(
hâp_å™s_c⁄n
 *
a_c⁄n
,

151 *
a_d©a
,

152 
a_d©a_Àn
)

154 i‡(
	`hâp_å™s_buf_‰ì
(
a_c⁄n
Ë< 
a_d©a_Àn
)

156 
a_c⁄n
->
io_buf
 = 
	`ªÆloc
◊_c⁄n->io_buf,á_c⁄n->
io_buf_Àn
 + 
a_d©a_Àn
);

157 
a_c⁄n
->
io_buf_Àn
 +
a_d©a_Àn
;

159 
	`mem˝y
(&
a_c⁄n
->
io_buf
[a_c⁄n->
io_buf_Æloc
], 
a_d©a
, 
a_d©a_Àn
);

160 
a_c⁄n
->
io_buf_Æloc
 +
a_d©a_Àn
;

162 
	}
}

165 
	$hâp_å™s_ªad_öto_buf
(
hâp_å™s_c⁄n
 *
a_c⁄n
)

167 
l_ªad
 = 0;

168 
l_byãs_to_ªad
 = 0;

171 i‡(
a_c⁄n
->
io_buf_io_À·
 == 0)

173 
a_c⁄n
->
io_buf_io_À·
 =á_c⁄n->
io_buf_chunksize
;

174 
a_c⁄n
->
io_buf_io_d⁄e
 = 0;

177 i‡(
	`hâp_å™s_buf_‰ì
(
a_c⁄n
Ë<á_c⁄n->
io_buf_io_À·
)

179 
a_c⁄n
->
io_buf
 = 
	`ªÆloc
(a_conn->io_buf,

180 
a_c⁄n
->
io_buf_Àn
 +á_c⁄n->
io_buf_io_À·
);

181 
a_c⁄n
->
io_buf_Àn
 +a_c⁄n->
io_buf_io_À·
;

184 i‡(
a_c⁄n
->
io_buf_io_À·
 >á_c⁄n->
io_buf_chunksize
)

185 
l_byãs_to_ªad
 = 
a_c⁄n
->
io_buf_chunksize
;

187 
l_byãs_to_ªad
 = 
a_c⁄n
->
io_buf_io_À·
;

189 i‡((
a_c⁄n
->
œ°_ªad
 = 
l_ªad
 = 
	`ªad
◊_c⁄n->
sock
,

190 &
a_c⁄n
->
io_buf
[a_c⁄n->
io_buf_Æloc
],

191 
l_byãs_to_ªad
)) < 0)

193 i‡(
î∫o
 =
EINTR
)

194 
l_ªad
 = 0;

196  
HTTP_TRANS_ERR
;

198 i‡(
l_ªad
 == 0)

199  
HTTP_TRANS_DONE
;

201 
a_c⁄n
->
io_buf_io_À·
 -
l_ªad
;

202 
a_c⁄n
->
io_buf_io_d⁄e
 +
l_ªad
;

203 
a_c⁄n
->
io_buf_Æloc
 +
l_ªad
;

205 i‡(
a_c⁄n
->
io_buf_io_À·
 == 0)

206  
HTTP_TRANS_DONE
;

207  
HTTP_TRANS_NOT_DONE
;

208 
	}
}

211 
	$hâp_å™s_wrôe_buf
(
hâp_å™s_c⁄n
 *
a_c⁄n
)

213 
l_wrôãn
 = 0;

215 i‡(
a_c⁄n
->
io_buf_io_À·
 == 0)

217 
a_c⁄n
->
io_buf_io_À·
 =á_c⁄n->
io_buf_Æloc
;

218 
a_c⁄n
->
io_buf_io_d⁄e
 = 0;

221 i‡((
a_c⁄n
->
œ°_ªad
 = 
l_wrôãn
 = 
	`wrôe
 (a_c⁄n->
sock
,

222 &
a_c⁄n
->
io_buf
[a_c⁄n->
io_buf_io_d⁄e
],

223 
a_c⁄n
->
io_buf_io_À·
)) <= 0)

225 i‡(
î∫o
 =
EINTR
)

226 
l_wrôãn
 = 0;

228  
HTTP_TRANS_ERR
;

230 i‡(
l_wrôãn
 == 0)

231  
HTTP_TRANS_DONE
;

233 
a_c⁄n
->
io_buf_io_À·
 -
l_wrôãn
;

234 
a_c⁄n
->
io_buf_io_d⁄e
 +
l_wrôãn
;

235 i‡(
a_c⁄n
->
io_buf_io_À·
 == 0)

236  
HTTP_TRANS_DONE
;

237  
HTTP_TRANS_NOT_DONE
;

238 
	}
}

241 
	$hâp_å™s_buf_ª£t
(
hâp_å™s_c⁄n
 *
a_c⁄n
)

243 i‡(
a_c⁄n
->
io_buf
)

244 
	`‰ì
(
a_c⁄n
->
io_buf
);

245 
a_c⁄n
->
io_buf
 = 
	`mÆloc
◊_c⁄n->
io_buf_chunksize
);

246 
	`mem£t
(
a_c⁄n
->
io_buf
, 0,á_c⁄n->
io_buf_chunksize
);

247 
a_c⁄n
->
io_buf_Àn
 =á_c⁄n->
io_buf_chunksize
;

248 
a_c⁄n
->
io_buf_Æloc
 = 0;

249 
a_c⁄n
->
io_buf_io_d⁄e
 = 0;

250 
a_c⁄n
->
io_buf_io_À·
 = 0;

251 
	}
}

254 
	$hâp_å™s_buf_˛ù
(
hâp_å™s_c⁄n
 *
a_c⁄n
, *
a_˛ù_to
)

256 
l_byãs
 = 0;

259 
l_byãs
 = 
a_˛ù_to
 - 
a_c⁄n
->
io_buf
;

260 i‡(
l_byãs
 > 0)

262 
	`memmove
(
a_c⁄n
->
io_buf
, 
a_˛ù_to
,á_c⁄n->
io_buf_Æloc
 - 
l_byãs
);

263 
a_c⁄n
->
io_buf_Æloc
 -
l_byãs
;

265 
a_c⁄n
->
io_buf_io_d⁄e
 = 0;

266 
a_c⁄n
->
io_buf_io_À·
 = 0;

267 
	}
}

270 
	$hâp_å™s_buf_has_∑â
(*
a_buf
, 
a_Àn
,

271 *
a_∑t
, 
a_∑éí
)

273 
i
 = 0;

274  ; 
i
 <–
a_Àn
 - 
a_∑éí
 ); i++ )

276 i‡(
a_buf
[
i
] =
a_∑t
[0])

278 i‡(
	`memcmp
(&
a_buf
[
i
], 
a_∑t
, 
a_∑éí
) == 0)

279  &
a_buf
[
i
];

282  
NULL
;

283 
	}
}

288 
	$hâp_å™s_buf_‰ì
(
hâp_å™s_c⁄n
 *
a_c⁄n
)

290  (
a_c⁄n
->
io_buf_Àn
 -á_c⁄n->
io_buf_Æloc
);

291 
	}
}

	@src/liblwqq/libghttp/http_trans.h

22 #i‚de‡
HTTP_TRANS_H


23 
	#HTTP_TRANS_H


	)

25 
	~<sys/ty≥s.h
>

26 
	~<sys/sockë.h
>

27 
	~<√töë/ö.h
>

28 
	~<√tdb.h
>

30 
	ehâp_å™s_îr_ty≥_èg
 {

31 
	mhâp_å™s_îr_ty≥_ho°
 = 0,

32 
	mhâp_å™s_îr_ty≥_î∫o


33 } 
	thâp_å™s_îr_ty≥
;

35 
	shâp_å™s_c⁄n_èg
 {

36 
ho°ít
 *
	mho°öfo
;

37 
sockaddr_ö
 
	mßddr
;

38 *
	mho°
;

39 *
	m¥oxy_ho°
;

40 
	msock
;

41 
	mp‹t
;

42 
	m¥oxy_p‹t
;

43 
hâp_å™s_îr_ty≥
 
	mîr‹_ty≥
;

44 
	mîr‹
;

45 
	msync
;

46 *
	mio_buf
;

47 
	mio_buf_Àn
;

48 
	mio_buf_Æloc
;

49 
	mio_buf_io_d⁄e
;

50 
	mio_buf_io_À·
;

51 
	mio_buf_chunksize
;

53 
	mœ°_ªad
;

54 
	mchunk_Àn
;

55 *
	mîr°r
;

56 } 
	thâp_å™s_c⁄n
;

58 
hâp_å™s_c⁄n
 *

59 
hâp_å™s_c⁄n_√w
();

62 
hâp_å™s_c⁄n_de°roy
(
hâp_å™s_c⁄n
 *
a_c⁄n
);

65 
hâp_å™s_buf_ª£t
(
hâp_å™s_c⁄n
 *
a_c⁄n
);

68 
hâp_å™s_buf_˛ù
(
hâp_å™s_c⁄n
 *
a_c⁄n
, *
a_˛ù_to
);

71 
hâp_å™s_c⁄√˘
(
hâp_å™s_c⁄n
 *
a_c⁄n
);

74 
hâp_å™s_gë_ho°_îr‹
(
a_hîr‹
);

77 
hâp_å™s_≠≥nd_d©a_to_buf
(
hâp_å™s_c⁄n
 *
a_c⁄n
,

78 *
a_d©a
,

79 
a_d©a_Àn
);

82 
hâp_å™s_ªad_öto_buf
(
hâp_å™s_c⁄n
 *
a_c⁄n
);

85 
hâp_å™s_wrôe_buf
(
hâp_å™s_c⁄n
 *
a_c⁄n
);

88 
hâp_å™s_buf_has_∑â
(*
a_buf
, 
a_Àn
,

89 *
a_∑t
, 
a_∑éí
);

	@src/liblwqq/libghttp/http_uri.c

22 
	~<°rög.h
>

23 
	~<°dlib.h
>

24 
	~<˘y≥.h
>

25 
	~"hâp_uri.h
"

27 
	euri_∑r£_°©e_èg


29 
	m∑r£_°©e_ªad_ho°
 = 0,

30 
	m∑r£_°©e_ªad_p‹t
,

31 
	m∑r£_°©e_ªad_ªsour˚


32 } 
	turi_∑r£_°©e
;

36 
	$hâp_uri_∑r£
(*
a_°rög
,

37 
hâp_uri
 *
a_uri
)

40 
uri_∑r£_°©e
 
l_°©e
 = 
∑r£_°©e_ªad_ho°
;

41 *
l_°¨t_°rög
 = 
NULL
;

42 *
l_íd_°rög
 = 
NULL
;

43 
l_ãmp_p‹t
[6];

46 
	`mem£t
(
l_ãmp_p‹t
, 0, 6);

48 i‡(
a_°rög
 =
NULL
)

49 
ec
;

50 i‡(
a_uri
) {

51 
a_uri
->
fuŒ
 = 
	`°rdup
(
a_°rög
);

53 
l_°¨t_°rög
 = 
	`°rchr
(
a_°rög
, ':');

55 i‡(!
l_°¨t_°rög
)

56 
ec
;

57 i‡(
a_uri
) {

58 
a_uri
->
¥Ÿo
 = (*)
	`mÆloc
(
l_°¨t_°rög
 - 
a_°rög
 + 1);

59 
	`mem˝y
(
a_uri
->
¥Ÿo
, 
a_°rög
, (
l_°¨t_°rög
 -á_string));

60 
a_uri
->
¥Ÿo
[
l_°¨t_°rög
 - 
a_°rög
] = '\0';

63 i‡(
	`°∫cmp
(
l_°¨t_°rög
, "://", 3) != 0)

64 
ec
;

66 
l_°¨t_°rög
 = 
l_íd_°rög
 = &l_start_string[3];

67 *
l_íd_°rög
)

69 i‡(
l_°©e
 =
∑r£_°©e_ªad_ho°
)

71 i‡(*
l_íd_°rög
 == ':')

73 
l_°©e
 = 
∑r£_°©e_ªad_p‹t
;

74 i‡((
l_íd_°rög
 - 
l_°¨t_°rög
) == 0)

75 
ec
;

77 i‡((
l_íd_°rög
 - 
l_°¨t_°rög
) == 0)

78 
ec
;

80 i‡(
a_uri
)

82 
a_uri
->
ho°
 = (*)
	`mÆloc
(
l_íd_°rög
 - 
l_°¨t_°rög
 + 1);

84 
	`mem˝y
(
a_uri
->
ho°
, 
l_°¨t_°rög
, (
l_íd_°rög
 -Ü_start_string));

86 
a_uri
->
ho°
[
l_íd_°rög
 - 
l_°¨t_°rög
] = '\0';

89 
l_íd_°rög
++;

90 
l_°¨t_°rög
 = 
l_íd_°rög
;

93 i‡(*
l_íd_°rög
 == '/')

95 
l_°©e
 = 
∑r£_°©e_ªad_ªsour˚
;

96 i‡((
l_íd_°rög
 - 
l_°¨t_°rög
) == 0)

97 
ec
;

98 i‡(
a_uri
)

100 
a_uri
->
ho°
 = (*)
	`mÆloc
(
l_íd_°rög
 - 
l_°¨t_°rög
 + 1);

101 
	`mem˝y
(
a_uri
->
ho°
, 
l_°¨t_°rög
, (
l_íd_°rög
 -Ü_start_string));

102 
a_uri
->
ho°
[
l_íd_°rög
 - 
l_°¨t_°rög
] = '\0';

104 
l_°¨t_°rög
 = 
l_íd_°rög
;

108 i‡(
l_°©e
 =
∑r£_°©e_ªad_p‹t
)

110 i‡(*
l_íd_°rög
 == '/')

112 
l_°©e
 = 
∑r£_°©e_ªad_ªsour˚
;

114 i‡(
l_íd_°rög
 - 
l_°¨t_°rög
 > 5)

115 
ec
;

117 i‡((
l_íd_°rög
 - 
l_°¨t_°rög
) == 0)

118 
ec
;

120 
	`mem˝y
(
l_ãmp_p‹t
, 
l_°¨t_°rög
, 
l_íd_°rög
 -Ü_start_string);

122 i‡(
a_uri
)

123 
a_uri
->
p‹t
 = 
	`©oi
(
l_ãmp_p‹t
);

124 
l_°¨t_°rög
 = 
l_íd_°rög
;

127 i‡(
	`isdigô
(*
l_íd_°rög
) == 0)

130 
ec
;

134 
l_íd_°rög
++;

138 i‡(
l_°©e
 =
∑r£_°©e_ªad_ho°
)

140 i‡((
l_íd_°rög
 - 
l_°¨t_°rög
) == 0)

141 
ec
;

142 i‡(
a_uri
)

144 
a_uri
->
ho°
 = (*)
	`mÆloc
(
l_íd_°rög
 - 
l_°¨t_°rög
 + 1);

145 
	`mem˝y
(
a_uri
->
ho°
, 
l_°¨t_°rög
, (
l_íd_°rög
 -Ü_start_string));

146 
a_uri
->
ho°
[
l_íd_°rög
 - 
l_°¨t_°rög
] = '\0';

148 
a_uri
->
ªsour˚
 = 
	`°rdup
("/");

151 i‡(
l_°©e
 =
∑r£_°©e_ªad_p‹t
)

153 i‡(
	`°æí
(
l_°¨t_°rög
) == 0)

155 
ec
;

156 i‡(
a_uri
)

158 
a_uri
->
p‹t
 = 
	`©oi
(
l_°¨t_°rög
);

159 
a_uri
->
ªsour˚
 = 
	`°rdup
("/");

162 i‡(
l_°©e
 =
∑r£_°©e_ªad_ªsour˚
)

164 i‡(
	`°æí
(
l_°¨t_°rög
) == 0)

166 i‡(
a_uri
)

167 
a_uri
->
ªsour˚
 = 
	`°rdup
("/");

171 i‡(
a_uri
)

172 
a_uri
->
ªsour˚
 = 
	`°rdup
(
l_°¨t_°rög
);

178 
ec
;

182 
ec
:

184 
	}
}

186 
hâp_uri
 *

187 
	$hâp_uri_√w
()

189 
hâp_uri
 *
l_ªtu∫
 = 
NULL
;

191 
l_ªtu∫
 = (
hâp_uri
 *)
	`mÆloc
((http_uri));

192 
l_ªtu∫
->
fuŒ
 = 
NULL
;

193 
l_ªtu∫
->
¥Ÿo
 = 
NULL
;

194 
l_ªtu∫
->
ho°
 = 
NULL
;

195 
l_ªtu∫
->
p‹t
 = 80;

196 
l_ªtu∫
->
ªsour˚
 = 
NULL
;

197  
l_ªtu∫
;

198 
	}
}

201 
	$hâp_uri_de°roy
(
hâp_uri
 *
a_uri
)

203 i‡(
a_uri
->
fuŒ
) {

204 
	`‰ì
(
a_uri
->
fuŒ
);

205 
a_uri
->
fuŒ
 = 
NULL
;

207 i‡(
a_uri
->
¥Ÿo
) {

208 
	`‰ì
(
a_uri
->
¥Ÿo
);

209 
a_uri
->
¥Ÿo
 = 
NULL
;

211 i‡(
a_uri
->
ho°
) {

212 
	`‰ì
(
a_uri
->
ho°
);

213 
a_uri
->
ho°
 = 
NULL
;

215 i‡(
a_uri
->
ªsour˚
) {

216 
	`‰ì
(
a_uri
->
ªsour˚
);

217 
a_uri
->
ªsour˚
 = 
NULL
;

219 
	`‰ì
(
a_uri
);

220 
	}
}

	@src/liblwqq/libghttp/http_uri.h

22 #i‚de‡
HTTP_URI_H


23 
	#HTTP_URI_H


	)

27 
	shâp_uri_èg


29 *
	mfuŒ
;

30 *
	m¥Ÿo
;

31 *
	mho°
;

32 
	mp‹t
;

33 *
	mªsour˚
;

34 } 
	thâp_uri
;

36 
hâp_uri
 *

37 
hâp_uri_√w
();

40 
hâp_uri_de°roy
(
hâp_uri
 *
a_uri
);

43 
hâp_uri_∑r£
(*
a_uri
,

44 
hâp_uri
 *
a_ªque°
);

	@src/liblwqq/logger.c

11 
	~<°d¨g.h
>

12 
	~<°dio.h
>

13 
	~<time.h
>

14 
	~<°rög.h
>

15 
	~<sys/ty≥s.h
>

16 
	~<uni°d.h
>

17 
	~"loggî.h
"

19 *
	gÀvñs
[] = {

35 
	$lwqq_log
(
Àvñ
, c⁄° *
fûe
, 
löe
,

36 c⁄° *
fun˘i⁄
, c⁄° * 
msg
, ...)

38 
buf
[1600] = {0};

39 
va_li°
 
va
;

40 
time_t
 
t
 = 
	`time
(
NULL
);

41 
tm
 *tm;

42 
buf_u£d
 = 0;

43 
d©e
[256];

45 
tm
 = 
	`loˇ…ime
(&
t
);

46 
	`°r·ime
(
d©e
, (d©e), "%b %ê%T", 
tm
);

48 
	`¢¥ötf
(
buf
, (buf), "[%s] %s[%ld]: %s:%d %s: ", 
d©e
, 
Àvñs
[
Àvñ
], ()
	`gëpid
(), 
fûe
, 
löe
, 
fun˘i⁄
);

49 
buf_u£d
 = 
	`°æí
(
buf
);

50 
	`va_°¨t
 (
va
, 
msg
);

51 
	`v¢¥ötf
(
buf
 + 
buf_u£d
 , (bufË- buf_u£d, (*)
msg
, 
va
);

52 
	`va_íd
(
va
);

54 
	`Ârötf
(
°dout
, "%s", 
buf
);

55 
	}
}

	@src/liblwqq/login.c

13 
	~<°rög.h
>

14 
	~<î∫o.h
>

15 
	~<°dlib.h
>

16 
	~<˘y≥.h
>

17 
	~<Æloˇ.h
>

18 
	~<time.h
>

19 
	~<sys/time.h
>

20 
	~<sys/ty≥s.h
>

21 
	~<sys/°©.h
>

22 
	~<f˙é.h
>

23 
	~<uni°d.h
>

25 
	~"logö.h
"

26 
	~"loggî.h
"

27 
	~"hâp.h
"

28 
	~"smem‹y.h
"

29 
	~"md5.h
"

30 
	~"uæ.h
"

31 
	~"js⁄.h
"

34 
	#LWQQ_URL_LOGIN_HOST
 "hâp://±logö2.qq.com"

	)

35 
	#LWQQ_URL_CHECK_HOST
 "hâp://check.±logö2.qq.com"

	)

36 
	#LWQQ_URL_VERIFY_IMG
 "hâp://ˇ±cha.qq.com/gëimage?aid=%s&uö=%s"

	)

37 
	#VCCHECKPATH
 "/check"

	)

38 
	#APPID
 "1003903"

	)

39 
	#LWQQ_URL_SET_STATUS
 "hâp://d.web2.qq.com/ch™√l/logö2"

	)

42 
	#LWQQ_URL_VERSION
 "hâp://ui.±logö2.qq.com/cgi-bö/vî"

	)

44 
£t_⁄löe_°©us
(
LwqqClõ¡
 *
lc
, *
°©us
, 
LwqqEº‹Code
 *
îr
);

54 
	$upd©e_cookõs
(
LwqqCookõs
 *
cookõs
, 
LwqqHâpReque°
 *
ªq
,

55 c⁄° *
key
, 
upd©e_ˇche
)

57 i‡(!
cookõs
 || !
ªq
 || !
key
) {

58 
	`lwqq_log
(
LOG_ERROR
, "NullÖointeráccess\n");

62 *
vÆue
 = 
ªq
->
	`gë_cookõ
‘eq, 
key
);

63 i‡(!
vÆue
)

66 
	#FREE_AND_STRDUP
(
a
, 
b
) \

67 i‡(
a
) \

68 
	`s_‰ì
(
a
); \

69 
a
 = 
	`s_°rdup
(
b
);

	)

71 i‡(!
	`°rcmp
(
key
, "ptvfsession")) {

72 
	`FREE_AND_STRDUP
(
cookõs
->
±vf£ssi⁄
, 
vÆue
);

73 } i‡(!
	`°rcmp
(
key
, "ptcz")) {

74 
	`FREE_AND_STRDUP
(
cookõs
->
±cz
, 
vÆue
);

75 } i‡(!
	`°rcmp
(
key
, "skey")) {

76 
	`FREE_AND_STRDUP
(
cookõs
->
skey
, 
vÆue
);

77 } i‡(!
	`°rcmp
(
key
, "ptwebqq")) {

78 
	`FREE_AND_STRDUP
(
cookõs
->
±webqq
, 
vÆue
);

79 } i‡(!
	`°rcmp
(
key
, "ptuserinfo")) {

80 
	`FREE_AND_STRDUP
(
cookõs
->
±u£röfo
, 
vÆue
);

81 } i‡(!
	`°rcmp
(
key
, "uin")) {

82 
	`FREE_AND_STRDUP
(
cookõs
->
uö
, 
vÆue
);

83 } i‡(!
	`°rcmp
(
key
, "ptisp")) {

84 
	`FREE_AND_STRDUP
(
cookõs
->
±i•
, 
vÆue
);

85 } i‡(!
	`°rcmp
(
key
, "pt2gguin")) {

86 
	`FREE_AND_STRDUP
(
cookõs
->
±2gguö
, 
vÆue
);

87 } i‡(!
	`°rcmp
(
key
, "verifysession")) {

88 
	`FREE_AND_STRDUP
(
cookõs
->
vîify£ssi⁄
, 
vÆue
);

90 
	`lwqq_log
(
LOG_WARNING
, "Nÿthi†cookõ: %s\n", 
key
);

92 
	`s_‰ì
(
vÆue
);

94 i‡(
upd©e_ˇche
) {

95 
buf
[4096] = {0};

96 
buÊí
 = 0;

97 i‡(
cookõs
->
±vf£ssi⁄
) {

98 
	`¢¥ötf
(
buf
, (buf), "±vf£ssi⁄=%s; ", 
cookõs
->
±vf£ssi⁄
);

99 
buÊí
 = 
	`°æí
(
buf
);

101 i‡(
cookõs
->
±cz
) {

102 
	`¢¥ötf
(
buf
 + 
buÊí
, (bufË- buÊí, "±cz=%s; ", 
cookõs
->
±cz
);

103 
buÊí
 = 
	`°æí
(
buf
);

105 i‡(
cookõs
->
skey
) {

106 
	`¢¥ötf
(
buf
 + 
buÊí
, (bufË- buÊí, "skey=%s; ", 
cookõs
->
skey
);

107 
buÊí
 = 
	`°æí
(
buf
);

109 i‡(
cookõs
->
±webqq
) {

110 
	`¢¥ötf
(
buf
 + 
buÊí
, (bufË- buÊí, "±webqq=%s; ", 
cookõs
->
±webqq
);

111 
buÊí
 = 
	`°æí
(
buf
);

113 i‡(
cookõs
->
±u£röfo
) {

114 
	`¢¥ötf
(
buf
 + 
buÊí
, (bufË- buÊí, "±u£röfo=%s; ", 
cookõs
->
±u£röfo
);

115 
buÊí
 = 
	`°æí
(
buf
);

117 i‡(
cookõs
->
uö
) {

118 
	`¢¥ötf
(
buf
 + 
buÊí
, (bufË- buÊí, "uö=%s; ", 
cookõs
->
uö
);

119 
buÊí
 = 
	`°æí
(
buf
);

121 i‡(
cookõs
->
±i•
) {

122 
	`¢¥ötf
(
buf
 + 
buÊí
, (bufË- buÊí, "±i•=%s; ", 
cookõs
->
±i•
);

123 
buÊí
 = 
	`°æí
(
buf
);

125 i‡(
cookõs
->
±2gguö
) {

126 
	`¢¥ötf
(
buf
 + 
buÊí
, (bufË- buÊí, "±2gguö=%s; ", 
cookõs
->
±2gguö
);

127 
buÊí
 = 
	`°æí
(
buf
);

129 i‡(
cookõs
->
vîify£ssi⁄
) {

130 
	`¢¥ötf
(
buf
 + 
buÊí
, (bufË- buÊí, "vîify£ssi⁄=%s; ", 
cookõs
->
vîify£ssi⁄
);

131 
buÊí
 = 
	`°æí
(
buf
);

134 
	`FREE_AND_STRDUP
(
cookõs
->
lwcookõs
, 
buf
);

136 #unde‡
FREE_AND_STRDUP


137 
	}
}

140 *
	$∑r£_vîify_uö
(c⁄° *
°r
)

142 *
°¨t
;

143 *
íd
;

144 
uö
[128] = {0};

146 
°¨t
 = 
	`°rchr
(
°r
, '\\');

147 i‡(!
°¨t
)

148  
NULL
;

150 
íd
 = 
	`°rchr
(
°¨t
, '\'');

151 i‡(!
íd
)

152  
NULL
;

154 
	`°∫˝y
(
uö
, 
°¨t
, 
íd
 - start);

156  
	`s_°rdup
(
uö
);

157 
	}
}

159 
	$gë_vîify_code
(
LwqqClõ¡
 *
lc
, 
LwqqEº‹Code
 *
îr
)

161 
LwqqHâpReque°
 *
ªq
;

162 
uæ
[512];

163 
ª•⁄£
[256];

164 
ªt
;

165 
chkuö
[64];

167 
	`¢¥ötf
(
uæ
, (uæ), "%s%s?uö=%s&≠pid=%s", 
LWQQ_URL_CHECK_HOST
,

168 
VCCHECKPATH
, 
lc
->
u£∫ame
, 
APPID
);

169 
ªq
 = 
	`lwqq_hâp_¸óã_deÁu…_ªque°
(
uæ
, 
îr
);

170 i‡(!
ªq
) {

171 
Áûed
;

174 
	`¢¥ötf
(
chkuö
, (chkuö), "chkuö=%s", 
lc
->
u£∫ame
);

175 
ªq
->
	`£t_hódî
‘eq, "Cookõ", 
chkuö
);

176 
ªt
 = 
ªq
->
	`do_ªque°
‘eq, 0, 
NULL
);

177 i‡(
ªt
) {

178 *
îr
 = 
LWQQ_EC_NETWORK_ERROR
;

179 
Áûed
;

181 i‡(
ªq
->
hâp_code
 != 200) {

182 *
îr
 = 
LWQQ_EC_HTTP_ERROR
;

183 
Áûed
;

198 
	`¢¥ötf
(
ª•⁄£
, ‘e•⁄£), "%s", 
ªq
->response);

199 
	`lwqq_log
(
LOG_NOTICE
, "GëÑe•⁄£ vîify code: %s\n", 
ª•⁄£
);

201 *
c
 = 
	`°r°r
(
ª•⁄£
, "ptui_checkVC");

202 *
s
;

203 i‡(!
c
) {

204 *
îr
 = 
LWQQ_EC_HTTP_ERROR
;

205 
Áûed
;

207 
c
 = 
	`°rchr
(
ª•⁄£
, '\'');

208 i‡(!
c
) {

209 *
îr
 = 
LWQQ_EC_HTTP_ERROR
;

210 
Áûed
;

212 
c
++;

213 
lc
->
vc
 = 
	`s_mÆloc0
((*lc->vc));

214 i‡(*
c
 == '0') {

218 
lc
->
vc
->
uö
 = 
	`∑r£_vîify_uö
(
ª•⁄£
);

219 i‡(!
lc
->
vc
->
uö
)

220 
Áûed
;

222 
s
 = 
c
;

223 
c
 = 
	`°r°r
(
s
, "'");

224 
s
 = 
c
 + 1;

225 
c
 = 
	`°r°r
(
s
, "'");

226 
s
 = 
c
 + 1;

227 
c
 = 
	`°r°r
(
s
, "'");

228 *
c
 = '\0';

230 
lc
->
vc
->
ty≥
 = 
	`s_°rdup
("0");

231 
lc
->
vc
->
°r
 = 
	`s_°rdup
(
s
);

234 
	`upd©e_cookõs
(
lc
->
cookõs
, 
ªq
, "ptvfsession", 1);

235 
	`lwqq_log
(
LOG_NOTICE
, "Vîify code: %s\n", 
lc
->
vc
->
°r
);

236 } i‡(*
c
 == '1') {

240 
lc
->
vc
->
uö
 = 
	`∑r£_vîify_uö
(
ª•⁄£
);

241 
s
 = 
c
;

242 
c
 = 
	`°r°r
(
s
, "'");

243 
s
 = 
c
 + 1;

244 
c
 = 
	`°r°r
(
s
, "'");

245 
s
 = 
c
 + 1;

246 
c
 = 
	`°r°r
(
s
, "'");

247 *
c
 = '\0';

248 
lc
->
vc
->
ty≥
 = 
	`s_°rdup
("1");

250 
lc
->
vc
->
°r
 = 
	`s_°rdup
(
s
);

251 *
îr
 = 
LWQQ_EC_LOGIN_NEED_VC
;

252 
	`lwqq_log
(
LOG_NOTICE
, "Wê√ed vîify codêimage: %s\n", 
lc
->
vc
->
°r
);

255 
	`lwqq_hâp_ªque°_‰ì
(
ªq
);

258 
Áûed
:

259 
	`lwqq_hâp_ªque°_‰ì
(
ªq
);

260 
	}
}

262 
	$gë_vîify_image
(
LwqqClõ¡
 *
lc
)

264 
LwqqHâpReque°
 *
ªq
 = 
NULL
;

265 
uæ
[512];

266 
ªt
;

267 
chkuö
[64];

268 
image_fûe
[256];

269 
image_Àngth
 = 0;

270 
LwqqEº‹Code
 
îr
;

272 
	`¢¥ötf
(
uæ
, (uæ), 
LWQQ_URL_VERIFY_IMG
, 
APPID
, 
lc
->
u£∫ame
);

273 
ªq
 = 
	`lwqq_hâp_¸óã_deÁu…_ªque°
(
uæ
, &
îr
);

274 i‡(!
ªq
) {

275 
Áûed
;

278 
	`¢¥ötf
(
chkuö
, (chkuö), "chkuö=%s", 
lc
->
u£∫ame
);

279 
ªq
->
	`£t_hódî
‘eq, "Cookõ", 
chkuö
);

280 
ªt
 = 
ªq
->
	`do_ªque°
‘eq, 0, 
NULL
);

281 i‡(
ªt
) {

282 
Áûed
;

284 i‡(
ªq
->
hâp_code
 != 200) {

285 
Áûed
;

288 *
c⁄ã¡_Àngth
 = 
ªq
->
	`gë_hódî
(req, "Content-Length");

289 i‡(
c⁄ã¡_Àngth
) {

290 
image_Àngth
 = 
	`©oi
(
c⁄ã¡_Àngth
);

291 
	`s_‰ì
(
c⁄ã¡_Àngth
);

293 
	`upd©e_cookõs
(
lc
->
cookõs
, 
ªq
, "verifysession", 1);

294 
	`¢¥ötf
(
image_fûe
, (image_fûe), "/tmp/lwqq_%s.j≥g", 
lc
->
u£∫ame
);

296 
	`u∆ök
(
image_fûe
);

297 
fd
 = 
	`¸ót
(
image_fûe
, 
S_IRUSR
 | 
S_IWUSR
);

298 i‡(
fd
 != -1) {

299 
ªt
 = 
	`wrôe
(
fd
, 
ªq
->
ª•⁄£
, 
image_Àngth
);

300 i‡(
ªt
 <= 0) {

301 
	`lwqq_log
(
LOG_ERROR
, "SavingÉrify image fileÉrror\n");

303 
	`˛o£
(
fd
);

306 
Áûed
:

307 
	`lwqq_hâp_ªque°_‰ì
(
ªq
);

308 
	}
}

311 
	$upˇ£_°rög
(*
°r
, 
Àn
)

313 
i
;

314 
i
 = 0; i < 
Àn
; ++i) {

315 i‡(
	`i¶owî
(
°r
[
i
]))

316 
°r
[
i
]
	`touµî
(str[i]);

318 
	}
}

337 *
	$lwqq_íc_pwd
(c⁄° *
pwd
, c⁄° *
vc
, c⁄° *
uö
)

339 
i
;

340 
uö_byã_Àngth
;

341 
buf
[128] = {0};

342 
_uö
[9] = {0};

344 i‡(!
pwd
 || !
vc
 || !
uö
) {

345 
	`lwqq_log
(
LOG_ERROR
, "NullÖarameterment\n");

346  
NULL
;

351 
uö_byã_Àngth
 = 
	`°æí
(
uö
) / 4;

357 
i
 = 0; i < 
uö_byã_Àngth
 ; i++) {

358 
u
[5] = {0};

359 
tmp
;

360 
	`°∫˝y
(
u
, 
uö
 + 
i
 * 4 + 2, 2);

362 
î∫o
 = 0;

363 
tmp
 = 
	`°πﬁ
(
u
, 
NULL
, 16);

364 i‡(
î∫o
) {

365  
NULL
;

367 
_uö
[
i
] = 
tmp
;

371 
	`lutû_md5_dige°
((*)
pwd
, 
	`°æí
’wd), (*)
buf
);

374 
	`mem˝y
(
buf
 + 16, 
_uö
, 
uö_byã_Àngth
);

375 
	`lutû_md5_d©a
((*)
buf
, 16 + 
uö_byã_Àngth
, (*)buf);

378 
	`¢¥ötf
(
buf
 + 
	`°æí
(buf), (bufË- såÀn(buf), "%s", 
vc
);

379 
	`upˇ£_°rög
(
buf
, 
	`°æí
(buf));

381 
	`lutû_md5_d©a
((*)
buf
, 
	`°æí
(buf), (*)buf);

382 
	`upˇ£_°rög
(
buf
, 
	`°æí
(buf));

385 
	`puts
(
buf
);

386  
	`s_°rdup
(
buf
);

387 
	}
}

389 
	$ßva_cookõ
(
LwqqClõ¡
 *
lc
, 
LwqqHâpReque°
 *
ªq
, 
LwqqEº‹Code
 *
îr
)

391 
	`upd©e_cookõs
(
lc
->
cookõs
, 
ªq
, "ptcz", 0);

392 
	`upd©e_cookõs
(
lc
->
cookõs
, 
ªq
, "skey", 0);

393 
	`upd©e_cookõs
(
lc
->
cookõs
, 
ªq
, "ptwebqq", 0);

394 
	`upd©e_cookõs
(
lc
->
cookõs
, 
ªq
, "ptuserinfo", 0);

395 
	`upd©e_cookõs
(
lc
->
cookõs
, 
ªq
, "uin", 0);

396 
	`upd©e_cookõs
(
lc
->
cookõs
, 
ªq
, "ptisp", 0);

397 
	`upd©e_cookõs
(
lc
->
cookõs
, 
ªq
, "pt2gguin", 1);

400 
	}
}

409 
	$do_logö
(
LwqqClõ¡
 *
lc
, c⁄° *
md5
, 
LwqqEº‹Code
 *
îr
)

411 
uæ
[1024];

412 
LwqqHâpReque°
 *
ªq
;

413 *
ª•⁄£
 = 
NULL
;

414 *
cookõs
;

415 
ªt
;

417 
	`¢¥ötf
(
uæ
, (url), "%s/login?u=%s&p=%s&verifycode=%s&"

422 "a˘i⁄=2-11-7438&mibao_css=m_webqq&t=1&g=1", 
LWQQ_URL_LOGIN_HOST
, 
lc
->
u£∫ame
, 
md5
,Üc->
vc
->
°r
);

424 
ªq
 = 
	`lwqq_hâp_¸óã_deÁu…_ªque°
(
uæ
, 
îr
);

425 i‡(!
ªq
) {

426 
d⁄e
;

429 
cookõs
 = 
	`lwqq_gë_cookõs
(
lc
);

430 i‡(
cookõs
) {

431 
ªq
->
	`£t_hódî
‘eq, "Cookõ", 
cookõs
);

432 
	`s_‰ì
(
cookõs
);

436 
ªt
 = 
ªq
->
	`do_ªque°
‘eq, 0, 
NULL
);

437 i‡(
ªt
) {

438 *
îr
 = 
LWQQ_EC_NETWORK_ERROR
;

439 
d⁄e
;

441 i‡(
ªq
->
hâp_code
 != 200) {

442 *
îr
 = 
LWQQ_EC_HTTP_ERROR
;

443 
d⁄e
;

446 
ª•⁄£
 = 
ªq
->response;

447 *
p
 = 
	`°r°r
(
ª•⁄£
, "\'");

448 i‡(!
p
) {

449 *
îr
 = 
LWQQ_EC_ERROR
;

450 
d⁄e
;

452 
buf
[4] = {0};

453 
°©us
;

454 
	`°∫˝y
(
buf
, 
p
 + 1, 1);

455 
°©us
 = 
	`©oi
(
buf
);

457 
°©us
) {

459 i‡(
	`ßva_cookõ
(
lc
, 
ªq
, 
îr
)) {

460 
d⁄e
;

465 
	`lwqq_log
(
LOG_WARNING
, "Server busy! PleaseÅryágain\n");

466 *
îr
 = 
LWQQ_EC_ERROR
;

467 
d⁄e
;

470 
	`lwqq_log
(
LOG_ERROR
, "Out of date QQÇumber\n");

471 *
îr
 = 
LWQQ_EC_ERROR
;

472 
d⁄e
;

475 
	`lwqq_log
(
LOG_ERROR
, "WrongÖassword\n");

476 *
îr
 = 
LWQQ_EC_ERROR
;

477 
d⁄e
;

480 
	`lwqq_log
(
LOG_ERROR
, "Wrong verify code\n");

481 *
îr
 = 
LWQQ_EC_ERROR
;

482 
d⁄e
;

485 
	`lwqq_log
(
LOG_ERROR
, "Verify failed\n");

486 *
îr
 = 
LWQQ_EC_ERROR
;

487 
d⁄e
;

490 
	`lwqq_log
(
LOG_WARNING
, "You mayÇeedÅoÅryÜoginágain\n");

491 *
îr
 = 
LWQQ_EC_ERROR
;

492 
d⁄e
;

495 
	`lwqq_log
(
LOG_ERROR
, "Wrong input\n");

496 *
îr
 = 
LWQQ_EC_ERROR
;

497 
d⁄e
;

500 
	`lwqq_log
(
LOG_ERROR
, "Too manyÜogins onÅhis IP. PleaseÅryágain\n");

501 *
îr
 = 
LWQQ_EC_ERROR
;

502 
d⁄e
;

505 *
îr
 = 
LWQQ_EC_ERROR
;

506 
	`lwqq_log
(
LOG_ERROR
, "UnknowÉrror");

507 
d⁄e
;

510 
	`£t_⁄löe_°©us
(
lc
, "⁄löe", 
îr
);

511 
d⁄e
:

512 
	`lwqq_hâp_ªque°_‰ì
(
ªq
);

513 
	}
}

525 
	$gë_vîsi⁄
(
LwqqClõ¡
 *
lc
, 
LwqqEº‹Code
 *
îr
)

527 
LwqqHâpReque°
 *
ªq
;

528 *
ª•⁄£
 = 
NULL
;

529 
ªt
;

531 
ªq
 = 
	`lwqq_hâp_¸óã_deÁu…_ªque°
(
LWQQ_URL_VERSION
, 
îr
);

532 i‡(!
ªq
) {

533 
d⁄e
;

537 
	`lwqq_log
(
LOG_DEBUG
, "Gë webqq vîsi⁄ from %s\n", 
LWQQ_URL_VERSION
);

538 
ªt
 = 
ªq
->
	`do_ªque°
‘eq, 0, 
NULL
);

539 i‡(
ªt
) {

540 *
îr
 = 
LWQQ_EC_NETWORK_ERROR
;

541 
d⁄e
;

543 
ª•⁄£
 = 
ªq
->response;

544 i‡(
	`°r°r
(
ª•⁄£
, "ptuiV")) {

545 *
s
, *
t
;

546 *
v
;

547 
s
 = 
	`°rchr
(
ª•⁄£
, '(');

548 
t
 = 
	`°rchr
(
ª•⁄£
, ')');

549 i‡(!
s
 || !
t
) {

550 *
îr
 = 
LWQQ_EC_ERROR
;

551 
d⁄e
;

553 
s
++;

554 
v
 = 
	`Æloˇ
(
t
 - 
s
 + 1);

555 
	`mem£t
(
v
, 0, 
t
 - 
s
 + 1);

556 
	`°∫˝y
(
v
, 
s
, 
t
 - s);

557 
	`s_‰ì
(
lc
->
vîsi⁄
);

558 
lc
->
vîsi⁄
 = 
	`s_°rdup
(
v
);

559 *
îr
 = 
LWQQ_EC_OK
;

562 
d⁄e
:

563 
	`lwqq_hâp_ªque°_‰ì
(
ªq
);

564 
	}
}

566 *
	$gíî©e_˛õ¡id
()

568 
r
;

569 
timevÆ
 
tv
;

570 
t
;

571 
buf
[20] = {0};

573 
	`§™d
(
	`time
(
NULL
));

574 
r
 = 
	`ønd
() % 90 + 10;

575 i‡(
	`gëtimeofday
(&
tv
, 
NULL
)) {

576  
NULL
;

578 
t
 = 
tv
.
tv_u£c
 % 1000000;

579 
	`¢¥ötf
(
buf
, (buf), "%d%ld", 
r
, 
t
);

580  
	`s_°rdup
(
buf
);

581 
	}
}

589 
	$£t_⁄löe_°©us
(
LwqqClõ¡
 *
lc
, *
°©us
, 
LwqqEº‹Code
 *
îr
)

591 
msg
[1024] ={0};

592 *
buf
;

593 
LwqqHâpReque°
 *
ªq
 = 
NULL
;

594 *
ª•⁄£
 = 
NULL
;

595 *
cookõs
;

596 
ªt
;

597 
js⁄_t
 *
js⁄
 = 
NULL
;

598 *
vÆue
;

600 i‡(!
°©us
 || !
îr
) {

601 
d⁄e
 ;

604 
lc
->
˛õ¡id
 = 
	`gíî©e_˛õ¡id
();

605 i‡(!
lc
->
˛õ¡id
) {

606 
	`lwqq_log
(
LOG_ERROR
, "Generate clientidÉrror\n");

607 *
îr
 = 
LWQQ_EC_ERROR
;

608 
d⁄e
 ;

611 
	`¢¥ötf
(
msg
, (msg), "{\"status\":\"%s\",\"ptwebqq\":\"%s\","

614 ,
°©us
, 
lc
->
cookõs
->
±webqq


615 ,
lc
->
˛õ¡id
);

616 
buf
 = 
	`uæ_ícode
(
msg
);

617 
	`¢¥ötf
(
msg
, (msg), "r=%s", 
buf
);

618 
	`s_‰ì
(
buf
);

621 
ªq
 = 
	`lwqq_hâp_¸óã_deÁu…_ªque°
(
LWQQ_URL_SET_STATUS
, 
îr
);

622 i‡(!
ªq
) {

623 
d⁄e
;

627 
ªq
->
	`£t_hódî
(req, "Cookie2", "$Version=1");

628 
ªq
->
	`£t_hódî
(req, "Referer", "http://d.web2.qq.com/proxy.html?v=20101025002");

629 
ªq
->
	`£t_hódî
(req, "Content-type", "application/x-www-form-urlencoded");

632 
cookõs
 = 
	`lwqq_gë_cookõs
(
lc
);

633 i‡(
cookõs
) {

634 
ªq
->
	`£t_hódî
‘eq, "Cookõ", 
cookõs
);

635 
	`s_‰ì
(
cookõs
);

638 
ªt
 = 
ªq
->
	`do_ªque°
‘eq, 1, 
msg
);

639 i‡(
ªt
) {

640 *
îr
 = 
LWQQ_EC_NETWORK_ERROR
;

641 
d⁄e
;

643 i‡(
ªq
->
hâp_code
 != 200) {

644 *
îr
 = 
LWQQ_EC_HTTP_ERROR
;

645 
d⁄e
;

653 
ª•⁄£
 = 
ªq
->response;

654 
ªt
 = 
	`js⁄_∑r£_documít
(&
js⁄
, 
ª•⁄£
);

655 i‡(
ªt
 !
JSON_OK
) {

656 *
îr
 = 
LWQQ_EC_ERROR
;

657 
d⁄e
;

660 i‡(!(
vÆue
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, "retcode"))) {

661 *
îr
 = 
LWQQ_EC_ERROR
;

662 
d⁄e
;

669 i‡((
vÆue
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, "seskey"))) {

670 
lc
->
£skey
 = 
	`s_°rdup
(
vÆue
);

673 i‡((
vÆue
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, "cip"))) {

674 
lc
->
cù
 = 
	`s_°rdup
(
vÆue
);

677 i‡((
vÆue
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, "index"))) {

678 
lc
->
ödex
 = 
	`s_°rdup
(
vÆue
);

681 i‡((
vÆue
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, "port"))) {

682 
lc
->
p‹t
 = 
	`s_°rdup
(
vÆue
);

685 i‡((
vÆue
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, "status"))) {

687 
lc
->
°©us
 = 
	`s_°rdup
(
vÆue
);

690 i‡((
vÆue
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, "vfwebqq"))) {

691 
lc
->
vfwebqq
 = 
	`s_°rdup
(
vÆue
);

694 i‡((
vÆue
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, "psessionid"))) {

695 
lc
->
p£ssi⁄id
 = 
	`s_°rdup
(
vÆue
);

698 *
îr
 = 
LWQQ_EC_OK
;

700 
d⁄e
:

701 i‡(
js⁄
)

702 
	`js⁄_‰ì_vÆue
(&
js⁄
);

703 
	`lwqq_hâp_ªque°_‰ì
(
ªq
);

704 
	}
}

718 
	$lwqq_logö
(
LwqqClõ¡
 *
˛õ¡
, 
LwqqEº‹Code
 *
îr
)

720 i‡(!
˛õ¡
 || !
îr
) {

721 
	`lwqq_log
(
LOG_ERROR
, "InvalidÖointer\n");

726 
	`gë_vîsi⁄
(
˛õ¡
, 
îr
);

727 i‡(*
îr
) {

728 
	`lwqq_log
(
LOG_ERROR
, "Get webqq versionÉrror\n");

731 
	`lwqq_log
(
LOG_NOTICE
, "Gë webqq vîsi⁄: %s\n", 
˛õ¡
->
vîsi⁄
);

742 i‡(!
˛õ¡
->
vc
) {

743 
	`gë_vîify_code
(
˛õ¡
, 
îr
);

744 *
îr
) {

745 
LWQQ_EC_LOGIN_NEED_VC
:

746 
	`gë_vîify_image
(
˛õ¡
);

747 
	`lwqq_log
(
LOG_WARNING
, "NeedÅoÉnter verify code\n");

750 
LWQQ_EC_NETWORK_ERROR
:

751 
	`lwqq_log
(
LOG_ERROR
, "NetworkÉrror\n");

754 
LWQQ_EC_OK
:

755 
	`lwqq_log
(
LOG_DEBUG
, "Get verify code OK\n");

759 
	`lwqq_log
(
LOG_ERROR
, "UnknownÉrror\n");

765 *
md5
 = 
	`lwqq_íc_pwd
(
˛õ¡
->
∑ssw‹d
, clõ¡->
vc
->
°r
, clõ¡->vc->
uö
);

768 
	`do_logö
(
˛õ¡
, 
md5
, 
îr
);

769 
	`s_‰ì
(
md5
);

772 
	`lwqq_vc_‰ì
(
˛õ¡
->
vc
);

773 
˛õ¡
->
vc
 = 
NULL
;

774 
	}
}

782 
	$lwqq_logout
(
LwqqClõ¡
 *
˛õ¡
, 
LwqqEº‹Code
 *
îr
)

784 
uæ
[512];

785 
LwqqHâpReque°
 *
ªq
 = 
NULL
;

786 
ªt
;

787 
js⁄_t
 *
js⁄
 = 
NULL
;

788 *
vÆue
;

789 
timevÆ
 
tv
;

790 *
cookõs
;

791 
ª
;

793 i‡(!
˛õ¡
) {

794 
	`lwqq_log
(
LOG_ERROR
, "InvalidÖointer\n");

799 i‡(
	`gëtimeofday
(&
tv
, 
NULL
)) {

800 i‡(
îr
)

801 *
îr
 = 
LWQQ_EC_ERROR
;

804 
ª
 = 
tv
.
tv_u£c
 / 1000;

805 
ª
 +
tv
.
tv_£c
;

807 
	`¢¥ötf
(
uæ
, (url), "%s/channel/logout2?clientid=%s&psessionid=%s&t=%ld",

808 "hâp://d.web2.qq.com", 
˛õ¡
->
˛õ¡id
, clõ¡->
p£ssi⁄id
, 
ª
);

811 
ªq
 = 
	`lwqq_hâp_¸óã_deÁu…_ªque°
(
uæ
, 
îr
);

812 i‡(!
ªq
) {

813 
d⁄e
;

817 
ªq
->
	`£t_hódî
(req, "Referer", "http://ptlogin2.qq.com/proxy.html?v=20101025002");

820 
cookõs
 = 
	`lwqq_gë_cookõs
(
˛õ¡
);

821 i‡(
cookõs
) {

822 
ªq
->
	`£t_hódî
‘eq, "Cookõ", 
cookõs
);

823 
	`s_‰ì
(
cookõs
);

826 
ªt
 = 
ªq
->
	`do_ªque°
‘eq, 0, 
NULL
);

827 i‡(
ªt
) {

828 
	`lwqq_log
(
LOG_ERROR
, "SendÜogoutÑequest failed\n");

829 i‡(
îr
)

830 *
îr
 = 
LWQQ_EC_NETWORK_ERROR
;

831 
d⁄e
;

833 i‡(
ªq
->
hâp_code
 != 200) {

834 i‡(
îr
)

835 *
îr
 = 
LWQQ_EC_HTTP_ERROR
;

836 
d⁄e
;

839 
ªt
 = 
	`js⁄_∑r£_documít
(&
js⁄
, 
ªq
->
ª•⁄£
);

840 i‡(
ªt
 !
JSON_OK
) {

841 i‡(
îr
)

842 *
îr
 = 
LWQQ_EC_ERROR
;

843 
d⁄e
;

847 
vÆue
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, "retcode");

848 i‡(!
vÆue
 || 
	`°rcmp
(value, "0")) {

849 i‡(
îr
)

850 *
îr
 = 
LWQQ_EC_ERROR
;

851 
d⁄e
;

853 
vÆue
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, "result");

854 i‡(!
vÆue
 || 
	`°rcmp
(value, "ok")) {

855 i‡(
îr
)

856 *
îr
 = 
LWQQ_EC_ERROR
;

857 
d⁄e
;

861 i‡(
îr
)

862 *
îr
 = 
LWQQ_EC_OK
;

864 
d⁄e
:

865 i‡(
js⁄
)

866 
	`js⁄_‰ì_vÆue
(&
js⁄
);

867 
	`lwqq_hâp_ªque°_‰ì
(
ªq
);

868 
	}
}

	@src/liblwqq/md5.c

48 #ifde‡
HAVE_CONFIG_H


49 
	~<c⁄fig.h
>

52 
	~<sys/ty≥s.h
>

53 
	~<f˙é.h
>

54 
	~<uni°d.h
>

55 
	~<î∫o.h
>

56 
	~<°dio.h
>

57 
	~<°dlib.h
>

58 
	~<°rög.h
>

60 
	~"md5.h
"

61 #ifde‡
WITH_DMALLOC


62 
	~<dmÆloc.h
>

65 
MD5Inô
(
MD5_CTX
 *
c⁄ãxt
);

66 
MD5Upd©e
(
MD5_CTX
 *
c⁄ãxt
, c⁄° *
buf
, 
Àn
);

67 
MD5FöÆ
(
dige°
[
MD5_HASHBYTES
], 
MD5_CTX
 *
c⁄ãxt
);

68 
MD5Tønsf‹m
(
u_öt32_t
 
buf
[4], u_öt32_àc⁄° 
ö
[16]);

69 * 
MD5End
(
MD5_CTX
 *, *);

72 #i‡
__BYTE_ORDER
 == 1234

73 
	#byãRevî£
(
buf
, 
Àn
Ë

	)

75 
byãRevî£
(*
buf
, 
l⁄gs
);

80 
	$byãRevî£
(*
buf
, 
l⁄gs
)

82 
u_öt32_t
 
t
;

84 
t
 = (
u_öt32_t
Ë((Ë
buf
[3] << 8 | buf[2]) << 16 |

85 ((Ë
buf
[1] << 8 | buf[0]);

86 *(
u_öt32_t
 *Ë
buf
 = 
t
;

87 
buf
 += 4;

88 } --
l⁄gs
);

89 
	}
}

96 
	$lutû_md5_fûe
 (c⁄° *
fûíame
, *
buf
)

98 
buf„r
[
BUFSIZ
];

99 
MD5_CTX
 
˘x
;

100 
f
,
i
,
j
;

102 
	`MD5Inô
(&
˘x
);

103 
f
 = 
	`›í
(
fûíame
,
O_RDONLY
);

104 i‡(
f
 < 0)  0;

105 (
i
 = 
	`ªad
(
f
,
buf„r
, buffer)) > 0) {

106 
	`MD5Upd©e
(&
˘x
,
buf„r
,
i
);

108 
j
 = 
î∫o
;

109 
	`˛o£
(
f
);

110 
î∫o
 = 
j
;

111 i‡(
i
 < 0)  0;

112  
	`MD5End
(&
˘x
, 
buf
);

113 
	}
}

116 
	$lutû_md5_d©a
 (c⁄° *
d©a
, 
Àn
, *
buf
)

118 
MD5_CTX
 
˘x
;

120 
	`MD5Inô
(&
˘x
);

121 
	`MD5Upd©e
(&
˘x
,
d©a
,
Àn
);

122  
	`MD5End
(&
˘x
, 
buf
);

123 
	}
}

131 
	$MD5End
(
MD5_CTX
 *
˘x
, *
buf
)

133 
i
;

134 
dige°
[
MD5_HASHBYTES
];

135 c⁄° 
hex
[]="0123456789abcdef";

137 i‡(!
buf
)

138 
buf
 = 
	`mÆloc
(33);

139 i‡(!
buf
)

141 
	`MD5FöÆ
(
dige°
,
˘x
);

142 
i
=0;i<
MD5_HASHBYTES
;i++) {

143 
buf
[
i
+i] = 
hex
[
dige°
[i] >> 4];

144 
buf
[
i
+i+1] = 
hex
[
dige°
[i] & 0x0f];

146 
buf
[
i
+i] = '\0';

147  
buf
;

148 
	}
}

154 
	$MD5Inô
(
MD5_CTX
 *
˘x
)

156 
˘x
->
buf
[0] = 0x67452301;

157 
˘x
->
buf
[1] = 0xefcdab89;

158 
˘x
->
buf
[2] = 0x98badcfe;

159 
˘x
->
buf
[3] = 0x10325476;

161 
˘x
->
bôs
[0] = 0;

162 
˘x
->
bôs
[1] = 0;

163 
	}
}

169 
	$MD5Upd©e
(
MD5_CTX
 *
˘x
, c⁄° *
buf
, 
Àn
)

171 
u_öt32_t
 
t
;

175 
t
 = 
˘x
->
bôs
[0];

176 i‡((
˘x
->
bôs
[0] = 
t
 + ((
u_öt32_t
Ë
Àn
 << 3)) <Å)

177 
˘x
->
bôs
[1]++;

178 
˘x
->
bôs
[1] +
Àn
 >> 29;

180 
t
 = (t >> 3) & 0x3f;

184 i‡(
t
) {

185 *
p
 = (*Ë
˘x
->
ö
 + 
t
;

187 
t
 = 64 -Å;

188 i‡(
Àn
 < 
t
) {

189 
	`mem˝y
(
p
, 
buf
, 
Àn
);

192 
	`mem˝y
(
p
, 
buf
, 
t
);

193 
	`byãRevî£
(
˘x
->
ö
, 16);

194 
	`MD5Tønsf‹m
(
˘x
->
buf
, (
u_öt32_t
 *Ë˘x->
ö
);

195 
buf
 +
t
;

196 
Àn
 -
t
;

200 
Àn
 >= 64) {

201 
	`mem˝y
(
˘x
->
ö
, 
buf
, 64);

202 
	`byãRevî£
(
˘x
->
ö
, 16);

203 
	`MD5Tønsf‹m
(
˘x
->
buf
, (
u_öt32_t
 *Ë˘x->
ö
);

204 
buf
 += 64;

205 
Àn
 -= 64;

210 
	`mem˝y
(
˘x
->
ö
, 
buf
, 
Àn
);

211 
	}
}

217 
	$MD5FöÆ
(
dige°
[16], 
MD5_CTX
 *
˘x
)

219 
cou¡
;

220 *
p
;

223 
cou¡
 = (
˘x
->
bôs
[0] >> 3) & 0x3F;

227 
p
 = 
˘x
->
ö
 + 
cou¡
;

228 *
p
++ = 0x80;

231 
cou¡
 = 64 - 1 - count;

234 i‡(
cou¡
 < 8) {

236 
	`mem£t
(
p
, 0, 
cou¡
);

237 
	`byãRevî£
(
˘x
->
ö
, 16);

238 
	`MD5Tønsf‹m
(
˘x
->
buf
, (
u_öt32_t
 *Ë˘x->
ö
);

241 
	`mem£t
(
˘x
->
ö
, 0, 56);

244 
	`mem£t
(
p
, 0, 
cou¡
 - 8);

246 
	`byãRevî£
(
˘x
->
ö
, 14);

249 ((
u_öt32_t
 *Ë
˘x
->
ö
)[14] = ctx->
bôs
[0];

250 ((
u_öt32_t
 *Ë
˘x
->
ö
)[15] = ctx->
bôs
[1];

252 
	`MD5Tønsf‹m
(
˘x
->
buf
, (
u_öt32_t
 *Ë˘x->
ö
);

253 
	`byãRevî£
((*Ë
˘x
->
buf
, 4);

254 
	`mem˝y
(
dige°
, 
˘x
->
buf
, 16);

255 
	`mem£t
((*Ë
˘x
, 0, (ctx));

256 
	}
}

261 
	#F1
(
x
, 
y
, 
z
Ë(z ^ (x & (y ^ z)))

	)

262 
	#F2
(
x
, 
y
, 
z
Ë
	`F1
(z, x, y)

	)

263 
	#F3
(
x
, 
y
, 
z
Ë(x ^ y ^ z)

	)

264 
	#F4
(
x
, 
y
, 
z
Ë(y ^ (x | ~z))

	)

267 
	#MD5STEP
(
f
, 
w
, 
x
, 
y
, 
z
, 
d©a
, 
s
) \

268 –
w
 +
	`f
(
x
, 
y
, 
z
Ë+ 
d©a
, w = w<<
s
 | w>>(32-s), w +x )

	)

275 
	$MD5Tønsf‹m
(
u_öt32_t
 
buf
[4], u_öt32_àc⁄° 
ö
[16])

277 
u_öt32_t
 
a
, 
b
, 
c
, 
d
;

279 
a
 = 
buf
[0];

280 
b
 = 
buf
[1];

281 
c
 = 
buf
[2];

282 
d
 = 
buf
[3];

284 
	`MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
ö
[0] + 0xd76aa478, 7);

285 
	`MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
ö
[1] + 0xe8c7b756, 12);

286 
	`MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
ö
[2] + 0x242070db, 17);

287 
	`MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
ö
[3] + 0xc1bdceee, 22);

288 
	`MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
ö
[4] + 0xf57c0faf, 7);

289 
	`MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
ö
[5] + 0x4787c62a, 12);

290 
	`MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
ö
[6] + 0xa8304613, 17);

291 
	`MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
ö
[7] + 0xfd469501, 22);

292 
	`MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
ö
[8] + 0x698098d8, 7);

293 
	`MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
ö
[9] + 0x8b44f7af, 12);

294 
	`MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
ö
[10] + 0xffff5bb1, 17);

295 
	`MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
ö
[11] + 0x895cd7be, 22);

296 
	`MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
ö
[12] + 0x6b901122, 7);

297 
	`MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
ö
[13] + 0xfd987193, 12);

298 
	`MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
ö
[14] + 0xa679438e, 17);

299 
	`MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
ö
[15] + 0x49b40821, 22);

301 
	`MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
ö
[1] + 0xf61e2562, 5);

302 
	`MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
ö
[6] + 0xc040b340, 9);

303 
	`MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
ö
[11] + 0x265e5a51, 14);

304 
	`MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
ö
[0] + 0xe9b6c7aa, 20);

305 
	`MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
ö
[5] + 0xd62f105d, 5);

306 
	`MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
ö
[10] + 0x02441453, 9);

307 
	`MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
ö
[15] + 0xd8a1e681, 14);

308 
	`MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
ö
[4] + 0xe7d3fbc8, 20);

309 
	`MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
ö
[9] + 0x21e1cde6, 5);

310 
	`MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
ö
[14] + 0xc33707d6, 9);

311 
	`MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
ö
[3] + 0xf4d50d87, 14);

312 
	`MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
ö
[8] + 0x455a14ed, 20);

313 
	`MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
ö
[13] + 0xa9e3e905, 5);

314 
	`MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
ö
[2] + 0xfcefa3f8, 9);

315 
	`MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
ö
[7] + 0x676f02d9, 14);

316 
	`MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
ö
[12] + 0x8d2a4c8a, 20);

318 
	`MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
ö
[5] + 0xfffa3942, 4);

319 
	`MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
ö
[8] + 0x8771f681, 11);

320 
	`MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
ö
[11] + 0x6d9d6122, 16);

321 
	`MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
ö
[14] + 0xfde5380c, 23);

322 
	`MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
ö
[1] + 0xa4beea44, 4);

323 
	`MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
ö
[4] + 0x4bdecfa9, 11);

324 
	`MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
ö
[7] + 0xf6bb4b60, 16);

325 
	`MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
ö
[10] + 0xbebfbc70, 23);

326 
	`MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
ö
[13] + 0x289b7ec6, 4);

327 
	`MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
ö
[0] + 0xeaa127fa, 11);

328 
	`MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
ö
[3] + 0xd4ef3085, 16);

329 
	`MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
ö
[6] + 0x04881d05, 23);

330 
	`MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
ö
[9] + 0xd9d4d039, 4);

331 
	`MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
ö
[12] + 0xe6db99e5, 11);

332 
	`MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
ö
[15] + 0x1fa27cf8, 16);

333 
	`MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
ö
[2] + 0xc4ac5665, 23);

335 
	`MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
ö
[0] + 0xf4292244, 6);

336 
	`MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
ö
[7] + 0x432aff97, 10);

337 
	`MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
ö
[14] + 0xab9423a7, 15);

338 
	`MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
ö
[5] + 0xfc93a039, 21);

339 
	`MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
ö
[12] + 0x655b59c3, 6);

340 
	`MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
ö
[3] + 0x8f0ccc92, 10);

341 
	`MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
ö
[10] + 0xffeff47d, 15);

342 
	`MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
ö
[1] + 0x85845dd1, 21);

343 
	`MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
ö
[8] + 0x6fa87e4f, 6);

344 
	`MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
ö
[15] + 0xfe2ce6e0, 10);

345 
	`MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
ö
[6] + 0xa3014314, 15);

346 
	`MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
ö
[13] + 0x4e0811a1, 21);

347 
	`MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
ö
[4] + 0xf7537e82, 6);

348 
	`MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
ö
[11] + 0xbd3af235, 10);

349 
	`MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
ö
[2] + 0x2ad7d2bb, 15);

350 
	`MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
ö
[9] + 0xeb86d391, 21);

352 
buf
[0] +
a
;

353 
buf
[1] +
b
;

354 
buf
[2] +
c
;

355 
buf
[3] +
d
;

356 
	}
}

360 
	$lutû_md5_dige°
(c⁄° *
d©a
, 
Àn
, *
buf
)

362 
MD5_CTX
 
˘x
;

364 
	`MD5Inô
(&
˘x
);

365 
	`MD5Upd©e
(&
˘x
,
d©a
,
Àn
);

366 
	`MD5FöÆ
((*)
buf
, &
˘x
);

367  
buf
;

368 
	}
}

	@src/liblwqq/md5.h

48 #i‚de‡
MD5_H


49 
	#MD5_H


	)

51 #ifde‡
HAVE_CONFIG_H


52 
	~<c⁄fig.h
>

55 
	~<sys/ty≥s.h
>

57 
	#MD5_HASHBYTES
 16

	)

59 
	sMD5C⁄ãxt
 {

60 
u_öt32_t
 
	mbuf
[4];

61 
u_öt32_t
 
	mbôs
[2];

62 
	mö
[64];

63 } 
	tMD5_CTX
;

65 * 
lutû_md5_fûe
(c⁄° *
fûíame
, *
buf
);

66 * 
lutû_md5_dige°
(c⁄° * 
d©a
, 
Àn
 , *
buf
);

67 * 
lutû_md5_d©a
(c⁄° *
d©a
, 
Àn
, *
buf
);

	@src/liblwqq/msg.c

11 
	~<°dlib.h
>

12 
	~<°rög.h
>

13 
	~<°dlib.h
>

15 
	~"ty≥.h
"

16 
	~"smem‹y.h
"

17 
	~"js⁄.h
"

18 
	~"hâp.h
"

19 
	~"uæ.h
"

20 
	~"loggî.h
"

21 
	~"msg.h
"

22 
	~"queue.h
"

23 
	~"unicode.h
"

25 *
°¨t_pﬁl_msg
(*
msg_li°
);

26 
lwqq_ªcvmsg_pﬁl_msg
(
LwqqRecvMsgLi°
 *
li°
);

27 
js⁄_t
 *
gë_ªsu…_js⁄_obje˘
(js⁄_à*
js⁄
);

28 
∑r£_ªcvmsg_‰om_js⁄
(
LwqqRecvMsgLi°
 *
li°
, c⁄° *
°r
);

30 
lwqq_msg_mesßge_‰ì
(*
›aque
);

31 
lwqq_msg_°©us_‰ì
(*
›aque
);

40 
LwqqRecvMsgLi°
 *
	$lwqq_ªcvmsg_√w
(*
˛õ¡
)

42 
LwqqRecvMsgLi°
 *
li°
;

44 
li°
 = 
	`s_mÆloc0
((*list));

45 
li°
->
lc
 = 
˛õ¡
;

46 
	`±hªad_muãx_öô
(&
li°
->
muãx
, 
NULL
);

47 
	`SIMPLEQ_INIT
(&
li°
->
hód
);

48 
li°
->
pﬁl_msg
 = 
lwqq_ªcvmsg_pﬁl_msg
;

50  
li°
;

51 
	}
}

58 
	$lwqq_ªcvmsg_‰ì
(
LwqqRecvMsgLi°
 *
li°
)

60 
LwqqRecvMsg
 *
ªcvmsg
;

62 i‡(!
li°
)

65 
	`±hªad_muãx_lock
(&
li°
->
muãx
);

66 (
ªcvmsg
 = 
	`SIMPLEQ_FIRST
(&
li°
->
hód
))) {

67 
	`SIMPLEQ_REMOVE_HEAD
(&
li°
->
hód
, 
íåõs
);

68 
	`lwqq_msg_‰ì
(
ªcvmsg
->
msg
);

69 
	`s_‰ì
(
ªcvmsg
);

71 
	`±hªad_muãx_u∆ock
(&
li°
->
muãx
);

73 
	`s_‰ì
(
li°
);

75 
	}
}

77 
LwqqMsg
 *
	$lwqq_msg_√w
(
LwqqMsgTy≥
 
ty≥
)

79 
LwqqMsg
 *
msg
 = 
NULL
;

81 
msg
 = 
	`s_mÆloc0
((*msg));

82 
msg
->
ty≥
 =Åype;

84 
ty≥
) {

85 
LWQQ_MT_BUDDY_MSG
:

86 
LWQQ_MT_GROUP_MSG
:

87 
msg
->
›aque
 = 
	`s_mÆloc0
((
LwqqMsgMesßge
));

88 
	`TAILQ_INIT
(&((
LwqqMsgMesßge
*)
msg
->
›aque
)->
c⁄ã¡
);

90 
LWQQ_MT_STATUS_CHANGE
:

91 
msg
->
›aque
 = 
	`s_mÆloc0
((
LwqqMsgSètusCh™ge
));

93 
LWQQ_MT_KICK_MESSAGE
:

94 
msg
->
›aque
 = 
	`s_mÆloc0
((
LwqqMsgKickMesßge
));

97 
	`lwqq_log
(
LOG_ERROR
, "No such messageÅype\n");

98 
Áûed
;

102  
msg
;

103 
Áûed
:

104 
	`lwqq_msg_‰ì
(
msg
);

105  
NULL
;

106 
	}
}

108 
	$lwqq_msg_mesßge_‰ì
(*
›aque
)

110 
LwqqMsgMesßge
 *
msg
 = 
›aque
;

111 i‡(!
msg
) {

115 
	`s_‰ì
(
msg
->
‰om
);

116 
	`s_‰ì
(
msg
->
to
);

117 
	`s_‰ì
(
msg
->
f_«me
);

118 
	`s_‰ì
(
msg
->
f_cﬁ‹
);

120 
LwqqMsgC⁄ã¡
 *
c
;

121 
	`TAILQ_FOREACH
(
c
, &
msg
->
c⁄ã¡
, 
íåõs
) {

122 i‡(
c
->
ty≥
 =
LWQQ_CONTENT_STRING
) {

123 
	`s_‰ì
(
c
->
d©a
.
°r
);

125 
	`s_‰ì
(
c
);

128 
	`s_‰ì
(
msg
);

129 
	}
}

131 
	$lwqq_msg_°©us_‰ì
(*
›aque
)

133 
LwqqMsgSètusCh™ge
 *
s
 = 
›aque
;

134 i‡(!
s
) {

138 
	`s_‰ì
(
s
->
who
);

139 
	`s_‰ì
(
s
);

140 
	}
}

142 
	$lwqq_msg_kick_‰ì
(*
›aque
)

144 
LwqqMsgKickMesßge
 *
kick
 = 
›aque
;

146 i‡(!
kick
) {

150 
	`s_‰ì
(
kick
->
ªas⁄
);

151 
	`s_‰ì
(
kick
->
way
);

152 
	`s_‰ì
(
kick
);

153 
	}
}

160 
	$lwqq_msg_‰ì
(
LwqqMsg
 *
msg
)

162 i‡(!
msg
)

165 
msg
->
ty≥
) {

166 
LWQQ_MT_BUDDY_MSG
:

167 
LWQQ_MT_GROUP_MSG
:

168 
	`lwqq_msg_mesßge_‰ì
(
msg
->
›aque
);

170 
LWQQ_MT_STATUS_CHANGE
:

171 
	`lwqq_msg_°©us_‰ì
(
msg
->
›aque
);

173 
LWQQ_MT_KICK_MESSAGE
:

174 
	`lwqq_msg_kick_‰ì
(
msg
->
›aque
);

177 
	`lwqq_log
(
LOG_ERROR
, "No such messageÅype\n");

181 
	`s_‰ì
(
msg
);

182 
	}
}

191 
js⁄_t
 *
	$gë_ªsu…_js⁄_obje˘
(
js⁄_t
 *
js⁄
)

193 
js⁄_t
 *
js⁄_tmp
;

194 *
vÆue
;

200 
vÆue
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, "retcode");

201 i‡(!
vÆue
 || 
	`°rcmp
(value, "0")) {

202 
Áûed
 ;

208 
js⁄_tmp
 = 
	`js⁄_föd_fú°_œbñ_Æl
(
js⁄
, "result");

209 i‡(!
js⁄_tmp
) {

210 
Áûed
;

213  
js⁄_tmp
;

215 
Áûed
:

216  
NULL
;

217 
	}
}

219 
LwqqMsgTy≥
 
	$∑r£_ªcvmsg_ty≥
(
js⁄_t
 *
js⁄
)

221 
LwqqMsgTy≥
 
ty≥
 = 
LWQQ_MT_UNKNOWN
;

222 *
msg_ty≥
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, "poll_type");

223 i‡(!
msg_ty≥
) {

224  
ty≥
;

226 i‡(!
	`°∫cmp
(
msg_ty≥
, "mesßge", 
	`°æí
("message"))) {

227 
ty≥
 = 
LWQQ_MT_BUDDY_MSG
;

228 } i‡(!
	`°∫cmp
(
msg_ty≥
, "group_mesßge", 
	`°æí
("group_message"))) {

229 
ty≥
 = 
LWQQ_MT_GROUP_MSG
;

230 } i‡(!
	`°∫cmp
(
msg_ty≥
, "buddies_status_change",

231 
	`°æí
("buddies_status_change"))) {

232 
ty≥
 = 
LWQQ_MT_STATUS_CHANGE
;

233 } i‡(!
	`°∫cmp
(
msg_ty≥
,"kick_mesßge",
	`°æí
("kick_message"))){

234 
ty≥
 = 
LWQQ_MT_KICK_MESSAGE
;

236  
ty≥
;

237 
	}
}

239 
	$∑r£_c⁄ã¡
(
js⁄_t
 *
js⁄
, *
›aque
)

241 
js⁄_t
 *
tmp
, *
˘ít
;

242 
LwqqMsgMesßge
 *
msg
 = 
›aque
;

244 
tmp
 = 
	`js⁄_föd_fú°_œbñ_Æl
(
js⁄
, "content");

245 i‡(!
tmp
 || !tmp->
chûd
 || !tmp->child) {

248 
tmp
 =Åmp->
chûd
->child;

249 
˘ít
 = 
tmp
; cã¡ !
NULL
; cã¡ = cã¡->
√xt
) {

250 i‡(
˘ít
->
ty≥
 =
JSON_ARRAY
) {

252 *
buf
;

254 
buf
 = 
˘ít
->
chûd
->
ãxt
;

255 i‡(!
	`°rcmp
(
buf
, "font")) {

256 c⁄° *
«me
, *
cﬁ‹
, *
size
;

257 
ß
, 
sb
, 
sc
;

259 
«me
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
˘ít
, "name");

260 
«me
 =Çame ?: "Arial";

261 
msg
->
f_«me
 = 
	`ucs4toutf8
(
«me
);

264 
cﬁ‹
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
˘ít
, "color");

265 
cﬁ‹
 = color ?: "000000";

266 
msg
->
f_cﬁ‹
 = 
	`s_°rdup
(
cﬁ‹
);

269 
size
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
˘ít
, "size");

270 
size
 = size ?: "12";

271 
msg
->
f_size
 = 
	`©oi
(
size
);

274 
tmp
 = 
	`js⁄_föd_fú°_œbñ_Æl
(
˘ít
, "style");

275 i‡(
tmp
) {

276 
js⁄_t
 *
°yÀ
 = 
tmp
->
chûd
->child;

277 c⁄° *
°yÀ°r
 = 
°yÀ
->
ãxt
;

278 
ß
 = ()
	`°πﬁ
(
°yÀ°r
, 
NULL
, 10);

279 
°yÀ
 = styÀ->
√xt
;

280 
°yÀ°r
 = 
°yÀ
->
ãxt
;

281 
sb
 = ()
	`°πﬁ
(
°yÀ°r
, 
NULL
, 10);

282 
°yÀ
 = styÀ->
√xt
;

283 
°yÀ°r
 = 
°yÀ
->
ãxt
;

284 
sc
 = ()
	`°πﬁ
(
°yÀ°r
, 
NULL
, 10);

286 
ß
 = 0;

287 
sb
 = 0;

288 
sc
 = 0;

290 
msg
->
f_°yÀ
.
a
 = 
ß
;

291 
msg
->
f_°yÀ
.
b
 = 
sb
;

292 
msg
->
f_°yÀ
.
b
 = 
sc
;

293 } i‡(!
	`°rcmp
(
buf
, "face")) {

296 
Á˚num
 = ()
	`°πﬁ
(
˘ít
->
chûd
->
√xt
->
ãxt
, 
NULL
, 10);

297 
LwqqMsgC⁄ã¡
 *
c
 = 
	`s_mÆloc0
((*c));

298 
c
->
ty≥
 = 
LWQQ_CONTENT_FACE
;

299 
c
->
d©a
.
Á˚
 = 
Á˚num
;

300 
	`TAILQ_INSERT_TAIL
(&
msg
->
c⁄ã¡
, 
c
, 
íåõs
);

302 } i‡(
˘ít
->
ty≥
 =
JSON_STRING
) {

303 
LwqqMsgC⁄ã¡
 *
c
 = 
	`s_mÆloc0
((*c));

304 
c
->
ty≥
 = 
LWQQ_CONTENT_STRING
;

305 
c
->
d©a
.
°r
 = 
	`ucs4toutf8
(
˘ít
->
ãxt
);

306 
	`TAILQ_INSERT_TAIL
(&
msg
->
c⁄ã¡
, 
c
, 
íåõs
);

311 i‡(!
msg
->
f_«me
 || !msg->
f_cﬁ‹
 || 
	`TAILQ_EMPTY
(&msg->
c⁄ã¡
)) {

314 i‡(
msg
->
f_size
 < 10) {

315 
msg
->
f_size
 = 10;

319 
	}
}

332 
	$∑r£_√w_msg
(
js⁄_t
 *
js⁄
, *
›aque
)

334 
LwqqMsgMesßge
 *
msg
 = 
›aque
;

335 *
time
;

337 
msg
->
‰om
 = 
	`s_°rdup
(
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, "from_uin"));

338 i‡(!
msg
->
‰om
) {

342 
time
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, "time");

343 
time
 =Åime ?: "0";

344 
msg
->
time
 = (
time_t
)
	`°πﬁl
—ime, 
NULL
, 10);

346 
msg
->
to
 = 
	`s_°rdup
(
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, "to_uin"));

347 i‡(!
msg
->
to
) {

351 i‡(
	`∑r£_c⁄ã¡
(
js⁄
, 
›aque
)) {

356 
	}
}

367 
	$∑r£_°©us_ch™ge
(
js⁄_t
 *
js⁄
, *
›aque
)

369 
LwqqMsgSètusCh™ge
 *
msg
 = 
›aque
;

370 *
c_ty≥
;

372 
msg
->
who
 = 
	`s_°rdup
(
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, "uin"));

373 i‡(!
msg
->
who
) {

376 
msg
->
°©us
 = 
	`s_°rdup
(
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, "status"));

377 i‡(!
msg
->
°©us
) {

380 
c_ty≥
 = 
	`s_°rdup
(
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
, "client_type"));

381 
c_ty≥
 = c_type ?: "1";

382 
msg
->
˛õ¡_ty≥
 = 
	`©oi
(
c_ty≥
);

385 
	}
}

396 
	$∑r£_kick_mesßge
(
js⁄_t
 *
js⁄
,*
›aque
)

398 
LwqqMsgKickMesßge
 *
msg
 = 
›aque
;

399 * 
show
;

400 
show
 = 
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
,"show_reason");

401 if(
show
)
msg
->
show_ªas⁄
 = 
	`©oi
(show);

402 
msg
->
ªas⁄
 = 
	`ucs4toutf8
(
	`js⁄_∑r£_sim∂e_vÆue
(
js⁄
,"reason"));

403 if(!
msg
->
ªas⁄
){

404 if(!
show
Ë
msg
->
show_ªas⁄
 = 0;

408 
	}
}

422 
	$∑r£_ªcvmsg_‰om_js⁄
(
LwqqRecvMsgLi°
 *
li°
, c⁄° *
°r
)

424 
ªt
;

425 
js⁄_t
 *
js⁄
 = 
NULL
, *
js⁄_tmp
, *
cur
;

427 
ªt
 = 
	`js⁄_∑r£_documít
(&
js⁄
, (*)
°r
);

428 i‡(
ªt
 !
JSON_OK
) {

429 
	`lwqq_log
(
LOG_ERROR
, "P¨£ js⁄ obje˘ o‡‰õnd†îr‹: %s\n", 
°r
);

430 
d⁄e
;

433 
js⁄_tmp
 = 
	`gë_ªsu…_js⁄_obje˘
(
js⁄
);

434 i‡(!
js⁄_tmp
) {

435 
	`lwqq_log
(
LOG_ERROR
, "P¨£ js⁄ obje˘Éº‹: %s\n", 
°r
);

436 
d⁄e
;

439 i‡(!
js⁄_tmp
->
chûd
 || !json_tmp->child->child) {

440 
d⁄e
;

444 
js⁄_tmp
 = js⁄_tmp->
chûd
->child;

445 
cur
 = 
js⁄_tmp
; cu∏!
NULL
; cu∏cur->
√xt
) {

446 
LwqqMsg
 *
msg
 = 
NULL
;

447 
LwqqMsgTy≥
 
msg_ty≥
;

448 
ªt
;

450 
msg_ty≥
 = 
	`∑r£_ªcvmsg_ty≥
(
cur
);

451 
msg
 = 
	`lwqq_msg_√w
(
msg_ty≥
);

452 i‡(!
msg
) {

456 
msg_ty≥
) {

457 
LWQQ_MT_BUDDY_MSG
:

458 
LWQQ_MT_GROUP_MSG
:

459 
ªt
 = 
	`∑r£_√w_msg
(
cur
, 
msg
->
›aque
);

461 
LWQQ_MT_STATUS_CHANGE
:

462 
ªt
 = 
	`∑r£_°©us_ch™ge
(
cur
, 
msg
->
›aque
);

464 
LWQQ_MT_KICK_MESSAGE
:

465 
ªt
 = 
	`∑r£_kick_mesßge
(
cur
,
msg
->
›aque
);

468 
ªt
 = -1;

469 
	`lwqq_log
(
LOG_ERROR
, "No such messageÅype\n");

473 i‡(
ªt
 == 0) {

474 
LwqqRecvMsg
 *
rmsg
 = 
	`s_mÆloc0
((*rmsg));

475 
rmsg
->
msg
 = msg;

477 
	`±hªad_muãx_lock
(&
li°
->
muãx
);

478 
	`SIMPLEQ_INSERT_TAIL
(&
li°
->
hód
, 
rmsg
, 
íåõs
);

479 
	`±hªad_muãx_u∆ock
(&
li°
->
muãx
);

481 
	`lwqq_msg_‰ì
(
msg
);

485 
d⁄e
:

486 i‡(
js⁄
) {

487 
	`js⁄_‰ì_vÆue
(&
js⁄
);

489 
	}
}

496 *
	$°¨t_pﬁl_msg
(*
msg_li°
)

498 
LwqqClõ¡
 *
lc
;

499 
LwqqHâpReque°
 *
ªq
 = 
NULL
;

500 
ªt
;

501 *
cookõs
;

502 *
s
;

503 
msg
[1024];

504 
LwqqRecvMsgLi°
 *
li°
;

506 
li°
 = (
LwqqRecvMsgLi°
 *)
msg_li°
;

507 
lc
 = (
LwqqClõ¡
 *)(
li°
->lc);

508 i‡(!
lc
) {

509 
Áûed
;

511 
	`¢¥ötf
(
msg
, (msg), "{\"clientid\":\"%s\",\"psessionid\":\"%s\"}",

512 
lc
->
˛õ¡id
,Üc->
p£ssi⁄id
);

513 
s
 = 
	`uæ_ícode
(
msg
);

514 
	`¢¥ötf
(
msg
, (msg), "r=%s", 
s
);

515 
	`s_‰ì
(
s
);

518 
uæ
[512];

519 
	`¢¥ötf
(
uæ
, (url), "%s/channel/poll2", "http://d.web2.qq.com");

520 
ªq
 = 
	`lwqq_hâp_¸óã_deÁu…_ªque°
(
uæ
, 
NULL
);

521 i‡(!
ªq
) {

522 
Áûed
;

524 
ªq
->
	`£t_hódî
(req, "Referer", "http://d.web2.qq.com/proxy.html?v=20101025002");

525 
ªq
->
	`£t_hódî
(req, "Content-Transfer-Encoding", "binary");

526 
ªq
->
	`£t_hódî
(req, "Content-type", "application/x-www-form-urlencoded");

527 
cookõs
 = 
	`lwqq_gë_cookõs
(
lc
);

528 i‡(
cookõs
) {

529 
ªq
->
	`£t_hódî
‘eq, "Cookõ", 
cookõs
);

530 
	`s_‰ì
(
cookõs
);

533 
ªt
 = 
ªq
->
	`do_ªque°
‘eq, 1, 
msg
);

534 i‡(
ªt
 || 
ªq
->
hâp_code
 != 200) {

537 
	`∑r£_ªcvmsg_‰om_js⁄
(
li°
, 
ªq
->
ª•⁄£
);

539 
Áûed
:

540 
	`±hªad_exô
(
NULL
);

541 
	}
}

543 
	$lwqq_ªcvmsg_pﬁl_msg
(
LwqqRecvMsgLi°
 *
li°
)

545 
±hªad_t
 
tid
;

546 
±hªad_©å_t
 
©å
;

548 
	`±hªad_©å_öô
(&
©å
);

549 
	`±hªad_©å_£tdëach°©e
(&
©å
, 
PTHREAD_CREATE_DETACHED
);

551 
	`±hªad_¸óã
(&
tid
, &
©å
, 
°¨t_pﬁl_msg
, 
li°
);

552 
	}
}

555 *
	$¸óã_deÁu…_c⁄ã¡
(c⁄° *
c⁄ã¡
)

557 
s
[2048];

559 
	`¢¥ötf
(
s
, (s), "\"[\\\"%s\\\\n\\\",[\\\"font\\\","

561 "\\\"°yÀ\\\":[0,0,0],\\\"cﬁ‹\\\":\\\"000000\\\"}]]\"", 
c⁄ã¡
);

562  
	`°rdup
(
s
);

563 
	}
}

573 
	$lwqq_msg_£nd
(*
˛õ¡
, 
LwqqMsg
 *
msg
)

575 
ªt
;

576 
LwqqHâpReque°
 *
ªq
 = 
NULL
;

577 *
cookõs
;

578 *
s
;

579 *
c⁄ã¡
 = 
NULL
;

580 
d©a
[1024];

581 
LwqqMsgMesßge
 *
mmsg
;

582 
LwqqMsgC⁄ã¡
 *
c
;

583 
°r
[1024] = {0};

584 
LwqqClõ¡
 *
lc
 = 
˛õ¡
;

586 i‡(!
msg
 || (msg->
ty≥
 !
LWQQ_MT_BUDDY_MSG
 &&

587 
msg
->
ty≥
 !
LWQQ_MT_GROUP_MSG
)) {

588 
Áûed
;

590 
mmsg
 = 
msg
->
›aque
;

591 
	`TAILQ_FOREACH
(
c
, &
mmsg
->
c⁄ã¡
, 
íåõs
) {

592 i‡(
c
->
ty≥
 =
LWQQ_CONTENT_STRING
) {

593 
	`°rˇt
(
°r
, 
c
->
d©a
.str);

596 i‡(!
	`°æí
(
°r
)) {

597 
Áûed
;

599 
c⁄ã¡
 = 
	`¸óã_deÁu…_c⁄ã¡
(
°r
);

600 
	`¢¥ötf
(
d©a
, (data), "{\"to\":%s,\"face\":0,\"content\":%s,"

602 
mmsg
->
to
, 
c⁄ã¡
, 
lc
->
msg_id
,Üc->
˛õ¡id
,Üc->
p£ssi⁄id
);

603 
	`s_‰ì
(
c⁄ã¡
);

604 
s
 = 
	`uæ_ícode
(
d©a
);

605 
	`¢¥ötf
(
d©a
, (d©a), "r=%s", 
s
);

606 
	`s_‰ì
(
s
);

609 
uæ
[512];

610 
	`¢¥ötf
(
uæ
, (url), "%s/channel/send_buddy_msg2", "http://d.web2.qq.com");

611 
ªq
 = 
	`lwqq_hâp_¸óã_deÁu…_ªque°
(
uæ
, 
NULL
);

612 i‡(!
ªq
) {

613 
Áûed
;

615 
ªq
->
	`£t_hódî
(req, "Referer", "http://d.web2.qq.com/proxy.html?v=20101025002");

616 
ªq
->
	`£t_hódî
(req, "Content-Transfer-Encoding", "binary");

617 
ªq
->
	`£t_hódî
(req, "Content-type", "application/x-www-form-urlencoded");

618 
cookõs
 = 
	`lwqq_gë_cookõs
(
lc
);

619 i‡(
cookõs
) {

620 
ªq
->
	`£t_hódî
‘eq, "Cookõ", 
cookõs
);

621 
	`s_‰ì
(
cookõs
);

624 
ªt
 = 
ªq
->
	`do_ªque°
‘eq, 1, 
d©a
);

625 i‡(
ªt
 || 
ªq
->
hâp_code
 != 200) {

626 
Áûed
;

630 
Áûed
:

631 
	`lwqq_hâp_ªque°_‰ì
(
ªq
);

633 
	}
}

635 
	$lwqq_msg_£nd2
(*
˛õ¡
, c⁄° *
to
, c⁄° *
c⁄ã¡
)

637 
ªt
 = 0;

638 
LwqqMsg
 *
msg
 = 
NULL
;

639 
LwqqMsgMesßge
 *
mmsg
 = 
NULL
;

640 
LwqqMsgC⁄ã¡
 *
c
 = 
NULL
;

641 
LwqqClõ¡
 *
lc
 = 
˛õ¡
;

643 i‡(!
lc
 || !
to
 || !
c⁄ã¡
) {

647 
msg
 = 
	`lwqq_msg_√w
(
LWQQ_MT_BUDDY_MSG
);

648 i‡(!
msg
) {

652 
mmsg
 = 
msg
->
›aque
;

653 
mmsg
->
to
 = 
	`s_°rdup
(to);

654 
c
 = 
	`s_mÆloc0
((*c));

655 
c
->
ty≥
 = 
LWQQ_CONTENT_STRING
;

656 
c
->
d©a
.
°r
 = 
	`s_°rdup
(
c⁄ã¡
);

657 
	`TAILQ_INSERT_HEAD
(&
mmsg
->
c⁄ã¡
, 
c
, 
íåõs
);

659 
ªt
 = 
	`lwqq_msg_£nd
(
lc
, 
msg
);

660 
	`lwqq_msg_‰ì
(
msg
);

661  
ªt
;

662 
	}
}

	@src/liblwqq/smemory.c

11 
	#_GNU_SOURCE


	)

12 
	~<°dio.h
>

13 
	~<°dlib.h
>

14 
	~<°d¨g.h
>

15 
	~<°rög.h
>

17 *
	$s_mÆloc
(
size_t
 
size
)

19 if(
size
 == 0)

20  
NULL
;

22  
	`mÆloc
(
size
);

23 
	}
}

25 *
	$s_mÆloc0
(
size_t
 
size
)

27 i‡(
size
 == 0)

28  
NULL
;

30 *
±r
 = 
	`mÆloc
(
size
);

31 i‡(
±r
)

32 
	`mem£t
(
±r
, 0, 
size
);

34  
±r
;

35 
	}
}

37 *
	$s_ˇŒoc
(
size_t
 
nmemb
, size_à
lsize
)

39  
	`ˇŒoc
(
nmemb
, 
lsize
);

40 
	}
}

42 *
	$s_ªÆloc
(*
±r
, 
size_t
 
size
)

44  
	`ªÆloc
(
±r
, 
size
);

45 
	}
}

47 
	$s_‰ì
(*
±r
)

49 i‡(
±r
)

50 
	`‰ì
(
±r
);

51 
	}
}

53 *
	$s_°rdup
(c⁄° *
s1
)

55 i‡(!
s1
)

56  
NULL
;

58  
	`°rdup
(
s1
);

59 
	}
}

61 *
	$s_°∫dup
(c⁄° *
s1
, 
size_t
 
n
)

63 i‡(!
s1
)

64  
NULL
;

66  
	`°∫dup
(
s1
, 
n
);

67 
	}
}

69 
	$s_va•rötf
(**
buf
, c⁄° * 
f‹m©
,

70 
va_li°
 
¨g
)

72  
	`va•rötf
(
buf
, 
f‹m©
, 
¨g
);

73 
	}
}

75 
	$s_a•rötf
(**
buf
, c⁄° *
f‹m©
, ...)

77 
va_li°
 
¨g
;

78 
rv
;

80 
	`va_°¨t
(
¨g
, 
f‹m©
);

81 
rv
 = 
	`s_va•rötf
(
buf
, 
f‹m©
, 
¨g
);

82 
	`va_íd
(
¨g
);

84  
rv
;

85 
	}
}

	@src/liblwqq/type.c

11 
	~<°rög.h
>

12 
	~<sys/time.h
>

13 
	~"ty≥.h
"

14 
	~"smem‹y.h
"

15 
	~"loggî.h
"

16 
	~"msg.h
"

26 
LwqqClõ¡
 *
	$lwqq_˛õ¡_√w
(c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

28 
timevÆ
 
tv
;

29 
v
;

31 i‡(!
u£∫ame
 || !
∑ssw‹d
) {

32 
	`lwqq_log
(
LOG_ERROR
, "Username orÖassword isÇull\n");

33  
NULL
;

36 
LwqqClõ¡
 *
lc
 = 
	`s_mÆloc0
((*lc));

37 
lc
->
u£∫ame
 = 
	`s_°rdup
(username);

38 
lc
->
∑ssw‹d
 = 
	`s_°rdup
(password);

39 
lc
->
my£lf
 = 
	`lwqq_buddy_√w
();

40 i‡(!
lc
->
my£lf
) {

41 
Áûed
;

43 
lc
->
my£lf
->
qqnumbî
 = 
	`s_°rdup
(
u£∫ame
);

44 
lc
->
my£lf
->
uö
 = 
	`s_°rdup
(
u£∫ame
);

46 
lc
->
cookõs
 = 
	`s_mÆloc0
((*(lc->cookies)));

48 
lc
->
msg_li°
 = 
	`lwqq_ªcvmsg_√w
(lc);

51 
	`gëtimeofday
(&
tv
, 
NULL
);

52 
v
 = 
tv
.
tv_u£c
;

53 
v
 = (v - v % 1000) / 1000;

54 
v
 = v % 10000 * 10000;

55 
lc
->
msg_id
 = 
v
;

57 
	`lwqq_log
(
LOG_DEBUG
, "CreateáÇew client with username:%s,Öassword:%s "

58 "suc˚ssfuŒy\n", 
lc
->
u£∫ame
,Üc->
∑ssw‹d
);

59  
lc
;

61 
Áûed
:

62 
	`lwqq_˛õ¡_‰ì
(
lc
);

63  
NULL
;

64 
	}
}

73 *
	$lwqq_gë_cookõs
(
LwqqClõ¡
 *
lc
)

75 i‡(
lc
->
cookõs
 &&Üc->cookõs->
lwcookõs
) {

76  
	`s_°rdup
(
lc
->
cookõs
->
lwcookõs
);

79  
NULL
;

80 
	}
}

82 
	$lwqq_vc_‰ì
(
LwqqVîifyCode
 *
vc
)

84 i‡(
vc
) {

85 
	`s_‰ì
(
vc
->
°r
);

86 
	`s_‰ì
(
vc
->
ty≥
);

87 
	`s_‰ì
(
vc
->
img
);

88 
	`s_‰ì
(
vc
->
uö
);

89 
	`s_‰ì
(
vc
);

91 
	}
}

93 
	$cookõs_‰ì
(
LwqqCookõs
 *
c
)

95 i‡(
c
) {

96 
	`s_‰ì
(
c
->
±vf£ssi⁄
);

97 
	`s_‰ì
(
c
->
±cz
);

98 
	`s_‰ì
(
c
->
skey
);

99 
	`s_‰ì
(
c
->
±webqq
);

100 
	`s_‰ì
(
c
->
±u£röfo
);

101 
	`s_‰ì
(
c
->
uö
);

102 
	`s_‰ì
(
c
->
±i•
);

103 
	`s_‰ì
(
c
->
±2gguö
);

104 
	`s_‰ì
(
c
->
vîify£ssi⁄
);

105 
	`s_‰ì
(
c
->
lwcookõs
);

106 
	`s_‰ì
(
c
);

108 
	}
}

110 
	$lwqq_ˇãg‹õs_‰ì
(
LwqqFrõndC©eg‹y
 *
ˇã
)

112 i‡(!
ˇã
)

115 
	`s_‰ì
(
ˇã
->
«me
);

116 
	`s_‰ì
(
ˇã
);

117 
	}
}

124 
	$lwqq_˛õ¡_‰ì
(
LwqqClõ¡
 *
˛õ¡
)

126 
LwqqBuddy
 *
b_íåy
, *
b_√xt
;

127 
LwqqFrõndC©eg‹y
 *
c_íåy
, *
c_√xt
;

128 
LwqqGroup
 *
g_íåy
, *
g_√xt
;

130 i‡(!
˛õ¡
)

134 
	`s_‰ì
(
˛õ¡
->
u£∫ame
);

135 
	`s_‰ì
(
˛õ¡
->
∑ssw‹d
);

136 
	`s_‰ì
(
˛õ¡
->
vîsi⁄
);

137 
	`lwqq_vc_‰ì
(
˛õ¡
->
vc
);

138 
	`cookõs_‰ì
(
˛õ¡
->
cookõs
);

139 
	`s_‰ì
(
˛õ¡
->
˛õ¡id
);

140 
	`s_‰ì
(
˛õ¡
->
£skey
);

141 
	`s_‰ì
(
˛õ¡
->
cù
);

142 
	`s_‰ì
(
˛õ¡
->
ödex
);

143 
	`s_‰ì
(
˛õ¡
->
p‹t
);

144 
	`s_‰ì
(
˛õ¡
->
°©us
);

145 
	`s_‰ì
(
˛õ¡
->
vfwebqq
);

146 
	`s_‰ì
(
˛õ¡
->
p£ssi⁄id
);

147 
	`lwqq_buddy_‰ì
(
˛õ¡
->
my£lf
);

150 
	`LIST_FOREACH_SAFE
(
b_íåy
, &
˛õ¡
->
‰õnds
, 
íåõs
, 
b_√xt
) {

151 
	`LIST_REMOVE
(
b_íåy
, 
íåõs
);

152 
	`lwqq_buddy_‰ì
(
b_íåy
);

156 
	`LIST_FOREACH_SAFE
(
c_íåy
, &
˛õ¡
->
ˇãg‹õs
, 
íåõs
, 
c_√xt
) {

157 
	`LIST_REMOVE
(
c_íåy
, 
íåõs
);

158 
	`lwqq_ˇãg‹õs_‰ì
(
c_íåy
);

163 
	`LIST_FOREACH_SAFE
(
g_íåy
, &
˛õ¡
->
groups
, 
íåõs
, 
g_√xt
) {

164 
	`LIST_REMOVE
(
g_íåy
, 
íåõs
);

165 
	`lwqq_group_‰ì
(
g_íåy
);

169 
	`lwqq_ªcvmsg_‰ì
(
˛õ¡
->
msg_li°
);

170 
	`s_‰ì
(
˛õ¡
);

171 
	}
}

182 
LwqqBuddy
 *
	$lwqq_buddy_√w
()

184 
LwqqBuddy
 *
b
 = 
	`s_mÆloc0
((*b));

185  
b
;

186 
	}
}

193 
	$lwqq_buddy_‰ì
(
LwqqBuddy
 *
buddy
)

195 i‡(!
buddy
)

198 
	`s_‰ì
(
buddy
->
uö
);

199 
	`s_‰ì
(
buddy
->
qqnumbî
);

200 
	`s_‰ì
(
buddy
->
Á˚
);

201 
	`s_‰ì
(
buddy
->
occu∑ti⁄
);

202 
	`s_‰ì
(
buddy
->
ph⁄e
);

203 
	`s_‰ì
(
buddy
->
Ælow
);

204 
	`s_‰ì
(
buddy
->
cﬁÀge
);

205 
	`s_‰ì
(
buddy
->
ªg_time
);

206 
	`s_‰ì
(
buddy
->
c⁄°ñ
);

207 
	`s_‰ì
(
buddy
->
blood
);

208 
	`s_‰ì
(
buddy
->
homïage
);

209 
	`s_‰ì
(
buddy
->
°©
);

210 
	`s_‰ì
(
buddy
->
cou¡ry
);

211 
	`s_‰ì
(
buddy
->
côy
);

212 
	`s_‰ì
(
buddy
->
≥rs⁄Æ
);

213 
	`s_‰ì
(
buddy
->
nick
);

214 
	`s_‰ì
(
buddy
->
l⁄g_nick
);

215 
	`s_‰ì
(
buddy
->
shígxüo
);

216 
	`s_‰ì
(
buddy
->
emaû
);

217 
	`s_‰ì
(
buddy
->
¥ovö˚
);

218 
	`s_‰ì
(
buddy
->
gídî
);

219 
	`s_‰ì
(
buddy
->
mobûe
);

220 
	`s_‰ì
(
buddy
->
vù_öfo
);

221 
	`s_‰ì
(
buddy
->
m¨k«me
);

222 
	`s_‰ì
(
buddy
->
Êag
);

223 
	`s_‰ì
(
buddy
->
ˇã_ödex
);

224 
	`s_‰ì
(
buddy
->
˛õ¡_ty≥
);

226 
	`s_‰ì
(
buddy
->
°©us
);

228 
	`s_‰ì
(
buddy
);

229 
	}
}

239 
LwqqBuddy
 *
	$lwqq_buddy_föd_buddy_by_uö
(
LwqqClõ¡
 *
lc
, c⁄° *
uö
)

241 
LwqqBuddy
 *
buddy
;

243 i‡(!
lc
 || !
uö
)

244  
NULL
;

246 
	`LIST_FOREACH
(
buddy
, &
lc
->
‰õnds
, 
íåõs
) {

247 i‡(
buddy
->
uö
 && (
	`°rcmp
(buddy->uin, uin) == 0))

248  
buddy
;

251  
NULL
;

252 
	}
}

262 
LwqqGroup
 *
	$lwqq_group_√w
()

264 
LwqqGroup
 *
g
 = 
	`s_mÆloc0
((*g));

265  
g
;

266 
	}
}

273 
	$lwqq_group_‰ì
(
LwqqGroup
 *
group
)

275 
LwqqBuddy
 *
m_íåy
, *
m_√xt
;

276 i‡(!
group
)

279 
	`s_‰ì
(
group
->
«me
);

280 
	`s_‰ì
(
group
->
gid
);

281 
	`s_‰ì
(
group
->
code
);

282 
	`s_‰ì
(
group
->
accou¡
);

283 
	`s_‰ì
(
group
->
m¨k«me
);

284 
	`s_‰ì
(
group
->
Á˚
);

285 
	`s_‰ì
(
group
->
memo
);

286 
	`s_‰ì
(
group
->
˛ass
);

287 
	`s_‰ì
(
group
->
fögîmemo
);

288 
	`s_‰ì
(
group
->
¸óãtime
);

289 
	`s_‰ì
(
group
->
Àvñ
);

290 
	`s_‰ì
(
group
->
ow√r
);

291 
	`s_‰ì
(
group
->
Êag
);

292 
	`s_‰ì
(
group
->
›ti⁄
);

295 
	`LIST_FOREACH_SAFE
(
m_íåy
, &
group
->
membîs
, 
íåõs
, 
m_√xt
) {

296 
	`LIST_REMOVE
(
m_íåy
, 
íåõs
);

297 
	`lwqq_buddy_‰ì
(
m_íåy
);

300 
	`s_‰ì
(
group
);

301 
	}
}

312 
LwqqGroup
 *
	$lwqq_group_föd_group_by_gid
(
LwqqClõ¡
 *
lc
, c⁄° *
gid
)

314 
LwqqGroup
 *
group
;

316 i‡(!
lc
 || !
gid
)

317  
NULL
;

319 
	`LIST_FOREACH
(
group
, &
lc
->
groups
, 
íåõs
) {

320 i‡(
group
->
gid
 && (
	`°rcmp
(group->gid, gid) == 0))

321  
group
;

324  
NULL
;

325 
	}
}

335 
LwqqBuddy
 *
	$lwqq_group_föd_group_membî_by_uö
(
LwqqGroup
 *
group
, c⁄° *
uö
)

337 
LwqqBuddy
 *
membî
;

339 i‡(!
group
 || !
uö
)

340  
NULL
;

342 
	`LIST_FOREACH
(
membî
, &
group
->
membîs
, 
íåõs
) {

343 i‡(
membî
->
uö
 && (
	`°rcmp
(member->uin, uin) == 0))

344  
membî
;

347  
NULL
;

348 
	}
}

	@src/liblwqq/unicode.c

12 
	~<°dio.h
>

13 
	~<°rög.h
>

14 
	~"smem‹y.h
"

16 
	$hex2ch¨
(
c
)

18 i‡(
c
 >= '0' && c <= '9') {

19  
c
 - '0';

22 i‡(
c
 >= 'a' && c <= 'f') {

23  
c
 - 'a' + 10;

26 i‡(
c
 >= 'A' && c <= 'F') {

27  
c
 - 'A' + 10;

31 
	}
}

49 *
	$do_ucs4toutf8
(c⁄° *
‰om
)

51 
°r
[5] = {0};

52 
i
;

54 
E
 = 0xe0;

55 
T
 = 0x02;

56 
£p1
 = 0x80;

57 
£p2
 = 0x800;

58 
£p3
 = 0x10000;

59 
£p4
 = 0x200000;

60 
£p5
 = 0x4000000;

62 
tmp
[4];

63 
ª
[6];

64 
ivÆue
 = 0;

66 
i
 = 0; i < 4; ++i) {

67 
tmp
[
i
] = 0x‡& 
	`hex2ch¨
(
‰om
[i + 2]);

68 
ivÆue
 *= 16;

69 
ivÆue
 +
tmp
[
i
];

73 i‡(
ivÆue
 < 
£p1
) {

75 
ª
[0] = 0x7‡& 
tmp
[3];

76 
°r
[0] = 
ª
[0];

77 } i‡(
ivÆue
 < 
£p2
) {

79 
ª
[0] = (0x3 << 6Ë| ((
tmp
[1] & 7) << 2) | (tmp[2] >> 2);

80 
ª
[1] = (0x1 << 7Ë| ((
tmp
[2] & 3) << 4) |Åmp[3];

81 
°r
[0] = 
ª
[0];

82 
°r
[1] = 
ª
[1];

83 } i‡(
ivÆue
 < 
£p3
) {

85 
ª
[0] = 
E
 | (
tmp
[0] & 0xf);

86 
ª
[1] = (
T
 << 6Ë| (
tmp
[1] << 2) | ((tmp[2] >> 2) & 0x3);

87 
ª
[2] = (
T
 << 6Ë| (
tmp
[2] & 0x3) << 4 |Åmp[3];

89 
i
 = 0; i < 3; ++i){

90 
°r
[
i
] = 
ª
[i];

92 } i‡(
ivÆue
 < 
£p4
) {

94 
ª
[0] = 0xf0 | ((
tmp
[1] >> 2) & 0x7);

95 
ª
[1] = 0x2 << 6 | ((
tmp
[1] & 0x3) << 4) | ((tmp[2] >> 4) & 0xf);

96 
ª
[2] = 0x2 << 6 | ((
tmp
[2] & 0xf) << 4) | ((tmp[3] >> 6) & 0x3);

97 
ª
[3] = 0x2 << 6 | (
tmp
[2] & 0x3f);

99 
i
 = 0; i < 4; ++i) {

100 
°r
[
i
] = 
ª
[i];

102 } i‡(
ivÆue
 < 
£p5
) {

104  
NULL
;

107  
NULL
;

110  
	`s_°rdup
(
°r
);

111 
	}
}

113 *
	$ucs4toutf8
(c⁄° *
‰om
)

115 i‡(!
‰om
) {

116  
NULL
;

119 *
out
 = 
NULL
;

120 
ouéí
 = 0;

121 c⁄° *
c
;

123 
c
 = 
‰om
; *c != '\0'; ++c) {

124 *
s
;

125 i‡(*
c
 == '\\' && *(c + 1) == 'u') {

126 
s
 = 
	`do_ucs4toutf8
(
c
);

127 
out
 = 
	`s_ªÆloc
(out, 
ouéí
 + 
	`°æí
(
s
) + 1);

128 
	`¢¥ötf
(
out
 + 
ouéí
, 
	`°æí
(
s
) + 1, "%s", s);

129 
ouéí
 = 
	`°æí
(
out
);

130 
	`s_‰ì
(
s
);

131 
c
 += 5;

133 
out
 = 
	`s_ªÆloc
(out, 
ouéí
 + 2);

134 
out
[
ouéí
] = *
c
;

135 
out
[
ouéí
 + 1] = '\0';

136 
ouéí
++;

141  
out
;

142 
	}
}

	@src/liblwqq/unicode.h

12 #i‚de‡
LWQQ_UNICODE_H


13 
	#LWQQ_UNICODE_H


	)

15 *
ucs4toutf8
(c⁄° *
‰om
);

	@src/liblwqq/url.c

12 
	~<°rög.h
>

13 
	~<˘y≥.h
>

16 
	$‰om_hex
(
ch
)

18  
	`isdigô
(
ch
Ë? ch - '0' : 
	`tﬁowî
(ch) - 'A' + 10;

19 
	}
}

22 
	$to_hex
(
code
)

24 
hex
[] = "0123456789ABCDEF";

25  
hex
[
code
 & 15];

26 
	}
}

35 *
	$uæ_ícode
(*
°r
)

37 i‡(!
°r
)

38  
NULL
;

40 *
p°r
 = 
°r
, *
buf
 = 
	`mÆloc
(
	`°æí
(°rË* 3 + 1), *
pbuf
 = buf;

41 *
p°r
) {

42 i‡(
	`iß um
(*
p°r
) || *pstr == '-' || *pstr == '_' || *pstr == '.' || *pstr == '~')

43 *
pbuf
++ = *
p°r
;

45 *
pbuf
++ = '%', *pbuf++ = 
	`to_hex
(*
p°r
 >> 4), *pbuf++ =Åo_hex(*pstr & 15);

46 
p°r
++;

48 *
pbuf
 = '\0';

49  
buf
;

50 
	}
}

59 *
	$uæ_decode
(*
°r
)

61 i‡(!
°r
) {

62  
NULL
;

64 *
p°r
 = 
°r
, *
buf
 = 
	`mÆloc
(
	`°æí
(°rË+ 1), *
pbuf
 = buf;

65 *
p°r
) {

66 i‡(*
p°r
 == '%') {

67 i‡(
p°r
[1] &&Östr[2]) {

68 *
pbuf
++ = 
	`‰om_hex
(
p°r
[1]) << 4 | from_hex(pstr[2]);

69 
p°r
 += 2;

71 } i‡(*
p°r
 == '+') {

72 *
pbuf
++ = ' ';

74 *
pbuf
++ = *
p°r
;

76 
p°r
++;

78 *
pbuf
 = '\0';

79  
buf
;

80 
	}
}

83 
	$maö
(
¨gc
, *
¨gv
[])

85 *
buf
 = 
	`uæ_ícode
("http://www.-go8ogle. com");

86 i‡(
buf
) {

87 
	`lwqq_log
(
LOG_NOTICE
, "Encodêd©a: %s\n", 
buf
);

89 
	`puts
(
buf
);

91 
	}
}

	@src/liblwqq/url.h

12 #i‚de‡
LWQQ_URL_H


13 
	#LWQQ_URL_H


	)

22 *
uæ_ícode
(*
°r
);

31 *
uæ_decode
(*
°r
);

	@src/lwdb/lwdb.c

17 
	~<°dlib.h
>

18 
	~<°rög.h
>

19 
	~<sqlôe3.h
>

20 
	~<uni°d.h
>

21 
	~<sys/°©.h
>

22 
	~<sys/ty≥s.h
>

24 
	~"smem‹y.h
"

25 
	~"loggî.h
"

26 
	~"swsqlôe.h
"

27 
	~"lwdb.h
"

29 
LwqqEº‹Code
 
lwdb_globÆdb_add_√w_u£r
(

30 
LwdbGlobÆDB
 *
db
, c⁄° *
qqnumbî
);

31 
LwdbGlobÆU£rE¡ry
 *
lwdb_globÆdb_quîy_u£r_öfo
(

32 
LwdbGlobÆDB
 *
db
, c⁄° *
qqnumbî
);

33 
LwqqEº‹Code
 
lwdb_globÆdb_upd©e_u£r_öfo
(

34 
LwdbGlobÆDB
 *
db
, c⁄° *
qqnumbî
,

35 c⁄° *
key
, c⁄° *
vÆue
);

37 
LwqqBuddy
 *
lwdb_u£rdb_quîy_buddy_öfo
(

38 
LwdbU£rDB
 *
db
, c⁄° *
qqnumbî
);

39 
LwqqEº‹Code
 
lwdb_u£rdb_upd©e_buddy_öfo
(

40 
LwdbU£rDB
 *
db
, 
LwqqBuddy
 *
buddy
);

42 *
	gd©aba£_∑th
;

43 *
	gglobÆ_d©aba£_«me
;

45 
	#LWDB_INIT_VERSION
 1001

	)

47 c⁄° *
	g¸óã_globÆ_db_sql
 =

60 c⁄° *
	g¸óã_u£r_db_sql
 =

96 
	$lwdb_öô
()

98 
buf
[256];

99 *
home
;

101 
home
 = 
	`gëív
("HOME");

102 i‡(!
home
) {

103 
	`lwqq_log
(
LOG_ERROR
, "Cant get $HOME,Éxit\n");

104 
	`exô
(1);

107 
	`¢¥ötf
(
buf
, (buf), "%s/.c⁄fig/lwqq", 
home
);

108 
d©aba£_∑th
 = 
	`s_°rdup
(
buf
);

109 i‡(
	`ac˚ss
(
d©aba£_∑th
, 
F_OK
)) {

111 
	`mkdú
(
d©aba£_∑th
, 0755);

114 
	`¢¥ötf
(
buf
, (buf), "%s/lwqq.db", 
d©aba£_∑th
);

115 
globÆ_d©aba£_«me
 = 
	`s_°rdup
(
buf
);

116 
	}
}

122 
	$lwdb_föÆize
()

124 
	`s_‰ì
(
d©aba£_∑th
);

125 
	`s_‰ì
(
globÆ_d©aba£_«me
);

126 
	}
}

137 
	$lwdb_¸óã_db
(c⁄° *
fûíame
, 
db_ty≥
)

139 
ªt
;

140 *
îrmsg
 = 
NULL
;

142 i‡(!
fûíame
) {

146 i‡(
	`ac˚ss
(
fûíame
, 
F_OK
) == 0) {

147 
	`lwqq_log
(
LOG_WARNING
, "Findá file whoseÇame is sameás file "

149 
	`u∆ök
(
fûíame
);

151 i‡(
db_ty≥
 == 0) {

152 
ªt
 = 
	`sws_exec_sql_dúe˘ly
(
fûíame
, 
¸óã_globÆ_db_sql
, &
îrmsg
);

153 } i‡(
db_ty≥
 == 1) {

154 
ªt
 = 
	`sws_exec_sql_dúe˘ly
(
fûíame
, 
¸óã_u£r_db_sql
, &
îrmsg
);

156 
ªt
 = -1;

159 i‡(
îrmsg
) {

160 
	`lwqq_log
(
LOG_ERROR
, "%s\n", 
îrmsg
);

161 
	`s_‰ì
(
îrmsg
);

163  
ªt
;

164 
	}
}

174 
	$db_is_vÆid
(c⁄° *
fûíame
, 
ty≥
)

176 
ªt
;

177 
SwsStmt
 *
°mt
 = 
NULL
;

178 
SwsDB
 *
db
 = 
NULL
;

179 *
sql
;

182 i‡(!
fûíame
 || 
	`ac˚ss
(fûíame, 
F_OK
)) {

183 
övÆid
;

187 
db
 = 
	`sws_›í_db
(
fûíame
, 
NULL
);

188 i‡(!
db
) {

189 
övÆid
;

193 i‡(
ty≥
 == 0) {

194 
sql
 = "SELECTÇame FROM sqlite_master WHEREÅype='table' ANDÇame='configs';";

196 
sql
 = "SELECTÇame FROM sqlite_master WHEREÅype='table' ANDÇame='buddies';";

198 
ªt
 = 
	`sws_quîy_°¨t
(
db
, 
sql
, &
°mt
, 
NULL
);

199 i‡(
ªt
) {

200 
övÆid
;

202 i‡(
	`sws_quîy_√xt
(
°mt
, 
NULL
)) {

203 
övÆid
;

205 
	`sws_quîy_íd
(
°mt
, 
NULL
);

208 
	`sws_˛o£_db
(
db
, 
NULL
);

213 
övÆid
:

214 
	`sws_˛o£_db
(
db
, 
NULL
);

216 
	}
}

225 
LwdbGlobÆDB
 *
	$lwdb_globÆdb_√w
()

227 
LwdbGlobÆDB
 *
db
 = 
NULL
;

228 
ªt
;

229 
sql
[256];

230 
SwsStmt
 *
°mt
 = 
NULL
;

232 i‡(!
	`db_is_vÆid
(
globÆ_d©aba£_«me
, 0)) {

233 
ªt
 = 
	`lwdb_¸óã_db
(
globÆ_d©aba£_«me
, 0);

234 i‡(
ªt
) {

235 
Áûed
;

239 
db
 = 
	`s_mÆloc0
((*db));

240 
db
->db = 
	`sws_›í_db
(
globÆ_d©aba£_«me
, 
NULL
);

241 i‡(!
db
->db) {

242 
Áûed
;

244 
db
->
add_√w_u£r
 = 
lwdb_globÆdb_add_√w_u£r
;

245 
db
->
quîy_u£r_öfo
 = 
lwdb_globÆdb_quîy_u£r_öfo
;

246 
db
->
upd©e_u£r_öfo
 = 
lwdb_globÆdb_upd©e_u£r_öfo
;

248 
	`¢¥ötf
(
sql
, (sql), "SELECT qqnumber,db_name,password,"

250 
	`lwqq_log
(
LOG_DEBUG
, "%s\n", 
sql
);

251 
ªt
 = 
	`sws_quîy_°¨t
(
db
->db, 
sql
, &
°mt
, 
NULL
);

252 i‡(
ªt
) {

253 
	`lwqq_log
(
LOG_ERROR
, "FaûedÅÿ%s\n", 
sql
);

254 
Áûed
;

257 !
	`sws_quîy_√xt
(
°mt
, 
NULL
)) {

258 
LwdbGlobÆU£rE¡ry
 *
e
 = 
	`s_mÆloc0
((*e));

259 
buf
[256] = {0};

260 
	#LWDB_GLOBALDB_NEW_MACRO
(
i
, 
membî
) { \

261 
	`sws_quîy_cﬁumn
(
°mt
, 
i
, 
buf
, (buf), 
NULL
); \

262 
e
->
membî
 = 
	`s_°rdup
(
buf
); \

263 }

	)

264 
	`LWDB_GLOBALDB_NEW_MACRO
(0, 
qqnumbî
);

265 
	`LWDB_GLOBALDB_NEW_MACRO
(1, 
db_«me
);

266 
	`LWDB_GLOBALDB_NEW_MACRO
(2, 
∑ssw‹d
);

267 
	`LWDB_GLOBALDB_NEW_MACRO
(3, 
°©us
);

268 
	`LWDB_GLOBALDB_NEW_MACRO
(4, 
ªmpwd
);

269 #unde‡
LWDB_GLOBALDB_NEW_MACRO


270 
	`lwqq_log
(
LOG_DEBUG
, "qqnumber:%s, db_name:%s,Öassword:%s, status:%s, "

271 "ªmpwd:%s\n", 
e
->
qqnumbî
,É->
db_«me
,É->
∑ssw‹d
,É->
°©us
);

272 
	`LIST_INSERT_HEAD
(&
db
->
hód
, 
e
, 
íåõs
);

274 
	`sws_quîy_íd
(
°mt
, 
NULL
);

275  
db
;

277 
Áûed
:

278 
	`sws_quîy_íd
(
°mt
, 
NULL
);

279 
	`lwdb_globÆdb_‰ì
(
db
);

280  
NULL
;

281 
	}
}

288 
	$lwdb_globÆdb_‰ì
(
LwdbGlobÆDB
 *
db
)

290 
LwdbGlobÆU£rE¡ry
 *
e
, *
e_√xt
;

291 i‡(!
db
)

294 
	`sws_˛o£_db
(
db
->db, 
NULL
);

296 
	`LIST_FOREACH_SAFE
(
e
, &
db
->
hód
, 
íåõs
, 
e_√xt
) {

297 
	`LIST_REMOVE
(
e
, 
íåõs
);

298 
	`lwdb_globÆdb_‰ì_u£r_íåy
(
e
);

300 
	`s_‰ì
(
db
);

301 
	}
}

308 
	$lwdb_globÆdb_‰ì_u£r_íåy
(
LwdbGlobÆU£rE¡ry
 *
e
)

310 i‡(
e
) {

311 
	`s_‰ì
(
e
->
qqnumbî
);

312 
	`s_‰ì
(
e
->
db_«me
);

313 
	`s_‰ì
(
e
->
∑ssw‹d
);

314 
	`s_‰ì
(
e
->
°©us
);

315 
	`s_‰ì
(
e
->
ªmpwd
);

316 
	`s_‰ì
(
e
);

318 
	}
}

328 
LwqqEº‹Code
 
	$lwdb_globÆdb_add_√w_u£r
(

329 
LwdbGlobÆDB
 *
db
, c⁄° *
qqnumbî
)

331 *
îrmsg
 = 
NULL
;

332 
sql
[256];

334 i‡(!
qqnumbî
){

335  
LWQQ_EC_NULL_POINTER
;

338 
	`¢¥ötf
(
sql
, (sql), "INSERT INTO users (qqnumber,db_name) "

339 "VALUES('%s','%s/%s.db');", 
qqnumbî
, 
d©aba£_∑th
, qqnumber);

340 
	`sws_exec_sql
(
db
->db, 
sql
, &
îrmsg
);

341 i‡(
îrmsg
) {

342 
	`lwqq_log
(
LOG_ERROR
, "AddÇew u£∏îr‹: %s\n", 
îrmsg
);

343 
	`s_‰ì
(
îrmsg
);

344  
LWQQ_EC_DB_EXEC_FAIELD
;

347  
LWQQ_EC_OK
;

348 
	}
}

350 
LwdbGlobÆU£rE¡ry
 *
	$lwdb_globÆdb_quîy_u£r_öfo
(

351 
LwdbGlobÆDB
 *
db
, c⁄° *
qqnumbî
)

353 
ªt
;

354 
sql
[256];

355 
LwdbGlobÆU£rE¡ry
 *
e
 = 
NULL
;

356 
SwsStmt
 *
°mt
 = 
NULL
;

358 i‡(!
qqnumbî
) {

359  
NULL
;

362 
	`¢¥ötf
(
sql
, (sql), "SELECT db_name,password,status,rempwd "

363 "FROM u£r†WHERE qqnumbî='%s';", 
qqnumbî
);

364 
ªt
 = 
	`sws_quîy_°¨t
(
db
->db, 
sql
, &
°mt
, 
NULL
);

365 i‡(
ªt
) {

366 
Áûed
;

369 i‡(!
	`sws_quîy_√xt
(
°mt
, 
NULL
)) {

370 
e
 = 
	`s_mÆloc0
((*e));

371 
buf
[256] = {0};

372 
	#GET_MEMBER_VALUE
(
i
, 
membî
) { \

373 
	`sws_quîy_cﬁumn
(
°mt
, 
i
, 
buf
, (buf), 
NULL
); \

374 
e
->
membî
 = 
	`s_°rdup
(
buf
); \

375 }

	)

376 
e
->
qqnumbî
 = 
	`s_°rdup
(qqnumber);

377 
	`GET_MEMBER_VALUE
(0, 
db_«me
);

378 
	`GET_MEMBER_VALUE
(1, 
∑ssw‹d
);

379 
	`GET_MEMBER_VALUE
(2, 
°©us
);

380 
	`GET_MEMBER_VALUE
(3, 
ªmpwd
);

381 #unde‡
GET_MEMBER_VALUE


383 
	`sws_quîy_íd
(
°mt
, 
NULL
);

385  
e
;

387 
Áûed
:

388 
	`s_‰ì
(
e
);

389 
	`sws_quîy_íd
(
°mt
, 
NULL
);

390  
NULL
;

391 
	}
}

393 
LwqqEº‹Code
 
	$lwdb_globÆdb_upd©e_u£r_öfo
(

394 
LwdbGlobÆDB
 *
db
, c⁄° *
qqnumbî
,

395 c⁄° *
key
, c⁄° *
vÆue
)

397 
sql
[256];

398 *
îr
 = 
NULL
;

400 i‡(!
qqnumbî
 || !
key
 || !
vÆue
) {

401  
LWQQ_EC_NULL_POINTER
;

404 
	`¢¥ötf
(
sql
, (sql), "UPDATE users SET %s='%s' WHERE qqnumber='%s';",

405 
key
, 
vÆue
, 
qqnumbî
);

406 i‡(!
	`sws_exec_sql
(
db
->db, 
sql
, &
îr
)) {

407 
	`lwqq_log
(
LOG_DEBUG
, "%†suc˚ssfuŒy\n", 
sql
);

408  
LWQQ_EC_DB_EXEC_FAIELD
;

410 
	`lwqq_log
(
LOG_ERROR
, "FaûedÅÿ%s: %s\n", 
sql
, 
îr
);

411 
	`s_‰ì
(
îr
);

414  
LWQQ_EC_OK
;

415 
	}
}

417 
LwdbU£rDB
 *
	$lwdb_u£rdb_√w
(c⁄° *
qqnumbî
)

419 
LwdbU£rDB
 *
udb
 = 
NULL
;

420 
LwdbGlobÆDB
 *
gdb
 = 
NULL
;

421 
LwdbGlobÆU£rE¡ry
 *
e
 = 
NULL
;

422 
ªt
;

423 *
db_«me
;

425 i‡(!
qqnumbî
) {

426  
NULL
;

430 
gdb
 = 
	`lwdb_globÆdb_√w
();

431 i‡(!
gdb
) {

432 
Áûed
;

434 
e
 = 
gdb
->
	`quîy_u£r_öfo
(gdb, 
qqnumbî
);

435 i‡(!
e
) {

436 
Áûed
;

438 
db_«me
 = 
e
->db_name;

441 i‡(!
	`db_is_vÆid
(
db_«me
, 1)) {

442 
	`lwqq_log
(
LOG_WARNING
, "db doesntÉxist, create it\n");

443 
ªt
 = 
	`lwdb_¸óã_db
(
db_«me
, 1);

444 i‡(
ªt
) {

445 
Áûed
;

449 
udb
 = 
	`s_mÆloc0
((*udb));

450 
udb
->
db
 = 
	`sws_›í_db
(
db_«me
, 
NULL
);

451 i‡(!
udb
->
db
) {

452 
Áûed
;

454 
udb
->
quîy_buddy_öfo
 = 
lwdb_u£rdb_quîy_buddy_öfo
;

455 
udb
->
upd©e_buddy_öfo
 = 
lwdb_u£rdb_upd©e_buddy_öfo
;

457 
	`lwdb_globÆdb_‰ì
(
gdb
);

458 
	`lwdb_globÆdb_‰ì_u£r_íåy
(
e
);

459  
udb
;

461 
Áûed
:

462 
	`lwdb_globÆdb_‰ì
(
gdb
);

463 
	`lwdb_globÆdb_‰ì_u£r_íåy
(
e
);

464 
	`lwdb_u£rdb_‰ì
(
udb
);

465  
NULL
;

466 
	}
}

468 
	$lwdb_u£rdb_‰ì
(
LwdbU£rDB
 *
db
)

470 i‡(
db
) {

471 
	`sws_˛o£_db
(
db
->db, 
NULL
);

472 
	`s_‰ì
(
db
);

474 
	}
}

484 
LwqqBuddy
 *
	$lwdb_u£rdb_quîy_buddy_öfo
(

485 
LwdbU£rDB
 *
db
, c⁄° *
qqnumbî
)

487 
ªt
;

488 
sql
[256];

489 
LwqqBuddy
 *
buddy
 = 
NULL
;

490 
SwsStmt
 *
°mt
 = 
NULL
;

492 i‡(!
qqnumbî
) {

493  
NULL
;

496 
	`¢¥ötf
(
sql
, (sql),

500 "ˇã_ödex FROM buddõ†WHERE qqnumbî='%s';", 
qqnumbî
);

501 
ªt
 = 
	`sws_quîy_°¨t
(
db
->db, 
sql
, &
°mt
, 
NULL
);

502 i‡(
ªt
) {

503 
Áûed
;

506 i‡(!
	`sws_quîy_√xt
(
°mt
, 
NULL
)) {

507 
buddy
 = 
	`s_mÆloc0
((*buddy));

508 
buf
[256] = {0};

509 
	#GET_BUDDY_MEMBER_VALUE
(
i
, 
membî
) { \

510 
	`sws_quîy_cﬁumn
(
°mt
, 
i
, 
buf
, (buf), 
NULL
); \

511 
buddy
->
membî
 = 
	`s_°rdup
(
buf
); \

512 }

	)

513 
buddy
->
qqnumbî
 = 
	`s_°rdup
(qqnumber);

514 
	`GET_BUDDY_MEMBER_VALUE
(0, 
Á˚
);

515 
	`GET_BUDDY_MEMBER_VALUE
(1, 
occu∑ti⁄
);

516 
	`GET_BUDDY_MEMBER_VALUE
(2, 
ph⁄e
);

517 
	`GET_BUDDY_MEMBER_VALUE
(3, 
Ælow
);

518 
	`GET_BUDDY_MEMBER_VALUE
(4, 
cﬁÀge
);

519 
	`GET_BUDDY_MEMBER_VALUE
(5, 
ªg_time
);

520 
	`GET_BUDDY_MEMBER_VALUE
(6, 
c⁄°ñ
);

521 
	`GET_BUDDY_MEMBER_VALUE
(7, 
blood
);

522 
	`GET_BUDDY_MEMBER_VALUE
(8, 
homïage
);

523 
	`GET_BUDDY_MEMBER_VALUE
(9, 
°©
);

524 
	`GET_BUDDY_MEMBER_VALUE
(10, 
cou¡ry
);

525 
	`GET_BUDDY_MEMBER_VALUE
(11, 
côy
);

526 
	`GET_BUDDY_MEMBER_VALUE
(12, 
≥rs⁄Æ
);

527 
	`GET_BUDDY_MEMBER_VALUE
(13, 
nick
);

528 
	`GET_BUDDY_MEMBER_VALUE
(14, 
shígxüo
);

529 
	`GET_BUDDY_MEMBER_VALUE
(15, 
emaû
);

530 
	`GET_BUDDY_MEMBER_VALUE
(16, 
¥ovö˚
);

531 
	`GET_BUDDY_MEMBER_VALUE
(17, 
gídî
);

532 
	`GET_BUDDY_MEMBER_VALUE
(18, 
mobûe
);

533 
	`GET_BUDDY_MEMBER_VALUE
(19, 
vù_öfo
);

534 
	`GET_BUDDY_MEMBER_VALUE
(20, 
m¨k«me
);

535 
	`GET_BUDDY_MEMBER_VALUE
(21, 
Êag
);

536 
	`GET_BUDDY_MEMBER_VALUE
(22, 
ˇã_ödex
);

537 #unde‡
GET_BUDDY_MEMBER_VALUE


539 
	`sws_quîy_íd
(
°mt
, 
NULL
);

541  
buddy
;

543 
Áûed
:

544 
	`lwqq_buddy_‰ì
(
buddy
);

545 
	`sws_quîy_íd
(
°mt
, 
NULL
);

546  
NULL
;

547 
	}
}

557 
LwqqEº‹Code
 
	$lwdb_u£rdb_upd©e_buddy_öfo
(

558 
LwdbU£rDB
 *
db
, 
LwqqBuddy
 *
buddy
)

560 
sql
[4096] = {0};

561 
sqŒí
 = 0;

563 i‡(!
buddy
 || !buddy->
qqnumbî
) {

564  
LWQQ_EC_NULL_POINTER
;

567 
	`¢¥ötf
(
sql
, (sql), "UPDATE buddõ†SET qqnumbî='%s'", 
buddy
->
qqnumbî
);

568 
sqŒí
 = 
	`°æí
(
sql
);

570 
	#UBI_CONSTRUCT_SQL
(
membî
) { \

571 i‡(
buddy
->
membî
) { \

572 
	`¢¥ötf
(
sql
 + 
sqŒí
, (sqlË- sqŒí, ",%s='%s'", #membî, 
buddy
->
membî
); \

573 
sqŒí
 = 
	`°æí
(
sql
); \

574 i‡(
sqŒí
 > ((
sql
) - 128)) { \

575  
LWQQ_EC_ERROR
; \

578 }

	)

579 
	`UBI_CONSTRUCT_SQL
(
Á˚
);

580 
	`UBI_CONSTRUCT_SQL
(
ph⁄e
);

581 
	`UBI_CONSTRUCT_SQL
(
Ælow
);

582 
	`UBI_CONSTRUCT_SQL
(
cﬁÀge
);

583 
	`UBI_CONSTRUCT_SQL
(
ªg_time
);

584 
	`UBI_CONSTRUCT_SQL
(
c⁄°ñ
);

585 
	`UBI_CONSTRUCT_SQL
(
blood
);

586 
	`UBI_CONSTRUCT_SQL
(
homïage
);

587 
	`UBI_CONSTRUCT_SQL
(
°©
);

588 
	`UBI_CONSTRUCT_SQL
(
cou¡ry
);

589 
	`UBI_CONSTRUCT_SQL
(
côy
);

590 
	`UBI_CONSTRUCT_SQL
(
≥rs⁄Æ
);

591 
	`UBI_CONSTRUCT_SQL
(
nick
);

592 
	`UBI_CONSTRUCT_SQL
(
shígxüo
);

593 
	`UBI_CONSTRUCT_SQL
(
emaû
);

594 
	`UBI_CONSTRUCT_SQL
(
¥ovö˚
);

595 
	`UBI_CONSTRUCT_SQL
(
gídî
);

596 
	`UBI_CONSTRUCT_SQL
(
mobûe
);

597 
	`UBI_CONSTRUCT_SQL
(
vù_öfo
);

598 
	`UBI_CONSTRUCT_SQL
(
m¨k«me
);

599 
	`UBI_CONSTRUCT_SQL
(
Êag
);

600 
	`UBI_CONSTRUCT_SQL
(
ˇã_ödex
);

601 
	`UBI_CONSTRUCT_SQL
(
˛õ¡_ty≥
);

602 #unde‡
UBI_CONSTRUCT_SQL


603 
	`¢¥ötf
(
sql
 + 
sqŒí
, (sqlË- sqŒí, " WHERE qqnumbî='%s';", 
buddy
->
qqnumbî
);

604 i‡(!
	`sws_exec_sql
(
db
->db, 
sql
, 
NULL
)) {

605  
LWQQ_EC_DB_EXEC_FAIELD
;

608  
LWQQ_EC_OK
;

609 
	}
}

	@src/lwdb/lwdb.h

12 #i‚de‡
LWDB_H


13 
	#LWDB_H


	)

15 
	~"ty≥.h
"

16 
	~"swsqlôe.h
"

24 
lwdb_öô
();

30 
lwdb_föÆize
();

36 
	sLwdbGlobÆU£rE¡ry
 {

37 *
	mqqnumbî
;

38 *
	mdb_«me
;

39 *
	m∑ssw‹d
;

40 *
	m°©us
;

41 *
	mªmpwd
;

42 
LIST_ENTRY
(
LwdbGlobÆU£rE¡ry
Ë
	míåõs
;

43 } 
	tLwdbGlobÆU£rE¡ry
;

45 
	sLwdbGlobÆDB
 {

46 
SwsDB
 *
	mdb
;

47 
LwqqEº‹Code
 (*
add_√w_u£r
)(
LwdbGlobÆDB
 *
	mdb
, c⁄° *
	mqqnumbî
);

48 
	mLwdbGlobÆU£rE¡ry
 * (*
	mquîy_u£r_öfo
)(
LwdbGlobÆDB
 *
	mdb
,

49 c⁄° *
	mqqnumbî
);

50 
LIST_HEAD
(, 
LwdbGlobÆU£rE¡ry
Ë
	mhód
;

51 
LwqqEº‹Code
 (*
upd©e_u£r_öfo
)(
LwdbGlobÆDB
 *
	mdb
, c⁄° *
	mqqnumbî
,

52 c⁄° *
	mkey
, c⁄° *
	mvÆue
);

53 } 
	tLwdbGlobÆDB
;

61 
LwdbGlobÆDB
 *
lwdb_globÆdb_√w
();

68 
lwdb_globÆdb_‰ì
(
LwdbGlobÆDB
 *
db
);

75 
lwdb_globÆdb_‰ì_u£r_íåy
(
LwdbGlobÆU£rE¡ry
 *
e
);

82 
	sLwdbU£rDB
 {

83 
SwsDB
 *
	mdb
;

84 
	mLwqqBuddy
 * (*
	mquîy_buddy_öfo
)(
LwdbU£rDB
 *
	mdb
, c⁄° *
	mqqnumbî
);

85 
LwqqEº‹Code
 (*
upd©e_buddy_öfo
)(
LwdbU£rDB
 *
	mdb
, 
LwqqBuddy
 *
	mbuddy
);

86 } 
	tLwdbU£rDB
;

95 
LwdbU£rDB
 *
lwdb_u£rdb_√w
(c⁄° *
qqnumbî
);

102 
lwdb_u£rdb_‰ì
(
LwdbU£rDB
 *
db
);

	@src/lwdb/swsqlite.c

11 
	~<°rög.h
>

12 
	~<°dio.h
>

13 
	~<sqlôe3.h
>

14 
	~"swsqlôe.h
"

16 
	#SET_ERRMSG
(
a
, 
msg
Ëif◊Ë*®
	`°rdup
(msg)

	)

28 
SwsDB
 *
	$sws_›í_db
(c⁄° *
fûíame
, **
îrmsg
)

30 
ªt
;

31 
sqlôe3
 *
db
 = 
NULL
;

33 i‡(!
fûíame
) {

34 i‡(
îrmsg
) {

35 
	`SET_ERRMSG
(
îrmsg
, "Filename isÇull");

37  
NULL
;

40 
ªt
 = 
	`sqlôe3_›í
(
fûíame
, &
db
);

41 i‡(
ªt
 !
SQLITE_OK
) {

46 
	`sqlôe3_˛o£
(
db
);

47 
msg
[128];

48 
	`¢¥ötf
(
msg
, (msg), "Open file: %s failed,Érrcode is %d",

49 
fûíame
, 
ªt
);

50 
	`SET_ERRMSG
(
îrmsg
, 
msg
);

51  
NULL
;

54  
db
;

55 
	}
}

63 
	$sws_˛o£_db
(
SwsDB
 *
db
, **
îrmsg
)

65 
ªt
;

67 i‡(!
db
) {

68 
	`SET_ERRMSG
(
îrmsg
, "Filename isÇull");

72 
ªt
 = 
	`sqlôe3_˛o£
(
db
);

73 i‡(
ªt
 !
SQLITE_OK
) {

74 
msg
[128];

75 
	`¢¥ötf
(
msg
, (msg), "Clo£ DB faûed: %s", 
	`sqlôe3_îrmsg
(
db
));

76 
	`SET_ERRMSG
(
îrmsg
, 
msg
);

79 
	}
}

90 
	$sws_exec_sql
(
SwsDB
 *
db
, c⁄° *
sql
, **
îrmsg
)

92 *
îr
 = 
NULL
;

93 
ªt
 = 0;

95 i‡(!
db
 || !
sql
) {

96 
	`SET_ERRMSG
(
îrmsg
, "SomeÖarameterment isÇull");

100 
ªt
 = 
	`sqlôe3_exec
(
db
, 
sql
, 
NULL
, NULL, &
îr
);

101 i‡(
ªt
 !
SQLITE_OK
) {

102 
msg
[512];

103 
	`¢¥ötf
(
msg
, (msg), "\"%s\" faûed: %s", 
sql
, 
îr
);

104 
	`SET_ERRMSG
(
îrmsg
, 
msg
);

105 
	`sqlôe3_‰ì
(
îr
);

110 
	}
}

123 
	$sws_quîy_°¨t
(
SwsDB
 *
db
, c⁄° *
sql
, 
SwsStmt
 **
°mt
, **
îrmsg
)

125 
ªt
;

127 i‡(!
db
 || !
sql
 || !
°mt
) {

128 
	`SET_ERRMSG
(
îrmsg
, "SomeÖarameterment isÇull");

132 
ªt
 = 
	`sqlôe3_¥ï¨e_v2
(
db
, 
sql
, -1, (
sqlôe3_°mt
 **)
°mt
, 0);

133 i‡(
ªt
 !
SQLITE_OK
) {

134 
msg
[512];

135 
	`¢¥ötf
(
msg
, (msg), "\"%s\" failed: %s",

136 
sql
, 
	`sqlôe3_îrmsg
(
db
));

137 
	`SET_ERRMSG
(
îrmsg
, 
msg
);

142 
	}
}

153 
	$sws_quîy_√xt
(
SwsStmt
 *
°mt
, **
îrmsg
)

155 
ªt
;

157 i‡(!
°mt
) {

158 
	`SET_ERRMSG
(
îrmsg
, "SomeÖarameterment isÇull");

162 
ªt
 = 
	`sqlôe3_°ï
(
°mt
);

163 i‡(
ªt
 !
SQLITE_ROW
) {

164 
msg
[128];

165 
	`¢¥ötf
(
msg
, (msg), "Quîy faûed,Éºcode: %d", 
ªt
);

166 
	`SET_ERRMSG
(
îrmsg
, 
msg
);

171 
	}
}

185 
	$sws_quîy_cﬁumn
(
SwsStmt
 *
°mt
, 
˛m_ödex
, *
buf
, 
buÊí
,

186 **
îrmsg
)

188 c⁄° *
ªsu…
;

190 i‡(!
°mt
 || 
˛m_ödex
 <0 || !
buf
 || 
buÊí
 <= 0) {

191 
	`SET_ERRMSG
(
îrmsg
, "SomeÖarameterment isÇull");

195 
ªsu…
 = 
	`sqlôe3_cﬁumn_ãxt
(
°mt
, 
˛m_ödex
);

196 i‡(!
ªsu…
) {

197 
msg
[64];

198 
	`¢¥ötf
(
msg
, (msg), "Quîy %d cﬁum¿Áûed", 
˛m_ödex
);

199 
	`SET_ERRMSG
(
îrmsg
, 
msg
);

203 
	`¢¥ötf
(
buf
, 
buÊí
, "%s", 
ªsu…
);

205 
	}
}

216 
	$sws_quîy_íd
(
SwsStmt
 *
°mt
, **
îrmsg
)

218 
ªt
;

220 i‡(!
°mt
) {

221 
	`SET_ERRMSG
(
îrmsg
, "SomeÖarameterment isÇull");

225 
ªt
 = 
	`sqlôe3_föÆize
(
°mt
);

227 i‡(
ªt
 !
SQLITE_OK
) {

228 
msg
[64];

229 
	`¢¥ötf
(
msg
, (msg), "End quîy faûed,Éºcode: %d", 
ªt
);

230 
	`SET_ERRMSG
(
îrmsg
, 
msg
);

235 
	}
}

246 
	$sws_exec_sql_dúe˘ly
(c⁄° *
fûíame
, c⁄° *
sql
, **
îrmsg
)

248 
ªt
;

249 
SwsDB
 *
db
 = 
NULL
;

251 i‡(!
fûíame
 || !
sql
) {

252 
	`SET_ERRMSG
(
îrmsg
, "SomeÖarameterment isÇull");

253 
Áûed
;

256 
db
 = 
	`sws_›í_db
(
fûíame
, 
îrmsg
);

257 i‡(!
db
) {

258 
Áûed
;

261 
ªt
 = 
	`sws_exec_sql
(
db
, 
sql
, 
îrmsg
);

262 i‡(
ªt
) {

263 
Áûed
;

266 
	`sws_˛o£_db
(
db
, 
NULL
);

270 
Áûed
:

271 i‡(
db
)

272 
	`sws_˛o£_db
(
db
, 
NULL
);

274 
	}
}

278 
	~<°dlib.h
>

279 
	$maö
(
¨gc
, *
¨gv
[])

281 
ªt
;

282 
SwsStmt
 *
°mt
 = 
NULL
;

285 
SwsDB
 *
db
 = 
	`sws_›í_db
("/tmp/ã°_sws.db", 
NULL
);

286 i‡(!
db
) {

291 
ªt
 = 
	`sws_exec_sql
(
db
, "createÅable ifÇotÉxists config("

297 "VALUES('sws', '°©us', 'ã°');", 
NULL
);

298 i‡(
ªt
) {

299 
Áûed
;

303 
ªt
 = 
	`sws_quîy_°¨t
(
db
, "SELECT key,vÆuêFROM c⁄fig;", &
°mt
, 
NULL
);

304 i‡(
ªt
) {

305 
Áûed
;

307 !
	`sws_quîy_√xt
(
°mt
, 
NULL
)) {

308 
key
[128], 
vÆue
[128];

309 
	`sws_quîy_cﬁumn
(
°mt
, 0, 
key
, (key), 
NULL
);

310 
	`sws_quîy_cﬁumn
(
°mt
, 1, 
vÆue
, (vÆue), 
NULL
);

311 
	`¥ötf
 ("%s=%s\n", 
key
, 
vÆue
);

313 
	`sws_quîy_íd
(
°mt
, 
NULL
);

316 
	`sws_˛o£_db
(
db
, 
NULL
);

319 
	`sws_exec_sql_dúe˘ly
("/tmp/test_sws.db", "INSERT INTO configs "

320 "(Ámûy,key,vÆueËVALUES('1', '2', '3');", 
NULL
);

324 
Áûed
:

325 
	`sws_˛o£_db
(
db
, 
NULL
);

327 
	}
}

	@src/lwdb/swsqlite.h

11 #i‚de‡
SSQLITE_H


12 
	#SSQLITE_H


	)

14 
	tSwsDB
;

15 
	tSwsStmt
;

26 
SwsDB
 *
sws_›í_db
(c⁄° *
fûíame
, **
îrmsg
);

34 
sws_˛o£_db
(
SwsDB
 *
db
, **
îrmsg
);

45 
sws_exec_sql
(
SwsDB
 *
db
, c⁄° *
sql
, **
îrmsg
);

77 
sws_quîy_°¨t
(
SwsDB
 *
db
, c⁄° *
sql
, 
SwsStmt
 **
°mt
, **
îrmsg
);

88 
sws_quîy_√xt
(
SwsStmt
 *
°mt
, **
îrmsg
);

102 
sws_quîy_cﬁumn
(
SwsStmt
 *
°mt
, 
˛m_ödex
, *
buf
, 
buÊí
,

103 **
îrmsg
);

113 
sws_quîy_íd
(
SwsStmt
 *
°mt
, **
îrmsg
);

124 
sws_exec_sql_dúe˘ly
(c⁄° *
fûíame
, c⁄° *
sql
, **
îrmsg
);

	@test/test_login.c

11 
	~<°rög.h
>

12 
	~<uni°d.h
>

14 
	~"logö.h
"

15 
	~"loggî.h
"

16 
	~"öfo.h
"

17 
	~"smem‹y.h
"

18 
	~"msg.h
"

20 *
	$gë_vc
()

22 
buf
[1024] = {0};

24 
FILE
 *
f
 = 
	`f›í
("/tmp/test.txt", "r");

25 i‡(!
f
)

26  
NULL
;

28 *
i
 = 
	`fgës
(
buf
, (buf), 
f
);

29 i‡(!
i
)

30  
NULL
;

31 
	`f˛o£
(
f
);

32 
Àn
 = 
	`°æí
(
buf
);

33 
buf
[
Àn
 - 1] = '\0';

34 
	`¥ötf
 ("%s\n", 
i
);

35  
	`s_°rdup
(
buf
);

36 
	}
}

38 
	$h™dÀ_√w_msg
(
LwqqRecvMsg
 *
ªcvmsg
)

40 
LwqqMsg
 *
msg
 = 
ªcvmsg
->msg;

42 
	`¥ötf
("Re˚ivêmesßgêty≥: %d\n", 
msg
->
ty≥
);

43 i‡(
msg
->
ty≥
 =
LWQQ_MT_BUDDY_MSG
) {

44 
buf
[1024] = {0};

45 
LwqqMsgC⁄ã¡
 *
c
;

46 
LwqqMsgMesßge
 *
mmsg
 = 
msg
->
›aque
;

47 
	`TAILQ_FOREACH
(
c
, &
mmsg
->
c⁄ã¡
, 
íåõs
) {

48 i‡(
c
->
ty≥
 =
LWQQ_CONTENT_STRING
) {

49 
	`°rˇt
(
buf
, 
c
->
d©a
.
°r
);

51 
	`¥ötf
 ("Re˚ivêÁ˚ msg: %d\n", 
c
->
d©a
.
Á˚
);

54 } i‡(
msg
->
ty≥
 =
LWQQ_MT_GROUP_MSG
) {

55 
LwqqMsgMesßge
 *
mmsg
 = 
msg
->
›aque
;

56 
buf
[1024] = {0};

57 
LwqqMsgC⁄ã¡
 *
c
;

58 
	`TAILQ_FOREACH
(
c
, &
mmsg
->
c⁄ã¡
, 
íåõs
) {

59 i‡(
c
->
ty≥
 =
LWQQ_CONTENT_STRING
) {

60 
	`°rˇt
(
buf
, 
c
->
d©a
.
°r
);

62 
	`¥ötf
 ("Re˚ivêÁ˚ msg: %d\n", 
c
->
d©a
.
Á˚
);

65 } i‡(
msg
->
ty≥
 =
LWQQ_MT_STATUS_CHANGE
) {

66 
LwqqMsgSètusCh™ge
 *
°©us
 = 
msg
->
›aque
;

67 
	`¥ötf
("Receive status change: %s - > %s\n",

68 
°©us
->
who
,

69 
°©us
->status);

71 
	`¥ötf
("unknow message\n");

74 
	`lwqq_msg_‰ì
(
ªcvmsg
->
msg
);

75 
	`s_‰ì
(
ªcvmsg
);

76 
	}
}

78 
	$ã°_logö
(c⁄° *
qqnumbî
, c⁄° *
∑ssw‹d
)

80 
LwqqClõ¡
 *
lc
 = 
	`lwqq_˛õ¡_√w
(
qqnumbî
, 
∑ssw‹d
);

81 i‡(!
lc
)

84 
LwqqEº‹Code
 
îr
;

85 
	`lwqq_logö
(
lc
, &
îr
);

86 i‡(
îr
 =
LWQQ_EC_LOGIN_NEED_VC
) {

87 
	`u∆ök
("/tmp/test.txt");

89 i‡(!
	`ac˚ss
("/tmp/ã°.txt", 
F_OK
)) {

90 
	`¶ìp
(1);

93 
	`¶ìp
(1);

95 
lc
->
vc
->
°r
 = 
	`gë_vc
();

96 
	`¥ötf
 ("gë vc: %s\n", 
lc
->
vc
->
°r
);

98 
	`lwqq_logö
(
lc
, &
îr
);

99 } i‡(
îr
 !
LWQQ_EC_OK
) {

100 
	`lwqq_log
(
LOG_ERROR
, "LoginÉrror,Éxit\n");

101 
d⁄e
;

103 
	`lwqq_log
(
LOG_NOTICE
, "Login successfully\n");

105 
	`lwqq_öfo_gë_‰õnds_öfo
(
lc
, &
îr
);

107 
	`lwqq_öfo_gë_⁄löe_buddõs
(
lc
, 
NULL
);

108 
LwqqBuddy
 *
buddy
;

109 
	`LIST_FOREACH
(
buddy
, &
lc
->
‰õnds
, 
íåõs
) {

110 i‡(
buddy
->
°©us
) {

111 
	`lwqq_log
(
LOG_NOTICE
, "uö:%s, sètus:%s\n", 
buddy
->
uö
, buddy->
°©us
);

116 
	`lwqq_öfo_gë_‰õnds_öfo
(
lc
, &
îr
);

118 i‡(
îr
 =
LWQQ_EC_OK
) {

119 
LwqqBuddy
 *
buddy
;

120 
	`LIST_FOREACH
(
buddy
, &
lc
->
‰õnds
, 
íåõs
) {

121 
buf
[128] = {0};

122 i‡(
buddy
->
qqnumbî
) {

123 
	`°rˇt
(
buf
, "qqnumber:");

124 
	`°rˇt
(
buf
, 
buddy
->
qqnumbî
);

125 
	`°rˇt
(
buf
, ", ");

127 i‡(
buddy
->
nick
) {

128 
	`°rˇt
(
buf
, "nick:");

129 
	`°rˇt
(
buf
, 
buddy
->
nick
);

130 
	`°rˇt
(
buf
, ", ");

132 i‡(
buddy
->
uö
) {

133 
	`°rˇt
(
buf
, "uin:");

134 
	`°rˇt
(
buf
, 
buddy
->
uö
);

135 
	`°rˇt
(
buf
, ", ");

137 
	`lwqq_log
(
LOG_DEBUG
, "Buddy info: %s\n", 
buf
);

141 
	`lwqq_öfo_gë_group_«me_li°
(
lc
, &
îr
);

143 i‡(
îr
 =
LWQQ_EC_OK
) {

144 
LwqqGroup
 *
group
;

145 
LwqqBuddy
 *
membî
;

146 
	`LIST_FOREACH
(
group
, &
lc
->
groups
, 
íåõs
) {

147 
buf
[256] = {0};

150 
	`lwqq_öfo_gë_group_dëaû_öfo
(
lc
, 
group
, &
îr
);

152 i‡(
group
->
«me
) {

153 
	`°rˇt
(
buf
, "name:");

154 
	`°rˇt
(
buf
, 
group
->
«me
);

155 
	`°rˇt
(
buf
, ", ");

158 i‡(
group
->
gid
) {

159 
	`°rˇt
(
buf
, "gid:");

160 
	`°rˇt
(
buf
, 
group
->
gid
);

161 
	`°rˇt
(
buf
, ", ");

164 i‡(
group
->
code
) {

165 
	`°rˇt
(
buf
, "code:");

166 
	`°rˇt
(
buf
, 
group
->
code
);

167 
	`°rˇt
(
buf
, ", ");

170 i‡(
group
->
m¨k«me
) {

171 
	`°rˇt
(
buf
, "markname:");

172 
	`°rˇt
(
buf
, 
group
->
m¨k«me
);

173 
	`°rˇt
(
buf
, ", ");

176 i‡(
group
->
accou¡
) {

177 
	`°rˇt
(
buf
, "account:");

178 
	`°rˇt
(
buf
, 
group
->
accou¡
);

179 
	`°rˇt
(
buf
, ", ");

182 i‡(
group
->
ow√r
) {

183 
	`°rˇt
(
buf
, "owner:");

184 
	`°rˇt
(
buf
, 
group
->
ow√r
);

185 
	`°rˇt
(
buf
, ", ");

188 i‡(
group
->
memo
) {

189 
	`°rˇt
(
buf
, "memo:");

190 
	`°rˇt
(
buf
, 
group
->
memo
);

191 
	`°rˇt
(
buf
, ", ");

194 i‡(
group
->
fögîmemo
) {

195 
	`°rˇt
(
buf
, "fingermemo:");

196 
	`°rˇt
(
buf
, 
group
->
fögîmemo
);

197 
	`°rˇt
(
buf
, ", ");

200 i‡(
group
->
Àvñ
) {

201 
	`°rˇt
(
buf
, "level:");

202 
	`°rˇt
(
buf
, 
group
->
Àvñ
);

203 
	`°rˇt
(
buf
, ", ");

206 i‡(
group
->
¸óãtime
) {

207 
	`°rˇt
(
buf
, "createtime:");

208 
	`°rˇt
(
buf
, 
group
->
¸óãtime
);

209 
	`°rˇt
(
buf
, ", ");

212 i‡(
group
->
Á˚
) {

213 
	`°rˇt
(
buf
, "face:");

214 
	`°rˇt
(
buf
, 
group
->
Á˚
);

215 
	`°rˇt
(
buf
, ", ");

218 i‡(
group
->
Êag
) {

219 
	`°rˇt
(
buf
, "flag:");

220 
	`°rˇt
(
buf
, 
group
->
Êag
);

221 
	`°rˇt
(
buf
, ", ");

224 i‡(
group
->
Êag
) {

225 
	`°rˇt
(
buf
, "option:");

226 
	`°rˇt
(
buf
, 
group
->
›ti⁄
);

227 
	`°rˇt
(
buf
, ", ");

229 
	`lwqq_log
(
LOG_DEBUG
, "Grou∞öfo: %s\n", 
buf
);

231 
	`LIST_FOREACH
(
membî
, &
group
->
membîs
, 
íåõs
) {

232 
buff
[256] = {0};

233 i‡(
membî
->
nick
) {

234 
	`°rˇt
(
buff
, "nick:");

235 
	`°rˇt
(
buff
, 
membî
->
nick
);

236 
	`°rˇt
(
buff
, ", ");

238 i‡(
membî
->
uö
) {

239 
	`°rˇt
(
buff
, "uin:");

240 
	`°rˇt
(
buff
, 
membî
->
uö
);

241 
	`°rˇt
(
buff
, ", ");

243 i‡(
membî
->
qqnumbî
) {

244 
	`°rˇt
(
buff
, "qqnumber:");

245 
	`°rˇt
(
buff
, 
membî
->
qqnumbî
);

246 
	`°rˇt
(
buff
, ", ");

248 i‡(
membî
->
˛õ¡_ty≥
) {

249 
	`°rˇt
(
buff
, "client_type:");

250 
	`°rˇt
(
buff
, 
membî
->
˛õ¡_ty≥
);

251 
	`°rˇt
(
buff
, ", ");

253 i‡(
membî
->
°©
) {

254 
	`°rˇt
(
buff
, "stat:");

255 
	`°rˇt
(
buff
, 
membî
->
°©
);

256 
	`°rˇt
(
buff
, ", ");

258 
	`lwqq_log
(
LOG_DEBUG
, "Grou∞Membî info: %s\n", 
buff
);

263 
	`lwqq_öfo_gë_‰õnd_dëaû_öfo
(
lc
,Üc->
my£lf
, &
îr
);

266 
lc
->
msg_li°
->
	`pﬁl_msg
(lc->msg_list);

269 
LwqqRecvMsgLi°
 *
l
 = 
lc
->
msg_li°
;

270 
LwqqRecvMsg
 *
msg
;

271 
	`±hªad_muãx_lock
(&
l
->
muãx
);

272 i‡(
	`SIMPLEQ_EMPTY
(&
l
->
hód
)) {

274 
	`±hªad_muãx_u∆ock
(&
l
->
muãx
);

275 
	`u¶ìp
(100000);

278 
msg
 = 
	`SIMPLEQ_FIRST
(&
l
->
hód
);

279 
	`SIMPLEQ_REMOVE_HEAD
(&
l
->
hód
, 
íåõs
);

280 
	`±hªad_muãx_u∆ock
(&
l
->
muãx
);

281 
	`h™dÀ_√w_msg
(
msg
);

285 
	`¶ìp
(2);

286 
	`lwqq_logout
(
lc
, &
îr
);

287 i‡(
îr
 !
LWQQ_EC_OK
) {

288 
	`lwqq_log
(
LOG_DEBUG
, "Logout failed\n");

290 
	`lwqq_log
(
LOG_DEBUG
, "Logout sucessfully\n");

293 
d⁄e
:

294 
	`lwqq_˛õ¡_‰ì
(
lc
);

295 
	}
}

297 
	$maö
(
¨gc
, *
¨gv
[])

299 i‡(
¨gc
 != 3) {

302 
	`ã°_logö
(
¨gv
[1],árgv[2]);

304 
	}
}

	@test/test_lwdb.c

11 
	~"logö.h
"

12 
	~"loggî.h
"

13 
	~"öfo.h
"

14 
	~"smem‹y.h
"

15 
	~"lwdb.h
"

17 
	$maö
(
¨gc
, *
¨gv
[])

19 
LwdbGlobÆDB
 *
gdb
 = 
NULL
;

20 
LwdbU£rDB
 *
udb
 = 
NULL
;

21 
LwdbGlobÆU£rE¡ry
 *
e
 = 
NULL
;

22 
LwqqBuddy
 *
b1
, 
b2
 = {

23 .
qqnumbî
 = "244569070",

24 .
uö
 = "4744839",

25 .
nick
 = "hello",

26 .
ph⁄e
 = "32344556",

29 
	`lwdb_öô
();

30 
gdb
 = 
	`lwdb_globÆdb_√w
();

31 i‡(!
gdb
) {

32 
	`lwqq_log
(
LOG_ERROR
, "error\n");

33 
d⁄e
;

35 
e
 = 
gdb
->
	`quîy_u£r_öfo
(gdb, "3456345");

36 i‡(!
e
) {

37 
gdb
->
	`add_√w_u£r
(gdb, "3456345");

38 
e
 = 
gdb
->
	`quîy_u£r_öfo
(gdb, "3456345");

39 i‡(!
e
) {

40 
d⁄e
;

44 
udb
 = 
	`lwdb_u£rdb_√w
("3456345");

45 i‡(!
udb
) {

46 
d⁄e
;

48 
	`lwqq_log
(
LOG_NOTICE
, "%s,%s,%s,%s,%s\n",

49 
e
->
qqnumbî
,É->
db_«me
,É->
∑ssw‹d
,É->
°©us
,É->
ªmpwd
);

51 
b1
 = 
udb
->
	`quîy_buddy_öfo
(udb, "244569070");

52 i‡(
b1
) {

53 
	`lwqq_buddy_‰ì
(
b1
);

55 
udb
->
	`upd©e_buddy_öfo
(udb, &
b2
);

57 
d⁄e
:

58 
	`lwdb_globÆdb_‰ì_u£r_íåy
(
e
);

59 
	`lwdb_globÆdb_‰ì
(
gdb
);

60 
	`lwdb_u£rdb_‰ì
(
udb
);

61 
	`lwdb_föÆize
();

63 
	}
}

	@test/test_sendmsg.c

11 
	~<°rög.h
>

12 
	~<uni°d.h
>

14 
	~"logö.h
"

15 
	~"loggî.h
"

16 
	~"öfo.h
"

17 
	~"smem‹y.h
"

18 
	~"msg.h
"

20 *
	$gë_vc
()

22 
buf
[1024] = {0};

24 
FILE
 *
f
 = 
	`f›í
("/tmp/test.txt", "r");

25 i‡(!
f
)

26  
NULL
;

28 *
i
 = 
	`fgës
(
buf
, (buf), 
f
);

29 i‡(!
i
)

30  
NULL
;

31 
	`f˛o£
(
f
);

32 
Àn
 = 
	`°æí
(
buf
);

33 
buf
[
Àn
 - 1] = '\0';

34 
	`¥ötf
 ("%s\n", 
i
);

35  
	`s_°rdup
(
buf
);

36 
	}
}

38 
	$ã°_£ndmsg
(c⁄° *
qqnumbî
, c⁄° *
∑ssw‹d
)

40 
LwqqClõ¡
 *
lc
 = 
	`lwqq_˛õ¡_√w
(
qqnumbî
, 
∑ssw‹d
);

41 i‡(!
lc
)

44 
LwqqEº‹Code
 
îr
;

45 
	`lwqq_logö
(
lc
, &
îr
);

46 i‡(
îr
 =
LWQQ_EC_LOGIN_NEED_VC
) {

47 
	`u∆ök
("/tmp/test.txt");

49 i‡(!
	`ac˚ss
("/tmp/ã°.txt", 
F_OK
)) {

50 
	`¶ìp
(1);

53 
	`¶ìp
(1);

55 
lc
->
vc
->
°r
 = 
	`gë_vc
();

56 
	`¥ötf
 ("gë vc: %s\n", 
lc
->
vc
->
°r
);

58 
	`lwqq_logö
(
lc
, &
îr
);

59 } i‡(
îr
 !
LWQQ_EC_OK
) {

60 
	`lwqq_log
(
LOG_ERROR
, "LoginÉrror,Éxit\n");

61 
d⁄e
;

63 
	`lwqq_log
(
LOG_NOTICE
, "Login successfully\n");

65 
	`lwqq_öfo_gë_‰õnds_öfo
(
lc
, &
îr
);

66 i‡(
îr
 =
LWQQ_EC_OK
) {

67 
LwqqBuddy
 *
buddy
;

68 
	`LIST_FOREACH
(
buddy
, &
lc
->
‰õnds
, 
íåõs
) {

70 
LwqqSídMsg
 *
msg
;

71 i‡(!
	`°rcmp
(
buddy
->
nick
, "mathslinux")) {

72 
msg
 = 
	`lwqq_£ndmsg_√w
(
lc
, 
buddy
->
uö
, "message", "Whoáre you?");

73 
msg
->
	`£nd
(msg);

81 
	`¶ìp
(3);

82 
	`lwqq_logout
(
lc
, &
îr
);

83 i‡(
îr
 !
LWQQ_EC_OK
) {

84 
	`lwqq_log
(
LOG_DEBUG
, "Logout failed\n");

86 
	`lwqq_log
(
LOG_DEBUG
, "Logout sucessfully\n");

89 
d⁄e
:

90 
	`lwqq_˛õ¡_‰ì
(
lc
);

91 
	}
}

93 
	$maö
(
¨gc
, *
¨gv
[])

95 i‡(
¨gc
 != 3) {

98 
	`ã°_£ndmsg
(
¨gv
[1],árgv[2]);

100 
	}
}

	@
1
.
0
75
1751
src/cli/cli.c
src/gui/buddylist.c
src/gui/buddylist.h
src/gui/buddytree.c
src/gui/buddytree.h
src/gui/chattextview.c
src/gui/chattextview.h
src/gui/chatwidget.c
src/gui/chatwidget.h
src/gui/chatwindow.c
src/gui/chatwindow.h
src/gui/loginpanel.c
src/gui/loginpanel.h
src/gui/main.c
src/gui/mainpanel.c
src/gui/mainpanel.h
src/gui/mainwindow.c
src/gui/mainwindow.h
src/gui/msgloop.c
src/gui/msgloop.h
src/gui/splashpanel.c
src/gui/splashpanel.h
src/gui/statusbutton.c
src/gui/statusbutton.h
src/gui/tray.c
src/gui/tray.h
src/include/lwqq/info.h
src/include/lwqq/logger.h
src/include/lwqq/login.h
src/include/lwqq/msg.h
src/include/lwqq/queue.h
src/include/lwqq/smemory.h
src/include/lwqq/type.h
src/liblwqq/http.c
src/liblwqq/http.h
src/liblwqq/http_curl.c
src/liblwqq/info.c
src/liblwqq/json.c
src/liblwqq/json.h
src/liblwqq/libghttp/ghttp.c
src/liblwqq/libghttp/ghttp.h
src/liblwqq/libghttp/ghttp_constants.h
src/liblwqq/libghttp/http_base64.c
src/liblwqq/libghttp/http_base64.h
src/liblwqq/libghttp/http_date.c
src/liblwqq/libghttp/http_date.h
src/liblwqq/libghttp/http_global.h
src/liblwqq/libghttp/http_hdrs.c
src/liblwqq/libghttp/http_hdrs.h
src/liblwqq/libghttp/http_req.c
src/liblwqq/libghttp/http_req.h
src/liblwqq/libghttp/http_resp.c
src/liblwqq/libghttp/http_resp.h
src/liblwqq/libghttp/http_trans.c
src/liblwqq/libghttp/http_trans.h
src/liblwqq/libghttp/http_uri.c
src/liblwqq/libghttp/http_uri.h
src/liblwqq/logger.c
src/liblwqq/login.c
src/liblwqq/md5.c
src/liblwqq/md5.h
src/liblwqq/msg.c
src/liblwqq/smemory.c
src/liblwqq/type.c
src/liblwqq/unicode.c
src/liblwqq/unicode.h
src/liblwqq/url.c
src/liblwqq/url.h
src/lwdb/lwdb.c
src/lwdb/lwdb.h
src/lwdb/swsqlite.c
src/lwdb/swsqlite.h
test/test_login.c
test/test_lwdb.c
test/test_sendmsg.c
